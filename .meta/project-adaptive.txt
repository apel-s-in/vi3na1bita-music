–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.
- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).
- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  ```ts
  export function x() {}
  ```
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.
- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.
- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.
- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].
- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. 
- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.
- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.

–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: vi3na1bita-music
–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: https://github.com/apel-s-in/vi3na1bita-music
# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.
–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).

–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:
vi3na1bita-music/
‚îú‚îÄ‚îÄ .git/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ applypatch-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fsmonitor-watchman.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-update.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-applypatch.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-merge-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-push.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-rebase.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-receive.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prepare-commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ push-to-checkout.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sendemail-validate.sample
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update.sample
‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exclude
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HEAD
‚îÇ   ‚îú‚îÄ‚îÄ objects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pack/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-759ac2af90ae434fcac33351bbcf68bbcb543d6c.idx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-759ac2af90ae434fcac33351bbcf68bbcb543d6c.pack
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ pack-759ac2af90ae434fcac33351bbcf68bbcb543d6c.rev
‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tags/
‚îÇ   ‚îú‚îÄ‚îÄ config
‚îÇ   ‚îú‚îÄ‚îÄ config.worktree
‚îÇ   ‚îú‚îÄ‚îÄ description
‚îÇ   ‚îú‚îÄ‚îÄ FETCH_HEAD
‚îÇ   ‚îú‚îÄ‚îÄ HEAD
‚îÇ   ‚îî‚îÄ‚îÄ index
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ e2e.yml
‚îÇ       ‚îú‚îÄ‚îÄ generate-context.yml
‚îÇ       ‚îî‚îÄ‚îÄ validate.yml
‚îú‚îÄ‚îÄ .meta/
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ albums/
‚îÇ   ‚îú‚îÄ‚îÄ gallery/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ news/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ thumbs/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ news-cover-02-thumb.jpg
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ news-cover-02-thumb.webp
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-01-baner.html
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.avif
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.png
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ news-cover-02.webp
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ emoji/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ noto/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ animated/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cross_mark.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ loudspeaker.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ satellite_antenna.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sparkles.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ trophy.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ warning.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ white_check_mark.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ fallback/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cross_mark.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ loudspeaker.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ satellite_antenna.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sparkles.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ trophy.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ warning.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ white_check_mark.webp
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ cross_mark.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ loudspeaker.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ satellite_antenna.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ sparkles.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ trophy.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ warning.png
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ white_check_mark.png
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ icons/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ apple-touch-icon.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-16.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-32.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-192.png
‚îÇ   ‚îî‚îÄ‚îÄ icon-512.png
‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îú‚îÄ‚îÄ desktop/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@2x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@3x.png
‚îÇ   ‚îú‚îÄ‚îÄ icon_album/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.png
‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@2x.jpg
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ bg.png
‚îÇ   ‚îú‚îÄ‚îÄ logo.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-01.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-02.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-03.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-04.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-21.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-22.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-23.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-24.png
‚îÇ   ‚îú‚îÄ‚îÄ star.png
‚îÇ   ‚îî‚îÄ‚îÄ star2.png
‚îú‚îÄ‚îÄ news/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ news.json
‚îú‚îÄ‚îÄ performance/
‚îÇ   ‚îî‚îÄ‚îÄ rum.js
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ albums.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background-audio.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background-events.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ downloads.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ navigation.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ player-ui.js
‚îÇ   ‚îú‚îÄ‚îÄ ci/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lint-sw.mjs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate-content.mjs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate-manifest.mjs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validate-playercore.mjs
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.js
‚îÇ   ‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.spec.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ player.spec.js
‚îÇ   ‚îú‚îÄ‚îÄ player/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ player-adapter.js
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-const.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-data.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-storage.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lyrics-modal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mini.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modals.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notify.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sleep.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sysinfo.js
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sw-manager.js
‚îÇ   ‚îú‚îÄ‚îÄ app.js
‚îÇ   ‚îî‚îÄ‚îÄ energy.js
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ PlayerCore.js
‚îÇ   ‚îî‚îÄ‚îÄ PlayerCore.ts
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îî‚îÄ‚îÄ main.css
‚îú‚îÄ‚îÄ albums.json
‚îú‚îÄ‚îÄ custom.json
‚îú‚îÄ‚îÄ generate-context.js
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ news.html
‚îî‚îÄ‚îÄ service-worker.js


–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: 2025-12-07 10:21:18 UTC
//=================================================
// FILE: /.github/workflows/e2e.yml
name: E2E smoke

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npx -y playwright@1.48.2 install --with-deps

      - name: Start static server
        run: |
          npx -y http-server -p 4173 -c-1 . &
          echo $! > server.pid
          sleep 2

      - name: Run smoke tests
        env:
          BASE_URL: http://127.0.0.1:4173
        run: npx -y @playwright/test@1.48.2 scripts/e2e

      - name: Stop server
        if: always()
        run: kill $(cat server.pid) || true

//=================================================
// FILE: /.github/workflows/generate-context.yml
name: Generate .meta context

on:
  push:
    branches: [ main, master ]
    # –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤–æ—Ä–∫—Ñ–ª–æ—É –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤, –º–µ–Ω—è—é—â–∏—Ö —Ç–æ–ª—å–∫–æ .meta
    paths-ignore:
      - '.meta/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate .meta
        run: |
          node generate-context.js --mode=both --max-lines=20000
          ls -la .meta || true

      - name: Commit .meta
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: generate .meta context"
          branch: ${{ github.ref_name }}
          file_pattern: ".meta/**"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

//=================================================
// FILE: /.github/workflows/validate.yml
name: Validate manifest and SW

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run manifest validator
        run: node scripts/ci/validate-manifest.mjs

      - name: Run SW linter
        run: node scripts/ci/lint-sw.mjs

      - name: Validate albums and galleries
        run: node scripts/ci/validate-content.mjs

      - name: Validate PlayerCore JS/TS agreement
        run: node scripts/ci/validate-playercore.mjs


//=================================================
// FILE: /albums.json
{
  "albums": [
    {
      "key": "mezhdu-zlom-i-dobrom",
      "title": "–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º (2025)",
      "base": "https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/"
    },
    {
      "key": "golos-dushi",
      "title": "–ì–æ–ª–æ—Å –î—É—à–∏",
      "base": "https://apel-s-in.github.io/vi3na1bita-golos-dushi/"
    },
    {
      "key": "krevetochka",
      "title": "–ö–†–ï–í–ï„ÉÑTOCHKA",
      "base": "https://apel-s-in.github.io/krevetochka/"
    }
  ]
}

//=================================================
// FILE: /albums/gallery/00/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-01.webp",
        "full": "albums/gallery/00/00-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-02.webp",
        "full": "albums/gallery/00/00-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/01/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-01.webp",
        "full": "albums/gallery/01/01-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-02.webp",
        "full": "albums/gallery/01/01-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-03.webp",
        "full": "albums/gallery/01/01-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-04.webp",
        "full": "albums/gallery/01/01-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/02/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-01.webp",
        "full": "albums/gallery/02/02-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-02.webp",
        "full": "albums/gallery/02/02-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-03.webp",
        "full": "albums/gallery/02/02-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-04.webp",
        "full": "albums/gallery/02/02-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/news/index.json
{
  "items": [
    { "type": "html", "src": "albums/gallery/news/news-01-baner.html" },
    {
      "formats": {
        "webp": "albums/gallery/news/news-cover-02.webp",
        "full": "albums/gallery/news/news-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /custom.json
{
  "rumEndpoint": "",
  "sw": {
    "mediaMaxCacheMB": 150,
    "nonRangeMaxStoreMB": 25,
    "nonRangeMaxStoreMBSlow": 10,
    "allowUnknownSize": false,
    "revalidateDays": 7
  },
  "items": [
    {
      "type": "ym",
      "title": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
      "subtitle": "–Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∞",
      "url": "https://music.yandex.ru/artist/24739002?utm_source=web&utm_medium=copy_link",
      "cover": ""
    },
    {
      "type": "tgPost",
      "title": "–°–≤–µ–∂–∏–π –ø–æ—Å—Ç –≤ Telegram",
      "url": "https://t.me/vitrina_razbita/28",
      "height": 480
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 3,
      "hash": "b8300406c5f33725de",
      "containerId": "vk_playlist_165137_3"
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 2,
      "hash": "d70fba309dc0bea296",
      "containerId": "vk_playlist_165137_2"
    }
  ]
}

//=================================================
// FILE: /index.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  
  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  
  <!-- Favicons -->
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">
  
  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">
  
  <!-- Styles -->
  <link rel="stylesheet" href="styles/main.css">
  
  <!-- Howler.js -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>

  <!-- Preconnect –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
  <!-- Core -->
  <script src="./scripts/core/bootstrap.js"></script>
  <!-- ‚ö†Ô∏è bootstrap.js –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ã—á–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º, –ù–ï type="module" -->
  <script src="./scripts/core/config.js" type="module"></script>
  
  <!-- Player Core -->
  <script src="./scripts/player/player-adapter.js" type="module"></script>
  
  <!-- UI Modules -->
  <script src="./scripts/ui/notify.js" defer></script>
  <script src="./scripts/ui/favorites-const.js" defer></script>
  <script src="./scripts/ui/favorites-storage.js" defer></script>
  <script src="./scripts/ui/favorites-data.js" defer></script>
  <script src="./scripts/ui/favorites.js" defer></script>
  <script src="./scripts/ui/mini.js" defer></script>
  <script src="./scripts/ui/modals.js" defer></script>
  <script src="./scripts/ui/sysinfo.js" defer></script>
  <script src="./scripts/ui/sleep.js" defer></script>
  
  <!-- App Modules -->
  <script src="./scripts/app/background-audio.js" defer></script>
  <script src="./scripts/app/background-events.js" defer></script>
  <script src="./scripts/app/player-ui.js" defer></script>
  <script src="./scripts/app/albums.js" type="module"></script>
  <script src="./scripts/app/navigation.js" type="module"></script>
  <script src="./scripts/app/downloads.js" type="module"></script>
  
  <!-- Main App -->
  <script src="./scripts/app.js" type="module"></script>
  
  <!-- Performance Monitoring -->
  <script src="./performance/rum.js" defer></script>
</head>
<body>
  <!-- Promocode Screen -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons" aria-label="–ê–ª—å–±–æ–º—ã"></div>
      
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" 
                title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" 
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div id="cover-slot" aria-label="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞"></div>
        
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" 
                title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" 
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <div id="now-playing"></div>
    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">
      <button class="filter-favorites-btn" id="filter-favorites-btn">
        –°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏
      </button>
      
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>
      
      <button id="install-pwa-btn" style="display: none;">
        –£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
      </button>
      
      <button id="download-album-main">
        –°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú
      </button>
      
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;">
        –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò
      </button>
      
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      
      <a class="support-link" id="support-link" href="#" target="_blank">
        –ü–û–î–î–ï–†–ñ–ê–¢–¨
      </a>
      
      <button class="offline-btn online" id="offline-btn">ONLINE</button>
    </div>
  </div>

  <!-- Modals Container -->
  <div id="modals-container"></div>

  <!-- Inline Scripts -->
  <script>
    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    
    const VERSION = '8.0.3';
    const BUILD_DATE = '2025-12-07';
    
    // –§–ª–∞–≥–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    window.autoNextDisabled = false;
    window.sleepTimerTarget = null;
    window.sleepTimerInterval = null;
    
    // ========== –ü–†–û–í–ï–†–ö–ê –ü–†–û–ú–û–ö–û–î–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
    
    window.addEventListener('load', () => {
      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iOS
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.body.classList.add('ios');
      }
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –µ—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
      const savedPromo = localStorage.getItem('promocode');
      if (savedPromo === 'VITRINA2025') {
        unlockAppDirectly();
      }
      
      // iOS: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–æ —É—Å—Ç–∞–Ω–æ–≤–∫—É
      detectIOSAndShowInstallGuide();
      
      // Chrome: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–æ Memory Saver
      showChromeMemorySaverHint();
    });
    
    function unlockAppDirectly() {
      const promocodeBlock = document.getElementById('promocode-block');
      const mainBlock = document.getElementById('main-block');
      
      if (promocodeBlock) promocodeBlock.classList.add('hidden');
      if (mainBlock) mainBlock.classList.remove('hidden');
      
      // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ window.app
      const waitForApp = setInterval(() => {
        if (window.app && typeof window.app.initialize === 'function') {
          clearInterval(waitForApp);
          window.app.initialize();
        }
      }, 100);
    }
    
    // ========== iOS INSTALL GUIDE ==========
    
    function detectIOSAndShowInstallGuide() {
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
      
      if (!isIOS || isStandalone) return;
      
      setTimeout(() => {
        if (localStorage.getItem('iosInstallDismissed') === '1') return;
        
        const el = document.createElement('div');
        el.className = 'ios-install-prompt';
        el.innerHTML = `
          <button class="ios-prompt-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="dismissIOSPrompt()">√ó</button>
          <div class="ios-prompt-content">
            <img class="ios-prompt-icon" src="icons/apple-touch-icon.png" alt="–ò–∫–æ–Ω–∫–∞">
            <div style="font-weight:800; font-size:18px; margin-bottom:8px;">
              –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            </div>
            <div style="opacity:.85; margin-bottom:14px;">
              –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</strong> ‚ÜóÔ∏è<br>
              –∏ –≤—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª¬ª</strong>
            </div>
            <button class="ios-prompt-button" onclick="dismissIOSPrompt()">–ü–æ–Ω—è—Ç–Ω–æ</button>
          </div>
        `;
        document.body.appendChild(el);
        
        requestAnimationFrame(() => el.classList.add('show'));
      }, 3000);
    }
    
    function dismissIOSPrompt() {
      const el = document.querySelector('.ios-install-prompt');
      if (el) {
        el.classList.remove('show');
        localStorage.setItem('iosInstallDismissed', '1');
        setTimeout(() => el.remove(), 350);
      }
    }
    
    // ========== CHROME MEMORY SAVER HINT ==========
    
    function showChromeMemorySaverHint() {
      try {
        const isChrome = /Chrome\/\d+/.test(navigator.userAgent) && 
                        !/Edg\//.test(navigator.userAgent) && 
                        !/OPR\//.test(navigator.userAgent);
        
        if (!isChrome) return;
        
        const alreadyShown = localStorage.getItem('chromeMemoryHintShown') === '1';
        if (alreadyShown) return;
        
        const container = document.querySelector('.bottom-controls-center');
        if (!container) return;
        
        const btn = document.createElement('button');
        btn.id = 'memory-saver-help-btn';
        btn.className = 'offline-btn';
        btn.style.cssText = 'width: 98%; background: #273050; margin-top: 8px;';
        btn.textContent = '–ö–∞–∫ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º—É–∑—ã–∫—É –≤ Chrome';
        
        btn.onclick = () => {
          showMemorySaverModal();
          localStorage.setItem('chromeMemoryHintShown', '1');
        };
        
        container.appendChild(btn);
      } catch (e) {
        console.warn('Failed to show Chrome hint:', e);
      }
    }
    
    function showMemorySaverModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-bg active';
      modal.innerHTML = `
        <div class="modal-feedback" style="max-width:480px;">
          <button class="bigclose" onclick="this.closest('.modal-bg').remove()" 
                  title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
            <svg viewBox="0 0 48 48">
              <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" 
                    stroke-width="6" stroke-linecap="round"/>
              <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" 
                    stroke-width="6" stroke-linecap="round"/>
            </svg>
          </button>
          
          <div style="font-size:1.1em; font-weight:800; margin-bottom:12px; color: #4daaff;">
            Chrome: –∫–∞–∫ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º—É–∑—ã–∫—É
          </div>
          
          <div style="color:#cfe3ff; background:rgba(255,255,255,.06); 
                      border:1px solid rgba(255,255,255,.1); border-radius:8px; 
                      padding:14px; line-height:1.5;">
            –ï—Å–ª–∏ –≤ Chrome –≤–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º <strong>¬´–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏¬ª</strong>, 
            –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –≤—ã–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.
            <br><br>
            <strong>–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–π—Ç –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:</strong><br>
            1Ô∏è‚É£ –û—Ç–∫—Ä–æ–π—Ç–µ <code style="background:rgba(0,0,0,.3); padding:2px 6px; 
               border-radius:4px;">chrome://settings/performance</code><br>
            2Ô∏è‚É£ –í —Ä–∞–∑–¥–µ–ª–µ ¬´–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏¬ª –Ω–∞–π–¥–∏—Ç–µ:<br>
            <em>¬´–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–∞–π—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–º–∏¬ª</em><br>
            3Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ <strong>¬´–î–æ–±–∞–≤–∏—Ç—å¬ª</strong> –∏ —É–∫–∞–∂–∏—Ç–µ:<br>
            <code style="background:rgba(77,170,255,.15); padding:3px 8px; 
                  border-radius:4px; color:#4daaff;">${location.origin}</code>
          </div>
          
          <div style="display:flex; gap:10px; justify-content:center; margin-top:16px; flex-wrap:wrap;">
            <button class="offline-btn online" id="copy-chrome-settings-btn">
              üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
            </button>
            <button class="offline-btn" onclick="this.closest('.modal-bg').remove()">
              –ü–æ–Ω—è—Ç–Ω–æ
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
      const copyBtn = modal.querySelector('#copy-chrome-settings-btn');
      copyBtn?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText('chrome://settings/performance');
          copyBtn.textContent = '‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞';
          copyBtn.style.background = '#27b34c';
          
          setTimeout(() => {
            copyBtn.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É';
            copyBtn.style.background = '';
          }, 2000);
        } catch (e) {
          console.error('Copy failed:', e);
        }
      });
    }
    
    // ========== –£–¢–ò–õ–ò–¢–´ ==========
    
    function formatTime(sec) {
      if (isNaN(sec) || sec < 0) return '--:--';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
    
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }
    
    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ì–û–†–Ø–ß–ò–• –ö–õ–ê–í–ò–® ==========
    
    function togglePlayPause() {
      if (!window.playerCore) return;
      window.playerCore.isPlaying() ? window.playerCore.pause() : window.playerCore.play();
    }
    
    function stopPlayback() {
      window.playerCore?.stop();
    }
    
    function nextTrack() {
      window.playerCore?.next();
    }
    
    function previousTrack() {
      window.playerCore?.prev();
    }
    
    function seekAudio(seconds) {
      if (!window.playerCore) return;
      const current = window.playerCore.getSeek() || 0;
      const duration = window.playerCore.getDuration() || 0;
      const newPos = Math.max(0, Math.min(duration, current + seconds));
      window.playerCore.seek(newPos);
    }
    
    function adjustVolume(delta) {
      if (!window.playerCore) return;
      const current = window.playerCore.getVolume();
      const newVolume = Math.max(0, Math.min(1, current + (delta / 100)));
      window.playerCore.setVolume(newVolume);
      
      // –û–±–Ω–æ–≤–∏—Ç—å UI –≥—Ä–æ–º–∫–æ—Å—Ç–∏
      if (window.PlayerUI) {
        window.PlayerUI.updateVolumeUI?.(newVolume);
      }
      
      localStorage.setItem('playerVolume', String(newVolume));
    }
    
    function toggleMute() {
      document.getElementById('mute-btn')?.click();
    }
    
    function toggleRepeat() {
      document.getElementById('repeat-btn')?.click();
    }
    
    function toggleShuffle() {
      document.getElementById('shuffle-btn')?.click();
    }
    
    function toggleFavoritesOnly() {
      document.getElementById('favorites-btn')?.click();
    }
    
    function toggleSleepMenu() {
      document.getElementById('sleep-timer-btn')?.click();
    }
    
    function toggleAnimation() {
      window.PlayerUI?.toggleAnimation();
    }
    
    function toggleBit() {
      window.PlayerUI?.toggleBit();
    }
    
    function setBitIntensity(value) {
      if (window.PlayerUI) {
        window.PlayerUI.bitIntensity = value;
        window.NotificationSystem?.info(`üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${value}%`);
      }
    }
    
    function toggleLyricsView() {
      window.PlayerUI?.toggleLyricsView();
    }
    
    function toggleLikePlaying() {
      const track = window.playerCore?.getCurrentTrack();
      if (!track) return;
      
      const albumKey = window.AlbumsManager?.getCurrentAlbum();
      const index = window.playerCore?.getIndex();
      
      if (albumKey !== null && typeof index === 'number') {
        const star = document.querySelector(`.track[data-index="${index}"] .like-star`);
        star?.click();
      }
    }
    
    function toggleEco() {
      document.getElementById('eco-btn')?.click();
    }
    
    function showHotkeysModal() {
      window.NavigationManager?.showHotkeysModal();
    }
    
    // ========== –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò ==========
    
    window.addEventListener('keydown', (e) => {
      // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
      const hasModal = document.querySelector('.modal-bg.active, .modal-overlay.show');
      if (e.key === 'Escape' && hasModal) {
        e.preventDefault();
        document.querySelectorAll('.modal-bg.active').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
        return;
      }
      
      if (hasModal) return;
      
      const key = e.key.toUpperCase();
      
      switch(key) {
        case ' ':
        case 'K':
          e.preventDefault();
          togglePlayPause();
          break;
        case 'X':
          e.preventDefault();
          stopPlayback();
          break;
        case 'N':
          e.preventDefault();
          nextTrack();
          break;
        case 'P':
          e.preventDefault();
          previousTrack();
          break;
        case 'J':
          e.preventDefault();
          seekAudio(-10);
          break;
        case 'L':
          e.preventDefault();
          seekAudio(10);
          break;
        case '+':
        case '=':
          e.preventDefault();
          adjustVolume(10);
          break;
        case '-':
          e.preventDefault();
          adjustVolume(-10);
          break;
        case 'M':
          e.preventDefault();
          toggleMute();
          break;
        case 'R':
          e.preventDefault();
          toggleRepeat();
          break;
        case 'U':
          e.preventDefault();
          toggleShuffle();
          break;
        case 'F':
          e.preventDefault();
          toggleFavoritesOnly();
          break;
        case 'T':
          e.preventDefault();
          toggleSleepMenu();
          break;
        case 'A':
          e.preventDefault();
          toggleAnimation();
          break;
        case 'B':
          e.preventDefault();
          toggleBit();
          break;
        case '1':
          if (window.PlayerUI?.bitEnabled) {
            e.preventDefault();
            setBitIntensity(100);
          }
          break;
        case '2':
          if (window.PlayerUI?.bitEnabled) {
            e.preventDefault();
            setBitIntensity(50);
          }
          break;
        case '3':
          if (window.PlayerUI?.bitEnabled) {
            e.preventDefault();
            setBitIntensity(15);
          }
          break;
        case 'Y':
          e.preventDefault();
          toggleLyricsView();
          break;
        case 'W':
          e.preventDefault();
          document.getElementById('track-list')?.scrollIntoView({
            behavior: 'smooth'
          });
          break;
        case 'D':
          e.preventDefault();
          toggleLikePlaying();
          break;
        case '?':
          e.preventDefault();
          showHotkeysModal();
          break;
        case 'O':
          e.preventDefault();
          window.autoNextDisabled = !window.autoNextDisabled;
          window.NotificationSystem?.info(
            window.autoNextDisabled ? '‚èπ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç–∫–ª—é—á—ë–Ω' : '‚ñ∂ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –≤–∫–ª—é—á—ë–Ω'
          );
          break;
      }
      
      // –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Ç—Ä–µ–∫–∞ –ø–æ —Ü–∏—Ñ—Ä–µ (1-9)
      if (e.key >= '1' && e.key <= '9' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
        const idx = parseInt(e.key) - 1;
        const tracks = document.querySelectorAll('.track');
        if (tracks[idx]) {
          e.preventDefault();
          tracks[idx].click();
        }
      }
    });
    
    // ========== SLEEP TIMER ==========
    
    function setSleepTimer(minutes) {
      if (minutes === 'off') {
        clearSleepTimer();
        return;
      }
      
      window.sleepTimerTarget = Date.now() + minutes * 60 * 1000;
      updateSleepTimerUI();
      
      if (window.sleepTimerInterval) {
        clearInterval(window.sleepTimerInterval);
      }
      
      window.sleepTimerInterval = setInterval(() => {
        if (!window.sleepTimerTarget) {
          clearInterval(window.sleepTimerInterval);
          window.sleepTimerInterval = null;
          return;
        }
        
        const now = Date.now();
        const msLeft = window.sleepTimerTarget - now;
        
        if (msLeft <= 0) {
          // –ö–†–ò–¢–ò–ß–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º PlayerCore
          if (window.playerCore && window.playerCore.isPlaying()) {
            window.playerCore.pause();
            window.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
          }
          clearSleepTimer();
        } else if (msLeft <= 10000 && !document.querySelector('#sleep-overlay')) {
          showSleepOverlay();
        }
        
        updateSleepTimerUI();
      }, 1000);
      
      window.NotificationSystem?.success(`‚è∞ –¢–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${minutes} –º–∏–Ω`);
    }
    
    function clearSleepTimer() {
      window.sleepTimerTarget = null;
      
      if (window.sleepTimerInterval) {
        clearInterval(window.sleepTimerInterval);
        window.sleepTimerInterval = null;
      }
      
      updateSleepTimerUI();
      
      const overlay = document.getElementById('sleep-overlay');
      if (overlay) overlay.remove();
      
      // –¢–∞–∫–∂–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤ PlayerCore
      if (window.playerCore && typeof window.playerCore.clearSleepTimer === 'function') {
        window.playerCore.clearSleepTimer();
      }
    }
    
    function updateSleepTimerUI() {
      const badge = document.getElementById('sleep-timer-badge');
      if (!badge) return;
      
      if (!window.sleepTimerTarget) {
        badge.style.display = 'none';
        badge.textContent = '';
        return;
      }
      
      const minsLeft = Math.max(0, Math.ceil((window.sleepTimerTarget - Date.now()) / 60000));
      badge.textContent = String(minsLeft);
      badge.style.display = minsLeft > 0 ? '' : 'none';
    }
    
    function showSleepOverlay() {
      let overlay = document.getElementById('sleep-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sleep-overlay';
        overlay.className = 'sleep-overlay';
        overlay.innerHTML = `
          <div class="sleep-content">
            <div class="sleep-icon">üò¥</div>
            <div class="sleep-title">–°–∫–æ—Ä–æ –ø–∞—É–∑–∞</div>
            <div class="sleep-message">
              –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ —Ç–∞–π–º–µ—Ä—É —Å–Ω–∞.
            </div>
            <div class="sleep-buttons">
              <button class="sleep-btn sleep-btn-secondary" onclick="cancelSleepOverlay()">
                –û—Ç–º–µ–Ω–∞
              </button>
              <button class="sleep-btn sleep-btn-primary" onclick="confirmSleepOverlay()">
                –û—Å—Ç–∞–≤–∏—Ç—å
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
      }
      overlay.classList.add('active');
    }
    
    function cancelSleepOverlay() {
      clearSleepTimer();
      const overlay = document.getElementById('sleep-overlay');
      if (overlay) overlay.remove();
    }
    
    function confirmSleepOverlay() {
      const overlay = document.getElementById('sleep-overlay');
      if (overlay) overlay.remove();
    }
    
    // ========== –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ò–ï –ó–ê–î–ê–ß–ò ==========
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Ç–∞–π–º–µ—Ä–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(() => {
      updateSleepTimerUI();
    }, 1000);
    
    // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–®–ò–ë–û–ö ==========
    
    window.addEventListener('error', (e) => {
      console.error('üí• Global error:', e.error || e.message);
    });
    
    window.addEventListener('unhandledrejection', (e) => {
      console.error('üí• Unhandled promise rejection:', e.reason);
    });
    
    // ========== –≠–ö–°–ü–û–†–¢ –ì–õ–û–ë–ê–õ–¨–ù–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• ==========
    
    window.VERSION = VERSION;
    window.BUILD_DATE = BUILD_DATE;
    
    console.log(`üéµ –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ v${VERSION} (${BUILD_DATE})`);
  </script>
</body>
</html>

//=================================================
// FILE: /manifest.json
{
  "name": "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "short_name": "–í–∏—Ç—Ä–∏–Ω–∞",
  "description": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#181818",
  "theme_color": "#181818",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "screenshots": [
    {
      "src": "img/screenshot-1.png",
      "sizes": "540x720",
      "type": "image/png",
      "form_factor": "narrow"
    }
  ],
  "categories": ["music", "entertainment"],
  "lang": "ru"
}

//=================================================
// FILE: /news.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0e15;
      --panel: #131a26;
      --text: #eaf2ff;
      --muted: #9db7dd;
      --accent: #4daaff;
      --danger: #E80100;
      --border: #23324a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 14px;
      background: var(--bg); color: var(--text);
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
    }
    .container { max-width: 760px; margin: 0 auto; }
    h1 { margin: 6px 0 16px; font-size: 22px; }
    .news-list { display: grid; gap: 14px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .date { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .media { margin: 10px 0; }
    .media iframe, .media img, .media video {
      width: 100%; border: 0; border-radius: 8px; min-height: 220px; background: #0b0e15;
    }
    .card p { margin: 8px 0; line-height: 1.45; }
    .tags { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 12px; color: var(--accent); background: rgba(77,170,255,.12); border: 1px solid rgba(77,170,255,.25); padding: 4px 8px; border-radius: 999px; }
    .error { color: var(--danger); background: rgba(232,1,0,.1); border: 1px solid rgba(232,1,0,.2); padding: 10px; border-radius: 8px; }
    .loading { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ù–æ–≤–æ—Å—Ç–∏</h1>
    <div id="status" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="news" class="news-list"></div>
  </div>

  <script>
    async function loadNews() {
      const status = document.getElementById('status');
      const listEl = document.getElementById('news');
      try {
        const r = await fetch('./news/news.json', { cache: 'no-cache' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const items = Array.isArray(j.items) ? j.items : [];
        status.style.display = 'none';
        if (!items.length) {
          status.style.display = '';
          status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
          return;
        }
        listEl.innerHTML = items.map(renderCard).join('');
      } catch (e) {
        status.className = 'error';
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
      }
    }
    function esc(s) { return String(s || '').replace(/[<>&'"]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&#39;','"':'&quot;'}[m])); }
    function renderCard(it) {
      const title = esc(it.title || '–ù–æ–≤–æ—Å—Ç—å');
      const date = esc(it.date || '');
      const text = esc(it.text || '');
      const tags = Array.isArray(it.tags) ? it.tags : [];
      let media = '';
      if (it.embedUrl) {
        media = `<div class="media"><iframe loading="lazy" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`;
      } else if (it.image) {
        media = `<div class="media"><img loading="lazy" src="${esc(it.image)}" alt=""></div>`;
      } else if (it.video) {
        media = `<div class="media"><video controls preload="metadata" src="${esc(it.video)}"></video></div>`;
      }
      return `<article class="card">
        <h2>${title}</h2>
        ${date ? `<div class="date">${date}</div>` : ''}
        ${media}
        ${text ? `<p>${text}</p>` : ''}
        ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join('')}</div>` : ''}
      </article>`;
    }
    loadNews();
  </script>
</body>
</html>

//=================================================
// FILE: /service-worker.js
// service-worker.js
// Service Worker –¥–ª—è PWA - —Å–æ–≤–º–µ—Å—Ç–∏–º —Å CI –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–º
const SW_VERSION = '8.0.3';
const CORE_CACHE = 'vitrina-core-v1.0.0';
const RUNTIME_CACHE = 'vitrina-runtime-v1';
const MEDIA_CACHE = 'vitrina-media-v1';
const OFFLINE_CACHE = 'vitrina-offline-v1';
const META_CACHE = 'vitrina-meta-v1';
const DEFAULT_SW_CONFIG = {
  mediaMaxCacheMB: 150,
  nonRangeMaxStoreMB: 25,
  nonRangeMaxStoreMBSlow: 10,
  allowUnknownSize: false,
  revalidateDays: 7
};

// –°—Ç–∞—Ç–∏—á–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
const STATIC_ASSETS = [
  './',
  './index.html',
  './manifest.json',
  './styles/main.css',
  './scripts/core/bootstrap.js',
  './scripts/core/config.js',
  './src/PlayerCore.js',
  './scripts/player/player-adapter.js',
  './scripts/ui/notify.js',
  './scripts/ui/favorites.js',
  './scripts/ui/favorites-const.js',
  './scripts/ui/favorites-storage.js',
  './scripts/ui/favorites-data.js',
  './scripts/ui/mini.js',
  './scripts/ui/sysinfo.js',
  './scripts/app/albums.js',
  './scripts/app/navigation.js',
  './scripts/app/downloads.js',
  './scripts/app/background-audio.js',
  './scripts/app/background-events.js',
  './scripts/app.js',
  './icons/icon-192.png',
  './icons/icon-512.png',
  './icons/apple-touch-icon.png',
  './img/logo.png',
  './img/star.png',
  './img/star2.png',
  './img/icon_album/icon-album-00.png',
  './img/icon_album/icon-album-01.png',
  './img/icon_album/icon-album-02.png',
  './img/icon_album/icon-album-news.png',
  './img/icon_album/icon-album+00.png'
];

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞
self.addEventListener('install', (event) => {
  console.log(`[SW v${SW_VERSION}] Installing...`);
  event.waitUntil(
    caches.open(CORE_CACHE)
      .then((cache) => {
        console.log('[SW] Caching static assets');
        return cache.addAll(STATIC_ASSETS);
      })
      .then(() => {
        console.log('[SW] Installed successfully');
        return self.skipWaiting();
      })
      .catch((error) => {
        console.error('[SW] Installation failed:', error);
      })
  );
});

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è
self.addEventListener('activate', (event) => {
  console.log(`[SW v${SW_VERSION}] Activating...`);
  event.waitUntil(
    caches.keys()
      .then((cacheNames) => {
        const validCaches = [CORE_CACHE, RUNTIME_CACHE, MEDIA_CACHE, OFFLINE_CACHE, META_CACHE];
        return Promise.all(
          cacheNames
            .filter((name) => !validCaches.includes(name))
            .map((name) => {
              console.log('[SW] Deleting old cache:', name);
              return caches.delete(name);
            })
        );
      })
      .then(() => {
        console.log('[SW] Activated successfully');
        return self.clients.claim();
      })
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);
  
  if (!url.protocol.startsWith('http')) return;
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ Range-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞—É–¥–∏–æ
  if (request.headers.has('range') && url.pathname.endsWith('.mp3')) {
    event.respondWith(handleRangeRequest(request));
    return;
  }
  
  if (url.hostname === 'cdn.jsdelivr.net') {
    event.respondWith(fetch(request));
    return;
  }
  
  if (request.url.endsWith('.mp3')) {
    event.respondWith(networkFirst(request, MEDIA_CACHE));
    return;
  }
  
  event.respondWith(cacheFirst(request));
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Range-–∑–∞–ø—Ä–æ—Å–æ–≤
async function handleRangeRequest(request) {
  try {
    const cache = await caches.open(MEDIA_CACHE);
    const cached = await cache.match(request);
    
    if (cached) {
      const rangeHeader = request.headers.get('range');
      if (rangeHeader) {
        const parts = rangeHeader.replace(/bytes=/, '').split('-');
        const start = parseInt(parts[0], 10);
        const end = parts[1] ? parseInt(parts[1], 10) : undefined;
        
        const blob = await cached.blob();
        const slicedBlob = blob.slice(start, end ? end + 1 : blob.size);
        
        const responseHeaders = new Headers(cached.headers);
        responseHeaders.set('Content-Range', `bytes ${start}-${end || (blob.size - 1)}/${blob.size}`);
        responseHeaders.set('Accept-Ranges', 'bytes');
        responseHeaders.set('Content-Length', slicedBlob.size);
        
        return new Response(slicedBlob, {
          status: 206,
          statusText: 'Partial Content',
          headers: responseHeaders
        });
      }
    }
    
    return cached;
  } catch (error) {
    console.error('Range request failed:', error);
    return fetch(request);
  }
}

async function cacheFirst(request) {
  try {
    const cache = await caches.open(CORE_CACHE);
    const cached = await cache.match(request);
    if (cached) {
      console.log('[SW] Serving from cache:', request.url);
      return cached;
    }
    
    const response = await fetch(request);
    if (response.ok && request.method === 'GET') {
      cache.put(request, response.clone());
    }
    return response;
  } catch (error) {
    console.error('[SW] Cache First error:', error);
    return new Response('Offline', {
      status: 503,
      statusText: 'Service Unavailable',
      headers: new Headers({ 'Content-Type': 'text/plain' })
    });
  }
}

async function networkFirst(request, cacheName) {
  try {
    const response = await fetch(request);
    if (response.ok) {
      const cache = await caches.open(cacheName);
      cache.put(request, response.clone());
    }
    return response;
  } catch (error) {
    const cache = await caches.open(cacheName);
    const cached = await cache.match(request);
    if (cached) {
      console.log('[SW] Serving from cache (offline):', request.url);
      return cached;
    }
    throw error;
  }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ–ª–∞–π–Ω-–∫—ç—à–µ–º
self.addEventListener('message', (event) => {
  if (event.data?.type === 'OFFLINE_CACHE_ADD') {
    const { resources } = event.data;
    event.waitUntil(
      caches.open(OFFLINE_CACHE)
        .then(cache => cache.addAll(resources))
        .then(() => event.ports[0]?.postMessage({ status: 'success' }))
        .catch(error => {
          console.error('[SW] OFFLINE_CACHE_ADD failed:', error);
          event.ports[0]?.postMessage({ status: 'error', message: error.message });
        })
    );
  }
  
  if (event.data?.type === 'OFFLINE_CACHE_CLEAR_CURRENT') {
    event.waitUntil(
      caches.delete(OFFLINE_CACHE)
        .then(() => caches.open(OFFLINE_CACHE))
        .then(() => event.ports[0]?.postMessage({ status: 'success' }))
        .catch(error => {
          console.error('[SW] OFFLINE_CACHE_CLEAR_CURRENT failed:', error);
          event.ports[0]?.postMessage({ status: 'error', message: error.message });
        })
    );
  }
  
  if (event.data?.type === 'SKIP_WAITING') {
    self.skipWaiting();
  }
  
  if (event.data?.type === 'CLEAR_CACHE') {
    event.waitUntil(
      caches.keys().then((names) => {
        return Promise.all(names.map((name) => caches.delete(name)));
      })
    );
  }
  
  if (event.data?.type === 'GET_SW_VERSION') {
    event.ports[0]?.postMessage({ version: SW_VERSION });
  }
  
  if (event.data?.type === 'REQUEST_OFFLINE_STATE') {
    const offline = !navigator.onLine;
    event.ports[0]?.postMessage({ type: 'OFFLINE_STATE', value: offline });
  }
});

console.log(`[SW v${SW_VERSION}] Loaded`);

//=================================================
// FILE: /performance/rum.js
;(function(){
  // –ù–µ–±–æ–ª–µ–∑–Ω–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞: —á—Ç–æ–±—ã <script src="./performance/rum.js"> –Ω–µ –¥–∞–≤–∞–ª 404
  // –∏ –Ω–µ –ª–æ–º–∞–ª –º–µ—Ç—Ä–∏–∫–∏. –ï—Å–ª–∏ –≤ custom.json –ø–æ—è–≤–∏—Ç—Å—è endpoint ‚Äî –≤–∞—à –∫–æ–¥ –≤ index.html
  // –≤—ã–∑–æ–≤–µ—Ç initRUM(...) –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏.
  if (typeof window.initRUM !== 'function') {
    window.initRUM = function initRUM() { /* no-op */ };
  }
})();

//=================================================
// FILE: /scripts/app.js
// scripts/app.js
// –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
import { APP_CONFIG } from './core/config.js';
import AlbumsManager from './app/albums.js';
import NavigationManager from './app/navigation.js';
import DownloadsManager from './app/downloads.js';
// FavoritesManager –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, –Ω–µ —á–µ—Ä–µ–∑ ESM

class App {
  constructor() {
    this.initialized = false;
    this.promoUnlocked = false;
    this.offlineMode = false;
    this.sleepTimer = null;
    this.sleepTimerTarget = null;
  }
  
  async initialize() {
    if (this.initialized) return;
    console.log(`üéµ Initializing Vitrina Razbita v${APP_CONFIG.APP_VERSION}`);
    
    try {
      // 1. –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ albumsIndex
      await this.waitForAlbumsIndex();
      
      // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
      await this.checkPromocode();
      if (!this.promoUnlocked) {
        console.log('‚è∏Ô∏è Waiting for promocode...');
        return;
      }
      
      // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI —Å–∏—Å—Ç–µ–º—ã
      this.initializeNotifications();
      
      // 4. –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–µ–µ—Ä–∞
      await this.waitForPlayer();
      
      // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π
      await this.initializeModules();
      
      // 6. PWA —Ñ—É–Ω–∫—Ü–∏–∏
      this.initializePWA();
      
      // 7. Online/Offline –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      this.initializeOnlineStatus();
      
      // 8. –§–æ–Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
      this.initializeBackgroundEvents();
      
      // 9. –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
      this.initializeHotkeys();
      
      this.initialized = true;
      console.log('‚úÖ App initialized successfully');
    } catch (error) {
      console.error('‚ùå App initialization failed:', error);
      if (window.NotificationSystem) {
        window.NotificationSystem.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
      }
    }
  }
  
  async waitForAlbumsIndex() {
    return new Promise((resolve) => {
      // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω - —Å—Ä–∞–∑—É resolve
      if (window.albumsIndex && window.albumsIndex.length > 0) {
        console.log('‚úÖ Albums index already loaded');
        resolve();
        return;
      }
      
      // –ñ–¥—ë–º –º–∞–∫—Å–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥
      let attempts = 0;
      const checkInterval = setInterval(() => {
        attempts++;
        if (window.albumsIndex && window.albumsIndex.length > 0) {
          clearInterval(checkInterval);
          console.log('‚úÖ Albums index loaded');
          resolve();
        } else if (attempts > 50) { // 50 * 100ms = 5 —Å–µ–∫—É–Ω–¥
          clearInterval(checkInterval);
          console.error('‚ùå Albums index loading timeout');
          window.albumsIndex = []; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
          resolve();
        }
      }, 100);
    });
  }
  
  async checkPromocode() {
    const promocodeBlock = document.getElementById('promocode-block');
    const mainBlock = document.getElementById('main-block');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    const savedPromo = localStorage.getItem('promocode');
    if (savedPromo === APP_CONFIG.PROMOCODE) {
      this.unlockApp(promocodeBlock, mainBlock);
      return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    const promoInput = document.getElementById('promo-inp');
    const promoBtn = document.getElementById('promo-btn');
    const promoError = document.getElementById('promo-error');
    
    const checkPromo = () => {
      const value = promoInput.value.trim();
      if (value === APP_CONFIG.PROMOCODE) {
        localStorage.setItem('promocode', value);
        this.unlockApp(promocodeBlock, mainBlock);
      } else {
        promoError.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';
        promoInput.classList.add('error');
        setTimeout(() => {
          promoError.textContent = '';
          promoInput.classList.remove('error');
        }, 2000);
      }
    };
    
    promoBtn?.addEventListener('click', checkPromo);
    promoInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkPromo();
    });
  }
  
  unlockApp(promocodeBlock, mainBlock) {
    if (promocodeBlock) promocodeBlock.classList.add('hidden');
    if (mainBlock) mainBlock.classList.remove('hidden');
    this.promoUnlocked = true;
    console.log('üîì App unlocked');
    // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    this.initialize();
  }
  
  initializeNotifications() {
    if (window.NotificationSystem) {
      console.log('‚úÖ Notification system ready');
    }
  }
  
  async waitForPlayer() {
    return new Promise((resolve) => {
      if (window.playerCore) {
        console.log('‚úÖ PlayerCore already loaded');
        resolve();
        return;
      }
      
      let attempts = 0;
      const checkInterval = setInterval(() => {
        attempts++;
        if (window.playerCore) {
          clearInterval(checkInterval);
          console.log('‚úÖ PlayerCore loaded');
          resolve();
        } else if (attempts > 50) {
          clearInterval(checkInterval);
          console.error('‚ùå PlayerCore loading timeout');
          resolve();
        }
      }, 100);
    });
  }
  
  async initializeModules() {
    if (!window.albumsIndex || window.albumsIndex.length === 0) {
      console.error('‚ùå Albums index not loaded');
      if (window.NotificationSystem) {
        window.NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤');
      }
      return;
    }
    
    console.log(`üìÄ Albums loaded: ${window.albumsIndex.length}`);
    
    if (window.AlbumsManager) {
      await window.AlbumsManager.initialize();
    }
    
    if (window.NavigationManager) {
      window.NavigationManager.initialize();
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
    if (window.FavoritesManager) {
      await window.FavoritesManager.updateRefsModel();
      console.log('‚≠ê Favorites manager ready');
    }
    
    // –§–∏–ª—å—Ç—Ä –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
    this.initializeFavoritesFilter();
    this.initializeKeyboardShortcuts();
  }
    initializeKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      const key = e.key.toLowerCase();
      
      switch(key) {
        case ' ':
        case 'k':
          e.preventDefault();
          document.getElementById('play-pause-btn')?.click();
          break;
        case 'p':
          e.preventDefault();
          window.playerCore?.prev();
          break;
        case 'n':
          e.preventDefault();
          window.playerCore?.next();
          break;
        case 'x':
          e.preventDefault();
          window.playerCore?.stop();
          break;
        case 'm':
          e.preventDefault();
          document.getElementById('mute-btn')?.click();
          break;
        case 'u':
          e.preventDefault();
          document.getElementById('shuffle-btn')?.click();
          break;
        case 'r':
          e.preventDefault();
          document.getElementById('repeat-btn')?.click();
          break;
        case 'y':
          e.preventDefault();
          window.PlayerUI?.toggleLyricsView();
          break;
        case 'a':
          e.preventDefault();
          window.PlayerUI?.toggleAnimation();
          break;
        case 'b':
          e.preventDefault();
          window.PlayerUI?.toggleBit();
          break;
        case 'f':
          e.preventDefault();
          document.getElementById('favorites-btn')?.click();
          break;
        case 't':
          e.preventDefault();
          document.getElementById('sleep-timer-btn')?.click();
          break;
      }
    });

    console.log('‚å®Ô∏è Keyboard shortcuts initialized');
  }

  initializeFavoritesFilter() {
    const filterBtn = document.getElementById('filter-favorites-btn');
    if (!filterBtn) return;
    
    let favoritesOnly = false;
    filterBtn.addEventListener('click', () => {
      favoritesOnly = !favoritesOnly;
      
      if (window.playerCore && typeof window.playerCore.setFavoritesOnly === 'function') {
        const currentAlbum = window.AlbumsManager?.getCurrentAlbum();
        const liked = currentAlbum ? window.FavoritesManager?.getLikedForAlbum(currentAlbum) : [];
        window.playerCore.setFavoritesOnly(favoritesOnly, liked);
      }
      
      if (favoritesOnly) {
        filterBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–µ—Å–Ω–∏';
        filterBtn.classList.add('active');
        this.filterTracksByFavorites(true);
      } else {
        filterBtn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏';
        filterBtn.classList.remove('active');
        this.filterTracksByFavorites(false);
      }
      
      if (window.NotificationSystem) {
        window.NotificationSystem.info(favoritesOnly ? '‚≠ê –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏' : '–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏');
      }
    });
  }
  
  filterTracksByFavorites(showOnlyFavorites) {
    const currentAlbum = window.AlbumsManager?.getCurrentAlbum();
    if (!currentAlbum) return;
    
    const tracks = document.querySelectorAll('.track');
    tracks.forEach((trackEl) => {
      const albumKey = trackEl.dataset.album;
      const trackNum = parseInt(trackEl.querySelector('.like-star')?.dataset.num);
      
      if (!trackNum) return;
      
      const isFavorite = window.FavoritesManager?.isFavorite(albumKey, trackNum);
      
      if (showOnlyFavorites && !isFavorite) {
        trackEl.style.display = 'none';
      } else {
        trackEl.style.display = '';
      }
    });
  }
  
  initializePWA() {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then((registration) => {
          console.log('‚úÖ Service Worker registered:', registration.scope);
          this.setupServiceWorkerListeners(registration);
        })
        .catch((error) => {
          console.error('‚ùå Service Worker registration failed:', error);
          if (window.NotificationSystem) {
            window.NotificationSystem.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker');
          }
        });
    }
    
    let deferredPrompt;
    const installBtn = document.getElementById('install-pwa-btn');
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (installBtn) {
        installBtn.style.display = 'block';
      }
    });
    
    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`PWA install outcome: ${outcome}`);
      deferredPrompt = null;
      installBtn.style.display = 'none';
      
      if (window.NotificationSystem) {
        if (outcome === 'accepted') {
          window.NotificationSystem.success('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
        } else {
          window.NotificationSystem.info('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
        }
      }
    });
    
    window.addEventListener('appinstalled', () => {
      console.log('‚úÖ PWA installed');
      if (window.NotificationSystem) {
        window.NotificationSystem.success('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
      }
    });
  }
  
  setupServiceWorkerListeners(registration) {
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    setInterval(async () => {
      try {
        const r = await navigator.serviceWorker.getRegistration();
        if (r) r.update();
      } catch (e) {
        console.warn('SW update check failed:', e);
      }
    }, 60 * 60 * 1000); // –ö–∞–∂–¥—ã–π —á–∞—Å
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç SW
    navigator.serviceWorker.addEventListener('message', (event) => {
      const msg = event.data || {};
      
      if (msg.type === 'SW_VERSION') {
        const swVer = String(msg.version || '');
        if (swVer && swVer !== APP_CONFIG.APP_VERSION) {
          this.handleAppUpdate(swVer);
        }
      }
      
      if (msg.type === 'OFFLINE_STATE') {
        this.offlineMode = !!msg.value;
        this.updateOfflineUI();
      }
      
      if (msg.type === 'OFFLINE_PROGRESS') {
        this.updateOfflineProgress(msg.percent);
      }
      
      if (msg.type === 'OFFLINE_DONE') {
        if (window.NotificationSystem) {
          window.NotificationSystem.success('–û—Ñ–ª–∞–π–Ω-–∫—ç—à –≥–æ—Ç–æ–≤!');
        }
      }
      
      if (msg.type === 'OFFLINE_ERROR') {
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–û—à–∏–±–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ñ–ª–∞–π–Ω');
        }
      }
    });
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ñ–ª–∞–π–Ω–∞
    try {
      registration.active?.postMessage({ type: 'REQUEST_OFFLINE_STATE' });
    } catch (e) {
      console.warn('Failed to request offline state:', e);
    }
  }
  
  handleAppUpdate(swVer) {
    if (window.NotificationSystem) {
      window.NotificationSystem.info(`–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (${swVer}). –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.`);
    }
    
    const updateBtn = document.createElement('button');
    updateBtn.id = 'update-app-btn';
    updateBtn.textContent = '–û–ë–ù–û–í–ò–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï';
    updateBtn.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: #4daaff;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    
    updateBtn.addEventListener('click', async () => {
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        if (registration && registration.waiting) {
          registration.waiting.postMessage({ type: 'SKIP_WAITING' });
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ SW
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
          });
        }
      } catch (e) {
        console.error('Update failed:', e);
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ä—É—á–Ω—É—é.');
        }
      }
      
      updateBtn.style.display = 'none';
    });
    
    document.body.appendChild(updateBtn);
  }
  
  updateOfflineUI() {
    const offlineBtn = document.getElementById('offline-btn');
    if (!offlineBtn) return;
    
    offlineBtn.textContent = this.offlineMode ? 'OFFLINE' : 'ONLINE';
    offlineBtn.className = this.offlineMode ? 'offline-btn offline' : 'offline-btn online';
    
    if (window.NotificationSystem) {
      window.NotificationSystem.info(this.offlineMode ? 'üì± –†–µ–∂–∏–º –æ—Ñ–ª–∞–π–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : 'üåê –û–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º');
    }
  }
  
  updateOfflineProgress(percent) {
    const progressBar = document.getElementById('offline-progress-bar');
    if (progressBar) {
      progressBar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
    }
  }
  
  initializeOnlineStatus() {
    const statusBtn = document.getElementById('offline-btn');
    if (!statusBtn) return;
    
    const updateStatus = () => {
      const isOnline = navigator.onLine;
      statusBtn.textContent = isOnline ? 'ONLINE' : 'OFFLINE';
      statusBtn.className = isOnline ? 'offline-btn online' : 'offline-btn offline';
    };
    
    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
    updateStatus();
  }
  
  initializeBackgroundEvents() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        this.handlePageHidden();
      } else {
        this.handlePageVisible();
      }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç–∞—Ä–µ–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    if ('getBattery' in navigator) {
      navigator.getBattery().then(battery => {
        battery.addEventListener('levelchange', () => {
          this.handleBatteryLevelChange(battery);
        });
        battery.addEventListener('chargingchange', () => {
          this.handleChargingChange(battery);
        });
      });
    }
  }
  
  handlePageHidden() {
    console.log('üì± Page hidden');
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    if (window.playerCore) {
      const position = window.playerCore.getSeek();
      localStorage.setItem('lastTrackPosition', position.toString());
    }
  }
  
  handlePageVisible() {
    console.log('üì± Page visible');
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
    const savedPosition = localStorage.getItem('lastTrackPosition');
    if (savedPosition && window.playerCore) {
      const position = parseFloat(savedPosition);
      if (!isNaN(position)) {
        window.playerCore.seek(position);
      }
    }
  }
  
  handleBatteryLevelChange(battery) {
    const level = Math.round(battery.level * 100);
    if (level < 15 && !battery.charging && window.NotificationSystem) {
      window.NotificationSystem.warning(`–ù–∏–∑–∫–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏: ${level}%`);
    }
  }
  
  handleChargingChange(battery) {
    if (battery.charging && window.NotificationSystem) {
      window.NotificationSystem.info('üîã –ó–∞—Ä—è–¥–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
    }
  }
  
  initializeHotkeys() {
    window.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal-bg.active');
        if (modals.length > 0) {
          modals.forEach(modal => modal.classList.remove('active'));
          e.preventDefault();
          return;
        }
      }
      
      // –í—ã–∑–æ–≤ —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –≥–æ—Ä—è—á–∏–º –∫–ª–∞–≤–∏—à–∞–º
      if (e.key === '?' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        this.showHotkeysModal();
        return;
      }
      
      // –û—Å—Ç–∞–ª—å–Ω—ã–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ player-adapter.js
    });
  }
  
  showHotkeysModal() {
    const modal = document.getElementById('hotkeys-modal');
    if (modal) {
      modal.classList.add('active');
    }
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const app = new App();

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => app.initialize());
} else {
  app.initialize();
}

window.app = app;
export default app;

//=================================================
// FILE: /scripts/app/albums.js
// scripts/app/albums.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞–º–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å—Ç–∞—Ä–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

import { APP_CONFIG } from '../core/config.js';

class AlbumsManager {
  constructor() {
    this.currentAlbum = null;
    this.albumsData = new Map();
    this.isLoading = false;
    this.galleryIndex = 0;
    this.galleryItems = [];
  }

  async initialize() {
    if (!window.albumsIndex || window.albumsIndex.length === 0) {
      console.error('‚ùå No albums found');
      return;
    }

    console.log(`‚úÖ Albums available: ${window.albumsIndex.length}`);

    this.renderAlbumIcons();
    this.setupGalleryNavigation();
    
    const lastAlbum = localStorage.getItem('currentAlbum');
    const albumToLoad = lastAlbum || window.albumsIndex[0].key;
    
    await this.loadAlbum(albumToLoad);
  }

  renderAlbumIcons() {
    const container = document.getElementById('album-icons');
    if (!container) return;

    container.innerHTML = '';

    APP_CONFIG.ICON_ALBUMS_ORDER.forEach(({ key, title, icon }) => {
      if (!key.startsWith('__')) {
        const exists = window.albumsIndex.some(a => a.key === key);
        if (!exists) return;
      }

      const iconEl = document.createElement('div');
      iconEl.className = 'album-icon';
      iconEl.dataset.album = key;
      iconEl.dataset.akey = key; // –î–ª—è E2E —Ç–µ—Å—Ç–æ–≤
      iconEl.title = title;
      iconEl.innerHTML = `<img src="${icon}" alt="${title}" draggable="false">`;

      iconEl.addEventListener('click', () => this.loadAlbum(key));
      container.appendChild(iconEl);
    });
  }

  async loadAlbum(albumKey) {
    if (this.isLoading) return;
    this.isLoading = true;

    try {
      // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–µ–µ—Ä –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ –∏–≥—Ä–∞–µ—Ç
      // (—Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é: "–ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç")
      if (window.playerCore && !window.playerCore.isPlaying()) {
        window.playerCore.stop();
      }

      this.clearUI();

      if (albumKey === '__favorites__') {
        await this.loadFavoritesAlbum();
      } else if (albumKey === '__reliz__') {
        await this.loadNewsAlbum();
      } else {
        await this.loadRegularAlbum(albumKey);
      }

      this.updateActiveIcon(albumKey);
      this.currentAlbum = albumKey;
      localStorage.setItem('currentAlbum', albumKey);

      console.log(`‚úÖ Album loaded: ${albumKey}`);

    } catch (error) {
      console.error('‚ùå Failed to load album:', error);
      window.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–∞');
    } finally {
      this.isLoading = false;
    }
  }

  async loadRegularAlbum(albumKey) {
    const albumInfo = window.albumsIndex.find(a => a.key === albumKey);
    if (!albumInfo) {
      throw new Error(`Album ${albumKey} not found`);
    }

    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º config.json (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∞–ª—å–±–æ–º–∞)
    let albumData = this.albumsData.get(albumKey);

    if (!albumData) {
      const base = albumInfo.base.endsWith('/') ? albumInfo.base : `${albumInfo.base}/`;
      const response = await fetch(`${base}config.json`, { cache: 'no-cache' });
      if (!response.ok) {
        throw new Error(`Failed to load config.json for ${albumKey}: HTTP ${response.status}`);
      }

      const raw = await response.json();
      const data = raw || {};

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç—Ä–µ–∫–∏: –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ URL –¥–ª—è –∞—É–¥–∏–æ/–ª–∏—Ä–∏–∫–∏/–ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
      const tracks = Array.isArray(data.tracks) ? data.tracks : [];
      const normTracks = tracks.map((t, idx) => ({
        num: t.num ?? (idx + 1),
        title: t.title || `–¢—Ä–µ–∫ ${idx + 1}`,
        // –í –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –ø–æ–ª–µ –æ–±—ã—á–Ω–æ audio, –∞ –Ω–µ file
        file: t.audio ? new URL(t.audio, base).toString() : null,
        lyrics: t.lyrics ? new URL(t.lyrics, base).toString() : null,
        fulltext: t.fulltext ? new URL(t.fulltext, base).toString() : null
      }));

      const coverPath = data.cover || 'cover.jpg';

      albumData = {
        title: data.albumName || albumInfo.title,
        artist: data.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        cover: coverPath,
        social_links: Array.isArray(data.social_links) ? data.social_links : [],
        tracks: normTracks
      };

      this.albumsData.set(albumKey, albumData);
    }

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –æ–±–ª–æ–∂–∫–∏)
    await this.loadGallery(albumKey);

    // 3. –†–µ–Ω–¥–µ—Ä UI
    this.renderAlbumTitle(albumData.title || albumInfo.title);
    this.renderCover(albumInfo, albumData);
    this.renderSocials(albumData.social_links);
    this.renderTrackList(albumData.tracks, albumInfo);

    // 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –¥–ª—è PlayerCore
    if (window.playerCore) {
      const tracksForCore = albumData.tracks
        .filter(t => !!t.file)
        .map((t) => ({
          src: t.file,
          title: t.title,
          artist: albumData.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          album: albumData.title || albumInfo.title,
          cover: new URL(albumData.cover || 'cover.jpg', albumInfo.base).toString(),
          lyrics: t.lyrics || null,
          fulltext: t.fulltext || null
        }));

      window.playerCore.setPlaylist(tracksForCore, 0, {
        artist: albumData.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: albumData.title || albumInfo.title,
        cover: new URL(albumData.cover || 'cover.jpg', albumInfo.base).toString()
      });
    }

    const coverWrap = document.getElementById('cover-wrap');
    if (coverWrap) coverWrap.style.display = '';
  }

  async loadGallery(albumKey) {
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ centralId –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
    let centralId = null;
    
    if (albumKey === 'mezhdu-zlom-i-dobrom') centralId = '01';
    else if (albumKey === 'golos-dushi') centralId = '02';
    else if (albumKey === 'krevetochka') centralId = '00';

    if (!centralId) {
      this.galleryItems = [];
      return;
    }

    try {
      const response = await fetch(`./albums/gallery/${centralId}/index.json`, {
        cache: 'force-cache'
      });
      
      if (response.ok) {
        const data = await response.json();
        this.galleryItems = Array.isArray(data.items) ? data.items : [];
        this.galleryIndex = 0;
        
        this.updateGalleryNavigation();
      }
    } catch (error) {
      console.warn('Failed to load gallery:', error);
      this.galleryItems = [];
    }
  }

  setupGalleryNavigation() {
    const leftBtn = document.getElementById('cover-gallery-arrow-left');
    const rightBtn = document.getElementById('cover-gallery-arrow-right');

    leftBtn?.addEventListener('click', () => {
      if (this.galleryItems.length <= 1) return;
      this.galleryIndex = (this.galleryIndex - 1 + this.galleryItems.length) % this.galleryItems.length;
      this.renderGalleryCover();
    });

    rightBtn?.addEventListener('click', () => {
      if (this.galleryItems.length <= 1) return;
      this.galleryIndex = (this.galleryIndex + 1) % this.galleryItems.length;
      this.renderGalleryCover();
    });
  }

  updateGalleryNavigation() {
    const coverWrap = document.getElementById('cover-wrap');
    if (!coverWrap) return;

    if (this.galleryItems.length > 1) {
      coverWrap.classList.add('gallery-nav-ready');
    } else {
      coverWrap.classList.remove('gallery-nav-ready');
    }
  }

  renderGalleryCover() {
    if (!this.galleryItems.length) return;

    const item = this.galleryItems[this.galleryIndex];
    const coverSlot = document.getElementById('cover-slot');
    if (!coverSlot) return;

    if (item.type === 'html' && item.src) {
      coverSlot.innerHTML = `<iframe src="${item.src}" frameborder="0" loading="lazy"></iframe>`;
    } else if (item.formats) {
      const src = item.formats.webp || item.formats.full || item.src;
      coverSlot.innerHTML = `<img src="${src}" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
    } else if (item.src) {
      coverSlot.innerHTML = `<img src="${item.src}" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
    }
  }

  async loadFavoritesAlbum() {
    this.renderAlbumTitle('‚≠ê‚≠ê‚≠ê –ò–ó–ë–†–ê–ù–ù–û–ï ‚≠ê‚≠ê‚≠ê', 'fav');
    
    if (typeof window.openFavoritesView === 'function') {
      await window.openFavoritesView();
    } else {
      const container = document.getElementById('track-list');
      if (container) {
        container.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #8ab8fd;">
            <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏</h3>
            <p>–û—Ç–º–µ—Ç—å—Ç–µ —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π ‚≠ê</p>
          </div>
        `;
      }
    }

    const coverWrap = document.getElementById('cover-wrap');
    if (coverWrap) coverWrap.style.display = 'none';
  }

  async loadNewsAlbum() {
    this.renderAlbumTitle('üì∞ –ù–û–í–û–°–¢–ò üì∞', 'news');
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ –Ω–æ–≤–æ—Å—Ç–µ–π
    await this.loadGallery('__reliz__');
    
    const coverSlot = document.getElementById('cover-slot');
    if (coverSlot && this.galleryItems.length) {
      this.galleryIndex = 0;
      this.renderGalleryCover();
    }

    const container = document.getElementById('track-list');
    if (container) {
      container.innerHTML = `
        <div style="padding: 20px; text-align: center; color: #8ab8fd;">
          <h3>–°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏</h3>
          <p>–ù–æ–≤—ã–µ —Ç—Ä–µ–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
          <div style="margin-top: 20px;">
            <a href="https://t.me/vitrina_razbita" target="_blank" 
               style="color: #4daaff; text-decoration: underline;">
              Telegram –∫–∞–Ω–∞–ª
            </a>
            ¬∑
            <a href="./news.html" target="_blank"
               style="color: #4daaff; text-decoration: underline;">
              –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
            </a>
          </div>
        </div>
      `;
    }

    const coverWrap = document.getElementById('cover-wrap');
    if (coverWrap) coverWrap.style.display = '';
  }

  renderAlbumTitle(title, modifier = '') {
    const titleEl = document.getElementById('active-album-title');
    if (titleEl) {
      titleEl.textContent = title;
      titleEl.className = 'active-album-title';
      if (modifier) titleEl.classList.add(modifier);
    }
  }

  renderCover(albumInfo, albumData) {
    const coverSlot = document.getElementById('cover-slot');
    if (!coverSlot) return;

    if (this.galleryItems.length > 0) {
      this.renderGalleryCover();
    } else {
      const coverUrl = albumData.cover 
        ? `${albumInfo.base}${albumData.cover}` 
        : `${albumInfo.base}cover.jpg`;
      
      coverSlot.innerHTML = `<img src="${coverUrl}" alt="${albumInfo.title}" draggable="false" loading="lazy">`;
    }
  }

  renderSocials(links) {
    const container = document.getElementById('social-links');
    if (!container) return;

    container.innerHTML = '';
    if (!links || links.length === 0) return;

    links.forEach(link => {
      const a = document.createElement('a');
      a.href = link.url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = link.label;
      container.appendChild(a);
    });
  }

  renderTrackList(tracks, albumInfo) {
    const container = document.getElementById('track-list');
    if (!container) return;

    container.innerHTML = '';

    tracks.forEach((track, index) => {
      const trackEl = this.createTrackElement(track, albumInfo.key, index);
      container.appendChild(trackEl);
    });
  }

  createTrackElement(track, albumKey, index) {
    const trackEl = document.createElement('div');
    trackEl.className = 'track';
    trackEl.id = `trk${index}`;
    trackEl.dataset.index = index;
    trackEl.dataset.album = albumKey;

    const isFavorite = window.getLikedForAlbum?.(albumKey)?.includes(track.num) || false;

    trackEl.innerHTML = `
      <div class="tnum">${track.num || index + 1}</div>
      <div class="track-title">${track.title}</div>
      <img src="${isFavorite ? 'img/star.png' : 'img/star2.png'}" 
           class="like-star" 
           alt="–∑–≤–µ–∑–¥–∞"
           data-album="${albumKey}" 
           data-num="${track.num || index + 1}">
    `;

    // –ö–ª–∏–∫ –ø–æ —Ç—Ä–µ–∫—É - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    trackEl.addEventListener('click', (e) => {
      if (e.target.classList.contains('like-star')) return;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
      document.querySelectorAll('.track.current').forEach(el => el.classList.remove('current'));
      trackEl.classList.add('current');
      
      window.playerCore?.play(index);
    });

    // –ö–ª–∏–∫ –ø–æ –∑–≤–µ–∑–¥–æ—á–∫–µ - –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
    const star = trackEl.querySelector('.like-star');
    star?.addEventListener('click', (e) => {
      e.stopPropagation();
      const trackNum = parseInt(star.dataset.num);
      const wasLiked = window.getLikedForAlbum?.(albumKey)?.includes(trackNum);
      
      window.toggleLikeForAlbum?.(albumKey, trackNum, !wasLiked);
      star.src = wasLiked ? 'img/star2.png' : 'img/star.png';
      
      // –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∞—Å—Å is-favorite
      trackEl.classList.toggle('is-favorite', !wasLiked);
    });

    return trackEl;
  }

  updateActiveIcon(albumKey) {
    document.querySelectorAll('.album-icon').forEach(icon => {
      icon.classList.toggle('active', icon.dataset.album === albumKey);
    });
  }

  clearUI() {
    const trackList = document.getElementById('track-list');
    const coverSlot = document.getElementById('cover-slot');
    const socials = document.getElementById('social-links');

    if (trackList) trackList.innerHTML = '';
    if (coverSlot) coverSlot.innerHTML = '';
    if (socials) socials.innerHTML = '';
    
    this.galleryItems = [];
    this.galleryIndex = 0;
    this.updateGalleryNavigation();
  }

  getCurrentAlbum() {
    return this.currentAlbum;
  }

  getAlbumData(albumKey) {
    return this.albumsData.get(albumKey);
  }
}

window.AlbumsManager = new AlbumsManager();

export default AlbumsManager;

//=================================================
// FILE: /scripts/app/background-audio.js
// scripts/app/background-audio.js
// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
class BackgroundAudioManager {
  constructor() {
    this.isSupported = 'mediaSession' in navigator;
    this.audioContext = null;
    this.init();
  }
  
  init() {
    if (!this.isSupported) {
      console.warn('Media Session API not supported');
      return;
    }
    
    this.setupMediaSession();
    this.attachPlayerEvents();
    console.log('‚úÖ Background audio initialized');
    
    // iOS —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞
    this.setupIOSBackgroundAudio();
  }
  
  setupMediaSession() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    const actionHandlers = {
      play: () => window.playerCore?.play(),
      pause: () => window.playerCore?.pause(),
      previoustrack: () => window.playerCore?.prev(),
      nexttrack: () => window.playerCore?.next(),
      seekbackward: (details) => {
        if (window.playerCore) {
          const current = window.playerCore.getSeek() || 0;
          window.playerCore.seek(Math.max(0, current - (details.seekOffset || 10)));
        }
      },
      seekforward: (details) => {
        if (window.playerCore) {
          const current = window.playerCore.getSeek() || 0;
          const duration = window.playerCore.getDuration() || 0;
          window.playerCore.seek(Math.min(duration, current + (details.seekOffset || 10)));
        }
      },
      seekto: (details) => {
        if (details.seekTime && window.playerCore) {
          window.playerCore.seek(details.seekTime);
        }
      },
      stop: () => window.playerCore?.stop()
    };
    
    for (const [action, handler] of Object.entries(actionHandlers)) {
      try {
        navigator.mediaSession.setActionHandler(action, handler);
      } catch (error) {
        console.warn(`Action ${action} not supported:`, error);
      }
    }
  }
  
  attachPlayerEvents() {
    if (!window.playerCore) {
      setTimeout(() => this.attachPlayerEvents(), 500);
      return;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç—Ä–µ–∫–∞
    window.playerCore.on({
      onTrackChange: (track) => {
        this.updateMetadata(track);
      },
      onTick: (position, duration) => {
        this.updatePositionState({ position, duration });
      }
    });
  }
  
  updateMetadata(track) {
    if (!this.isSupported || !track) return;
    
    try {
      const albumInfo = window.albumsIndex?.find(a => a.key === track.album);
      const albumTitle = albumInfo?.title || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞';
      
      // –ü–æ–ª—É—á–∏—Ç—å –æ–±–ª–æ–∂–∫—É
      let artworkUrl = 'icons/icon-512.png';
      if (albumInfo) {
        const albumData = window.AlbumsManager?.getAlbumData(track.album);
        if (albumData?.cover) {
          artworkUrl = `${albumInfo.base}${albumData.cover}`;
        }
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–±–ª–æ–∂–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
      const artwork = [
        { src: artworkUrl, sizes: '96x96', type: 'image/png' },
        { src: artworkUrl, sizes: '128x128', type: 'image/png' },
        { src: artworkUrl, sizes: '192x192', type: 'image/png' },
        { src: artworkUrl, sizes: '256x256', type: 'image/png' },
        { src: artworkUrl, sizes: '384x384', type: 'image/png' },
        { src: artworkUrl, sizes: '512x512', type: 'image/png' }
      ];
      
      navigator.mediaSession.metadata = new MediaMetadata({
        title: track.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—Ä–µ–∫',
        artist: track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: albumTitle,
        artwork: artwork
      });
      
      console.log('üéµ Media metadata updated:', track.title);
    } catch (error) {
      console.error('Failed to update metadata:', error);
    }
  }
  
  updatePositionState(data) {
    if (!this.isSupported) return;
    
    try {
      if ('setPositionState' in navigator.mediaSession) {
        navigator.mediaSession.setPositionState({
          duration: data.duration || 0,
          playbackRate: 1.0,
          position: data.position || 0
        });
      }
    } catch (error) {
      console.error('Failed to update position state:', error);
    }
  }
  
  setupIOSBackgroundAudio() {
    // –î–ª—è iOS –≤ Standalone —Ä–µ–∂–∏–º–µ
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  
    if (!isIOS) return;
  
    console.log('üì± iOS detected - enabling background audio support');
  
    // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      console.log('‚úÖ AudioContext created for iOS background audio');
    
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      const unlockAudio = () => {
        if (this.audioContext.state === 'suspended') {
          this.audioContext.resume().then(() => {
            console.log('üîä iOS Audio Context resumed');
          });
        }
        document.removeEventListener('touchstart', unlockAudio);
        document.removeEventListener('touchend', unlockAudio);
      };
    
      document.addEventListener('touchstart', unlockAudio);
      document.addEventListener('touchend', unlockAudio);
    
    } catch (error) {
      console.warn('Failed to create AudioContext:', error);
    }
  
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && this.audioContext) {
        console.log('üì± iOS page visible - checking audio state');
        try {
          if (this.audioContext.state === 'suspended') {
            this.audioContext.resume().catch(e => console.warn('Resume failed:', e));
          }
        
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ Howler
          if (window.Howler && window.Howler.ctx && window.Howler.ctx.state === 'suspended') {
            window.Howler.ctx.resume().catch(e => console.warn('Howler resume failed:', e));
          }
        
          // –ï—Å–ª–∏ –ø–ª–µ–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–≥—Ä–∞—Ç—å - –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º
          if (window.playerCore && window.playerCore.isPlaying && window.playerCore.isPlaying()) {
            const currentTrack = window.playerCore.getCurrentTrack();
            if (currentTrack) {
              console.log('üì± Resuming playback:', currentTrack.title);
            }
          }
        } catch (error) {
          console.error('Failed to resume after iOS background:', error);
        }
      }
    });
  
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è webkitendfullscreen (—Å—Ç–∞—Ä—ã–µ iOS)
    document.addEventListener('webkitendfullscreen', () => {
      console.log('üì± iOS webkitendfullscreen event');
      if (this.audioContext && this.audioContext.state === 'suspended') {
        this.audioContext.resume();
      }
    });
  }
  
  getAudioContext() {
    return this.audioContext;
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.BackgroundAudioManager = new BackgroundAudioManager();
  });
} else {
  window.BackgroundAudioManager = new BackgroundAudioManager();
}

//=================================================
// FILE: /scripts/app/background-events.js
// scripts/app/background-events.js
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π (visibility, online/offline, battery)

(function() {
  'use strict';

  class BackgroundEventsManager {
    constructor() {
      this.wasPlaying = false;
      this.isOnline = navigator.onLine;
      this.init();
    }

    init() {
      this.setupVisibilityHandler();
      this.setupNetworkHandlers();
      this.setupBatteryHandler();
      this.setupBeforeUnloadHandler();
      this.setupPopstateHandler();

      console.log('‚úÖ Background events initialized');
    }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (Back/Forward)
  setupPopstateHandler() {
    window.addEventListener('popstate', (event) => {
      console.log('üìç Popstate event:', event.state);
      
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      if (event.state && event.state.albumKey) {
        window.AlbumsManager?.loadAlbum(event.state.albumKey);
      }
    });
  }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setupVisibilityHandler() {
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          this.onPageHidden();
        } else {
          this.onPageVisible();
        }
      });
    }

    onPageHidden() {
      console.log('üì± Page hidden');
      
      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
      if (window.playerCore) {
        this.wasPlaying = window.playerCore.isPlaying();
      }

      // –ú–æ–∂–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏
      // (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π)
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (isMobile && this.wasPlaying) {
        // window.playerCore?.pause();
        // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ - –ø—É—Å—Ç—å –∏–≥—Ä–∞–µ—Ç –≤ —Ñ–æ–Ω–µ
      }
    }

    onPageVisible() {
      console.log('üì± Page visible');
      
      // –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ
      if (this.wasPlaying && window.playerCore) {
        // window.playerCore.play();
        // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ - —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω
    setupNetworkHandlers() {
      window.addEventListener('online', () => {
        this.onOnline();
      });

      window.addEventListener('offline', () => {
        this.onOffline();
      });
    }

    onOnline() {
      console.log('üåê Online');
      this.isOnline = true;
      
      window.NotificationSystem?.success('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      
      const offlineBtn = document.getElementById('offline-btn');
      if (offlineBtn) {
        offlineBtn.className = 'offline-btn online';
        offlineBtn.textContent = 'ONLINE';
      }
    }

    onOffline() {
      console.log('üì¥ Offline');
      this.isOnline = false;
      
      window.NotificationSystem?.offline('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
      
      const offlineBtn = document.getElementById('offline-btn');
      if (offlineBtn) {
        offlineBtn.className = 'offline-btn offline';
        offlineBtn.textContent = 'OFFLINE';
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç–∞—Ä–µ–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    async setupBatteryHandler() {
      if (!('getBattery' in navigator)) {
        console.warn('Battery API not supported');
        return;
      }

      try {
        const battery = await navigator.getBattery();
        
        battery.addEventListener('levelchange', () => {
          this.onBatteryLevelChange(battery);
        });

        battery.addEventListener('chargingchange', () => {
          this.onChargingChange(battery);
        });

        // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        this.onBatteryLevelChange(battery);
      } catch (error) {
        console.warn('Battery API error:', error);
      }
    }

    onBatteryLevelChange(battery) {
      const level = Math.round(battery.level * 100);
      console.log(`üîã Battery level: ${level}%`);

      // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∑–∞—Ä—è–¥–µ
      if (level < 15 && !battery.charging) {
        window.NotificationSystem?.warning(
          `–ù–∏–∑–∫–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏: ${level}%`,
          4000
        );
      }
    }

    onChargingChange(battery) {
      if (battery.charging) {
        console.log('üîå Charging');
      } else {
        console.log('üîã Not charging');
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
    setupBeforeUnloadHandler() {
      window.addEventListener('beforeunload', () => {
        this.saveState();
      });
    }

    saveState() {
      try {
        if (window.playerCore) {
          const currentTrack = window.playerCore.getIndex();
          const position = window.playerCore.getSeek();
          
          localStorage.setItem('lastTrackIndex', currentTrack.toString());
          localStorage.setItem('lastTrackPosition', position.toString());
        }

        const currentAlbum = window.AlbumsManager?.getCurrentAlbum();
        if (currentAlbum) {
          localStorage.setItem('currentAlbum', currentAlbum);
        }

        console.log('üíæ State saved');
      } catch (error) {
        console.error('Failed to save state:', error);
      }
    }

    // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    getNetworkStatus() {
      return this.isOnline;
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.BackgroundEventsManager = new BackgroundEventsManager();
    });
  } else {
    window.BackgroundEventsManager = new BackgroundEventsManager();
  }
})();

//=================================================
// FILE: /scripts/app/downloads.js
// scripts/app/downloads.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º —Ç—Ä–µ–∫–æ–≤ –∏ –∞–ª—å–±–æ–º–æ–≤
class DownloadsManager {
  constructor() {
    this.downloadQueue = [];
    this.isDownloading = false;
  }

  async downloadAlbum(albumKey) {
    const albumInfo = window.albumsIndex?.find(a => a.key === albumKey);
    if (!albumInfo) {
      console.error('Album not found:', albumKey);
      return;
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–ª—å–±–æ–º–∞
    const albumData = window.AlbumsManager?.getAlbumData(albumKey);
    if (!albumData) {
      window.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–ª—å–±–æ–º–∞');
      return;
    }
    
    window.NotificationSystem?.info(`–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é: ${albumInfo.title}`);
    
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
    const files = albumData.tracks.map(track => ({
      url: `${albumInfo.base}${track.file}`,
      filename: `${albumInfo.title} - ${track.num}. ${track.title}.mp3`
    }));
    
    // –î–æ–±–∞–≤–∏—Ç—å –æ–±–ª–æ–∂–∫—É
    if (albumData.cover) {
      files.push({
        url: `${albumInfo.base}${albumData.cover}`,
        filename: `${albumInfo.title} - cover.jpg`
      });
    }
    
    // –ù–∞—á–∞—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
    this.downloadFiles(files, albumInfo.title);
  }

  async downloadFiles(files, albumTitle) {
    if (!files || files.length === 0) return;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    if (!this.isDownloadSupported()) {
      this.fallbackDownload(files);
      return;
    }
    
    window.NotificationSystem?.info(`–°–∫–∞—á–∏–≤–∞–Ω–∏–µ ${files.length} —Ñ–∞–π–ª–æ–≤...`);
    let completed = 0;
    
    for (const file of files) {
      try {
        await this.downloadFile(file.url, file.filename);
        completed++;
        window.NotificationSystem?.info(
          `–°–∫–∞—á–∞–Ω–æ ${completed} –∏–∑ ${files.length}`,
          { duration: 2000 }
        );
        // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è–º–∏ (—á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±—Ä–∞—É–∑–µ—Ä)
        await this.delay(500);
      } catch (error) {
        console.error('Download failed:', file.filename, error);
      }
    }
    
    window.NotificationSystem?.success(`‚úÖ –ê–ª—å–±–æ–º "${albumTitle}" —Å–∫–∞—á–∞–Ω!`);
  }

  async downloadFile(url, filename) {
    return new Promise((resolve, reject) => {
      if (!navigator.onLine) {
        reject(new Error('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É'));
        return;
      }
    
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);
    
      fetch(url, { signal: controller.signal })
        .then(response => {
          clearTimeout(timeoutId);
        
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        
          const contentType = response.headers.get('content-type');
          if (!contentType || (!contentType.includes('audio') && !contentType.includes('octet-stream'))) {
            console.warn('‚ö†Ô∏è Unexpected content type:', contentType);
          }
        
          return response.blob();
        })
        .then(blob => {
          if (blob.size === 0) {
            throw new Error('–§–∞–π–ª –ø—É—Å—Ç–æ–π (0 –±–∞–π—Ç)');
          }
        
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = this.sanitizeFilename(filename);
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        
          setTimeout(() => URL.revokeObjectURL(link.href), 100);
        
          console.log(`‚úÖ Downloaded: ${filename} (${(blob.size / 1024 / 1024).toFixed(2)} MB)`);
          resolve();
        })
        .catch(error => {
          clearTimeout(timeoutId);
        
          if (error.name === 'AbortError') {
            reject(new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è'));
          } else {
            reject(error);
          }
        });
    });
  }

  sanitizeFilename(filename) {
    // –£–¥–∞–ª–∏—Ç—å –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    return filename.replace(/[<>:"/\\|?*]/g, '_');
  }

  isDownloadSupported() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ download attribute
    const a = document.createElement('a');
    return typeof a.download !== 'undefined';
  }

  fallbackDownload(files) {
    // –û—Ç–∫—Ä—ã—Ç—å –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Å–∫–∞—á–∞–µ—Ç)
    window.NotificationSystem?.info('–û—Ç–∫—Ä–æ—é—Ç—Å—è –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
    files.forEach((file, index) => {
      setTimeout(() => {
        window.open(file.url, '_blank');
      }, index * 300);
    });
  }

  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.DownloadsManager = new DownloadsManager();
export default DownloadsManager;

//=================================================
// FILE: /scripts/app/navigation.js
// scripts/app/navigation.js
// –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
class NavigationManager {
  constructor() {
    this.modalsContainer = null;
    this.activeModal = null;
    this.sleepTimer = null;
    this.sleepTimerTarget = null;
  }
  
  initialize() {
    this.modalsContainer = document.getElementById('modals-container');
    this.setupEventListeners();
    this.setupMediaSessionHandlers();
    console.log('‚úÖ NavigationManager initialized');
  }
  
  setupEventListeners() {
    // –ö–Ω–æ–ø–∫–∞ "–û —Å–∏—Å—Ç–µ–º–µ"
    const sysinfoBtn = document.getElementById('sysinfo-btn');
    sysinfoBtn?.addEventListener('click', () => {
      this.showSystemInfo();
    });
    
    // –ö–Ω–æ–ø–∫–∞ "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å"
    const feedbackLink = document.getElementById('feedback-link');
    feedbackLink?.addEventListener('click', () => {
      this.showFeedbackModal();
    });
    
    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å"
    const supportLink = document.getElementById('support-link');
    if (supportLink) {
      supportLink.href = 'https://example.com/support';
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å –∞–ª—å–±–æ–º"
    const downloadBtn = document.getElementById('download-album-main');
    downloadBtn?.addEventListener('click', () => {
      this.downloadCurrentAlbum();
    });
    
    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    const hotkeysBtn = document.getElementById('hotkeys-btn');
    hotkeysBtn?.addEventListener('click', () => {
      this.showHotkeysModal();
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    this.modalsContainer?.addEventListener('click', (e) => {
      if (e.target === this.modalsContainer) {
        this.closeModal();
      }
    });
    
    // –°–∫—Ä–æ–ª–ª –¥–ª—è –º–∏–Ω–∏-—Ä–µ–∂–∏–º–∞
    window.addEventListener('scroll', () => {
      this.handleScroll();
    }, { passive: true });
  }
  
  handleScroll() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const miniMode = document.body.classList.contains('mini-mode');
    
    if (scrollTop > 300 && !miniMode) {
      this.enableMiniMode();
    } else if (scrollTop < 100 && miniMode) {
      this.disableMiniMode();
    }
  }
  
  setupMediaSessionHandlers() {
    if (!('mediaSession' in navigator)) return;
    
    try {
      navigator.mediaSession.setActionHandler('play', () => {
        window.playerCore?.play();
      });
      
      navigator.mediaSession.setActionHandler('pause', () => {
        window.playerCore?.pause();
      });
      
      navigator.mediaSession.setActionHandler('previoustrack', () => {
        window.playerCore?.prev();
      });
      
      navigator.mediaSession.setActionHandler('nexttrack', () => {
        window.playerCore?.next();
      });
      
      console.log('‚úÖ Media Session handlers set');
    } catch (e) {
      console.error('Failed to setup Media Session:', e);
    }
  }
  
  showSystemInfo() {
    this.showModal(`
      <h2>–û —Å–∏—Å—Ç–µ–º–µ</h2>
      <div style="text-align: left; padding: 20px;">
        <p><strong>–í–µ—Ä—Å–∏—è:</strong> ${APP_CONFIG.APP_VERSION}</p>
        <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
        <p><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${navigator.platform}</p>
        <p><strong>–Ø–∑—ã–∫:</strong> ${navigator.language}</p>
        <p><strong>–†–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞:</strong> ${window.innerWidth}√ó${window.innerHeight}</p>
        <p><strong>Online:</strong> ${navigator.onLine ? '–î–∞' : '–ù–µ—Ç'}</p>
        <p><strong>Service Worker:</strong> ${'serviceWorker' in navigator ? '–î–∞' : '–ù–µ—Ç'}</p>
      </div>
      <button class="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    `);
  }
  
  showFeedbackModal() {
    this.showModal(`
      <h2>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h2>
      <div style="padding: 20px; text-align: center;">
        <p style="margin-bottom: 20px; color: #8ab8fd;">
          –ï—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞—à–ª–∏ –æ—à–∏–±–∫—É?<br>
          –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º!
        </p>
        <div style="display: flex; flex-direction: column; gap: 15px; max-width: 300px; margin: 0 auto;">
          <a href="https://t.me/vitrina_razbita" target="_blank" 
             style="background: #0088cc; color: white; padding: 15px; border-radius: 8px; text-decoration: none; display: block;">
            üì± Telegram
          </a>
          <a href="mailto:support@vitrina-razbita.ru" target="_blank"
             style="background: #4daaff; color: white; padding: 15px; border-radius: 8px; text-decoration: none; display: block;">
            ‚úâÔ∏è Email
          </a>
          <a href="https://github.com/apel-s-in/vi3na1bita-music" target="_blank"
             style="background: #333; color: white; padding: 15px; border-radius: 8px; text-decoration: none; display: block;">
            üêô GitHub
          </a>
        </div>
      </div>
      <button class="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    `);
  }
  
  showHotkeysModal() {
    this.showModal(`
      <h2>üìå –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h2>
      <div class="hotkeys-section">
        <h3>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
        <div class="hotkey-item"><span class="hotkey-combo">K / –ü—Ä–æ–±–µ–ª</span><span class="hotkey-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">X</span><span class="hotkey-desc">–°—Ç–æ–ø</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">N / P</span><span class="hotkey-desc">–°–ª–µ–¥—É—é—â–∏–π/–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">J / L</span><span class="hotkey-desc">–ü–µ—Ä–µ–º–æ—Ç–∫–∞ ‚Üê10—Å–µ–∫ / 10—Å–µ–∫‚Üí</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">+ / -</span><span class="hotkey-desc">–ì—Ä–æ–º–∫–æ—Å—Ç—å ¬±10%</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>üéµ –†–µ–∂–∏–º—ã</h3>
        <div class="hotkey-item"><span class="hotkey-combo">R</span><span class="hotkey-desc">–ü–æ–≤—Ç–æ—Ä</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">U</span><span class="hotkey-desc">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">F</span><span class="hotkey-desc">–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">M</span><span class="hotkey-desc">–ë–µ–∑ –∑–≤—É–∫–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">T</span><span class="hotkey-desc">–¢–∞–π–º–µ—Ä —Å–Ω–∞</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>‚ú® –≠—Ñ—Ñ–µ–∫—Ç—ã</h3>
        <div class="hotkey-item"><span class="hotkey-combo">A</span><span class="hotkey-desc">–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">B</span><span class="hotkey-desc">–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">1 / 2 / 3</span><span class="hotkey-desc">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (100%/50%/15%)</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
        <div class="hotkey-item"><span class="hotkey-combo">Y</span><span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ª–∏—Ä–∏–∫—É</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">W</span><span class="hotkey-desc">–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Å–ø–∏—Å–∫—É —Ç—Ä–µ–∫–æ–≤</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">D</span><span class="hotkey-desc">–î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">Esc</span><span class="hotkey-desc">–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">?</span><span class="hotkey-desc">–≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞</span></div>
      </div>
      <button class="modal-close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    `);
  }
  
  async downloadCurrentAlbum() {
    const currentAlbum = window.AlbumsManager?.getCurrentAlbum();
    if (!currentAlbum) {
      if (window.NotificationSystem) {
        window.NotificationSystem.error('–ù–µ –≤—ã–±—Ä–∞–Ω –∞–ª—å–±–æ–º');
      }
      return;
    }
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –Ω–µ–ª—å–∑—è —Å–∫–∞—á–∞—Ç—å
    if (currentAlbum.startsWith('__')) {
      if (window.NotificationSystem) {
        window.NotificationSystem.info('–≠—Ç–æ—Ç –∞–ª—å–±–æ–º –Ω–µ–ª—å–∑—è —Å–∫–∞—á–∞—Ç—å —Ü–µ–ª–∏–∫–æ–º');
      }
      return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Downloads Manager
    if (window.DownloadsManager) {
      window.DownloadsManager.downloadAlbum(currentAlbum);
    } else {
      // Fallback: –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (window.NotificationSystem) {
        window.NotificationSystem.info('–§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      }
    }
  }
  
  showModal(content) {
    if (!this.modalsContainer) return;
    this.closeModal(); // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        ${content}
      </div>
    `;
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
    const closeBtn = modal.querySelector('.modal-close-btn');
    closeBtn?.addEventListener('click', () => this.closeModal());
    
    this.modalsContainer.appendChild(modal);
    this.activeModal = modal;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    requestAnimationFrame(() => {
      modal.classList.add('show');
    });
  }
  
  closeModal() {
    if (!this.activeModal) return;
    this.activeModal.classList.remove('show');
    setTimeout(() => {
      if (this.activeModal && this.activeModal.parentNode) {
        this.activeModal.parentNode.removeChild(this.activeModal);
      }
      this.activeModal = null;
    }, 300);
  }
  
  enableMiniMode() {
    document.body.classList.add('mini-mode');
    localStorage.setItem('miniMode', '1');
    
    // –°–∫—Ä—ã—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    this.hideElements([
      '#cover-wrap',
      '#social-links',
      '.album-icons',
      '.active-album-title'
    ]);
    
    console.log('üì± Mini mode enabled');
  }
  
  disableMiniMode() {
    document.body.classList.remove('mini-mode');
    localStorage.setItem('miniMode', '0');
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ
    this.showElements([
      '#cover-wrap',
      '#social-links',
      '.album-icons',
      '.active-album-title'
    ]);
    
    console.log('üì± Mini mode disabled');
  }
  
  hideElements(selectors) {
    selectors.forEach(selector => {
      const el = document.querySelector(selector);
      if (el) {
        el.style.display = 'none';
      }
    });
  }
  
  showElements(selectors) {
    selectors.forEach(selector => {
      const el = document.querySelector(selector);
      if (el) {
        el.style.display = '';
      }
    });
  }
  
  // –¢–∞–π–º–µ—Ä —Å–Ω–∞
  setSleepTimer(minutes) {
    if (minutes === 'off') {
      this.clearSleepTimer();
      return;
    }
    
    this.sleepTimerTarget = Date.now() + minutes * 60 * 1000;
    this.updateSleepTimerUI();
    
    if (this.sleepTimer) {
      clearInterval(this.sleepTimer);
    }
    
    this.sleepTimer = setInterval(() => this.checkSleepTimer(), 1000);
    
    if (window.NotificationSystem) {
      window.NotificationSystem.info(`–¢–∞–π–º–µ—Ä —Å–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${minutes} –º–∏–Ω—É—Ç`);
    }
  }
  
  clearSleepTimer() {
    if (this.sleepTimer) {
      clearInterval(this.sleepTimer);
      this.sleepTimer = null;
    }
    this.sleepTimerTarget = null;
    this.updateSleepTimerUI();
    
    const overlay = document.getElementById('sleep-overlay');
    if (overlay) overlay.remove();
    
    if (window.NotificationSystem) {
      window.NotificationSystem.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω');
    }
  }
  
  checkSleepTimer() {
    if (!this.sleepTimerTarget) return;
    
    const now = Date.now();
    const msLeft = this.sleepTimerTarget - now;
    
    if (msLeft <= 0) {
      window.playerCore?.pause();
      this.clearSleepTimer();
      
      if (window.NotificationSystem) {
        window.NotificationSystem.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      }
    } else if (msLeft <= 10000 && !document.querySelector('#sleep-overlay')) {
      this.showSleepOverlay();
    }
    
    this.updateSleepTimerUI();
  }
  
  updateSleepTimerUI() {
    const badge = document.getElementById('sleep-timer-badge');
    if (!this.sleepTimerTarget) {
      if (badge) badge.style.display = 'none';
      return;
    }
    
    const minsLeft = Math.max(0, Math.ceil((this.sleepTimerTarget - Date.now()) / 60000));
    if (badge) {
      badge.textContent = String(minsLeft);
      badge.style.display = '';
    }
  }
  
  showSleepOverlay() {
    let overlay = document.getElementById('sleep-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'sleep-overlay';
      overlay.className = 'sleep-overlay';
      overlay.innerHTML = `
        <div class="sleep-content">
          <div class="sleep-icon">üò¥</div>
          <div class="sleep-title">–°–∫–æ—Ä–æ –ø–∞—É–∑–∞</div>
          <div class="sleep-message">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ —Ç–∞–π–º–µ—Ä—É —Å–Ω–∞.</div>
          <div class="sleep-buttons">
            <button class="sleep-btn sleep-btn-secondary" onclick="window.NavigationManager?.cancelSleepTimer()">–û—Ç–º–µ–Ω–∞</button>
            <button class="sleep-btn sleep-btn-primary" onclick="document.getElementById('sleep-overlay')?.remove()">–û—Å—Ç–∞–≤–∏—Ç—å</button>
          </div>
        </div>`;
      document.body.appendChild(overlay);
    }
  }
  
  cancelSleepTimer() {
    this.clearSleepTimer();
    const overlay = document.getElementById('sleep-overlay');
    if (overlay) overlay.remove();
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.NavigationManager = new NavigationManager();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
window.cancelSleepTimer = () => {
  if (window.NavigationManager) {
    window.NavigationManager.cancelSleepTimer();
  }
};

export default NavigationManager;

//=================================================
// FILE: /scripts/app/player-ui.js
// scripts/app/player-ui.js
// –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π UI –ø–ª–µ–µ—Ä–∞ —Å Sleep Timer –∏ Favorites-Only

(function PlayerUIModule() {
  'use strict';

  const w = window;

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  let currentLyrics = [];
  let lyricsViewMode = 'normal';
  let isSeekingProgress = false;
  let isMuted = false;
  let animationEnabled = false;
  let bitEnabled = false;
  let bitIntensity = 100;
  let favoritesOnlyMode = false;

  // Audio Context –¥–ª—è –ø—É–ª—å—Å–∞—Ü–∏–∏
  let audioContext = null;
  let analyser = null;
  let audioSource = null;
  let animationFrame = null;

  const LYRICS_MIN_INTERVAL = 250;
  let lyricsLastIdx = -1;
  let lyricsLastTs = 0;

  // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========

  function initPlayerUI() {
    if (!w.playerCore) {
      setTimeout(initPlayerUI, 100);
      return;
    }

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è PlayerCore
    w.playerCore.on({
      onTrackChange: (track, index) => {
        ensurePlayerBlock();
        loadLyrics(track?.lyrics);
        updateTrackInfo(track);
        updateDownloadLink(track);
        highlightCurrentTrack(index);
      },
      onPlay: () => {
        updatePlayPauseIcon();
      },
      onPause: () => {
        updatePlayPauseIcon();
      },
      onStop: () => {
        updatePlayPauseIcon();
        resetProgress();
      },
      onTick: (position, duration) => {
        if (!isSeekingProgress) {
          updateProgress(position, duration);
          renderLyricsEnhanced(position);
        }
      }
    });

    restoreSettings();
    initFavoritesOnlyMode();
    
    console.log('‚úÖ PlayerUI initialized');
  }

  // ========== –†–ï–ù–î–ï–†–ò–ù–ì –ë–õ–û–ö–ê –ü–õ–ï–ï–†–ê ==========

  function ensurePlayerBlock() {
    const container = document.getElementById('now-playing');
    if (!container) return;

    if (document.getElementById('lyricsplayerblock')) {
      return; // –£–∂–µ —Å–æ–∑–¥–∞–Ω
    }

    container.innerHTML = `
      <div class="lyrics-player-block" id="lyricsplayerblock">
        <div id="lyrics-window" class="lyrics-${lyricsViewMode}">
          <div class="lyrics-animated-bg${animationEnabled ? ' active' : ''}"></div>
          <div class="lyrics-scroll" id="lyrics"></div>
        </div>
        
        <div class="player-progress-wrapper">
          <div class="player-progress-bar" id="player-progress-bar">
            <div class="player-progress-fill" id="player-progress-fill">
              <div class="player-progress-handle"></div>
            </div>
          </div>
        </div>
        
        <div class="audio-wrapper">
          <div id="audio-slot"></div>
        </div>
        
        <div class="player-controls">
          <div class="player-controls-row">
            <span class="time-in-controls" id="time-elapsed">00:00</span>
            
            <button class="player-control-btn" id="prev-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫ (P)" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M11 5L4 12l7 7V5zm9 0v14l-7-7 7-7z"/>
              </svg>
            </button>
            
            <button class="player-control-btn main" id="play-pause-btn" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞ (K/–ü—Ä–æ–±–µ–ª)" aria-label="–ò–≥—Ä–∞—Ç—å/–ü–∞—É–∑–∞">
              <svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
            
            <button class="player-control-btn" id="stop-btn" title="–°—Ç–æ–ø (X)" aria-label="–°—Ç–æ–ø">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="6" width="12" height="12"/>
              </svg>
            </button>
            
            <button class="player-control-btn" id="next-btn" title="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ (N)" aria-label="–°–ª–µ–¥—É—é—â–∏–π">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M13 5l7 7-7 7V5zM4 5v14l7-7-7-7z"/>
              </svg>
            </button>
            
            <span class="time-in-controls" id="time-remaining">--:--</span>
          </div>
          
          <div class="player-controls-row">
            <button class="player-control-btn" id="mute-btn" title="–ë–µ–∑ –∑–≤—É–∫–∞ (M)" aria-label="–ó–≤—É–∫">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
              </svg>
            </button>
            
            <button class="player-control-btn" id="shuffle-btn" title="–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (U)" aria-label="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 17h2.735a4 4 0 003.43-1.942l3.67-6.116A4 4 0 0116.265 7H21m0 0l-3-3m3 3l-3 3"/>
                <path d="M3 7h2.735a4 4 0 013.43 1.942l3.67 6.116A4 4 0 0016.265 17H21m0 0l-3 3m3-3l-3-3"/>
              </svg>
            </button>
            
            <button class="player-control-btn animation-btn" id="animation-btn" title="–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ (A)" aria-label="–ê–Ω–∏–º–∞—Ü–∏—è">A</button>
            <button class="player-control-btn bit-btn" id="bit-btn" title="–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ (B)" aria-label="–ü—É–ª—å—Å–∞—Ü–∏—è">B</button>
            
            <button class="player-control-btn" id="repeat-btn" title="–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ (R)" aria-label="–ü–æ–≤—Ç–æ—Ä">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 2l4 4-4 4"/>
                <path d="M3 11V9a4 4 0 014-4h14"/>
                <path d="M7 22l-4-4 4-4"/>
                <path d="M21 13v2a4 4 0 01-4 4H3"/>
                <circle cx="12" cy="12" r="1" fill="currentColor"/>
              </svg>
            </button>
            
            <button class="sleep-timer-btn" id="sleep-timer-btn" title="–¢–∞–π–º–µ—Ä —Å–Ω–∞ (T)" aria-label="–¢–∞–π–º–µ—Ä —Å–Ω–∞">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"></circle>
                <path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
              <span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none;">0</span>
            </button>
            
            <button class="player-control-btn" id="favorites-btn" title="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (F)" aria-label="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">
              <img src="img/star2.png" alt="‚òÖ" id="favorites-btn-icon"/>
            </button>
          </div>
        </div>
        
        <div class="volume-control-wrapper">
          <div class="volume-track"></div>
          <div class="volume-fill" id="volume-fill"></div>
          <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100" aria-label="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
        </div>
        
        <div class="player-buttons-wrapper">
          <button class="lyrics-toggle-btn lyrics-${lyricsViewMode}" id="lyrics-toggle-btn" title="–†–µ–∂–∏–º –ª–∏—Ä–∏–∫–∏ (Y)" aria-label="–†–µ–∂–∏–º –ª–∏—Ä–∏–∫–∏">
            <span class="lyrics-toggle-btn-visual">–¢</span>
            <span class="lyrics-toggle-label">${getLyricsModeLabel()}</span>
          </button>
          
          <div class="player-extra-buttons-row">
            <button class="karaoke-btn" id="lyrics-text-btn">üìù –¢–ï–ö–°–¢</button>
            <a class="player-download-btn" href="#" id="track-download-btn" download>üíæ –°–ö–ê–ß–ê–¢–¨</a>
            <button id="eco-btn" class="eco-btn" title="–£–ª—å—Ç—Ä–∞-—ç–∫–æ–Ω–æ–º">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M13 3L4 14h6l-1 7 9-11h-6l1-7z"/>
              </svg>
              <span class="eco-label">–≠–ö–û</span>
            </button>
          </div>
        </div>
      </div>
    `;

    bindPlayerEvents();
  }

  // ========== –ü–†–ò–í–Ø–ó–ö–ê –°–û–ë–´–¢–ò–ô ==========

  function bindPlayerEvents() {
    // Play/Pause
    const playPauseBtn = document.getElementById('play-pause-btn');
    playPauseBtn?.addEventListener('click', () => {
      if (w.playerCore.isPlaying()) {
        w.playerCore.pause();
      } else {
        w.playerCore.play();
      }
    });

    // Prev/Next/Stop
    document.getElementById('prev-btn')?.addEventListener('click', () => w.playerCore.prev());
    document.getElementById('next-btn')?.addEventListener('click', () => w.playerCore.next());
    document.getElementById('stop-btn')?.addEventListener('click', () => w.playerCore.stop());

    // Repeat
    document.getElementById('repeat-btn')?.addEventListener('click', toggleRepeat);

    // Shuffle
    document.getElementById('shuffle-btn')?.addEventListener('click', toggleShuffle);

    // Mute
    document.getElementById('mute-btn')?.addEventListener('click', toggleMute);

    // Volume
    const volumeSlider = document.getElementById('volume-slider');
    volumeSlider?.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value) / 100;
      w.playerCore.setVolume(value);
      updateVolumeUI(value);
      localStorage.setItem('playerVolume', String(value));
      isMuted = false;
    });

    // Progress bar
    const progressBar = document.getElementById('player-progress-bar');
    
    progressBar?.addEventListener('mousedown', startSeeking);
    progressBar?.addEventListener('touchstart', startSeeking);
    
    document.addEventListener('mousemove', handleSeeking);
    document.addEventListener('touchmove', handleSeeking);
    
    document.addEventListener('mouseup', stopSeeking);
    document.addEventListener('touchend', stopSeeking);

    // Lyrics toggle
    document.getElementById('lyrics-toggle-btn')?.addEventListener('click', toggleLyricsView);

    // Animation
    document.getElementById('animation-btn')?.addEventListener('click', toggleAnimation);

    // Bit
    document.getElementById('bit-btn')?.addEventListener('click', toggleBit);

    // Favorites only
    document.getElementById('favorites-btn')?.addEventListener('click', toggleFavoritesOnly);

    // Lyrics text modal
    document.getElementById('lyrics-text-btn')?.addEventListener('click', () => {
      w.LyricsModal?.show();
    });

    // Download track
    const downloadBtn = document.getElementById('track-download-btn');
    downloadBtn?.addEventListener('click', (e) => {
      const track = w.playerCore.getCurrentTrack();
      if (!track || !track.src) {
        e.preventDefault();
        w.NotificationSystem?.error('–¢—Ä–µ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
      }
    });

    // Eco mode
    document.getElementById('eco-btn')?.addEventListener('click', toggleEcoMode);
  }

  // ========== PROGRESS BAR ==========

  function startSeeking(e) {
    isSeekingProgress = true;
    handleSeeking(e);
  }

  function handleSeeking(e) {
    if (!isSeekingProgress) return;

    const progressBar = document.getElementById('player-progress-bar');
    if (!progressBar) return;

    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const rect = progressBar.getBoundingClientRect();
    const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    const duration = w.playerCore.getDuration();
    
    const newPosition = duration * percent;
    w.playerCore.seek(newPosition);
    updateProgress(newPosition, duration);
  }

  function stopSeeking() {
    isSeekingProgress = false;
  }

  function updateProgress(position, duration) {
    const percent = (position / duration) * 100;
    const fill = document.getElementById('player-progress-fill');
    if (fill) fill.style.width = `${Math.min(100, percent)}%`;

    const elapsed = document.getElementById('time-elapsed');
    const remaining = document.getElementById('time-remaining');
    
    if (elapsed) elapsed.textContent = formatTime(position);
    if (remaining) remaining.textContent = formatTime(Math.max(0, duration - position));
  }

  function resetProgress() {
    const fill = document.getElementById('player-progress-fill');
    if (fill) fill.style.width = '0%';

    const elapsed = document.getElementById('time-elapsed');
    const remaining = document.getElementById('time-remaining');
    
    if (elapsed) elapsed.textContent = '00:00';
    if (remaining) remaining.textContent = '--:--';
  }

  // ========== PLAY/PAUSE ==========

  function updatePlayPauseIcon() {
    const icon = document.getElementById('play-pause-icon');
    const btn = document.getElementById('play-pause-btn');
    if (!icon || !btn) return;

    if (w.playerCore.isPlaying()) {
      icon.innerHTML = '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>';
      btn.title = '–ü–∞—É–∑–∞ (K/–ü—Ä–æ–±–µ–ª)';
    } else {
      icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
      btn.title = '–ò–≥—Ä–∞—Ç—å (K/–ü—Ä–æ–±–µ–ª)';
    }
  }

  // ========== VOLUME ==========

  function toggleMute() {
    if (isMuted) {
      const saved = parseFloat(localStorage.getItem('playerVolume') || '1');
      w.playerCore.setVolume(saved);
      isMuted = false;
      updateVolumeUI(saved);
    } else {
      localStorage.setItem('playerVolume', String(w.playerCore.getVolume()));
      w.playerCore.setVolume(0);
      isMuted = true;
      updateVolumeUI(0);
    }
  }

  function updateVolumeUI(volume) {
    const percent = Math.round(volume * 100);
    const fill = document.getElementById('volume-fill');
    const slider = document.getElementById('volume-slider');
    
    if (fill) fill.style.width = `${percent}%`;
    if (slider) slider.value = percent;
  }

  // ========== REPEAT & SHUFFLE ==========

  function toggleRepeat() {
    const newState = !w.playerCore.repeat;
    w.playerCore.setRepeat(newState);
    
    const btn = document.getElementById('repeat-btn');
    btn?.classList.toggle('repeat-active', newState);
    
    localStorage.setItem('repeatMode', newState ? '1' : '0');
    w.NotificationSystem?.info(newState ? 'üîÅ –ü–æ–≤—Ç–æ—Ä: –í–ö–õ' : 'üîÅ –ü–æ–≤—Ç–æ—Ä: –í–´–ö–õ');
  }

  function toggleShuffle() {
    const newState = !w.playerCore.shuffle;
    w.playerCore.setShuffle(newState);
    
    const btn = document.getElementById('shuffle-btn');
    btn?.classList.toggle('active', newState);
    
    localStorage.setItem('shuffleMode', newState ? '1' : '0');
    w.NotificationSystem?.info(newState ? 'üîÄ –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ: –í–ö–õ' : 'üîÄ –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ: –í–´–ö–õ');
  }

  // ========== FAVORITES ONLY MODE ==========

  function initFavoritesOnlyMode() {
    try {
      favoritesOnlyMode = localStorage.getItem('favoritesOnlyMode') === '1';
      applyFavoritesOnlyState();
    } catch {}
  }

  function toggleFavoritesOnly() {
    favoritesOnlyMode = !favoritesOnlyMode;
    applyFavoritesOnlyState();
    
    try {
      localStorage.setItem('favoritesOnlyMode', favoritesOnlyMode ? '1' : '0');
    } catch {}

    if (favoritesOnlyMode) {
      applyFavoritesFilter();
      w.NotificationSystem?.success('‚≠ê –†–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ');
    } else {
      clearFavoritesFilter();
      w.NotificationSystem?.info('üéµ –†–µ–∂–∏–º: –≤—Å–µ —Ç—Ä–µ–∫–∏');
    }
  }

  function applyFavoritesOnlyState() {
    const btn = document.getElementById('favorites-btn');
    const icon = document.getElementById('favorites-btn-icon');
    
    if (btn) btn.classList.toggle('favorites-active', favoritesOnlyMode);
    if (icon) icon.src = favoritesOnlyMode ? 'img/star.png' : 'img/star2.png';
  }

  function applyFavoritesFilter() {
    const currentAlbum = w.AlbumsManager?.getCurrentAlbum();
    if (!currentAlbum || currentAlbum.startsWith('__')) return;

    const likedIndices = w.getLikedForAlbum?.(currentAlbum) || [];
    
    if (likedIndices.length === 0) {
      w.NotificationSystem?.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ');
      favoritesOnlyMode = false;
      applyFavoritesOnlyState();
      localStorage.setItem('favoritesOnlyMode', '0');
      return;
    }

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ PlayerCore
    if (typeof w.playerCore.setFavoritesOnly === 'function') {
      w.playerCore.setFavoritesOnly(true, likedIndices);
      
      // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –Ω–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–π - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
      const currentIndex = w.playerCore.getIndex();
      if (!likedIndices.includes(currentIndex)) {
        w.playerCore.play(likedIndices[0]);
      }
    }
  }

  function clearFavoritesFilter() {
    if (typeof w.playerCore.setFavoritesOnly === 'function') {
      w.playerCore.setFavoritesOnly(false, []);
    }
  }

  // ========== LYRICS ==========

  async function loadLyrics(lyricsUrl) {
    if (!lyricsUrl) {
      currentLyrics = [];
      renderLyrics(0);
      return;
    }

    try {
      const response = await fetch(lyricsUrl);
      if (!response.ok) throw new Error('HTTP error');
      
      const data = await response.json();
      currentLyrics = Array.isArray(data) ? data : [];
      renderLyrics(0);
      
    } catch (error) {
      console.warn('Failed to load lyrics:', error);
      currentLyrics = [];
      renderLyrics(0);
    }
  }

  function renderLyrics(time) {
    const lyricsEl = document.getElementById('lyrics');
    if (!lyricsEl) return;

    if (!currentLyrics || !currentLyrics.length) {
      lyricsEl.innerHTML = '<div class="lyrics-window-line" style="opacity:0.5;">–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
      return;
    }

    const windowSize = (lyricsViewMode === 'expanded') ? 9 : 5;
    const centerLine = Math.floor(windowSize / 2);
    
    let active = 0;
    for (let i = 0; i < currentLyrics.length; i++) {
      if (time >= currentLyrics[i].time) active = i;
      else break;
    }

    const start = Math.max(0, active - centerLine);
    const padTop = Math.max(0, centerLine - active);
    const rows = [];

    for (let p = 0; p < padTop; p++) {
      rows.push('<div class="lyrics-window-line"></div>');
    }

    for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
      const cls = (i === active) ? 'lyrics-window-line active' : 'lyrics-window-line';
      const line = escapeHtml(currentLyrics[i]?.line || '');
      rows.push(`<div class="${cls}">${line}</div>`);
    }

    while (rows.length < windowSize) {
      rows.push('<div class="lyrics-window-line"></div>');
    }

    lyricsEl.innerHTML = rows.join('');
  }

  function renderLyricsEnhanced(time) {
    if (lyricsViewMode === 'hidden' || !currentLyrics.length) return;

    let idx = 0;
    for (let i = 0; i < currentLyrics.length; i++) {
      if (time >= currentLyrics[i].time) idx = i;
      else break;
    }

    const now = performance.now();
    if (idx === lyricsLastIdx && (now - lyricsLastTs) < LYRICS_MIN_INTERVAL) {
      return;
    }

    lyricsLastIdx = idx;
    lyricsLastTs = now;
    renderLyrics(time);
  }

  function toggleLyricsView() {
    const modes = ['normal', 'hidden', 'expanded'];
    const currentIndex = modes.indexOf(lyricsViewMode);
    lyricsViewMode = modes[(currentIndex + 1) % modes.length];
    
    applyLyricsViewMode();
    saveLyricsViewMode();

    const messages = {
      'normal': 'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥',
      'hidden': 'üö´ –õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞',
      'expanded': 'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∏–¥'
    };
    
    w.NotificationSystem?.info(messages[lyricsViewMode]);
  }

  function applyLyricsViewMode() {
    const win = document.getElementById('lyrics-window');
    const btn = document.getElementById('lyrics-toggle-btn');
    const label = btn?.querySelector('.lyrics-toggle-label');
    
    if (win) win.className = `lyrics-${lyricsViewMode}`;
    if (btn) btn.className = `lyrics-toggle-btn lyrics-${lyricsViewMode}`;
    if (label) label.textContent = getLyricsModeLabel();

    if (lyricsViewMode === 'hidden') {
      applyAnimationState(false);
    }
  }

  function getLyricsModeLabel() {
    const labels = {
      'normal': '–û–±—ã—á–Ω—ã–π',
      'hidden': '–°–∫—Ä—ã—Ç–∞',
      'expanded': '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π'
    };
    return labels[lyricsViewMode] || '';
  }

  // ========== ANIMATION ==========

  function toggleAnimation() {
    applyAnimationState(!animationEnabled);
    localStorage.setItem('animationEnabled', animationEnabled ? '1' : '0');
    w.NotificationSystem?.info(animationEnabled ? '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è: –í–ö–õ' : '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è: –í–´–ö–õ');
  }

  function applyAnimationState(on) {
    animationEnabled = !!on;
    
    const win = document.getElementById('lyrics-window');
    const bg = win?.querySelector('.lyrics-animated-bg');
    const btn = document.getElementById('animation-btn');
    
    if (win) win.classList.toggle('animation-active', animationEnabled);
    if (bg) bg.classList.toggle('active', animationEnabled);
    if (btn) btn.classList.toggle('animation-active', animationEnabled);
  }

  // ========== BIT (LOGO PULSATION) ==========

  function toggleBit() {
    bitEnabled = !bitEnabled;
    localStorage.setItem('bitEnabled', bitEnabled ? '1' : '0');
    
    const btn = document.getElementById('bit-btn');
    if (btn) btn.classList.toggle('bit-active', bitEnabled);

    if (bitEnabled) {
      initAudioContext();
      startLogoPulsation();
      w.NotificationSystem?.info(`üíø –ü—É–ª—å—Å–∞—Ü–∏—è: –í–ö–õ`);
    } else {
      stopLogoPulsation();
      w.NotificationSystem?.info('üíø –ü—É–ª—å—Å–∞—Ü–∏—è: –í–´–ö–õ');
    }
  }

  function initAudioContext() {
    try {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      if (audioContext.state === 'suspended') {
        audioContext.resume().catch(() => {});
      }

      if (!analyser) {
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
      }

      // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Howler
      if (w.Howler && w.Howler.ctx && !audioSource) {
        try {
          const howlerDest = w.Howler.ctx.destination;
          // –ù–ï –ø–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é - —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
          // audioSource —Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        } catch (e) {
          console.warn('Failed to connect to Howler:', e);
        }
      }

    } catch (e) {
      console.warn('Failed to init audio context:', e);
    }
  }

  function startLogoPulsation() {
    const logo = document.getElementById('logo-bottom');
    if (!logo) return;

    if (animationFrame) cancelAnimationFrame(animationFrame);
    
    const dataArray = analyser ? new Uint8Array(analyser.frequencyBinCount) : new Uint8Array(32);

    function loop(ts) {
      if (!bitEnabled) return;

      let level = 0.35;
      
      if (analyser) {
        try {
          analyser.getByteFrequencyData(dataArray);
          const bassCount = Math.max(4, Math.floor(dataArray.length * 0.2));
          let sum = 0;
          for (let i = 0; i < bassCount; i++) sum += dataArray[i];
          level = (sum / (bassCount * 255));
        } catch {}
      } else {
        // Fallback –∞–Ω–∏–º–∞—Ü–∏—è –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
        level = 0.5 + 0.3 * Math.sin(ts / 300);
      }

      const intensity = bitIntensity / 100;
      const scale = 1 + (level * 0.15 * intensity);
      
      if (logo) {
        logo.style.transform = `scale(${scale.toFixed(3)})`;
      }
      
      animationFrame = requestAnimationFrame(loop);
    }

    animationFrame = requestAnimationFrame(loop);
  }

  function stopLogoPulsation() {
    if (animationFrame) {
      cancelAnimationFrame(animationFrame);
      animationFrame = null;
    }

    const logo = document.getElementById('logo-bottom');
    if (logo) logo.style.transform = 'scale(1)';

    // –û—á–∏—Å—Ç–∫–∞ –∞—É–¥–∏–æ-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    try {
      if (audioSource) {
        audioSource.disconnect();
        audioSource = null;
      }
      if (analyser) {
        analyser.disconnect();
        analyser = null;
      }
      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close().catch(() => {});
      }
    } catch {}

    audioContext = null;
  }

  // ========== ECO MODE ==========

  let ecoMode = false;

  function toggleEcoMode() {
    ecoMode = !ecoMode;
    
    const btn = document.getElementById('eco-btn');
    if (btn) btn.classList.toggle('active', ecoMode);

    if (ecoMode) {
      // –û—Ç–∫–ª—é—á–∏—Ç—å —ç–Ω–µ—Ä–≥–æ—ë–º–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
      if (animationEnabled) toggleAnimation();
      if (bitEnabled) toggleBit();
      
      // –°–Ω–∏–∑–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      if (w.playerCore && w.playerCore._tickIntervalMs) {
        w.playerCore._tickIntervalMs = 1000;
      }
      
      w.NotificationSystem?.success('‚ö° –£–ª—å—Ç—Ä–∞-—ç–∫–æ–Ω–æ–º: –í–ö–õ');
    } else {
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É
      if (w.playerCore && w.playerCore._tickIntervalMs) {
        w.playerCore._tickIntervalMs = 250;
      }
      
      w.NotificationSystem?.info('‚ö° –£–ª—å—Ç—Ä–∞-—ç–∫–æ–Ω–æ–º: –í–´–ö–õ');
    }

    localStorage.setItem('ecoMode', ecoMode ? '1' : '0');
  }

  // ========== TRACK INFO ==========

  function updateTrackInfo(track) {
    // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    if (track) {
      document.title = `${track.title} - –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞`;
    }
  }

  function updateDownloadLink(track) {
    const downloadBtn = document.getElementById('track-download-btn');
    if (!downloadBtn || !track) return;

    if (track.src) {
      downloadBtn.href = track.src;
      downloadBtn.download = `${track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞'} - ${track.title}.mp3`;
      downloadBtn.style.opacity = '1';
      downloadBtn.style.pointerEvents = 'auto';
    } else {
      downloadBtn.href = '#';
      downloadBtn.style.opacity = '0.5';
      downloadBtn.style.pointerEvents = 'none';
    }
  }

  function highlightCurrentTrack(index) {
    document.querySelectorAll('.track.current').forEach(el => {
      el.classList.remove('current');
    });

    const currentTrack = document.querySelector(`.track[data-index="${index}"]`);
    if (currentTrack) {
      currentTrack.classList.add('current');
      
      setTimeout(() => {
        currentTrack.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }, 100);
    }
  }

  // ========== UTILITIES ==========

  function formatTime(sec) {
    if (!Number.isFinite(sec) || sec < 0) return '--:--';
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }

  function restoreSettings() {
    restoreLyricsViewMode();
    
    try {
      const savedAnimation = localStorage.getItem('animationEnabled') === '1';
      if (savedAnimation) applyAnimationState(true);
      
      const savedBit = localStorage.getItem('bitEnabled') === '1';
      if (savedBit) {
        bitEnabled = true;
        const btn = document.getElementById('bit-btn');
        if (btn) btn.classList.add('bit-active');
      }
      
      const savedEco = localStorage.getItem('ecoMode') === '1';
      if (savedEco) {
        ecoMode = true;
        const btn = document.getElementById('eco-btn');
        if (btn) btn.classList.add('active');
      }
      
      const savedRepeat = localStorage.getItem('repeatMode') === '1';
      if (savedRepeat) {
        const btn = document.getElementById('repeat-btn');
        if (btn) btn.classList.add('repeat-active');
      }
      
      const savedShuffle = localStorage.getItem('shuffleMode') === '1';
      if (savedShuffle) {
        const btn = document.getElementById('shuffle-btn');
        if (btn) btn.classList.add('active');
      }
      
      const savedVolume = parseFloat(localStorage.getItem('playerVolume') || '1');
      updateVolumeUI(savedVolume);
      
    } catch {}
  }

  function restoreLyricsViewMode() {
    try {
      const saved = localStorage.getItem('lyricsViewMode');
      if (saved && ['normal','hidden','expanded'].includes(saved)) {
        lyricsViewMode = saved;
      }
    } catch {}
  }

  function saveLyricsViewMode() {
    try {
      localStorage.setItem('lyricsViewMode', lyricsViewMode);
    } catch {}
  }

  // ========== PUBLIC API ==========

  w.PlayerUI = {
    ensurePlayerBlock,
    updateProgress,
    updatePlayPauseIcon,
    loadLyrics,
    toggleLyricsView,
    toggleAnimation,
    toggleBit,
    toggleFavoritesOnly,
    currentLyrics: () => currentLyrics,
    getLyricsViewMode: () => lyricsViewMode
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPlayerUI);
  } else {
    initPlayerUI();
  }

})();

//=================================================
// FILE: /scripts/ci/lint-sw.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('service-worker.js');
if (!fs.existsSync(file)) {
  console.error('service-worker.js not found');
  process.exit(1);
}
const src = fs.readFileSync(file, 'utf8');

const errors = [];
const warns = [];

if (!/const\s+SW_VERSION\s*=\s*['"`]\d+\.\d+\.\d+['"`]/.test(src)) {
  errors.push('SW_VERSION is missing or has wrong format (x.y.z)');
}

const listeners = (name) => (src.match(new RegExp(`addEventListener\\(['"]${name}['"]`, 'g')) || []).length;
['install','activate','fetch'].forEach(ev => {
  const n = listeners(ev);
  if (n === 0) errors.push(`No ${ev} event listener`);
  if (n > 1) warns.push(`Multiple (${n}) ${ev} listeners`);
});

const consts = ['CORE_CACHE','RUNTIME_CACHE','MEDIA_CACHE','OFFLINE_CACHE','META_CACHE'];
consts.forEach(cn => {
  const n = (src.match(new RegExp(`\\bconst\\s+${cn}\\b`, 'g')) || []).length;
  if (n === 0) errors.push(`Missing const ${cn}`);
  if (n > 1) warns.push(`Duplicate const ${cn} (${n} times)`);
});

// –î–æ–ø.–ø—Ä–æ–≤–µ—Ä–∫–∏: DEFAULT_SW_CONFIG —á–∏—Å–ª–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã –∏ revalidateDays —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ
const cfgMatch = src.match(/const\s+DEFAULT_SW_CONFIG\s*=\s*\{([\s\S]*?)\};/);
if (cfgMatch) {
  const body = cfgMatch[1];
  const num = (key) => {
    const m = body.match(new RegExp(`${key}\\s*:\\s*([0-9]+(?:\\.[0-9]+)?)`));
    return m ? Number(m[1]) : null;
  };
  const revalidateDays = num('revalidateDays');
  if (!(Number.isInteger(revalidateDays) && revalidateDays > 0)) {
    errors.push('DEFAULT_SW_CONFIG.revalidateDays must be positive integer');
  }
  ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(k => {
    const v = num(k);
    if (!(typeof v === 'number' && v > 0)) errors.push(`DEFAULT_SW_CONFIG.${k} must be positive number`);
  });
}

if (warns.length) {
  console.warn('SW linter warnings:\n - ' + warns.join('\n - '));
}
if (errors.length) {
  console.error('SW linter errors:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Service Worker lint OK');


//=================================================
// FILE: /scripts/ci/validate-content.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const fail = (msg) => { console.error(msg); process.exit(2); };
const warn = (msg) => { console.warn(msg); };

// 1) albums.json –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
const albumsFile = path.resolve('albums.json');
if (!fs.existsSync(albumsFile)) fail('albums.json not found');
let albums;
try {
  const raw = fs.readFileSync(albumsFile, 'utf8');
  const j = JSON.parse(raw);
  if (!j || !Array.isArray(j.albums)) fail('albums.json: "albums" must be an array');
  albums = j.albums;
} catch (e) {
  fail('albums.json is not valid JSON: ' + e.message);
}
albums.forEach((a, i) => {
  if (!a.key || !a.title || !a.base) fail(`albums.json: album[${i}] must contain key/title/base`);
  if (typeof a.key !== 'string' || typeof a.title !== 'string' || typeof a.base !== 'string') {
    fail(`albums.json: album[${i}] key/title/base must be strings`);
  }
});

// 2) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –≥–∞–ª–µ—Ä–µ–π –∏ index.json –Ω–∞–ª–∏—á–∏—è/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
const galleryRoot = path.resolve('albums/gallery');
const required = ['00','01','02','news'];
required.forEach(id => {
  const dir = path.join(galleryRoot, id);
  const idx = path.join(dir, 'index.json');
  if (!fs.existsSync(dir)) fail(`albums/gallery/${id} directory missing`);
  if (!fs.existsSync(idx)) fail(`albums/gallery/${id}/index.json missing`);
  try {
    const raw = fs.readFileSync(idx, 'utf8');
    const j = JSON.parse(raw);
    const items = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
    if (!Array.isArray(items)) fail(`albums/gallery/${id}/index.json: items must be array`);
    if (items.length === 0) warn(`albums/gallery/${id}/index.json: items is empty`);
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ)
    items.forEach((it, k) => {
      const check = (p) => {
        if (!p || /^https?:\/\//i.test(p)) return;
        const rel = p.replace(/^\.\//, '');
        const fp = path.resolve(rel);
        if (!fs.existsSync(fp)) warn(`Missing file referenced from gallery ${id} item[${k}]: ${p}`);
      };
      if (typeof it === 'string') check(it);
      else if (it && typeof it === 'object') {
        if (it.src) check(it.src);
        if (it.formats) Object.values(it.formats).forEach(check);
      }
    });
  } catch (e) {
    fail(`albums/gallery/${id}/index.json invalid JSON: ${e.message}`);
  }
});

// 3) custom.json sw –∫–æ–Ω—Ñ–∏–≥: revalidateDays —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
const customFile = path.resolve('custom.json');
if (fs.existsSync(customFile)) {
  try {
    const raw = fs.readFileSync(customFile, 'utf8');
    const j = JSON.parse(raw);
    if (j && j.sw) {
      const d = j.sw.revalidateDays;
      if (!(Number.isInteger(d) && d > 0)) {
        fail('custom.json.sw.revalidateDays must be positive integer');
      }
      ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(key => {
        const v = j.sw[key];
        if (!(typeof v === 'number' && v > 0)) fail(`custom.json.sw.${key} must be positive number`);
      });
      if (typeof j.sw.allowUnknownSize !== 'boolean') {
        fail('custom.json.sw.allowUnknownSize must be boolean');
      }
    }
  } catch (e) {
    fail('custom.json invalid JSON: ' + e.message);
  }
}

console.log('Content validation OK');

//=================================================
// FILE: /scripts/ci/validate-manifest.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('manifest.json');
if (!fs.existsSync(file)) {
  console.error('manifest.json not found');
  process.exit(1);
}
const raw = fs.readFileSync(file, 'utf8');
let json;
try {
  json = JSON.parse(raw);
} catch (e) {
  console.error('manifest.json is not valid JSON:', e.message);
  process.exit(1);
}
const errors = [];
function req(key) { if (!(key in json)) errors.push(`Missing key: ${key}`); }

req('name');
req('short_name');
req('start_url');
req('icons');

if (json.icons && !Array.isArray(json.icons)) {
  errors.push('icons must be an array');
}
if (Array.isArray(json.icons) && json.icons.length === 0) {
  errors.push('icons must contain at least one icon');
}
if (!json.display) errors.push('Missing key: display');
if (!json.theme_color) errors.push('Missing key: theme_color');
if (!json.background_color) errors.push('Missing key: background_color');

if (errors.length) {
  console.error('Manifest validation failed:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Manifest validation OK');

//=================================================
// FILE: /scripts/ci/validate-playercore.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const jsFile = path.resolve('src/PlayerCore.js');
const tsFile = path.resolve('src/PlayerCore.ts');

function read(p){ if(!fs.existsSync(p)){ console.error(`File not found: ${p}`); process.exit(2);} return fs.readFileSync(p,'utf8'); }
const js = read(jsFile);
const ts = read(tsFile);

function extractSnapshotKeys(src) {
  const m = src.match(/getPlaylistSnapshot\([\s\S]*?\)\s*\{[\s\S]*?return\s*\([\s\S]*?\.map\(\s*\w+\s*=>\s*\(\{\s*([\s\S]*?)\}\)\)\s*\)/);
  if (!m) return null;
  const body = m[1];
  const keys = new Set();
  for (const prop of body.split('\n')) {
    const mm = prop.match(/^\s*([a-zA-Z_][\w]*)\s*:/);
    if (mm) keys.add(mm[1]);
  }
  return [...keys];
}

function extractTsTrackFields(src) {
  const m = src.match(/export\s+type\s+PlayerTrack\s*=\s*\{([\s\S]*?)\};/);
  if (!m) return null;
  const body = m[1];
  const keys = new Set();
  for (const line of body.split('\n')) {
    const mm = line.match(/^\s*([a-zA-Z_][\w]*)\s*:/);
    if (mm) keys.add(mm[1]);
  }
  return [...keys];
}

const jsKeys = extractSnapshotKeys(js) || [];
const tsKeys = extractSnapshotKeys(ts) || [];
const tsTrack = extractTsTrackFields(ts) || [];

const expected = ['title','artist','album','cover','lyrics','src','fulltext'];

function fail(msg){ console.error('validate-playercore:', msg); process.exit(2); }

function sameSet(a,b){ const A=new Set(a), B=new Set(b); if (A.size!==B.size) return false; for (const k of A) if(!B.has(k)) return false; return true; }

if (!sameSet(jsKeys, expected)) {
  fail(`PlayerCore.js getPlaylistSnapshot keys mismatch. Got: [${jsKeys.join(', ')}], expected: [${expected.join(', ')}]`);
}
if (!sameSet(tsKeys, expected)) {
  fail(`PlayerCore.ts getPlaylistSnapshot keys mismatch. Got: [${tsKeys.join(', ')}], expected: [${expected.join(', ')}]`);
}

// track type must contain at least listed fields (some optional)
const requiredInTrack = ['src','title','artist','album','cover','lyrics','fulltext'];
const miss = requiredInTrack.filter(k => !tsTrack.includes(k));
if (miss.length) {
  fail(`PlayerCore.ts PlayerTrack is missing fields: ${miss.join(', ')}`);
}

console.log('PlayerCore JS/TS validation OK');

//=================================================
// FILE: /scripts/core/bootstrap.js
// scripts/core/bootstrap.js
// ‚≠ê –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –≤—Å–µ —ç–∫—Å–ø–æ—Ä—Ç—ã, async/await –æ–±—ë—Ä–Ω—É—Ç –≤ IIFE

(function() {
  'use strict';

  class AppBootstrap {
    constructor() {
      this.requiredFeatures = [
        'localStorage',
        'fetch',
        'Promise',
        'addEventListener'
      ];
    }

    async init() {
      console.log('üöÄ Bootstrapping application...');

      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      if (!this.checkCompatibility()) {
        console.error('‚ùå Browser compatibility check failed');
        return;
      }

      // 2. –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
      this.detectIOS();
      this.detectStandalone();

      // 3. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
      this.preventDefaultBehaviors();

      // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      this.setupErrorHandling();

      // 5. ‚≠ê –ö–†–ò–¢–ò–ß–ù–û: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ albums.json
      await this.loadAlbumsIndex();

      console.log('‚úÖ Bootstrap complete');
    }

    async loadAlbumsIndex() {
      try {
        console.log('üìÄ Loading albums index...');
        
        const response = await fetch('./albums.json', { 
          cache: 'no-cache',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (!data || !Array.isArray(data.albums)) {
          throw new Error('Invalid albums.json format');
        }

        // ‚≠ê –ü—É–±–ª–∏–∫—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        window.albumsIndex = data.albums;

        console.log(`‚úÖ Albums index loaded: ${data.albums.length} albums`);
      } catch (error) {
        console.error('‚ùå Failed to load albums.json:', error);
        window.albumsIndex = [];
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤');
        }
      }
    }

    checkCompatibility() {
      const missing = [];

      if (!this.checkLocalStorage()) {
        missing.push('LocalStorage');
      }

      if (typeof fetch === 'undefined') {
        missing.push('Fetch API');
      }

      if (typeof Promise === 'undefined') {
        missing.push('Promises');
      }

      if (!document.addEventListener) {
        missing.push('Event Listeners');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ Web Audio API
      if (typeof AudioContext === 'undefined' && typeof webkitAudioContext === 'undefined') {
        console.warn('‚ö†Ô∏è Web Audio API not supported');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ MediaSession API (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      if (!('mediaSession' in navigator)) {
        console.warn('‚ö†Ô∏è Media Session API not supported - —Ñ–æ–Ω–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ Howler.js
      if (typeof Howl === 'undefined') {
        missing.push('Howler.js (–∞—É–¥–∏–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞)');
      }

      if (missing.length > 0) {
        this.showCompatibilityError(missing);
        return false;
      }

      return true;
    }

    checkLocalStorage() {
      try {
        localStorage.setItem('__test', '1');
        localStorage.removeItem('__test');
        return true;
      } catch (e) {
        return false;
      }
    }

    showCompatibilityError(missing) {
      const errorHtml = `
        <div style="
          position: fixed;
          inset: 0;
          background: #181818;
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: center;
          font-family: sans-serif;
          padding: 20px;
          text-align: center;
          z-index: 99999;
        ">
          <div>
            <h1 style="color: #E80100; margin-bottom: 20px;">‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h1>
            <p style="margin-bottom: 15px;">–î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É—é—Ç—Å—è:</p>
            <ul style="list-style: none; padding: 0; margin-bottom: 20px;">
              ${missing.map(f => `<li style="margin: 5px 0;">‚ùå ${f}</li>`).join('')}
            </ul>
            <p style="color: #999;">–û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.</p>
          </div>
        </div>
      `;

      document.body.innerHTML = errorHtml;
    }

    detectIOS() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS) {
        document.body.classList.add('ios');
        console.log('üì± iOS detected');
      }
      return isIOS;
    }

    detectStandalone() {
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                          window.navigator.standalone === true;
      
      if (isStandalone) {
        document.body.classList.add('standalone');
        console.log('üì≤ PWA mode detected');
      }
      
      return isStandalone;
    }

    preventDefaultBehaviors() {
      document.body.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });

      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      document.addEventListener('contextmenu', (e) => {
        if (e.target.tagName === 'IMG' || e.target.closest('#cover-slot')) {
          e.preventDefault();
        }
      });
    }

    setupErrorHandling() {
      window.addEventListener('error', (e) => {
        console.error('üí• Global error:', e.error || e.message);
      });

      window.addEventListener('unhandledrejection', (e) => {
        console.error('üí• Unhandled promise rejection:', e.reason);
      });
    }
  }

  // ‚≠ê –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
      const bootstrap = new AppBootstrap();
      await bootstrap.init();
    });
  } else {
    const bootstrap = new AppBootstrap();
    bootstrap.init();
  }
})();

//=================================================
// FILE: /scripts/core/config.js
// scripts/core/config.js
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
export const APP_CONFIG = {
  // –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  APP_VERSION: '8.0.3',
  BUILD_DATE: '2025-11-08',
  // ‚úÖ –ü–†–û–ú–û–ö–û–î –î–õ–Ø –í–•–û–î–ê
  PROMOCODE: 'VITRINA2025',
  // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –∞–ª—å–±–æ–º–æ–≤
  ICON_ALBUMS_ORDER: [
    { key: '__favorites__', title: '‚≠ê‚≠ê‚≠ê–ò–ó–ë–†–ê–ù–ù–û–ï‚≠ê‚≠ê‚≠ê', icon: 'img/icon_album/icon-album-00.png' },
    { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º', icon: 'img/icon_album/icon-album-01.png' },
    { key: 'golos-dushi', title: '–ì–æ–ª–æ—Å –î—É—à–∏', icon: 'img/icon_album/icon-album-02.png' },
    { key: 'krevetochka', title: '–ö–†–ï–í–ï—ÜTOCHKA', icon: 'img/icon_album/icon-album+00.png' },
    { key: '__reliz__', title: '–ù–û–í–û–°–¢–ò', icon: 'img/icon_album/icon-album-news.png' }
  ],
  // –ö–ª—é—á–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤
  SPECIAL_FAVORITES_KEY: '__favorites__',
  SPECIAL_RELIZ_KEY: '__reliz__',
  // –°—Å—ã–ª–∫–∏
  SUPPORT_URL: 'https://example.com/support',
  SUPPORT_EMAIL: 'support@vitrina-razbita.ru',
  GITHUB_URL: 'https://github.com/apel-s-in/vi3na1bita-music',
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–µ—Ä–∞
  PLAYER_SETTINGS: {
    defaultVolume: 1.0,
    crossfade: false,
    preload: true
  },
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  CACHE_VERSION: 'v1.0.0',
  CACHE_AUDIO: false, // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã
  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  ANALYTICS_ENABLED: false,
  ANALYTICS_ID: null,
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
  CENTRAL_GALLERY_BASE: './albums/gallery/',
  // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞–ª—å–±–æ–º–æ–≤
  PUBLISHED_ALBUM_KEYS: new Set(['golos-dushi', 'mezhdu-zlom-i-dobrom', 'krevetochka'])
};

// –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
if (typeof window !== 'undefined') {
  window.APP_CONFIG = APP_CONFIG;
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  window.SPECIAL_FAVORITES_KEY = APP_CONFIG.SPECIAL_FAVORITES_KEY;
  window.SPECIAL_RELIZ_KEY = APP_CONFIG.SPECIAL_RELIZ_KEY;
  window.ICON_ALBUMS_ORDER = APP_CONFIG.ICON_ALBUMS_ORDER;
}

//=================================================
// FILE: /scripts/e2e/favorites.spec.js
// @ts-check
import { test, expect } from '@playwright/test';

const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';

test('favorites UI builds and plays from favorites list', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –û—Ç–º–µ—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π –≤ —Ç–µ–∫—É—â–µ–º –∞–ª—å–±–æ–º–µ
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();

  // –û—Ç–∫—Ä—ã—Ç—å ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª
  await page.click('.album-icon[data-akey="__favorites__"]');

  // –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const favCount = await page.locator('#track-list .track').count();
  expect(favCount).toBeGreaterThan(0);

  // –ö–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
});

test('toggle star in favorites updates row state and localStorage', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –æ—Ç–º–µ—Ç–∏–º —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // –í–æ–π—Ç–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const favRow = page.locator('#track-list .track').first();
  const favId = await favRow.getAttribute('id'); // —Ñ–æ—Ä–º–∞—Ç fav_{a}_{t}
  expect(favId).toMatch(/^fav_/);

  // –°–Ω–∏–º–µ–º –∑–≤–µ–∑–¥—É ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–µ—Ç .inactive –∏ –∑–∞–ø–∏—Å—å –ø—Ä–æ–ø–∞–¥—ë—Ç –∏–∑ likedTracks:v2
  await favRow.locator('.like-star').click();

  await expect(favRow).toHaveClass(/inactive/);

  // –ü—Ä–æ–≤–µ—Ä–∏–º localStorage: likedTracks:v2 –±–æ–ª—å—à–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç—É —Å—Å—ã–ª–∫—É
  const { albumKey, trackIdx, present } = await page.evaluate((id) => {
    const m = id.match(/^fav_(.+)_(\d+)$/);
    const a = m ? m[1] : '';
    const t = m ? parseInt(m[2], 10) : -1;
    const raw = localStorage.getItem('likedTracks:v2');
    const map = raw ? JSON.parse(raw) : {};
    const arr = Array.isArray(map[a]) ? map[a] : [];
    return { albumKey: a, trackIdx: t, present: arr.includes(t) };
  }, favId);

  expect(albumKey).toBeTruthy();
  expect(trackIdx).toBeGreaterThanOrEqual(0);
  expect(present).toBeFalsy();
});

test('favorites view: add to favorites, play and verify mini-mode when browsing other album', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });

  // –í–æ–π—Ç–∏ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // –û—Ç–º–µ—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π
  const firstTrack = page.locator('#track-list .track').first();
  await firstTrack.hover();
  const star = firstTrack.locator('.like-star');
  await star.click();

  // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª (–∏–∫–æ–Ω–∫–∞ —Å data-akey="__favorites__")
  await page.click('.album-icon[data-akey="__favorites__"]');

  // –ö–ª–∏–∫–Ω—É—Ç—å –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª, –µ—Å–ª–∏ –µ—Å—Ç—å
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const favFirst = page.locator('#track-list .track').first();
  await favFirst.click();

  // –ü–ª–µ–µ—Ä –≤–∏–¥–∏–º
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Ç–æ—Ä–æ–π –∑–Ω–∞—á–æ–∫, –Ω–µ Favorites –∏ –Ω–µ News)
  const otherIcon = page.locator('.album-icon').filter({ hasNot: page.locator('[data-akey="__favorites__"]') }).nth(1);
  await otherIcon.click();

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—è–≤–∏–ª—Å—è mini-—Ä–µ–∂–∏–º (–º–∏–Ω–∏-—à–∞–ø–∫–∞)
  await expect(page.locator('#mini-now')).toBeVisible();
});

// –î–æ–ø. —Ç–µ—Å—Ç: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (PlayerState.applyState)
test('reload restores state via PlayerState.applyState', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });

  // –°–æ—Ö—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Ä—É—á–Ω—É—é (—ç–º—É–ª–∏—Ä—É–µ–º PlayerState.save)
  await page.evaluate(() => {
    const pc = window.playerCore;
    const st = {
      album: window.currentAlbumKey || null,
      trackIndex: 0,
      position: Math.floor(pc?.getSeek?.() || 5),
      volume: pc?.getVolume?.() ?? 1,
      wasPlaying: true
    };
    localStorage.setItem('playerStateV1', JSON.stringify(st));
  });

  await page.reload({ waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025'); // –ø–æ—Å–ª–µ reload –º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–º–æ
  await page.click('#promo-btn');

  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getSeek?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç setSinkId: —Å–∫–∏–ø, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
test('optional audio output setSinkId (skip when unsupported)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  const supported = await page.evaluate(() => {
    const dest = (window.Howler && window.Howler.ctx && window.Howler.ctx.destination) ? window.Howler.ctx.destination : null;
    return !!(dest && typeof dest.setSinkId === 'function' && navigator.mediaDevices);
  });
  // –ù–∏—á–µ–≥–æ –Ω–µ –∞—Å—Å–µ—Ä—Ç–∏–º: —Ç–µ—Å—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π.
});

test('sysinfo modal shows after GET_SW_INFO', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –ñ–¥—ë–º –∏–Ω–∏ SW
  await page.waitForTimeout(800);
  const sysbtn = page.locator('#sysinfo-btn');
  await expect(sysbtn).toBeVisible({ timeout: 5000 });
  await sysbtn.click();

  const modal = page.locator('.modal-bg .modal-feedback').filter({ hasText: '–û —Å–∏—Å—Ç–µ–º–µ' });
  await expect(modal).toBeVisible({ timeout: 5000 });
  await expect(modal).toContainText(/SW –≤–µ—Ä—Å–∏—è:/);
});

// –ù–æ–≤—ã–π —Ç–µ—Å—Ç: –±—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏ Prev/Next —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ ‚Äî –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç legacy <audio>
test('quick prev/next uses PlayerCore only (no legacy audio starts)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  await page.evaluate(async () => {
    await new Promise(r => setTimeout(r, 50));
    window.PlayerControls && window.PlayerControls.previousTrack && window.PlayerControls.previousTrack();
    window.PlayerControls && window.PlayerControls.nextTrack && window.PlayerControls.nextTrack();
  });

  const res = await page.evaluate(() => ({
    hasPc: !!window.playerCore,
    hasAudioEl: !!document.getElementById('audio')
  }));
  expect(res.hasPc).toBeTruthy();
  expect(res.hasAudioEl).toBeFalsy();
});

test('SW update flow persists state and restores after reload', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');
  await page.waitForTimeout(200);
  await page.evaluate(() => {
    if (window.playerCore && typeof window.playerCore.play === 'function') {
      window.playerCore.play(0);
      try { window.playerCore.seek(7); } catch {}
    }
  });

  await page.evaluate(() => {
    window.confirm = () => true;
    const evt = new MessageEvent('message', { data: { type: 'SW_VERSION', version: '9.9.9' } });
    try { navigator.serviceWorker && navigator.serviceWorker.dispatchEvent && navigator.serviceWorker.dispatchEvent(evt); } catch {}
  });

  const hasResume = await page.evaluate(() => !!sessionStorage.getItem('resumeAfterReloadV1'));
  expect(hasResume).toBeTruthy();

  await page.reload({ waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getSeek?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

// –ù–û–í–´–ô –¢–ï–°–¢: —Å–Ω—è–ª –∑–≤–µ–∑–¥—É —É —Ç–µ–∫—É—â–µ–≥–æ –≤ —Ä–µ–∂–∏–º–µ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ‚Üí next() –∏ UI –æ–±–Ω–æ–≤–∏–ª—Å—è
test('favorites playing: removing star of current track triggers next and updates UI', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –û—Ç–º–µ—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π –≤ –∞–ª—å–±–æ–º–µ
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // –û—Ç–∫—Ä–æ–µ–º ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª –∏ –∑–∞–ø—É—Å—Ç–∏–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ç—Ä–µ–∫–∞
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const favFirst = page.locator('#track-list .track').first();
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // –°–Ω–∏–º–µ–º –∑–≤–µ–∑–¥—É –Ω–∞ —ç—Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ
  const beforeIdx = await page.evaluate(() => (window.playerCore?.getIndex?.() ?? window.playingTrack ?? 0));
  await favFirst.locator('.like-star').click();

  // –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
  await page.waitForTimeout(300);
  const afterIdx = await page.evaluate(() => (window.playerCore?.getIndex?.() ?? window.playingTrack ?? 0));
  expect(afterIdx).not.toBe(beforeIdx);

  // –°—Ç—Ä–æ–∫–∞ —Å—Ç–∞–ª–∞ inactive, –∞ –∫–ª–∞—Å—Å .current –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –¥—Ä—É–≥–æ–π —ç–ª–µ–º–µ–Ω—Ç
  await expect(favFirst).toHaveClass(/inactive/);
  const currentCount = await page.locator('#track-list .track.current').count();
  expect(currentCount).toBe(1);

  // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –º–∏–Ω–∏-—Ä–µ–∂–∏–º –≤–æ–∑–º–æ–∂–µ–Ω ‚Äî ¬´–î–∞–ª–µ–µ¬ª/–º–∏–Ω–∏-—à–∞–ø–∫–∞ –æ–±–Ω–æ–≤—è—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ (–Ω–µ —Å—Ç—Ä–æ–≥–æ –∞—Å—Å–µ—Ä—Ç–∏–º –≤–∏–¥–∏–º–æ—Å—Ç—å)
  await page.evaluate(() => {
    window.MiniUI && window.MiniUI.updateNextUpLabel && window.MiniUI.updateNextUpLabel();
    window.MiniUI && window.MiniUI.updateMiniNowHeader && window.MiniUI.updateMiniNowHeader();
  });
});

//=================================================
// FILE: /scripts/e2e/player.spec.js
// @ts-check
import { test, expect } from '@playwright/test';

const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';

test('play track, toggle favorites-only and sleep timer UI', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });

  // –í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await expect(page.locator('#main-block')).toBeVisible();

  // –î–æ–∂–¥–∞—Ç—å—Å—è —Å–ø–∏—Å–∫–∞ –∞–ª—å–±–æ–º–æ–≤ –∏ –∫–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ —Ç—Ä–µ–∫–ª–∏—Å—Ç–∞
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstTrack = page.locator('#track-list .track').first();
  await firstTrack.click();

  // –ü–æ—è–≤–∏–ª—Å—è –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞ –∏ –∫–Ω–æ–ø–∫–∞ Play/Pause –µ—Å—Ç—å
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
  await expect(page.locator('#play-pause-icon')).toBeVisible();

  // –í–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä "—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ" (–∫–Ω–æ–ø–∫–∞ –≤ –ø–ª–µ–µ—Ä–µ)
  await page.click('#favorites-btn');
  const favBtn = page.locator('#favorites-btn');
  await expect(favBtn).toHaveClass(/favorites-active/);

  // –¢–∞–π–º–µ—Ä —Å–Ω–∞: –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –∏ –≤—ã–±—Ä–∞—Ç—å "15 –º–∏–Ω—É—Ç", –∑–∞—Ç–µ–º –≤—ã–∫–ª—é—á–∏—Ç—å
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("15 –º–∏–Ω—É—Ç")');
  // –ë–µ–π–¥–∂ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è
  await expect(page.locator('#sleep-timer-badge')).toBeVisible();
  // –í—ã–∫–ª—é—á–∏–º
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("–í—ã–∫–ª—é—á–∏—Ç—å")');
  await expect(page.locator('#sleep-timer-badge')).toBeHidden();
});

test('favorites view: add to favorites, play and verify mini-mode when browsing other album', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });

  // –í–æ–π—Ç–∏ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // –û—Ç–º–µ—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π
  const firstTrack = page.locator('#track-list .track').first();
  await firstTrack.hover();
  const star = firstTrack.locator('.like-star');
  await star.click();

  // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª (–∏–∫–æ–Ω–∫–∞ —Å data-akey="__favorites__")
  await page.click('.album-icon[data-akey="__favorites__"]');

  // –ö–ª–∏–∫–Ω—É—Ç—å –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª, –µ—Å–ª–∏ –µ—Å—Ç—å
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const favFirst = page.locator('#track-list .track').first();
  await favFirst.click();

  // –ü–ª–µ–µ—Ä –≤–∏–¥–∏–º
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Ç–æ—Ä–æ–π –∑–Ω–∞—á–æ–∫, –Ω–µ Favorites –∏ –Ω–µ News)
  const otherIcon = page.locator('.album-icon').filter({ hasNot: page.locator('[data-akey="__favorites__"]') }).nth(1);
  await otherIcon.click();

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—è–≤–∏–ª—Å—è mini-—Ä–µ–∂–∏–º (–º–∏–Ω–∏-—à–∞–ø–∫–∞)
  await expect(page.locator('#mini-now')).toBeVisible();
});

// –î–æ–ø. —Ç–µ—Å—Ç: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (PlayerState.applyState)
test('reload restores state via PlayerState.applyState', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });

  // –°–æ—Ö—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Ä—É—á–Ω—É—é (—ç–º—É–ª–∏—Ä—É–µ–º PlayerState.save) ‚Äî —á—Ç–æ–±—ã —Ç–µ—Å—Ç –±—ã–ª –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
  await page.evaluate(() => {
    const pc = window.playerCore;
    const st = {
      album: window.currentAlbumKey || null,
      trackIndex: 0,
      position: Math.floor(pc?.getSeek?.() || 5),
      volume: pc?.getVolume?.() ?? 1,
      wasPlaying: true
    };
    localStorage.setItem('playerStateV1', JSON.stringify(st));
  });

  await page.reload({ waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025'); // –ø–æ—Å–ª–µ reload –º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–º–æ
  await page.click('#promo-btn');

  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è (–∏–ª–∏ –≥–æ—Ç–æ–≤–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å—Å—è) –∏ –∏–Ω–¥–µ–∫—Å/–ø–æ–∑–∏—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –±–ª–∏–∑–∫–æ –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getSeek?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0); // –¥–æ–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ, –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ —Å –Ω—É–ª—è
});

// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç setSinkId: —Å–∫–∏–ø, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
test('optional audio output setSinkId (skip when unsupported)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  const supported = await page.evaluate(() => {
    const dest = (window.Howler && window.Howler.ctx && window.Howler.ctx.destination) ? window.Howler.ctx.destination : null;
    return !!(dest && typeof dest.setSinkId === 'function' && navigator.mediaDevices);
  });
  // –ù–∏—á–µ–≥–æ –Ω–µ –∞—Å—Å–µ—Ä—Ç–∏–º: —Ç–µ—Å—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π. –ü—Ä–æ—Å—Ç–æ –Ω–µ –ø–∞–¥–∞–µ–º.
});

test('sysinfo modal shows after GET_SW_INFO', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –ñ–¥—ë–º –∏–Ω–∏ SW
  await page.waitForTimeout(800);
  // –ö–Ω–æ–ø–∫–∞ ¬´–û –°–ò–°–¢–ï–ú–ï¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ desktop
  const sysbtn = page.locator('#sysinfo-btn');
  await expect(sysbtn).toBeVisible({ timeout: 5000 });
  await sysbtn.click();

  // –ü–æ—è–≤–ª—è–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–∞
  const modal = page.locator('.modal-bg .modal-feedback').filter({ hasText: '–û —Å–∏—Å—Ç–µ–º–µ' });
  await expect(modal).toBeVisible({ timeout: 5000 });

  // –í –º–æ–¥–∞–ª–∫–µ –µ—Å—Ç—å –≤–µ—Ä—Å–∏—è SW
  await expect(modal).toContainText(/SW –≤–µ—Ä—Å–∏—è:/);
});

// –ù–æ–≤—ã–π —Ç–µ—Å—Ç: –±—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏ Prev/Next —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ ‚Äî –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç legacy <audio>
test('quick prev/next uses PlayerCore only (no legacy audio starts)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  // –ë—ã—Å—Ç—Ä–æ –≤—ã–∑–æ–≤–µ–º prev/next —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–π API
  await page.evaluate(async () => {
    // –í–æ–∑–º–æ–∂–Ω–∞ –ª–µ–Ω—Ç–∏–≤–∫–∞ –∞–¥–∞–ø—Ç–µ—Ä–∞ ‚Äî –ø–æ–¥–æ–∂–¥—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ
    await new Promise(r => setTimeout(r, 50));
    window.PlayerControls && window.PlayerControls.previousTrack && window.PlayerControls.previousTrack();
    window.PlayerControls && window.PlayerControls.nextTrack && window.PlayerControls.nextTrack();
  });

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º: PlayerCore –µ—Å—Ç—å, legacy <audio> –Ω–µ —Å–æ–∑–¥–∞–Ω
  const res = await page.evaluate(() => ({
    hasPc: !!window.playerCore,
    hasAudioEl: !!document.getElementById('audio')
  }));
  expect(res.hasPc).toBeTruthy();
  expect(res.hasAudioEl).toBeFalsy();
});

// –ù–æ–≤—ã–π —Ç–µ—Å—Ç: –∏–º–∏—Ç–∏—Ä—É–µ–º SW_VERSION ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è state, –ø–æ—Å–ª–µ reload –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
test('SW update flow persists state and restores after reload', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');
  // –ù–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥—ë–º –∏ —É—Å—Ç–∞–Ω–æ–≤–∏–º –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ PlayerCore (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
  await page.waitForTimeout(200);
  await page.evaluate(() => {
    if (window.playerCore && typeof window.playerCore.play === 'function') {
      window.playerCore.play(0);
      try { window.playerCore.seek(7); } catch {}
    }
  });

  // –ê–≤—Ç–æ-–ø—Ä–∏–Ω—è—Ç–∏–µ confirm –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ fake SW_VERSION
  await page.evaluate(() => {
    window.confirm = () => true;
    const evt = new MessageEvent('message', { data: { type: 'SW_VERSION', version: '9.9.9' } });
    try { navigator.serviceWorker && navigator.serviceWorker.dispatchEvent && navigator.serviceWorker.dispatchEvent(evt); } catch {}
  });

  // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Å—Ç–µ–π—Ç –¥–ª—è —Ä–µ—é–º–∞ –∑–∞–ø–∏—Å–∞–Ω
  const hasResume = await page.evaluate(() => !!sessionStorage.getItem('resumeAfterReloadV1'));
  expect(hasResume).toBeTruthy();

  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Å–Ω–æ–≤–∞ –ø—Ä–æ–π–¥—ë–º –ø—Ä–æ–º–æ
  await page.reload({ waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏—è –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å ¬´—Å –Ω—É–ª—è¬ª
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getSeek?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

//=================================================
// FILE: /scripts/energy.js


//=================================================
// FILE: /scripts/player/player-adapter.js
// scripts/player/player-adapter.js
// –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è PlayerCore
import { PlayerCore } from '../../src/PlayerCore.js';

class PlayerAdapter {
  constructor() {
    this.player = null;
    this.initialized = false;
    this.init();
  }

  init() {
    if (this.initialized || window.playerCore) return;
    
    console.log('üéµ Initializing PlayerCore adapter...');
    
    // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä PlayerCore
    this.player = new PlayerCore({
      events: {
        onTrackChange: (track, index) => this.handleTrackChange(track, index),
        onPlay: (track, index) => this.handlePlay(track, index),
        onPause: (track, index) => this.handlePause(track, index),
        onStop: (track, index) => this.handleStop(track, index),
        onEnd: (track, index) => this.handleEnd(track, index),
        onTick: (position, duration) => this.handleTick(position, duration),
        onSleepTriggered: (track, index) => this.handleSleepTriggered(track, index)
      }
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    this.restoreSettings();
    
    // –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    window.playerCore = this.player;
    this.initialized = true;
    console.log('‚úÖ PlayerCore adapter initialized');
  }

  handleTrackChange(track, index) {
    console.log('üéµ Track changed:', track?.title);
    if (window.PlayerControls) {
      window.PlayerControls.updateNowPlaying({ track, index });
    }
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞-—Å–µ—Å—Å–∏–∏
    if (window.BackgroundAudioManager) {
      window.BackgroundAudioManager.updateMetadata(track);
    }
  }

  handlePlay(track, index) {
    console.log('‚ñ∂Ô∏è Playing:', track?.title);
    if (window.PlayerControls) {
      window.PlayerControls.updatePlayPauseButton(true);
    }
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    if (window.BackgroundEventsManager) {
      window.BackgroundEventsManager.setPlaybackLocks(true);
    }
  }

  handlePause(track, index) {
    console.log('‚è∏Ô∏è Paused');
    if (window.PlayerControls) {
      window.PlayerControls.updatePlayPauseButton(false);
    }
    if (window.BackgroundEventsManager) {
      window.BackgroundEventsManager.setPlaybackLocks(false);
    }
  }

  handleStop(track, index) {
    console.log('‚èπÔ∏è Stopped');
    if (window.PlayerControls) {
      window.PlayerControls.updatePlayPauseButton(false);
    }
    if (window.BackgroundEventsManager) {
      window.BackgroundEventsManager.setPlaybackLocks(false);
    }
  }

  handleEnd(track, index) {
    console.log('‚è≠Ô∏è Track ended');
    // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
    if (!window.autoNextDisabled) {
      this.player.next();
    }
  }

  handleTick(position, duration) {
    if (window.PlayerControls) {
      window.PlayerControls.updateProgress(position, duration);
    }
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –º–µ–¥–∏–∞-—Å–µ—Å—Å–∏–∏
    if (window.BackgroundAudioManager) {
      window.BackgroundAudioManager.updatePositionState({
        position,
        duration
      });
    }
  }

  handleSleepTriggered(track, index) {
    console.log('üò¥ Sleep timer triggered');
    if (window.NotificationSystem) {
      window.NotificationSystem.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    }
  }

  restoreSettings() {
    try {
      // –ì—Ä–æ–º–∫–æ—Å—Ç—å
      const volume = parseFloat(localStorage.getItem('playerVolume') || '1');
      if (Number.isFinite(volume)) {
        this.player.setVolume(volume);
      }
      
      // –†–µ–∂–∏–º—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
      this.player.setRepeat(localStorage.getItem('repeatMode') === '1');
      this.player.setShuffle(localStorage.getItem('shuffleMode') === '1');
      
      // –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏
      const favoritesOnly = localStorage.getItem('favoritesOnlyMode') === '1';
      if (favoritesOnly && window.getLikedForAlbum) {
        const currentAlbum = window.AlbumsManager?.getCurrentAlbum();
        const liked = currentAlbum ? window.getLikedForAlbum(currentAlbum) : [];
        this.player.setFavoritesOnly(true, liked);
      }
    } catch (e) {
      console.error('Failed to restore player settings:', e);
    }
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    new PlayerAdapter();
  });
} else {
  new PlayerAdapter();
}

//=================================================
// FILE: /scripts/ui/favorites-const.js
// scripts/ui/favorites-const.js
// –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∫–ª—é—á–µ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª.
// –í–∞–∂–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –ø—Ä–æ–∫–∏–Ω–µ–º –≤ window, —á—Ç–æ–±—ã –∏—Ö –≤–∏–¥–µ–ª inline-–∫–æ–¥ index.html.

const SPECIAL_FAVORITES_KEY = '__favorites__';
const SPECIAL_RELIZ_KEY = '__reliz__';

// –ö–ª—é—á —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ª–∞–π–∫–æ–≤ (V2)
const LIKED_STORAGE_KEY_V2 = 'likedTracks:v2';

// –ö–ª—é—á —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å—Å—ã–ª–æ–∫ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª (refs)
const FAVORITES_REFS_KEY = 'favoritesAlbumRefs:v1';

// Back-compat –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ inline-–∫–æ–¥–∞:
Object.assign(window, {
  SPECIAL_FAVORITES_KEY,
  SPECIAL_RELIZ_KEY,
  LIKED_STORAGE_KEY_V2,
  FAVORITES_REFS_KEY,
});

//=================================================
// FILE: /scripts/ui/favorites-data.js
// scripts/ui/favorites-data.js
// Data-—Ö–µ–ª–ø–µ—Ä—ã ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª + TTL-–∫—ç—à –æ–±–ª–æ–∂–µ–∫.
// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ window.* –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

(function FavoritesDataModule() {
  const w = window;

  const FAVORITES_REFS_KEY = window.FAVORITES_REFS_KEY || 'favoritesAlbumRefs:v1';
  const COVER_TTL_MS = 12 * 60 * 60 * 1000; // 12 —á–∞—Å–æ–≤
  const albumCoverCache = Object.create(null); // { [albumKey]: { url:string, ts:number } }

  // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≥–µ—Ç—Ç–µ—Ä—ã likedTracks:v2
  function getLikedMap() {
    try { const raw = localStorage.getItem('likedTracks:v2'); const obj = raw ? JSON.parse(raw) : {}; return obj && typeof obj === 'object' ? obj : {}; }
    catch { return {}; }
  }
  function getLikedForAlbum(albumKey) {
    try {
      const map = getLikedMap();
      const arr = (map && typeof map === 'object') ? map[albumKey] : [];
      if (!Array.isArray(arr)) return [];
      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ —á–∏—Å–ª–∞–º –∏ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏
      const norm = Array.from(new Set(arr.map(n => parseInt(n, 10)).filter(Number.isFinite)));
      return norm;
    } catch {
      return [];
    }
  }

  function readFavoritesRefs() {
    try { const raw = localStorage.getItem(FAVORITES_REFS_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; }
    catch { return []; }
  }
  function writeFavoritesRefs(arr) {
    try { localStorage.setItem(FAVORITES_REFS_KEY, JSON.stringify(Array.isArray(arr) ? arr : [])); } catch {}
  }

  function ensureFavoritesRefsWithLikes() {
    const refs = readFavoritesRefs();
    const keySet = new Set(refs.map(x => `${x.a}:${x.t}`));

    try {
      const map = getLikedMap();
      const albumsIndex = Array.isArray(w.albumsIndex) ? w.albumsIndex : [];

      // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∫–ª—é—á–∏ –∏–∑ albumsIndex –∏ likedTracks:v2 ‚Äî —ç—Ç–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç —Å–ª—É—á–∞–π,
      // –∫–æ–≥–¥–∞ –≤ albums.json –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Ç –∞–ª—å–±–æ–º–∞, –Ω–æ –≤ likedTracks –æ–Ω –µ—â—ë –µ—Å—Ç—å.
      const indexKeys = albumsIndex.map(a => a && a.key).filter(Boolean);
      const likedKeys = Object.keys(map || {});
      const allKeysSet = new Set([...indexKeys, ...likedKeys]);

      for (const akey of allKeysSet) {
        const liked = Array.isArray(map?.[akey]) ? map[akey] : [];
        for (const ti of liked) {
          const k = `${akey}:${ti}`;
          if (!keySet.has(k)) {
            refs.push({ a: akey, t: ti });
            keySet.add(k);
          }
        }
      }
    } catch {}

    writeFavoritesRefs(refs);
    return refs;
  }

  function getSortedFavoritesRefs() {
    const refs = ensureFavoritesRefsWithLikes().slice();
    const ICON_ALBUMS_ORDER = (w.ICON_ALBUMS_ORDER || []).map(x => x.key)
      .filter(k => k !== w.SPECIAL_FAVORITES_KEY && k !== w.SPECIAL_RELIZ_KEY);
    const orderMap = new Map(ICON_ALBUMS_ORDER.map((k, i) => [k, i]));
    refs.sort((r1, r2) => {
      const o1 = orderMap.has(r1.a) ? orderMap.get(r1.a) : 999;
      const o2 = orderMap.has(r2.a) ? orderMap.get(r2.a) : 999;
      if (o1 !== o2) return o1 - o2;
      return (r1.t - r2.t);
    });
    return refs;
  }

  async function getAlbumConfigByKey(albumKey) {
    if (!albumKey) return null;
    const albumConfigCache = w.albumConfigCache || {};

    // –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–ª—è alias
    let realKey = albumKey;
    if (typeof w.resolveRealAlbumKey === 'function') {
      try {
        const cand = w.resolveRealAlbumKey(albumKey);
        if (cand) realKey = cand;
      } catch {}
    }

    // 1) –ü—Ä–æ–±—É–µ–º –∫—ç—à –ø–æ –æ–±–æ–∏–º –∫–ª—é—á–∞–º
    if (albumConfigCache[albumKey]?.config) return albumConfigCache[albumKey].config;
    if (albumConfigCache[realKey]?.config)  return albumConfigCache[realKey].config;

    // 2) –ò—â–µ–º meta –ø–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–º—É –∫–ª—é—á—É (–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ realKey)
    const albumsIndex = w.albumsIndex || [];
    const meta = (albumsIndex.find(a => a && a.key === realKey) ||
                  albumsIndex.find(a => a && a.key === albumKey)) || null;
    if (!meta) return null;

    const base = (typeof w.normalizeBase === 'function') ? w.normalizeBase(meta.base) : meta.base;
    const absJoin = typeof w.absJoin === 'function'
      ? w.absJoin
      : ((b, r) => new URL(String(r || ''), String(b || '') + '/').toString());

    try {
      const r = await fetch(absJoin(base, 'config.json'), { cache: 'no-cache' });
      if (!r || !r.ok) return null;
      const data = await r.json();
      (data.tracks || []).forEach(t => {
        t.audio   = absJoin(base, t.audio);
        t.lyrics  = absJoin(base, t.lyrics);
        if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
      });

      // 3) –ö–ª–∞–¥—ë–º –≤ –∫—ç—à –ø–æ–¥ –û–ë–û–ò–ú–ò –∫–ª—é—á–∞–º–∏ (alias –∏ canonical)
      albumConfigCache[realKey]  = { base, config: data };
      albumConfigCache[albumKey] = { base, config: data };
      w.albumConfigCache = albumConfigCache;

      return data;
    } catch {
      return null;
    }
  }

  async function getAlbumCoverUrl(albumKey) {
    const now = Date.now();

    // 1) sessionStorage-–∫—ç—à
    try {
      const sKey = `favCoverCache:v1:${albumKey}`;
      const raw = sessionStorage.getItem(sKey);
      if (raw) {
        const obj = JSON.parse(raw);
        if (obj && obj.url && obj.ts && (now - obj.ts) < COVER_TTL_MS) {
          albumCoverCache[albumKey] = { url: obj.url, ts: obj.ts };
          return obj.url;
        }
      }
    } catch {}

    // 2) in-memory –∫—ç—à
    const cache = albumCoverCache[albumKey];
    if (cache && (now - cache.ts) < COVER_TTL_MS) return cache.url;

    // 3) –∑–∞–≥—Ä—É–∑–∫–∞ index.json –≥–∞–ª–µ—Ä–µ–∏
    try {
      const centralIdForAlbumKey = w.centralIdForAlbumKey;
      const normalizeGalleryItem = w.normalizeGalleryItem;
      const CENTRAL_GALLERY_BASE = w.CENTRAL_GALLERY_BASE || './albums/gallery/';
      const cid = typeof centralIdForAlbumKey === 'function' ? centralIdForAlbumKey(albumKey) : null;
      if (!cid) {
        albumCoverCache[albumKey] = { url: 'img/logo.png', ts: now };
        try { sessionStorage.setItem(`favCoverCache:v1:${albumKey}`, JSON.stringify({ url: 'img/logo.png', ts: now })); } catch {}
        return 'img/logo.png';
      }
      const baseDir = `${CENTRAL_GALLERY_BASE}${cid}/`;
      const r = await fetch(baseDir + 'index.json', { cache: 'force-cache' });
      if (r.ok) {
        const j = await r.json();
        const first = Array.isArray(j.items) ? j.items[0] : (Array.isArray(j) ? j[0] : null);
        if (first) {
          const norm = typeof normalizeGalleryItem === 'function' ? normalizeGalleryItem(first, baseDir) : first;
          const url = (norm && (norm.formats?.webp || norm.formats?.full || norm.src)) || 'img/logo.png';
          albumCoverCache[albumKey] = { url, ts: now };
          try { sessionStorage.setItem(`favCoverCache:v1:${albumKey}`, JSON.stringify({ url, ts: now })); } catch {}
          return url;
        }
      }
    } catch {}

    albumCoverCache[albumKey] = { url: 'img/logo.png', ts: now };
    try { sessionStorage.setItem(`favCoverCache:v1:${albumKey}`, JSON.stringify({ url: 'img/logo.png', ts: now })); } catch {}
    return 'img/logo.png';
  }

  async function buildFavoritesRefsModel() {
    const sortedRefs = getSortedFavoritesRefs();
    const out = [];

    for (const ref of sortedRefs) {
      // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî –≤—Å–µ–≥–¥–∞ –∏–∑ likedTracks:v2
      const active = getLikedForAlbum(ref.a).includes(ref.t);

      // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∞–ª—å–±–æ–º–∞ –∏ —Ü–µ–ª–µ–≤–æ–π —Ç—Ä–µ–∫
      let cfg = null;
      try { cfg = await getAlbumConfigByKey(ref.a); } catch {}
      const tr = cfg?.tracks?.[ref.t] || null;

      // –û–±–ª–æ–∂–∫—É —Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏ (—É—Å—Ç–æ–π—á–∏–≤–µ–µ –∫ CORS)
      const cover = await getAlbumCoverUrl(ref.a);

      if (tr && tr.audio) {
        out.push({
          title: tr.title,
          audio: tr.audio,
          lyrics: tr.lyrics,
          fulltext: tr.fulltext || null,
          __a: ref.a,
          __t: ref.t,
          __artist: cfg?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          __album: cfg?.albumName || '–ê–ª—å–±–æ–º',
          __active: active,
          __cover: cover
        });
        continue;
      }

      // Fallback: –Ω–µ—Ç –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ —Ç—Ä–µ–∫–∞ ‚Äî —Å—Ç—Ä–æ–∏–º ¬´–Ω–µ–∏–≥—Ä–∞–±–µ–ª—å–Ω—É—é¬ª —Å—Ç—Ä–æ–∫—É (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º)
      try {
        const albumMeta =
          (Array.isArray(w.albumsIndex) ? w.albumsIndex.find(a => a && a.key === ref.a) : null) || null;
        const albumTitle =
          (albumMeta && albumMeta.title) ||
          (w.ICON_TITLE_MAP && w.ICON_TITLE_MAP[ref.a]) ||
          ref.a;

        out.push({
          title: `–¢—Ä–µ–∫ ${String((ref.t || 0) + 1).padStart(2, '0')}`,
          audio: null,                // –≤–∞–∂–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫: —Ç–∞–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å
          lyrics: null,
          fulltext: null,
          __a: ref.a,
          __t: ref.t,
          __artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          __album: albumTitle,
          __active: active,
          __cover: cover
        });
      } catch {
        // –∫–∞–∫ –∫—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏–º —Å—Å—ã–ª–∫—É, —á—Ç–æ–±—ã –Ω–µ –∑–∞—à—É–º–ª—è—Ç—å —Å–ø–∏—Å–æ–∫
      }
    }

    w.favoritesRefsModel = out;
    return out;
  }

  function updateFavoritesRefsModelActiveFlag(albumKey, trackIndex, isActive) {
    const model = w.favoritesRefsModel;
    if (!Array.isArray(model)) return;
    const item = model.find(x => x.__a === albumKey && x.__t === trackIndex);
    if (item) item.__active = !!isActive;
  }

  // –≠–∫—Å–ø–æ—Ä—Ç API
  w.FavoritesData = {
    readFavoritesRefs,
    writeFavoritesRefs,
    ensureFavoritesRefsWithLikes,
    getSortedFavoritesRefs,
    getAlbumConfigByKey,
    buildFavoritesRefsModel,
    updateFavoritesRefsModelActiveFlag,
    getAlbumCoverUrl
  };

  // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º (–≥–ª–æ–±–∞–ª–∏)
  w.readFavoritesRefs = readFavoritesRefs;
  w.writeFavoritesRefs = writeFavoritesRefs;
  w.ensureFavoritesRefsWithLikes = ensureFavoritesRefsWithLikes;
  w.getSortedFavoritesRefs = getSortedFavoritesRefs;
  w.getAlbumConfigByKey = getAlbumConfigByKey;
  w.buildFavoritesRefsModel = buildFavoritesRefsModel;
  w.updateFavoritesRefsModelActiveFlag = updateFavoritesRefsModelActiveFlag;

})();

//=================================================
// FILE: /scripts/ui/favorites-storage.js
// scripts/ui/favorites-storage.js
// –û–ø–µ—Ä–∞—Ü–∏–∏ —Å localStorage –¥–ª—è –ª–∞–π–∫–æ–≤.
// –ß–∏—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ DOM. –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, –∫–ª–∞–¥—ë—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –≤ window.

// –ë–µ—Ä—ë–º –∫–ª—é—á –ª–∏–±–æ –∏–∑ favorites-const.js, –ª–∏–±–æ fallback.
const __LIKED_KEY = (typeof window.LIKED_STORAGE_KEY_V2 === 'string')
  ? window.LIKED_STORAGE_KEY_V2
  : 'likedTracks:v2';

function getLikedMap() {
  try {
    const raw = localStorage.getItem(__LIKED_KEY);
    const map = raw ? JSON.parse(raw) : {};
    return (map && typeof map === 'object') ? map : {};
  } catch {
    return {};
  }
}

function getLikedForAlbum(albumKey) {
  try {
    const raw = localStorage.getItem(__LIKED_KEY);
    const map = raw ? JSON.parse(raw) : {};
    const arr = (map && typeof map === 'object') ? map[albumKey] : [];
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ —á–∏—Å–ª–∞–º –∏ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    return Array.from(new Set((Array.isArray(arr) ? arr : [])
      .map(n => parseInt(n, 10))
      .filter(Number.isFinite)));
  } catch {
    return [];
  }
}

function toggleLikeForAlbum(albumKey, idx, makeLiked) {
  const index = parseInt(idx, 10);
  if (!Number.isFinite(index)) return;
  const map = getLikedMap();
  const arrRaw = Array.isArray(map[albumKey]) ? map[albumKey] : [];
  const arr = Array.from(new Set(arrRaw
    .map(n => parseInt(n, 10))
    .filter(Number.isFinite)));
  const has = arr.includes(index);

  let next = arr.slice();
  if (makeLiked && !has) next.push(index);
  if (!makeLiked && has) next = next.filter(x => x !== index);

  map[albumKey] = next;
  try { localStorage.setItem(__LIKED_KEY, JSON.stringify(map)); } catch {}
}

// Back-compat: –æ—Å—Ç–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç index.html
Object.assign(window, {
  getLikedMap,
  getLikedForAlbum,
  toggleLikeForAlbum,
});

//=================================================
// FILE: /scripts/ui/favorites.js
// scripts/ui/favorites.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–º–∏ —Ç—Ä–µ–∫–∞–º–∏
class FavoritesManager {
  constructor() {
    this.storageKey = 'likedTracks:v2';
    this.refsKey = 'favoritesAlbumRefs:v1';
    this.refsModel = null;
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
  getLikedMap() {
    try {
      const raw = localStorage.getItem(this.storageKey);
      const map = raw ? JSON.parse(raw) : {};
      return (map && typeof map === 'object') ? map : {};
    } catch {
      return {};
    }
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –¥–ª—è –∞–ª—å–±–æ–º–∞
  getLikedForAlbum(albumKey) {
    try {
      const map = this.getLikedMap();
      const arr = (map && typeof map === 'object') ? map[albumKey] : [];
      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ —á–∏—Å–ª–∞–º –∏ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
      return Array.from(new Set((Array.isArray(arr) ? arr : [])
        .map(n => parseInt(n, 10))
        .filter(Number.isFinite)));
    } catch {
      return [];
    }
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–ª—è —Ç—Ä–µ–∫–∞
  toggleLike(albumKey, trackIndex, makeLiked = null) {
    const index = parseInt(trackIndex, 10);
    if (!Number.isFinite(index)) return;
    
    const map = this.getLikedMap();
    const arrRaw = Array.isArray(map[albumKey]) ? map[albumKey] : [];
    const arr = Array.from(new Set(arrRaw
      .map(n => parseInt(n, 10))
      .filter(Number.isFinite)));
    
    const has = arr.includes(index);
    const shouldLike = makeLiked !== null ? makeLiked : !has;
    
    let next = arr.slice();
    if (shouldLike && !has) next.push(index);
    if (!shouldLike && has) next = next.filter(x => x !== index);
    
    map[albumKey] = Array.from(new Set(next));
    try {
      localStorage.setItem(this.storageKey, JSON.stringify(map));
      // –û–±–Ω–æ–≤–ª—è–µ–º refs –º–æ–¥–µ–ª—å
      this.updateRefsModel();
      return true;
    } catch {
      return false;
    }
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç—Ä–µ–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–º
  isFavorite(albumKey, trackIndex) {
    return this.getLikedForAlbum(albumKey).includes(parseInt(trackIndex, 10));
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ refs
  async updateRefsModel() {
    const refs = this.readFavoritesRefs();
    const map = this.getLikedMap();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –≤ refs
    Object.entries(map).forEach(([albumKey, trackIndices]) => {
      trackIndices.forEach(trackIndex => {
        const key = `${albumKey}:${trackIndex}`;
        if (!refs.some(r => r.a === albumKey && r.t === trackIndex)) {
          refs.push({ a: albumKey, t: trackIndex });
        }
      });
    });
    
    // –£–¥–∞–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ refs
    const activeRefs = refs.filter(ref => {
      const liked = this.getLikedForAlbum(ref.a);
      return liked.includes(ref.t);
    });
    
    this.writeFavoritesRefs(activeRefs);
    await this.buildFavoritesRefsModel();
  }

  // –ß—Ç–µ–Ω–∏–µ refs –∏–∑ localStorage
  readFavoritesRefs() {
    try {
      const raw = localStorage.getItem(this.refsKey);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  // –ó–∞–ø–∏—Å—å refs –≤ localStorage
  writeFavoritesRefs(arr) {
    try {
      localStorage.setItem(this.refsKey, JSON.stringify(Array.isArray(arr) ? arr : []));
    } catch {}
  }

  // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö
  async buildFavoritesRefsModel() {
    const refs = this.readFavoritesRefs();
    const model = [];
    
    for (const ref of refs) {
      // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî –≤—Å–µ–≥–¥–∞ –∏–∑ likedTracks:v2
      const active = this.getLikedForAlbum(ref.a).includes(ref.t);
      
      // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∞–ª—å–±–æ–º–∞ –∏ —Ü–µ–ª–µ–≤–æ–π —Ç—Ä–µ–∫
      let cfg = null;
      try {
        cfg = await window.AlbumsManager?.getAlbumConfigByKey(ref.a);
      } catch {}
      
      const tr = cfg?.tracks?.[ref.t] || null;
      
      // –û–±–ª–æ–∂–∫—É —Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏
      const cover = await this.getAlbumCoverUrl(ref.a);
      
      if (tr && tr.audio) {
        model.push({
          title: tr.title,
          audio: tr.audio,
          lyrics: tr.lyrics,
          fulltext: tr.fulltext || null,
          __a: ref.a,
          __t: ref.t,
          __artist: cfg?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          __album: cfg?.albumName || '–ê–ª—å–±–æ–º',
          __active: active,
          __cover: cover
        });
      }
    }
    
    this.refsModel = model;
    return model;
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ URL –æ–±–ª–æ–∂–∫–∏ –∞–ª—å–±–æ–º–∞
  async getAlbumCoverUrl(albumKey) {
    try {
      const centralIdForAlbumKey = window.centralIdForAlbumKey;
      const normalizeGalleryItem = window.normalizeGalleryItem;
      const CENTRAL_GALLERY_BASE = window.APP_CONFIG?.CENTRAL_GALLERY_BASE || './albums/gallery/';
      
      const cid = typeof centralIdForAlbumKey === 'function' ? centralIdForAlbumKey(albumKey) : null;
      if (!cid) return 'img/logo.png';
      
      const baseDir = `${CENTRAL_GALLERY_BASE}${cid}/`;
      const r = await fetch(baseDir + 'index.json', { cache: 'force-cache' });
      
      if (r.ok) {
        const j = await r.json();
        const first = Array.isArray(j.items) ? j.items[0] : (Array.isArray(j) ? j[0] : null);
        if (first) {
          const norm = typeof normalizeGalleryItem === 'function' ? normalizeGalleryItem(first, baseDir) : first;
          return (norm && (norm.formats?.webp || norm.formats?.full || norm.src)) || 'img/logo.png';
        }
      }
    } catch {}
    
    return 'img/logo.png';
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –º–æ–¥–µ–ª–∏
  updateRefsModelActiveFlag(albumKey, trackIndex, isActive) {
    if (!Array.isArray(this.refsModel)) return;
    
    const item = this.refsModel.find(x => x.__a === albumKey && x.__t === trackIndex);
    if (item) {
      item.__active = !!isActive;
    }
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö refs
  getSortedRefs() {
    const refs = this.readFavoritesRefs().slice();
    const ICON_ALBUMS_ORDER = (window.ICON_ALBUMS_ORDER || []).map(x => x.key)
      .filter(k => k !== window.SPECIAL_FAVORITES_KEY && k !== window.SPECIAL_RELIZ_KEY);
    
    const orderMap = new Map(ICON_ALBUMS_ORDER.map((k, i) => [k, i]));
    
    refs.sort((r1, r2) => {
      const o1 = orderMap.has(r1.a) ? orderMap.get(r1.a) : 999;
      const o2 = orderMap.has(r2.a) ? orderMap.get(r2.a) : 999;
      if (o1 !== o2) return o1 - o2;
      return (r1.t - r2.t);
    });
    
    return refs;
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.FavoritesManager = new FavoritesManager();

//=================================================
// FILE: /scripts/ui/lyrics-modal.js
// scripts/ui/lyrics-modal.js
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø–µ—Å–Ω–∏

(function LyricsModalModule() {
  'use strict';

  const w = window;

  function showFullLyricsModal() {
    const track = w.playerCore?.getCurrentTrack();
    if (!track) {
      w.NotificationSystem?.warning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞');
      return;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
    const fulltext = track.fulltext;
    
    if (fulltext) {
      loadFulltextAndShow(fulltext, track);
    } else {
      showLyricsFromTimeline(track);
    }
  }

  async function loadFulltextAndShow(url, track) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to load fulltext');
      
      const text = await response.text();
      showModal(track, text);
      
    } catch (error) {
      console.error('Failed to load fulltext:', error);
      w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏');
    }
  }

  function showLyricsFromTimeline(track) {
    // –°–æ–±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ timeline –ª–∏—Ä–∏–∫–∏
    if (!w.PlayerUI || !w.PlayerUI.currentLyrics || !w.PlayerUI.currentLyrics.length) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    const lines = w.PlayerUI.currentLyrics.map(item => item.line).filter(Boolean);
    const text = lines.join('\n');
    
    showModal(track, text);
  }

  function showModal(track, text) {
    const modal = document.createElement('div');
    modal.className = 'modal-bg active';
    
    modal.innerHTML = `
      <div class="modal-feedback lyrics-modal" style="max-width: 520px; max-height: 80vh;">
        <button class="bigclose" title="–ó–∞–∫—Ä—ã—Ç—å">
          <svg viewBox="0 0 48 48">
            <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          </svg>
        </button>
        
        <h2 style="margin-bottom: 8px;">${escapeHtml(track.title)}</h2>
        <div style="color: #8ab8fd; margin-bottom: 20px; font-size: 14px;">
          ${escapeHtml(track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞')} ¬∑ ${escapeHtml(track.album || '')}
        </div>
        
        <div class="lyrics-fulltext" style="
          max-height: 50vh;
          overflow-y: auto;
          padding: 16px;
          background: rgba(0,0,0,0.2);
          border-radius: 10px;
          line-height: 1.8;
          white-space: pre-wrap;
          font-size: 15px;
          scrollbar-width: thin;
          scrollbar-color: rgba(77,170,255,0.3) transparent;
        ">
          ${escapeHtml(text)}
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
          <button class="modal-action-btn" id="copy-lyrics-btn">
            üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
          </button>
          <button class="modal-action-btn" id="share-lyrics-btn">
            üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
          </button>
        </div>
      </div>
    `;

    const closeBtn = modal.querySelector('.bigclose');
    closeBtn?.addEventListener('click', () => modal.remove());

    const copyBtn = modal.querySelector('#copy-lyrics-btn');
    copyBtn?.addEventListener('click', () => copyLyrics(text, modal));

    const shareBtn = modal.querySelector('#share-lyrics-btn');
    shareBtn?.addEventListener('click', () => shareLyrics(track, text));

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });

    document.body.appendChild(modal);
  }

  async function copyLyrics(text, modal) {
    try {
      await navigator.clipboard.writeText(text);
      w.NotificationSystem?.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
      modal.remove();
    } catch (error) {
      // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        w.NotificationSystem?.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
        modal.remove();
      } catch (e) {
        w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      }
      
      document.body.removeChild(textarea);
    }
  }

  async function shareLyrics(track, text) {
    const shareData = {
      title: track.title,
      text: `${track.title} - ${track.artist}\n\n${text}`
    };

    if (navigator.share) {
      try {
        await navigator.share(shareData);
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Share failed:', error);
        }
      }
    } else {
      w.NotificationSystem?.info('–§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
    }
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }

  // –ü—É–±–ª–∏—á–Ω—ã–π API
  w.LyricsModal = {
    show: showFullLyricsModal
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  // (Lyrics Modal –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞)

})();

//=================================================
// FILE: /scripts/ui/mini.js
// scripts/ui/mini.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏-—Ä–µ–∂–∏–º–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–ª–µ–µ—Ä–∞

(function() {
  'use strict';

  class MiniModeManager {
    constructor() {
      this.isMiniMode = false;
      this.scrollThreshold = 300; // –ü–æ—Ä–æ–≥ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–∏–Ω–∏-—Ä–µ–∂–∏–º–∞
      this.lastScrollTop = 0;
      this.init();
    }

    init() {
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      this.isMiniMode = localStorage.getItem('miniMode') === '1';
      
      if (this.isMiniMode) {
        this.enableMiniMode();
      }

      // –°–ª—É—à–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      this.setupScrollListener();

      // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
      this.setupToggleButton();
    }

    setupScrollListener() {
      let ticking = false;

      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            this.handleScroll();
            ticking = false;
          });
          ticking = true;
        }
      }, { passive: true });
    }

    handleScroll() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∏–Ω–∏-—Ä–µ–∂–∏–º –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –≤–Ω–∏–∑
      if (scrollTop > this.scrollThreshold && scrollTop > this.lastScrollTop) {
        if (!this.isMiniMode) {
          this.enableMiniMode();
        }
      } else if (scrollTop < 100) {
        if (this.isMiniMode) {
          this.disableMiniMode();
        }
      }

      this.lastScrollTop = scrollTop;
    }

    setupToggleButton() {
      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–∏–Ω–∏-—Ä–µ–∂–∏–º–∞
      const toggleBtn = document.getElementById('mini-mode-toggle');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          this.toggleMiniMode();
        });
      }
    }

    enableMiniMode() {
      if (this.isMiniMode) return;

      this.isMiniMode = true;
      document.body.classList.add('mini-mode');
      localStorage.setItem('miniMode', '1');

      // –°–∫—Ä—ã—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      this.hideElements([
        '#cover-wrap',
        '#social-links',
        '.album-icons',
        '.active-album-title'
      ]);

      // –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å now-playing –≤–≤–µ—Ä—Ö—É
      const nowPlaying = document.getElementById('now-playing');
      if (nowPlaying) {
        nowPlaying.style.position = 'sticky';
        nowPlaying.style.top = '0';
        nowPlaying.style.zIndex = '10';
        nowPlaying.style.background = 'var(--primary-bg)';
        nowPlaying.style.padding = '10px';
        nowPlaying.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
      }

      console.log('üì± Mini mode enabled');
    }

    disableMiniMode() {
      if (!this.isMiniMode) return;

      this.isMiniMode = false;
      document.body.classList.remove('mini-mode');
      localStorage.setItem('miniMode', '0');

      // –ü–æ–∫–∞–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ
      this.showElements([
        '#cover-wrap',
        '#social-links',
        '.album-icons',
        '.active-album-title'
      ]);

      // –í–µ—Ä–Ω—É—Ç—å now-playing –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      const nowPlaying = document.getElementById('now-playing');
      if (nowPlaying) {
        nowPlaying.style.position = '';
        nowPlaying.style.top = '';
        nowPlaying.style.zIndex = '';
        nowPlaying.style.background = '';
        nowPlaying.style.padding = '';
        nowPlaying.style.boxShadow = '';
      }

      console.log('üì± Mini mode disabled');
    }

    toggleMiniMode() {
      if (this.isMiniMode) {
        this.disableMiniMode();
      } else {
        this.enableMiniMode();
      }
    }

    hideElements(selectors) {
      selectors.forEach(selector => {
        const el = document.querySelector(selector);
        if (el) {
          el.style.display = 'none';
        }
      });
    }

    showElements(selectors) {
      selectors.forEach(selector => {
        const el = document.querySelector(selector);
        if (el) {
          el.style.display = '';
        }
      });
    }

    isMini() {
      return this.isMiniMode;
    }
  }

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
  window.MiniModeManager = new MiniModeManager();

  console.log('‚úÖ Mini mode manager initialized');
})();

//=================================================
// FILE: /scripts/ui/modals.js
// scripts/ui/modals.js (ESM)
// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏.

(function(){
  function toggleModal(modalId, show) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    const doShow = show === undefined ? !modal.classList.contains('active') : show;
    modal.classList.toggle('active', doShow);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    if(doShow) {
        modal.addEventListener('click', e => {
            if(e.target === modal) {
                toggleModal(modalId, false);
            }
        });
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç
  window.toggleModal = toggleModal;
})();

//=================================================
// FILE: /scripts/ui/notify.js
// scripts/ui/notify.js
// –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
class NotificationSystem {
  constructor() {
    this.container = null;
    this.queue = [];
    this.isShowing = false;
    this.currentToast = null;
    this.init();
  }
  
  init() {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    this.container = document.createElement('div');
    this.container.id = 'toast-container';
    this.container.style.cssText = `
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      pointer-events: none;
    `;
    document.body.appendChild(this.container);
  }
  
  show(message, type = 'info', duration = 3000) {
    const toast = {
      message,
      type,
      duration,
      id: Date.now() + Math.random()
    };
    this.queue.push(toast);
    this.processQueue();
  }
  
  processQueue() {
    if (this.isShowing || this.queue.length === 0) return;
    this.isShowing = true;
    const toast = this.queue.shift();
    this.displayToast(toast);
  }
  
  displayToast(toast) {
    const toastEl = document.createElement('div');
    toastEl.className = `toast toast-${toast.type}`;
    const emoji = this.getEmoji(toast.type);
    toastEl.innerHTML = `
      <div class="toast-content">
        <span class="toast-emoji">${emoji}</span>
        <span class="toast-message">${this.escapeHtml(toast.message)}</span>
      </div>
    `;
    this.container.appendChild(toastEl);
    this.currentToast = toastEl;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    requestAnimationFrame(() => {
      toastEl.classList.add('show');
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
    setTimeout(() => {
      this.hideToast(toastEl);
    }, toast.duration);
  }
  
  hideToast(toastEl) {
    if (!toastEl) return;
    toastEl.classList.remove('show');
    setTimeout(() => {
      if (toastEl.parentNode) {
        toastEl.parentNode.removeChild(toastEl);
      }
      this.isShowing = false;
      this.currentToast = null;
      this.processQueue();
    }, 300);
  }
  
  getEmoji(type) {
    const emojis = {
      info: '‚ÑπÔ∏è',
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      offline: 'üì¥'
    };
    return emojis[type] || '‚ÑπÔ∏è';
  }
  
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
  info(message, duration) {
    this.show(message, 'info', duration || 2000);
  }
  
  success(message, duration) {
    this.show(message, 'success', duration || 2500);
  }
  
  error(message, duration) {
    this.show(message, 'error', duration || 4000);
  }
  
  warning(message, duration) {
    this.show(message, 'warning', duration || 3000);
  }
  
  offline(message, duration) {
    this.show(message, 'offline', duration || 3000);
  }
  
  clear() {
    this.queue = [];
    if (this.currentToast) {
      this.hideToast(this.currentToast);
    }
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.NotificationSystem = new NotificationSystem();
console.log('‚úÖ Notification system initialized');

//=================================================
// FILE: /scripts/ui/sleep.js
// scripts/ui/sleep.js
// –¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º –æ–±—Ä–∞—Ç–Ω—ã–º –æ—Ç—Å—á—ë—Ç–æ–º

(function SleepTimerModule() {
  'use strict';

  const w = window;
  
  let sleepMenu = null;
  let updateInterval = null;

  const PRESETS = [
    { label: '5 –º–∏–Ω—É—Ç', minutes: 5 },
    { label: '10 –º–∏–Ω—É—Ç', minutes: 10 },
    { label: '15 –º–∏–Ω—É—Ç', minutes: 15 },
    { label: '30 –º–∏–Ω—É—Ç', minutes: 30 },
    { label: '1 —á–∞—Å', minutes: 60 },
    { label: '2 —á–∞—Å–∞', minutes: 120 }
  ];

  function initSleepTimer() {
    const btn = document.getElementById('sleep-timer-btn');
    if (!btn) {
      setTimeout(initSleepTimer, 100);
      return;
    }

    btn.addEventListener('click', toggleSleepMenu);

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ —Ç–∞–π–º–µ—Ä–∞ –æ—Ç PlayerCore
    if (w.playerCore) {
      w.playerCore.on({
        onSleepTriggered: () => {
          w.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª');
          clearSleepTimer();
        }
      });
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    restoreSleepTimer();

    console.log('‚úÖ Sleep timer initialized');
  }

  function toggleSleepMenu(e) {
    if (sleepMenu) {
      closeSleepMenu();
      return;
    }

    openSleepMenu(e.currentTarget);
  }

  function openSleepMenu(anchor) {
    sleepMenu = document.createElement('div');
    sleepMenu.className = 'sleep-menu';

    const items = [];

    // –¢–µ–∫—É—â–∏–π —Ç–∞–π–º–µ—Ä
    const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;
    if (targetTs > 0) {
      items.push(`
        <div class="sleep-menu-item active" data-action="cancel">
          ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω: ${formatRemainingTime(targetTs)}
        </div>
        <div class="sleep-menu-item" data-action="clear">
          üö´ –í—ã–∫–ª—é—á–∏—Ç—å
        </div>
        <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 6px 0;"></div>
      `);
    }

    // –ü—Ä–µ—Å–µ—Ç—ã
    PRESETS.forEach(preset => {
      items.push(`
        <div class="sleep-menu-item" data-minutes="${preset.minutes}">
          ${preset.label}
        </div>
      `);
    });

    sleepMenu.innerHTML = items.join('');
    anchor.appendChild(sleepMenu);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    sleepMenu.querySelectorAll('.sleep-menu-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        handleSleepMenuClick(item);
      });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
    setTimeout(() => {
      document.addEventListener('click', closeSleepMenuOutside);
    }, 10);
  }

  function closeSleepMenu() {
    if (sleepMenu && sleepMenu.parentNode) {
      sleepMenu.parentNode.removeChild(sleepMenu);
    }
    sleepMenu = null;
    document.removeEventListener('click', closeSleepMenuOutside);
  }

  function closeSleepMenuOutside(e) {
    if (sleepMenu && !sleepMenu.contains(e.target)) {
      closeSleepMenu();
    }
  }

  function handleSleepMenuClick(item) {
    const action = item.dataset.action;
    const minutes = parseInt(item.dataset.minutes);

    if (action === 'clear') {
      clearSleepTimer();
      closeSleepMenu();
      w.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω');
      return;
    }

    if (Number.isFinite(minutes) && minutes > 0) {
      setSleepTimer(minutes);
      closeSleepMenu();
      w.NotificationSystem?.success(`‚è∞ –¢–∞–π–º–µ—Ä: ${minutes} –º–∏–Ω`);
    }
  }

  function setSleepTimer(minutes) {
    if (!w.playerCore) return;

    const ms = minutes * 60 * 1000;
    w.playerCore.setSleepTimer(ms);

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    try {
      localStorage.setItem('sleepTimerTarget', String(Date.now() + ms));
    } catch {}

    updateBadge();
    startUpdateInterval();
  }

  function clearSleepTimer() {
    if (w.playerCore) {
      w.playerCore.clearSleepTimer();
    }

    try {
      localStorage.removeItem('sleepTimerTarget');
    } catch {}

    stopUpdateInterval();
    updateBadge();
  }

  function restoreSleepTimer() {
    try {
      const saved = localStorage.getItem('sleepTimerTarget');
      if (!saved) return;

      const targetTs = parseInt(saved);
      const remaining = targetTs - Date.now();

      if (remaining > 0) {
        w.playerCore?.setSleepTimer(remaining);
        updateBadge();
        startUpdateInterval();
        console.log(`‚è∞ Sleep timer restored: ${Math.round(remaining / 60000)} min`);
      } else {
        localStorage.removeItem('sleepTimerTarget');
      }
    } catch {}
  }

  function updateBadge() {
    const badge = document.getElementById('sleep-timer-badge');
    if (!badge) return;

    const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;

    if (targetTs > 0) {
      const remaining = targetTs - Date.now();
      const minutes = Math.ceil(remaining / 60000);
      
      badge.textContent = minutes > 0 ? minutes : '';
      badge.style.display = minutes > 0 ? '' : 'none';
    } else {
      badge.style.display = 'none';
    }
  }

  function startUpdateInterval() {
    stopUpdateInterval();
    
    updateInterval = setInterval(() => {
      updateBadge();
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
      const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;
      if (targetTs > 0 && targetTs <= Date.now()) {
        clearSleepTimer();
      }
    }, 10000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  }

  function stopUpdateInterval() {
    if (updateInterval) {
      clearInterval(updateInterval);
      updateInterval = null;
    }
  }

  function formatRemainingTime(targetTs) {
    const remaining = targetTs - Date.now();
    const minutes = Math.ceil(remaining / 60000);
    
    if (minutes >= 60) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}—á ${mins}–º` : `${hours}—á`;
    }
    
    return `${minutes}–º`;
  }

  // –ü—É–±–ª–∏—á–Ω—ã–π API
  w.SleepTimer = {
    setSleepTimer,
    clearSleepTimer,
    updateBadge
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSleepTimer);
  } else {
    initSleepTimer();
  }

  console.log('‚úÖ Sleep timer module loaded');
})();

//=================================================
// FILE: /scripts/ui/sysinfo.js
// scripts/ui/sysinfo.js
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–∏—Å—Ç–µ–º–µ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

(function() {
  'use strict';

  class SystemInfoManager {
    constructor() {
      this.modal = null;
      this.init();
    }

    init() {
      // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è
      const button = document.getElementById('sysinfo-btn');
      if (button) {
        button.style.display = '';
        button.addEventListener('click', () => this.show());
      }

      // –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ Ctrl+I
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
          e.preventDefault();
          this.show();
        }
      });
    }

    show() {
      if (this.modal) {
        this.modal.classList.add('active');
        return;
      }

      this.createModal();
    }

    createModal() {
      const modalBg = document.createElement('div');
      modalBg.className = 'modal-bg sysinfo-modal';
      
      const info = this.collectSystemInfo();

      modalBg.innerHTML = `
        <div class="modal-feedback" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
          <button class="bigclose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
            <svg width="31" height="31" viewBox="0 0 31 31">
              <line x1="8" y1="8" x2="23" y2="23" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              <line x1="23" y1="8" x2="8" y2="23" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </button>
          
          <h2 style="margin-top: 0; color: #4daaff;">–û —Å–∏—Å—Ç–µ–º–µ</h2>
          
          <div style="font-size: 14px; line-height: 1.6;">
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
            <div><strong>–í–µ—Ä—Å–∏—è:</strong> ${info.app.version}</div>
            <div><strong>–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏:</strong> ${info.app.buildDate}</div>
            <div><strong>PWA:</strong> ${info.app.isPWA ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ë—Ä–∞—É–∑–µ—Ä</h3>
            <div><strong>User Agent:</strong> ${info.browser.userAgent}</div>
            <div><strong>–Ø–∑—ã–∫:</strong> ${info.browser.language}</div>
            <div><strong>Online:</strong> ${info.browser.online ? '‚úÖ' : '‚ùå'}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h3>
            <div><strong>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:</strong> ${info.device.resolution}</div>
            <div><strong>DPR:</strong> ${info.device.dpr}</div>
            <div><strong>Touch:</strong> ${info.device.touch ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Platform:</strong> ${info.device.platform}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü–ª–µ–µ—Ä</h3>
            <div><strong>–Ø–¥—Ä–æ:</strong> ${info.player.core}</div>
            <div><strong>–í–µ—Ä—Å–∏—è Howler:</strong> ${info.player.howlerVersion}</div>
            <div><strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Web Audio:</strong> ${info.player.webAudio ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTML5:</strong> ${info.player.html5 ? '‚úÖ' : '‚ùå'}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–•—Ä–∞–Ω–∏–ª–∏—â–µ</h3>
            <div><strong>LocalStorage:</strong> ${info.storage.localStorage ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>IndexedDB:</strong> ${info.storage.indexedDB ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Cache API:</strong> ${info.storage.cacheAPI ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Service Worker:</strong> ${info.storage.serviceWorker ? '‚úÖ' : '‚ùå'}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü–∞–º—è—Ç—å</h3>
            <div><strong>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:</strong> ${info.memory.used}</div>
            <div><strong>–õ–∏–º–∏—Ç:</strong> ${info.memory.limit}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
            <div><strong>–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏:</strong> ${info.performance.loadTime}</div>
            <div><strong>DOM –∑–∞–≥—Ä—É–∂–µ–Ω:</strong> ${info.performance.domContentLoaded}</div>
          </div>
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #394866; text-align: center; font-size: 12px; color: #999;">
            –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ ¬© 2025
          </div>
        </div>
      `;

      // –ó–∞–∫—Ä—ã—Ç–∏–µ
      const closeBtn = modalBg.querySelector('.bigclose');
      closeBtn?.addEventListener('click', () => this.hide());

      modalBg.addEventListener('click', (e) => {
        if (e.target === modalBg) {
          this.hide();
        }
      });

      document.getElementById('modals-container')?.appendChild(modalBg);
      this.modal = modalBg;

      requestAnimationFrame(() => {
        modalBg.classList.add('active');
      });
    }

    collectSystemInfo() {
      const APP_CONFIG = window.APP_CONFIG || {};
      
      return {
        app: {
          version: APP_CONFIG.VERSION || 'unknown',
          buildDate: APP_CONFIG.BUILD_DATE || 'unknown',
          isPWA: window.matchMedia('(display-mode: standalone)').matches
        },
        browser: {
          userAgent: navigator.userAgent,
          language: navigator.language,
          online: navigator.onLine
        },
        device: {
          resolution: `${window.screen.width}√ó${window.screen.height}`,
          dpr: window.devicePixelRatio || 1,
          touch: 'ontouchstart' in window,
          platform: navigator.platform
        },
        player: {
          core: window.playerCore ? 'PlayerCore (Howler.js)' : '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω',
          howlerVersion: window.Howler ? Howler.version : 'N/A',
          webAudio: window.Howler ? Howler.usingWebAudio : false,
          html5: window.Howler ? !Howler.usingWebAudio : false
        },
        storage: {
          localStorage: this.checkLocalStorage(),
          indexedDB: 'indexedDB' in window,
          cacheAPI: 'caches' in window,
          serviceWorker: 'serviceWorker' in navigator
        },
        memory: this.getMemoryInfo(),
        performance: this.getPerformanceInfo()
      };
    }

    checkLocalStorage() {
      try {
        localStorage.setItem('test', '1');
        localStorage.removeItem('test');
        return true;
      } catch (e) {
        return false;
      }
    }

    getMemoryInfo() {
      if (performance.memory) {
        return {
          used: this.formatBytes(performance.memory.usedJSHeapSize),
          limit: this.formatBytes(performance.memory.jsHeapSizeLimit)
        };
      }
      return {
        used: 'N/A',
        limit: 'N/A'
      };
    }

    getPerformanceInfo() {
      const perf = performance.timing;
      const loadTime = perf.loadEventEnd - perf.navigationStart;
      const domTime = perf.domContentLoadedEventEnd - perf.navigationStart;

      return {
        loadTime: loadTime > 0 ? `${loadTime}ms` : 'N/A',
        domContentLoaded: domTime > 0 ? `${domTime}ms` : 'N/A'
      };
    }

    formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    hide() {
      if (this.modal) {
        this.modal.classList.remove('active');
        setTimeout(() => {
          if (this.modal && this.modal.parentNode) {
            this.modal.parentNode.removeChild(this.modal);
          }
          this.modal = null;
        }, 300);
      }
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.SystemInfoManager = new SystemInfoManager();
    });
  } else {
    window.SystemInfoManager = new SystemInfoManager();
  }

  console.log('‚úÖ System info manager initialized');
})();

//=================================================
// FILE: /scripts/utils/sw-manager.js
// scripts/utils/sw-manager.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Service Worker –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

class ServiceWorkerManager {
  constructor() {
    this.registration = null;
    this.isSupported = 'serviceWorker' in navigator;
  }

  async init() {
    if (!this.isSupported) {
      console.warn('Service Worker not supported');
      return false;
    }

    try {
      this.registration = await navigator.serviceWorker.register('./service-worker.js', {
        scope: './'
      });

      console.log('‚úÖ Service Worker registered:', this.registration.scope);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      this.checkForUpdates();

      // –°–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      this.registration.addEventListener('updatefound', () => {
        this.handleUpdateFound();
      });

      // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–∫–∞–∂–¥—ã–π —á–∞—Å)
      setInterval(() => {
        this.checkForUpdates();
      }, 60 * 60 * 1000);

      return true;
    } catch (error) {
      console.error('Service Worker registration failed:', error);
      return false;
    }
  }

  checkForUpdates() {
    if (this.registration) {
      this.registration.update();
    }
  }

  handleUpdateFound() {
    const newWorker = this.registration.installing;
    
    newWorker.addEventListener('statechange', () => {
      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
        // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
        this.showUpdateNotification();
      }
    });
  }

  showUpdateNotification() {
    window.NotificationSystem?.info(
      '–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?',
      10000
    );

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    this.showUpdateButton();
  }

  showUpdateButton() {
    let updateBtn = document.getElementById('update-app-btn');
    
    if (!updateBtn) {
      updateBtn = document.createElement('button');
      updateBtn.id = 'update-app-btn';
      updateBtn.textContent = '–û–ë–ù–û–í–ò–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï';
      updateBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: #4daaff;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      
      updateBtn.addEventListener('click', () => {
        this.applyUpdate();
      });
      
      document.body.appendChild(updateBtn);
    }
    
    updateBtn.style.display = 'block';
  }

  async applyUpdate() {
    if (!this.registration || !this.registration.waiting) {
      return;
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ SW –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è
    this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ SW
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }

  async clearCache(cacheType) {
    if (!this.registration || !this.registration.active) {
      return;
    }

    this.registration.active.postMessage({
      type: 'CLEAR_CACHE',
      payload: { cacheType }
    });

    window.NotificationSystem?.success('–ö—ç—à –æ—á–∏—â–µ–Ω');
  }

  async cacheAudioFiles(urls) {
    if (!this.registration || !this.registration.active) {
      return;
    }

    this.registration.active.postMessage({
      type: 'CACHE_AUDIO',
      payload: { urls }
    });
  }

  async getCacheSize() {
    if (!this.registration || !this.registration.active) {
      return 0;
    }

    return new Promise((resolve) => {
      const messageChannel = new MessageChannel();
      
      messageChannel.port1.onmessage = (event) => {
        resolve(event.data.size || 0);
      };

      this.registration.active.postMessage(
        { type: 'GET_CACHE_SIZE' },
        [messageChannel.port2]
      );
    });
  }

  formatCacheSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.ServiceWorkerManager = new ServiceWorkerManager();

// –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.ServiceWorkerManager.init();
  });
} else {
  window.ServiceWorkerManager.init();
}

export default ServiceWorkerManager;

//=================================================
// FILE: /albums/gallery/news/news-01-baner.html
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ</title>
  <style>
    :root{
      --bg-0: #0b0e15;     /* –±–∞–∑–æ–≤—ã–π —Ñ–æ–Ω */
      --bg-1: #0f1422;     /* –ø–∞–Ω–µ–ª—å/–∫–∞—Ä—Ç–∞ */
      --bg-2: #0a0d17;     /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ–Ω */
      --text: #e8ecf6;     /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --muted: #a9b3c7;    /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π */
      --accent-1: #4aa3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã */
      --accent-2: #7be3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã 2 */
      --shadow: 0 12px 28px rgba(0,0,0,0.45), 0 3px 10px rgba(0,0,0,0.35);
      --radius: 16px;
      --radius-inner: 12px;
    }
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(120% 120% at 10% 10%, #111827 0%, #0b0e15 45%, #070a12 100%);
      color: var(--text);
      font: 500 16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    .wrap{
      position:relative;
      height:100%;
      width:100%;
      display:grid;
      place-items:center;
      padding:10px;
      box-sizing:border-box;
    }
    /* –í–Ω–µ—à–Ω—è—è ¬´–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è —Ä–∞–º–∫–∞¬ª */
    .frame{
      position:relative;
      width:100%;
      height:100%;
      max-width:900px;
      max-height:900px;
      border-radius: var(--radius);
      padding:1px; /* —Ç–æ–ª—â–∏–Ω–∞ —Ä–∞–º–∫–∏ */
      background: linear-gradient(135deg, rgba(74,163,255,0.85), rgba(123,227,255,0.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card{
      position:relative;
      width:100%;
      height:100%;
      border-radius: calc(var(--radius) - 1px);
      background:
        radial-gradient(140% 120% at 80% 0%, rgba(27,41,72,0.55), transparent 60%),
        radial-gradient(120% 140% at 0% 100%, rgba(18,30,58,0.6), transparent 55%),
        var(--bg-1);
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:16px;
      box-sizing:border-box;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .badge{
      align-self:flex-start;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(2px);
    }
    .title{
      font-weight:700;
      font-size: clamp(18px, 3vw, 24px);
      line-height:1.25;
      margin:0 4px;
      color: var(--text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.25);
    }
    .subtitle{
      margin: -6px 4px 2px;
      color: var(--muted);
      font-size: 14px;
    }

    /* –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø–ª–µ–µ—Ä–∞ */
    .embed{
      position:relative;
      margin-top: 4px;
      width:100%;
      flex: 1 1 auto;
      aspect-ratio: 1 / 1; /* —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç */
      border-radius: var(--radius-inner);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.8), rgba(6,8,15,0.92)),
        var(--bg-2);
      border:1px solid rgba(255,255,255,0.07);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 24px rgba(0,0,0,0.45);
    }
    /* –î–µ–ª–∞–µ–º —Å–∞–º iframe –Ø.–ú—É–∑—ã–∫–∏ —Ä–µ–∑–∏–Ω–æ–≤—ã–º –Ω–∞ –≤–µ—Å—å –∫–≤–∞–¥—Ä–∞—Ç */
    .embed iframe{
      position:absolute;
      inset:0;
      width:100% !important;
      height:100% !important;
      border:0 !important;
      display:block;
      background: transparent;
    }

    /* –ù–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top: 4px;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      opacity: .9;
    }
    .cta{
      padding:8px 12px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      text-decoration:none;
      font-weight:600;
      transition: transform .12s ease, background .2s ease;
    }
    .cta:hover{ transform: translateY(-1px); }
    .cta:active{ transform: translateY(0); }

    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö –≤—ã—Å–æ—Ç–∞—Ö —Å–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
    @media (max-height: 420px){
      .card{ padding:12px; gap:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <section class="card" role="region" aria-label="–ù–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–Ω–Ω–µ—Ä ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏">
        <div class="badge">–ù–æ–≤–æ—Å—Ç–∏</div>
        <h1 class="title">¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª ‚Äî —É–∂–µ –Ω–∞ –Ø–Ω–¥–µ–∫—Å&nbsp;–ú—É–∑—ã–∫–µ</h1>
        <p class="subtitle">–°–ª—É—à–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º –≥—Ä—É–ø–ø—ã ¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª</p>

        <div class="embed" role="group" aria-label="–ü–ª–µ–µ—Ä –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∏">
          <!-- –í–ê–® –í–°–¢–ê–í–õ–ï–ù–ù–´–ô –ö–û–î –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∏ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –Ω–∞ –≤–µ—Å—å –∫–≤–∞–¥—Ä–∞—Ç) -->
          <iframe
            frameborder="0"
            allow="clipboard-write"
            style="border:none;width:614px;height:614px;"
            width="614"
            height="614"
            src="https://music.yandex.ru/iframe/album/38188979">
              –°–ª—É—à–∞–π—Ç–µ <a href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link">–ì–æ–ª–æ—Å –î—É—à–∏</a> ‚Äî <a href="https://music.yandex.ru/artist/24739002">–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</a> –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ
          </iframe>
        </div>

        <div class="footer">
          <div class="hint">–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏—Ç–µ ¬´–ø–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤ –ø–ª–µ–µ—Ä–µ, —á—Ç–æ–±—ã —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –¥—Ä—É–∑—å—è–º</div>
          <a class="cta" href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º</a>
        </div>
      </section>
    </div>
  </div>
</body>
</html>

//=================================================
// FILE: /generate-context.js
/* eslint-disable no-console */
"use strict";

/**
 * generate-context.js
 *
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä .meta/project-full.txt –∏ .meta/project-adaptive.txt
 * –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã):
 * 1) –í –Ω–∞—á–∞–ª–µ ‚Äî –±–ª–æ–∫ ¬´–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô¬ª, –∑–∞—Ç–µ–º –º–µ—Ç–∞‚Äë–±–ª–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º/URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–æ–º–µ—Ç–∫–æ–π –ø—Ä–æ GitHub.
 * 2) –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ‚Äî –ü–û–õ–ù–û–ï –¥–µ—Ä–µ–≤–æ –í–°–ï–• —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è assets/), –Ω–æ –±–µ–∑ .git/** –∏ .meta/**.
 *    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤.
 * 3) –ü–æ—Å–ª–µ –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º (critical ‚Üí high ‚Üí medium ‚Üí low),
 *    –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤—ã–≤–æ–¥–∏—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º. –ó–¥–µ—Å—å assets/** –∏—Å–∫–ª—é—á–∞–µ–º (–ø–æ –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é), .meta/** —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º.
 * 4) –ù–ï–¢ –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª.
 * 5) Adaptive-—Ä–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—â–∏–π –æ–±—ä—ë–º —Å—Ç—Ä–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º --max-lines (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20000).
 *
 * –ó–∞–ø—É—Å–∫:
 *   node generate-context.js --mode=both --max-lines=20000
 *   node generate-context.js --mode=full
 *   node generate-context.js --mode=adaptive --out-dir=.meta
 *
 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
 *   --mode=both|full|adaptive
 *   --max-lines=–ß–ò–°–õ–û           // —Ç–æ–ª—å–∫–æ –¥–ª—è adaptive
 *   --out-dir=–ü–£–¢–¨              // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é .meta
 *   --root=–ü–£–¢–¨                 // –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞)
 */

const fs = require("fs");
const path = require("path");

// -------------------- CLI --------------------
const argv = Object.fromEntries(
  process.argv.slice(2).map(a => {
    const [k, ...r] = a.replace(/^--/, "").split("=");
    return [k, r.join("=") === "" ? true : r.join("=")];
  })
);

const ROOT     = path.resolve(argv.root || __dirname);
const META_DIR = path.resolve(argv["out-dir"] || path.join(ROOT, ".meta"));
const MODE     = (argv.mode || "both").toLowerCase(); // full | adaptive | both
const MAX_LINES = Number(argv["max-lines"] || 20000);

// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ .meta
if (!fs.existsSync(META_DIR)) fs.mkdirSync(META_DIR, { recursive: true });

const FULL_FILE    = path.join(META_DIR, "project-full.txt");
const ADAPTIVE_FILE= path.join(META_DIR, "project-adaptive.txt");

// –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ self-—Ñ–∞–π–ª–∞–º (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è)
const SELF_FULL_REL  = toUnix(path.relative(ROOT, FULL_FILE));
const SELF_ADAPT_REL = toUnix(path.relative(ROOT, ADAPTIVE_FILE));

// -------------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ --------------------

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ç–æ—Ä—ã—Ö –≤–∫–ª—é—á–∞–µ–º –≤ —Å–µ–∫—Ü–∏—é ¬´–§–ê–ô–õ–´¬ª
const TEXT_EXTS = new Set([
  ".html",".htm",".css",".js",".mjs",".cjs",".ts",".tsx",
  ".json",".webmanifest",".md",".txt",".yml",".yaml"
]);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –°–ï–ö–¶–ò–ò ¬´–§–ê–ô–õ–´¬ª (—Ç–æ–ª—å–∫–æ –∫ –ª–∏—Å—Ç–∏–Ω–≥—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ù–ï –∫ –¥–µ—Ä–µ–≤—É):
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –∏—Å–∫–ª—é—á–∞–µ–º .meta/** –∏ assets/** (–Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ –∫–æ–Ω—Ç–µ–Ω—Ç),
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏.
 */
const EXCLUDE_FILES_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  "assets/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û –¥–ª—è –°–¢–†–£–ö–¢–£–†–´ –î–ï–†–ï–í–ê:
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã, –≤–∫–ª—é—á–∞—è assets/**.
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ .git/**, .meta/** –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ (node_modules –∏ —Ç.–ø.),
 *   –ø–ª—é—Å –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤.
 */
const EXCLUDE_TREE_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
const PRIORITY = {
  critical: [
    /^index\.html?$/i,
    /^service-worker\.js$/i,
    /^manifest\.json$/i,
    /^albums\.json$/i,
    /^custom\.json$/i,
    /^news\.html?$/i,
    /^generate-index\.(js|mjs|cjs)$/i,
    /^albums\/gallery\/[^/]+\/index\.json$/i,
    /^\.github\/workflows\/.*\.ya?ml$/i
  ],
  high: [
    /^AudioController\.(js|mjs|cjs|ts)$/i,
    /^GlobalState\.(js|mjs|cjs|ts)$/i,
    /^scripts\/.*\.(mjs|js|ts)$/i,
    /^performance\/.*\.(js|ts)$/i,
    /^.*\.(ya?ml)$/i
  ],
  medium: [
    /^.*\.(js|mjs|cjs|ts|tsx|json|html?|css)$/i
  ],
};

// -------------------- –£—Ç–∏–ª–∏—Ç—ã --------------------
function toUnix(p) {
  return String(p).replace(/\\/g, "/");
}
function globToRegExp(pat) {
  const esc = pat
    .replace(/[.+^${}()|[\]\\]/g, "\\$")
    .replace(/\*\*/g, "___GLOBSTAR___")
    .replace(/\*/g, "[^/]*")
    .replace(/___GLOBSTAR___/g, ".*");
  return new RegExp("^" + esc + "$");
}
function isTextFile(rel) {
  return TEXT_EXTS.has(path.extname(rel).toLowerCase());
}
function readText(rel) {
  try { return fs.readFileSync(path.join(ROOT, rel), "utf8"); }
  catch (e) { return `// read error: ${e.message}`; }
}
function countLines(s) {
  return (s.match(/\n/g) || []).length + (s.length ? 1 : 0);
}

// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
function isExcludedForFiles(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_FILES_PATTERNS.some(re => re.test(u));
}
// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –¥–µ—Ä–µ–≤–∞
function isExcludedForTree(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_TREE_PATTERNS.some(re => re.test(u));
}

// -------------------- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ --------------------
function listAllEntries(includeFiles = true, forTree = false) {
  const res = [];
  const stack = [ROOT];

  while (stack.length) {
    const dir = stack.pop();
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { continue; }

    for (const e of entries) {
      const full = path.join(dir, e.name);
      const rel = toUnix(path.relative(ROOT, full)) || ".";

      // –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –¥–ª—è –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–≤–æ–∏, –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî —Å–≤–æ–∏
      const excluded = forTree ? isExcludedForTree(rel) : isExcludedForFiles(rel);
      if (excluded) continue;

      if (e.isDirectory()) {
        res.push({ rel, full, dir: true });
        stack.push(full);
      } else if (e.isFile() && includeFiles) {
        res.push({ rel, full, dir: false });
      }
    }
  }

  // –ü–∞–ø–∫–∏ —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º —Ñ–∞–π–ª—ã; –≤–Ω—É—Ç—Ä–∏ ‚Äî –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  res.sort((a, b) => (a.dir !== b.dir ? (a.dir ? -1 : 1) : a.rel.localeCompare(b.rel)));
  return res;
}

function listTextFilesForContent() {
  return listAllEntries(true, /*forTree*/ false)
    .filter(e => !e.dir && isTextFile(e.rel))
    .map(e => e.rel);
}

// -------------------- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π --------------------
function readRepoMeta() {
  let url = "";
  try {
    const cfg = path.join(ROOT, ".git", "config");
    if (fs.existsSync(cfg)) {
      const raw = fs.readFileSync(cfg, "utf8");
      const m = raw.match(/url\s*=\s*(.+)\n/);
      if (m) url = m[1].trim();
    }
  } catch {}
  return {
    name: path.basename(ROOT),
    url: url || "(URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω; —É–∫–∞–∂–∏—Ç–µ –≤ .git/config)",
    madeWith: "–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).",
  };
}

// -------------------- –ë–ª–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ --------------------
function rulesBlock() {
  return [
    "–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):",
    "- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.",
    "- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.",
    "- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).",
    "- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:",
    "  ```ts",
    "  export function x() {}",
    "  ```",
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).",
    "- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.",
    "- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.",
    "- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.",
    "- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.",
    "- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].",
    "- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. ",
    "- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.",
    "- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).",
    "- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.",
    "- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.",
    ""
  ].join("\n");
}

function metaBlock() {
  const m = readRepoMeta();
  return [
    `–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.name}`,
    `–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.url}`,
    "# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.",
    m.madeWith,
    ""
  ].join("\n");
}

// -------------------- –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê (–¥–µ—Ä–µ–≤–æ) --------------------
function buildFullTree() {
  const lines = [];
  lines.push(path.basename(ROOT) + "/");

  function walk(dir, prefix = "") {
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { return; }

    const visible = entries
      .filter(e => !isExcludedForTree(toUnix(path.relative(ROOT, path.join(dir, e.name)))))
      .sort((a, b) => (a.isDirectory() !== b.isDirectory() ? (a.isDirectory() ? -1 : 1) : a.name.localeCompare(b.name)));

    visible.forEach((e, i) => {
      const isLast = i === visible.length - 1;
      const branch = isLast ? "‚îî‚îÄ‚îÄ " : "‚îú‚îÄ‚îÄ ";
      lines.push(prefix + branch + e.name + (e.isDirectory() ? "/" : ""));
      if (e.isDirectory()) {
        walk(path.join(dir, e.name), prefix + (isLast ? "    " : "‚îÇ   "));
      }
    });
  }

  walk(ROOT);
  return lines.join("\n") + "\n\n";
}

// -------------------- –°–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª --------------------
function getPriority(rel) {
  const u = toUnix(rel);
  for (const [lvl, rules] of Object.entries(PRIORITY)) {
    if (rules.some(re => re.test(u))) return lvl;
  }
  return "low";
}

function groupFilesByPriority() {
  const all = listTextFilesForContent(); // —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω—ã assets/.meta –∏ –ø—Ä–æ—á–∏–µ –ø–æ EXCLUDE_FILES_PATTERNS
  return {
    critical: all.filter(f => getPriority(f) === "critical"),
    high:     all.filter(f => getPriority(f) === "high"),
    medium:   all.filter(f => getPriority(f) === "medium"),
    low:      all.filter(f => getPriority(f) === "low"),
  };
}

function fileBlock(rel) {
  return [
    "//=================================================",
    `// FILE: /${toUnix(rel)}`,
    readText(rel),
    ""
  ].join("\n");
}

// -------------------- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞ --------------------
function headerBlock() {
  const now = new Date().toISOString().replace("T"," ").slice(0,19) + " UTC";
  return [
    rulesBlock(),
    metaBlock(),
    "–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:",
    buildFullTree(),
    `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${now}`,
    ""
  ].join("\n");
}

// -------------------- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã --------------------
function generateFull() {
  let out = headerBlock();

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium", "low"];
  for (const lvl of order) {
    for (const f of groups[lvl]) {
      out += fileBlock(f);
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

function generateAdaptive() {
  let out = headerBlock();
  let cur = countLines(out);
  const max = MAX_LINES;

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium"]; // low –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ adaptive —á–∞—â–µ –≤—Å–µ–≥–æ

  for (const lvl of order) {
    for (const f of groups[lvl]) {
      const block = fileBlock(f);
      const L = countLines(block);
      if (cur + L > max) {
        out += "\n// ... (truncate)\n";
        return out;
      }
      out += block; cur += L;
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

// -------------------- MAIN --------------------
function main() {
  if (MODE === "full" || MODE === "both") {
    fs.writeFileSync(FULL_FILE, generateFull(), "utf8");
    console.log(`‚úÖ ${FULL_FILE}`);
  }
  if (MODE === "adaptive" || MODE === "both") {
    fs.writeFileSync(ADAPTIVE_FILE, generateAdaptive(), "utf8");
    console.log(`‚úÖ ${ADAPTIVE_FILE}`);
  }
}

try { main(); } catch (e) { console.error("‚ùå", e); process.exit(1); }

//=================================================
// FILE: /news/news.json
{
  "items": [
    {
      "id": "2025-11-01-release",
      "title": "–ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ ‚Äî –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "date": "2025-11-01",
      "text": "–î–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
      "image": "img/logo.png",
      "tags": ["—Ä–µ–ª–∏–∑", "–∞–ª—å–±–æ–º"]
    },
    {
      "id": "2025-10-20-video",
      "title": "–ö–ª–∏–ø –Ω–∞ —Ç—Ä–µ–∫ ¬´–û—Ç—Ä–∞–∂–µ–Ω–∏–µ¬ª",
      "date": "2025-10-20",
      "embedUrl": "https://www.youtube.com/embed/dQw4w9WgXcQ",
      "tags": ["–∫–ª–∏–ø", "–≤–∏–¥–µ–æ"]
    },
    {
      "id": "2025-10-05-tour",
      "title": "–¢—É—Ä: –∑–∏–º–Ω–∏–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã",
      "date": "2025-10-05",
      "text": "–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü—Å–µ—Ç—è—Ö.",
      "tags": ["–∫–æ–Ω—Ü–µ—Ä—Ç—ã"]
    }
  ]
}

//=================================================
// FILE: /src/PlayerCore.js
// src/PlayerCore.js (ESM)
// –Ø–¥—Ä–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞ Howler.js –¥–ª—è vi3na1bita-music.
// –£–ø—Ä–∞–≤–ª—è–µ—Ç: –ø–ª–µ–π–ª–∏—Å—Ç–æ–º, play/pause/stop/prev/next, repeat/shuffle/favoritesOnly,
// –≥—Ä–æ–º–∫–æ—Å—Ç—å—é/–ø–æ–∑–∏—Ü–∏—è–º–∏, –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–æ–º, MediaSession –∏ "—Ç–∏–∫–µ—Ä–æ–º" –≤—Ä–µ–º–µ–Ω–∏.

export class PlayerCore {
  constructor(events = {}, options = {}) {
    this.playlist = [];
    this.index = 0;
    this.howl = null;
    this.events = { ...events };
    this.repeat = false;
    this.shuffle = false;
    this.favoritesOnly = false;
    this.favorites = [];
    this.shuffled = [];
    this._ticker = null;
    this._tickIntervalMs = Math.max(100, options.tickIntervalMs || 250);
    this._isPaused = true;
    this._albumArtist = '';
    this._albumTitle = '';
    this._albumCover = '';
    // Sleep timer
    this._sleepTimerId = null;
    this._sleepTargetTs = 0;
    this._installMediaSessionHandlersOnce();
  }

  setPlaylist(tracks, startIndex = 0, albumMeta = {}) {
    this.stop();
    this.playlist = Array.isArray(tracks) ? tracks.slice() : [];
    this.index = Math.max(0, Math.min(this.playlist.length - 1, startIndex || 0));
    this._albumArtist = albumMeta.artist || (tracks && tracks[0] && tracks[0].artist) || '';
    this._albumTitle  = albumMeta.album  || (tracks && tracks[0] && tracks[0].album)  || '';
    this._albumCover  = albumMeta.cover  || (tracks && tracks[0] && tracks[0].cover)  || '';
    this._syncShuffle(true);
    const t = this.getCurrentTrack();
    this._fire('onTrackChange', t, this.index);
  }

  on(events) { this.events = { ...this.events, ...events }; }
  setEvents(events) { this.events = { ...events }; }
  setRepeat(v) { this.repeat = !!v; }
  setShuffle(v) { this.shuffle = !!v; this._syncShuffle(true); }
  setFavoritesOnly(v, favorites = []) {
    this.favoritesOnly = !!v;
    this.favorites = Array.isArray(favorites) ? favorites.slice() : [];
    this._syncShuffle(true);
  }

  play(index) {
    if (typeof index === 'number') this.index = this._clampIndex(index);
    if (!this.playlist.length) return;
    
    // –ï—Å–ª–∏ Howl —É–∂–µ –µ—Å—Ç—å –∏ –∏–≥—Ä–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ç—Ä–µ–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º
    if (this.howl && this._isPaused && this.howl._src === (this.playlist[this.index]?.src || '')) {
      this.howl.play();
      return;
    }
    
    this._stopHowl();
    const tr = this.getCurrentTrack();
    if (!tr || !tr.src) return;
    
    this.howl = new Howl({
      src: [tr.src],
      html5: true,
      onend: () => {
        if (this.repeat) { this.play(); return; }
        this.next();
        this._fire('onEnd', tr, this.index);
      },
      onplay: () => {
        this._isPaused = false;
        this._fire('onPlay', tr, this.index);
        this._fire('onTrackChange', tr, this.index);
        this._updateMediaSessionMeta();
        this._startTicker();
      },
      onpause: () => { this._isPaused = true; this._fire('onPause', tr, this.index); this._stopTicker(); },
      onstop:  () => { this._isPaused = true; this._fire('onStop',  tr, this.index); this._stopTicker(); },
      onplayerror: (_, err) => {
        console.warn('Howler play error:', err);
        try { 
          this.howl.once('unlock', () => { 
            try { 
              this.howl.play(); 
            } catch (e) {
              console.error('Failed to resume after unlock:', e);
            }
          }); 
        } catch (e) {
          console.error('Failed to setup unlock handler:', e);
        }
        
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        }
      },
      onloaderror: (_, err) => {
        console.warn('Howler load error:', err);
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ');
        }
        setTimeout(() => this.next(), 1000);
      }
    });
    
    try {
      const saved = parseFloat(localStorage.getItem('playerVolume'));
      if (Number.isFinite(saved)) this.setVolume(saved);
    } catch {}
    
    this.howl.play();
  }

  pause() { if (this.howl && !this._isPaused) this.howl.pause(); }
  stop()  { this._stopHowl(); this._isPaused = true; this._fire('onStop', this.getCurrentTrack(), this.index); }
  next() {
    const n = this._nextIndex();
    if (n < 0) { this.stop(); return; }
    this.index = n;
    this.play();
  }
  prev() {
    const p = this._prevIndex();
    if (p < 0) { this.stop(); return; }
    this.index = p;
    this.play();
  }

  setVolume(v) {
    const vol = Math.max(0, Math.min(1, Number(v)));
    if (this.howl) this.howl.volume(vol);
    else if (typeof Howler !== 'undefined') Howler.volume(vol);
  }

  getVolume() {
    if (this.howl) return this.howl.volume();
    if (typeof Howler !== 'undefined') return Howler.volume();
    return 1;
  }

  seek(sec) {
    if (!this.howl) return;
    if (typeof sec === 'number') this.howl.seek(Math.max(0, sec));
    else return Number(this.howl.seek()) || 0;
  }

  getSeek() { return this.seek(); }
  getDuration() { return this.howl ? (this.howl.duration() || 0) : 0; }
  getNextIndex() { return this._nextIndex(); }

  getPlaylistSnapshot() {
    return (this.playlist || []).map(t => ({
      title: t?.title || '',
      artist: t?.artist || this._albumArtist || '',
      album: t?.album || this._albumTitle || '',
      cover: t?.cover || this._albumCover || '',
      lyrics: t?.lyrics || '',
      src: t?.src || '',
      fulltext: t?.fulltext || ''
    }));
  }

  isPlaying() { return !!this.howl && !this._isPaused; }
  getIndex() { return this.index; }
  getCurrentTrack() {
    if (!this.playlist.length) return null;
    return this.playlist[this.index] || null;
  }

  destroy() {
    this.stop();
    this._stopTicker();
    this.playlist = [];
    this.events = {};
  }

  _clampIndex(i) { return Math.max(0, Math.min(this.playlist.length - 1, i)); }
  _fire(name, ...args) { try { const fn = this.events && this.events[name]; if (typeof fn === 'function') fn(...args); } catch {} }
  _stopHowl() {
    if (this.howl) { try { this.howl.stop(); this.howl.unload(); } catch {} this.howl = null; }
  }

  _filteredIndices() {
    if (!this.playlist.length) return [];
    if (this.favoritesOnly && this.favorites.length) {
      return this.favorites.filter(i => Number.isInteger(i) && i >= 0 && i < this.playlist.length);
    }
    return this.playlist.map((_, i) => i);
  }

  _syncShuffle(force = false) {
    if (!this.shuffle) { this.shuffled = []; return; }
    const base = this._filteredIndices();
    // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≤–∞–ª–∏–¥–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–Ω–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äî –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –±–µ–∑ –Ω—É–∂–¥—ã.
    if (!force && Array.isArray(this.shuffled) &&
        this.shuffled.length === base.length &&
        this.shuffled.includes(this.index)) {
      return;
    }
    const arr = base.slice();
    for (let j = arr.length - 1; j > 0; j--) {
      const k = Math.floor(Math.random() * (j + 1));
      [arr[j], arr[k]] = [arr[k], arr[j]];
    }
    const i = arr.indexOf(this.index);
    if (i > 0) { arr.splice(i, 1); arr.unshift(this.index); }
    this.shuffled = arr;
  }

  _displayList() {
    const base = this._filteredIndices();
    if (this.shuffle && this.shuffled.length) return this.shuffled.slice();
    return base;
  }

  _nextIndex() {
    const arr = this._displayList();
    if (!arr.length) return -1;
    const pos = arr.indexOf(this.index);
    const nextIdx = (pos + 1) % arr.length;
    return arr[nextIdx];
  }

  _prevIndex() {
    const arr = this._displayList();
    if (!arr.length) return -1;
    const pos = arr.indexOf(this.index);
    const prevIdx = (pos - 1 + arr.length) % arr.length;
    return arr[prevIdx];
  }

  _startTicker() {
    if (this._ticker) return;
    this._ticker = setInterval(() => {
      try {
        if (!this.isPlaying()) return;
        const pos = this.getSeek() || 0;
        const dur = this.getDuration() || 0;
        const fn = this.events && this.events.onTick;
        if (typeof fn === 'function') fn(pos, dur);
      } catch {}
    }, this._tickIntervalMs);
  }

  _stopTicker() {
    if (this._ticker) { clearInterval(this._ticker); this._ticker = null; }
  }

  setSleepTimer(ms) {
    try { this.clearSleepTimer(); } catch {}
    const n = Number(ms);
    if (!Number.isFinite(n) || n <= 0) return;
    this._sleepTargetTs = Date.now() + n;
    this._sleepTimerId = setTimeout(() => {
      this._sleepTimerId = null;
      this._sleepTargetTs = 0;
      try {
        if (this.howl && !this._isPaused) this.howl.pause();
      } catch {}
      this._fire('onSleepTriggered', this.getCurrentTrack(), this.index);
    }, n);
  }

  clearSleepTimer() {
    if (this._sleepTimerId) {
      try { clearTimeout(this._sleepTimerId); } catch {}
      this._sleepTimerId = null;
    }
    this._sleepTargetTs = 0;
  }

  getSleepTimerTarget() {
    return this._sleepTargetTs || 0;
  }

  _updateMediaSessionMeta() {
    if (!('mediaSession' in navigator)) return;
    const t = this.getCurrentTrack();
    if (!t) return;
    try {
      navigator.mediaSession.metadata = new window.MediaMetadata({
        title: t.title || '',
        artist: t.artist || this._albumArtist || '',
        album: t.album || this._albumTitle || '',
        artwork: (t.cover || this._albumCover) ? [
          { src: t.cover || this._albumCover, sizes: '512x512', type: 'image/png' }
        ] : []
      });
    } catch {}
    try {
      navigator.mediaSession.playbackState = this.isPlaying() ? 'playing' : 'paused';
      const self = this;
      navigator.mediaSession.setActionHandler('play',          () => self.play());
      navigator.mediaSession.setActionHandler('pause',         () => self.pause());
      navigator.mediaSession.setActionHandler('previoustrack', () => self.prev());
      navigator.mediaSession.setActionHandler('nexttrack',     () => self.next());
      navigator.mediaSession.setActionHandler('seekbackward',  (d) => self.seek((self.getSeek() || 0) - (d.seekOffset || 10)));
      navigator.mediaSession.setActionHandler('seekforward',   (d) => self.seek((self.getSeek() || 0) + (d.seekOffset || 10)));
      navigator.mediaSession.setActionHandler('seekto',        (d) => { if (typeof d.seekTime === 'number') self.seek(d.seekTime); });
      navigator.mediaSession.setActionHandler('stop',          () => self.stop());
    } catch {}
  }

  _installMediaSessionHandlersOnce() {
    if (!('mediaSession' in navigator) || window.__msInstalled) return;
    try {
      const self = this;
      navigator.mediaSession.setActionHandler('play', () => self.play());
      navigator.mediaSession.setActionHandler('pause', () => self.pause());
      navigator.mediaSession.setActionHandler('previoustrack', () => self.prev());
      navigator.mediaSession.setActionHandler('nexttrack', () => self.next());
      navigator.mediaSession.setActionHandler('seekbackward', (d) => self.seek((self.getSeek() || 0) - (d.seekOffset || 10)));
      navigator.mediaSession.setActionHandler('seekforward', (d) => self.seek((self.getSeek() || 0) + (d.seekOffset || 10)));
      navigator.mediaSession.setActionHandler('seekto', (d) => { if (typeof d.seekTime === 'number') self.seek(d.seekTime); });
      navigator.mediaSession.setActionHandler('stop', () => self.stop());
      window.__msInstalled = true;
    } catch {}
  }
}

//=================================================
// FILE: /src/PlayerCore.ts
// src/PlayerCore.ts
// –Ø–¥—Ä–æ Howler.js –¥–ª—è vi3na1bita-music: –ø–ª–µ–π–ª–∏—Å—Ç, play/pause/stop/prev/next,
// repeat/shuffle/favoritesOnly, –≥—Ä–æ–º–∫–æ—Å—Ç—å/–ø–æ–∑–∏—Ü–∏—è, –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥, MediaSession, —Ç–∏–∫–µ—Ä –≤—Ä–µ–º–µ–Ω–∏.

export type PlayerTrack = {
  src: string;
  title: string;
  artist?: string;
  album?: string;
  cover?: string;
  lyrics?: string;
  fulltext?: string;
};

type PlayerCoreEvents = {
  onPlay?: (track: PlayerTrack | null, index: number) => void;
  onPause?: (track: PlayerTrack | null, index: number) => void;
  onStop?: (track: PlayerTrack | null, index: number) => void;
  onTrackChange?: (track: PlayerTrack | null, index: number) => void;
  onEnd?: (track: PlayerTrack | null, index: number) => void;
  onTick?: (positionSec: number, durationSec: number) => void;
  onSleepTriggered?: (track: PlayerTrack | null, index: number) => void;
};

type PlayerCoreOptions = {
  tickIntervalMs?: number;
  events?: PlayerCoreEvents;
};

declare const Howler: any; // –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–∑ CDN
declare class Howl {
  constructor(opts: any);
  play(): void;
  pause(): void;
  stop(): void;
  unload(): void;
  seek(sec?: number): number;
  duration(): number;
  volume(v?: number): number;
}

export class PlayerCore {
  private playlist: PlayerTrack[] = [];
  private index = 0;
  private howl: Howl | null = null;
  private events: PlayerCoreEvents = {};
  private repeat = false;
  private shuffle = false;
  private favoritesOnly = false;
  private favorites: number[] = [];
  private shuffled: number[] = [];
  private _ticker: ReturnType<typeof setInterval> | null = null;
  private _tickIntervalMs: number;
  private _isPaused = true;
  private _albumArtist = '';
  private _albumTitle = '';
  private _albumCover = '';

  private _sleepTimerId: ReturnType<typeof setTimeout> | null = null;
  private _sleepTargetTs = 0;

  constructor(opts: PlayerCoreOptions = {}) {
    this._tickIntervalMs = Math.max(100, opts.tickIntervalMs || 250);
    if (opts.events) this.events = { ...opts.events };
    this._installMediaSessionHandlersOnce();
  }

  setPlaylist(tracks: PlayerTrack[], startIndex = 0, albumMeta?: { artist?: string; album?: string; cover?: string }) {
    this.stop();
    this.playlist = Array.isArray(tracks) ? tracks.slice() : [];
    this.index = Math.max(0, Math.min(this.playlist.length - 1, startIndex || 0));
    this._albumArtist = (albumMeta?.artist) || (tracks?.[0]?.artist) || '';
    this._albumTitle  = (albumMeta?.album)  || (tracks?.[0]?.album)  || '';
    this._albumCover  = (albumMeta?.cover)  || (tracks?.[0]?.cover)  || '';
    this._syncShuffle(true);
    this._fire('onTrackChange', this.getCurrentTrack(), this.index);
  }

  on(events: PlayerCoreEvents) { this.events = { ...this.events, ...events }; }
  setEvents(events: PlayerCoreEvents) { this.events = { ...events }; }

  setRepeat(v: boolean) { this.repeat = !!v; }
  setShuffle(v: boolean) { this.shuffle = !!v; this._syncShuffle(true); }
  setFavoritesOnly(v: boolean, favorites: number[] = []) {
    this.favoritesOnly = !!v;
    this.favorites = Array.isArray(favorites) ? favorites.slice() : [];
    this._syncShuffle(true);
  }

  play(index?: number) {
    if (typeof index === 'number') this.index = this._clampIndex(index);
    if (!this.playlist.length) return;

    this._stopHowl();
    const tr = this.getCurrentTrack();
    if (!tr) return;

    this.howl = new Howl({
      src: [tr.src],
      html5: true,
      onend: () => {
        if (this.repeat) { this.play(); return; }
        this.next();
        this._fire('onEnd', tr, this.index);
      },
      onplay: () => {
        this._isPaused = false;
        this._fire('onPlay', tr, this.index);
        this._fire('onTrackChange', tr, this.index);
        this._updateMediaSessionMeta();
        this._startTicker();
      },
      onpause: () => { this._isPaused = true; this._fire('onPause', tr, this.index); this._stopTicker(); },
      onstop:  () => { this._isPaused = true; this._fire('onStop',  tr, this.index); this._stopTicker(); }
    });

    try {
      const saved = parseFloat(localStorage.getItem('playerVolume') || '');
      if (Number.isFinite(saved)) this.setVolume(saved);
    } catch {}
    this.howl.play();
  }

  pause() { if (this.howl && !this._isPaused) this.howl.pause(); }
  stop()  { this._stopHowl(); this._isPaused = true; this._fire('onStop', this.getCurrentTrack(), this.index); }

  next() { const n = this._nextIndex(); if (n < 0) return; this.index = n; this.play(); }
  prev() { const p = this._prevIndex(); if (p < 0) return; this.index = p; this.play(); }

  setVolume(v: number) {
    const vol = Math.max(0, Math.min(1, Number(v)));
    if (this.howl) this.howl.volume(vol);
    else if (typeof Howler !== 'undefined') Howler.volume(vol);
  }
  getVolume(): number {
    if (this.howl) return this.howl.volume();
    if (typeof Howler !== 'undefined') return Howler.volume();
    return 1;
  }

  seek(sec?: number): number | void {
    if (!this.howl) return;
    if (typeof sec === 'number') this.howl.seek(Math.max(0, sec));
    else return Number(this.howl.seek()) || 0;
  }
  getSeek(): number { return (this.seek() as number) || 0; }
  getDuration(): number { return this.howl ? (this.howl.duration() || 0) : 0; }

  // –ü—É–±–ª–∏—á–Ω—ã–π ¬´—Å–ª–µ–¥—É—é—â–∏–π¬ª –∏–Ω–¥–µ–∫—Å –ø–æ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–µ shuffle/favoritesOnly
  getNextIndex(): number {
    return this._nextIndex();
  }

  // –°–Ω–∏–º–æ–∫ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –¥–ª—è UI (–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø—Ä.)
  getPlaylistSnapshot(): Array<{ title: string; artist: string; album: string; cover: string; lyrics: string; src: string; fulltext: string; }> {
    return (this.playlist || []).map(t => ({
      title: t?.title || '',
      artist: t?.artist || this._albumArtist || '',
      album: t?.album || this._albumTitle || '',
      cover: t?.cover || this._albumCover || '',
      lyrics: t?.lyrics || '',
      src: t?.src || '',
      fulltext: (t as any)?.fulltext || ''
    }));
  }

  isPlaying() { return !!this.howl && !this._isPaused; }
  getIndex() { return this.index; }
  getCurrentTrack(): PlayerTrack | null {
    if (!this.playlist.length) return null;
    return this.playlist[this.index] || null;
  }

  destroy() {
    this.stop(); this._stopTicker(); this.playlist = []; this.events = {};
  }

  // ===== INTERNAL =====
  private _clampIndex(i: number) { return Math.max(0, Math.min(this.playlist.length - 1, i)); }
  private _fire<K extends keyof PlayerCoreEvents>(name: K, ...args: any[]) { try { const fn = this.events && this.events[name]; if (typeof fn === 'function') (fn as any)(...args); } catch {} }
  private _stopHowl() { if (this.howl) { try { this.howl.stop(); this.howl.unload(); } catch {} this.howl = null; } }

  private _filteredIndices(): number[] {
    if (!this.playlist.length) return [];
    if (this.favoritesOnly && this.favorites.length) {
      return this.favorites.filter(i => Number.isInteger(i) && i >= 0 && i < this.playlist.length);
    }
    return this.playlist.map((_, i) => i);
  }
  private _syncShuffle(force: boolean = false) {
    if (!this.shuffle) { this.shuffled = []; return; }
    const base = this._filteredIndices();

    if (!force &&
        Array.isArray(this.shuffled) &&
        this.shuffled.length === base.length &&
        this.shuffled.includes(this.index)) {
      return;
    }

    const arr = base.slice();
    for (let j = arr.length - 1; j > 0; j--) {
      const k = Math.floor(Math.random() * (j + 1));
      [arr[j], arr[k]] = [arr[k], arr[j]];
    }
    const i = arr.indexOf(this.index);
    if (i > 0) { arr.splice(i, 1); arr.unshift(this.index); }
    this.shuffled = arr;
  }

  private _displayList(): number[] {
    const base = this._filteredIndices();
    if (this.shuffle && this.shuffled.length) return this.shuffled.slice();
    return base;
  }
  private _nextIndex(): number {
    const arr = this._displayList(); if (!arr.length) return -1;
    const pos = arr.indexOf(this.index);
    const nextIdx = (pos + 1) % arr.length;
    return arr[nextIdx];
  }
  private _prevIndex(): number {
    const arr = this._displayList(); if (!arr.length) return -1;
    const pos = arr.indexOf(this.index);
    const prevIdx = (pos - 1 + arr.length) % arr.length;
    return arr[prevIdx];
  }

  private _startTicker() {
    if (this._ticker) return;
    this._ticker = setInterval(() => {
      try {
        if (!this.isPlaying()) return;
        const pos = this.getSeek() || 0;
        const dur = this.getDuration() || 0;
        const fn = this.events && this.events.onTick;
        if (typeof fn === 'function') fn(pos, dur);
      } catch {}
    }, this._tickIntervalMs);
  }
  private _stopTicker() { if (this._ticker) { clearInterval(this._ticker); this._ticker = null; } }

  // ===== Sleep timer API =====
  setSleepTimer(ms: number) {
    try { this.clearSleepTimer(); } catch {}
    const n = Number(ms);
    if (!Number.isFinite(n) || n <= 0) return;
    this._sleepTargetTs = Date.now() + n;
    this._sleepTimerId = setTimeout(() => {
      this._sleepTimerId = null;
      this._sleepTargetTs = 0;
      try {
        if (this.howl && !this._isPaused) this.howl.pause();
      } catch {}
      this._fire('onSleepTriggered', this.getCurrentTrack(), this.index);
    }, n);
  }
  clearSleepTimer() {
    if (this._sleepTimerId) {
      try { clearTimeout(this._sleepTimerId); } catch {}
      this._sleepTimerId = null;
    }
    this._sleepTargetTs = 0;
  }
  getSleepTimerTarget(): number {
    return this._sleepTargetTs || 0;
  }

  private _updateMediaSessionMeta() {
    if (!('mediaSession' in navigator)) return;
    const t = this.getCurrentTrack();
    try {
      (navigator as any).mediaSession.metadata = new (window as any).MediaMetadata({
        title: t?.title || '',
        artist: t?.artist || this._albumArtist || '',
        album: t?.album || this._albumTitle || '',
        artwork: (t?.cover || this._albumCover) ? [
          { src: t?.cover || this._albumCover, sizes: '512x512', type: 'image/png' }
        ] : []
      });
      (navigator as any).mediaSession.playbackState = this.isPlaying() ? 'playing' : 'paused';
      const self = this;
      (navigator as any).mediaSession.setActionHandler('play',         () => self.play());
      (navigator as any).mediaSession.setActionHandler('pause',        () => self.pause());
      (navigator as any).mediaSession.setActionHandler('previoustrack',() => self.prev());
      (navigator as any).mediaSession.setActionHandler('nexttrack',    () => self.next());
      (navigator as any).mediaSession.setActionHandler('seekbackward', (d: any) => self.seek((self.getSeek() || 0) - (d.seekOffset || 10)));
      (navigator as any).mediaSession.setActionHandler('seekforward',  (d: any) => self.seek((self.getSeek() || 0) + (d.seekOffset || 10)));
      (navigator as any).mediaSession.setActionHandler('seekto',       (d: any) => { if (typeof d.seekTime === 'number') self.seek(d.seekTime); });
      (navigator as any).mediaSession.setActionHandler('stop',         () => self.stop());
    } catch {}
  }

  private _installMediaSessionHandlersOnce() {
    // –•—ç–Ω–¥–ª–µ—Ä—ã –¥–µ–π—Å—Ç–≤–∏–π –∑–∞–¥–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏ onplay/track-change.
  }
}

//=================================================
// FILE: /styles/main.css
/* styles/main.css - –ü–æ–ª–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */

:root {
  --primary-bg: #181818;
  --primary-color: #E80100;
  --secondary-color: #4daaff;
  --text-color: #f2f2f2;
  --modal-bg: #252d39;
  --border-color: #394866;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
}

body {
  min-height: 100vh;
  background: var(--primary-bg);
  color: var(--text-color);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  min-width: 100vw;
  padding-top: env(safe-area-inset-top);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.hidden {
  display: none !important;
}

/* ========== PROMOCODE ========== */

#promocode-block {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--primary-bg);
  z-index: 100;
}

.promo-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: rgba(15,18,24,0.98);
  border-radius: 16px;
  box-shadow: 0 6px 24px rgba(0,0,0,0.5);
  padding: 36px 26px 32px 26px;
  min-width: 280px;
  max-width: 90vw;
}

.promo-cover {
  width: 256px;
  height: 256px;
  max-width: 70vw;
  max-height: 70vw;
  object-fit: cover;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.7);
  margin-bottom: 19px;
  display: block;
  background: var(--primary-bg);
}

.promo-inner h2 {
  margin-bottom: 16px;
  color: var(--secondary-color);
  font-size: 20px;
}

#promo-inp {
  padding: 12px 16px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  background: rgba(255,255,255,0.1);
  color: var(--text-color);
  margin: 10px 0;
  width: 100%;
  max-width: 280px;
  font-size: 16px;
  outline: none;
  transition: border-color 0.3s;
}

#promo-inp:focus {
  border-color: var(--secondary-color);
}

#promo-inp.error {
  border-color: var(--primary-color);
  animation: shake 0.3s;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

#promo-btn {
  padding: 12px 32px;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  transition: opacity 0.2s, transform 0.1s;
  margin-top: 8px;
}

#promo-btn:hover:not(:disabled) {
  opacity: 0.9;
  transform: translateY(-1px);
}

#promo-btn:active {
  transform: translateY(0);
}

#promo-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#promo-error {
  color: #ff6b6b;
  margin-top: 12px;
  font-size: 14px;
  min-height: 20px;
}

/* ========== MAIN BLOCK ========== */

#main-block {
  max-width: 420px;
  margin: 0 auto;
  flex: 1 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  padding: 0 10px;
  padding-bottom: env(safe-area-inset-bottom);
}

header {
  width: 100%;
  text-align: center;
  margin: 0 auto;
}

/* ========== ALBUM TITLE ========== */

.active-album-title {
  width: 100%;
  max-width: 400px;
  margin: 18px auto 6px auto;
  text-align: center;
  color: #eaf2ff;
  font-weight: 900;
  letter-spacing: 0.01em;
  line-height: 1.15;
  text-shadow: 0 1px 0 rgba(0,0,0,0.35);
  font-size: clamp(18px, 4.6vw, 24px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.active-album-title.fav {
  color: #ffd166;
  letter-spacing: 0.06em;
}

.active-album-title.news {
  color: #8ab8fd;
  letter-spacing: 0.02em;
}

/* ========== ALBUM ICONS ========== */

.album-icons {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: center;
  margin: 12px auto 0 auto;
  max-width: 400px;
  overflow-x: auto;
  padding: 4px 0;
  scrollbar-width: none;
}

.album-icons::-webkit-scrollbar {
  display: none;
}

.album-icon {
  width: 60px;
  height: 60px;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid var(--border-color);
  cursor: pointer;
  filter: grayscale(70%) brightness(0.88);
  opacity: 0.72;
  transition: transform 0.15s, filter 0.15s, opacity 0.15s, box-shadow 0.15s, width 0.15s ease, height 0.15s ease;
  flex: 0 0 auto;
}

.album-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.album-icon.active {
  filter: none;
  opacity: 1;
  box-shadow: 0 2px 10px rgba(0,0,0,0.35);
  width: 66px;
  height: 66px;
}

.album-icon:hover {
  transform: translateY(-2px);
  opacity: 0.9;
}

.album-icon:active {
  transform: translateY(0) scale(0.95);
}

/* ========== COVER / GALLERY ========== */

#cover-wrap {
  width: 100%;
  max-width: 400px;
  margin: 14px auto 0 auto;
  aspect-ratio: 1/1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.cover-gallery-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 2;
  border: none;
  cursor: pointer;
  background: none;
  padding: 0;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.2s;
  visibility: hidden;
  pointer-events: none;
}

.cover-gallery-arrow:hover {
  opacity: 0.8;
}

.cover-gallery-arrow:active {
  transform: translateY(-50%) scale(0.9);
}

#cover-gallery-arrow-left {
  left: 7px;
}

#cover-gallery-arrow-right {
  right: 7px;
}

#cover-wrap.gallery-nav-ready .cover-gallery-arrow {
  visibility: visible;
  pointer-events: auto;
}

#cover-slot {
  width: 100%;
  height: 100%;
  border-radius: 12px;
  overflow: hidden;
  background: var(--primary-bg);
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
  position: relative;
}

#cover-slot img,
#cover-slot iframe {
  width: 100%;
  height: 100%;
  display: block;
  border: 0;
  background: transparent;
}

#cover-slot img {
  object-fit: contain;
}

/* ========== SOCIALS ========== */

.socials-under-cover {
  margin: 14px auto 0 auto;
  width: 100%;
  max-width: 398px;
  text-align: center;
  font-size: 1.03em;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
}

.socials-under-cover a {
  color: var(--secondary-color);
  text-decoration: none;
  transition: color 0.2s;
  padding: 4px 8px;
}

.socials-under-cover a:hover {
  color: var(--text-color);
  text-decoration: underline;
}

/* ========== PLAYER UI ========== */

.lyrics-player-block {
  max-width: 370px;
  width: 100%;
  margin: 20px auto 0 auto;
  background: linear-gradient(180deg, rgba(30,34,45,0.95) 0%, rgba(15,18,24,0.98) 100%);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  position: relative;
}

/* Lyrics Window */
#lyrics-window {
  position: relative;
  overflow: hidden;
  border-radius: 12px 12px 0 0;
  background: #0f1218;
  transition: min-height 0.3s, max-height 0.3s, opacity 0.3s;
}

.lyrics-scroll {
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: inherit;
  max-height: inherit;
  overflow-y: auto;
  padding: 12px 0;
  scrollbar-width: thin;
  scrollbar-color: rgba(77,170,255,0.3) transparent;
}

.lyrics-scroll::-webkit-scrollbar {
  width: 6px;
}

.lyrics-scroll::-webkit-scrollbar-track {
  background: transparent;
}

.lyrics-scroll::-webkit-scrollbar-thumb {
  background: rgba(77,170,255,0.3);
  border-radius: 3px;
}

.lyrics-window-line {
  text-align: center;
  padding: 8px 16px;
  color: #5a6989;
  font-size: 15px;
  transition: color 0.3s, transform 0.3s, font-size 0.3s, font-weight 0.3s;
  user-select: none;
  line-height: 1.4;
}

.lyrics-window-line.active {
  color: #eaf2ff;
  font-size: 17px;
  font-weight: 600;
  transform: scale(1.05);
  text-shadow: 0 0 8px rgba(77,170,255,0.3);
}

.lyrics-normal {
  min-height: 180px;
  max-height: 240px;
}

.lyrics-hidden {
  min-height: 0 !important;
  max-height: 0 !important;
  opacity: 0;
  pointer-events: none;
}

.lyrics-expanded {
  min-height: 320px;
  max-height: 420px;
}

/* Animated Background */
.lyrics-animated-bg {
  position: absolute;
  inset: 0;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.6s;
  background: 
    radial-gradient(circle at 20% 30%, rgba(77,170,255,0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(232,1,0,0.06) 0%, transparent 50%);
  animation: gradientShift 12s ease-in-out infinite;
}

.lyrics-animated-bg.active {
  opacity: 1;
}

@keyframes gradientShift {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(-5%, 5%) scale(1.05); }
  66% { transform: translate(5%, -5%) scale(1.03); }
}

/* Progress Bar */
.player-progress-wrapper {
  padding: 16px 20px 12px 20px;
  background: rgba(15,18,24,0.6);
}

.player-progress-bar {
  position: relative;
  height: 6px;
  background: rgba(255,255,255,0.08);
  border-radius: 3px;
  cursor: pointer;
  overflow: visible;
}

.player-progress-fill {
  position: relative;
  height: 100%;
  background: linear-gradient(90deg, #4daaff 0%, #357ac9 100%);
  border-radius: 3px;
  width: 0%;
  transition: width 0.1s linear;
}

.player-progress-handle {
  position: absolute;
  right: -7px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  opacity: 0;
  transition: opacity 0.2s, transform 0.1s;
}

.player-progress-bar:hover .player-progress-handle {
  opacity: 1;
}

.player-progress-handle:hover {
  transform: translateY(-50%) scale(1.2);
}

/* Audio Wrapper */
.audio-wrapper {
  display: none;
}

/* Player Controls */
.player-controls {
  padding: 14px 18px 16px 18px;
  background: rgba(25,28,36,0.8);
}

.player-controls-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.player-controls-row:last-child {
  margin-bottom: 0;
}

.time-in-controls {
  color: #8ab8fd;
  font-size: 13px;
  min-width: 42px;
  text-align: center;
  font-variant-numeric: tabular-nums;
  font-weight: 500;
}

.player-control-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  color: #8ab8fd;
  cursor: pointer;
  padding: 10px;
  border-radius: 50%;
  transition: all 0.25s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  outline: none;
}

.player-control-btn:hover {
  background: rgba(77,170,255,0.15);
  border-color: rgba(77,170,255,0.3);
  transform: scale(1.05);
}

.player-control-btn:active {
  transform: scale(0.95);
}

.player-control-btn.main {
  background: #E80100;
  border-color: #E80100;
  color: white;
  width: 52px;
  height: 52px;
}

.player-control-btn.main:hover {
  background: #c60000;
}

.player-control-btn svg {
  width: 20px;
  height: 20px;
}

.player-control-btn.main svg {
  width: 24px;
  height: 24px;
}

/* Special buttons states */
.animation-btn,
.bit-btn {
  font-weight: bold;
  font-size: 15px;
}

.animation-btn.animation-active,
.bit-btn.bit-active,
.player-control-btn.repeat-active,
.player-control-btn.active {
  background: rgba(77,170,255,0.2);
  border-color: #4daaff;
  color: #4daaff;
  box-shadow: 0 0 12px rgba(77,170,255,0.3);
}

/* Sleep Timer */
.sleep-timer-btn {
  position: relative;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  color: #8ab8fd;
  cursor: pointer;
  padding: 10px;
  border-radius: 50%;
  transition: all 0.25s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
}

.sleep-timer-btn:hover {
  background: rgba(77,170,255,0.15);
  border-color: rgba(77,170,255,0.3);
}

.sleep-timer-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: #E80100;
  color: white;
  font-size: 10px;
  font-weight: bold;
  border-radius: 10px;
  padding: 2px 6px;
  min-width: 18px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

.sleep-menu {
  position: absolute;
  bottom: 100%;
  right: 0;
  margin-bottom: 8px;
  background: var(--modal-bg);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  min-width: 180px;
  z-index: 100;
}

.sleep-menu-item {
  padding: 10px 14px;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.2s;
  color: var(--text-color);
  font-size: 14px;
}

.sleep-menu-item:hover {
  background: rgba(77,170,255,0.15);
}

.sleep-menu-item.active {
  background: rgba(77,170,255,0.2);
  color: #4daaff;
}

/* Favorites Button */
#favorites-btn {
  position: relative;
}

#favorites-btn-icon {
  width: 18px;
  height: 18px;
  transition: transform 0.2s;
}

#favorites-btn.favorites-active {
  background: rgba(77,170,255,0.2);
  border-color: #4daaff;
}

#favorites-btn.favorites-active #favorites-btn-icon {
  transform: scale(1.2);
}

/* Volume Control */
.volume-control-wrapper {
  position: relative;
  padding: 12px 20px 14px 20px;
  background: rgba(15,18,24,0.5);
  border-top: 1px solid rgba(255,255,255,0.05);
  height: 40px;
}

.volume-track {
  position: absolute;
  left: 20px;
  right: 20px;
  height: 4px;
  background: rgba(255,255,255,0.08);
  border-radius: 2px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

.volume-fill {
  position: absolute;
  left: 20px;
  height: 4px;
  background: linear-gradient(90deg, #4daaff, #357ac9);
  border-radius: 2px;
  top: 50%;
  transform: translateY(-50%);
  width: 100%;
  pointer-events: none;
  transition: width 0.1s;
}

.volume-slider {
  width: 100%;
  height: 4px;
  background: transparent;
  outline: none;
  -webkit-appearance: none;
  cursor: pointer;
  position: relative;
  z-index: 2;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: white;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: transform 0.1s;
}

.volume-slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
}

.volume-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  background: white;
  border-radius: 50%;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* Player Extra Buttons */
.player-buttons-wrapper {
  background: rgba(15,18,24,0.5);
  padding: 12px 16px;
  border-top: 1px solid rgba(255,255,255,0.05);
}

.lyrics-toggle-btn {
  background: rgba(77,170,255,0.12);
  border: 1px solid rgba(77,170,255,0.25);
  color: #4daaff;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.2s;
  display: block;
  width: 100%;
  margin-bottom: 10px;
  font-size: 13px;
  letter-spacing: 0.02em;
}

.lyrics-toggle-btn:hover {
  background: rgba(77,170,255,0.2);
  transform: translateY(-1px);
}

.lyrics-toggle-btn:active {
  transform: translateY(0);
}

.lyrics-toggle-btn-visual {
  display: inline-block;
  font-size: 16px;
  margin-right: 6px;
}

.player-extra-buttons-row {
  display: flex;
  gap: 8px;
  justify-content: space-between;
  flex-wrap: wrap;
}

.karaoke-btn,
.player-download-btn,
.eco-btn {
  flex: 1;
  min-width: 80px;
  padding: 10px 14px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 12px;
  letter-spacing: 0.03em;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  text-decoration: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.karaoke-btn {
  background: linear-gradient(135deg, #4a1a7a, #2a0a4a);
  border: 1px solid rgba(138,43,226,0.3);
  color: #c8a2ff;
}

.karaoke-btn:hover {
  background: linear-gradient(135deg, #5a2a8a, #3a1a5a);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(138,43,226,0.2);
}

.player-download-btn {
  background: linear-gradient(135deg, #1a4a7a, #0a2a4a);
  border: 1px solid rgba(77,170,255,0.3);
  color: #4daaff;
}

.player-download-btn:hover {
  background: linear-gradient(135deg, #2a5a8a, #1a3a5a);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(77,170,255,0.2);
}

.eco-btn {
  background: linear-gradient(135deg, #1a7a4a, #0a4a2a);
  border: 1px solid rgba(39,179,76,0.3);
  color: #27b34c;
}

.eco-btn:hover {
  background: linear-gradient(135deg, #2a8a5a, #1a5a3a);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(39,179,76,0.2);
}

.eco-btn svg {
  width: 16px;
  height: 16px;
}

.eco-label {
  font-size: 11px;
}

/* ========== TRACK LIST ========== */

.track-list {
  margin: 0 auto;
  max-width: 370px;
  width: 100%;
  font-size: 1.05em;
  color: #eee;
  background: none;
  padding: 0;
}

.track-list.filtered .track:not(.is-favorite) {
  display: none !important;
}

.track {
  display: flex;
  align-items: center;
  padding: 9px 10px;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
  transition: background 0.13s, transform 0.1s;
  background: none;
}

.track:hover {
  background: rgba(255,255,255,0.05);
}

.track.current {
  background: #232b38;
  border-left: 3px solid var(--secondary-color);
}

.track:active {
  transform: scale(0.98);
  background: rgba(255,255,255,0.08) !important;
}

.track.inactive {
  opacity: 0.45;
  filter: grayscale(0.6);
}

.track.is-favorite {
  background: rgba(77,170,255,0.06);
}

.tnum {
  min-width: 30px;
  color: #8ab8fd;
  font-weight: 500;
}

.track-title {
  margin-left: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.like-star {
  margin-left: auto;
  width: 20px;
  height: 20px;
  cursor: pointer;
  opacity: 0.97;
  transition: transform 0.2s, filter 0.13s, opacity 0.13s;
}

.like-star:hover {
  filter: brightness(1.13);
  opacity: 1;
  transform: scale(1.15);
}

.like-star:active {
  transform: scale(0.9);
}

.like-star.animating {
  animation: starPulse 0.3s;
}

@keyframes starPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.4); }
}

/* ========== LOGO ========== */

.logo-bottom {
  max-width: 112px;
  width: 23vw;
  min-width: 66px;
  height: auto;
  display: block;
  margin: 0 auto 15px auto !important;
  cursor: pointer;
  transition: transform 0.05s ease-out !important;
  will-change: transform;
  transform: translateZ(0);
  transform-origin: center center;
}

.logo-bottom:hover {
  opacity: 0.9;
}

/* ========== BOTTOM CONTROLS ========== */

.bottom-controls-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 32px auto 0 auto;
  gap: 10px;
  width: 100%;
  max-width: 300px;
  padding-bottom: env(safe-area-inset-bottom);
}

.filter-favorites-btn {
  display: block;
  margin: 0 auto 15px auto;
  padding: 12px 20px;
  background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
  color: var(--secondary-color);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-size: 0.95em;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
  width: 100%;
  white-space: nowrap;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.filter-favorites-btn:hover {
  background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
  border-color: var(--secondary-color);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

.filter-favorites-btn:active {
  transform: translateY(0);
}

.filter-favorites-btn.filtered,
.filter-favorites-btn.active {
  background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
  border-color: var(--primary-color);
  color: #fff;
}

#install-pwa-btn,
#download-album-main {
  color: #fff;
  background: var(--secondary-color);
  border: none;
  border-radius: 8px;
  font-size: 1.07em;
  font-weight: bold;
  letter-spacing: 0.02em;
  margin: 8px 0;
  padding: 12px 18px;
  cursor: pointer;
  width: 100%;
  box-shadow: 0 4px 14px rgba(0,0,0,0.3);
  transition: background 0.2s, transform 0.1s;
}

#install-pwa-btn:hover,
#download-album-main:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.4);
}

#install-pwa-btn:active,
#download-album-main:active {
  transform: translateY(0);
}

#download-album-main {
  background: var(--primary-color);
  font-size: 1.09em;
}

#install-pwa-btn:hover {
  background: #3275c2;
}

#download-album-main:hover {
  background: #c60000;
}

.feedback-link,
.support-link,
.hotkeys-btn {
  color: var(--secondary-color) !important;
  text-decoration: underline !important;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  cursor: pointer;
  transition: color 0.18s;
  font-size: 1em;
  display: block;
  text-align: center;
  width: 100%;
  margin: 6px 0;
  background: none;
  border: none;
  padding: 8px;
}

.feedback-link:hover,
.support-link:hover,
.hotkeys-btn:hover {
  color: #fff !important;
}

.offline-btn {
  min-width: 110px;
  height: 40px;
  font-size: 1.05em;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  letter-spacing: 0.07em;
  box-shadow: 0 2px 8px rgba(6,0,0,0.2);
  transition: background 0.2s, color 0.14s, transform 0.1s;
  display: block;
  margin: 10px auto 0 auto;
}

.offline-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(6,0,0,0.3);
}

.offline-btn:active {
  transform: translateY(0);
}

.offline-btn.online {
  background: var(--primary-color);
  color: #fff;
}

.offline-btn.offline {
  background: #27b34c;
  color: #fff;
}

/* ========== TOASTS ========== */

#toast-container {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  pointer-events: none;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center;
}

.toast {
  background: #2a2a2a;
  border-radius: 12px;
  padding: 15px 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  max-width: 90vw;
  word-wrap: break-word;
  pointer-events: auto;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast-content {
  display: flex;
  align-items: center;
  gap: 10px;
}

.toast-emoji {
  width: 24px;
  height: 24px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 18px;
}

.toast-message {
  flex: 1;
  font-size: 14px;
  line-height: 1.4;
}

.toast-info {
  border-left: 4px solid var(--secondary-color);
}

.toast-success {
  border-left: 4px solid #27b34c;
}

.toast-error {
  border-left: 4px solid var(--primary-color);
}

.toast-warning {
  border-left: 4px solid #ff9800;
}

.toast-offline {
  border-left: 4px solid #666;
}

/* ========== MODALS ========== */

.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px);
  z-index: 9999;
  animation: fadeIn 0.3s;
}

.modal-bg.active {
  display: flex;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-feedback {
  background: var(--modal-bg);
  border-radius: 14px;
  padding: 28px 24px;
  min-width: 240px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  position: relative;
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from {
    transform: translateY(30px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-feedback h2 {
  margin-top: 0;
  margin-bottom: 18px;
  color: var(--secondary-color);
  font-size: 22px;
}

.bigclose {
  background: none;
  border: none;
  position: absolute;
  top: 14px;
  right: 14px;
  cursor: pointer;
  color: #eee;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, background 0.2s;
}

.bigclose:hover {
  transform: scale(1.1);
  background: rgba(255,255,255,0.1);
}

.bigclose:active {
  transform: scale(0.95);
}

.bigclose svg {
  width: 22px;
  height: 22px;
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-overlay.show {
  display: flex;
  opacity: 1;
}

.modal-content {
  background: #1e1e1e;
  border-radius: 12px;
  padding: 30px;
  max-width: 90%;
  max-height: 80%;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.show .modal-content {
  transform: scale(1);
}

.modal-content h2 {
  color: #4daaff;
  margin-bottom: 20px;
  text-align: center;
}

.modal-close-btn {
  background: #4daaff;
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  margin-top: 20px;
  display: block;
  margin-left: auto;
  margin-right: auto;
  transition: background 0.3s, transform 0.1s;
}

.modal-close-btn:hover {
  background: #357ac9;
  transform: translateY(-1px);
}

.modal-close-btn:active {
  transform: translateY(0);
}

/* ========== MINI MODE ========== */

.mini-now {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 10px;
  background: #232b38;
  margin-bottom: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.mini-now .tnum {
  color: #8ab8fd;
  min-width: 28px;
  font-weight: 500;
}

.mini-now .track-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 15px;
}

.next-up {
  display: none;
  margin: 8px 4px 0 4px;
  font-size: 0.98em;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
}

.mini-mode .next-up {
  display: flex;
}

.next-up .label {
  color: #8ab8fd;
  opacity: 0.9;
  font-size: 13px;
}

.next-up .title {
  color: var(--primary-color);
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
  flex: 1;
  font-size: 14px;
}

/* ========== iOS SPECIFIC ========== */

body.ios .volume-control-wrapper {
  display: none !important;
}

body.ios #mute-btn {
  display: none !important;
}

/* ========== RESPONSIVE ========== */

@media (max-width: 600px) {
  .hotkeys-btn {
    display: none !important;
  }
  
  .player-controls-row {
    gap: 8px;
  }
  
  .player-control-btn {
    width: 40px;
    height: 40px;
    padding: 8px;
  }
  
  .player-control-btn.main {
    width: 48px;
    height: 48px;
  }
  
  .player-control-btn svg {
    width: 18px;
    height: 18px;
  }
  
  .player-control-btn.main svg {
    width: 22px;
    height: 22px;
  }
  
  .time-in-controls {
    font-size: 12px;
    min-width: 38px;
  }
  
  .player-extra-buttons-row {
    flex-direction: column;
  }
  
  .karaoke-btn,
  .player-download-btn,
  .eco-btn {
    width: 100%;
    min-width: 100%;
  }
  
  .lyrics-window-line {
    font-size: 14px;
    padding: 7px 12px;
  }
  
  .lyrics-window-line.active {
    font-size: 16px;
  }
}

@media (max-width: 380px) {
  .promo-cover {
    width: 200px;
    height: 200px;
  }
  
  .album-icon {
    width: 54px;
    height: 54px;
  }
  
  .album-icon.active {
    width: 60px;
    height: 60px;
  }
}

@media (display-mode: standalone) {
  .bottom-controls-center {
    padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
  }
}

/* ========== DARK MODE ENHANCEMENTS ========== */

@media (prefers-color-scheme: dark) {
  body {
    background: #0d0d0d;
  }
}

/* ========== ACCESSIBILITY ========== */

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

button:focus-visible,
a:focus-visible,
input:focus-visible {
  outline: 2px solid var(--secondary-color);
  outline-offset: 2px;
}

/* ========== ANIMATIONS ========== */

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-in {
  animation: fadeInUp 0.4s ease-out;
}

/* ========== LOADING STATES ========== */

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(77,170,255,0.2);
  border-top-color: #4daaff;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 20px auto;
}
/* Lyrics Modal */
.lyrics-modal .lyrics-fulltext::-webkit-scrollbar {
  width: 8px;
}

.lyrics-modal .lyrics-fulltext::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}

.lyrics-modal .lyrics-fulltext::-webkit-scrollbar-thumb {
  background: rgba(77,170,255,0.3);
  border-radius: 4px;
}

.modal-action-btn {
  background: rgba(77,170,255,0.15);
  border: 1px solid rgba(77,170,255,0.3);
  color: #4daaff;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  transition: all 0.2s;
}

.modal-action-btn:hover {
  background: rgba(77,170,255,0.25);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(77,170,255,0.2);
}

.modal-action-btn:active {
  transform: translateY(0);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

