–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.
- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).
- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  ```ts
  export function x() {}
  ```
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.
- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.
- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.
- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].
- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. 
- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.
- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.

–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: vi3na1bita-music
–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: https://github.com/apel-s-in/vi3na1bita-music
# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.
–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).

–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:
vi3na1bita-music/
‚îú‚îÄ‚îÄ .git/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ applypatch-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fsmonitor-watchman.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-update.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-applypatch.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-merge-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-push.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-rebase.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-receive.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prepare-commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ push-to-checkout.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sendemail-validate.sample
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update.sample
‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exclude
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HEAD
‚îÇ   ‚îú‚îÄ‚îÄ objects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pack/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-b015ea2ffb23abe418827f7346e6f8c990551f45.idx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-b015ea2ffb23abe418827f7346e6f8c990551f45.pack
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ pack-b015ea2ffb23abe418827f7346e6f8c990551f45.rev
‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tags/
‚îÇ   ‚îú‚îÄ‚îÄ config
‚îÇ   ‚îú‚îÄ‚îÄ config.worktree
‚îÇ   ‚îú‚îÄ‚îÄ description
‚îÇ   ‚îú‚îÄ‚îÄ FETCH_HEAD
‚îÇ   ‚îú‚îÄ‚îÄ HEAD
‚îÇ   ‚îî‚îÄ‚îÄ index
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ e2e.yml
‚îÇ       ‚îú‚îÄ‚îÄ generate-context.yml
‚îÇ       ‚îî‚îÄ‚îÄ validate.yml
‚îú‚îÄ‚îÄ .meta/
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ albums/
‚îÇ   ‚îú‚îÄ‚îÄ gallery/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ news/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ thumbs/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ news-cover-02-thumb.jpg
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ news-cover-02-thumb.webp
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-01-baner.html
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.avif
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.png
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ news-cover-02.webp
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ emoji/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ noto/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ animated/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cross_mark.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ loudspeaker.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ satellite_antenna.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sparkles.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ trophy.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ warning.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ white_check_mark.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ fallback/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cross_mark.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ loudspeaker.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ satellite_antenna.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sparkles.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ trophy.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ warning.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ white_check_mark.webp
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ cross_mark.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ loudspeaker.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ satellite_antenna.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ sparkles.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ trophy.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ warning.png
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ white_check_mark.png
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ icons/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ apple-touch-icon.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-16.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-32.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-192.png
‚îÇ   ‚îî‚îÄ‚îÄ icon-512.png
‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îú‚îÄ‚îÄ desktop/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@2x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@3x.png
‚îÇ   ‚îú‚îÄ‚îÄ icon_album/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.png
‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@2x.jpg
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ bg.png
‚îÇ   ‚îú‚îÄ‚îÄ logo.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-01.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-02.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-03.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-04.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-21.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-22.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-23.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-24.png
‚îÇ   ‚îú‚îÄ‚îÄ star.png
‚îÇ   ‚îî‚îÄ‚îÄ star2.png
‚îú‚îÄ‚îÄ news/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ news.json
‚îú‚îÄ‚îÄ performance/
‚îÇ   ‚îî‚îÄ‚îÄ rum.js
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ albums.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ downloads.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-policy.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ player-ui.js
‚îÇ   ‚îú‚îÄ‚îÄ ci/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lint-sw.mjs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate-content.mjs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validate-manifest.mjs
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.spec.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player.spec.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modals.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notify.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sleep.js
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sw-manager.js
‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ PlayerCore.js
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îî‚îÄ‚îÄ main.css
‚îú‚îÄ‚îÄ albums.json
‚îú‚îÄ‚îÄ custom.json
‚îú‚îÄ‚îÄ generate-context.js
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ news.html
‚îî‚îÄ‚îÄ service-worker.js


–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: 2025-12-20 23:05:11 UTC
//=================================================
// FILE: /.github/workflows/e2e.yml
name: E2E smoke

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npx -y playwright@1.48.2 install --with-deps

      - name: Start static server
        run: |
          npx -y http-server -p 4173 -c-1 . &
          echo $! > server.pid
          sleep 2

      - name: Run smoke tests
        env:
          BASE_URL: http://127.0.0.1:4173
        run: npx -y @playwright/test@1.48.2 scripts/e2e

      - name: Stop server
        if: always()
        run: kill $(cat server.pid) || true

//=================================================
// FILE: /.github/workflows/generate-context.yml
name: Generate .meta context

on:
  push:
    branches: [ main, master ]
    # –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤–æ—Ä–∫—Ñ–ª–æ—É –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤, –º–µ–Ω—è—é—â–∏—Ö —Ç–æ–ª—å–∫–æ .meta
    paths-ignore:
      - '.meta/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate .meta
        run: |
          node generate-context.js --mode=both --max-lines=20000
          ls -la .meta || true

      - name: Commit .meta
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: generate .meta context"
          branch: ${{ github.ref_name }}
          file_pattern: ".meta/**"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

//=================================================
// FILE: /.github/workflows/validate.yml
name: Validate manifest and SW

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run manifest validator
        run: node scripts/ci/validate-manifest.mjs

      - name: Run SW linter
        run: node scripts/ci/lint-sw.mjs

      - name: Validate albums and galleries
        run: node scripts/ci/validate-content.mjs

  remote-validate:
    name: Remote content validate (informational)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Remote validate (warnings only)
        run: node scripts/ci/validate-content.mjs

//=================================================
// FILE: /albums.json
{
  "albums": [
    {
      "key": "mezhdu-zlom-i-dobrom",
      "title": "–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "base": "https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/"
    },
    {
      "key": "golos-dushi",
      "title": "–ì–æ–ª–æ—Å –î—É—à–∏",
      "base": "https://apel-s-in.github.io/vi3na1bita-golos-dushi/"
    },
    {
      "key": "odnazhdy-v-skazke",
      "title": "–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ",
      "base": "https://apel-s-in.github.io/vi3na1bita-odnazhdy-v-skazke/"
    },
    {
      "key": "krevetochka",
      "title": "–ö–†–ï–í–ï„ÉÑTOCHKA",
      "base": "https://apel-s-in.github.io/krevetochka/"
    }
  ]
}

//=================================================
// FILE: /albums/gallery/00/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-01.webp",
        "full": "albums/gallery/00/00-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-02.webp",
        "full": "albums/gallery/00/00-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/01/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-01.webp",
        "full": "albums/gallery/01/01-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-02.webp",
        "full": "albums/gallery/01/01-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-03.webp",
        "full": "albums/gallery/01/01-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-04.webp",
        "full": "albums/gallery/01/01-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/02/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-01.webp",
        "full": "albums/gallery/02/02-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-02.webp",
        "full": "albums/gallery/02/02-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-03.webp",
        "full": "albums/gallery/02/02-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-04.webp",
        "full": "albums/gallery/02/02-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/03/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-01.webp",
        "full": "albums/gallery/03/03-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-02.webp",
        "full": "albums/gallery/03/03-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-03.webp",
        "full": "albums/gallery/03/03-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-04.webp",
        "full": "albums/gallery/03/03-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/news/index.json
{
  "items": [
    { "type": "html", "src": "albums/gallery/news/news-01-baner.html" },
    {
      "formats": {
        "webp": "albums/gallery/news/news-cover-02.webp",
        "full": "albums/gallery/news/news-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /custom.json
{
  "rumEndpoint": "",
  "sw": {
    "mediaMaxCacheMB": 150,
    "nonRangeMaxStoreMB": 25,
    "nonRangeMaxStoreMBSlow": 10,
    "allowUnknownSize": false,
    "revalidateDays": 7
  },
  "items": [
    {
      "type": "ym",
      "title": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
      "subtitle": "–Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∞",
      "url": "https://music.yandex.ru/artist/24739002?utm_source=web&utm_medium=copy_link",
      "cover": ""
    },
    {
      "type": "tgPost",
      "title": "–°–≤–µ–∂–∏–π –ø–æ—Å—Ç –≤ Telegram",
      "url": "https://t.me/vitrina_razbita/28",
      "height": 480
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 3,
      "hash": "b8300406c5f33725de",
      "containerId": "vk_playlist_165137_3"
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 2,
      "hash": "d70fba309dc0bea296",
      "containerId": "vk_playlist_165137_2"
    }
  ]
}

//=================================================
// FILE: /index.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="preload" href="img/logo.png" as="image">
  <link rel="stylesheet" href="styles/main.css">
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>
</head>
<body>
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false">
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus>
      <button id="promo-btn">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons"></div>
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="–ù–∞–∑–∞–¥">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity=".65"/><polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round"/></svg>
        </button>
        <div id="cover-slot"></div>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="–í–ø–µ—Ä—ë–¥">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity=".65"/><polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div id="social-links" class="socials-under-cover"></div>
    </header>
    <div id="now-playing" style="width:100%;max-width:395px;margin:8px auto 0"></div>
    <div class="track-list" id="track-list"></div>
    <div class="bottom-controls-center">
      <button class="filter-favorites-btn" id="filter-favorites-btn">–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏</button>
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø">
      <button id="install-pwa-btn" style="display:none">–£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï</button>
      <button id="download-album-main">–°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú</button>
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none">–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</button>
      <button id="sysinfo-btn" style="display:none">–û –°–ò–°–¢–ï–ú–ï</button>
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>
      <button class="offline-btn online" id="offline-btn">ONLINE</button>
    </div>
  </div>
  <div id="modals-container"></div>

  <script>
    const VERSION='8.1.0',BUILD_DATE='2025-12-21';
    window.VERSION=VERSION;window.BUILD_DATE=BUILD_DATE;

    window.addEventListener('load',()=>{
      if(/iPhone|iPad|iPod/i.test(navigator.userAgent))document.body.classList.add('ios');
      if(localStorage.getItem('promocode')==='VITRINA2025')unlockApp();
      
      const inp=document.getElementById('promo-inp'),btn=document.getElementById('promo-btn'),err=document.getElementById('promo-error');
      const check=()=>{
        if(inp.value.trim()==='VITRINA2025'){localStorage.setItem('promocode',inp.value.trim());unlockApp();}
        else{err.textContent='‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';inp.classList.add('error');setTimeout(()=>{err.textContent='';inp.classList.remove('error');},2000);}
      };
      btn?.addEventListener('click',check);
      inp?.addEventListener('keypress',e=>{if(e.key==='Enter')check();});
    });

    function unlockApp(){
      document.getElementById('promocode-block')?.classList.add('hidden');
      document.getElementById('main-block')?.classList.remove('hidden');
      const wait=setInterval(()=>{if(window.app?.initialize){clearInterval(wait);window.app.initialize();}},100);
    }
  </script>

  <script src="./scripts/core/utils.js" type="module"></script>
  <script src="./scripts/core/bootstrap.js"></script>
  <script src="./scripts/core/config.js" type="module"></script>
  <script src="./src/PlayerCore.js" type="module"></script>
  <script src="./scripts/ui/notify.js" defer></script>
  <script src="./scripts/ui/favorites.js" defer></script>
  <script src="./scripts/ui/sleep.js" defer></script>
  <script src="./scripts/ui/modals.js" defer></script>
  <script src="./scripts/app/background.js" defer></script>
  <script src="./scripts/app/playback-policy.js" defer></script>
  <script src="./scripts/app/player-ui.js" defer></script>
  <script src="./scripts/app/gallery.js" type="module"></script>
  <script src="./scripts/app/albums.js" type="module"></script>
  <script src="./scripts/app/downloads.js" type="module"></script>
  <script src="./scripts/app.js" type="module"></script>
</body>
</html>

//=================================================
// FILE: /manifest.json
{
  "name": "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "short_name": "Vi3na1bita",
  "description": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#181818",
  "theme_color": "#181818",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "categories": ["music", "entertainment"],
  "screenshots": []
}

//=================================================
// FILE: /news.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0e15;
      --panel: #131a26;
      --text: #eaf2ff;
      --muted: #9db7dd;
      --accent: #4daaff;
      --danger: #E80100;
      --border: #23324a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 14px;
      background: var(--bg); color: var(--text);
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
    }
    .container { max-width: 760px; margin: 0 auto; }
    h1 { margin: 6px 0 16px; font-size: 22px; }
    .news-list { display: grid; gap: 14px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .date { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .media { margin: 10px 0; }
    .media iframe, .media img, .media video {
      width: 100%; border: 0; border-radius: 8px; min-height: 220px; background: #0b0e15;
    }
    .card p { margin: 8px 0; line-height: 1.45; }
    .tags { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 12px; color: var(--accent); background: rgba(77,170,255,.12); border: 1px solid rgba(77,170,255,.25); padding: 4px 8px; border-radius: 999px; }
    .error { color: var(--danger); background: rgba(232,1,0,.1); border: 1px solid rgba(232,1,0,.2); padding: 10px; border-radius: 8px; }
    .loading { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ù–æ–≤–æ—Å—Ç–∏</h1>
    <div id="status" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="news" class="news-list"></div>
  </div>

  <script>
    async function loadNews() {
      const status = document.getElementById('status');
      const listEl = document.getElementById('news');
      try {
        const r = await fetch('./news/news.json', { cache: 'no-cache' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const items = Array.isArray(j.items) ? j.items : [];
        status.style.display = 'none';
        if (!items.length) {
          status.style.display = '';
          status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
          return;
        }
        listEl.innerHTML = items.map(renderCard).join('');
      } catch (e) {
        status.className = 'error';
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
      }
    }
    function esc(s) { return String(s || '').replace(/[<>&'"]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&#39;','"':'&quot;'}[m])); }
    function renderCard(it) {
      const title = esc(it.title || '–ù–æ–≤–æ—Å—Ç—å');
      const date = esc(it.date || '');
      const text = esc(it.text || '');
      const tags = Array.isArray(it.tags) ? it.tags : [];
      let media = '';
      if (it.embedUrl) {
        media = `<div class="media"><iframe loading="lazy" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`;
      } else if (it.image) {
        media = `<div class="media"><img loading="lazy" src="${esc(it.image)}" alt=""></div>`;
      } else if (it.video) {
        media = `<div class="media"><video controls preload="metadata" src="${esc(it.video)}"></video></div>`;
      }
      return `<article class="card">
        <h2>${title}</h2>
        ${date ? `<div class="date">${date}</div>` : ''}
        ${media}
        ${text ? `<p>${text}</p>` : ''}
        ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join('')}</div>` : ''}
      </article>`;
    }
    loadNews();
  </script>
</body>
</html>

//=================================================
// FILE: /service-worker.js
// service-worker.js
// –ï–¥–∏–Ω—ã–π Service Worker –¥–ª—è PWA "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"

const SW_VERSION = '8.0.4';

// –û—Å–Ω–æ–≤–Ω—ã–µ –∫—ç—à–∏ (–æ–∂–∏–¥–∞—é—Ç—Å—è lint-sw.mjs)
const CORE_CACHE = `vitrina-core-v${SW_VERSION}`;
const RUNTIME_CACHE = `vitrina-runtime-v${SW_VERSION}`;
const MEDIA_CACHE = `vitrina-media-v${SW_VERSION}`;
const OFFLINE_CACHE = `vitrina-offline-v${SW_VERSION}`;
const META_CACHE = `vitrina-meta-v${SW_VERSION}`;

// –ö–æ–Ω—Ñ–∏–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ–∂–∏–¥–∞–µ—Ç—Å—è lint-sw.mjs)
const DEFAULT_SW_CONFIG = {
  mediaMaxCacheMB: 150,
  nonRangeMaxStoreMB: 25,
  nonRangeMaxStoreMBSlow: 10,
  allowUnknownSize: false,
  revalidateDays: 7
};

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ ¬´—è–¥—Ä–∞¬ª
const STATIC_ASSETS = [
  './', './index.html', './news.html', './manifest.json',
  './styles/main.css', './img/logo.png', './img/star.png', './img/star2.png',
  './icons/favicon-32.png', './icons/favicon-16.png', './icons/apple-touch-icon.png',
  './scripts/core/bootstrap.js', './scripts/core/config.js',
  './scripts/app/gallery.js', './scripts/app/albums.js', './scripts/app/navigation.js',
  './scripts/app/downloads.js', './scripts/app/background-audio.js',
  './scripts/app/background-events.js', './scripts/app/player-ui.js', './scripts/app.js',
  './scripts/ui/notify.js', './scripts/ui/favorites.js', './scripts/ui/sleep.js',
  './scripts/ui/lyrics-modal.js', './scripts/ui/sysinfo.js',
  './src/PlayerCore.js',

  // Howler.js (CDN)
  // –í–ê–ñ–ù–û: –Ω–µ precache –Ω–∞ install, —á—Ç–æ–±—ã –Ω–µ —Ä–æ–Ω—è—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É SW –∏–∑-–∑–∞ opaque/CORS/CDN-–æ—à–∏–±–æ–∫.
  // CDN –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ —Å–µ—Ç–∏; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–∫—ç—à–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ runtime-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é.
];

// ========== INSTALL ==========
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CORE_CACHE)
      .then((cache) => cache.addAll(STATIC_ASSETS))
      .then(() => self.skipWaiting())
  );
});

// ========== ACTIVATE ==========
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((names) =>
      Promise.all(
        names.map((name) => {
          if (
            name !== CORE_CACHE &&
            name !== RUNTIME_CACHE &&
            name !== MEDIA_CACHE &&
            name !== OFFLINE_CACHE &&
            name !== META_CACHE
          ) {
            return caches.delete(name);
          }
          return undefined;
        })
      )
    ).then(() => self.clients.claim())
  );
});

// ========== FETCH ==========
self.addEventListener('fetch', (event) => {
  const { request } = event;

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ-GET –∑–∞–ø—Ä–æ—Å—ã
  if (request.method !== 'GET') {
    return;
  }

  const url = new URL(request.url);

  // –ê—É–¥–∏–æ-—Ñ–∞–π–ª—ã ‚Äî –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∫—ç—à–∞, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥)
  if (/\.(mp3|ogg|m4a|flac)$/i.test(url.pathname)) {
    event.respondWith(fetch(request));
    return;
  }

  // –°—Ç–∞—Ç–∏–∫–∞: cache-first –∏–∑ CORE/RUNTIME
  const isStatic = STATIC_ASSETS.some((asset) =>
    asset.startsWith('http')
      ? request.url === asset
      : request.url.endsWith(asset.replace('./', ''))
  );

  if (isStatic) {
    event.respondWith(
      caches.match(request).then((cached) => {
        if (cached) return cached;
        return fetch(request).then((resp) => {
          return caches.open(RUNTIME_CACHE).then((cache) => {
            cache.put(request, resp.clone());
            return resp;
          });
        });
      })
    );
    return;
  }

  // –û—Å—Ç–∞–ª—å–Ω–æ–µ: network-first —Å fallback –≤ RUNTIME_CACHE
  event.respondWith(
    fetch(request)
      .then((resp) => {
        const copy = resp.clone();
        caches.open(RUNTIME_CACHE).then((cache) => cache.put(request, copy));
        return resp;
      })
      .catch(() => caches.match(request))
  );
});

// ========== MESSAGE API (–¥–ª—è sysinfo.js –∏ ServiceWorkerManager) ==========
self.addEventListener('message', (event) => {
  const { data, ports } = event;
  if (!data || typeof data !== 'object') return;

  const type = data.type;

  // –û—Ç–≤–µ—Ç –≤–µ—Ä—Å–∏–∏ SW –¥–ª—è sysinfo.js
  if (type === 'GET_SW_VERSION') {
    const port = ports && ports[0];
    if (port) {
      port.postMessage({ version: SW_VERSION });
    }
    return;
  }

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
  if (type === 'SKIP_WAITING') {
    self.skipWaiting();
    return;
  }

  // –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ API ServiceWorkerManager ‚Äî —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å
  if (type === 'CLEAR_CACHE') {
    const cacheType = data.payload && data.payload.cacheType;
    let targetNames = [CORE_CACHE, RUNTIME_CACHE, MEDIA_CACHE, OFFLINE_CACHE, META_CACHE];

    if (cacheType === 'media') {
      targetNames = [MEDIA_CACHE];
    } else if (cacheType === 'offline') {
      targetNames = [OFFLINE_CACHE];
    }

    event.waitUntil(
      caches.keys().then((names) =>
        Promise.all(
          names.map((name) => {
            if (targetNames.includes(name)) {
              return caches.delete(name);
            }
            return undefined;
          })
        )
      )
    );
    return;
  }

  if (type === 'CACHE_AUDIO') {
    // –í —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Ç–æ–ª—å–∫–æ –Ω–µ –ø–∞–¥–∞–µ–º.
    // –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ.
    return;
  }

  if (type === 'GET_CACHE_SIZE') {
    const port = ports && ports[0];
    if (!port) return;

    event.waitUntil(
      (async () => {
        let total = 0;
        try {
          const names = await caches.keys();
          for (const name of names) {
            const cache = await caches.open(name);
            const reqs = await cache.keys();
            for (const req of reqs) {
              const resp = await cache.match(req);
              if (resp) {
                const clone = resp.clone();
                const buf = await clone.arrayBuffer();
                total += buf.byteLength;
              }
            }
          }
        } catch (e) {
          // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—ë–º —Ç–æ, —á—Ç–æ –Ω–∞—Å—á–∏—Ç–∞–ª–∏
        }
        port.postMessage({ size: total });
      })()
    );
    return;
  }
});

//=================================================
// FILE: /performance/rum.js
;(function(){
  // –ù–µ–±–æ–ª–µ–∑–Ω–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞: —á—Ç–æ–±—ã <script src="./performance/rum.js"> –Ω–µ –¥–∞–≤–∞–ª 404
  // –∏ –Ω–µ –ª–æ–º–∞–ª –º–µ—Ç—Ä–∏–∫–∏. –ï—Å–ª–∏ –≤ custom.json –ø–æ—è–≤–∏—Ç—Å—è endpoint ‚Äî –≤–∞—à –∫–æ–¥ –≤ index.html
  // –≤—ã–∑–æ–≤–µ—Ç initRUM(...) –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏.
  if (typeof window.initRUM !== 'function') {
    window.initRUM = function initRUM() { /* no-op */ };
  }
})();

//=================================================
// FILE: /scripts/app.js
// scripts/app.js ‚Äî –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
(function AppModule() {
  'use strict';
  const w = window;

  class Application {
    constructor() {
      this.initialized = false;
    }

    async initialize() {
      if (this.initialized) return;
      this.initialized = true;
      console.log(`üéµ Initializing app v${w.VERSION}`);

      try {
        await w.Utils?.waitFor?.(() => w.albumsIndex?.length > 0, 2000);
        
        const modules = [
          ['FavoritesManager', 'initialize'],
          ['GalleryManager', 'initialize'],
          ['AlbumsManager', 'initialize'],
          ['PlayerUI', 'initialize']
        ];
        
        for (const [name, method] of modules) {
          await w.Utils?.waitFor?.(() => w[name]?.[method], 2000);
          w[name][method]();
          console.log(`‚úÖ ${name} initialized`);
        }

        await w.PlayerState?.apply?.();
        this.setupHotkeys();
        this.setupPWA();
        this.setupSWMessaging();
        
        // Download button
        document.getElementById('download-album-main')?.addEventListener('click', () => {
          const album = w.AlbumsManager?.getCurrentAlbum?.();
          if (!album || album.startsWith('__')) {
            w.NotificationSystem?.info('–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –Ω–µ–ª—å–∑—è —Å–∫–∞—á–∞—Ç—å');
            return;
          }
          w.DownloadsManager?.downloadAlbum(album);
        });

        console.log('‚úÖ Application initialized');
      } catch (e) {
        console.error('‚ùå Init failed:', e);
        w.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
      }
    }

    setupHotkeys() {
      document.addEventListener('keydown', (e) => {
        if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
        const k = e.key.toLowerCase();
        const pc = w.playerCore;
        
        const actions = {
          'k': () => w.PlayerUI?.togglePlayPause?.(),
          ' ': () => w.PlayerUI?.togglePlayPause?.(),
          'n': () => pc?.next(),
          'p': () => pc?.prev(),
          'x': () => pc?.stop(),
          'm': () => document.getElementById('mute-btn')?.click(),
          'r': () => document.getElementById('repeat-btn')?.click(),
          'u': () => document.getElementById('shuffle-btn')?.click(),
          'a': () => document.getElementById('animation-btn')?.click(),
          'b': () => document.getElementById('pulse-btn')?.click(),
          'f': () => document.getElementById('favorites-btn')?.click(),
          't': () => w.SleepTimer?.show?.(),
          'y': () => document.getElementById('lyrics-toggle-btn')?.click(),
          'arrowleft': () => pc?.seek(Math.max(0, pc.getPosition() - 5)),
          'arrowright': () => pc?.seek(Math.min(pc.getDuration(), pc.getPosition() + 5)),
          'arrowup': () => pc?.setVolume(Math.min(100, (pc.getVolume() || 100) + 5)),
          'arrowdown': () => pc?.setVolume(Math.max(0, (pc.getVolume() || 100) - 5))
        };
        
        if (actions[k]) { e.preventDefault(); actions[k](); }
      });
    }

    setupPWA() {
      let prompt = null;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        prompt = e;
        const btn = document.getElementById('install-pwa-btn');
        if (btn) {
          btn.style.display = 'block';
          btn.onclick = async () => {
            prompt?.prompt();
            const { outcome } = await prompt?.userChoice || {};
            if (outcome === 'accepted') w.NotificationSystem?.success('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
            prompt = null;
            btn.style.display = 'none';
          };
        }
      });
    }

    setupSWMessaging() {
      if (!('serviceWorker' in navigator)) return;
      const handle = async (e) => {
        const msg = e?.data;
        if (msg?.type !== 'SW_VERSION' || !msg.version || msg.version === w.VERSION) return;
        if (!confirm(`–û–±–Ω–æ–≤–∏—Ç—å –¥–æ ${msg.version}?`)) return;
        w.PlayerState?.save?.({ forReload: true });
        try {
          const reg = await navigator.serviceWorker.getRegistration();
          reg?.waiting?.postMessage({ type: 'SKIP_WAITING' });
          navigator.serviceWorker.addEventListener('controllerchange', () => location.reload(), { once: true });
        } catch { location.reload(); }
      };
      navigator.serviceWorker.addEventListener('message', handle);
      window.addEventListener('message', handle);
    }
  }

  w.app = new Application();
  if (localStorage.getItem('promocode') === 'VITRINA2025') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => w.app.initialize());
    } else w.app.initialize();
  }
})();

// PlayerState
(function() {
  const KEY = 'playerStateV2';

  function save(opts = {}) {
    try {
      const pc = window.playerCore;
      if (!pc) return;
      const track = pc.getCurrentTrack();
      const state = {
        album: window.AlbumsManager?.getPlayingAlbum?.(),
        currentAlbum: window.AlbumsManager?.getCurrentAlbum?.(),
        trackUid: track?.uid?.trim() || null,
        sourceAlbum: track?.sourceAlbum?.trim() || null,
        trackIndex: pc.getIndex() || 0,
        position: Math.floor(pc.getPosition() || 0),
        volume: pc.getVolume() ?? 100,
        wasPlaying: pc.isPlaying()
      };
      localStorage.setItem(KEY, JSON.stringify(state));
      if (opts.forReload) sessionStorage.setItem('resumeAfterReloadV2', '1');
    } catch {}
  }

  async function apply() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return;
      const s = JSON.parse(raw);
      if (!s?.album || !window.AlbumsManager || !window.playerCore) return;

      if (s.currentAlbum && s.currentAlbum !== s.album) {
        await window.AlbumsManager.loadAlbum(s.currentAlbum);
      }

      if (s.album === '__favorites__') {
        let idx = s.trackIndex || 0;
        if (s.trackUid) {
          const model = window.favoritesRefsModel || [];
          const found = model.findIndex(it => it?.__uid === s.trackUid);
          if (found >= 0) idx = found;
        }
        await window.AlbumsManager.ensureFavoritesPlayback(idx);
      } else {
        const data = window.AlbumsManager.getAlbumData(s.album);
        const info = window.albumsIndex?.find(a => a.key === s.album);
        if (!data || !info) return;
        
        const tracks = data.tracks.filter(t => t.file).map(t => ({
          src: t.file, title: t.title, artist: data.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          album: s.album, cover: 'img/logo.png', lyrics: t.lyrics, fulltext: t.fulltext,
          uid: t.uid?.trim() || null, hasLyrics: t.hasLyrics
        }));
        
        if (tracks.length) {
          let idx = s.trackIndex || 0;
          if (s.trackUid) {
            const found = tracks.findIndex(t => t.uid === s.trackUid);
            if (found >= 0) idx = found;
          }
          window.playerCore.setPlaylist(tracks, idx, { artist: data.artist, album: data.title, cover: 'img/logo.png' });
          window.AlbumsManager.setPlayingAlbum(s.album);
          window.playerCore.play(idx);
        }
      }

      window.playerCore.setVolume(s.volume ?? 100);
      if (s.position > 0) try { window.playerCore.seek(s.position); } catch {}
      if (!s.wasPlaying && window.playerCore.isPlaying()) window.playerCore.pause();
    } catch {} finally {
      try { sessionStorage.removeItem('resumeAfterReloadV2'); } catch {}
    }
  }

  window.PlayerState = { save, apply };
})();

//=================================================
// FILE: /scripts/app/albums.js
// scripts/app/albums.js ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞–º–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)

const APP_CONFIG = window.APP_CONFIG;

class AlbumsManager {
  constructor() {
    this.currentAlbum = null;
    this.playingAlbum = null;
    this.albumsData = new Map();
    this.albumCoverUrlCache = new Map();
    this.isLoading = false;
    this.isGalleryVisible = true;
  }

  async initialize() {
    await this._waitForAlbumsIndex();
    if (!window.albumsIndex?.length) {
      console.error('‚ùå No albums found');
      return;
    }
    console.log(`‚úÖ Albums available: ${window.albumsIndex.length}`);
    this.renderAlbumIcons();
    
    const lastAlbum = localStorage.getItem('currentAlbum');
    const ordered = (APP_CONFIG?.ICON_ALBUMS_ORDER || []).map(x => x.key).filter(Boolean);
    const albumToLoad = lastAlbum || ordered.find(k => !k.startsWith('__') && window.albumsIndex.some(a => a.key === k)) || window.albumsIndex[0]?.key;
    
    if (albumToLoad) await this.loadAlbum(albumToLoad);
  }

  async _waitForAlbumsIndex(maxWait = 2000) {
    const step = 50;
    let waited = 0;
    while ((!window.albumsIndex?.length) && waited < maxWait) {
      await new Promise(r => setTimeout(r, step));
      waited += step;
    }
  }

  renderAlbumIcons() {
    const container = document.getElementById('album-icons');
    if (!container) return;
    container.innerHTML = '';

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    APP_CONFIG.ICON_ALBUMS_ORDER.forEach(({ key, title, icon }) => {
      if (!key.startsWith('__') && !window.albumsIndex.some(a => a.key === key)) return;

      const el = document.createElement('div');
      el.className = 'album-icon';
      el.dataset.album = key;
      el.dataset.akey = key;
      el.title = title;

      const base = icon || 'img/logo.png';
      const p1x = isMobile ? base.replace(/icon_album\/(.+)\.png$/i, 'icon_album/mobile/$1@1x.jpg') : base.replace(/\.png$/i, '@1x.png');
      const p2x = isMobile ? p1x.replace(/@1x\.jpg$/i, '@2x.jpg') : p1x.replace(/@1x\.png$/i, '@2x.png');

      el.innerHTML = `<img src="${p1x}" srcset="${p2x} 2x" alt="${title}" draggable="false" loading="lazy" width="60" height="60">`;
      el.addEventListener('click', () => this._onIconClick(key));
      container.appendChild(el);
    });
  }

  async _onIconClick(key) {
    if (this.currentAlbum === key && !key.startsWith('__')) {
      this._toggleGallery();
      return;
    }
    await this.loadAlbum(key);
  }

  _toggleGallery() {
    this.isGalleryVisible = !this.isGalleryVisible;
    const wrap = document.getElementById('cover-wrap');
    if (wrap) wrap.style.display = this.isGalleryVisible ? '' : 'none';
    window.NotificationSystem?.info(this.isGalleryVisible ? 'üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –ø–æ–∫–∞–∑–∞–Ω–∞' : 'üö´ –ì–∞–ª–µ—Ä–µ—è —Å–∫—Ä—ã—Ç–∞');
  }

  async loadAlbum(key) {
    if (this.isLoading) return;
    this.isLoading = true;

    try {
      this.isGalleryVisible = true;
      this._clearUI();
      this._updateFilterBtn(key);

      if (key === '__favorites__') await this._loadFavorites();
      else if (key === '__reliz__') await this._loadNews();
      else await this._loadRegular(key);

      this.currentAlbum = key;
      this._updateActiveIcon(key);
      localStorage.setItem('currentAlbum', key);
      this._resetFilter();

      window.PlayerUI?.switchAlbumInstantly?.(key);
      window.PlayerState?.save?.();
      console.log(`‚úÖ Album loaded: ${key}`);
    } catch (e) {
      console.error('‚ùå Failed to load album:', e);
      window.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–∞');
    } finally {
      this.isLoading = false;
    }
  }

  _updateFilterBtn(key) {
    const btn = document.getElementById('filter-favorites-btn');
    if (btn) btn.style.display = (key === '__favorites__' || key === '__reliz__') ? 'none' : '';
  }

  _resetFilter() {
    const btn = document.getElementById('filter-favorites-btn');
    const list = document.getElementById('track-list');
    if (btn) { btn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏'; btn.classList.remove('filtered'); }
    if (list) list.classList.remove('filtered');
  }

  async _loadRegular(key) {
    const info = window.albumsIndex.find(a => a.key === key);
    if (!info) throw new Error(`Album ${key} not found`);

    let data = this.albumsData.get(key);
    if (!data) {
      const base = info.base.endsWith('/') ? info.base : `${info.base}/`;
      const res = await fetch(`${base}config.json`, { cache: 'no-cache' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const raw = await res.json();
      const tracks = (raw.tracks || []).map((t, i) => ({
        num: i + 1,
        title: t.title || `–¢—Ä–µ–∫ ${i + 1}`,
        file: t.audio ? new URL(t.audio, base).toString() : null,
        lyrics: t.lyrics ? new URL(t.lyrics, base).toString() : (t.lrc ? new URL(t.lrc, base).toString() : null),
        fulltext: t.fulltext ? new URL(t.fulltext, base).toString() : null,
        uid: t.uid?.trim() || null,
        size: t.size ?? null,
        hasLyrics: typeof t.hasLyrics === 'boolean' ? t.hasLyrics : !!(t.lyrics || t.lrc)
      }));

      data = {
        title: raw.albumName || info.title,
        artist: raw.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        cover: raw.cover || 'cover.jpg',
        social_links: raw.social_links || raw.socials?.map(s => ({ label: s.title, url: s.url })) || [],
        tracks
      };
      this.albumsData.set(key, data);
    }

    await this._loadGallery(key);
    try {
      const cover = await window.GalleryManager?.getFirstCoverUrl?.(key);
      this.albumCoverUrlCache.set(key, cover || 'img/logo.png');
    } catch { this.albumCoverUrlCache.set(key, 'img/logo.png'); }

    this._renderTitle(data.title || info.title);
    this._renderSocials(data.social_links);
    this._renderTracks(data.tracks, info);

    window.PlayerUI?.updateMiniHeader?.();
    window.PlayerUI?.updateNextUpLabel?.();

    const wrap = document.getElementById('cover-wrap');
    if (wrap) wrap.style.display = '';
  }

  async _loadGallery(key) {
    await window.GalleryManager?.loadGallery?.(key);
  }

  async _loadFavorites() {
    this._renderTitle('‚≠ê‚≠ê‚≠ê –ò–ó–ë–†–ê–ù–ù–û–ï ‚≠ê‚≠ê‚≠ê', 'fav');
    document.getElementById('cover-wrap')?.style && (document.getElementById('cover-wrap').style.display = 'none');

    await window.buildFavoritesRefsModel?.();
    const model = window.favoritesRefsModel || [];
    const container = document.getElementById('track-list');
    if (!container) return;

    if (!model.length) {
      container.innerHTML = `<div style="padding:20px;text-align:center;color:#8ab8fd"><h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏</h3><p>–û—Ç–º–µ—Ç—å—Ç–µ —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π ‚≠ê</p></div>`;
      return;
    }

    container.innerHTML = '';
    model.forEach((item, i) => {
      const el = document.createElement('div');
      el.className = 'track' + (item.__active ? '' : ' inactive');
      el.id = `fav_${item.__a}_${item.__uid}`;
      el.dataset.index = i;
      el.dataset.album = item.__a;
      el.dataset.uid = item.__uid;

      el.innerHTML = `
        <div class="tnum">${String(i + 1).padStart(2, '0')}.</div>
        <div class="track-title" title="${item.title} - ${item.__album}">
          <span class="fav-track-name">${item.title}</span>
          <span class="fav-album-name"> ‚Äî ${item.__album}</span>
        </div>
        <img src="${item.__active ? 'img/star.png' : 'img/star2.png'}" class="like-star" alt="‚òÖ" data-album="${item.__a}" data-uid="${item.__uid}">
      `;

      el.addEventListener('click', async (e) => {
        if (e.target.classList.contains('like-star')) return;
        if (item.__active && item.audio) {
          await this.ensureFavoritesPlayback(i);
        } else {
          window.FavoritesData?.showFavoritesInactiveModal?.({
            albumKey: item.__a, uid: item.__uid, title: item.title,
            onDeleted: () => window.PlayerUI?.updateAvailableTracksForPlayback?.()
          });
        }
      });

      el.querySelector('.like-star')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const wasActive = item.__active;
        window.FavoritesManager?.toggleLike?.(item.__a, item.__uid, !wasActive);
        if (!wasActive) window.FavoritesData?.ensureFavoritesRefsWithLikes?.();

        item.__active = !wasActive;
        if (!item.__active) { item.audio = null; item.lyrics = null; }
        el.classList.toggle('inactive', !item.__active);
        el.querySelector('.like-star').src = item.__active ? 'img/star.png' : 'img/star2.png';

        window.PlayerUI?.updateAvailableTracksForPlayback?.();
        if (window.playerCore && this.playingAlbum === '__favorites__' && window.playerCore.getIndex() === i && wasActive && !item.__active) {
          window.playerCore.next();
        }
      });

      container.appendChild(el);
    });
  }

  async ensureFavoritesPlayback(index) {
    const model = window.favoritesRefsModel || [];
    const active = model.filter(it => it?.__active && it.audio);
    if (!active.length) { window.NotificationSystem?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤'); return; }

    const clicked = model[index];
    let start = 0;
    if (clicked?.__active && clicked.audio) {
      const idx = active.findIndex(it => it.__uid === clicked.__uid && it.__a === clicked.__a);
      start = idx >= 0 ? idx : 0;
    }

    const tracks = active.map(it => ({
      src: it.audio, title: it.title, artist: it.__artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      album: '__favorites__', cover: it.__cover || 'img/logo.png',
      lyrics: it.lyrics, fulltext: it.fulltext, uid: it.__uid, sourceAlbum: it.__a
    }));

    window.playerCore?.setPlaylist(tracks, start, { artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞', album: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', cover: 'img/logo.png' });
    window.playerCore?.play(start);
    this.playingAlbum = '__favorites__';
    this.highlightCurrentTrack(index);
    window.PlayerUI?.ensurePlayerBlock?.(index);
    window.PlayerUI?.updateAvailableTracksForPlayback?.();
  }

  async _loadNews() {
    this._renderTitle('üì∞ –ù–û–í–û–°–¢–ò üì∞', 'news');
    await this._loadGallery('__reliz__');
    document.getElementById('cover-wrap')?.style && (document.getElementById('cover-wrap').style.display = '');

    const container = document.getElementById('track-list');
    if (!container) return;

    container.innerHTML = `
      <div style="padding:14px 10px;text-align:center;color:#8ab8fd">
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:12px">
          <a href="https://t.me/vitrina_razbita" target="_blank" style="color:#4daaff;text-decoration:underline">Telegram</a>
          <span style="opacity:.6">¬∑</span>
          <a href="./news.html" target="_blank" style="color:#4daaff;text-decoration:underline">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</a>
        </div>
        <div id="news-inline-status" style="opacity:.85">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div id="news-inline-list" style="display:grid;gap:12px;padding:0 0 10px"></div>
    `;

    try {
      const r = await fetch('./news/news.json', { cache: 'no-cache' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const items = (await r.json())?.items || [];

      const status = document.getElementById('news-inline-status');
      const list = document.getElementById('news-inline-list');
      if (!list) return;

      if (!items.length) { if (status) status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç'; return; }
      if (status) status.style.display = 'none';

      const esc = s => String(s || '').replace(/[<>&'"]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&#39;','"':'&quot;'}[m]));
      list.innerHTML = items.map(it => {
        let media = '';
        if (it.embedUrl) media = `<div style="margin:10px 0"><iframe loading="lazy" style="width:100%;border:0;border-radius:10px;min-height:220px;background:#0b0e15" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`;
        else if (it.image) media = `<div style="margin:10px 0"><img loading="lazy" style="width:100%;border:0;border-radius:10px" src="${esc(it.image)}" alt=""></div>`;
        else if (it.video) media = `<div style="margin:10px 0"><video controls preload="metadata" style="width:100%;border:0;border-radius:10px;min-height:220px" src="${esc(it.video)}"></video></div>`;

        const tags = (it.tags || []).map(t => `<span style="font-size:12px;color:#4daaff;background:rgba(77,170,255,.12);border:1px solid rgba(77,170,255,.25);padding:4px 8px;border-radius:999px">#${esc(t)}</span>`).join('');

        return `<article style="background:#131a26;border:1px solid #23324a;border-radius:12px;padding:12px;box-shadow:0 4px 16px rgba(0,0,0,.25)">
          <div style="font-weight:900;font-size:16px;color:#eaf2ff">${esc(it.title || '–ù–æ–≤–æ—Å—Ç—å')}</div>
          ${it.date ? `<div style="color:#9db7dd;font-size:13px;margin-top:6px">${esc(it.date)}</div>` : ''}
          ${media}
          ${it.text ? `<div style="margin-top:8px;line-height:1.45;color:#eaf2ff">${esc(it.text)}</div>` : ''}
          ${tags ? `<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">${tags}</div>` : ''}
        </article>`;
      }).join('');
    } catch {
      const status = document.getElementById('news-inline-status');
      if (status) { status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏'; status.style.color = '#ff6b6b'; }
    }
  }

  _renderTitle(title, mod = '') {
    const el = document.getElementById('active-album-title');
    if (el) { el.textContent = title; el.className = 'active-album-title' + (mod ? ` ${mod}` : ''); }
  }

  _renderSocials(links) {
    const container = document.getElementById('social-links');
    if (!container) return;
    container.innerHTML = '';
    (links || []).forEach(l => {
      const a = document.createElement('a');
      a.href = l.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
      a.textContent = l.label || l.title || '–°—Å—ã–ª–∫–∞';
      container.appendChild(a);
    });
  }

  _renderTracks(tracks, info) {
    const container = document.getElementById('track-list');
    if (!container) return;
    container.innerHTML = '';
    tracks.forEach((t, i) => container.appendChild(this._createTrackEl(t, info.key, i)));
  }

  _createTrackEl(track, albumKey, index) {
    const el = document.createElement('div');
    el.className = 'track';
    el.id = `trk${index}`;
    el.dataset.index = index;
    el.dataset.album = albumKey;

    const data = this.albumsData.get(albumKey);
    const playable = data?.tracks?.filter(t => t?.file) || [];
    const playIdx = playable.findIndex(t => t.uid && track.uid && t.uid === track.uid);
    el.dataset.playIndex = playIdx >= 0 ? playIdx : index;

    const isFav = window.FavoritesManager?.isFavorite?.(albumKey, track.uid);

    el.innerHTML = `
      <div class="tnum">${String(track.num || index + 1).padStart(2, '0')}.</div>
      <div class="track-title">${track.title}</div>
      <img src="${isFav ? 'img/star.png' : 'img/star2.png'}" class="like-star" alt="‚òÖ" data-album="${albumKey}" data-uid="${track.uid || ''}">
    `;

    el.addEventListener('click', (e) => {
      if (e.target.classList.contains('like-star')) return;
      const d = this.albumsData.get(albumKey);
      if (!d || !window.playerCore) { window.NotificationSystem?.error('–ê–ª—å–±–æ–º –Ω–µ –≥–æ—Ç–æ–≤'); return; }

      const snap = window.playerCore.getPlaylistSnapshot?.() || [];
      const needNew = snap.length !== d.tracks.length || snap.some((t, i) => t.src !== d.tracks[i]?.file);
      const pIdx = Number(el.dataset.playIndex) || index;

      if (needNew) {
        const cover = this.albumCoverUrlCache.get(albumKey) || 'img/logo.png';
        const list = d.tracks.filter(t => t.file).map(t => ({
          src: t.file, title: t.title, artist: d.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          album: albumKey, cover, lyrics: t.lyrics, fulltext: t.fulltext, uid: t.uid, hasLyrics: t.hasLyrics
        }));
        if (list.length) window.playerCore.setPlaylist(list, pIdx, { artist: d.artist, album: d.title, cover });
      }

      this.highlightCurrentTrack(index);
      window.playerCore.play(pIdx);
      this.playingAlbum = albumKey;
      window.PlayerUI?.ensurePlayerBlock?.(index);
    });

    el.querySelector('.like-star')?.addEventListener('click', (e) => {
      e.stopPropagation();
      const uid = track.uid?.trim();
      if (!uid) { window.NotificationSystem?.warning('UID –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

      const liked = window.FavoritesManager?.isFavorite?.(albumKey, uid);
      window.FavoritesManager?.toggleLike?.(albumKey, uid, !liked);
      e.target.src = !liked ? 'img/star.png' : 'img/star2.png';
      el.classList.toggle('is-favorite', !liked);
    });

    return el;
  }

  highlightCurrentTrack(index) {
    document.querySelectorAll('.track.current').forEach(el => el.classList.remove('current'));
    if (typeof index === 'number' && index >= 0) {
      document.querySelector(`.track[data-index="${index}"]`)?.classList.add('current');
    }
  }

  _updateActiveIcon(key) {
    document.querySelectorAll('.album-icon').forEach(el => el.classList.toggle('active', el.dataset.album === key));
  }

  _clearUI() {
    const list = document.getElementById('track-list');
    const socials = document.getElementById('social-links');
    if (list) list.innerHTML = '';
    if (socials) socials.innerHTML = '';
    window.GalleryManager?.clear?.();
  }

  getCurrentAlbum() { return this.currentAlbum; }
  getPlayingAlbum() { return this.playingAlbum; }
  setPlayingAlbum(key) { this.playingAlbum = key || null; }
  getAlbumData(key) { return this.albumsData.get(key); }
  getAlbumConfigByKey(key) { return this.albumsData.get(key); }
  getTrackUid(_, uid) { return uid?.trim() || null; }
}

window.AlbumsManager = new AlbumsManager();
export default AlbumsManager;

//=================================================
// FILE: /scripts/app/background.js
// scripts/app/background.js
// –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –º–æ–¥—É–ª—å —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏ —Å–æ–±—ã—Ç–∏–π

(function BackgroundModule() {
  'use strict';

  const w = window;

  class BackgroundManager {
    constructor() {
      this.isSupported = 'mediaSession' in navigator;
      this.audioContext = null;
      this.wasPlaying = false;
      this.isOnline = navigator.onLine;
    }

    init() {
      this.setupMediaSession();
      this.setupVisibility();
      this.setupNetwork();
      this.setupIOSAudio();
      this.setupBeforeUnload();
      console.log('‚úÖ Background manager initialized');
    }

    setupMediaSession() {
      if (!this.isSupported) return;
      if (!w.playerCore) {
        setTimeout(() => this.setupMediaSession(), 500);
        return;
      }
      w.playerCore.on({
        onTick: (pos, dur) => {
          try {
            if ('setPositionState' in navigator.mediaSession) {
              navigator.mediaSession.setPositionState({ duration: dur || 0, playbackRate: 1.0, position: pos || 0 });
            }
          } catch {}
        }
      });
    }

    setupVisibility() {
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          this.wasPlaying = w.playerCore?.isPlaying?.() || false;
        }
        // –ü—Ä–∞–≤–∏–ª–æ: –Ω–∏—á—Ç–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –º—É–∑—ã–∫—É
      });
    }

    setupNetwork() {
      const updateBtn = () => {
        const btn = document.getElementById('offline-btn');
        if (btn) {
          btn.className = `offline-btn ${this.isOnline ? 'online' : 'offline'}`;
          btn.textContent = this.isOnline ? 'ONLINE' : 'OFFLINE';
        }
      };
      window.addEventListener('online', () => {
        this.isOnline = true;
        w.NotificationSystem?.success('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        updateBtn();
      });
      window.addEventListener('offline', () => {
        this.isOnline = false;
        w.NotificationSystem?.offline('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
        updateBtn();
      });
    }

    setupIOSAudio() {
      if (!w.Utils?.isIOS?.()) return;
      try {
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const unlock = () => {
          if (this.audioContext.state === 'suspended') this.audioContext.resume();
          document.removeEventListener('touchstart', unlock);
        };
        document.addEventListener('touchstart', unlock);
      } catch {}

      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && this.audioContext?.state === 'suspended') {
          this.audioContext.resume();
        }
      });
    }

    setupBeforeUnload() {
      window.addEventListener('beforeunload', () => {
        w.PlayerState?.save?.();
      });
      window.addEventListener('popstate', (e) => {
        if (e.state?.albumKey) w.AlbumsManager?.loadAlbum(e.state.albumKey);
      });
    }

    getNetworkStatus() { return this.isOnline; }
  }

  const mgr = new BackgroundManager();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => mgr.init());
  } else {
    mgr.init();
  }
  w.BackgroundManager = mgr;
})();

//=================================================
// FILE: /scripts/app/downloads.js
// scripts/app/downloads.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º —Ç—Ä–µ–∫–æ–≤ –∏ –∞–ª—å–±–æ–º–æ–≤

class DownloadsManager {
  constructor() {
    this.downloadQueue = [];
    this.isDownloading = false;
  }

  async downloadAlbum(albumKey) {
    const albumInfo = window.albumsIndex?.find(a => a.key === albumKey);
    if (!albumInfo) {
      console.error('Album not found:', albumKey);
      return;
    }

    const albumData = window.AlbumsManager?.getAlbumData(albumKey);
    if (!albumData) {
      window.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–ª—å–±–æ–º–∞');
      return;
    }

    window.NotificationSystem?.info(`–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é: ${albumInfo.title}`);

    // track.file —É–∂–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π URL (AlbumsManager –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —á–µ—Ä–µ–∑ new URL(...))
    const files = (albumData.tracks || [])
      .filter(t => !!t && typeof t.file === 'string' && t.file.length > 0)
      .map(track => ({
        url: track.file,
        filename: `${albumInfo.title} - ${track.num}. ${track.title}.mp3`
      }));

    // ‚úÖ –û–±–ª–æ–∂–∫–∞: –±–µ—Ä—ë–º –ü–ï–†–í–£–Æ –∫–∞—Ä—Ç–∏–Ω–∫—É —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏ (–∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º).
    try {
      const coverUrl = await window.GalleryManager?.getFirstCoverUrl?.(albumKey);
      if (coverUrl && typeof coverUrl === 'string' && coverUrl !== 'img/logo.png') {
        const extMatch = coverUrl.split('?')[0].match(/\.([a-z0-9]+)$/i);
        const ext = extMatch ? extMatch[1].toLowerCase() : 'img';
        files.push({
          url: coverUrl,
          filename: `${albumInfo.title} - cover.${ext}`
        });
      }
    } catch {}

    this.downloadFiles(files, albumInfo.title);
  }

  async downloadFiles(files, albumTitle) {
    if (!files || files.length === 0) return;

    if (!this.isDownloadSupported()) {
      this.fallbackDownload(files);
      return;
    }

    window.NotificationSystem?.info(`–°–∫–∞—á–∏–≤–∞–Ω–∏–µ ${files.length} —Ñ–∞–π–ª–æ–≤...`);
    let completed = 0;

    for (const file of files) {
      try {
        await this.downloadFile(file.url, file.filename);
        completed++;
        window.NotificationSystem?.info(`–°–∫–∞—á–∞–Ω–æ ${completed} –∏–∑ ${files.length}`, 2000);
        await this.delay(500);
      } catch (error) {
        console.error('Download failed:', file.filename, error);
      }
    }

    window.NotificationSystem?.success(`‚úÖ –ê–ª—å–±–æ–º "${albumTitle}" —Å–∫–∞—á–∞–Ω!`);
  }

  async downloadFile(url, filename) {
    return new Promise((resolve, reject) => {
      if (!navigator.onLine) {
        reject(new Error('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É'));
        return;
      }

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);

      fetch(url, { signal: controller.signal })
        .then(response => {
          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          return response.blob();
        })
        .then(blob => {
          if (blob.size === 0) {
            throw new Error('–§–∞–π–ª –ø—É—Å—Ç–æ–π (0 –±–∞–π—Ç)');
          }

          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = this.sanitizeFilename(filename);
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          setTimeout(() => URL.revokeObjectURL(link.href), 250);

          console.log(`‚úÖ Downloaded: ${filename} (${(blob.size / 1024 / 1024).toFixed(2)} MB)`);
          resolve();
        })
        .catch(error => {
          clearTimeout(timeoutId);

          if (error && error.name === 'AbortError') {
            reject(new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è'));
          } else {
            reject(error);
          }
        });
    });
  }

  sanitizeFilename(filename) {
    return String(filename || 'file').replace(/[<>:"/\\|?*]/g, '_');
  }

  isDownloadSupported() {
    const a = document.createElement('a');
    return typeof a.download !== 'undefined';
  }

  fallbackDownload(files) {
    window.NotificationSystem?.info('–û—Ç–∫—Ä–æ—é—Ç—Å—è –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
    files.forEach((file, index) => {
      setTimeout(() => {
        window.open(file.url, '_blank');
      }, index * 300);
    });
  }

  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

window.DownloadsManager = new DownloadsManager();
export default DownloadsManager;

//=================================================
// FILE: /scripts/app/gallery.js
// scripts/app/gallery.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–µ–π –æ–±–ª–æ–∂–µ–∫

class GalleryManager {
  constructor() {
    this.items = [];
    this.currentIndex = 0;
    this.autoplayInterval = null;
    this.isAutoplayEnabled = false;
    this.transitionLock = false;
    
    this.prefetchedUrls = new Set();
    this.imageLoader = null;
    
    this.ALBUM_GALLERY_MAP = {
      'krevetochka': '00',
      'mezhdu-zlom-i-dobrom': '01',
      'golos-dushi': '02',
      'odnazhdy-v-skazke': '03',
      '__reliz__': 'news'
    };
    
    this.ALLOWED_IDS = new Set(['00', '01', '02', '03', 'news']);
    this.GALLERY_BASE = './albums/gallery/';
  }

  initialize() {
    this.setupNavigation();
    this.setupSwipeGestures();
    this.setupVisibilityHandler();
    console.log('‚úÖ GalleryManager initialized');
  }

  getCentralId(albumKey) {
    if (!albumKey || albumKey === '__favorites__') return null;
    const id = this.ALBUM_GALLERY_MAP[albumKey];
    return (id && this.ALLOWED_IDS.has(id)) ? id : null;
  }

  async loadGallery(albumKey) {
    const id = this.getCentralId(albumKey);
    
    if (!id) {
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
      return;
    }

    // ‚úÖ –ö—ç—à–∏—Ä—É–µ–º 404 –¥–ª—è –≥–∞–ª–µ—Ä–µ–π —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    const gallery404Key = `gallery_404_cache:v1`;
    let gallery404Cache = {};
    try {
      const raw = sessionStorage.getItem(gallery404Key);
      gallery404Cache = raw ? JSON.parse(raw) : {};
    } catch {}

    if (gallery404Cache[id]) {
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
      return;
    }

    try {
      const baseDir = `${this.GALLERY_BASE}${id}/`;
      const response = await fetch(`${baseDir}index.json`, { cache: 'force-cache' });
      
      if (!response.ok) {
        // ‚úÖ –ö—ç—à–∏—Ä—É–µ–º 404
        if (response.status === 404) {
          gallery404Cache[id] = Date.now();
          try { sessionStorage.setItem(gallery404Key, JSON.stringify(gallery404Cache)); } catch {}
        }
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      const rawItems = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);

      this.items = rawItems
        .map(item => this.normalizeItem(item, baseDir))
        .filter(Boolean);

      this.currentIndex = 0;
      
      if (this.items.length > 0) {
        this.renderItem(0);
        this.updateNavigationState();
        this.startAutoplay();
      }

      console.log(`‚úÖ Gallery loaded: ${this.items.length} items`);
    } catch (error) {
      // ‚úÖ –¢–∏—Ö–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏ (–Ω–µ –∑–∞—Å–æ—Ä—è–µ–º –∫–æ–Ω—Å–æ–ª—å)
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º logo.png –∫–∞–∫ fallback
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
    }
  }

  normalizeItem(raw, baseDir) {
    if (!raw) return null;
    const toAbs = (p) => {
      if (!p) return null;
      const s = String(p).replace(/^\.?\//, '');
      return /^https?:\/\//i.test(s) ? s : /^(albums|img|icons|assets)\//i.test(s) ? `./${s}` : baseDir + s;
    };
    if (typeof raw === 'string') return { type: /\.html(\?|#|$)/i.test(raw) ? 'html' : 'img', src: toAbs(raw), formats: null };
    const type = raw.type?.toLowerCase() === 'html' ? 'html' : 'img';
    if (type === 'html') return { type: 'html', src: toAbs(raw.src || ''), formats: null };
    const formats = { webp: toAbs(raw.formats?.webp), full: toAbs(raw.formats?.full || raw.src), thumb: toAbs(raw.formats?.thumb) };
    return { type: 'img', src: formats.full || toAbs(raw.src), formats };
  }

  renderItem(index) {
    if (this.transitionLock) return;
    if (!this.items.length) return;

    this.transitionLock = true;
    this.currentIndex = (index + this.items.length) % this.items.length;

    const item = this.items[this.currentIndex];
    const slot = document.getElementById('cover-slot');
    
    if (!slot || !item) {
      this.transitionLock = false;
      return;
    }

    if (this.imageLoader) {
      this.imageLoader.onload = null;
      this.imageLoader.onerror = null;
      this.imageLoader = null;
    }

    if (item.type === 'html') {
      this.renderHtml(slot, item.src);
    } else {
      this.renderImage(slot, item);
    }

    setTimeout(() => {
      this.prefetchNext();
      this.transitionLock = false;
    }, 200);
  }

  renderHtml(slot, src) {
    const iframe = document.createElement('iframe');
    
    // ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ html-–±–∞–Ω–Ω–µ—Ä—ã (albums/gallery/...) –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ.
    // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞) –Ω—É–∂–µ–Ω allow-same-origin.
    // ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º security-–æ—à–∏–±–∫–∏ –æ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –±–∞–Ω–Ω–µ—Ä–∞:
    // –Ω–µ –¥–∞—ë–º outer-iframe same-origin.
    iframe.setAttribute('sandbox', 'allow-scripts allow-popups allow-forms');
    iframe.setAttribute('referrerpolicy', 'no-referrer');
    iframe.loading = 'lazy';
    iframe.src = src;

    this.clearSlot(slot);
    slot.appendChild(iframe);
  }

  renderImage(slot, item) {
    const img = new Image();
    this.imageLoader = img;

    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';

    const src = item.formats?.webp || item.formats?.full || item.src;

    img.onload = () => {
      if (this.imageLoader !== img) return;

      const picture = document.createElement('picture');

      if (item.formats?.webp) {
        const source = document.createElement('source');
        source.type = 'image/webp';
        source.srcset = item.formats.webp;
        picture.appendChild(source);
      }

      const displayImg = document.createElement('img');
      displayImg.src = src;
      displayImg.alt = '–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞';
      displayImg.decoding = 'async';
      displayImg.referrerPolicy = 'no-referrer';
      displayImg.style.cssText = 'opacity: 0; transition: opacity .15s ease-out';

      picture.appendChild(displayImg);

      this.clearSlot(slot);
      slot.appendChild(picture);

      requestAnimationFrame(() => {
        displayImg.style.opacity = '1';
      });
    };

    img.onerror = () => console.warn('Failed to load image:', src);
    img.src = src;
  }

  clearSlot(slot) {
    while (slot.firstChild) {
      if (slot.firstChild.tagName === 'IFRAME') {
        slot.firstChild.src = 'about:blank';
      }
      slot.removeChild(slot.firstChild);
    }
  }

  prefetchNext() {
    if (this.items.length < 2) return;

    const nextIndex = (this.currentIndex + 1) % this.items.length;
    const item = this.items[nextIndex];

    if (!item || item.type !== 'img') return;

    const webp = item.formats?.webp || null;

    if (this.prefetchedUrls.size > 20) this.prefetchedUrls.clear();

    if (webp && !this.prefetchedUrls.has(webp)) {
      const img = new Image();
      img.src = webp;
      this.prefetchedUrls.add(webp);
    }
  }

  setupNavigation() {
    const leftBtn = document.getElementById('cover-gallery-arrow-left');
    const rightBtn = document.getElementById('cover-gallery-arrow-right');

    leftBtn?.addEventListener('click', () => {
      if (!this.items.length) return;
      this.renderItem(this.currentIndex - 1);
      this.restartAutoplay();
    });

    rightBtn?.addEventListener('click', () => {
      if (!this.items.length) return;
      this.renderItem(this.currentIndex + 1);
      this.restartAutoplay();
    });
  }

  setupSwipeGestures() {
    const wrap = document.getElementById('cover-wrap');
    if (!wrap) return;

    let startX = null;

    wrap.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
    }, { passive: true });

    wrap.addEventListener('touchend', (e) => {
      if (startX === null) return;

      const dx = e.changedTouches[0].clientX - startX;

      if (Math.abs(dx) > 50) {
        if (dx > 0) {
          this.renderItem(this.currentIndex - 1);
        } else {
          this.renderItem(this.currentIndex + 1);
        }
        this.restartAutoplay();
      }

      startX = null;
    }, { passive: true });
  }

  setupVisibilityHandler() {
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // ‚úÖ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≥–∞–ª–µ—Ä–µ—é (–ø–ª–µ–µ—Ä –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
        this.stopAutoplay();
      } else {
        // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –∫—Ä—É—Ç–∏—Ç—å
        if (this.items.length > 1) {
          this.startAutoplay();
        }
      }
    });
  }

  updateNavigationState() {
    const wrap = document.getElementById('cover-wrap');
    if (!wrap) return;

    if (this.items.length > 1) {
      wrap.classList.add('gallery-nav-ready');
    } else {
      wrap.classList.remove('gallery-nav-ready');
    }
  }

  startAutoplay() {
    if (this.items.length <= 1) return;
    if (this.autoplayInterval) return;

    this.autoplayInterval = setInterval(() => {
      this.renderItem(this.currentIndex + 1);
    }, 5000);

    this.isAutoplayEnabled = true;
  }

  stopAutoplay() {
    if (this.autoplayInterval) {
      clearInterval(this.autoplayInterval);
      this.autoplayInterval = null;
    }
    this.isAutoplayEnabled = false;
  }

  restartAutoplay() {
    this.stopAutoplay();
    this.startAutoplay();
  }

  clear() {
    this.stopAutoplay();
    this.items = [];
    this.currentIndex = 0;
    this.prefetchedUrls.clear();
    
    if (this.imageLoader) {
      this.imageLoader.onload = null;
      this.imageLoader.onerror = null;
      this.imageLoader = null;
    }

    const slot = document.getElementById('cover-slot');
    if (slot) this.clearSlot(slot);

    this.updateNavigationState();
  }

  getItemsCount() {
    return this.items.length;
  }

  getCurrentIndex() {
    return this.currentIndex;
  }

  /**
   * ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –ø–µ—Ä–≤–æ–π –æ–±–ª–æ–∂–∫–∏ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏ –¥–ª—è albumKey
   * (webp –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ), –ª–∏–±–æ img/logo.png.
   * –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
   */
  async getFirstCoverUrl(albumKey) {
    const id = this.getCentralId(albumKey);
    if (!id) return 'img/logo.png';

    const baseDir = `${this.GALLERY_BASE}${id}/`;

    try {
      const response = await fetch(`${baseDir}index.json`, { cache: 'force-cache' });
      if (!response.ok) return 'img/logo.png';

      const data = await response.json();
      const rawItems = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
      const first = rawItems && rawItems.length ? rawItems[0] : null;
      if (!first) return 'img/logo.png';

      const norm = this.normalizeItem(first, baseDir);
      if (!norm || norm.type !== 'img') return 'img/logo.png';

      return norm.formats?.webp || norm.formats?.full || norm.src || 'img/logo.png';
    } catch {
      return 'img/logo.png';
    }
  }
}

window.GalleryManager = new GalleryManager();

export default GalleryManager;

//=================================================
// FILE: /scripts/app/playback-policy.js
// scripts/app/playback-policy.js
// –ï–¥–∏–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏/—Ä–µ–∂–∏–º–æ–≤ (favoritesOnly + shuffle) –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–µ–µ—Ä–∞.

(function PlaybackPolicyModule() {
  'use strict';

  const w = window;

  function isSpecialAlbumKey(key) {
    return !!key && String(key).startsWith('__');
  }

  function getPlayingAlbumKey() {
    return w.AlbumsManager?.getPlayingAlbum?.() || null;
  }

  function getLikedUidsForPlayingAlbum() {
    const playingAlbum = getPlayingAlbumKey();
    if (!playingAlbum) return [];
    if (playingAlbum === w.SPECIAL_FAVORITES_KEY) return [];
    if (isSpecialAlbumKey(playingAlbum)) return [];

    const uids = w.FavoritesManager?.getLikedUidsForAlbum?.(playingAlbum) || [];
    return Array.isArray(uids) ? uids.map(x => String(x || '').trim()).filter(Boolean) : [];
  }

  function getOriginalPlaylistSnapshot() {
    const pc = w.playerCore;
    const original = pc?.originalPlaylist || [];
    return Array.isArray(original) ? original.slice() : [];
  }

  function getCurrentSnapshot() {
    const pc = w.playerCore;
    const snap = pc?.getPlaylistSnapshot?.() || [];
    return Array.isArray(snap) ? snap.slice() : [];
  }

  function buildFavoritesOnlyPlaylistFromOriginal(original, likedUids) {
    if (!Array.isArray(original) || original.length === 0) return [];
    if (!Array.isArray(likedUids) || likedUids.length === 0) return [];

    const set = new Set(likedUids);
    return original.filter(t => {
      const uid = String(t?.uid || '').trim();
      return uid && set.has(uid);
    });
  }

  function findTrackIndexBySrc(list, src) {
    if (!Array.isArray(list) || !src) return -1;
    return list.findIndex(t => t && t.src === src);
  }

  function setFavoritesOnlyModeUI(enabled) {
    // UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∫–Ω–æ–ø–∫–∞ –≤ –ø–ª–µ–µ—Ä–µ)
    const btn = document.getElementById('favorites-btn');
    const icon = document.getElementById('favorites-btn-icon');
    if (!btn || !icon) return;

    btn.classList.toggle('favorites-active', !!enabled);
    icon.src = enabled ? 'img/star.png' : 'img/star2.png';

    try {
      localStorage.setItem('favoritesOnlyMode', enabled ? '1' : '0');
    } catch {}
  }

  function ensureAvailableIndicesForPlayback() {
    // –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É window.availableFavoriteIndices –∫–∞–∫ ‚Äú–º—è–≥–∫–∏–π‚Äù fallback,
    // –Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º —Ç–µ–ø–µ—Ä—å ‚Äî –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ —á–µ—Ä–µ–∑ setPlaylist.
    try {
      if (w.PlayerUI && typeof w.PlayerUI.updateAvailableTracksForPlayback === 'function') {
        w.PlayerUI.updateAvailableTracksForPlayback();
      }
    } catch {}
  }

  /**
   * –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –æ—á–µ—Ä–µ–¥–∏ –∫ —Ç–µ–∫—É—â–µ–º—É playingAlbum (–ù–ï –∫ currentAlbum).
   * opts:
   * - reason: 'toggle' | 'favoritesChanged' | 'init'
   * - changed: { albumKey, uid, liked }
   */
  function apply(opts = {}) {
    const pc = w.playerCore;
    if (!pc) return;

    const playingAlbum = getPlayingAlbumKey();
    if (!playingAlbum) return;

    // –í __favorites__ –ø–ª–µ–π–ª–∏—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ AlbumsManager.ensureFavoritesPlayback.
    if (playingAlbum === w.SPECIAL_FAVORITES_KEY) {
      ensureAvailableIndicesForPlayback();
      return;
    }

    // –î–ª—è —Å–ø–µ—Ü-—Ä–∞–∑–¥–µ–ª–æ–≤ (–Ω–æ–≤–æ—Å—Ç–∏) –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É.
    if (isSpecialAlbumKey(playingAlbum)) {
      ensureAvailableIndicesForPlayback();
      return;
    }

    const favoritesOnlyEnabled = (localStorage.getItem('favoritesOnlyMode') === '1');

    if (!favoritesOnlyEnabled) {
      // –†–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º.
      ensureAvailableIndicesForPlayback();
      return;
    }

    const likedUids = getLikedUidsForPlayingAlbum();

    // ‚úÖ 6.5: –µ—Å–ª–∏ –ª–∞–π–∫–æ–≤ 0 ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç
    if (likedUids.length === 0) {
      setFavoritesOnlyModeUI(false);
      w.NotificationSystem?.info('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
      ensureAvailableIndicesForPlayback();
      return;
    }

    const original = getOriginalPlaylistSnapshot();
    const current = getCurrentSnapshot();

    const currentTrack = pc.getCurrentTrack?.();
    const currentSrc = currentTrack?.src || null;

    const targetFavoritesPlaylist = buildFavoritesOnlyPlaylistFromOriginal(original, likedUids);

    if (targetFavoritesPlaylist.length === 0) {
      // –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ, –µ—Å–ª–∏ uid –Ω–µ —Å–æ–≤–ø–∞–ª–∏ —Å originalPlaylist
      setFavoritesOnlyModeUI(false);
      w.NotificationSystem?.info('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
      ensureAvailableIndicesForPlayback();
      return;
    }

    const isShuffle = !!pc.isShuffle?.();

    // ‚úÖ –ï—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω, –∏ –ø—Ä–∏—à—ë–ª –ª–∞–π–∫ –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏
    // (6.2) –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ reshuffle.
    if (isShuffle && opts?.reason === 'favoritesChanged') {
      const d = opts?.changed || {};
      const changedAlbum = String(d.albumKey || '').trim();
      const changedUid = String(d.uid || '').trim();
      const liked = !!d.liked;

      // ‚úÖ Like: –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ö–≤–æ—Å—Ç
      if (liked && changedAlbum === playingAlbum && changedUid) {
        const inCurrent = current.some(t => String(t?.uid || '').trim() === changedUid);
        if (!inCurrent) {
          const add = targetFavoritesPlaylist.find(t => String(t?.uid || '').trim() === changedUid) || null;
          if (add) {
            pc.appendToPlaylistTail?.([add]);
            ensureAvailableIndicesForPlayback();
            return;
          }
        }
      }

      // ‚úÖ Unlike –ù–ï —Ç–µ–∫—É—â–µ–≥–æ: —É–±—Ä–∞—Ç—å –∏–∑ —Ö–≤–æ—Å—Ç–∞ –æ—á–µ—Ä–µ–¥–∏, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –ø—Ä–æ–∏–≥—Ä–∞–Ω (—É–º–Ω—ã–π —Ä–µ–∂–∏–º)
      if (!liked && changedAlbum === playingAlbum && changedUid) {
        const repeat = !!pc.isRepeat?.();
        if (!repeat) {
          const removed = pc.removeFromPlaylistTailIfNotPlayed?.({ uid: changedUid });
          if (removed) {
            ensureAvailableIndicesForPlayback();
            return;
          }
        }
      }
    }

    // –ï—Å–ª–∏ –º—ã —É–∂–µ –≤ favorites-only –ø–ª–µ–π–ª–∏—Å—Ç–µ (–ø–æ —Å–æ—Å—Ç–∞–≤—É) ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –Ω–∞ ‚Äúunlike current‚Äù
    // –∏ –ø—Ä–∏–º–µ–Ω–∏–º 6.1: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–æ—Å—Ç—É–ø–Ω–æ–º—É.
    // ‚úÖ 6.3: –µ—Å–ª–∏ repeat –≤–∫–ª—é—á—ë–Ω ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–≤—Ç–æ—Ä—è—Ç—å.
    const repeat = !!pc.isRepeat?.();

    if (!repeat && opts?.reason === 'favoritesChanged' && currentSrc) {
      const d = opts?.changed || {};
      const changedAlbum = String(d.albumKey || '').trim();
      const changedUid = String(d.uid || '').trim();
      const liked = !!d.liked;

      if (!liked && changedAlbum === playingAlbum && changedUid) {
        const stillLiked = likedUids.includes(changedUid);
        if (!stillLiked) {
          // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–ª–∞–π–∫–∞–ª–∏ ‚Äî next().
          const curUid = String(currentTrack?.uid || '').trim();
          if (curUid && curUid === changedUid) {
            // –ü–µ—Ä–µ–¥ next() —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞—à –ø–ª–µ–π–ª–∏—Å—Ç –∞–∫—Ç—É–∞–ª–µ–Ω –∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –∏—Å–∫–ª—é—á—ë–Ω.
            // –ú—ã –ù–ï —Å—Ç–æ–ø–∞–µ–º ‚Äî –ø—Ä–æ—Å—Ç–æ ‚Äú–ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è‚Äù.
            const filtered = targetFavoritesPlaylist.filter(t => String(t?.uid || '').trim() !== changedUid);
            if (filtered.length === 0) {
              setFavoritesOnlyModeUI(false);
              w.NotificationSystem?.info('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
              ensureAvailableIndicesForPlayback();
              return;
            }

            // –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç –±–µ–∑ —Ç–µ–∫—É—â–µ–≥–æ, —Å–æ—Ö—Ä–∞–Ω—è—è shuffleMode (–µ—Å–ª–∏ –æ–Ω –±—ã–ª) –∏ originalPlaylist.
            pc.setPlaylist(filtered, 0, {}, {
              preserveOriginalPlaylist: true,
              preserveShuffleMode: true,
              resetHistory: false
            });

            // next() –≤ —Ä–∞–º–∫–∞—Ö –Ω–æ–≤–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞.
            pc.next();
            ensureAvailableIndicesForPlayback();
            return;
          }
        }
      }
    }

    // –ë–∞–∑–æ–≤—ã–π —Å–ª—É—á–∞–π: –ø—Ä–∏–≤–µ—Å—Ç–∏ —Ç–µ–∫—É—â–∏–π –ø–ª–µ–π–ª–∏—Å—Ç –∫ favorites-only (–∏–∑ original).
    // –°—Ç–∞—Ä—Ç: –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –µ—Å—Ç—å –≤ target ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –Ω–µ–≥–æ, –∏–Ω–∞—á–µ —Å 0.
    let startIndex = 0;
    if (currentSrc) {
      const idx = findTrackIndexBySrc(targetFavoritesPlaylist, currentSrc);
      startIndex = idx >= 0 ? idx : 0;
    }

    pc.setPlaylist(targetFavoritesPlaylist, startIndex, {}, {
      preserveOriginalPlaylist: true,
      preserveShuffleMode: true,
      resetHistory: false
    });

    // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º play() –∑–¥–µ—Å—å: setPlaylist —É–∂–µ ‚Äú–º—è–≥–∫–æ‚Äù —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
    ensureAvailableIndicesForPlayback();
  }

  w.PlaybackPolicy = {
    apply
  };
})();

//=================================================
// FILE: /scripts/app/player-ui.js
// scripts/app/player-ui.js ‚Äî UI –ø–ª–µ–µ—Ä–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
(function PlayerUIModule() {
  'use strict';
  const w = window;
  const $ = (id) => document.getElementById(id);
  const $q = (sel) => document.querySelector(sel);
  const $qa = (sel) => document.querySelectorAll(sel);

  let currentLyrics = [], lyricsViewMode = 'normal', hasTimedLyrics = false;
  let isSeekingProgress = false, isMuted = false, animationEnabled = false;
  let bitEnabled = false, bitIntensity = 100;
  let favoritesFilterActive = false, favoritesOnlyMode = false;
  let audioContext = null, analyser = null, animationFrame = null;
  let lyricsLastIdx = -1, lyricsLastTs = 0;
  let isInContextMiniMode = false, savedLyricsMode = null, savedAnimation = null;
  const LYRICS_404_KEY = 'lyrics_404_cache:v1';
  let prefetchedLyrics = null, prefetchedLyricsUrl = null;

  function initPlayerUI() {
    if (w.__playerUIInitialized) return;
    if (!w.albumsIndex?.length) { setTimeout(initPlayerUI, 100); return; }
    w.__playerUIInitialized = true;

    restoreSettings();
    attachPlayerCoreEvents();
    bindGlobalEvents();
    console.log('‚úÖ PlayerUI initialized');
  }

  function bindGlobalEvents() {
    if (!w.__favoritesChangedBound) {
      w.__favoritesChangedBound = true;
      w.addEventListener('favorites:changed', (e) => {
        updateMiniHeader();
        updateNextUpLabel();
        w.PlaybackPolicy?.apply?.({ reason: 'favoritesChanged', changed: e?.detail || {} });
        updateAvailableTracksForPlayback();
      });
    }

    const filterBtn = $('filter-favorites-btn');
    if (filterBtn && !filterBtn.__bound) {
      filterBtn.__bound = true;
      filterBtn.addEventListener('click', toggleFavoritesFilter);
    }
  }

  function attachPlayerCoreEvents() {
    if (!w.playerCore) { setTimeout(attachPlayerCoreEvents, 100); return; }
    w.playerCore.on({
      onTrackChange: onTrackChange,
      onPlay: updatePlayPauseIcon,
      onPause: updatePlayPauseIcon,
      onStop: updatePlayPauseIcon,
      onTick: (pos, dur) => { updateProgress(pos, dur); renderLyricsEnhanced(pos); }
    });
  }

  function onTrackChange(track, index) {
    if (!track) return;
    w.AlbumsManager?.highlightCurrentTrack?.(index);
    ensurePlayerBlock(index);

    const has = !!(track.hasLyrics !== false && (track.hasLyrics || track.lyrics));
    if (!has) { hasTimedLyrics = false; setLyricsAvailability(false); }

    loadLyrics(track.lyrics).then(() => {
      if (hasTimedLyrics && lyricsViewMode !== 'hidden') renderLyrics(0);
    });

    const karaokeBtn = $('lyrics-text-btn');
    if (karaokeBtn && !track.fulltext) {
      karaokeBtn.classList.add('disabled');
      karaokeBtn.style.pointerEvents = 'none';
    }

    const dlBtn = $('track-download-btn');
    if (dlBtn && track.src) {
      dlBtn.href = track.src;
      dlBtn.download = `${track.title}.mp3`;
    }
  }

  function isBrowsingOther() {
    const playing = w.AlbumsManager?.getPlayingAlbum?.();
    const current = w.AlbumsManager?.getCurrentAlbum?.();
    return playing && playing !== current && !(playing === '__favorites__' && current === '__favorites__');
  }

  let ensureTimeout = null;
  function ensurePlayerBlock(idx) {
    if (typeof idx !== 'number' || idx < 0 || !Number.isFinite(idx)) return;
    if (ensureTimeout) clearTimeout(ensureTimeout);
    ensureTimeout = setTimeout(() => { ensureTimeout = null; _doEnsure(idx); }, 50);
  }

  function _doEnsure(idx) {
    let block = $('lyricsplayerblock');
    if (!block) block = createPlayerBlock();

    const mini = isBrowsingOther();
    const nowPlaying = $('now-playing');
    const trackList = $('track-list');

    if (mini) {
      if (nowPlaying && !nowPlaying.contains(block)) {
        nowPlaying.innerHTML = '';
        nowPlaying.appendChild(createMiniHeader());
        nowPlaying.appendChild(block);
        nowPlaying.appendChild(createNextUp());
      }
      applyMiniState();
      setDisplay('mini-now', 'flex');
      setDisplay('next-up', 'flex');
      setTimeout(() => nowPlaying?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
    } else {
      if (!trackList) return;
      const row = trackList.querySelector(`.track[data-index="${idx}"]`);
      if (row) {
        if (row.nextSibling !== block) row.parentNode.insertBefore(block, row.nextSibling);
        setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
      } else if (!block.parentNode) {
        trackList.appendChild(block);
      }
      restoreLyricsState();
      setDisplay('mini-now', 'none');
      setDisplay('next-up', 'none');
    }
    updateMiniHeader();
    updateNextUpLabel();
  }

  function setDisplay(id, val) {
    const el = $(id);
    if (el) el.style.display = val;
  }

  function createPlayerBlock() {
    const b = document.createElement('div');
    b.className = 'lyrics-player-block';
    b.id = 'lyricsplayerblock';
    b.innerHTML = PLAYER_HTML;
    bindPlayerEvents(b);
    return b;
  }

  const PLAYER_HTML = `
<div id="lyrics-window" class="lyrics-normal">
  <div class="lyrics-animated-bg"></div>
  <div class="lyrics-scroll" id="lyrics"><div class="lyrics-placeholder lyrics-spinner"></div></div>
</div>
<div class="player-progress-wrapper">
  <div class="player-progress-bar" id="player-progress-bar">
    <div class="player-progress-fill" id="player-progress-fill"><div class="player-progress-handle"></div></div>
  </div>
</div>
<div class="player-controls">
  <div class="player-controls-row">
    <span class="time-in-controls" id="time-elapsed">00:00</span>
    <button class="player-control-btn" id="prev-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π (P)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 5L4 12l7 7V5zm9 0v14l-7-7 7-7z"/></svg></button>
    <button class="player-control-btn main" id="play-pause-btn" title="Play/Pause (K)"><svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
    <button class="player-control-btn" id="stop-btn" title="–°—Ç–æ–ø (X)"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg></button>
    <button class="player-control-btn" id="next-btn" title="–°–ª–µ–¥—É—é—â–∏–π (N)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 5l7 7-7 7V5zM4 5v14l7-7-7-7z"/></svg></button>
    <span class="time-in-controls" id="time-remaining">--:--</span>
  </div>
  <div class="player-controls-row">
    <button class="player-control-btn" id="mute-btn" title="Mute (M)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></button>
    <button class="player-control-btn" id="shuffle-btn" title="Shuffle (U)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17h2.735a4 4 0 003.43-1.942l3.67-6.116A4 4 0 0116.265 7H21m0 0l-3-3m3 3l-3 3"/><path d="M3 7h2.735a4 4 0 013.43 1.942l3.67 6.116A4 4 0 0016.265 17H21m0 0l-3 3m3-3l-3-3"/></svg></button>
    <button class="player-control-btn" id="repeat-btn" title="Repeat (R)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 2l4 4-4 4"/><path d="M3 11V9a4 4 0 014-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v2a4 4 0 01-4 4H3"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg></button>
    <button class="sleep-timer-btn" id="sleep-timer-btn" title="–¢–∞–π–º–µ—Ä —Å–Ω–∞ (T)"><svg viewBox="0 0 24 24" width="24" height="24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none">0</span></button>
    <button class="player-control-btn" id="favorites-btn" title="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (F)"><img src="img/star2.png" alt="‚òÖ" id="favorites-btn-icon" width="20" height="20"/></button>
  </div>
</div>
<div class="volume-control-wrapper">
  <div class="volume-track" id="volume-track"><div class="volume-fill" id="volume-fill"></div><div class="volume-handle" id="volume-handle"></div></div>
  <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100" aria-label="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
</div>
<div class="player-buttons-wrapper">
  <div class="player-extra-buttons-row">
    <button class="lyrics-toggle-btn" id="lyrics-toggle-btn" title="–†–µ–∂–∏–º –ª–∏—Ä–∏–∫–∏ (Y)"><span>–¢</span></button>
    <button class="animation-btn" id="animation-btn" title="–ê–Ω–∏–º–∞—Ü–∏—è (A)">A</button>
    <button class="karaoke-btn" id="lyrics-text-btn" title="–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç">üìù</button>
    <button class="pulse-btn" id="pulse-btn" title="–ü—É–ª—å—Å–∞—Ü–∏—è"><span id="pulse-heart">ü§ç</span></button>
    <a class="player-download-btn" href="#" id="track-download-btn" download title="–°–∫–∞—á–∞—Ç—å">üíæ</a>
    <button id="eco-btn" class="eco-btn" title="–≠–∫–æ–Ω–æ–º —Ä–µ–∂–∏–º"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M13 3L4 14h6l-1 7 9-11h-6l1-7z"/></svg></button>
  </div>
</div>`;

  function createMiniHeader() {
    const h = document.createElement('div');
    h.className = 'mini-now'; h.id = 'mini-now';
    h.innerHTML = `<span class="tnum" id="mini-now-num">--.</span><span class="track-title" id="mini-now-title">‚Äî</span><img src="img/star2.png" class="like-star" id="mini-now-star" alt="‚òÖ">`;
    h.addEventListener('click', (e) => {
      if (e.target.id === 'mini-now-star') return;
      const k = w.AlbumsManager?.getPlayingAlbum?.();
      if (k && k !== '__reliz__') w.AlbumsManager?.loadAlbum(k);
    });
    h.querySelector('#mini-now-star')?.addEventListener('click', (e) => { e.stopPropagation(); toggleLikePlaying(); });
    return h;
  }

  function createNextUp() {
    const n = document.createElement('div');
    n.className = 'next-up'; n.id = 'next-up';
    n.innerHTML = `<span class="label">–î–∞–ª–µ–µ:</span><span class="title">‚Äî</span>`;
    return n;
  }

  function updateMiniHeader() {
    const h = $('mini-now');
    if (!h) return;
    if (!isBrowsingOther()) { h.style.display = 'none'; return; }
    const track = w.playerCore?.getCurrentTrack?.();
    const idx = w.playerCore?.getIndex?.();
    if (!track || idx < 0) { h.style.display = 'none'; return; }
    h.style.display = 'flex';
    const num = h.querySelector('#mini-now-num');
    const title = h.querySelector('#mini-now-title');
    const star = h.querySelector('#mini-now-star');
    if (num) num.textContent = `${String(idx + 1).padStart(2, '0')}.`;
    if (title) title.textContent = track.title || '‚Äî';
    if (star) {
      const album = w.AlbumsManager?.getPlayingAlbum?.();
      const uid = String(track?.uid || '').trim();
      let liked = false;
      if (album && uid && w.FavoritesManager) {
        if (album !== '__favorites__') liked = !!w.FavoritesManager.isFavorite(album, uid);
        else {
          const src = String(track?.sourceAlbum || '').trim();
          if (src) liked = !!w.FavoritesManager.isFavorite(src, uid);
        }
      }
      star.src = liked ? 'img/star.png' : 'img/star2.png';
    }
  }

  function updateNextUpLabel() {
    const n = $('next-up');
    if (!n) return;
    if (!isBrowsingOther()) { n.style.display = 'none'; return; }
    const ni = w.playerCore?.getNextIndex?.();
    if (ni < 0) { n.style.display = 'none'; return; }
    const snap = w.playerCore?.getPlaylistSnapshot?.();
    const next = snap?.[ni];
    if (!next) { n.style.display = 'none'; return; }
    n.style.display = 'flex';
    const t = n.querySelector('.title');
    if (t) { t.textContent = next.title || '‚Äî'; t.title = next.title || ''; }
  }

  function switchAlbumInstantly(key) {
    const idx = w.playerCore?.getIndex?.() || 0;
    ensurePlayerBlock(idx);
    updateMiniHeader();
    updateNextUpLabel();
    w.PlayerState?.save?.();
  }

  function bindPlayerEvents(b) {
    b.querySelector('#play-pause-btn')?.addEventListener('click', togglePlayPause);
    b.querySelector('#prev-btn')?.addEventListener('click', () => w.playerCore?.prev());
    b.querySelector('#next-btn')?.addEventListener('click', () => w.playerCore?.next());
    b.querySelector('#stop-btn')?.addEventListener('click', () => w.playerCore?.stop());
    b.querySelector('#repeat-btn')?.addEventListener('click', toggleRepeat);
    b.querySelector('#shuffle-btn')?.addEventListener('click', toggleShuffle);
    b.querySelector('#mute-btn')?.addEventListener('click', toggleMute);

    const vs = b.querySelector('#volume-slider');
    vs?.addEventListener('input', onVolumeChange);

    const vw = b.querySelector('.volume-control-wrapper');
    if (vw && !vw.__bound) {
      vw.__bound = true;
      const set = (x) => {
        const t = b.querySelector('.volume-track');
        if (!t) return;
        const r = t.getBoundingClientRect();
        if (!r.width) return;
        const p = Math.max(0, Math.min(1, (x - r.left) / r.width));
        vs.value = Math.round(p * 100);
        onVolumeChange({ target: vs });
      };
      vw.addEventListener('pointerdown', (e) => set(e.clientX));
      vw.addEventListener('pointermove', (e) => { if (e.buttons === 1) set(e.clientX); });
    }

    const pb = b.querySelector('#player-progress-bar');
    pb?.addEventListener('mousedown', startSeek);
    pb?.addEventListener('touchstart', startSeek);

    b.querySelector('#lyrics-toggle-btn')?.addEventListener('click', toggleLyricsView);
    b.querySelector('#animation-btn')?.addEventListener('click', toggleAnimation);
    b.querySelector('#pulse-btn')?.addEventListener('click', togglePulse);
    b.querySelector('#favorites-btn')?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); toggleFavoritesOnly(); });
    b.querySelector('#sleep-timer-btn')?.addEventListener('click', () => w.SleepTimer?.show?.());
    b.querySelector('#lyrics-text-btn')?.addEventListener('click', () => w.LyricsModal?.show?.());
    b.querySelector('#track-download-btn')?.addEventListener('click', (e) => {
      if (!w.playerCore?.getCurrentTrack?.()?.src) { e.preventDefault(); w.NotificationSystem?.error('–¢—Ä–µ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); }
    });
    b.querySelector('#eco-btn')?.addEventListener('click', toggleEcoMode);

    document.addEventListener('mousemove', handleSeek);
    document.addEventListener('touchmove', handleSeek);
    document.addEventListener('mouseup', stopSeek);
    document.addEventListener('touchend', stopSeek);
  }

  function togglePlayPause() {
    if (!w.playerCore) return;
    w.playerCore.isPlaying() ? w.playerCore.pause() : w.playerCore.play();
  }

  function updatePlayPauseIcon() {
    const icon = $('play-pause-icon');
    if (!icon || !w.playerCore) return;
    icon.innerHTML = w.playerCore.isPlaying() ? '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>' : '<path d="M8 5v14l11-7z"/>';
  }

  function startSeek(e) { isSeekingProgress = true; handleSeek(e); }
  function handleSeek(e) {
    if (!isSeekingProgress) return;
    const bar = $('player-progress-bar');
    if (!bar || !w.playerCore) return;
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const r = bar.getBoundingClientRect();
    const p = Math.max(0, Math.min(1, (x - r.left) / r.width));
    w.playerCore.seek(w.playerCore.getDuration() * p);
  }
  function stopSeek() { isSeekingProgress = false; }

  function updateProgress(pos, dur) {
    if (isSeekingProgress) return;
    const fill = $('player-progress-fill');
    if (fill) fill.style.width = `${Math.min(100, (pos / dur) * 100)}%`;
    const el = $('time-elapsed'), rem = $('time-remaining');
    if (el) el.textContent = formatTime(pos);
    if (rem) rem.textContent = `-${formatTime(dur - pos)}`;
  }

  function renderVolumeUI(v) {
    const p = Math.max(0, Math.min(100, v)) / 100;
    const fill = $('volume-fill'), handle = $('volume-handle'), track = $('volume-track');
    if (fill) fill.style.width = `${p * 100}%`;
    if (handle && track) {
      const r = track.getBoundingClientRect();
      handle.style.left = `${Math.max(7, Math.min(r.width - 7, r.width * p))}px`;
    }
  }

  function onVolumeChange(e) {
    const v = Math.max(0, Math.min(100, parseInt(e.target.value, 10) || 0));
    w.playerCore?.setVolume(v);
    requestAnimationFrame(() => renderVolumeUI(v));
    try { localStorage.setItem('playerVolume', String(v)); } catch {}
  }

  function toggleMute() {
    if (!w.playerCore) return;
    isMuted = !isMuted;
    w.playerCore.setMuted(isMuted);
    $('mute-btn')?.classList.toggle('active', isMuted);
  }

  function toggleRepeat() {
    if (!w.playerCore) return;
    w.playerCore.toggleRepeat();
    $('repeat-btn')?.classList.toggle('active', w.playerCore.isRepeat());
  }

  function toggleShuffle() {
    if (!w.playerCore) return;
    w.playerCore.toggleShuffle();
    $('shuffle-btn')?.classList.toggle('active', w.playerCore.isShuffle());
    w.PlaybackPolicy?.apply?.({ reason: 'toggle' });
    updateAvailableTracksForPlayback();
  }

  function toggleAnimation() {
    if ($('animation-btn')?.classList.contains('disabled')) return;
    if (lyricsViewMode === 'hidden') { w.NotificationSystem?.info('–õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞'); return; }
    animationEnabled = !animationEnabled;
    try { localStorage.setItem('lyricsAnimationEnabled', animationEnabled ? '1' : '0'); } catch {}
    const bg = $q('.lyrics-animated-bg');
    bg?.classList.toggle('active', animationEnabled);
    $('animation-btn')?.classList.toggle('active', animationEnabled);
    w.NotificationSystem?.info(animationEnabled ? '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è: –í–ö–õ' : '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è: –í–´–ö–õ');
  }

  function togglePulse() {
    bitEnabled = !bitEnabled;
    localStorage.setItem('bitEnabled', bitEnabled ? '1' : '0');
    $('pulse-btn')?.classList.toggle('active', bitEnabled);
    const h = $('pulse-heart'); if (h) h.textContent = bitEnabled ? '‚ù§Ô∏è' : 'ü§ç';
    bitEnabled ? startBitEffect() : stopBitEffect();
  }

  function startBitEffect() {
    try {
      if (w.Howler?.ctx && w.Howler.masterGain && !audioContext) {
        audioContext = w.Howler.ctx;
        if (!analyser) {
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          analyser.smoothingTimeConstant = 0.85;
          try { w.Howler.masterGain.connect(analyser); } catch { analyser = null; }
        }
      }
    } catch {}
    animateBit();
  }

  function animateBit() {
    if (!bitEnabled) return;
    let intensity = 0;
    if (analyser && audioContext?.state === 'running') {
      try {
        const d = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(d);
        const range = Math.floor(d.length * 0.3);
        let sum = 0;
        for (let i = 0; i < range; i++) sum += d[i];
        intensity = (sum / range / 255) * (bitIntensity / 100);
      } catch {}
    }
    if (intensity === 0 && w.playerCore?.isPlaying?.()) {
      const t = Date.now() / 1000;
      intensity = (Math.sin(t * 2.5) * 0.5 + 0.5) * (Math.sin(t * 1.3 + 0.5) * 0.3 + 0.7) * 0.25 * (bitIntensity / 100);
    }
    const logo = $('logo-bottom');
    if (logo) logo.style.transform = `scale(${1 + intensity * 0.2})`;
    animationFrame = requestAnimationFrame(animateBit);
  }

  function stopBitEffect() {
    if (animationFrame) { cancelAnimationFrame(animationFrame); animationFrame = null; }
    const logo = $('logo-bottom');
    if (logo) { logo.style.transition = 'transform 0.3s'; logo.style.transform = 'scale(1)'; setTimeout(() => { if (logo) logo.style.transition = ''; }, 300); }
    analyser = null;
  }

  function toggleLyricsView() {
    if ($('lyrics-toggle-btn')?.classList.contains('disabled')) return;
    const modes = ['normal', 'hidden', 'expanded'];
    lyricsViewMode = modes[(modes.indexOf(lyricsViewMode) + 1) % modes.length];
    try { localStorage.setItem('lyricsViewMode', lyricsViewMode); } catch {}
    renderLyricsViewMode();
    const msg = { normal: 'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥', hidden: 'üö´ –°–∫—Ä—ã—Ç–∞', expanded: 'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π' };
    w.NotificationSystem?.info(msg[lyricsViewMode]);
  }

  function renderLyricsViewMode() {
    const win = $('lyrics-window'), btn = $('lyrics-toggle-btn');
    if (!win || !btn) return;
    win.className = `lyrics-${lyricsViewMode}`;
    btn.className = `lyrics-toggle-btn lyrics-${lyricsViewMode}`;
    const bg = $q('.lyrics-animated-bg');
    if (lyricsViewMode === 'hidden') {
      bg?.classList.remove('active');
      $('animation-btn')?.classList.remove('active');
    } else if (animationEnabled) {
      bg?.classList.add('active');
      $('animation-btn')?.classList.add('active');
    }
  }

  function applyMiniState() {
    if (isInContextMiniMode) return;
    isInContextMiniMode = true;
    if (savedLyricsMode === null && lyricsViewMode !== 'hidden') savedLyricsMode = lyricsViewMode;
    if (savedAnimation === null) savedAnimation = animationEnabled;
    const win = $('lyrics-window');
    if (win) { win.style.display = 'none'; }
    const btn = $q('.lyrics-toggle-btn');
    if (btn) btn.style.display = 'none';
    animationEnabled = false;
    $q('.lyrics-animated-bg')?.classList.remove('active');
    $('animation-btn')?.classList.remove('active');
  }

  function restoreLyricsState() {
    if (!isInContextMiniMode) return;
    isInContextMiniMode = false;
    const win = $('lyrics-window');
    if (win) win.style.display = '';
    const btn = $q('.lyrics-toggle-btn');
    if (btn) btn.style.display = '';
    if (!hasTimedLyrics) {
      lyricsViewMode = 'hidden';
      animationEnabled = false;
      savedLyricsMode = null;
      savedAnimation = null;
      setLyricsAvailability(false);
      return;
    }
    if (savedLyricsMode !== null) { lyricsViewMode = savedLyricsMode; savedLyricsMode = null; }
    if (savedAnimation !== null) { animationEnabled = savedAnimation; savedAnimation = null; }
    renderLyricsViewMode();
  }

  function toggleFavoritesOnly() {
    const btn = $('favorites-btn'), icon = $('favorites-btn-icon');
    if (!btn || !icon) return;
    favoritesOnlyMode = !favoritesOnlyMode;
    btn.classList.toggle('favorites-active', favoritesOnlyMode);
    icon.src = favoritesOnlyMode ? 'img/star.png' : 'img/star2.png';
    w.NotificationSystem?.[favoritesOnlyMode ? 'success' : 'info'](favoritesOnlyMode ? '‚≠ê –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ' : '–í—Å–µ —Ç—Ä–µ–∫–∏');
    try { localStorage.setItem('favoritesOnlyMode', favoritesOnlyMode ? '1' : '0'); } catch {}
    syncFilterWithFavoritesMode();
    updateAvailableTracksForPlayback();
    w.PlaybackPolicy?.apply?.({ reason: 'toggle' });
  }

  function toggleLikePlaying() {
    const album = w.AlbumsManager?.getPlayingAlbum?.();
    const track = w.playerCore?.getCurrentTrack?.();
    if (!album || !track || !w.FavoritesManager) return;
    const uid = String(track?.uid || '').trim();
    if (!uid) return;
    if (album !== '__favorites__') {
      const liked = !!w.FavoritesManager.isFavorite(album, uid);
      w.FavoritesManager.toggleLike(album, uid, !liked);
    } else {
      const src = String(track?.sourceAlbum || '').trim();
      if (!src) return;
      const liked = !!w.FavoritesManager.isFavorite(src, uid);
      w.FavoritesManager.toggleLike(src, uid, !liked);
    }
    updateMiniHeader();
  }

  function toggleEcoMode() {
    const btn = $('eco-btn'), active = btn?.classList.contains('active');
    btn?.classList.toggle('active', !active);
    w.playerCore?.setQuality?.(active ? 'high' : 'low');
    w.NotificationSystem?.success(active ? '–≠–∫–æ–Ω–æ–º –í–´–ö–õ' : '–≠–∫–æ–Ω–æ–º –í–ö–õ');
  }

  function setLyricsAvailability(enabled) {
    const win = $('lyrics-window'), lBtn = $('lyrics-toggle-btn'), aBtn = $('animation-btn'), kBtn = $('lyrics-text-btn'), bg = $q('.lyrics-animated-bg'), cont = $('lyrics');
    if (win) win.style.display = enabled ? '' : 'none';
    [lBtn, aBtn].forEach(b => {
      if (b) {
        b.classList.toggle('disabled', !enabled);
        b.style.pointerEvents = enabled ? '' : 'none';
      }
    });
    if (kBtn) {
      const track = w.playerCore?.getCurrentTrack?.();
      const ok = !!(track?.fulltext) || (enabled && hasTimedLyrics && currentLyrics.length);
      kBtn.classList.toggle('disabled', !ok);
      kBtn.style.pointerEvents = ok ? '' : 'none';
      kBtn.style.opacity = ok ? '' : '0.4';
    }
    if (!enabled) {
      animationEnabled = false;
      bg?.classList.remove('active');
      aBtn?.classList.remove('active');
      lyricsViewMode = 'hidden';
      if (cont) cont.innerHTML = '';
    } else {
      const saved = localStorage.getItem('lyricsViewMode');
      lyricsViewMode = ['normal', 'hidden', 'expanded'].includes(saved) ? saved : 'normal';
      animationEnabled = localStorage.getItem('lyricsAnimationEnabled') === '1';
      aBtn?.classList.toggle('active', animationEnabled);
      bg?.classList.toggle('active', animationEnabled && lyricsViewMode !== 'hidden');
    }
    renderLyricsViewMode();
  }

  function get404Cache() { try { return JSON.parse(sessionStorage.getItem(LYRICS_404_KEY) || '{}'); } catch { return {}; } }
  function set404Cache(url) { try { const c = get404Cache(); c[url] = Date.now(); const k = Object.keys(c); if (k.length > 100) k.sort((a, b) => c[a] - c[b]).slice(0, 50).forEach(x => delete c[x]); sessionStorage.setItem(LYRICS_404_KEY, JSON.stringify(c)); } catch {} }
  function is404Cached(url) { return !!get404Cache()[url]; }

  async function loadLyrics(url) {
    currentLyrics = []; lyricsLastIdx = -1; hasTimedLyrics = false;
    const cont = $('lyrics');
    if (!cont) return;
    if (!url) { const t = w.playerCore?.getCurrentTrack?.(); if (!(t?.hasLyrics !== false && (t?.hasLyrics || t?.lyrics))) { setLyricsAvailability(false); return; } }
    if (!url) { setLyricsAvailability(false); return; }
    if (is404Cached(url)) { setLyricsAvailability(false); return; }
    if (prefetchedLyricsUrl === url && prefetchedLyrics) {
      currentLyrics = prefetchedLyrics; prefetchedLyrics = null; prefetchedLyricsUrl = null;
      if (currentLyrics.length) { hasTimedLyrics = true; setLyricsAvailability(true); renderLyricsViewMode(); }
      else { setLyricsAvailability(false); }
      prefetchNext(); return;
    }
    const cacheKey = `lyrics_cache_${url}`;
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) {
      try {
        const p = JSON.parse(cached);
        if (p === '__NO_LYRICS__' || p === null) { setLyricsAvailability(false); prefetchNext(); return; }
        parseLyrics(p);
        if (!currentLyrics.length) { setLyricsAvailability(false); prefetchNext(); return; }
        hasTimedLyrics = true; setLyricsAvailability(true); renderLyricsViewMode(); prefetchNext(); return;
      } catch { sessionStorage.removeItem(cacheKey); }
    }
    cont.innerHTML = '<div class="lyrics-spinner"></div>';
    try {
      const r = await fetch(url, { cache: 'force-cache' });
      if (!r.ok) { if (r.status === 404) set404Cache(url); setLyricsAvailability(false); prefetchNext(); return; }
      const txt = await r.text();
      const fmt = detectFmt(url, txt);
      if (fmt === 'json' || r.headers.get('content-type')?.includes('application/json')) {
        try {
          const j = JSON.parse(txt);
          if (!Array.isArray(j)) { sessionStorage.setItem(cacheKey, JSON.stringify('__NO_LYRICS__')); setLyricsAvailability(false); prefetchNext(); return; }
          sessionStorage.setItem(cacheKey, JSON.stringify(j)); parseLyrics(j);
        } catch { sessionStorage.setItem(cacheKey, JSON.stringify('__NO_LYRICS__')); setLyricsAvailability(false); prefetchNext(); return; }
      } else {
        sessionStorage.setItem(cacheKey, JSON.stringify(txt)); parseLyrics(txt);
      }
      if (!currentLyrics.length) { setLyricsAvailability(false); prefetchNext(); return; }
      hasTimedLyrics = true; setLyricsAvailability(true); renderLyricsViewMode(); prefetchNext();
    } catch { setLyricsAvailability(false); prefetchNext(); }
  }

  function detectFmt(url, txt) {
    if (url) { const l = url.toLowerCase(); if (l.endsWith('.lrc') || l.endsWith('.txt')) return 'lrc'; if (l.endsWith('.json')) return 'json'; }
    if (txt) { const t = txt.trim(); if (t.startsWith('[') && !/^$$\d/.test(t)) { try { JSON.parse(t); return 'json'; } catch {} } if (/\[\d{1,2}:\d{2}/.test(t)) return 'lrc'; }
    return 'unknown';
  }

  async function prefetchNext() {
    prefetchedLyrics = null; prefetchedLyricsUrl = null;
    const ni = w.playerCore?.getNextIndex?.(); if (ni < 0) return;
    const snap = w.playerCore?.getPlaylistSnapshot?.(); const next = snap?.[ni]; if (!next?.lyrics) return;
    const url = next.lyrics; if (is404Cached(url)) return;
    const cacheKey = `lyrics_cache_${url}`;
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) { try { const p = JSON.parse(cached); if (p && p !== '__NO_LYRICS__') { const tmp = []; parseLyricsInto(p, tmp); if (tmp.length) { prefetchedLyrics = tmp; prefetchedLyricsUrl = url; } } } catch {} return; }
    try {
      const r = await fetch(url, { cache: 'force-cache' }); if (!r.ok) { if (r.status === 404) set404Cache(url); return; }
      const txt = await r.text(); const fmt = detectFmt(url, txt); let data = txt; const tmp = [];
      if (fmt === 'json') { try { const j = JSON.parse(txt); if (Array.isArray(j)) { data = j; parseLyricsInto(j, tmp); } } catch {} } else parseLyricsInto(txt, tmp);
      try { sessionStorage.setItem(cacheKey, JSON.stringify(data)); } catch {}
      if (tmp.length) { prefetchedLyrics = tmp; prefetchedLyricsUrl = url; }
    } catch {}
  }

  function parseLyrics(src) { currentLyrics = []; parseLyricsInto(src, currentLyrics); }

  function parseLyricsInto(src, arr) {
    if (Array.isArray(src)) {
      src.forEach(it => { if (typeof it?.time !== 'number') return; const t = (it.line || it.text || '').trim(); if (t) arr.push({ time: it.time, text: t }); });
      arr.sort((a, b) => a.time - b.time); return;
    }
    String(src || '').split('\n').forEach(ln => {
      const tr = ln.trim(); if (!tr || /^\[[a-z]{2}:/i.test(tr)) return;
      let m = tr.match(/^\[(\d{1,2}):(\d{2})\.(\d{2,3})$$(.*)$/);
      if (m) { const cs = m[3].length === 3 ? parseInt(m[3], 10) / 1000 : parseInt(m[3], 10) / 100; const t = parseInt(m[1], 10) * 60 + parseInt(m[2], 10) + cs; const txt = (m[4] || '').trim(); if (txt) arr.push({ time: t, text: txt }); return; }
      m = tr.match(/^$$(\d{1,2}):(\d{2})$$(.*)$/);
      if (m) { const t = parseInt(m[1], 10) * 60 + parseInt(m[2], 10); const txt = (m[3] || '').trim(); if (txt) arr.push({ time: t, text: txt }); }
    });
    arr.sort((a, b) => a.time - b.time);
  }

  function renderLyrics(pos) {
    const cont = $('lyrics'); if (!cont) return;
    if (!currentLyrics.length) { cont.innerHTML = '<div class="lyrics-placeholder">–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>'; return; }
    const first = currentLyrics[0]?.time || 0;
    if (pos < first && first > 5) { const rem = first - pos; cont.innerHTML = `<div class="lyrics-countdown"${rem < 1 ? ` style="opacity:${rem.toFixed(2)}"` : ''}>${Math.ceil(rem)}</div>`; return; }
    let active = -1; for (let i = 0; i < currentLyrics.length; i++) { if (pos >= currentLyrics[i].time) active = i; else break; }
    const ws = lyricsViewMode === 'expanded' ? 9 : 5, center = Math.floor(ws / 2);
    const start = Math.max(0, active - center), pad = Math.max(0, center - active);
    const rows = [];
    for (let p = 0; p < pad; p++) rows.push('<div class="lyrics-window-line"></div>');
    for (let i = start; i < Math.min(currentLyrics.length, start + ws - pad); i++) {
      const cls = i === active ? 'lyrics-window-line active' : 'lyrics-window-line';
      rows.push(`<div class="${cls}">${escapeHtml(currentLyrics[i]?.text || '')}</div>`);
    }
    while (rows.length < ws) rows.push('<div class="lyrics-window-line"></div>');
    cont.innerHTML = rows.join('');
  }

  function renderLyricsEnhanced(pos) {
    if (lyricsViewMode === 'hidden' || isInContextMiniMode || !currentLyrics.length) return;
    let active = -1; for (let i = 0; i < currentLyrics.length; i++) { if (pos >= currentLyrics[i].time) active = i; else break; }
    const now = Date.now(); if (active === lyricsLastIdx && now - lyricsLastTs < 250) return;
    lyricsLastIdx = active; lyricsLastTs = now;
    renderLyrics(pos);
  }

  function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

  function restoreSettings() {
    favoritesOnlyMode = localStorage.getItem('favoritesOnlyMode') === '1';
    const btn = $('favorites-btn'), icon = $('favorites-btn-icon');
    if (btn && icon) { btn.classList.toggle('favorites-active', favoritesOnlyMode); icon.src = favoritesOnlyMode ? 'img/star.png' : 'img/star2.png'; }
    let vol = 50; const sv = localStorage.getItem('playerVolume'); if (sv !== null) { const v = parseInt(sv, 10); if (Number.isFinite(v)) vol = v; } else try { localStorage.setItem('playerVolume', '50'); } catch {}
    w.playerCore?.setVolume(vol);
    const vs = $('volume-slider'); if (vs) vs.value = String(vol); renderVolumeUI(vol);
    const sm = localStorage.getItem('lyricsViewMode'); lyricsViewMode = ['normal', 'hidden', 'expanded'].includes(sm) ? sm : 'normal';
    animationEnabled = localStorage.getItem('lyricsAnimationEnabled') === '1';
    bitEnabled = localStorage.getItem('bitEnabled') === '1'; if (bitEnabled) setTimeout(startBitEffect, 1000);
    const h = $('pulse-heart'); if (h) h.textContent = bitEnabled ? '‚ù§Ô∏è' : 'ü§ç';
    renderLyricsViewMode();
    console.log(`‚úÖ Settings restored: lyrics=${lyricsViewMode}, anim=${animationEnabled}`);
  }

  function toggleFavoritesFilter() {
    const cur = w.AlbumsManager?.getCurrentAlbum?.();
    const list = $('track-list'), btn = $('filter-favorites-btn'); if (!cur || !list || !btn) return;
    if (cur === '__favorites__' || cur === '__reliz__') { w.NotificationSystem?.info('–§–∏–ª—å—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
    const liked = w.FavoritesManager?.getLikedUidsForAlbum?.(cur) || [];
    favoritesFilterActive = !favoritesFilterActive;
    if (favoritesFilterActive) {
      if (!liked.length) { favoritesFilterActive = false; w.NotificationSystem?.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö'); return; }
      btn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò'; btn.classList.add('filtered'); list.classList.add('filtered');
      updateFavoriteClasses(liked);
      w.NotificationSystem?.success('–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ');
    } else {
      btn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏'; btn.classList.remove('filtered'); list.classList.remove('filtered');
      $qa('.track.is-favorite').forEach(el => el.classList.remove('is-favorite'));
      w.NotificationSystem?.info('–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏');
    }
  }

  function updateFavoriteClasses(liked) {
    const album = w.AlbumsManager?.getCurrentAlbum?.();
    const data = w.AlbumsManager?.getAlbumData?.(album);
    if (!data?.tracks) return;
    $qa('.track').forEach(el => {
      const idx = parseInt(el.dataset.index, 10); if (!Number.isFinite(idx)) return;
      const t = data.tracks[idx], uid = String(t?.uid || '').trim();
      el.classList.toggle('is-favorite', uid && liked.includes(uid));
    });
  }

  function syncFilterWithFavoritesMode() {
    const cur = w.AlbumsManager?.getCurrentAlbum?.();
    const btn = $('filter-favorites-btn'), list = $('track-list'); if (!btn || !list) return;
    favoritesFilterActive = favoritesOnlyMode;
    if (favoritesFilterActive) {
      btn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò'; btn.classList.add('filtered'); list.classList.add('filtered');
      const liked = cur === '__favorites__' ? null : w.FavoritesManager?.getLikedUidsForAlbum?.(cur) || [];
      if (liked) updateFavoriteClasses(liked);
    } else {
      btn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏'; btn.classList.remove('filtered'); list.classList.remove('filtered');
      $qa('.track.is-favorite').forEach(el => el.classList.remove('is-favorite'));
    }
  }

  function updateAvailableTracksForPlayback() {
    const album = w.AlbumsManager?.getPlayingAlbum?.();
    const snap = w.playerCore?.getPlaylistSnapshot?.() || [];
    if (!album || !snap.length) return;
    if (album === '__favorites__') { w.availableFavoriteIndices = null; return; }
    if (favoritesOnlyMode) {
      const liked = w.FavoritesManager?.getLikedUidsForAlbum?.(album) || [];
      if (!liked.length) { w.availableFavoriteIndices = null; return; }
      w.availableFavoriteIndices = snap.map((t, i) => liked.includes(String(t?.uid || '').trim()) ? i : -1).filter(i => i >= 0);
    } else {
      w.availableFavoriteIndices = null;
    }
  }

  function formatTime(s) { if (isNaN(s) || s < 0) return '00:00'; const m = Math.floor(s / 60), sec = Math.floor(s % 60); return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`; }

  w.PlayerUI = {
    initialize: initPlayerUI,
    ensurePlayerBlock,
    updateMiniHeader,
    updateNextUpLabel,
    togglePlayPause,
    toggleLikePlaying,
    switchAlbumInstantly,
    toggleFavoritesFilter,
    toggleFavoritesOnly,
    updateAvailableTracksForPlayback,
    get currentLyrics() { return currentLyrics; },
    get currentLyricsLines() { return currentLyrics.map(l => ({ line: l.text })); }
  };

  w.toggleFavoritesFilter = toggleFavoritesFilter;
  w.toggleFavoritesOnly = toggleFavoritesOnly;

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initPlayerUI);
  else initPlayerUI();
})();

//=================================================
// FILE: /scripts/ci/lint-sw.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('service-worker.js');
if (!fs.existsSync(file)) {
  console.error('service-worker.js not found');
  process.exit(1);
}
const src = fs.readFileSync(file, 'utf8');

const errors = [];
const warns = [];

if (!/const\s+SW_VERSION\s*=\s*['"`]\d+\.\d+\.\d+['"`]/.test(src)) {
  errors.push('SW_VERSION is missing or has wrong format (x.y.z)');
}

const listeners = (name) => (src.match(new RegExp(`addEventListener\\(['"]${name}['"]`, 'g')) || []).length;
['install','activate','fetch'].forEach(ev => {
  const n = listeners(ev);
  if (n === 0) errors.push(`No ${ev} event listener`);
  if (n > 1) warns.push(`Multiple (${n}) ${ev} listeners`);
});

const consts = ['CORE_CACHE','RUNTIME_CACHE','MEDIA_CACHE','OFFLINE_CACHE','META_CACHE'];
consts.forEach(cn => {
  const n = (src.match(new RegExp(`\\bconst\\s+${cn}\\b`, 'g')) || []).length;
  if (n === 0) errors.push(`Missing const ${cn}`);
  if (n > 1) warns.push(`Duplicate const ${cn} (${n} times)`);
});

// –î–æ–ø.–ø—Ä–æ–≤–µ—Ä–∫–∏: DEFAULT_SW_CONFIG —á–∏—Å–ª–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã –∏ revalidateDays —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ
const cfgMatch = src.match(/const\s+DEFAULT_SW_CONFIG\s*=\s*\{([\s\S]*?)\};/);
if (cfgMatch) {
  const body = cfgMatch[1];
  const num = (key) => {
    const m = body.match(new RegExp(`${key}\\s*:\\s*([0-9]+(?:\\.[0-9]+)?)`));
    return m ? Number(m[1]) : null;
  };
  const revalidateDays = num('revalidateDays');
  if (!(Number.isInteger(revalidateDays) && revalidateDays > 0)) {
    errors.push('DEFAULT_SW_CONFIG.revalidateDays must be positive integer');
  }
  ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(k => {
    const v = num(k);
    if (!(typeof v === 'number' && v > 0)) errors.push(`DEFAULT_SW_CONFIG.${k} must be positive number`);
  });
}

if (warns.length) {
  console.warn('SW linter warnings:\n - ' + warns.join('\n - '));
}
if (errors.length) {
  console.error('SW linter errors:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Service Worker lint OK');


//=================================================
// FILE: /scripts/ci/validate-content.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const fail = (msg) => { console.error(msg); process.exit(2); };
const warn = (msg) => { console.warn(msg); };

// 1) albums.json –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
const albumsFile = path.resolve('albums.json');
if (!fs.existsSync(albumsFile)) fail('albums.json not found');
let albums;
try {
  const raw = fs.readFileSync(albumsFile, 'utf8');
  const j = JSON.parse(raw);
  if (!j || !Array.isArray(j.albums)) fail('albums.json: "albums" must be an array');
  albums = j.albums;
} catch (e) {
  fail('albums.json is not valid JSON: ' + e.message);
}
albums.forEach((a, i) => {
  if (!a.key || !a.title || !a.base) fail(`albums.json: album[${i}] must contain key/title/base`);
  if (typeof a.key !== 'string' || typeof a.title !== 'string' || typeof a.base !== 'string') {
    fail(`albums.json: album[${i}] key/title/base must be strings`);
  }
  if (!/^https?:\/\//i.test(a.base)) {
    fail(`albums.json: album[${i}].base must be absolute http(s) url`);
  }
  if (!/\/$/.test(a.base)) {
    warn(`albums.json: album[${i}].base should end with "/" (got: ${a.base})`);
  }
});

// 1.5) –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π –∞–ª—å–±–æ–º–æ–≤
{
  const keys = albums.map(a => a.key);
  const uniq = new Set(keys);
  if (uniq.size !== keys.length) {
    const dup = keys.filter((k, idx) => keys.indexOf(k) !== idx);
    fail(`albums.json: duplicate album keys: ${Array.from(new Set(dup)).join(', ')}`);
  }
}

// 2) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –≥–∞–ª–µ—Ä–µ–π –∏ index.json –Ω–∞–ª–∏—á–∏—è/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
const galleryRoot = path.resolve('albums/gallery');
const required = ['00','01','02','03','news'];
required.forEach(id => {
  const dir = path.join(galleryRoot, id);
  const idx = path.join(dir, 'index.json');
  if (!fs.existsSync(dir)) fail(`albums/gallery/${id} directory missing`);
  if (!fs.existsSync(idx)) fail(`albums/gallery/${id}/index.json missing`);
  try {
    const raw = fs.readFileSync(idx, 'utf8');
    const j = JSON.parse(raw);
    const items = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
    if (!Array.isArray(items)) fail(`albums/gallery/${id}/index.json: items must be array`);
    if (items.length === 0) warn(`albums/gallery/${id}/index.json: items is empty`);
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ)
    items.forEach((it, k) => {
      const check = (p) => {
        if (!p || /^https?:\/\//i.test(p)) return;
        const rel = p.replace(/^\.\//, '');
        const fp = path.resolve(rel);
        if (!fs.existsSync(fp)) warn(`Missing file referenced from gallery ${id} item[${k}]: ${p}`);
      };
      if (typeof it === 'string') check(it);
      else if (it && typeof it === 'object') {
        if (it.src) check(it.src);
        if (it.formats) Object.values(it.formats).forEach(check);
      }
    });
  } catch (e) {
    fail(`albums/gallery/${id}/index.json invalid JSON: ${e.message}`);
  }
});

// 3) custom.json sw –∫–æ–Ω—Ñ–∏–≥: revalidateDays —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
const customFile = path.resolve('custom.json');
if (fs.existsSync(customFile)) {
  try {
    const raw = fs.readFileSync(customFile, 'utf8');
    const j = JSON.parse(raw);
    if (j && j.sw) {
      const d = j.sw.revalidateDays;
      if (!(Number.isInteger(d) && d > 0)) {
        fail('custom.json.sw.revalidateDays must be positive integer');
      }
      ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(key => {
        const v = j.sw[key];
        if (!(typeof v === 'number' && v > 0)) fail(`custom.json.sw.${key} must be positive number`);
      });
      if (typeof j.sw.allowUnknownSize !== 'boolean') {
        fail('custom.json.sw.allowUnknownSize must be boolean');
      }
    }
  } catch (e) {
    fail('custom.json invalid JSON: ' + e.message);
  }
}
// 4) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å uid –≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö config.json (–ù–ï —Ñ–µ–π–ª–∏–º –±–∏–ª–¥ –∏–∑-–∑–∞ —Å–µ—Ç–∏)
{
  // Node 20: fetch –¥–æ—Å—Ç—É–ø–µ–Ω. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –µ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º.
  const hasFetch = typeof fetch === 'function';
  if (!hasFetch) {
    warn('fetch() is not available in this Node runtime; skip remote config.json uid checks');
  } else {
    for (const a of albums) {
      const base = a.base.endsWith('/') ? a.base : `${a.base}/`;
      const url = `${base}config.json`;

      try {
        const r = await fetch(url, { cache: 'no-cache' });
        if (!r.ok) {
          warn(`remote config.json not reachable for "${a.key}": HTTP ${r.status} (${url})`);
          continue;
        }

        const cfg = await r.json();
        const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : null;
        if (!tracks) {
          warn(`remote config.json "${a.key}": tracks must be array (${url})`);
          continue;
        }

        const seen = new Set();
        const dups = new Set();
        let missing = 0;

        for (const t of tracks) {
          const uid = String(t?.uid || '').trim();
          if (!uid) {
            missing++;
            continue;
          }
          if (seen.has(uid)) dups.add(uid);
          seen.add(uid);
        }

        if (missing > 0) {
          warn(`remote config.json "${a.key}": ${missing} track(s) have empty uid (${url})`);
        }
        if (dups.size > 0) {
          warn(`remote config.json "${a.key}": duplicate uid(s): ${Array.from(dups).join(', ')} (${url})`);
        }
      } catch (e) {
        warn(`remote config.json check failed for "${a.key}": ${e?.message || e} (${url})`);
      }
    }
  }
}

console.log('Content validation OK');

//=================================================
// FILE: /scripts/ci/validate-manifest.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('manifest.json');
if (!fs.existsSync(file)) {
  console.error('manifest.json not found');
  process.exit(1);
}
const raw = fs.readFileSync(file, 'utf8');
let json;
try {
  json = JSON.parse(raw);
} catch (e) {
  console.error('manifest.json is not valid JSON:', e.message);
  process.exit(1);
}
const errors = [];
function req(key) { if (!(key in json)) errors.push(`Missing key: ${key}`); }

req('name');
req('short_name');
req('start_url');
req('icons');

if (json.icons && !Array.isArray(json.icons)) {
  errors.push('icons must be an array');
}
if (Array.isArray(json.icons) && json.icons.length === 0) {
  errors.push('icons must contain at least one icon');
}
if (!json.display) errors.push('Missing key: display');
if (!json.theme_color) errors.push('Missing key: theme_color');
if (!json.background_color) errors.push('Missing key: background_color');

if (errors.length) {
  console.error('Manifest validation failed:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Manifest validation OK');

//=================================================
// FILE: /scripts/core/bootstrap.js
// scripts/core/bootstrap.js
// ‚≠ê –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –≤—Å–µ —ç–∫—Å–ø–æ—Ä—Ç—ã, async/await –æ–±—ë—Ä–Ω—É—Ç –≤ IIFE

(function() {
  'use strict';

  class AppBootstrap {
    constructor() {
      this.requiredFeatures = [
        'localStorage',
        'fetch',
        'Promise',
        'addEventListener'
      ];
    }

    async init() {
      console.log('üöÄ Bootstrapping application...');

      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      if (!this.checkCompatibility()) {
        console.error('‚ùå Browser compatibility check failed');
        return;
      }

      // 1.5. –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ Howler.js
      const howlerReady = await this.waitForHowler();
      if (!howlerReady) {
        console.error('‚ùå Howler.js loading timeout');
        return;
      }

      // 2. –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
      this.detectIOS();
      this.detectStandalone();

      // 3. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
      this.preventDefaultBehaviors();

      // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      this.setupErrorHandling();

      // 5. ‚≠ê –ö–†–ò–¢–ò–ß–ù–û: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ albums.json
      await this.loadAlbumsIndex();

      console.log('‚úÖ Bootstrap complete');
    }

    async loadAlbumsIndex() {
      try {
        console.log('üìÄ Loading albums index...');
        
        const response = await fetch('./albums.json', { 
          cache: 'no-cache',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (!data || !Array.isArray(data.albums)) {
          throw new Error('Invalid albums.json format');
        }

        // ‚≠ê –ü—É–±–ª–∏–∫—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        window.albumsIndex = data.albums;

        console.log(`‚úÖ Albums index loaded: ${data.albums.length} albums`);
      } catch (error) {
        console.error('‚ùå Failed to load albums.json:', error);
        window.albumsIndex = [];
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤');
        }
      }
    }

    checkCompatibility() {
      const missing = [];

      if (!this.checkLocalStorage()) {
        missing.push('LocalStorage');
      }

      if (typeof fetch === 'undefined') {
        missing.push('Fetch API');
      }

      if (typeof Promise === 'undefined') {
        missing.push('Promises');
      }

      if (!document.addEventListener) {
        missing.push('Event Listeners');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ Web Audio API (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
      if (typeof AudioContext === 'undefined' && typeof webkitAudioContext === 'undefined') {
        console.warn('‚ö†Ô∏è Web Audio API not supported - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ MediaSession API (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
      if (!('mediaSession' in navigator)) {
        console.warn('‚ö†Ô∏è Media Session API not supported - —Ñ–æ–Ω–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ');
      }

      // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Howler.js –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏
      // –£–±–∏—Ä–∞–µ–º –∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

      if (missing.length > 0) {
        this.showCompatibilityError(missing);
        return false;
      }

      return true;
    }
    async waitForHowler() {
      // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ Howler.js –º–∞–∫—Å–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥
      const maxAttempts = 50;
      let attempts = 0;

      while (typeof Howl === 'undefined' && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }

      if (typeof Howl === 'undefined') {
        console.error('‚ùå Howler.js failed to load');
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ-–±–∏–±–ª–∏–æ—Ç–µ–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        }
        return false;
      }

      console.log('‚úÖ Howler.js loaded successfully');
      return true;
    }
    checkLocalStorage() {
      try {
        localStorage.setItem('__test', '1');
        localStorage.removeItem('__test');
        return true;
      } catch (e) {
        return false;
      }
    }

    showCompatibilityError(missing) {
      const errorHtml = `
        <div style="
          position: fixed;
          inset: 0;
          background: #181818;
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: center;
          font-family: sans-serif;
          padding: 20px;
          text-align: center;
          z-index: 99999;
        ">
          <div>
            <h1 style="color: #E80100; margin-bottom: 20px;">‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h1>
            <p style="margin-bottom: 15px;">–î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É—é—Ç—Å—è:</p>
            <ul style="list-style: none; padding: 0; margin-bottom: 20px;">
              ${missing.map(f => `<li style="margin: 5px 0;">‚ùå ${f}</li>`).join('')}
            </ul>
            <p style="color: #999;">–û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.</p>
          </div>
        </div>
      `;

      document.body.innerHTML = errorHtml;
    }

    detectIOS() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS) {
        document.body.classList.add('ios');
        console.log('üì± iOS detected');
      }
      return isIOS;
    }

    detectStandalone() {
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                          window.navigator.standalone === true;
      
      if (isStandalone) {
        document.body.classList.add('standalone');
        console.log('üì≤ PWA mode detected');
      }
      
      return isStandalone;
    }

    preventDefaultBehaviors() {
      document.body.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });

      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      document.addEventListener('contextmenu', (e) => {
        if (e.target.tagName === 'IMG' || e.target.closest('#cover-slot')) {
          e.preventDefault();
        }
      });
    }

    setupErrorHandling() {
      window.addEventListener('error', (e) => {
        console.error('üí• Global error:', e.error || e.message);
      });

      window.addEventListener('unhandledrejection', (e) => {
        console.error('üí• Unhandled promise rejection:', e.reason);
      });
    }
  }

  // ‚≠ê –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
      const bootstrap = new AppBootstrap();
      await bootstrap.init();
    });
  } else {
    const bootstrap = new AppBootstrap();
    bootstrap.init();
  }
})();

//=================================================
// FILE: /scripts/core/config.js
// scripts/core/config.js
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
export const APP_CONFIG = {
  // –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  APP_VERSION: '8.0.4',
  BUILD_DATE: '2025-11-08',
  // ‚úÖ –ü–†–û–ú–û–ö–û–î –î–õ–Ø –í–•–û–î–ê
  PROMOCODE: 'VITRINA2025',
  // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –∞–ª—å–±–æ–º–æ–≤
  ICON_ALBUMS_ORDER: [
    { key: '__favorites__', title: '‚≠ê‚≠ê‚≠ê–ò–ó–ë–†–ê–ù–ù–û–ï‚≠ê‚≠ê‚≠ê', icon: 'img/icon_album/icon-album-00.png' },
    { key: 'odnazhdy-v-skazke', title: '–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ', icon: 'img/icon_album/icon-album-03.png' },
    { key: 'golos-dushi', title: '–ì–æ–ª–æ—Å –î—É—à–∏', icon: 'img/icon_album/icon-album-02.png' },
    { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º', icon: 'img/icon_album/icon-album-01.png' },
    { key: 'krevetochka', title: '–ö–†–ï–í–ï—ÜTOCHKA', icon: 'img/icon_album/icon-album+00.png' },
    { key: '__reliz__', title: '–ù–û–í–û–°–¢–ò', icon: 'img/icon_album/icon-album-news.png' }
  ],
  // –ö–ª—é—á–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤
  SPECIAL_FAVORITES_KEY: '__favorites__',
  SPECIAL_RELIZ_KEY: '__reliz__',
  // –°—Å—ã–ª–∫–∏
  SUPPORT_URL: 'https://example.com/support',
  SUPPORT_EMAIL: 'support@vitrina-razbita.ru',
  GITHUB_URL: 'https://github.com/apel-s-in/vi3na1bita-music',
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–µ—Ä–∞
  PLAYER_SETTINGS: {
    defaultVolume: 1.0,
    crossfade: false,
    preload: true
  },
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  CACHE_VERSION: 'v1.0.0',
  CACHE_AUDIO: false, // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã
  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  ANALYTICS_ENABLED: false,
  ANALYTICS_ID: null,
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
  CENTRAL_GALLERY_BASE: './albums/gallery/',
  // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞–ª—å–±–æ–º–æ–≤
  PUBLISHED_ALBUM_KEYS: new Set(['odnazhdy-v-skazke', 'golos-dushi', 'mezhdu-zlom-i-dobrom', 'krevetochka'])
};

// –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
if (typeof window !== 'undefined') {
  window.APP_CONFIG = APP_CONFIG;
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  window.SPECIAL_FAVORITES_KEY = APP_CONFIG.SPECIAL_FAVORITES_KEY;
  window.SPECIAL_RELIZ_KEY = APP_CONFIG.SPECIAL_RELIZ_KEY;
  window.ICON_ALBUMS_ORDER = APP_CONFIG.ICON_ALBUMS_ORDER;
  window.CENTRAL_GALLERY_BASE = APP_CONFIG.CENTRAL_GALLERY_BASE;
}


//=================================================
// FILE: /scripts/core/utils.js
// scripts/core/utils.js
// –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

export function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

export function formatTime(s) {
  if (isNaN(s) || s < 0) return '--:--';
  const m = Math.floor(s / 60), sec = Math.floor(s % 60);
  return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

export function $(id) {
  return document.getElementById(id);
}

export function $q(sel) {
  return document.querySelector(sel);
}

export function $qa(sel) {
  return document.querySelectorAll(sel);
}

export async function waitFor(condition, maxMs = 2000, stepMs = 50) {
  let waited = 0;
  while (!condition() && waited < maxMs) {
    await new Promise(r => setTimeout(r, stepMs));
    waited += stepMs;
  }
  return condition();
}

export function createModal(html, onClose) {
  const bg = document.createElement('div');
  bg.className = 'modal-bg active';
  bg.innerHTML = html;
  bg.addEventListener('click', e => { if (e.target === bg) { bg.remove(); onClose?.(); } });
  bg.querySelector('.bigclose')?.addEventListener('click', () => { bg.remove(); onClose?.(); });
  document.body.appendChild(bg);
  return bg;
}

export function isMobile() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

export function isIOS() {
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

export function isStandalone() {
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
if (typeof window !== 'undefined') {
  window.Utils = { escapeHtml, formatTime, $, $q, $qa, waitFor, createModal, isMobile, isIOS, isStandalone };
}

//=================================================
// FILE: /scripts/e2e/favorites.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import { BASE, loginByPromo, likeFirstTrack, openFavorites, waitTracks } from './utils.js';

test('favorites UI builds and plays', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);

  expect(await page.locator('#track-list .track').count()).toBeGreaterThan(0);
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
});

test('toggle star updates row state and localStorage', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);

  const favRow = page.locator('#track-list .track').first();
  const favId = await favRow.getAttribute('id');
  expect(favId).toMatch(/^fav_/);

  await favRow.locator('.like-star').click();
  await expect(favRow).toHaveClass(/inactive/);

  const { present } = await page.evaluate((id) => {
    const m = String(id || '').match(/^fav_(.+)_(.+)$/);
    if (!m) return { present: false };
    const raw = localStorage.getItem('likedTrackUids:v1');
    const map = raw ? JSON.parse(raw) : {};
    return { present: (map[m[1]] || []).includes(m[2]) };
  }, favId);

  expect(present).toBeFalsy();
});

test('mini-player star toggles favorite in __favorites__', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);

  const favFirst = page.locator('#track-list .track').first();
  const favId = await favFirst.getAttribute('id');
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  const otherIcon = page.locator('.album-icon').filter({ hasNot: page.locator('[data-akey="__favorites__"]') }).nth(1);
  await otherIcon.click();

  await expect(page.locator('#mini-now')).toBeVisible({ timeout: 5000 });
  await page.locator('#mini-now-star').click();
  await page.waitForTimeout(200);

  await page.click('.album-icon[data-akey="__favorites__"]');
  await waitTracks(page);

  const { present } = await page.evaluate((id) => {
    const m = String(id || '').match(/^fav_(.+)_(.+)$/);
    if (!m) return { present: true };
    const raw = localStorage.getItem('likedTrackUids:v1');
    const map = raw ? JSON.parse(raw) : {};
    return { present: (map[m[1]] || []).includes(m[2]) };
  }, favId);

  const favRowAfter = page.locator(`#${favId}`);
  if (present) {
    await expect(favRowAfter).not.toHaveClass(/inactive/);
  } else {
    await expect(favRowAfter).toHaveClass(/inactive/);
  }
});

test('removing star of current track in favorites triggers next', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);

  // Like second track too
  await page.locator('#track-list .track').nth(1).hover();
  await page.locator('#track-list .track').nth(1).locator('.like-star').click();

  await openFavorites(page);
  const favFirst = page.locator('#track-list .track').first();
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  const beforeIdx = await page.evaluate(() => window.playerCore?.getIndex?.() ?? 0);
  await favFirst.locator('.like-star').click();
  await page.waitForTimeout(300);

  const afterIdx = await page.evaluate(() => window.playerCore?.getIndex?.() ?? 0);
  expect(afterIdx).not.toBe(beforeIdx);
  await expect(favFirst).toHaveClass(/inactive/);
});

//=================================================
// FILE: /scripts/e2e/player.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import {
  BASE,
  loginByPromo,
  likeFirstTrack,
  openFavorites,
  playFirstTrack,
  waitTracks,
  seedPlayerStateV2FromCurrent
} from './utils.js';

test('play track, toggle favorites-only and sleep timer UI', async ({ page }) => {
  await loginByPromo(page);
  await expect(page.locator('#main-block')).toBeVisible();
  await waitTracks(page);

  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
  await expect(page.locator('#play-pause-icon')).toBeVisible();

  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("15 –º–∏–Ω—É—Ç")');
  await expect(page.locator('#sleep-timer-badge')).toBeVisible();
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("–í—ã–∫–ª—é—á–∏—Ç—å")');
  await expect(page.locator('#sleep-timer-badge')).toBeHidden();
});

test('mini-mode when browsing other album', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  const otherIcon = page.locator('.album-icon').filter({ hasNot: page.locator('[data-akey="__favorites__"]') }).nth(1);
  await otherIcon.click();
  await expect(page.locator('#mini-now')).toBeVisible();
});

test('reload restores state via PlayerState', async ({ page }) => {
  await loginByPromo(page);
  await playFirstTrack(page);
  await seedPlayerStateV2FromCurrent(page, { position: 5, wasPlaying: true });

  await page.reload({ waitUntil: 'load' });
  await loginByPromo(page);
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });

  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getPosition?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

test('quick prev/next uses PlayerCore only', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');

  await page.evaluate(async () => {
    await new Promise(r => setTimeout(r, 50));
    window.playerCore?.prev?.();
    window.playerCore?.next?.();
  });

  const res = await page.evaluate(() => ({
    hasPc: !!window.playerCore,
    hasAudioEl: !!document.getElementById('audio')
  }));
  expect(res.hasPc).toBeTruthy();
  expect(res.hasAudioEl).toBeFalsy();
});

test('sysinfo modal shows SW version', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForTimeout(800);

  const sysbtn = page.locator('#sysinfo-btn');
  await expect(sysbtn).toBeVisible({ timeout: 5000 });
  await sysbtn.click();

  const modal = page.locator('.modal-bg .modal-feedback').filter({ hasText: '–û —Å–∏—Å—Ç–µ–º–µ' });
  await expect(modal).toBeVisible({ timeout: 5000 });
  await expect(modal).toContainText(/SW –≤–µ—Ä—Å–∏—è:/);
});

test('SW update flow persists state', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');
  await page.waitForTimeout(200);

  await page.evaluate(() => {
    window.playerCore?.play?.(0);
    try { window.playerCore?.seek?.(7); } catch {}
  });

  await page.evaluate(() => {
    window.confirm = () => true;
    window.dispatchEvent(new MessageEvent('message', { data: { type: 'SW_VERSION', version: '9.9.9' } }));
  });

  expect(await page.evaluate(() => !!sessionStorage.getItem('resumeAfterReloadV2'))).toBeTruthy();
});

test('favoritesOnly: unliking current triggers next', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);

  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  const before = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));
  await firstRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => ({
    playing: !!window.playerCore?.isPlaying?.(),
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  expect(after.playing).toBeTruthy();
  expect(after.uid).not.toBe(before);
});

test('repeat has priority over favoritesOnly', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);

  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  await page.click('#favorites-btn');
  await page.click('#repeat-btn');
  await expect(page.locator('#repeat-btn')).toHaveClass(/active/);

  const before = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));
  await firstRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));
  expect(after).toBe(before);
});

test('shuffle history: next-next-prev returns to previous', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');

  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  await page.click('#next-btn');
  await page.waitForTimeout(200);
  const second = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#next-btn');
  await page.waitForTimeout(200);

  await page.click('#prev-btn');
  await page.waitForTimeout(200);
  const back = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  expect(back).toBe(second);
});

//=================================================
// FILE: /scripts/e2e/utils.js
// @ts-check
/**
 * scripts/e2e/utils.js
 * –û–±—â–∏–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è Playwright e2e, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤ spec-—Ñ–∞–π–ª–∞—Ö.
 */

export const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';

export async function loginByPromo(page, promo = 'VITRINA2025') {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', promo);
  await page.click('#promo-btn');
  await page.waitForSelector('#main-block:not(.hidden)', { timeout: 10000 });
}

export async function waitTracks(page) {
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
}

export async function likeFirstTrack(page) {
  await waitTracks(page);
  const first = page.locator('#track-list .track').first();
  await first.hover();
  await first.locator('.like-star').click();
}

export async function openFavorites(page) {
  await page.click('.album-icon[data-akey="__favorites__"]');
  await waitTracks(page);
}

export async function playFirstTrack(page) {
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
}

/**
 * –ó–∞–ø–∏—Å–∞—Ç—å PlayerState –≤ localStorage –≤ uid-—Ñ–æ—Ä–º–∞—Ç–µ (V2).
 * –ë–µ—Ä—ë–º playingAlbum –∏–∑ AlbumsManager, –∞ uid/sourceAlbum –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞.
 */
export async function seedPlayerStateV2FromCurrent(page, opts = {}) {
  const position = typeof opts.position === 'number' ? opts.position : 5;
  const wasPlaying = typeof opts.wasPlaying === 'boolean' ? opts.wasPlaying : true;

  await page.evaluate(({ position, wasPlaying }) => {
    const pc = window.playerCore;
    const track = pc?.getCurrentTrack?.() || null;

    const albumKey = window.AlbumsManager?.getPlayingAlbum?.() || null;

    const st = {
      album: albumKey,
      currentAlbum: window.AlbumsManager?.getCurrentAlbum?.() || albumKey,
      trackUid: String(track?.uid || '').trim() || null,
      sourceAlbum: String(track?.sourceAlbum || '').trim() || null,
      trackIndex: typeof pc?.getIndex === 'function' ? (pc.getIndex() || 0) : 0,
      position: Math.floor(position),
      volume: typeof pc?.getVolume === 'function' ? (pc.getVolume() ?? 100) : 100,
      wasPlaying: !!wasPlaying
    };

    localStorage.setItem('playerStateV2', JSON.stringify(st));
  }, { position, wasPlaying });
}

//=================================================
// FILE: /scripts/ui/favorites.js
// scripts/ui/favorites.js
// –ï–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω—ã–º (uid-based)

(function FavoritesModule() {
  'use strict';
  const w = window;

  // === –ö–û–ù–°–¢–ê–ù–¢–´ ===
  const SPECIAL_FAVORITES_KEY = '__favorites__';
  const SPECIAL_RELIZ_KEY = '__reliz__';
  const LIKED_UID_KEY = 'likedTrackUids:v1';
  const REFS_UID_KEY = 'favoritesAlbumRefsByUid:v1';
  const COVER_TTL_MS = 12 * 60 * 60 * 1000;

  w.SPECIAL_FAVORITES_KEY = SPECIAL_FAVORITES_KEY;
  w.SPECIAL_RELIZ_KEY = SPECIAL_RELIZ_KEY;

  // === STORAGE ===
  const albumCoverCache = Object.create(null);

  function getLikedUidMap() {
    try {
      const raw = localStorage.getItem(LIKED_UID_KEY);
      const map = raw ? JSON.parse(raw) : {};
      return (map && typeof map === 'object') ? map : {};
    } catch { return {}; }
  }

  function setLikedUidMap(map) {
    try { localStorage.setItem(LIKED_UID_KEY, JSON.stringify(map || {})); } catch {}
  }

  function getLikedUidsForAlbum(albumKey) {
    const map = getLikedUidMap();
    const arr = map[albumKey];
    if (!Array.isArray(arr)) return [];
    return [...new Set(arr.map(x => String(x || '').trim()).filter(Boolean))];
  }

  function isFavorite(albumKey, trackUid) {
    const a = String(albumKey || '').trim();
    const uid = String(trackUid || '').trim();
    return a && uid && getLikedUidsForAlbum(a).includes(uid);
  }

  function toggleLike(albumKey, trackUid, makeLiked = null) {
    const a = String(albumKey || '').trim();
    const uid = String(trackUid || '').trim();
    if (!a || !uid) return false;

    const map = getLikedUidMap();
    let arr = [...new Set((map[a] || []).map(x => String(x || '').trim()).filter(Boolean))];
    const has = arr.includes(uid);
    const shouldLike = makeLiked !== null ? !!makeLiked : !has;

    if (shouldLike && !has) arr.push(uid);
    else if (!shouldLike && has) arr = arr.filter(x => x !== uid);

    map[a] = [...new Set(arr)];
    setLikedUidMap(map);

    try { w.dispatchEvent(new CustomEvent('favorites:changed', { detail: { albumKey: a, uid, liked: shouldLike } })); } catch {}
    return true;
  }

  // === REFS ===
  function readRefs() {
    try {
      const raw = localStorage.getItem(REFS_UID_KEY);
      return Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : [];
    } catch { return []; }
  }

  function writeRefs(arr) {
    try { localStorage.setItem(REFS_UID_KEY, JSON.stringify(arr || [])); } catch {}
  }

  function ensureRefsWithLikes() {
    const refs = readRefs();
    const seen = new Set(refs.map(x => `${x?.a}:${x?.uid}`));
    const map = getLikedUidMap();
    let changed = false;

    for (const a of Object.keys(map)) {
      for (const uid of (map[a] || [])) {
        const u = String(uid || '').trim();
        if (!u) continue;
        const k = `${a}:${u}`;
        if (!seen.has(k)) { refs.push({ a, uid: u }); seen.add(k); changed = true; }
      }
    }
    if (changed) writeRefs(refs);
    return refs;
  }

  function removeRef(albumKey, uid) {
    const a = String(albumKey || '').trim();
    const u = String(uid || '').trim();
    if (!a || !u) return false;
    const refs = readRefs().filter(r => !(r?.a === a && String(r?.uid || '').trim() === u));
    writeRefs(refs);
    return true;
  }

  // === MODEL ===
  async function buildModel() {
    ensureRefsWithLikes();
    const refs = readRefs();
    const out = [];
    const albumsIndex = w.albumsIndex || [];

    for (const ref of refs) {
      const a = String(ref?.a || '').trim();
      const uid = String(ref?.uid || '').trim();
      if (!a || !uid) continue;

      const meta = albumsIndex.find(x => x?.key === a);
      if (!meta?.base) continue;

      let cfg = null;
      try {
        const base = meta.base.endsWith('/') ? meta.base : `${meta.base}/`;
        const r = await fetch(`${base}config.json`, { cache: 'no-cache' });
        if (r.ok) cfg = await r.json();
      } catch {}

      const tracks = cfg?.tracks || [];
      const tr = tracks.find(t => String(t?.uid || '').trim() === uid);
      const isActive = getLikedUidsForAlbum(a).includes(uid);
      const base = meta.base.endsWith('/') ? meta.base : `${meta.base}/`;

      out.push({
        title: tr?.title || '–¢—Ä–µ–∫',
        uid,
        audio: isActive && tr?.audio ? new URL(tr.audio, base).toString() : null,
        lyrics: isActive && tr?.lyrics ? new URL(tr.lyrics, base).toString() : null,
        fulltext: isActive && tr?.fulltext ? new URL(tr.fulltext, base).toString() : null,
        __a: a, __uid: uid, __active: isActive,
        __artist: cfg?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        __album: cfg?.albumName || '–ê–ª—å–±–æ–º',
        __cover: 'img/logo.png'
      });
    }
    w.favoritesRefsModel = out;
    return out;
  }

  // === MODALS ===
  function createModalBg(html) {
    const bg = document.createElement('div');
    bg.className = 'modal-bg active';
    bg.innerHTML = html;
    bg.addEventListener('click', e => { if (e.target === bg) bg.remove(); });
    document.body.appendChild(bg);
    return bg;
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = String(str || '');
    return div.innerHTML;
  }

  function showDeleteConfirm(params) {
    const { albumKey, uid, title, onDeleted } = params || {};
    if (!albumKey || !uid) return;

    const modal = createModalBg(`
      <div class="modal-feedback" style="max-width:420px">
        <button class="bigclose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        <h3>–£–¥–∞–ª–∏—Ç—å –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª?</h3>
        <p><strong>${escapeHtml(title)}</strong></p>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:16px">
          <button class="offline-btn" data-act="cancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="offline-btn online" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `);

    modal.querySelector('.bigclose')?.addEventListener('click', () => modal.remove());
    modal.querySelector('[data-act="cancel"]')?.addEventListener('click', () => modal.remove());
    modal.querySelector('[data-act="delete"]')?.addEventListener('click', () => {
      removeRef(albumKey, uid);
      document.getElementById(`fav_${albumKey}_${uid}`)?.remove();
      modal.remove();
      w.NotificationSystem?.success('–£–¥–∞–ª–µ–Ω–æ');
      onDeleted?.();
    });
  }

  function showInactiveModal(params) {
    const { albumKey, uid, title, onDeleted } = params || {};
    if (!albumKey || !uid) return;

    const modal = createModalBg(`
      <div class="modal-feedback" style="max-width:420px">
        <button class="bigclose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        <h3>–¢—Ä–µ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</h3>
        <p><strong>${escapeHtml(title)}</strong></p>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:16px">
          <button class="offline-btn online" data-act="add">–î–æ–±–∞–≤–∏—Ç—å –≤ ‚≠ê</button>
          <button class="offline-btn" data-act="remove">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `);

    modal.querySelector('.bigclose')?.addEventListener('click', () => modal.remove());
    modal.querySelector('[data-act="add"]')?.addEventListener('click', () => {
      toggleLike(albumKey, uid, true);
      modal.remove();
      w.NotificationSystem?.success('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ ‚≠ê');
    });
    modal.querySelector('[data-act="remove"]')?.addEventListener('click', () => {
      modal.remove();
      showDeleteConfirm({ albumKey, uid, title, onDeleted });
    });
  }

  // === INIT ===
  function initialize() {
    try {
      const raw = localStorage.getItem(LIKED_UID_KEY);
      if (!raw) setLikedUidMap({});
    } catch {}
    console.log('‚úÖ FavoritesManager initialized');
  }

  // === EXPORTS ===
  w.FavoritesManager = {
    initialize,
    getLikedUidMap,
    getLikedUidsForAlbum,
    isFavorite,
    toggleLike
  };

  w.FavoritesData = {
    readFavoritesRefsByUid: readRefs,
    writeFavoritesRefsByUid: writeRefs,
    ensureFavoritesRefsWithLikes: ensureRefsWithLikes,
    buildFavoritesRefsModel: buildModel,
    removeFavoritesRef: removeRef,
    showFavoritesInactiveModal: showInactiveModal,
    showFavoritesDeleteConfirm: showDeleteConfirm
  };

  w.buildFavoritesRefsModel = buildModel;
  w.openFavoritesView = async () => w.AlbumsManager?.loadAlbum(SPECIAL_FAVORITES_KEY);

  // Legacy compat
  w.getLikedMap = getLikedUidMap;
  w.getLikedForAlbum = getLikedUidsForAlbum;
  w.toggleLikeForAlbum = (a, uid, liked) => toggleLike(a, uid, liked);
})();

//=================================================
// FILE: /scripts/ui/modals.js
// scripts/ui/modals.js ‚Äî –í—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
(function ModalsModule() {
  'use strict';
  const w = window;
  const esc = s => w.Utils?.escapeHtml?.(s) || s;

  // === LYRICS MODAL ===
  async function showLyrics() {
    const track = w.playerCore?.getCurrentTrack();
    if (!track) { w.NotificationSystem?.warning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞'); return; }

    let text = '';
    if (track.fulltext) {
      try {
        const r = await fetch(track.fulltext);
        if (r.ok) text = await r.text();
      } catch {}
    }
    if (!text && w.PlayerUI?.currentLyrics?.length) {
      text = w.PlayerUI.currentLyrics.map(l => l.text || l.line || '').filter(Boolean).join('\n');
    }
    if (!text) { w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }

    const modal = w.Utils?.createModal?.(`
      <div class="modal-feedback lyrics-modal" style="max-width:520px;max-height:80vh">
        <button class="bigclose">√ó</button>
        <h2>${esc(track.title)}</h2>
        <div style="color:#8ab8fd;margin-bottom:20px;font-size:14px">${esc(track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞')}</div>
        <div class="lyrics-fulltext" style="max-height:50vh;overflow-y:auto;padding:16px;background:rgba(0,0,0,.2);border-radius:10px;line-height:1.8;white-space:pre-wrap">${esc(text)}</div>
        <div style="display:flex;gap:10px;margin-top:20px;justify-content:center">
          <button class="modal-action-btn" id="copy-lyrics">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    `);
    modal?.querySelector('#copy-lyrics')?.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(text); w.NotificationSystem?.success('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); modal.remove(); } catch { w.NotificationSystem?.error('–û—à–∏–±–∫–∞'); }
    });
  }

  // === SYSINFO MODAL ===
  async function showSysinfo() {
    const swVer = await getSWVersion();
    const info = {
      ver: w.APP_CONFIG?.APP_VERSION || w.VERSION || '?',
      build: w.APP_CONFIG?.BUILD_DATE || w.BUILD_DATE || '?',
      pwa: window.matchMedia('(display-mode: standalone)').matches ? '‚úÖ' : '‚ùå',
      sw: swVer,
      howler: w.Howler?.version || 'N/A',
      online: navigator.onLine ? '‚úÖ' : '‚ùå'
    };
    w.Utils?.createModal?.(`
      <div class="modal-feedback" style="max-width:500px;max-height:80vh;overflow-y:auto">
        <button class="bigclose">√ó</button>
        <h2 style="color:#4daaff">–û —Å–∏—Å—Ç–µ–º–µ</h2>
        <div style="font-size:14px;line-height:1.8">
          <div><b>–í–µ—Ä—Å–∏—è:</b> ${info.ver}</div>
          <div><b>–°–±–æ—Ä–∫–∞:</b> ${info.build}</div>
          <div><b>PWA:</b> ${info.pwa}</div>
          <div><b>SW:</b> ${info.sw}</div>
          <div><b>Howler:</b> ${info.howler}</div>
          <div><b>Online:</b> ${info.online}</div>
        </div>
        <div style="margin-top:20px;text-align:center;font-size:12px;color:#999">–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ ¬© 2025</div>
      </div>
    `);
  }

  async function getSWVersion() {
    try {
      const reg = await navigator.serviceWorker.getRegistration();
      if (!reg?.active) return 'N/A';
      return new Promise(r => {
        const ch = new MessageChannel();
        ch.port1.onmessage = e => r(e.data.version || 'N/A');
        reg.active.postMessage({ type: 'GET_SW_VERSION' }, [ch.port2]);
        setTimeout(() => r('N/A'), 1000);
      });
    } catch { return 'N/A'; }
  }

  // === FEEDBACK MODAL ===
  function showFeedback() {
    const email = w.APP_CONFIG?.SUPPORT_EMAIL || 'support@vitrina-razbita.ru';
    const gh = w.APP_CONFIG?.GITHUB_URL || 'https://github.com/apel-s-in/vi3na1bita-music';
    w.Utils?.createModal?.(`
      <div class="modal-feedback" style="max-width:400px">
        <button class="bigclose">√ó</button>
        <h2>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h2>
        <div style="display:flex;flex-direction:column;gap:15px;margin-top:20px">
          <a href="https://t.me/vitrina_razbita" target="_blank" style="background:#0088cc;color:#fff;padding:15px;border-radius:8px;text-align:center;text-decoration:none">Telegram</a>
          <a href="mailto:${email}" style="background:#4daaff;color:#fff;padding:15px;border-radius:8px;text-align:center;text-decoration:none">Email</a>
          <a href="${gh}" target="_blank" style="background:#333;color:#fff;padding:15px;border-radius:8px;text-align:center;text-decoration:none">GitHub</a>
        </div>
      </div>
    `);
  }

  // === HOTKEYS MODAL ===
  function showHotkeys() {
    w.Utils?.createModal?.(`
      <div class="modal-feedback" style="max-width:400px">
        <button class="bigclose">√ó</button>
        <h2>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h2>
        <div style="margin-top:16px;font-size:14px;line-height:2">
          <div><b>K / –ü—Ä–æ–±–µ–ª</b> ‚Äî Play/Pause</div>
          <div><b>X</b> ‚Äî –°—Ç–æ–ø</div>
          <div><b>N / P</b> ‚Äî –°–ª–µ–¥./–ü—Ä–µ–¥.</div>
          <div><b>R</b> ‚Äî –ü–æ–≤—Ç–æ—Ä</div>
          <div><b>U</b> ‚Äî Shuffle</div>
          <div><b>F</b> ‚Äî –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</div>
          <div><b>T</b> ‚Äî –¢–∞–π–º–µ—Ä —Å–Ω–∞</div>
          <div><b>‚Üê/‚Üí</b> ‚Äî ¬±5 —Å–µ–∫</div>
          <div><b>‚Üë/‚Üì</b> ‚Äî –ì—Ä–æ–º–∫–æ—Å—Ç—å</div>
        </div>
      </div>
    `);
  }

  // === INIT ===
  function init() {
    document.getElementById('sysinfo-btn')?.addEventListener('click', showSysinfo);
    document.getElementById('feedback-link')?.addEventListener('click', showFeedback);
    document.getElementById('hotkeys-btn')?.addEventListener('click', showHotkeys);
    const supportLink = document.getElementById('support-link');
    if (supportLink) supportLink.href = w.APP_CONFIG?.SUPPORT_URL || '#';
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else init();

  w.LyricsModal = { show: showLyrics };
  w.Modals = { showLyrics, showSysinfo, showFeedback, showHotkeys };
})();

//=================================================
// FILE: /scripts/ui/notify.js
// scripts/ui/notify.js ‚Äî –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
(function() {
  const EMOJIS = { info: '‚ÑπÔ∏è', success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', offline: 'üì¥' };
  const DURATIONS = { info: 2000, success: 2500, error: 4000, warning: 3000, offline: 3000 };

  class Notify {
    constructor() {
      this.queue = [];
      this.showing = false;
      this.container = document.createElement('div');
      this.container.id = 'toast-container';
      document.body.appendChild(this.container);
    }

    show(msg, type = 'info', dur) {
      this.queue.push({ msg, type, dur: dur || DURATIONS[type] || 2000 });
      this.process();
    }

    process() {
      if (this.showing || !this.queue.length) return;
      this.showing = true;
      const { msg, type, dur } = this.queue.shift();
      const el = document.createElement('div');
      el.className = `toast toast-${type}`;
      el.innerHTML = `<div class="toast-content"><span class="toast-emoji">${EMOJIS[type] || '‚ÑπÔ∏è'}</span><span class="toast-message">${window.Utils?.escapeHtml?.(msg) || msg}</span></div>`;
      this.container.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
      setTimeout(() => {
        el.classList.remove('show');
        setTimeout(() => { el.remove(); this.showing = false; this.process(); }, 300);
      }, dur);
    }

    info(m, d) { this.show(m, 'info', d); }
    success(m, d) { this.show(m, 'success', d); }
    error(m, d) { this.show(m, 'error', d); }
    warning(m, d) { this.show(m, 'warning', d); }
    offline(m, d) { this.show(m, 'offline', d); }
    clear() { this.queue = []; }
  }

  window.NotificationSystem = new Notify();
})();

//=================================================
// FILE: /scripts/ui/sleep.js
// scripts/ui/sleep.js
// –¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º –æ–±—Ä–∞—Ç–Ω—ã–º –æ—Ç—Å—á—ë—Ç–æ–º

(function SleepTimerModule() {
  'use strict';

  const w = window;
  
  let sleepMenu = null;
  let updateInterval = null;

  const PRESETS = [
    { label: '5 –º–∏–Ω—É—Ç', minutes: 5 },
    { label: '10 –º–∏–Ω—É—Ç', minutes: 10 },
    { label: '15 –º–∏–Ω—É—Ç', minutes: 15 },
    { label: '30 –º–∏–Ω—É—Ç', minutes: 30 },
    { label: '1 —á–∞—Å', minutes: 60 },
    { label: '2 —á–∞—Å–∞', minutes: 120 }
  ];

  function initSleepTimer() {
    const btn = document.getElementById('sleep-timer-btn');
    if (!btn) {
      setTimeout(initSleepTimer, 100);
      return;
    }

    btn.addEventListener('click', toggleSleepMenu);

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ —Ç–∞–π–º–µ—Ä–∞ –æ—Ç PlayerCore
    if (w.playerCore) {
      w.playerCore.on({
        onSleepTriggered: () => {
          w.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª');
          clearSleepTimer();
        }
      });
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    restoreSleepTimer();

    console.log('‚úÖ Sleep timer initialized');
  }

  function toggleSleepMenu(e) {
    if (sleepMenu) {
      closeSleepMenu();
      return;
    }

    openSleepMenu(e.currentTarget);
  }

  function openSleepMenu(anchor) {
    sleepMenu = document.createElement('div');
    sleepMenu.className = 'sleep-menu';

    // ‚úÖ –ü–æ—Ä—Ç–∞–ª –≤ body, —á—Ç–æ–±—ã –º–µ–Ω—é –Ω–µ –æ–±—Ä–µ–∑–∞–ª–æ—Å—å overflow'–∞–º–∏ –ø–ª–µ–µ—Ä–∞
    // –∏ –≤—Å–µ–≥–¥–∞ –ø–æ–º–µ—â–∞–ª–æ—Å—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
    const rect = anchor.getBoundingClientRect();
    sleepMenu.style.position = 'fixed';
    sleepMenu.style.right = `${Math.max(8, window.innerWidth - rect.right)}px`;
    sleepMenu.style.bottom = `${Math.max(8, window.innerHeight - rect.top)}px`;

    const items = [];

    // –¢–µ–∫—É—â–∏–π —Ç–∞–π–º–µ—Ä
    const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;
    if (targetTs > 0) {
      items.push(`
        <div class="sleep-menu-item active" data-action="cancel">
          ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω: ${formatRemainingTime(targetTs)}
        </div>
        <div class="sleep-menu-item" data-action="clear">
          üö´ –í—ã–∫–ª—é—á–∏—Ç—å
        </div>
        <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 6px 0;"></div>
      `);
    }

    // –ü—Ä–µ—Å–µ—Ç—ã
    PRESETS.forEach(preset => {
      items.push(`
        <div class="sleep-menu-item" data-minutes="${preset.minutes}">
          ${preset.label}
        </div>
      `);
    });

    sleepMenu.innerHTML = items.join('');
    document.body.appendChild(sleepMenu);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    sleepMenu.querySelectorAll('.sleep-menu-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        handleSleepMenuClick(item);
      });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
    setTimeout(() => {
      document.addEventListener('click', closeSleepMenuOutside);
    }, 10);
  }

  function closeSleepMenu() {
    if (sleepMenu && sleepMenu.parentNode) {
      sleepMenu.parentNode.removeChild(sleepMenu);
    }
    sleepMenu = null;
    document.removeEventListener('click', closeSleepMenuOutside);
  }

  function closeSleepMenuOutside(e) {
    if (sleepMenu && !sleepMenu.contains(e.target)) {
      closeSleepMenu();
    }
  }

  function handleSleepMenuClick(item) {
    const action = item.dataset.action;
    const minutes = parseInt(item.dataset.minutes);

    if (action === 'clear') {
      clearSleepTimer();
      closeSleepMenu();
      w.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω');
      return;
    }

    if (Number.isFinite(minutes) && minutes > 0) {
      setSleepTimer(minutes);
      closeSleepMenu();
      w.NotificationSystem?.success(`‚è∞ –¢–∞–π–º–µ—Ä: ${minutes} –º–∏–Ω`);
    }
  }

  function setSleepTimer(minutes) {
    if (!w.playerCore) return;

    const ms = minutes * 60 * 1000;
    w.playerCore.setSleepTimer(ms);

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    try {
      localStorage.setItem('sleepTimerTarget', String(Date.now() + ms));
    } catch {}

    updateBadge();
    startUpdateInterval();
  }

  function clearSleepTimer() {
    if (w.playerCore) {
      w.playerCore.clearSleepTimer();
    }

    try {
      localStorage.removeItem('sleepTimerTarget');
    } catch {}

    stopUpdateInterval();
    updateBadge();
  }

  function restoreSleepTimer() {
    try {
      const saved = localStorage.getItem('sleepTimerTarget');
      if (!saved) return;

      const targetTs = parseInt(saved);
      const remaining = targetTs - Date.now();

      if (remaining > 0) {
        w.playerCore?.setSleepTimer(remaining);
        updateBadge();
        startUpdateInterval();
        console.log(`‚è∞ Sleep timer restored: ${Math.round(remaining / 60000)} min`);
      } else {
        localStorage.removeItem('sleepTimerTarget');
      }
    } catch {}
  }

  function updateBadge() {
    const badge = document.getElementById('sleep-timer-badge');
    if (!badge) return;

    const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;

    if (targetTs > 0) {
      const remaining = targetTs - Date.now();
      const minutes = Math.ceil(remaining / 60000);
      
      badge.textContent = minutes > 0 ? minutes : '';
      badge.style.display = minutes > 0 ? '' : 'none';
    } else {
      badge.style.display = 'none';
    }
  }

  function startUpdateInterval() {
    stopUpdateInterval();
    
    updateInterval = setInterval(() => {
      updateBadge();
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
      const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;
      if (targetTs > 0 && targetTs <= Date.now()) {
        clearSleepTimer();
      }
    }, 10000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  }

  function stopUpdateInterval() {
    if (updateInterval) {
      clearInterval(updateInterval);
      updateInterval = null;
    }
  }

  function formatRemainingTime(targetTs) {
    const remaining = targetTs - Date.now();
    const minutes = Math.ceil(remaining / 60000);
    
    if (minutes >= 60) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}—á ${mins}–º` : `${hours}—á`;
    }
    
    return `${minutes}–º`;
  }

  // –ü—É–±–ª–∏—á–Ω—ã–π API
  w.SleepTimer = {
    setSleepTimer,
    clearSleepTimer,
    updateBadge,
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ—Ä—è—á–µ–π –∫–ª–∞–≤–∏—à–µ–π T –∏ –∫–Ω–æ–ø–∫–æ–π –≤ PlayerUI)
    show() {
      const btn = document.getElementById('sleep-timer-btn');
      if (!btn) return;
      // –ï—Å–ª–∏ –º–µ–Ω—é —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ ‚Äì –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç—å/–æ—Ç–∫—Ä—ã—Ç—å –ø–æ toggleSleepMenu
      toggleSleepMenu({ currentTarget: btn });
    }
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSleepTimer);
  } else {
    initSleepTimer();
  }

  console.log('‚úÖ Sleep timer module loaded');
})();

//=================================================
// FILE: /scripts/utils/sw-manager.js
// scripts/utils/sw-manager.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Service Worker –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

class ServiceWorkerManager {
  constructor() {
    this.registration = null;
    this.isSupported = 'serviceWorker' in navigator;
  }

  async init() {
    if (!this.isSupported) {
      console.warn('Service Worker not supported');
      return false;
    }

    try {
      this.registration = await navigator.serviceWorker.register('./service-worker.js', {
        scope: './'
      });

      console.log('‚úÖ Service Worker registered:', this.registration.scope);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      this.checkForUpdates();

      // –°–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      this.registration.addEventListener('updatefound', () => {
        this.handleUpdateFound();
      });

      // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–∫–∞–∂–¥—ã–π —á–∞—Å)
      setInterval(() => {
        this.checkForUpdates();
      }, 60 * 60 * 1000);

      return true;
    } catch (error) {
      console.error('Service Worker registration failed:', error);
      return false;
    }
  }

  checkForUpdates() {
    if (this.registration) {
      this.registration.update();
    }
  }

  handleUpdateFound() {
    const newWorker = this.registration.installing;
    
    newWorker.addEventListener('statechange', () => {
      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
        // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
        this.showUpdateNotification();
      }
    });
  }

  showUpdateNotification() {
    window.NotificationSystem?.info(
      '–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?',
      10000
    );

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    this.showUpdateButton();
  }

  showUpdateButton() {
    let updateBtn = document.getElementById('update-app-btn');
    
    if (!updateBtn) {
      updateBtn = document.createElement('button');
      updateBtn.id = 'update-app-btn';
      updateBtn.textContent = '–û–ë–ù–û–í–ò–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï';
      updateBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: #4daaff;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      
      updateBtn.addEventListener('click', () => {
        this.applyUpdate();
      });
      
      document.body.appendChild(updateBtn);
    }
    
    updateBtn.style.display = 'block';
  }

  async applyUpdate() {
    if (!this.registration || !this.registration.waiting) {
      return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–µ–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ reload –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
    try {
      if (window.PlayerState && typeof window.PlayerState.save === 'function') {
        window.PlayerState.save({ forReload: true });
      }
    } catch (e) {
      console.warn('PlayerState.save before SW update failed:', e);
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ SW –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è
    this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ SW
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }

  async clearCache(cacheType) {
    if (!this.registration || !this.registration.active) {
      return;
    }

    this.registration.active.postMessage({
      type: 'CLEAR_CACHE',
      payload: { cacheType }
    });

    window.NotificationSystem?.success('–ö—ç—à –æ—á–∏—â–µ–Ω');
  }

  async cacheAudioFiles(urls) {
    if (!this.registration || !this.registration.active) {
      return;
    }

    this.registration.active.postMessage({
      type: 'CACHE_AUDIO',
      payload: { urls }
    });
  }

  async getCacheSize() {
    if (!this.registration || !this.registration.active) {
      return 0;
    }

    return new Promise((resolve) => {
      const messageChannel = new MessageChannel();
      
      messageChannel.port1.onmessage = (event) => {
        resolve(event.data.size || 0);
      };

      this.registration.active.postMessage(
        { type: 'GET_CACHE_SIZE' },
        [messageChannel.port2]
      );
    });
  }

  formatCacheSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.ServiceWorkerManager = new ServiceWorkerManager();

// –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.ServiceWorkerManager.init();
  });
} else {
  window.ServiceWorkerManager.init();
}

export default ServiceWorkerManager;

//=================================================
// FILE: /albums/gallery/news/news-01-baner.html
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ</title>
  <style>
    :root{
      --bg-0: #0b0e15;     /* –±–∞–∑–æ–≤—ã–π —Ñ–æ–Ω */
      --bg-1: #0f1422;     /* –ø–∞–Ω–µ–ª—å/–∫–∞—Ä—Ç–∞ */
      --bg-2: #0a0d17;     /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ–Ω */
      --text: #e8ecf6;     /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --muted: #a9b3c7;    /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π */
      --accent-1: #4aa3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã */
      --accent-2: #7be3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã 2 */
      --shadow: 0 12px 28px rgba(0,0,0,0.45), 0 3px 10px rgba(0,0,0,0.35);
      --radius: 16px;
      --radius-inner: 12px;
    }
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(120% 120% at 10% 10%, #111827 0%, #0b0e15 45%, #070a12 100%);
      color: var(--text);
      font: 500 16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    .wrap{
      position:relative;
      height:100%;
      width:100%;
      display:grid;
      place-items:center;
      padding:10px;
      box-sizing:border-box;
    }
    /* –í–Ω–µ—à–Ω—è—è ¬´–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è —Ä–∞–º–∫–∞¬ª */
    .frame{
      position:relative;
      width:100%;
      height:100%;
      max-width:900px;
      max-height:900px;
      border-radius: var(--radius);
      padding:1px; /* —Ç–æ–ª—â–∏–Ω–∞ —Ä–∞–º–∫–∏ */
      background: linear-gradient(135deg, rgba(74,163,255,0.85), rgba(123,227,255,0.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card{
      position:relative;
      width:100%;
      height:100%;
      border-radius: calc(var(--radius) - 1px);
      background:
        radial-gradient(140% 120% at 80% 0%, rgba(27,41,72,0.55), transparent 60%),
        radial-gradient(120% 140% at 0% 100%, rgba(18,30,58,0.6), transparent 55%),
        var(--bg-1);
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:16px;
      box-sizing:border-box;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .badge{
      align-self:flex-start;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(2px);
    }
    .title{
      font-weight:700;
      font-size: clamp(18px, 3vw, 24px);
      line-height:1.25;
      margin:0 4px;
      color: var(--text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.25);
    }
    .subtitle{
      margin: -6px 4px 2px;
      color: var(--muted);
      font-size: 14px;
    }

    /* –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø–ª–µ–µ—Ä–∞ */
    .embed{
      position:relative;
      margin-top: 4px;
      width:100%;
      flex: 1 1 auto;
      aspect-ratio: 1 / 1; /* —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç */
      border-radius: var(--radius-inner);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.8), rgba(6,8,15,0.92)),
        var(--bg-2);
      border:1px solid rgba(255,255,255,0.07);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 24px rgba(0,0,0,0.45);
    }
    /* ‚úÖ –í–º–µ—Å—Ç–æ iframe: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –≤—Å—é –æ–±–ª–∞—Å—Ç—å (–±–µ–∑ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—à–∏–±–æ–∫) */
    .embed-link{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: var(--text);
      text-decoration:none;
      font-weight:800;
      font-size: clamp(16px, 3vw, 22px);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.65), rgba(6,8,15,0.9)),
        var(--bg-2);
    }
    .embed-link:hover{
      filter: brightness(1.05);
    }
    .embed-link:active{
      filter: brightness(0.95);
    }

    /* –ù–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top: 4px;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      opacity: .9;
    }
    .cta{
      padding:8px 12px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      text-decoration:none;
      font-weight:600;
      transition: transform .12s ease, background .2s ease;
    }
    .cta:hover{ transform: translateY(-1px); }
    .cta:active{ transform: translateY(0); }

    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö –≤—ã—Å–æ—Ç–∞—Ö —Å–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
    @media (max-height: 420px){
      .card{ padding:12px; gap:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <section class="card" role="region" aria-label="–ù–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–Ω–Ω–µ—Ä ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏">
        <div class="badge">–ù–æ–≤–æ—Å—Ç–∏</div>
        <h1 class="title">¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª ‚Äî —É–∂–µ –Ω–∞ –Ø–Ω–¥–µ–∫—Å&nbsp;–ú—É–∑—ã–∫–µ</h1>
        <p class="subtitle">–°–ª—É—à–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º –≥—Ä—É–ø–ø—ã ¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª</p>

        <div class="embed" role="group" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ">
          <a class="embed-link"
             href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link"
             target="_blank"
             rel="noopener">
            –û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ
          </a>
        </div>

        <div class="footer">
          <div class="hint">–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏—Ç–µ ¬´–ø–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤ –ø–ª–µ–µ—Ä–µ, —á—Ç–æ–±—ã —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –¥—Ä—É–∑—å—è–º</div>
          <a class="cta" href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º</a>
        </div>
      </section>
    </div>
  </div>
</body>
</html>

//=================================================
// FILE: /generate-context.js
/* eslint-disable no-console */
"use strict";

/**
 * generate-context.js
 *
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä .meta/project-full.txt –∏ .meta/project-adaptive.txt
 * –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã):
 * 1) –í –Ω–∞—á–∞–ª–µ ‚Äî –±–ª–æ–∫ ¬´–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô¬ª, –∑–∞—Ç–µ–º –º–µ—Ç–∞‚Äë–±–ª–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º/URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–æ–º–µ—Ç–∫–æ–π –ø—Ä–æ GitHub.
 * 2) –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ‚Äî –ü–û–õ–ù–û–ï –¥–µ—Ä–µ–≤–æ –í–°–ï–• —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è assets/), –Ω–æ –±–µ–∑ .git/** –∏ .meta/**.
 *    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤.
 * 3) –ü–æ—Å–ª–µ –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º (critical ‚Üí high ‚Üí medium ‚Üí low),
 *    –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤—ã–≤–æ–¥–∏—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º. –ó–¥–µ—Å—å assets/** –∏—Å–∫–ª—é—á–∞–µ–º (–ø–æ –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é), .meta/** —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º.
 * 4) –ù–ï–¢ –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª.
 * 5) Adaptive-—Ä–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—â–∏–π –æ–±—ä—ë–º —Å—Ç—Ä–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º --max-lines (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20000).
 *
 * –ó–∞–ø—É—Å–∫:
 *   node generate-context.js --mode=both --max-lines=20000
 *   node generate-context.js --mode=full
 *   node generate-context.js --mode=adaptive --out-dir=.meta
 *
 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
 *   --mode=both|full|adaptive
 *   --max-lines=–ß–ò–°–õ–û           // —Ç–æ–ª—å–∫–æ –¥–ª—è adaptive
 *   --out-dir=–ü–£–¢–¨              // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é .meta
 *   --root=–ü–£–¢–¨                 // –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞)
 */

const fs = require("fs");
const path = require("path");

// -------------------- CLI --------------------
const argv = Object.fromEntries(
  process.argv.slice(2).map(a => {
    const [k, ...r] = a.replace(/^--/, "").split("=");
    return [k, r.join("=") === "" ? true : r.join("=")];
  })
);

const ROOT     = path.resolve(argv.root || __dirname);
const META_DIR = path.resolve(argv["out-dir"] || path.join(ROOT, ".meta"));
const MODE     = (argv.mode || "both").toLowerCase(); // full | adaptive | both
const MAX_LINES = Number(argv["max-lines"] || 20000);

// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ .meta
if (!fs.existsSync(META_DIR)) fs.mkdirSync(META_DIR, { recursive: true });

const FULL_FILE    = path.join(META_DIR, "project-full.txt");
const ADAPTIVE_FILE= path.join(META_DIR, "project-adaptive.txt");

// –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ self-—Ñ–∞–π–ª–∞–º (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è)
const SELF_FULL_REL  = toUnix(path.relative(ROOT, FULL_FILE));
const SELF_ADAPT_REL = toUnix(path.relative(ROOT, ADAPTIVE_FILE));

// -------------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ --------------------

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ç–æ—Ä—ã—Ö –≤–∫–ª—é—á–∞–µ–º –≤ —Å–µ–∫—Ü–∏—é ¬´–§–ê–ô–õ–´¬ª
const TEXT_EXTS = new Set([
  ".html",".htm",".css",".js",".mjs",".cjs",".ts",".tsx",
  ".json",".webmanifest",".md",".txt",".yml",".yaml"
]);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –°–ï–ö–¶–ò–ò ¬´–§–ê–ô–õ–´¬ª (—Ç–æ–ª—å–∫–æ –∫ –ª–∏—Å—Ç–∏–Ω–≥—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ù–ï –∫ –¥–µ—Ä–µ–≤—É):
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –∏—Å–∫–ª—é—á–∞–µ–º .meta/** –∏ assets/** (–Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ –∫–æ–Ω—Ç–µ–Ω—Ç),
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏.
 */
const EXCLUDE_FILES_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  "assets/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û –¥–ª—è –°–¢–†–£–ö–¢–£–†–´ –î–ï–†–ï–í–ê:
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã, –≤–∫–ª—é—á–∞—è assets/**.
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ .git/**, .meta/** –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ (node_modules –∏ —Ç.–ø.),
 *   –ø–ª—é—Å –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤.
 */
const EXCLUDE_TREE_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
const PRIORITY = {
  critical: [
    /^index\.html?$/i,
    /^service-worker\.js$/i,
    /^manifest\.json$/i,
    /^albums\.json$/i,
    /^custom\.json$/i,
    /^news\.html?$/i,
    /^generate-index\.(js|mjs|cjs)$/i,
    /^albums\/gallery\/[^/]+\/index\.json$/i,
    /^\.github\/workflows\/.*\.ya?ml$/i
  ],
  high: [
    /^AudioController\.(js|mjs|cjs|ts)$/i,
    /^GlobalState\.(js|mjs|cjs|ts)$/i,
    /^scripts\/.*\.(mjs|js|ts)$/i,
    /^performance\/.*\.(js|ts)$/i,
    /^.*\.(ya?ml)$/i
  ],
  medium: [
    /^.*\.(js|mjs|cjs|ts|tsx|json|html?|css)$/i
  ],
};

// -------------------- –£—Ç–∏–ª–∏—Ç—ã --------------------
function toUnix(p) {
  return String(p).replace(/\\/g, "/");
}
function globToRegExp(pat) {
  const esc = pat
    .replace(/[.+^${}()|[\]\\]/g, "\\$")
    .replace(/\*\*/g, "___GLOBSTAR___")
    .replace(/\*/g, "[^/]*")
    .replace(/___GLOBSTAR___/g, ".*");
  return new RegExp("^" + esc + "$");
}
function isTextFile(rel) {
  return TEXT_EXTS.has(path.extname(rel).toLowerCase());
}
function readText(rel) {
  try { return fs.readFileSync(path.join(ROOT, rel), "utf8"); }
  catch (e) { return `// read error: ${e.message}`; }
}
function countLines(s) {
  return (s.match(/\n/g) || []).length + (s.length ? 1 : 0);
}

// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
function isExcludedForFiles(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_FILES_PATTERNS.some(re => re.test(u));
}
// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –¥–µ—Ä–µ–≤–∞
function isExcludedForTree(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_TREE_PATTERNS.some(re => re.test(u));
}

// -------------------- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ --------------------
function listAllEntries(includeFiles = true, forTree = false) {
  const res = [];
  const stack = [ROOT];

  while (stack.length) {
    const dir = stack.pop();
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { continue; }

    for (const e of entries) {
      const full = path.join(dir, e.name);
      const rel = toUnix(path.relative(ROOT, full)) || ".";

      // –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –¥–ª—è –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–≤–æ–∏, –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî —Å–≤–æ–∏
      const excluded = forTree ? isExcludedForTree(rel) : isExcludedForFiles(rel);
      if (excluded) continue;

      if (e.isDirectory()) {
        res.push({ rel, full, dir: true });
        stack.push(full);
      } else if (e.isFile() && includeFiles) {
        res.push({ rel, full, dir: false });
      }
    }
  }

  // –ü–∞–ø–∫–∏ —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º —Ñ–∞–π–ª—ã; –≤–Ω—É—Ç—Ä–∏ ‚Äî –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  res.sort((a, b) => (a.dir !== b.dir ? (a.dir ? -1 : 1) : a.rel.localeCompare(b.rel)));
  return res;
}

function listTextFilesForContent() {
  return listAllEntries(true, /*forTree*/ false)
    .filter(e => !e.dir && isTextFile(e.rel))
    .map(e => e.rel);
}

// -------------------- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π --------------------
function readRepoMeta() {
  let url = "";
  try {
    const cfg = path.join(ROOT, ".git", "config");
    if (fs.existsSync(cfg)) {
      const raw = fs.readFileSync(cfg, "utf8");
      const m = raw.match(/url\s*=\s*(.+)\n/);
      if (m) url = m[1].trim();
    }
  } catch {}
  return {
    name: path.basename(ROOT),
    url: url || "(URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω; —É–∫–∞–∂–∏—Ç–µ –≤ .git/config)",
    madeWith: "–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).",
  };
}

// -------------------- –ë–ª–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ --------------------
function rulesBlock() {
  return [
    "–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):",
    "- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.",
    "- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.",
    "- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).",
    "- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:",
    "  ```ts",
    "  export function x() {}",
    "  ```",
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).",
    "- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.",
    "- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.",
    "- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.",
    "- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.",
    "- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].",
    "- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. ",
    "- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.",
    "- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).",
    "- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.",
    "- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.",
    ""
  ].join("\n");
}

function metaBlock() {
  const m = readRepoMeta();
  return [
    `–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.name}`,
    `–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.url}`,
    "# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.",
    m.madeWith,
    ""
  ].join("\n");
}

// -------------------- –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê (–¥–µ—Ä–µ–≤–æ) --------------------
function buildFullTree() {
  const lines = [];
  lines.push(path.basename(ROOT) + "/");

  function walk(dir, prefix = "") {
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { return; }

    const visible = entries
      .filter(e => !isExcludedForTree(toUnix(path.relative(ROOT, path.join(dir, e.name)))))
      .sort((a, b) => (a.isDirectory() !== b.isDirectory() ? (a.isDirectory() ? -1 : 1) : a.name.localeCompare(b.name)));

    visible.forEach((e, i) => {
      const isLast = i === visible.length - 1;
      const branch = isLast ? "‚îî‚îÄ‚îÄ " : "‚îú‚îÄ‚îÄ ";
      lines.push(prefix + branch + e.name + (e.isDirectory() ? "/" : ""));
      if (e.isDirectory()) {
        walk(path.join(dir, e.name), prefix + (isLast ? "    " : "‚îÇ   "));
      }
    });
  }

  walk(ROOT);
  return lines.join("\n") + "\n\n";
}

// -------------------- –°–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª --------------------
function getPriority(rel) {
  const u = toUnix(rel);
  for (const [lvl, rules] of Object.entries(PRIORITY)) {
    if (rules.some(re => re.test(u))) return lvl;
  }
  return "low";
}

function groupFilesByPriority() {
  const all = listTextFilesForContent(); // —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω—ã assets/.meta –∏ –ø—Ä–æ—á–∏–µ –ø–æ EXCLUDE_FILES_PATTERNS
  return {
    critical: all.filter(f => getPriority(f) === "critical"),
    high:     all.filter(f => getPriority(f) === "high"),
    medium:   all.filter(f => getPriority(f) === "medium"),
    low:      all.filter(f => getPriority(f) === "low"),
  };
}

function fileBlock(rel) {
  return [
    "//=================================================",
    `// FILE: /${toUnix(rel)}`,
    readText(rel),
    ""
  ].join("\n");
}

// -------------------- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞ --------------------
function headerBlock() {
  const now = new Date().toISOString().replace("T"," ").slice(0,19) + " UTC";
  return [
    rulesBlock(),
    metaBlock(),
    "–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:",
    buildFullTree(),
    `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${now}`,
    ""
  ].join("\n");
}

// -------------------- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã --------------------
function generateFull() {
  let out = headerBlock();

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium", "low"];
  for (const lvl of order) {
    for (const f of groups[lvl]) {
      out += fileBlock(f);
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

function generateAdaptive() {
  let out = headerBlock();
  let cur = countLines(out);
  const max = MAX_LINES;

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium"]; // low –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ adaptive —á–∞—â–µ –≤—Å–µ–≥–æ

  for (const lvl of order) {
    for (const f of groups[lvl]) {
      const block = fileBlock(f);
      const L = countLines(block);
      if (cur + L > max) {
        out += "\n// ... (truncate)\n";
        return out;
      }
      out += block; cur += L;
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

// -------------------- MAIN --------------------
function main() {
  if (MODE === "full" || MODE === "both") {
    fs.writeFileSync(FULL_FILE, generateFull(), "utf8");
    console.log(`‚úÖ ${FULL_FILE}`);
  }
  if (MODE === "adaptive" || MODE === "both") {
    fs.writeFileSync(ADAPTIVE_FILE, generateAdaptive(), "utf8");
    console.log(`‚úÖ ${ADAPTIVE_FILE}`);
  }
}

try { main(); } catch (e) { console.error("‚ùå", e); process.exit(1); }

//=================================================
// FILE: /news/news.json
{
  "items": [
    {
      "id": "2025-11-01-release",
      "title": "–ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ ‚Äî –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "date": "2025-11-01",
      "text": "–î–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
      "image": "img/logo.png",
      "tags": ["—Ä–µ–ª–∏–∑", "–∞–ª—å–±–æ–º"]
    },
    {
      "id": "2025-10-20-video",
      "title": "–ö–ª–∏–ø –Ω–∞ —Ç—Ä–µ–∫ ¬´–û—Ç—Ä–∞–∂–µ–Ω–∏–µ¬ª",
      "date": "2025-10-20",
      "embedUrl": "https://www.youtube.com/embed/dQw4w9WgXcQ",
      "tags": ["–∫–ª–∏–ø", "–≤–∏–¥–µ–æ"]
    },
    {
      "id": "2025-10-05-tour",
      "title": "–¢—É—Ä: –∑–∏–º–Ω–∏–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã",
      "date": "2025-10-05",
      "text": "–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü—Å–µ—Ç—è—Ö.",
      "tags": ["–∫–æ–Ω—Ü–µ—Ä—Ç—ã"]
    }
  ]
}

//=================================================
// FILE: /src/PlayerCore.js
// src/PlayerCore.js
// –Ø–¥—Ä–æ –ø–ª–µ–µ—Ä–∞ –Ω–∞ –±–∞–∑–µ Howler.js

(function PlayerCoreModule() {
  'use strict';

  class PlayerCore {
    constructor() {
      this.playlist = [];
      this.currentIndex = -1;
      this.sound = null;
      this.isReady = false;

      this.repeatMode = false;
      this.shuffleMode = false;
      this.originalPlaylist = [];

      // ‚úÖ Shuffle history (–∫–∞–∫ Spotify): —Å—Ç–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ (–ø–æ src)
      this.shuffleHistory = [];
      this.historyMax = 200;

      this.tickInterval = null;
      this.tickRate = 100; // –º—Å

      this.callbacks = {
        onTrackChange: [],
        onPlay: [],
        onPause: [],
        onStop: [],
        onEnd: [],
        onTick: [],
        onError: [],
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
        onSleepTriggered: []
      };

      this.metadata = {
        artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: '',
        cover: ''
      };

      // –¢–∞–π–º–µ—Ä —Å–Ω–∞
      this.sleepTimerTarget = 0;   // timestamp (ms) –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
      this.sleepTimerId = null;    // id setTimeout –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    }

    initialize() {
      console.log('üéµ PlayerCore initializing...');
      this.isReady = true;
      console.log('‚úÖ PlayerCore ready');
    }

    // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–õ–ï–ô–õ–ò–°–¢–û–ú ==========

    setPlaylist(tracks, startIndex = 0, metadata = {}, options = {}) {
      const wasPlaying = this.isPlaying();
      const prev = this.getCurrentTrack();
      const prevUid = prev?.uid || null;
      const prevPos = this.getPosition();
      const { preserveOriginalPlaylist = false, preserveShuffleMode = false, resetHistory = true } = options || {};

      this.playlist = (Array.isArray(tracks) ? tracks : []).map(t => ({
        src: t.src, title: t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', artist: t.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: t.album || '', cover: t.cover || '', lyrics: t.lyrics || null, fulltext: t.fulltext || null,
        uid: t.uid?.trim() || null, hasLyrics: t.hasLyrics ?? null, sourceAlbum: t.sourceAlbum || null
      }));

      if (!preserveOriginalPlaylist) {
        this.originalPlaylist = [...this.playlist];
      }
      this.metadata = { ...this.metadata, ...metadata };

      if (resetHistory) {
        this.shuffleHistory = [];
      }

      // –ï—Å–ª–∏ –ø–æ–ø—Ä–æ—Å–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å shuffleMode ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ñ–ª–∞–≥.
      // –ò–Ω–∞—á–µ –æ–Ω –¥–µ–π—Å—Ç–≤—É–µ—Ç –∫–∞–∫ —Ç–µ–∫—É—â–∏–π.
      if (!preserveShuffleMode) {
        // –Ω–∏—á–µ–≥–æ
      }

      if (this.shuffleMode) {
        this.shufflePlaylist();
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –ø–æ uid, –∏–Ω–∞—á–µ ‚Äî startIndex
      let nextIndex = -1;
      if (prevUid) {
        nextIndex = this.playlist.findIndex(t => t.uid && t.uid === prevUid);
      }
      if (nextIndex === -1) {
        nextIndex = Math.max(0, Math.min(startIndex, this.playlist.length - 1));
      }
      this.currentIndex = nextIndex;

      console.log(`‚úÖ Playlist set: ${this.playlist.length} tracks`);

      // –ï—Å–ª–∏ –∏–≥—Ä–∞–ª–æ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä–∞—Ç—å –±–µ–∑ onStop (—Ç–∏—Ö–∞—è —Å–º–µ–Ω–∞ Howl –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ load)
      if (wasPlaying && this.playlist.length > 0) {
        this.load(this.currentIndex, { autoPlay: true, resumePosition: prevPos });
      } else {
        const cur = this.getCurrentTrack();
        if (cur) {
          this.trigger('onTrackChange', cur, this.currentIndex);
          this.updateMediaSession();
        }
      }
    }

    getPlaylistSnapshot() {
      return [...this.playlist];
    }

    // ========== –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï ==========

    play(index = null) {
      if (index !== null && index >= 0 && index < this.playlist.length) {
        this.load(index);
      }

      // ‚úÖ History: —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ñ–∞–∫—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –Ω–æ–≤—ã–π —Ç—Ä–µ–∫ (–µ—Å–ª–∏ –æ–Ω —Ä–µ–∞–ª—å–Ω–æ —Å–º–µ–Ω–∏–ª—Å—è)
      this._pushHistoryForCurrent();
      
      if (!this.sound) {
        console.warn('‚ö†Ô∏è No sound loaded');
        return;
      }
      
      // Howler –≤—ã–∑–æ–≤–µ—Ç onplay ‚Üí —Ç–∞–º –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫ –∏ —Ç—Ä–∏–≥–≥–µ—Ä–∏–º onPlay.
      this.sound.play();
      this.updateMediaSession();
    }

    pause() {
      if (!this.sound) return;
      
      this.sound.pause();
      this.stopTick();
      this.trigger('onPause', this.getCurrentTrack(), this.currentIndex);
    }

    stop() {
      // ‚úÖ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è ‚Äú–∂—ë—Å—Ç–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞‚Äù, —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–∞—è –ø—Ä–∞–≤–∏–ª–∞–º–∏ (–∫–Ω–æ–ø–∫–∞ Stop).
      if (this.sound) {
        try { this.sound.stop(); } catch {}
        try { this.sound.unload(); } catch {}
        this.sound = null;
      }

      this.stopTick();
      this.trigger('onStop', this.getCurrentTrack(), this.currentIndex);
    }

    _silentUnloadCurrentSound() {
      // ‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ —Ç—Ä–µ–∫–∞/–ø–ª–µ–π–ª–∏—Å—Ç–∞: –ù–ï —Ç—Ä–∏–≥–≥–µ—Ä–∏–º onStop.
      if (this.sound) {
        try { this.sound.stop(); } catch {}
        try { this.sound.unload(); } catch {}
        this.sound = null;
      }
      this.stopTick();
    }

    load(index, options = {}) {
      // ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
      if (typeof index !== 'number' || !Number.isFinite(index) || index < 0 || index >= this.playlist.length) {
        console.warn('‚ö†Ô∏è PlayerCore.load called with invalid index:', index);
        return;
      }

      const { autoPlay = false, resumePosition = null } = options || {};

      // ‚úÖ –ù–ï–õ–¨–ó–Ø stop(): —ç—Ç–æ –Ω–∞—Ä—É—à–∏—Ç –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ.
      this._silentUnloadCurrentSound();

      this.currentIndex = index;

      const track = this.playlist[index];

      this.sound = new Howl({
        src: [track.src],
        html5: true,
        preload: true,
        volume: this.getVolume() / 100,
        onplay: () => {
          this.startTick();
          this.trigger('onPlay', track, index);
        },
        onpause: () => {
          this.stopTick();
          this.trigger('onPause', track, index);
        },
        onend: () => {
          this.stopTick();
          this.trigger('onEnd', track, index);
          this.handleTrackEnd();
        },
        onload: () => {
          if (typeof resumePosition === 'number' && Number.isFinite(resumePosition) && resumePosition > 0) {
            try { this.seek(resumePosition); } catch {}
          }
          if (autoPlay) {
            try { this.play(); } catch {}
          }
        },
        onloaderror: (id, error) => {
          console.error('‚ùå Load error:', error);
          this.trigger('onError', { type: 'load', error, track, index });
        },
        onplayerror: (id, error) => {
          console.error('‚ùå Play error:', error);
          this.trigger('onError', { type: 'play', error, track, index });
        }
      });

      this.trigger('onTrackChange', track, index);
      this.updateMediaSession();
    }

    handleTrackEnd() {
      if (this.repeatMode) {
        this.play(this.currentIndex);
      } else {
        this.next();
      }
    }

    next() {
      if (this.playlist.length === 0) return;

      // ‚úÖ –ü—Ä–∏ next() –º—ã –¥–æ–ª–∂–Ω—ã –∑–∞–ø–æ–º–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏, —á—Ç–æ–±—ã prev –º–æ–≥ –≤–µ—Ä–Ω—É—Ç—å—Å—è ‚Äú–∫–∞–∫ Spotify‚Äù.
      this._pushHistoryForCurrent();

      // –°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ –ø–æ —Ç–µ–∫—É—â–µ–º—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –ø–ª–µ–π–ª–∏—Å—Ç—É
      let nextIndex = this.currentIndex + 1;

      if (nextIndex >= this.playlist.length) {
        nextIndex = 0;
      }

      this.play(nextIndex);
    }

    prev() {
      if (this.playlist.length === 0) return;

      // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ–º –±–æ–ª—å—à–µ 3 —Å–µ–∫—É–Ω–¥, –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º –Ω–∞ –Ω–∞—á–∞–ª–æ
      if (this.getPosition() > 3) {
        this.seek(0);
        return;
      }

      // ‚úÖ Shuffle history (–∫–∞–∫ Spotify): –µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–Ω–æ–º—É
      const histIdx = this._popHistoryPrevIndex();
      if (typeof histIdx === 'number' && histIdx >= 0) {
        this.play(histIdx);
        return;
      }

      // ‚úÖ Fallback: –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ —Ç–µ–∫—É—â–µ–º—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –ø–ª–µ–π–ª–∏—Å—Ç—É
      let prevIndex = this.currentIndex - 1;

      if (prevIndex < 0) {
        prevIndex = this.playlist.length - 1;
      }

      this.play(prevIndex);
    }

    // ========== –ü–ï–†–ï–ú–û–¢–ö–ê –ò –ü–û–ó–ò–¶–ò–Ø ==========

    seek(seconds) {
      if (!this.sound) return;
      this.sound.seek(seconds);
    }

    getPosition() {
      if (!this.sound) return 0;
      return this.sound.seek() || 0;
    }

    getDuration() {
      if (!this.sound) return 0;
      return this.sound.duration() || 0;
    }

    // ========== –ì–†–û–ú–ö–û–°–¢–¨ ==========

    setVolume(percent) {
      const volume = Math.max(0, Math.min(100, percent)) / 100;
      
      if (this.sound) {
        this.sound.volume(volume);
      }
      
      Howler.volume(volume);
      localStorage.setItem('playerVolume', Math.round(percent));
    }

    getVolume() {
      const saved = localStorage.getItem('playerVolume');
      return saved !== null ? parseInt(saved, 10) : 100;
    }

    setMuted(muted) {
      if (this.sound) {
        this.sound.mute(muted);
      } else {
        Howler.mute(muted);
      }
    }

    // ========== –†–ï–ñ–ò–ú–´ –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø ==========

    toggleRepeat() {
      this.repeatMode = !this.repeatMode;
      console.log(`üîÅ Repeat: ${this.repeatMode}`);
    }

    isRepeat() {
      return this.repeatMode;
    }

    setShuffleMode(enabled) {
      const next = !!enabled;
      if (this.shuffleMode === next) return;

      this.shuffleMode = next;

      if (this.shuffleMode) {
        this.shufflePlaylist();
      } else {
        this.playlist = [...this.originalPlaylist];
      }

      console.log(`üîÄ Shuffle: ${this.shuffleMode}`);
    }

    toggleShuffle() {
      this.setShuffleMode(!this.shuffleMode);
    }

    isShuffle() {
      return this.shuffleMode;
    }

    shufflePlaylist() {
      const currentTrack = this.playlist[this.currentIndex];

      // ‚úÖ –ü—Ä–∏ reshuffle —Å–±—Ä–∞—Å—ã–≤–∞–µ–º history, —á—Ç–æ–±—ã prev –Ω–µ –ø—Ä—ã–≥–∞–ª –≤ ‚Äú—Å—Ç–∞—Ä—ã–µ‚Äù –∏–Ω–¥–µ–∫—Å—ã –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
      this.shuffleHistory = [];
      
      const shuffled = [...this.playlist];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      
      this.playlist = shuffled;
      
      if (currentTrack) {
        this.currentIndex = this.playlist.findIndex(t => t.src === currentTrack.src);
      }
    }

    // ========== –ö–ê–ß–ï–°–¢–í–û –ó–í–£–ö–ê ==========

    setQuality(quality) {
      // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
      console.log(`üéµ Quality set to: ${quality}`);
    }

    // ========== –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• ==========

    getCurrentTrack() {
      if (this.currentIndex < 0 || this.currentIndex >= this.playlist.length) {
        return null;
      }
      return this.playlist[this.currentIndex];
    }

    getIndex() {
      return this.currentIndex;
    }

    getNextIndex() {
      if (this.playlist.length === 0) return -1;
      
      let nextIndex = this.currentIndex + 1;
      if (nextIndex >= this.playlist.length) {
        nextIndex = 0;
      }
      
      return nextIndex;
    }

    isPlaying() {
      return this.sound ? this.sound.playing() : false;
    }

    // ========== –°–û–ë–´–¢–ò–Ø ==========

    on(events) {
      Object.keys(events).forEach(event => {
        if (this.callbacks[event]) {
          this.callbacks[event].push(events[event]);
        }
      });
    }

    trigger(event, ...args) {
      if (this.callbacks[event]) {
        this.callbacks[event].forEach(callback => {
          try {
            callback(...args);
          } catch (error) {
            console.error(`Error in ${event} callback:`, error);
          }
        });
      }
    }

    // ========== –¢–ò–ö (–û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–û–ì–†–ï–°–°–ê) ==========

    startTick() {
      this.stopTick();
      
      this.tickInterval = setInterval(() => {
        const position = this.getPosition();
        const duration = this.getDuration();
        this.trigger('onTick', position, duration);
      }, this.tickRate);
    }

    stopTick() {
      if (this.tickInterval) {
        clearInterval(this.tickInterval);
        this.tickInterval = null;
      }
    }

    // ========== –¢–ê–ô–ú–ï–† –°–ù–ê ==========

    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä —Å–Ω–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥.
     * –ü–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—é –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–ª–µ–µ—Ä –∂—ë—Å—Ç–∫–æ, –∞:
     *  - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ onSleepTriggered,
     *  - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (SleepTimerModule) —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å (–ø–æ –¢–ó: –∏–º–µ–Ω–Ω–æ —Ç–∞–π–º–µ—Ä –º–æ–∂–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ø/–ø–∞—É–∑—É).
     */
    setSleepTimer(ms) {
      const delay = Number(ms) || 0;
      if (delay <= 0) {
        this.clearSleepTimer();
        return;
      }

      const now = Date.now();
      this.sleepTimerTarget = now + delay;

      if (this.sleepTimerId) {
        clearTimeout(this.sleepTimerId);
        this.sleepTimerId = null;
      }

      this.sleepTimerId = setTimeout(() => {
        this.sleepTimerId = null;
        const target = this.sleepTimerTarget;
        this.sleepTimerTarget = 0;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ ‚Äî UI/–º–æ–¥—É–ª–∏ —Ä–µ—à–∞—é—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å (—Å—Ç–æ–ø/–ø–∞—É–∑–∞ –∏ —Ç.–ø.)
        this.trigger('onSleepTriggered', { targetAt: target });

        // –ü–æ –±–∞–∑–æ–≤–æ–º—É –ø—Ä–∞–≤–∏–ª—É: –∏–º–µ–Ω–Ω–æ —Ç–∞–π–º–µ—Ä —Å–Ω–∞ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É,
        // –Ω–æ –¥–µ–ª–∞–µ–º —ç—Ç–æ –º—è–≥–∫–æ: –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –≤ onSleepTriggered —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª –ø–ª–µ–µ—Ä,
        // –≤—Ç–æ—Ä–∏—á–Ω–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.
        if (this.isPlaying()) {
          try {
            this.pause();
          } catch (e) {
            console.warn('Sleep timer pause failed:', e);
          }
        }
      }, delay);
    }

    /**
     * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä —Å–Ω–∞.
     */
    clearSleepTimer() {
      if (this.sleepTimerId) {
        clearTimeout(this.sleepTimerId);
        this.sleepTimerId = null;
      }
      this.sleepTimerTarget = 0;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç absolute timestamp (ms) —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞, –ª–∏–±–æ 0, –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
     */
    getSleepTimerTarget() {
      return this.sleepTimerTarget || 0;
    }

    updateMediaSession() {
      if (!('mediaSession' in navigator)) return;

      const track = this.getCurrentTrack();
      if (!track) return;

      const artworkUrl = track.cover || this.metadata.cover || 'icons/icon-512.png';
      const artwork = artworkUrl ? [
        { src: artworkUrl, sizes: '96x96', type: 'image/png' },
        { src: artworkUrl, sizes: '128x128', type: 'image/png' },
        { src: artworkUrl, sizes: '192x192', type: 'image/png' },
        { src: artworkUrl, sizes: '256x256', type: 'image/png' },
        { src: artworkUrl, sizes: '384x384', type: 'image/png' },
        { src: artworkUrl, sizes: '512x512', type: 'image/png' }
      ] : [];

      navigator.mediaSession.metadata = new MediaMetadata({
        title: track.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
        artist: track.artist || this.metadata.artist,
        album: track.album || this.metadata.album,
        artwork
      });

      // action handlers ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
      navigator.mediaSession.setActionHandler('play', () => this.play());
      navigator.mediaSession.setActionHandler('pause', () => this.pause());
      navigator.mediaSession.setActionHandler('stop', () => this.stop());
      navigator.mediaSession.setActionHandler('previoustrack', () => this.prev());
      navigator.mediaSession.setActionHandler('nexttrack', () => this.next());

      navigator.mediaSession.setActionHandler('seekbackward', (details) => {
        const skipTime = details?.seekOffset || 10;
        this.seek(Math.max(0, this.getPosition() - skipTime));
      });

      navigator.mediaSession.setActionHandler('seekforward', (details) => {
        const skipTime = details?.seekOffset || 10;
        this.seek(Math.min(this.getDuration(), this.getPosition() + skipTime));
      });

      navigator.mediaSession.setActionHandler('seekto', (details) => {
        const t = details?.seekTime;
        if (typeof t !== 'number') return;
        // Howler –Ω–µ –¥–∞—ë—Ç fastSeek —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∞ Howl; –∏—Å–ø–æ–ª—å–∑—É–µ–º seek.
        this.seek(t);
      });
    }

    // ========== –£–¢–ò–õ–ò–¢–´ ==========

    _pushHistoryForCurrent() {
      // –ò—Å—Ç–æ—Ä–∏—è –Ω—É–∂–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –¥–ª—è shuffle, –Ω–æ –º—ã –Ω–µ –∑–∞–ø—Ä–µ—â–∞–µ–º –ø–∏—Å–∞—Ç—å –µ—ë –∏ –±–µ–∑ shuffle.
      // –í–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç: —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤–ª–∏—è—Ç—å –Ω–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
      try {
        const track = this.getCurrentTrack();
        if (!track || !track.src) return;

        const src = track.src;

        const last = this.shuffleHistory.length ? this.shuffleHistory[this.shuffleHistory.length - 1] : null;
        if (last && last.src === src) return;

        this.shuffleHistory.push({ src });

        if (this.shuffleHistory.length > this.historyMax) {
          this.shuffleHistory.splice(0, this.shuffleHistory.length - this.historyMax);
        }
      } catch {}
    }

    _popHistoryPrevIndex() {
      try {
        if (!this.shuffleMode) return -1;
        if (!Array.isArray(this.shuffleHistory) || this.shuffleHistory.length === 0) return -1;

        // pop —Ç–µ–∫—É—â—É—é ‚Äú—Ç–æ—á–∫—É‚Äù, –∑–∞—Ç–µ–º –±–µ—Ä—ë–º –ø—Ä–µ–¥—ã–¥—É—â—É—é
        const popped = this.shuffleHistory.pop();
        const prev = this.shuffleHistory.length ? this.shuffleHistory[this.shuffleHistory.length - 1] : null;

        const src = prev?.src || null;
        if (!src) return -1;

        const idx = this.playlist.findIndex(t => t && t.src === src);
        return idx >= 0 ? idx : -1;
      } catch {
        return -1;
      }
    }

    appendToPlaylistTail(tracks) {
      // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏ –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PlaybackPolicy 6.2)
      const list = Array.isArray(tracks) ? tracks : [];
      if (list.length === 0) return;

      const existing = new Set(this.playlist.map(t => String(t?.src || '').trim()).filter(Boolean));
      const toAdd = [];

      for (const t of list) {
        const src = String(t?.src || '').trim();
        if (!src) continue;
        if (existing.has(src)) continue;
        existing.add(src);
        toAdd.push({
          src,
          title: t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
          artist: t.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          album: t.album || '',
          cover: t.cover || '',
          lyrics: t.lyrics || null,
          fulltext: t.fulltext || null,
          uid: (typeof t.uid === 'string' && t.uid.trim()) ? t.uid.trim() : null,
          sourceAlbum: t.sourceAlbum || null
        });
      }

      if (toAdd.length === 0) return;

      // –í–ê–ñ–ù–û: originalPlaylist —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å ‚Äî —ç—Ç–æ ‚Äú–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã‚Äù.
      // –í —Ç–µ–∫—É—â–µ–º shuffled/favorites-only –ø–ª–µ–π–ª–∏—Å—Ç–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Ö–≤–æ—Å—Ç.
      this.playlist = this.playlist.concat(toAdd);
    }

    removeFromPlaylistTailIfNotPlayed(params = {}) {
      // ‚úÖ ‚Äú–£–º–Ω—ã–π Spotify‚Äù: —É–±—Ä–∞—Ç—å —Ç—Ä–µ–∫ –∏–∑ –æ—á–µ—Ä–µ–¥–∏, –µ—Å–ª–∏:
      // - –æ–Ω –Ω–µ —Ç–µ–∫—É—â–∏–π
      // - –æ–Ω –µ—â—ë –Ω–µ –≤—Å—Ç—Ä–µ—á–∞–ª—Å—è –≤ shuffleHistory
      // - –æ–Ω –µ—Å—Ç—å –≤ –ø–ª–µ–π–ª–∏—Å—Ç–µ (–æ–±—ã—á–Ω–æ –±–ª–∏–∂–µ –∫ —Ö–≤–æ—Å—Ç—É)
      const uid = String(params?.uid || '').trim();
      if (!uid) return false;

      const current = this.getCurrentTrack();
      const currentUid = String(current?.uid || '').trim();
      if (currentUid && currentUid === uid) return false;

      // –£–∂–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–ª—Å—è?
      const srcToCheck = (() => {
        const t = this.playlist.find(x => String(x?.uid || '').trim() === uid) || null;
        return t?.src || null;
      })();

      if (!srcToCheck) return false;

      const played = Array.isArray(this.shuffleHistory)
        ? this.shuffleHistory.some(h => h && h.src === srcToCheck)
        : false;

      if (played) return false;

      const beforeLen = this.playlist.length;
      this.playlist = this.playlist.filter(t => String(t?.uid || '').trim() !== uid);

      // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ currentIndex –µ—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç ‚Äú–¥–æ‚Äù —Ç–µ–∫—É—â–µ–≥–æ
      if (this.currentIndex >= this.playlist.length) {
        this.currentIndex = this.playlist.length - 1;
      }

      return this.playlist.length !== beforeLen;
    }

    getAudioElement() {
      // Howler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Web Audio API, –Ω–æ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å HTML5 audio
      if (this.sound && this.sound._sounds && this.sound._sounds[0]) {
        return this.sound._sounds[0]._node;
      }
      return null;
    }

    destroy() {
      this.stop();
      this.playlist = [];
      this.originalPlaylist = [];
      this.currentIndex = -1;
      this.callbacks = {
        onTrackChange: [],
        onPlay: [],
        onPause: [],
        onStop: [],
        onEnd: [],
        onTick: [],
        onError: []
      };
      console.log('üóëÔ∏è PlayerCore destroyed');
    }
  }

  // –°–æ–∑–¥–∞—ë–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
  window.playerCore = new PlayerCore();

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.playerCore.initialize();
    });
  } else {
    window.playerCore.initialize();
  }

  console.log('‚úÖ PlayerCore module loaded');

})();

//=================================================
// FILE: /styles/main.css
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   –í–ò–¢–†–ò–ù–ê –†–ê–ó–ë–ò–¢–ê ‚Äî PWA Music Player
   –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ v8.0.4
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* === –ü–ï–†–ï–ú–ï–ù–ù–´–ï === */
:root {
  --bg: #181818;
  --bg-card: #1e222d;
  --bg-modal: #252d39;
  --red: #E80100;
  --red-dark: #c60000;
  --blue: #4daaff;
  --blue-dark: #357ac9;
  --green: #27b34c;
  --orange: #ff9800;
  --purple: #8a2be2;
  --text: #f2f2f2;
  --text-muted: #8ab8fd;
  --text-dim: #5a6989;
  --border: #394866;
  --shadow: rgba(0, 0, 0, 0.3);
  --shadow-strong: rgba(0, 0, 0, 0.5);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --transition: 0.2s ease;
}

/* === –°–ë–†–û–° –ò –ë–ê–ó–ê === */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }

body {
  min-height: 100vh;
  min-height: 100dvh;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  display: flex;
  flex-direction: column;
  padding-top: env(safe-area-inset-top);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}

.hidden { display: none !important; }

/* === –ü–†–û–ú–û–ö–û–î === */
#promocode-block {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  z-index: 100;
}

.promo-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: rgba(15, 18, 24, 0.98);
  border-radius: 16px;
  box-shadow: 0 6px 24px var(--shadow-strong);
  padding: 36px 26px 32px;
  min-width: 280px;
  max-width: 90vw;
}

.promo-cover {
  width: 256px;
  height: 256px;
  max-width: 70vw;
  max-height: 70vw;
  object-fit: cover;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.7);
  margin-bottom: 19px;
}

.promo-inner h2 {
  margin-bottom: 16px;
  color: var(--blue);
  font-size: 20px;
}

#promo-inp {
  padding: 12px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.1);
  color: var(--text);
  margin: 10px 0;
  width: 100%;
  max-width: 280px;
  font-size: 16px;
  outline: none;
  transition: border-color var(--transition);
}

#promo-inp:focus { border-color: var(--blue); }
#promo-inp.error { border-color: var(--red); animation: shake 0.3s; }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

#promo-btn {
  padding: 12px 32px;
  background: var(--red);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  transition: opacity var(--transition), transform var(--transition);
  margin-top: 8px;
}

#promo-btn:hover { opacity: 0.9; transform: translateY(-1px); }
#promo-btn:active { transform: translateY(0); }

#promo-error {
  color: #ff6b6b;
  margin-top: 12px;
  font-size: 14px;
  min-height: 20px;
  text-align: center;
}

/* === –û–°–ù–û–í–ù–û–ô –ë–õ–û–ö === */
#main-block {
  max-width: 420px;
  margin: 0 auto;
  flex: 1 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  padding: 0 10px;
  padding-bottom: env(safe-area-inset-bottom);
}

header { width: 100%; text-align: center; }

/* === –ó–ê–ì–û–õ–û–í–û–ö –ê–õ–¨–ë–û–ú–ê === */
.active-album-title {
  width: 100%;
  max-width: 400px;
  margin: 18px auto 6px;
  text-align: center;
  color: #eaf2ff;
  font-weight: 900;
  line-height: 1.15;
  font-size: clamp(18px, 4.6vw, 24px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.active-album-title.fav { color: #ffd166; }
.active-album-title.news { color: var(--text-muted); }

/* === –ò–ö–û–ù–ö–ò –ê–õ–¨–ë–û–ú–û–í === */
.album-icons {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px;
  align-items: center;
  justify-items: center;
  margin: 12px auto 0;
  max-width: 400px;
  width: 100%;
  padding: 4px 8px;
}

.album-icon[data-album="__favorites__"] { grid-row: 2; grid-column: 2; }
.album-icon[data-album="__reliz__"] { grid-row: 2; grid-column: 3; }

.album-icon {
  --size: clamp(62px, 16vw, 82px);
  width: var(--size);
  height: var(--size);
  border-radius: var(--radius-md);
  overflow: hidden;
  border: 1px solid var(--border);
  cursor: pointer;
  filter: grayscale(70%) brightness(0.88);
  opacity: 0.72;
  transition: all 0.15s ease;
}

.album-icon img { width: 100%; height: 100%; object-fit: cover; }

.album-icon.active {
  --size: clamp(68px, 17vw, 88px);
  filter: none;
  opacity: 1;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
}

.album-icon:hover:not(.active) {
  transform: translateY(-2px);
  opacity: 0.9;
}

/* === –û–ë–õ–û–ñ–ö–ê === */
#cover-wrap {
  width: 100%;
  max-width: 400px;
  margin: 14px auto 0;
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.cover-gallery-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 2;
  border: none;
  cursor: pointer;
  background: none;
  padding: 0;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  visibility: hidden;
  pointer-events: none;
  transition: opacity var(--transition);
}

#cover-gallery-arrow-left { left: 7px; }
#cover-gallery-arrow-right { right: 7px; }

#cover-wrap.gallery-nav-ready .cover-gallery-arrow {
  visibility: visible;
  pointer-events: auto;
}

.cover-gallery-arrow:hover { opacity: 0.8; }

#cover-slot {
  width: 100%;
  height: 100%;
  border-radius: 12px;
  overflow: hidden;
  background: var(--bg);
  box-shadow: 0 4px 24px var(--shadow);
}

#cover-slot img,
#cover-slot iframe {
  width: 100%;
  height: 100%;
  display: block;
  border: 0;
}

#cover-slot img { object-fit: contain; }

/* === –°–û–¶–ò–ê–õ–¨–ù–´–ï –°–°–´–õ–ö–ò === */
.socials-under-cover {
  margin: 14px auto 0;
  width: 100%;
  max-width: 398px;
  text-align: center;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
}

.socials-under-cover a {
  color: var(--blue);
  text-decoration: none;
  padding: 4px 8px;
  transition: color var(--transition);
}

.socials-under-cover a:hover {
  color: var(--text);
  text-decoration: underline;
}

/* === –ü–õ–ï–ï–† === */
.lyrics-player-block {
  max-width: 370px;
  width: 100%;
  margin: 20px auto 0;
  background: linear-gradient(180deg, rgba(30, 34, 45, 0.95), rgba(15, 18, 24, 0.98));
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  position: relative;
  z-index: 10;
  isolation: isolate;
}

/* === –û–ö–ù–û –õ–ò–†–ò–ö–ò === */
#lyrics-window {
  position: relative;
  overflow: hidden;
  border-radius: 12px 12px 0 0;
  background: #0f1218;
}

#lyrics-window.lyrics-normal { height: 8.7em; }
#lyrics-window.lyrics-hidden { height: 0 !important; opacity: 0 !important; pointer-events: none !important; }
#lyrics-window.lyrics-expanded { height: 15.6em; }

.lyrics-scroll {
  display: flex;
  flex-direction: column;
  justify-content: center;
  height: 100%;
  overflow: hidden;
  position: relative;
  z-index: 1;
  scrollbar-width: none;
}

.lyrics-scroll::-webkit-scrollbar { display: none; }

.lyrics-window-line {
  text-align: center;
  padding: 6px 16px;
  color: #eee;
  font-size: 15px;
  opacity: 0.57;
  transition: all 0.25s ease;
  user-select: none;
  line-height: 1.35;
}

.lyrics-window-line.active {
  color: var(--red);
  font-size: 1.19em;
  font-weight: bold;
  opacity: 1;
  background: rgba(0, 0, 0, 0.07);
}

.lyrics-placeholder {
  text-align: center;
  padding: 40px 16px;
  color: var(--text-dim);
  font-size: 14px;
  opacity: 0.6;
}

.lyrics-spinner {
  width: 40px;
  height: 40px;
  margin: 40px auto;
  border: 4px solid rgba(77, 170, 255, 0.2);
  border-top-color: var(--blue);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.lyrics-countdown {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 4em;
  font-weight: 900;
  color: rgba(77, 170, 255, 0.35);
  pointer-events: none;
  animation: countdownPulse 1s ease-in-out infinite;
}

@keyframes countdownPulse {
  0%, 100% { transform: scale(1); opacity: 0.35; }
  50% { transform: scale(1.05); opacity: 0.45; }
}

.lyrics-animated-bg {
  position: absolute;
  inset: 0;
  opacity: 0;
  pointer-events: none;
  z-index: 0;
  background: linear-gradient(45deg, rgba(232, 1, 0, 0.15), rgba(77, 170, 255, 0.15), rgba(232, 1, 0, 0.15));
  background-size: 400% 400%;
}

.lyrics-animated-bg.active {
  opacity: 1;
  animation: lyricsGradient 10s ease infinite;
}

@keyframes lyricsGradient {
  0% { background-position: 0 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0 50%; }
}

/* === –ü–†–û–ì–†–ï–°–°-–ë–ê–† === */
.player-progress-wrapper { padding: 16px 20px 12px; }

.player-progress-bar {
  position: relative;
  height: 6px;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 3px;
  cursor: pointer;
}

.player-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--blue), var(--blue-dark));
  border-radius: 3px;
  width: 0;
  transition: width 0.1s linear;
  position: relative;
}

.player-progress-handle {
  position: absolute;
  right: -7px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
  opacity: 0;
  transition: opacity var(--transition);
}

.player-progress-bar:hover .player-progress-handle { opacity: 1; }

.time-row {
  display: flex;
  justify-content: space-between;
  color: var(--text-muted);
  font-size: 12px;
  margin-top: 8px;
  font-variant-numeric: tabular-nums;
}

/* === –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø === */
.player-controls {
  padding: 14px 18px 16px;
  background: rgba(25, 28, 36, 0.8);
}

.player-controls-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.player-controls-row:last-child { margin-bottom: 0; }

.time-in-controls {
  color: var(--text-muted);
  font-size: 13px;
  min-width: 42px;
  text-align: center;
  font-variant-numeric: tabular-nums;
}

.player-control-btn {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text-muted);
  cursor: pointer;
  padding: 10px;
  border-radius: 50%;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
}

.player-control-btn:hover {
  background: rgba(77, 170, 255, 0.15);
  border-color: rgba(77, 170, 255, 0.3);
  transform: scale(1.05);
}

.player-control-btn:active { transform: scale(0.98); }

.player-control-btn.main {
  background: var(--red);
  border-color: var(--red);
  color: #fff;
  width: 52px;
  height: 52px;
}

.player-control-btn.main:hover { background: var(--red-dark); }

.player-control-btn svg { width: 20px; height: 20px; }
.player-control-btn.main svg { width: 24px; height: 24px; }

.player-control-btn.active {
  background: rgba(77, 170, 255, 0.2);
  border-color: var(--blue);
  color: var(--blue);
  box-shadow: 0 0 12px rgba(77, 170, 255, 0.3);
}

/* === FIX: –ó–≤–µ–∑–¥–∞ –≤ –∫–Ω–æ–ø–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ === */
#favorites-btn {
  overflow: hidden;
  position: relative;
}

#favorites-btn img,
#favorites-btn-icon {
  width: 20px;
  height: 20px;
  max-width: 20px;
  max-height: 20px;
  object-fit: contain;
  display: block;
  pointer-events: none;
}

/* === FIX: –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –ø–ª–µ–µ—Ä–µ === */
#favorites-btn.favorites-active {
  background: rgba(255, 215, 0, 0.2);
  border-color: #ffd700;
}

#favorites-btn.favorites-active img,
#favorites-btn.favorites-active #favorites-btn-icon {
  filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.5));
}

/* === –¢–ê–ô–ú–ï–† –°–ù–ê === */
.sleep-timer-btn {
  position: relative;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text-muted);
  cursor: pointer;
  padding: 10px;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sleep-timer-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--red);
  color: #fff;
  font-size: 10px;
  font-weight: bold;
  border-radius: 10px;
  padding: 2px 6px;
  min-width: 18px;
  text-align: center;
}

.sleep-menu {
  position: fixed;
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 8px;
  box-shadow: 0 4px 20px var(--shadow-strong);
  min-width: 180px;
  z-index: 100;
}

.sleep-menu-item {
  padding: 10px 14px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 14px;
  transition: background var(--transition);
}

.sleep-menu-item:hover { background: rgba(77, 170, 255, 0.15); }
.sleep-menu-item.active { background: rgba(77, 170, 255, 0.2); color: var(--blue); }

/* === –ì–†–û–ú–ö–û–°–¢–¨ === */
.volume-control-wrapper {
  position: relative;
  padding: 16px 20px 12px;
  background: rgba(15, 18, 24, 0.5);
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.volume-track {
  position: relative;
  height: 6px;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 3px;
}

.volume-fill {
  position: absolute;
  left: 0;
  top: 0;
  height: 6px;
  background: linear-gradient(90deg, var(--blue), var(--blue-dark));
  width: 0;
  border-radius: 3px;
  pointer-events: none;
}

.volume-handle {
  position: absolute;
  top: 50%;
  left: 0;
  transform: translate(-50%, -50%);
  width: 14px;
  height: 14px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
  pointer-events: none;
  z-index: 3;
}

.volume-slider {
  position: absolute;
  left: 20px;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  height: 28px;
  background: transparent;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
  z-index: 4;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: transparent;
  border-radius: 50%;
  cursor: pointer;
}

.volume-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  background: transparent;
  border: none;
  border-radius: 50%;
  cursor: pointer;
}

/* === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò === */
.player-buttons-wrapper {
  background: rgba(15, 18, 24, 0.5);
  padding: 12px 16px;
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.player-extra-buttons-row {
  display: flex;
  flex: 1;
  gap: 8px;
  justify-content: space-between;
  width: 100%;
}

.lyrics-toggle-btn,
.animation-btn,
.pulse-btn,
.karaoke-btn,
.player-download-btn,
.eco-btn {
  width: 44px;
  min-width: 44px;
  max-width: 44px;
  height: 44px;
  min-height: 44px;
  max-height: 44px;
  padding: 0;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.lyrics-toggle-btn {
  background: rgba(77, 170, 255, 0.12);
  border: 1px solid rgba(77, 170, 255, 0.25);
  color: var(--blue);
}

.lyrics-toggle-btn.lyrics-hidden {
  background: rgba(232, 1, 0, 0.12);
  border-color: rgba(232, 1, 0, 0.25);
}

.lyrics-toggle-btn.disabled,
.animation-btn.disabled,
.karaoke-btn.disabled {
  background: rgba(30, 30, 30, 0.6) !important;
  border-color: rgba(255, 255, 255, 0.06) !important;
  color: rgba(255, 255, 255, 0.2) !important;
  cursor: not-allowed !important;
  opacity: 0.5;
  pointer-events: none;
  filter: grayscale(100%);
}

.animation-btn {
  background: linear-gradient(135deg, #4a1a7a, #2a0a4a);
  border: 1px solid rgba(138, 43, 226, 0.3);
  color: #c8a2ff;
}

.animation-btn.active {
  background: linear-gradient(135deg, #5a2a8a, #3a1a5a);
  box-shadow: 0 0 12px rgba(138, 43, 226, 0.4);
}

.pulse-btn {
  background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: #fff;
  font-size: 20px;
}

.pulse-btn.active {
  background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
  border-color: rgba(232, 1, 0, 0.3);
  color: var(--red);
}

.karaoke-btn {
  background: linear-gradient(135deg, #4a1a7a, #2a0a4a);
  border: 1px solid rgba(138, 43, 226, 0.3);
  color: #c8a2ff;
}

.player-download-btn {
  background: linear-gradient(135deg, #1a4a7a, #0a2a4a);
  border: 1px solid rgba(77, 170, 255, 0.3);
  color: var(--blue);
  text-decoration: none;
}

.eco-btn {
  background: linear-gradient(135deg, #1a7a4a, #0a4a2a);
  border: 1px solid rgba(39, 179, 76, 0.3);
  color: var(--green);
}

.eco-btn svg { width: 16px; height: 16px; }

/* === –°–ü–ò–°–û–ö –¢–†–ï–ö–û–í === */
.track-list {
  margin: 0 auto;
  max-width: 370px;
  width: 100%;
  font-size: 1.05em;
  color: #eee;
  position: relative;
  z-index: 1;
}

.track-list.filtered .track:not(.is-favorite) { display: none !important; }

.track {
  display: flex;
  align-items: center;
  padding: 9px 10px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.13s ease;
  position: relative;
  z-index: 1;
  overflow: hidden;
}

.track:hover { background: rgba(255, 255, 255, 0.05); }

.track.current {
  background: #232b38;
  border-left: 3px solid var(--blue);
}

.track.inactive {
  opacity: 0.45;
  filter: grayscale(0.6);
}

.track.is-favorite { background: rgba(77, 170, 255, 0.06); }

.tnum {
  min-width: 30px;
  color: var(--text-muted);
  font-weight: 500;
}

.track-title {
  margin-left: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.like-star {
  margin-left: auto;
  width: 20px;
  height: 20px;
  min-width: 20px;
  max-width: 20px;
  cursor: pointer;
  opacity: 0.97;
  transition: transform var(--transition);
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

.like-star:hover {
  filter: brightness(1.13);
  transform: scale(1.15);
}

/* === –õ–û–ì–û–¢–ò–ü === */
.logo-bottom {
  max-width: 112px;
  width: 23vw;
  min-width: 66px;
  height: auto;
  display: block;
  margin: 0 auto 15px !important;
  cursor: pointer;
  transition: transform 0.05s ease-out !important;
  will-change: transform;
}

.logo-bottom:hover { transform: scale(1.02); }
.logo-bottom:active { transform: scale(0.98); }

/* === –ù–ò–ñ–ù–ò–ï –ö–ù–û–ü–ö–ò === */
.bottom-controls-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 32px auto 0;
  gap: 10px;
  width: 100%;
  max-width: 300px;
  padding-bottom: env(safe-area-inset-bottom);
}

.filter-favorites-btn {
  display: block;
  margin: 0 auto 15px;
  padding: 12px 20px;
  background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
  color: var(--blue);
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 0.95em;
  font-weight: bold;
  cursor: pointer;
  width: 100%;
  box-shadow: 0 2px 8px var(--shadow);
  transition: all var(--transition);
}

.filter-favorites-btn:hover {
  background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
  border-color: var(--blue);
  transform: translateY(-2px);
}

.filter-favorites-btn.filtered {
  background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
  border-color: var(--red);
  color: #fff;
}

#install-pwa-btn,
#download-album-main {
  color: #fff;
  background: var(--blue);
  border: none;
  border-radius: 8px;
  font-size: 1.07em;
  font-weight: bold;
  margin: 8px 0;
  padding: 12px 18px;
  cursor: pointer;
  width: 100%;
  box-shadow: 0 4px 14px var(--shadow);
  transition: all var(--transition);
}

#install-pwa-btn:hover,
#download-album-main:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--shadow);
}

#download-album-main { background: var(--red); }

.feedback-link,
.support-link,
.hotkeys-btn {
  color: var(--blue) !important;
  text-decoration: underline !important;
  font-weight: 700;
  text-transform: uppercase;
  cursor: pointer;
  font-size: 1em;
  display: block;
  text-align: center;
  width: 100%;
  margin: 6px 0;
  background: none;
  border: none;
  padding: 8px;
  transition: opacity var(--transition);
}

.feedback-link:hover,
.support-link:hover,
.hotkeys-btn:hover { opacity: 0.8; }

.offline-btn {
  min-width: 110px;
  height: 40px;
  font-size: 1.05em;
  font-weight: bold;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(6, 0, 0, 0.2);
  display: block;
  margin: 10px auto 0;
  transition: all var(--transition);
}

.offline-btn.online { background: var(--red); color: #fff; }
.offline-btn.offline { background: var(--green); color: #fff; }

/* === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (TOASTS) === */
#toast-container {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  pointer-events: none;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  background: #2a2a2a;
  border-radius: 12px;
  padding: 15px 20px;
  box-shadow: 0 4px 20px var(--shadow);
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  max-width: 90vw;
  pointer-events: auto;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast-content {
  display: flex;
  align-items: center;
  gap: 10px;
}

.toast-emoji {
  width: 24px;
  height: 24px;
  font-size: 18px;
  flex-shrink: 0;
}

.toast-message {
  flex: 1;
  font-size: 14px;
  line-height: 1.4;
}

.toast-info { border-left: 4px solid var(--blue); }
.toast-success { border-left: 4px solid var(--green); }
.toast-error { border-left: 4px solid var(--red); }
.toast-warning { border-left: 4px solid var(--orange); }

/* === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê === */
.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

.modal-bg.active { display: flex; }

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-feedback {
  background: var(--bg-modal);
  border-radius: var(--radius-lg);
  padding: 28px 24px;
  min-width: 240px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
  position: relative;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-feedback h2 {
  margin-top: 0;
  margin-bottom: 18px;
  color: var(--blue);
  font-size: 22px;
}

.modal-feedback h3 {
  margin-top: 0;
  margin-bottom: 14px;
  color: var(--text);
  font-size: 18px;
}

.bigclose {
  background: none;
  border: none;
  position: absolute;
  top: 14px;
  right: 14px;
  cursor: pointer;
  color: #eee;
  font-size: 28px;
  line-height: 1;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
}

.bigclose:hover {
  transform: scale(1.1);
  background: rgba(255, 255, 255, 0.1);
}

/* === –ú–ò–ù–ò-–†–ï–ñ–ò–ú === */
.mini-now {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: var(--radius-md);
  background: #232b38;
  margin-bottom: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.mini-now .tnum {
  color: var(--text-muted);
  min-width: 28px;
}

.mini-now .track-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 15px;
}

.next-up {
  display: none;
  margin: 8px 4px 0;
  font-size: 0.98em;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
}

.mini-mode .next-up { display: flex; }

.next-up .label {
  color: var(--text-muted);
  font-size: 13px;
}

.next-up .title {
  color: var(--red);
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  font-size: 14px;
}

/* === –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò === */
.hotkeys-grid {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 10px 20px;
  margin-top: 16px;
}

.hotkey-key {
  background: rgba(255, 255, 255, 0.1);
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  font-family: monospace;
  font-size: 14px;
  text-align: center;
}

.hotkey-desc {
  color: var(--text-muted);
  font-size: 14px;
}

/* === –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø === */
.sysinfo-content {
  font-size: 14px;
  line-height: 1.6;
}

.sysinfo-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.sysinfo-row:last-child { border-bottom: none; }

.sysinfo-label { color: var(--text-muted); }
.sysinfo-value { color: var(--text); font-weight: 500; }

/* === FEEDBACK –§–û–†–ú–ê === */
.feedback-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.feedback-form input,
.feedback-form textarea {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px;
  color: var(--text);
  font-size: 14px;
  outline: none;
  transition: border-color var(--transition);
}

.feedback-form input:focus,
.feedback-form textarea:focus { border-color: var(--blue); }

.feedback-form textarea {
  min-height: 120px;
  resize: vertical;
}

.feedback-form button {
  background: var(--blue);
  color: #fff;
  border: none;
  border-radius: var(--radius-sm);
  padding: 12px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: all var(--transition);
}

.feedback-form button:hover {
  background: var(--blue-dark);
  transform: translateY(-1px);
}

/* === iOS –°–ü–ï–¶–ò–§–ò–ö–ê === */
body.ios .volume-control-wrapper { display: none !important; }
body.ios #mute-btn { display: none !important; }

/* === –ú–ï–î–ò–ê-–ó–ê–ü–†–û–°–´ === */
@media (max-width: 600px) {
  .hotkeys-btn { display: none !important; }
  
  .player-controls-row { gap: 8px; }
  
  .player-control-btn {
    width: 40px;
    height: 40px;
    padding: 8px;
  }
  
  .player-control-btn.main { width: 48px; height: 48px; }
  .player-control-btn svg { width: 18px; height: 18px; }
  
  .player-extra-buttons-row {
    flex-wrap: wrap;
    gap: 6px;
  }
  
  .lyrics-toggle-btn,
  .animation-btn,
  .pulse-btn,
  .karaoke-btn,
  .player-download-btn,
  .eco-btn {
    width: calc(33.333% - 4px);
    min-width: unset;
    max-width: unset;
  }
}

@media (max-width: 380px) {
  .promo-cover { width: 200px; height: 200px; }
  
  .album-icon { --size: 54px; }
  .album-icon.active { --size: 60px; }
  
  .active-album-title { font-size: 16px; }
  
  .lyrics-toggle-btn,
  .animation-btn,
  .pulse-btn,
  .karaoke-btn,
  .player-download-btn,
  .eco-btn {
    width: calc(50% - 4px);
  }
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* === FIX: –ó–≤—ë–∑–¥—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –ø–ª–µ–µ—Ä === */
.track-list .track .like-star {
  pointer-events: auto;
}

.lyrics-player-block * {
  position: relative;
}

.lyrics-player-block .player-controls,
.lyrics-player-block .player-buttons-wrapper,
.lyrics-player-block .volume-control-wrapper {
  z-index: 5;
}

.lyrics-player-block .player-control-btn,
.lyrics-player-block .lyrics-toggle-btn,
.lyrics-player-block .animation-btn,
.lyrics-player-block .pulse-btn,
.lyrics-player-block .karaoke-btn,
.lyrics-player-block .player-download-btn,
.lyrics-player-block .eco-btn,
.lyrics-player-block .sleep-timer-btn {
  position: relative;
  z-index: 10;
}

/* === PRINT === */
@media print {
  body { background: #fff; color: #000; }
  #promocode-block,
  .player-controls,
  .bottom-controls-center,
  .modal-bg { display: none !important; }
}

