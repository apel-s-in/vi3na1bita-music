–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.
- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).
- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  ```ts
  export function x() {}
  ```
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.
- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.
- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.
- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].
- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. 
- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.
- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤—ã–∑–≤–∞—Ç—å STOP —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–Ω—è—Ç –≤ favorites view, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞ –∏ –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ä–æ–≥–æ —Å–ª–µ–¥–∞, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–µ–º —á—Ç–æ-—Ç–æ –≤ –∫–æ–¥–µ
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏–ª–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –∫–æ–¥–µ, –Ω–æ –ø—Ä–∏—ç—Ç–æ–º –ø–æ–ª–Ω–æ—Å—Ç—å–± –±—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ –ª–æ–≥–∏–∫—É, –ª–æ–≥–∏—Å—Ç–∏–∫—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–µ–º–∏—Ç—å—Å—è –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —É–ø—Ä–æ—â–µ–Ω–∏—é –∫–æ–¥–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: vi3na1bita-music
–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: https://github.com/apel-s-in/vi3na1bita-music
# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.
## –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞
–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ –≤ –ò–ó–ë–†–ê–ù–ù–û–ï:
–õ–∞–π–∫/–∞–Ω–ª–∞–π–∫ (‚≠ê) = –∏–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞.
–°–æ—Å—Ç–æ—è–Ω–∏–µ ‚≠ê —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö (—Ä–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º, ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª, –¥—Ä—É–≥–∏–µ —Å–ø–∏—Å–∫–∏).

–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–∑ –æ–∫–Ω–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª
–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äì —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.

–ü–æ–¥—Ä–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã):
- –ü–æ—Å—Ç–∞–≤–∏–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π.
- –°–Ω—è–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª (–¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º, ¬´–±–µ–∑ —Å–ª–µ–¥–∞¬ª).

‚≠ê –≤ –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:
- –°–Ω—è–ª–∏ ‚≠ê —Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–µ—Ä–æ–π (inactive), ‚≠ê —Å–Ω–∏–º–∞–µ—Ç—Å—è –∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª, –∏ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.
- –°–Ω—è—Ç–∏–µ ‚≠ê –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ, –∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –µ—ë –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (‚Äú–±—É—Ñ–µ—Ä‚Äù).

–ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π (—Å–µ—Ä–æ–π) —Å—Ç—Ä–æ–∫–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª:
- –ö–ª–∏–∫ –ø–æ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–µ –ø–æ –∑–≤–µ–∑–¥–µ) ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:
  - –í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, ‚≠ê —Å—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–µ–∑–¥–µ.
  - –£–¥–∞–ª–∏—Ç—å ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê –ø—Ä–∏ —ç—Ç–æ–º —Å–Ω—è—Ç–∞.
- –ö–ª–∏–∫ –ø–æ ‚≠ê –Ω–∞ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –º–æ–¥–∞–ª–∫–∏, —Å—Ç—Ä–æ–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å ‚≠ê.
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É (–∏–ª–∏ ‚Äú–±–µ–∑ —Å–ª–µ–¥–∞‚Äù —á–µ—Ä–µ–∑ –∞–Ω–ª–∞–π–∫ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ).

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
- –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚≠ê –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ –≤—Å–µ—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è—Ö –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫.
- –í –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª: —Å–Ω—è—Ç–∏–µ ‚≠ê –Ω–∞ –ª—é–±–æ–π —Å—Ç—Ä–æ–∫–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.
- –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É.

–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:
- –õ—é–±—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç—Ä–µ–∫–∞ –≤ inactive, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞.
- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–µ—Å–Ω–∏ –ù–ï –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç ‚Äú–≤ —Ñ–æ–Ω–µ‚Äù.

–û—Å–æ–±–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞:
- –ï—Å–ª–∏ —Ç—Ä–µ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è inactive –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫.
- –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî –ø–ª–µ–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º —Å—Ç–æ–ø, –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

–†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º –≤—Å–µ–≥–¥–∞ —Ä–µ—à–∞–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ:
- –ï—Å–ª–∏ —Å–Ω—è—Ç—å ‚≠ê —Å —Ç—Ä–µ–∫–∞ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚Äî –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–ª—Å—è —Ç–∞–º –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è (—Å–µ—Ä–∞—è) —Å—Ç—Ä–æ–∫–∞.

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ:
- –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ ‚≠ê –Ω–∞ —Ç—Ä–µ–∫–µ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π.

–ò—Ç–æ–≥–∏
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî —à–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–æ–π.
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚≠ê –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö.
- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π: –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–¥–Ω–æ–º—É –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.
- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.
- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.
 =========================================================================== 
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F (–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)
–ö–Ω–æ–ø–∫–∞ F –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º Favorites Only –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞).
–û–Ω–∞ –Ω–µ —Å—Ç–∞–≤–∏—Ç/–Ω–µ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê —É —Ç—Ä–µ–∫–æ–≤, –∞ —Ç–æ–ª—å–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç, –ø–æ –∫–∞–∫–∏–º —Ç—Ä–µ–∫–∞–º –º–æ–∂–Ω–æ —Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Next / Prev / –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏ –∫–∞–∫–∏–µ —Ç—Ä–µ–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ Shuffle.
–ï–¥–∏–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø (–ø–æ–ª–Ω—ã–π –ø–ª–µ–µ—Ä –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä)
–ü–æ–ª–Ω—ã–π –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ playing-–ø–ª–µ–π–ª–∏—Å—Ç–æ–º.
–ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö: –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ playing, –∞ –Ω–µ –∫ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å–ø–∏—Å–∫—É.
–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–¥–æ—Å—Ç—É–ø–Ω—ã–º —Ç—Ä–µ–∫–æ–º‚Äù
–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ ‚Äî —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤:
Next / Prev
–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —Ç—Ä–µ–∫–∞
Shuffle-–ø–æ—Ä—è–¥–∫–µ (–µ—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω)
–ü—Ä–∞–≤–∏–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:
F = OFF: –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±—ã—á–Ω—ã–π –Ω–∞–±–æ—Ä playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞, –Ω–æ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å–º. ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –Ω–∏–∂–µ).
F = ON: –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (‚≠ê) —Ç—Ä–µ–∫–∏ playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞.
–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –æ–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º
–ò–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ ‚≠ê –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ (–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ª–∞–π–∫–æ–≤).
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –≤ –∞–ª—å–±–æ–º–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ ‚≠ê —Ç—Ä–µ–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä —Å—É–∂–∞–µ—Ç—Å—è –¥–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è OFF, –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞–ª—å–±–æ–º–∞, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ ‚≠ê –Ω–µ—Ç: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = ‚≠ê, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ —ç—Ç–æ–º—É shuffle-–ø–æ—Ä—è–¥–∫—É.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = –≤—Å–µ —Ç—Ä–µ–∫–∏, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–∞–±–æ—Ä—É, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –ò–ó–ë–†–ê–ù–ù–û–ï (–ø–ª–µ–π–ª–∏—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ)
–í ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã active –∏ inactive:
active: —Ç—Ä–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º (‚≠ê –µ—Å—Ç—å) ‚Äî —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
inactive: ‚≠ê —Å–Ω—è—Ç–∞, —Å—Ç—Ä–æ–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
–ë–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–≤–∞–∂–Ω–æ): inactive –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –≤ Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∏ shuffle-–ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø—Ä–∏ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ F.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –Ω–µ—Ç active (–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –Ω–µ—á–µ–≥–æ –∏–≥—Ä–∞—Ç—å): –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = active (–ø–æ —Ñ–∞–∫—Ç—É –æ–Ω –∏ —Ç–∞–∫ —Ç–∞–∫–æ–π), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ active.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è = active (inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ active.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –Ω–µ—Ç active: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active (–ø–æ—Ç–æ–º—É —á—Ç–æ inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
–ù–∞–∂–∞—Ç–∏–µ F –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–∞–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (‚≠ê –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –∏ –Ω–µ —Å–Ω–∏–º–∞–µ—Ç—Å—è).
–ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ (–Ω–µ—Ç ‚≠ê –≤ –∞–ª—å–±–æ–º–µ / –Ω–µ—Ç active –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ): –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∏ F –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è (–æ—Å—Ç–∞—ë—Ç—Å—è OFF).
inactive –≤ –ò–ó–ë–†–ê–ù–ù–û–ú ‚Äî —ç—Ç–æ UI-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è, –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∏ –≤ –∫–∞–∫–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –Ω–∏ –≤ Next/Prev, –Ω–∏ –≤ Shuffle.

–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).

–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:
vi3na1bita-music/
‚îú‚îÄ‚îÄ .git/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ applypatch-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fsmonitor-watchman.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-update.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-applypatch.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-merge-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-push.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-rebase.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-receive.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prepare-commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ push-to-checkout.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sendemail-validate.sample
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update.sample
‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exclude
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ qwen-code-c0a6e5d8-7ce2-4015-b9e8-16c1eb5626f1
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ qwen-code-c670b9c3-90a8-4bf4-a12a-b54705b66530
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HEAD
‚îÇ   ‚îú‚îÄ‚îÄ objects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pack/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-265ed6d39f1abf30c53c35f4d9cc93d2b2ee794e.idx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-265ed6d39f1abf30c53c35f4d9cc93d2b2ee794e.pack
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ pack-265ed6d39f1abf30c53c35f4d9cc93d2b2ee794e.rev
‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ qwen-code-c0a6e5d8-7ce2-4015-b9e8-16c1eb5626f1
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ qwen-code-c670b9c3-90a8-4bf4-a12a-b54705b66530
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tags/
‚îÇ   ‚îú‚îÄ‚îÄ config
‚îÇ   ‚îú‚îÄ‚îÄ config.worktree
‚îÇ   ‚îú‚îÄ‚îÄ description
‚îÇ   ‚îú‚îÄ‚îÄ FETCH_HEAD
‚îÇ   ‚îú‚îÄ‚îÄ HEAD
‚îÇ   ‚îî‚îÄ‚îÄ index
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ e2e.yml
‚îÇ       ‚îú‚îÄ‚îÄ generate-context.yml
‚îÇ       ‚îî‚îÄ‚îÄ validate.yml
‚îú‚îÄ‚îÄ .meta/
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ albums/
‚îÇ   ‚îú‚îÄ‚îÄ gallery/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ news/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ thumbs/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ news-cover-02-thumb.jpg
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ news-cover-02-thumb.webp
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-01-baner.html
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.avif
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.png
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ news-cover-02.webp
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ icons/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ apple-touch-icon.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-16.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-32.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-192.png
‚îÇ   ‚îî‚îÄ‚îÄ icon-512.png
‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îú‚îÄ‚îÄ desktop/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@2x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@3x.png
‚îÇ   ‚îú‚îÄ‚îÄ icon_album/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.png
‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@2x.jpg
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ bg.png
‚îÇ   ‚îú‚îÄ‚îÄ Fav_logo.png
‚îÇ   ‚îú‚îÄ‚îÄ logo.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-01.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-02.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-03.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-04.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-21.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-22.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-23.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-24.png
‚îÇ   ‚îú‚îÄ‚îÄ star.png
‚îÇ   ‚îî‚îÄ‚îÄ star2.png
‚îú‚îÄ‚îÄ news/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ news.json
‚îú‚îÄ‚îÄ performance/
‚îÇ   ‚îî‚îÄ‚îÄ rum.js
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ albums/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ specials.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player-ui/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lyrics.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app-utils.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ albums.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ navigation.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-ui-bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-cache-bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-policy.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player-ui.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promocode.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track-registry.js
‚îÇ   ‚îú‚îÄ‚îÄ ci/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lint-sw.mjs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate-content.mjs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validate-manifest.mjs
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-manager.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stats-core.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.spec.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player.spec.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ offline/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache-db.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ net-policy.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-manager.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-cache.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track-resolver.js
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache-progress-overlay.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cloud-menu.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-view.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lyrics-modal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modal-templates.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modals.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ news-inline.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notify.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-indicators.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-modal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sleep.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ statistics-modal.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sysinfo.js
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sw-manager.js
‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache-db.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ download-queue.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mode-manager.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-indicators.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-manager.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-modal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-cache.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stats-core.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stats-modal.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track-resolver.js
‚îÇ   ‚îú‚îÄ‚îÄ player-core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ media-session.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stats-tracker.js
‚îÇ   ‚îî‚îÄ‚îÄ PlayerCore.js
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îî‚îÄ‚îÄ main.css
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ albums.json
‚îú‚îÄ‚îÄ custom.json
‚îú‚îÄ‚îÄ generate-context.js
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ news.html
‚îî‚îÄ‚îÄ service-worker.js


–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: 2026-02-06 10:40:25 UTC
//=================================================
// FILE: /.github/workflows/e2e.yml
name: E2E smoke

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npx -y playwright@1.48.2 install --with-deps

      - name: Start static server
        run: |
          npx -y http-server -p 4173 -c-1 . &
          echo $! > server.pid
          sleep 2

      - name: Run smoke tests
        env:
          BASE_URL: http://127.0.0.1:4173
        run: npx -y @playwright/test@1.48.2 scripts/e2e

      - name: Stop server
        if: always()
        run: kill $(cat server.pid) || true

//=================================================
// FILE: /.github/workflows/generate-context.yml
name: Generate .meta context

on:
  push:
    branches: [ main, master ]
    # –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤–æ—Ä–∫—Ñ–ª–æ—É –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤, –º–µ–Ω—è—é—â–∏—Ö —Ç–æ–ª—å–∫–æ .meta
    paths-ignore:
      - '.meta/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate .meta
        run: |
          node generate-context.js --mode=both --max-lines=20000
          ls -la .meta || true

      - name: Commit .meta
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: generate .meta context"
          branch: ${{ github.ref_name }}
          file_pattern: ".meta/**"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

//=================================================
// FILE: /.github/workflows/validate.yml
name: Validate manifest and SW

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run manifest validator
        run: node scripts/ci/validate-manifest.mjs

      - name: Run SW linter
        run: node scripts/ci/lint-sw.mjs

      - name: Validate albums and galleries
        run: node scripts/ci/validate-content.mjs

  remote-validate:
    name: Remote content validate (informational)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Remote validate (warnings only)
        run: node scripts/ci/validate-content.mjs

//=================================================
// FILE: /albums.json
{
  "albums": [
    {
      "key": "mezhdu-zlom-i-dobrom",
      "title": "–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "base": "https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/"
    },
    {
      "key": "golos-dushi",
      "title": "–ì–æ–ª–æ—Å –î—É—à–∏",
      "base": "https://apel-s-in.github.io/vi3na1bita-golos-dushi/"
    },
    {
      "key": "odnazhdy-v-skazke",
      "title": "–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ",
      "base": "https://apel-s-in.github.io/vi3na1bita-odnazhdy-v-skazke/"
    },
    {
      "key": "krevetochka",
      "title": "–ö–†–ï–í–ï„ÉÑTOCHKA",
      "base": "https://apel-s-in.github.io/krevetochka/"
    }
  ]
}

//=================================================
// FILE: /albums/gallery/00/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-01.webp",
        "full": "albums/gallery/00/00-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-02.webp",
        "full": "albums/gallery/00/00-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/01/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-01.webp",
        "full": "albums/gallery/01/01-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-02.webp",
        "full": "albums/gallery/01/01-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-03.webp",
        "full": "albums/gallery/01/01-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-04.webp",
        "full": "albums/gallery/01/01-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/02/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-01.webp",
        "full": "albums/gallery/02/02-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-02.webp",
        "full": "albums/gallery/02/02-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-03.webp",
        "full": "albums/gallery/02/02-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-04.webp",
        "full": "albums/gallery/02/02-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/03/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-01.webp",
        "full": "albums/gallery/03/03-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-02.webp",
        "full": "albums/gallery/03/03-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-03.webp",
        "full": "albums/gallery/03/03-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-04.webp",
        "full": "albums/gallery/03/03-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/news/index.json
{
  "items": [
    { "type": "html", "src": "albums/gallery/news/news-01-baner.html" },
    {
      "formats": {
        "webp": "albums/gallery/news/news-cover-02.webp",
        "full": "albums/gallery/news/news-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /custom.json
{
  "rumEndpoint": "",
  "sw": {
    "mediaMaxCacheMB": 150,
    "nonRangeMaxStoreMB": 25,
    "nonRangeMaxStoreMBSlow": 10,
    "allowUnknownSize": false,
    "revalidateDays": 7
  },
  "items": [
    {
      "type": "ym",
      "title": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
      "subtitle": "–Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∞",
      "url": "https://music.yandex.ru/artist/24739002?utm_source=web&utm_medium=copy_link",
      "cover": ""
    },
    {
      "type": "tgPost",
      "title": "–°–≤–µ–∂–∏–π –ø–æ—Å—Ç –≤ Telegram",
      "url": "https://t.me/vitrina_razbita/28",
      "height": 480
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 3,
      "hash": "b8300406c5f33725de",
      "containerId": "vk_playlist_165137_3"
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 2,
      "hash": "d70fba309dc0bea296",
      "containerId": "vk_playlist_165137_2"
    }
  ]
}

//=================================================
// FILE: /index.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">

  <link rel="preload" href="img/logo.png" as="image">
  <link rel="stylesheet" href="styles/main.css">

  <!-- Howler first -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>

  <!-- Core -->
  <script src="./scripts/core/utils.js"></script>
  <script src="./scripts/core/bootstrap.js"></script>
  <script src="./scripts/core/config.js" type="module"></script>
  <script src="./scripts/utils/sw-manager.js" defer></script>

  <!-- Player Core -->
  <script src="./src/PlayerCore.js" type="module"></script>

  <!-- UI Modules -->
  <script src="./scripts/ui/notify.js" defer></script>
  <script src="./scripts/ui/modals.js" defer></script>
  <script src="./scripts/ui/favorites.js" defer></script>
  <script src="./scripts/ui/sleep.js" defer></script>
  <script src="./scripts/ui/lyrics-modal.js" defer></script>
  <script src="./scripts/ui/modal-templates.js" type="module"></script>
  <script src="./scripts/ui/sysinfo.js" defer></script>

  <!-- App Modules -->
  <script src="./scripts/app/promocode.js" defer></script>
  <script src="./scripts/app/playback-policy.js" defer></script>
  <script src="./scripts/app/player-ui/lyrics.js" defer></script>
  <script src="./scripts/app/player-ui.js" defer></script>
  <script src="./scripts/app/gallery.js" type="module"></script>
  <script src="./scripts/app/albums.js" type="module"></script>
  <script src="./scripts/app/navigation.js" type="module"></script>

  <script src="./scripts/app.js" type="module"></script>

  <script src="./performance/rum.js" defer></script>
</head>
<body>
  <!-- Promocode Screen -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons" aria-label="–ê–ª—å–±–æ–º—ã"></div>

      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left"
                title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff"
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div id="cover-slot" aria-label="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞"></div>

        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right"
                title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff"
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <div id="now-playing" style="width:100%; max-width:395px; margin:8px auto 0 auto;"></div>
    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>

      <button id="install-pwa-btn" style="display: none;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï</button>
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;">–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</button>
      <button id="sysinfo-btn" style="display:none;">–û –°–ò–°–¢–ï–ú–ï</button>

      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>

      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>

      <button class="offline-btn" id="offline-btn">OFFLINE</button>
    </div>
  </div>

  <div id="modals-container"></div>

  <template id="mini-header-template">
    <div class="mini-now" id="mini-now">
      <span class="tnum" id="mini-now-num">--.</span>
      <span class="track-title" id="mini-now-title">‚Äî</span>
      <img src="img/star2.png" class="like-star" id="mini-now-star" alt="–∑–≤–µ–∑–¥–∞">
    </div>
  </template>

  <template id="next-up-template">
    <div class="next-up" id="next-up">
      <span class="label">–î–∞–ª–µ–µ:</span>
      <span class="title" title="">‚Äî</span>
    </div>
  </template>

  <template id="player-template">
    <!-- (—Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
    <div class="lyrics-player-block" id="lyricsplayerblock">
      <div id="lyrics-window" class="lyrics-normal">
        <div class="lyrics-animated-bg"></div>
        <div class="lyrics-scroll" id="lyrics">
          <div class="lyrics-placeholder lyrics-spinner"></div>
        </div>
      </div>

      <div class="player-progress-wrapper">
        <div class="player-progress-bar" id="player-progress-bar">
          <div class="player-progress-fill" id="player-progress-fill">
            <div class="player-progress-handle"></div>
          </div>
        </div>
      </div>

      <div class="player-controls">
        <div class="player-controls-row">
          <span class="time-in-controls" id="time-elapsed">00:00</span>

          <button class="player-control-btn" id="prev-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫ (P)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M11 5L4 12l7 7V5zm9 0v14l-7-7 7-7z"/>
            </svg>
          </button>

          <button class="player-control-btn main" id="play-pause-btn" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞ (K)">
            <svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>

          <button class="player-control-btn" id="stop-btn" title="–°—Ç–æ–ø (X)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12"/>
            </svg>
          </button>

          <button class="player-control-btn" id="next-btn" title="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ (N)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M13 5l7 7-7 7V5zM4 5v14l7-7-7-7z"/>
            </svg>
          </button>

          <span class="time-in-controls" id="time-remaining">--:--</span>
        </div>

        <div class="player-controls-row">
          <button class="player-control-btn" id="pq-btn" title="–ö–∞—á–µ—Å—Ç–≤–æ (Hi/Lo)">
            <span class="pq-btn-label" id="pq-btn-label">Hi</span>
          </button>

          <button class="player-control-btn" id="mute-btn" title="–ë–µ–∑ –∑–≤—É–∫–∞ (M)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
            </svg>
          </button>

          <button class="player-control-btn" id="shuffle-btn" title="–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (U)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 17h2.735a4 4 0 003.43-1.942l3.67-6.116A4 4 0 0116.265 7H21m0 0l-3-3m3 3l-3 3"/>
              <path d="M3 7h2.735a4 4 0 013.43 1.942l3.67 6.116A4 4 0 0016.265 17H21m0 0l-3 3m3-3l-3-3"/>
            </svg>
          </button>

          <button class="player-control-btn" id="repeat-btn" title="–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ (R)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 2l4 4-4 4"/>
              <path d="M3 11V9a4 4 0 014-4h14"/>
              <path d="M7 22l-4-4 4-4"/>
              <path d="M21 13v2a4 4 0 01-4 4H3"/>
              <circle cx="12" cy="12" r="1" fill="currentColor"/>
            </svg>
          </button>

          <button class="sleep-timer-btn" id="sleep-timer-btn" title="–¢–∞–π–º–µ—Ä —Å–Ω–∞ (T)">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"></circle>
              <path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none;">0</span>
          </button>

          <button class="player-control-btn" id="favorites-btn" title="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (F)">
            <img src="img/star2.png" alt="‚òÖ" id="favorites-btn-icon"/>
          </button>
        </div>
      </div>

      <div class="volume-control-wrapper">
        <div class="volume-track" id="volume-track">
          <div class="volume-fill" id="volume-fill"></div>
          <div class="volume-handle" id="volume-handle"></div>
        </div>
        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100" aria-label="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
      </div>

      <div class="player-buttons-wrapper">
        <div class="player-extra-buttons-row">
          <button class="lyrics-toggle-btn lyrics-normal" id="lyrics-toggle-btn" title="–†–µ–∂–∏–º –ª–∏—Ä–∏–∫–∏ (Y)">
            <span class="lyrics-toggle-btn-visual">–¢</span>
          </button>

          <button class="animation-btn" id="animation-btn" title="–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ (A)">A</button>

          <button class="karaoke-btn" id="lyrics-text-btn" title="–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏">üìù</button>

          <button class="stats-btn" id="stats-btn" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" style="background:none; border:none; cursor:pointer; font-size:18px; opacity:0.8; padding:0 8px;">üìä</button>

          <button class="pulse-btn" id="pulse-btn" title="–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞">
            <span id="pulse-heart">ü§ç</span>
          </button>

          <a class="player-download-btn" href="#" id="track-download-btn" download title="–°–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫">üíæ</a>
        </div>
      </div>
    </div>
  </template>

  <script>
    const VERSION = String(window.APP_CONFIG?.APP_VERSION || '8.0.4');
    const BUILD_DATE = String(window.APP_CONFIG?.BUILD_DATE || '2025-12-07');

    window.autoNextDisabled = false;
    window.sleepTimerTarget = null;
    window.sleepTimerInterval = null;

    window.VERSION = VERSION;
    window.BUILD_DATE = BUILD_DATE;

    console.log(`üéµ –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ v${VERSION} (${BUILD_DATE})`);
  </script>
</body>
</html>

//=================================================
// FILE: /manifest.json
{
  "name": "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "short_name": "Vi3na1bita",
  "description": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#181818",
  "theme_color": "#181818",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "categories": ["music", "entertainment"],
  "screenshots": []
}

//=================================================
// FILE: /news.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0e15;
      --panel: #131a26;
      --text: #eaf2ff;
      --muted: #9db7dd;
      --accent: #4daaff;
      --danger: #E80100;
      --border: #23324a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 14px;
      background: var(--bg); color: var(--text);
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
    }
    .container { max-width: 760px; margin: 0 auto; }
    h1 { margin: 6px 0 16px; font-size: 22px; }
    .news-list { display: grid; gap: 14px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .date { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .media { margin: 10px 0; }
    .media iframe, .media img, .media video {
      width: 100%; border: 0; border-radius: 8px; min-height: 220px; background: #0b0e15;
    }
    .card p { margin: 8px 0; line-height: 1.45; }
    .tags { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 12px; color: var(--accent); background: rgba(77,170,255,.12); border: 1px solid rgba(77,170,255,.25); padding: 4px 8px; border-radius: 999px; }
    .error { color: var(--danger); background: rgba(232,1,0,.1); border: 1px solid rgba(232,1,0,.2); padding: 10px; border-radius: 8px; }
    .loading { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ù–æ–≤–æ—Å—Ç–∏</h1>
    <div id="status" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="news" class="news-list"></div>
  </div>

  <script>
    async function loadNews() {
      const status = document.getElementById('status');
      const listEl = document.getElementById('news');
      try {
        const r = await fetch('./news/news.json', { cache: 'no-cache' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const items = Array.isArray(j.items) ? j.items : [];
        status.style.display = 'none';
        if (!items.length) {
          status.style.display = '';
          status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
          return;
        }
        listEl.innerHTML = items.map(renderCard).join('');
      } catch (e) {
        status.className = 'error';
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
      }
    }
    function esc(s) {
      // –µ–¥–∏–Ω—ã–π esc –±–µ–∑ –¥—É–±–ª–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ (–∑–¥–µ—Å—å standalone, –ø–æ—ç—Ç–æ–º—É –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ)
      return String(s || '').replace(/[<>&'"]/g, (m) => ({
        '<': '&lt;', '>': '&gt;', '&': '&amp;', "'": '&#39;', '"': '&quot;'
      })[m]);
    }
    function renderCard(it) {
      const title = esc(it.title || '–ù–æ–≤–æ—Å—Ç—å');
      const date = esc(it.date || '');
      const text = esc(it.text || '');
      const tags = Array.isArray(it.tags) ? it.tags : [];
      let media = '';
      if (it.embedUrl) {
        media = `<div class="media"><iframe loading="lazy" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`;
      } else if (it.image) {
        media = `<div class="media"><img loading="lazy" src="${esc(it.image)}" alt=""></div>`;
      } else if (it.video) {
        media = `<div class="media"><video controls preload="metadata" src="${esc(it.video)}"></video></div>`;
      }
      return `<article class="card">
        <h2>${title}</h2>
        ${date ? `<div class="date">${date}</div>` : ''}
        ${media}
        ${text ? `<p>${text}</p>` : ''}
        ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join('')}</div>` : ''}
      </article>`;
    }
    loadNews();
  </script>
</body>
</html>

//=================================================
// FILE: /service-worker.js
// service-worker.js
// Optimized Service Worker for "Vi3na1bita" (v8.1)

const SW_VERSION = '8.1.5';

// Cache Names (Required by lint-sw.mjs)
const CORE_CACHE = `vitrina-core-v${SW_VERSION}`;
const RUNTIME_CACHE = `vitrina-runtime-v${SW_VERSION}`;
const MEDIA_CACHE = `vitrina-media-v${SW_VERSION}`;
const OFFLINE_CACHE = `vitrina-offline-v${SW_VERSION}`;
const META_CACHE = `vitrina-meta-v${SW_VERSION}`;

// Config (Required by lint-sw.mjs - do not remove)
const DEFAULT_SW_CONFIG = {
  mediaMaxCacheMB: 150,
  nonRangeMaxStoreMB: 25,
  nonRangeMaxStoreMBSlow: 10,
  allowUnknownSize: false,
  revalidateDays: 7
};

// Core Assets (App Shell)
const STATIC_ASSETS = [
  './', './index.html', './news.html', './manifest.json',
  './styles/main.css', './img/logo.png', './img/star.png', './img/star2.png',
  './icons/favicon-32.png', './icons/favicon-16.png', './icons/apple-touch-icon.png',
  './scripts/core/bootstrap.js', './scripts/core/config.js', './scripts/core/utils.js',
  './scripts/core/favorites-manager.js',
  './scripts/app/gallery.js', './scripts/ui/notify.js', './scripts/ui/favorites.js',
  './scripts/ui/sleep.js', './scripts/ui/lyrics-modal.js', './scripts/ui/sysinfo.js',
  './scripts/ui/modal-templates.js', './scripts/ui/modals.js',
  './scripts/ui/offline-modal.js', './scripts/ui/offline-indicators.js',
  './scripts/ui/cache-progress-overlay.js', './scripts/ui/statistics-modal.js',
  './scripts/app/player-ui.js', './scripts/app/albums.js', './scripts/app/navigation.js',
  './scripts/app.js', './src/PlayerCore.js',
  './scripts/app/offline-ui-bootstrap.js', './scripts/app/playback-cache-bootstrap.js'
];

// Helper: Normalize URL for strict cache matching
const norm = (u) => { 
  try { 
    const p = new URL(u, self.registration.scope); 
    p.hash = ''; p.search = ''; 
    if(p.pathname.endsWith('/')) p.pathname += 'index.html'; 
    return p.href; 
  } catch { return String(u); } 
};
const STATIC_SET = new Set(STATIC_ASSETS.map(norm));

// --- Lifecycle ---

// Optimized Install: Best-effort caching
self.addEventListener('install', (e) => {
  e.waitUntil(
    caches.open(CORE_CACHE).then(async (cache) => {
      // –ü—ã—Ç–∞–µ–º—Å—è –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë, –Ω–æ –Ω–µ –ø–∞–¥–∞–µ–º –µ—Å–ª–∏ –æ–¥–∏–Ω —Ñ–∞–π–ª 404
      const promises = STATIC_ASSETS.map(url => {
        const req = new Request(url); 
        return fetch(req).then(res => {
          // –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitHub Pages –±–µ–∑ —Å–ª–µ—à–∞)
          if (res.ok && !res.redirected) return cache.put(req, res);
          console.warn('SW: Skipped (redirect/fail):', url);
        }).catch(err => console.warn('SW: Fetch error', url, err));
      });
      await Promise.all(promises);
      return self.skipWaiting();
    })
  );
});

self.addEventListener('activate', (e) => {
  e.waitUntil(caches.keys().then(keys => Promise.all(keys.map(k => {
    // Clean old caches except current versions
    if (![CORE_CACHE, RUNTIME_CACHE, MEDIA_CACHE, OFFLINE_CACHE, META_CACHE].includes(k)) {
      return caches.delete(k);
    }
  }))).then(() => self.clients.claim()));
});

// --- Fetch Strategy ---

self.addEventListener('fetch', (e) => {
  const req = e.request;
  if (req.method !== 'GET') return;

  const url = new URL(req.url);

  // 1. Audio Bypass: Network Only
  // –ê—É–¥–∏–æ —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è OfflineManager (IndexedDB). SW –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è,
  // —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ –ª–æ–º–∞—Ç—å Range-–∑–∞–ø—Ä–æ—Å—ã.
  if (/\.(mp3|ogg|m4a|flac)$/i.test(url.pathname)) {
    return; // Fallback to browser network stack
  }

  // 2. Static Assets: Cache First (Strict)
  if (STATIC_SET.has(norm(url.href))) {
    e.respondWith(
      caches.open(CORE_CACHE).then(c => c.match(req)).then(r => r || fetch(req).then(n => {
        if(n.ok) caches.open(CORE_CACHE).then(c => c.put(req, n.clone()));
        return n;
      }))
    );
    return;
  }

  // 3. Default: Network First -> Runtime Cache (Stale-While-Revalidate pattern simplified)
  e.respondWith(
    caches.match(req).then(cached => {
      const networked = fetch(req).then(res => {
        if (res.ok && url.protocol.startsWith('http')) {
          const clone = res.clone();
          caches.open(RUNTIME_CACHE).then(c => c.put(req, clone));
        }
        return res;
      });
      return cached || networked;
    })
  );
});

// --- Messaging API ---

self.addEventListener('message', (e) => {
  const d = e.data;
  if (!d || typeof d !== 'object') return;
  const port = e.ports[0];

  switch (d.type) {
    case 'GET_SW_VERSION':
      if (port) port.postMessage({ version: SW_VERSION });
      break;

    case 'SKIP_WAITING':
      self.skipWaiting();
      break;

    case 'CLEAR_CACHE':
      e.waitUntil(caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k)))));
      break;

    case 'WARM_OFFLINE_SHELL': 
      // –¢–ó: "100% Offline" - –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤ (lyrics/json/etc)
      e.waitUntil((async () => {
        try {
          const c = await caches.open(OFFLINE_CACHE);
          const urls = (d.payload?.urls || []);
          await Promise.all(urls.map(u => c.add(u).catch(()=>{})));
          if (port) port.postMessage({ ok: true });
        } catch (err) { if (port) port.postMessage({ ok: false, error: String(err) }); }
      })());
      break;

    case 'GET_CACHE_SIZE': 
      // –¢–ó: –û—Ü–µ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ "Other" –≤ –º–æ–¥–∞–ª–∫–µ Offline
      if (!port) return;
      e.waitUntil((async () => {
        let size = 0, entries = 0;
        try {
          for (const name of await caches.keys()) {
            const c = await caches.open(name);
            const keys = await c.keys();
            entries += keys.length;
            for (const k of keys) {
              const r = await c.match(k);
              if (r) {
                const len = r.headers.get('content-length');
                if (len) size += parseInt(len, 10) || 0;
              }
            }
          }
        } catch {}
        port.postMessage({ size, entries, approx: true });
      })());
      break;
  }
});

//=================================================
// FILE: /performance/rum.js
;(function(){
  // –ù–µ–±–æ–ª–µ–∑–Ω–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞: —á—Ç–æ–±—ã <script src="./performance/rum.js"> –Ω–µ –¥–∞–≤–∞–ª 404
  // –∏ –Ω–µ –ª–æ–º–∞–ª –º–µ—Ç—Ä–∏–∫–∏. –ï—Å–ª–∏ –≤ custom.json –ø–æ—è–≤–∏—Ç—Å—è endpoint ‚Äî –≤–∞—à –∫–æ–¥ –≤ index.html
  // –≤—ã–∑–æ–≤–µ—Ç initRUM(...) –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏.
  if (typeof window.initRUM !== 'function') {
    window.initRUM = function initRUM() { /* no-op */ };
  }
})();

//=================================================
// FILE: /scripts/app.js
// scripts/app.js
// Optimized Application Entry Point v2.1
(function (W, D) {
  'use strict';

  const $ = (id) => D.getElementById(id);
  const click = (id) => $(id)?.click();
  
  // Wait helper using new Utils
  const waitObj = async (name) => {
    const U = W.Utils;
    if (U?.waitFor) return U.waitFor(() => !!W[name]?.initialize, 3000);
    let i = 0; while(!W[name]?.initialize && i++ < 30) await new Promise(r => setTimeout(r, 100));
    return !!W[name];
  };

  const initModules = async () => {
    // 1. Albums Index
    if (!Array.isArray(W.albumsIndex) || !W.albumsIndex.length) {
      try { await W.Utils?.onceEvent?.(W, 'albumsIndex:ready', { timeoutMs: 5000 }); } catch {}
    }
    W.albumsIndex = Array.isArray(W.albumsIndex) ? W.albumsIndex : [];

    // 2. Offline System
    try {
      const boot = await import('./app/offline-ui-bootstrap.js');
      boot?.attachOfflineUI?.();
      
      Promise.all([
        import('./ui/offline-indicators.js'),
        import('./ui/cache-progress-overlay.js'),
        import('./app/playback-cache-bootstrap.js'),
        import('./ui/offline-modal.js')
      ]).then(([ind, ov, pb, mod]) => {
        ind?.attachOfflineIndicators?.();
        ov?.attachCacheProgressOverlay?.();
        pb?.attachPlaybackCache?.();
        if (localStorage.getItem('offline:preloadAllTracksOnce:v1') !== '1' && mod?.preloadAllAlbumsTrackIndex) {
          mod.preloadAllAlbumsTrackIndex().then(() => localStorage.setItem('offline:preloadAllTracksOnce:v1', '1'));
        }
      });
    } catch (e) { console.error('Offline boot err:', e); }

    // 3. UI Managers
    const run = (n) => W[n]?.initialize();
    if (await waitObj('GalleryManager')) run('GalleryManager');
    if (await waitObj('AlbumsManager')) run('AlbumsManager');
    if (await waitObj('PlayerUI')) run('PlayerUI');

    // 4. Minor Modules
    ['SleepTimer', 'LyricsModal', 'SystemInfoManager'].forEach(m => W[m]?.initialize?.());
    await import('./ui/statistics-modal.js'); // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

    // 5. Restore State
    W.PlayerState?.apply?.();
  };

  const setupHotkeys = () => {
    const pc = W.playerCore;
    const map = {
      'k': () => W.PlayerUI?.togglePlayPause(),
      ' ': (e) => { e.preventDefault(); W.PlayerUI?.togglePlayPause(); },
      'n': () => pc?.next(),
      'p': () => pc?.prev(),
      'x': () => pc?.stop(),
      'm': () => click('mute-btn'),
      'r': () => click('repeat-btn'),
      'u': () => click('shuffle-btn'),
      'a': () => click('animation-btn'),
      'b': () => click('pulse-btn'),
      'f': () => click('favorites-btn'),
      't': () => W.SleepTimer?.show?.(),
      'y': () => click('lyrics-toggle-btn'),
      'arrowleft': () => pc?.seek(Math.max(0, (pc.getPosition() || 0) - 5)),
      'arrowright': () => pc?.seek(Math.min(pc.getDuration() || 0, (pc.getPosition() || 0) + 5)),
      'arrowup': (e) => { e.preventDefault(); pc?.setVolume(Math.min(100, pc.getVolume() + 5)); },
      'arrowdown': (e) => { e.preventDefault(); pc?.setVolume(Math.max(0, pc.getVolume() - 5)); }
    };

    D.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA'].includes(e.target?.tagName)) return;
      const h = map[e.key.toLowerCase()];
      if (h) h(e);
    });
  };

  const setupPWA = () => {
    W.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      const btn = $('install-pwa-btn');
      if (!btn) return;
      btn.style.display = 'block';
      btn.onclick = async () => {
        e.prompt();
        if ((await e.userChoice).outcome === 'accepted') W.NotificationSystem?.success('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
        btn.style.display = 'none';
      };
    });
    W.addEventListener('appinstalled', () => {
      W.NotificationSystem?.success('–£—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
      const btn = $('install-pwa-btn');
      if (btn) btn.style.display = 'none';
    });
  };

  const setupSW = () => {
    if (!('serviceWorker' in navigator)) return;
    const h = (e) => {
      const d = e.data;
      if (d?.type === 'SW_VERSION') {
        const v = String(d.version || '').trim();
        if (v && v !== String(W.VERSION || '')) W.ServiceWorkerManager?.handleVersionMessage?.({ swVer: v });
      }
    };
    navigator.serviceWorker.addEventListener('message', h);
    W.addEventListener('message', h);
  };

  let _init = false;
  W.app = {
    initialize: async () => {
      if (_init) return;
      _init = true;
      try { await initModules(); setupHotkeys(); setupPWA(); setupSW(); }
      catch (e) { console.error('App init failed:', e); W.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏'); }
    }
  };
})(window, document);

//=================================================
// FILE: /scripts/app/albums.js
import { registerTrack } from './track-registry.js';
import { $, toStr, escHtml, isMobileUA } from './utils/app-utils.js';

const C = window.APP_CONFIG || {};
const FAV = window.SPECIAL_FAVORITES_KEY || '__favorites__';
const NEWS = window.SPECIAL_RELIZ_KEY || '__reliz__';
const STAR_ON = 'img/star.png';
const STAR_OFF = 'img/star2.png';
const LOGO = 'img/logo.png';

// ‚úÖ –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
const toUrl = (b, r) => r ? new URL(r, b).toString() : null;

class AlbumsManager {
  constructor() {
    this.curr = null;
    this.playing = null;
    this.cache = new Map();
    this.covers = new Map();
    this.loading = false;
    this.galVis = true;
  }

  async initialize() {
    if (!window.albumsIndex?.length) {
      try { await window.Utils?.onceEvent?.(window, 'albumsIndex:ready', { timeoutMs: 5000 }); } catch {}
    }
    if (!window.albumsIndex?.length) return console.error('‚ùå Albums index empty');

    this._renderIcons();
    this._bindEvents();

    const def = C.ICON_ALBUMS_ORDER?.find(x => !x.key.startsWith('__'))?.key || window.albumsIndex[0]?.key;
    const key = localStorage.getItem('currentAlbum') || def;
    if (key) await this.loadAlbum(key);
  }

  _renderIcons() {
    const box = $('album-icons');
    if (!box) return;
    
    const isMob = isMobileUA();
    const index = window.albumsIndex || [];

    box.innerHTML = (C.ICON_ALBUMS_ORDER || [])
      .filter(it => it.key && (it.key.startsWith('__') || index.some(a => a.key === it.key)))
      .map(it => {
        const base = it.icon || LOGO;
        let p1, p2;

        if (base.includes('icon_album') && !base.includes('Fav_logo')) {
          p1 = isMob ? base.replace(/icon_album\/(.+)\.png$/, 'icon_album/mobile/$1@1x.jpg') : base.replace(/\.png$/, '@1x.png');
          p2 = isMob ? p1.replace(/@1x\.jpg$/, '@2x.jpg') : p1.replace(/@1x\.png$/, '@2x.png');
        } else {
          p1 = base;
          p2 = base;
        }
        
        // FIX: Add data-akey for E2E consistency
        return `<div class="album-icon" data-album="${it.key}" data-akey="${it.key}" title="${escHtml(it.title)}">
          <img src="${p1}" srcset="${p2} 2x" alt="${escHtml(it.title)}" draggable="false" loading="lazy" width="60" height="60">
        </div>`;
      }).join('');
  }

  _bindEvents() {
    $('album-icons')?.addEventListener('click', (e) => {
      const el = e.target.closest('.album-icon');
      if (!el) return;
      const key = el.dataset.album;
      
      if (this.curr === key && !key.startsWith('__')) {
        this.galVis = !this.galVis;
        const w = $('cover-wrap');
        if (w) w.style.display = this.galVis ? '' : 'none';
        window.NotificationSystem?.info(this.galVis ? 'üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –ø–æ–∫–∞–∑–∞–Ω–∞' : 'üö´ –ì–∞–ª–µ—Ä–µ—è —Å–∫—Ä—ã—Ç–∞');
      } else {
        this.loadAlbum(key);
      }
    });

    $('track-list')?.addEventListener('click', (e) => {
      // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –°—Ä–∞–∑—É –∂–µ –≥–æ—Ç–æ–≤–∏–º –∞—É–¥–∏–æ-–∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ –∫–ª–∏–∫—É (User Gesture)
      if (window.playerCore?.prepareContext) window.playerCore.prepareContext();

      // M1: –í —Ä–µ–∂–∏–º–µ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç bindsFavoritesList (scripts/ui/favorites-view.js)
      // —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Soft Delete (—Å–µ—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏) –∏ –º–æ–¥–∞–ª–∫–∏.
      if (this.curr === FAV) return;

      const trk = e.target.closest('.track');
      if (!trk) return;

      const aKey = toStr(trk.dataset.album).trim();
      const uid = toStr(trk.dataset.uid).trim();
      
      if (!aKey || aKey.startsWith('__')) return;

      if (e.target.classList.contains('like-star')) {
        e.preventDefault(); e.stopPropagation();
        if (uid && window.playerCore) {
          const next = !window.playerCore.isFavorite(uid);
          e.target.src = next ? STAR_ON : STAR_OFF;
          e.target.classList.add('animating');
          setTimeout(() => e.target.classList.remove('animating'), 320);
          window.playerCore.toggleFavorite(uid, { fromAlbum: true, albumKey: aKey });
        }
        return;
      }

      const data = this.cache.get(aKey);
      if (!data) return;

      this.playing = aKey; 

      const tracks = data.tracks.filter(t => t.src).map(t => ({
        src: t.src, sources: t.sources, title: t.title, artist: data.artist,
        album: data.title, cover: this.covers.get(aKey) || LOGO,
        uid: t.uid, lyrics: t.lyrics, fulltext: t.fulltext, hasLyrics: t.hasLyrics,
        sourceAlbum: aKey 
      }));
      
      const pIdx = tracks.findIndex(t => t.uid === uid);
      if (pIdx === -1) return;

      const curSnap = window.playerCore.getPlaylistSnapshot() || [];
      if (curSnap.length !== tracks.length || curSnap[0]?.sourceAlbum !== aKey) {
        window.playerCore.setPlaylist(tracks, pIdx, null, { preservePosition: false });
      }

      this.highlightCurrentTrack(pIdx);
      window.playerCore.play(pIdx);
      
      window.PlayerUI?.ensurePlayerBlock?.(pIdx, { userInitiated: true });
    });

    window.playerCore?.onFavoritesChanged((d) => {
      const s = d?.liked ? STAR_ON : STAR_OFF;
      // F2: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–≤–µ–∑–¥ –¥–∞–∂–µ –µ—Å–ª–∏ albumKey –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω (–∏—â–µ–º –ø–æ uid)
      const sel = d?.albumKey 
        ? `.like-star[data-album="${CSS.escape(d.albumKey)}"][data-uid="${CSS.escape(d.uid)}"]`
        : `.like-star[data-uid="${CSS.escape(d?.uid)}"]`;
      document.querySelectorAll(sel).forEach(el => el.src = s);
    });
  }

  async loadAlbum(key) {
    if (this.loading) return;
    this.loading = true;
    this.galVis = true;

    try {
      $('track-list').innerHTML = '';
      $('social-links').innerHTML = '';
      window.GalleryManager?.clear?.();

      if (key === FAV) await (await import('./albums/specials.js')).loadFavoritesAlbum(this);
      else if (key === NEWS) await (await import('./albums/specials.js')).loadNewsAlbum(this);
      else await this._loadReg(key);

      this.curr = key;
      localStorage.setItem('currentAlbum', key);
      
      document.querySelectorAll('.album-icon').forEach(el => el.classList.toggle('active', el.dataset.album === key));
      $('track-list')?.classList.remove('filtered');
      
      window.PlayerUI?.switchAlbumInstantly?.(key);
    } catch (e) {
      console.error(e);
      window.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
    } finally {
      this.loading = false;
    }
  }

  async _loadReg(key) {
    const info = window.albumsIndex?.find(a => a.key === key);
    if (!info) throw new Error(`Album ${key} missing`);

    let data = this.cache.get(key);
    if (!data) {
      const base = info.base.endsWith('/') ? info.base : `${info.base}/`;
      const res = await fetch(`${base}config.json`);
      if (!res.ok) throw new Error(`Config err`);
      const raw = await res.json();
      
      data = {
        title: raw.albumName || info.title,
        artist: raw.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        links: (raw.social_links || raw.socials || []).map(s => ({ label: s.title || s.label, url: s.url })),
        tracks: (raw.tracks || []).map((t, i) => this._normTrack(t, i, base, key, raw.albumName || info.title))
      };
      this.cache.set(key, data);
    }

    await window.GalleryManager?.loadGallery?.(key);
    const cover = await window.GalleryManager?.getFirstCoverUrl?.(key) || LOGO;
    this.covers.set(key, cover);

    if (window.GalleryManager?.getItemsCount?.() <= 0) $('cover-slot').innerHTML = `<img src="${LOGO}" alt="Cover">`;

    $('cover-wrap').style.display = '';
    this.renderAlbumTitle(data.title);
    this._renderSocials(data.links);
    
    $('track-list').innerHTML = data.tracks.map((t, i) => {
      const liked = t.uid && window.playerCore?.isFavorite?.(t.uid);
      return `<div class="track" id="trk${i}" data-index="${i}" data-album="${escHtml(key)}" data-uid="${escHtml(t.uid)}">
        <div class="tnum">${String(t.num).padStart(2,'0')}.</div>
        <div class="track-title">${escHtml(t.title)}</div>
        <img src="${liked ? STAR_ON : STAR_OFF}" class="like-star" alt="‚òÖ" data-album="${escHtml(key)}" data-uid="${escHtml(t.uid)}">
      </div>`;
    }).join('');
    
    window.PlayerUI?.updateMiniHeader?.();
  }

  _normTrack(t, i, base, key, albumTitle) {
    const hi = toUrl(base, t.audio), lo = toUrl(base, t.audio_low);
    const uid = toStr(t.uid).trim() || null;
    
    if (uid) registerTrack({
      uid, title: t.title, audio: hi, audio_low: lo,
      size: t.size, size_low: t.size_low,
      lyrics: toUrl(base, t.lyrics), fulltext: toUrl(base, t.fulltext),
      sourceAlbum: key
    }, { title: albumTitle });

    return {
      num: i + 1, title: t.title || `–¢—Ä–µ–∫ ${i + 1}`, uid, src: hi,
      sources: (hi || lo) ? { audio: { hi, lo } } : null,
      lyrics: toUrl(base, t.lyrics), fulltext: toUrl(base, t.fulltext), hasLyrics: t.hasLyrics ?? !!t.lyrics
    };
  }

  _renderSocials(links) {
    $('social-links').innerHTML = (links || []).filter(l => l.url).map(l => 
      `<a href="${l.url}" target="_blank" rel="noopener noreferrer">${l.label}</a>`
    ).join('');
  }

  highlightCurrentTrack(i, { uid, albumKey } = {}) {
    document.querySelectorAll('.track.current').forEach(n => n.classList.remove('current'));
    let sel;
    if (this.curr === FAV && uid && albumKey) sel = `.track[data-album="${CSS.escape(albumKey)}"][data-uid="${CSS.escape(uid)}"]`;
    else if (uid) sel = `.track[data-uid="${CSS.escape(uid)}"]`;
    else if (i >= 0) sel = `.track[data-index="${i}"]`;
    if (sel) document.querySelector(sel)?.classList.add('current');
  }

  getCurrentAlbum() { return this.curr; }
  getPlayingAlbum() { return this.playing; }
  setPlayingAlbum(k) { this.playing = k; }
  
  renderAlbumTitle(t, mod) {
    const el = $('active-album-title');
    if(el) { el.textContent = t; el.className = `active-album-title ${mod||''}`; }
  }
}

window.AlbumsManager = new AlbumsManager();
export default window.AlbumsManager;

//=================================================
// FILE: /scripts/app/albums/specials.js
import { $ } from '../utils/app-utils.js';
import { renderFavoritesList, renderFavoritesEmpty, bindFavoritesList } from '../../ui/favorites-view.js';
import { loadAndRenderNewsInline } from '../../ui/news-inline.js';

const FAV = window.SPECIAL_FAVORITES_KEY || '__favorites__';
const NEWS = window.SPECIAL_RELIZ_KEY || '__reliz__';
const FAV_COVER = 'img/Fav_logo.png';

// --- Favorites Logic ---

export async function loadFavoritesAlbum(ctx) {
  ctx.renderAlbumTitle('‚≠ê‚≠ê‚≠ê –ò–ó–ë–†–ê–ù–ù–û–ï ‚≠ê‚≠ê‚≠ê', 'fav');

  // FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π –º–µ—Ç–æ–¥ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ
  if (window.preloadAllAlbumsTrackIndex) {
     await window.preloadAllAlbumsTrackIndex(); 
  }

  $('cover-wrap').style.display = 'none';
  const container = $('track-list');
  if (!container) return;

  const refreshData = async () => { try { await window.FavoritesUI?.buildFavoritesRefsModel(); } catch {} };
  const getUiModel = () => window.FavoritesUI?.getModel() || [];

  const rebuild = async () => {
    await refreshData();
    const model = getUiModel();
    if (!model.length) renderFavoritesEmpty(container);
    else renderFavoritesList(container, model);
  };

  if (!ctx._favoritesViewBound) {
    ctx._favoritesViewBound = true;

    bindFavoritesList(container, {
      getModel: getUiModel,

      onStarClick: async ({ uid, albumKey }) => {
        if (ctx.getCurrentAlbum() !== FAV) return;
        // FIX: —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º source='favorites'
        window.playerCore?.toggleFavorite?.(uid, { source: 'favorites', albumKey });
      },

      onActiveRowClick: async ({ uid }) => {
        if (ctx.getCurrentAlbum() !== FAV) return;

        const model = getUiModel();
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        const activeList = model.filter((it) => it && it.__active && !it.isGhost);
        
        // FIX: –ò—â–µ–º –ø–æ __uid, —Ç–∞–∫ –∫–∞–∫ –º–æ–¥–µ–ª—å Favorites UI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ –ø–æ–ª–µ
        const idx = activeList.findIndex((it) => String(it?.__uid || '').trim() === String(uid || '').trim());
        
        if (idx >= 0) await ensureFavoritesPlayback(ctx, activeList, idx);
      },

      onInactiveRowClick: ({ uid, title }) => {
        if (ctx.getCurrentAlbum() !== FAV) return;
        
        // –í–ê–ñ–ù–û: –ù–∏–∫–∞–∫–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –º–æ–¥–∞–ª–∫–∞
        window.playerCore?.showInactiveFavoriteModal?.({
          uid, title,
          onDeleted: async () => {
            await rebuild();
            window.PlayerUI?.updateAvailableTracksForPlayback?.();
          },
        });
      },
    });

    window.playerCore?.onFavoritesChanged(async () => {
      if (ctx.getCurrentAlbum() === FAV) {
        await rebuild();
        window.PlayerUI?.updateAvailableTracksForPlayback?.();
      }
    });
  }

  await rebuild();
}

export async function ensureFavoritesPlayback(ctx, activeList, activeIndex) {
  if (!activeList?.length) return window.NotificationSystem?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');

  ctx.setPlayingAlbum(FAV);

  // FIX: –ù–µ –¥–µ–ª–∞–µ–º spread ...it, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –æ–±—ä–µ–∫—Ç —Ç—Ä–µ–∫–∞ UI-–º—É—Å–æ—Ä–æ–º (__active, __uid –∏ —Ç.–¥.)
  // –°–æ–±–∏—Ä–∞–µ–º —á–∏—Å—Ç—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –ø–ª–µ–µ—Ä–∞.
  const tracks = activeList.map((it) => {
      const srcAlbum = it.sourceAlbum || it.__a;
      return {
        uid: it.__uid, // ensure uid is passed
        title: it.title,
        artist: it.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', // –í –ø–ª–µ–µ—Ä–µ –ø–∏—à–µ–º "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
        cover: FAV_COVER,   // –û–±–ª–æ–∂–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        src: it.audio || it.src, // Audio url
        audio: it.audio || it.src,
        audio_low: it.audio_low,
        sources: it.sources,
        lyrics: it.lyrics,
        fulltext: it.fulltext,
        sourceAlbum: srcAlbum
      };
  });

  window.playerCore.setPlaylist(
    tracks,
    activeIndex,
    { artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞', album: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', cover: FAV_COVER },
    { preservePosition: false }
  );

  window.playerCore.play(activeIndex);
  
  const clicked = activeList[activeIndex];
  // FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º __uid
  ctx.highlightCurrentTrack(-1, { 
      uid: String(clicked?.__uid).trim(), 
      albumKey: String(clicked?.sourceAlbum || clicked?.__a).trim() 
  });

  window.PlayerUI?.ensurePlayerBlock?.(activeIndex, { userInitiated: true });
  window.PlayerUI?.updateAvailableTracksForPlayback?.();
}

// --- News Logic ---
export async function loadNewsAlbum(ctx) {
  ctx.renderAlbumTitle('üì∞ –ù–û–í–û–°–¢–ò üì∞', 'news');
  
  // FIX: –ò—Å–ø–æ–ª—å–∑—É–µ–º window.GalleryManager –Ω–∞–ø—Ä—è–º—É—é
  if (window.GalleryManager?.loadGallery) {
      await window.GalleryManager.loadGallery(NEWS);
  }
  
  $('cover-wrap').style.display = '';
  const container = $('track-list');
  if (container) await loadAndRenderNewsInline(container);
}

//=================================================
// FILE: /scripts/app/gallery.js
// scripts/app/gallery.js
const W = window, D = document;
const CACHE_404 = 'gallery_404_cache:v1';
const MAP = { 
  'krevetochka': '00', 'mezhdu-zlom-i-dobrom': '01', 
  'golos-dushi': '02', 'odnazhdy-v-skazke': '03', '__reliz__': 'news' 
};
const BASE = './albums/gallery/';
const LOGO = 'img/logo.png';

const $ = (id) => D.getElementById(id);
const ss = (k, v) => { 
  try { 
    if(v===undefined) return JSON.parse(sessionStorage.getItem(k)||'{}'); 
    sessionStorage.setItem(k, JSON.stringify(v)); 
  } catch(e){ return {}; } 
};

class GalleryManager {
  constructor() {
    this.it = [];
    this.idx = 0;
    this.tm = null;
    this.lck = false;
    this.pre = new Set();
    this.ldr = null;
  }

  initialize() {
    const go = (d) => this.it.length > 1 && (this.show((this.idx + d + this.it.length) % this.it.length), this.play());
    $('cover-gallery-arrow-left')?.addEventListener('click', () => go(-1));
    $('cover-gallery-arrow-right')?.addEventListener('click', () => go(1));

    const w = $('cover-wrap');
    if (w) {
      let x = 0;
      w.addEventListener('touchstart', e => x = e.touches[0].clientX, {passive:true});
      w.addEventListener('touchend', e => {
        if (x === null) return;
        const d = e.changedTouches[0].clientX - x;
        if (Math.abs(d) > 50) go(d > 0 ? -1 : 1);
        x = null;
      }, {passive:true});
    }

    D.addEventListener('visibilitychange', () => D.hidden ? this.stop() : (this.it.length > 1 && this.play()));
  }

  _id(k) { return (k && k !== '__favorites__' && MAP[k]) || null; }

  async loadGallery(key) {
    this.stop();
    this.it = [];
    this.idx = 0;
    
    const id = this._id(key);
    const slot = $('cover-slot');
    const setLogo = () => { if(slot) slot.innerHTML = `<img src="${LOGO}" alt="Cover" draggable="false">`; this._nav(); };

    if (!id || ss(CACHE_404)[id]) return setLogo();

    try {
      const dir = `${BASE}${id}/`;
      const r = await fetch(`${dir}index.json`, { cache: 'force-cache' });
      if (!r.ok) {
        if (r.status === 404) ss(CACHE_404, { ...ss(CACHE_404), [id]: 1 });
        throw 0;
      }
      const d = await r.json();
      this.it = (Array.isArray(d.items) ? d.items : (Array.isArray(d) ? d : []))
        .map(i => this._norm(i, dir)).filter(Boolean);

      if (this.it.length) {
        this.show(0);
        this.play();
      } else setLogo();
    } catch { setLogo(); }
    this._nav();
  }

  _norm(i, dir) {
    if (!i) return null;
    const abs = (p) => {
      if (!p) return null;
      return /^(https?:)?\/\//.test(p) ? p : (/^(albums|img|icons)\//.test(p) ? './'+p : dir + p);
    };
    if (typeof i === 'string') return /\.html([?#]|$)/i.test(i) ? { t: 'html', s: abs(i) } : { t: 'img', s: abs(i) };
    const t = (i.type||'').toLowerCase() === 'html' ? 'html' : 'img';
    if (t === 'html') return { t, s: abs(i.src) };
    const f = i.formats || {};
    return { t, s: abs(f.full||i.src), w: abs(f.webp), f: { w: abs(f.webp), f: abs(f.full||i.src) } };
  }

  show(i) {
    if (this.lck || !this.it.length) return;
    this.lck = true;
    this.idx = i;
    
    const it = this.it[i];
    const slot = $('cover-slot');
    if (!slot || !it) return (this.lck = false);

    // FIX BUG-4: Correct cleanup
    if (this.ldr) { 
        this.ldr.onload = null; 
        this.ldr.onerror = null; 
        this.ldr.src = ''; 
        this.ldr = null; 
    }

    const finish = () => { setTimeout(() => { this._pre(); this.lck = false; }, 200); };

    while(slot.firstChild) slot.removeChild(slot.firstChild);

    if (it.t === 'html') {
      const f = D.createElement('iframe');
      f.sandbox = 'allow-scripts allow-popups allow-forms';
      f.referrerPolicy = 'no-referrer';
      f.loading = 'lazy';
      f.src = it.s;
      slot.appendChild(f);
      finish();
    } else {
      const img = new Image();
      this.ldr = img;
      img.decoding = 'async';
      img.referrerPolicy = 'no-referrer';
      img.src = it.w || it.s;
      
      img.onload = () => {
        if (this.ldr !== img) return;
        const p = D.createElement('picture');
        if (it.w) { const s = D.createElement('source'); s.type = 'image/webp'; s.srcset = it.w; p.appendChild(s); }
        const el = D.createElement('img');
        el.src = it.s;
        el.alt = 'Cover';
        el.decoding = 'async';
        el.referrerPolicy = 'no-referrer';
        el.style.cssText = 'opacity:0;transition:opacity .15s ease-out';
        p.appendChild(el);
        slot.appendChild(p);
        requestAnimationFrame(() => el.style.opacity = '1');
        finish();
      };
      img.onerror = finish;
    }
  }

  _pre() {
    if (this.it.length < 2) return;
    const n = this.it[(this.idx + 1) % this.it.length];
    if (n?.t === 'img' && n.w && !this.pre.has(n.w)) {
      if (this.pre.size > 20) this.pre.clear();
      (new Image()).src = n.w;
      this.pre.add(n.w);
    }
  }

  _nav() {
    $('cover-wrap')?.classList.toggle('gallery-nav-ready', this.it.length > 1);
  }

  play() {
    this.stop();
    if (this.it.length > 1) this.tm = setInterval(() => this.show((this.idx + 1) % this.it.length), 5000);
  }

  stop() { if (this.tm) clearInterval(this.tm); this.tm = null; }

  clear() {
    this.stop();
    this.it = [];
    this.pre.clear();
    this.ldr = null;
    if ($('cover-slot')) $('cover-slot').innerHTML = '';
    this._nav();
  }

  getItemsCount() { return this.it.length; }
  getCurrentIndex() { return this.idx; }

  async getFirstCoverUrl(key) {
    const id = this._id(key);
    if (!id) return LOGO;
    try {
      const dir = `${BASE}${id}/`;
      const r = await fetch(`${dir}index.json`, { cache: 'force-cache' });
      if (!r.ok) return LOGO;
      const d = await r.json();
      const i = (d.items||d||[])[0];
      if (!i) return LOGO;
      const n = this._norm(i, dir);
      return (n.t === 'img' ? (n.w || n.s) : LOGO);
    } catch { return LOGO; }
  }
}

W.GalleryManager = new GalleryManager();
export default W.GalleryManager;

//=================================================
// FILE: /scripts/app/navigation.js
// scripts/app/navigation.js
// –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

class NavigationManager {
  constructor() {
    this.activeModal = null;
    this.U = window.Utils;
    this.$ = (id) => this.U.dom.byId(id);
    this.on = (el, ev, fn, opts) => this.U.dom.on(el, ev, fn, opts);
  }

  initialize() {
    this.setupEventListeners();
    console.log('‚úÖ NavigationManager initialized');
  }

  setupEventListeners() {
    const feedbackLink = this.$('feedback-link');
    this.on(feedbackLink, 'click', (e) => {
      e.preventDefault();
      this.showFeedbackModal();
    });

    const supportLink = this.$('support-link');
    if (supportLink) {
      supportLink.href = window.APP_CONFIG?.SUPPORT_URL || 'https://example.com/support';
    }

    const hotkeysBtn = this.$('hotkeys-btn');
    this.on(hotkeysBtn, 'click', (e) => {
      e.preventDefault();
      this.showHotkeysModal();
    });
  }

  showFeedbackModal() {
    this.closeModal();
    if (!window.Modals?.open) return;

    this.activeModal = window.Modals.open({
      title: '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å',
      maxWidth: 420,
      bodyHtml: `
        <p style="margin-bottom:20px; color:#8ab8fd; text-align:center;">
          –ï—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞—à–ª–∏ –æ—à–∏–±–∫—É?<br>–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º!
        </p>
        <div style="display:flex; flex-direction:column; gap:15px; max-width:300px; margin:0 auto;">
          <a href="https://t.me/vitrina_razbita" target="_blank"
             style="background:#0088cc; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            Telegram
          </a>
          <a href="mailto:${window.APP_CONFIG?.SUPPORT_EMAIL || 'support@vitrina-razbita.ru'}" target="_blank"
             style="background:#4daaff; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            Email
          </a>
          <a href="${window.APP_CONFIG?.GITHUB_URL || 'https://github.com/apel-s-in/vi3na1bita-music'}" target="_blank"
             style="background:#333; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            GitHub
          </a>
        </div>
      `
    });
  }

  showHotkeysModal() {
    this.closeModal();
    if (!window.Modals?.open) return;

    this.activeModal = window.Modals.open({
      title: '–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏',
      maxWidth: 520,
      bodyHtml: `
        <div class="hotkeys-section">
          <h3 style="color:#8ab8fd; margin-bottom:12px;">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
          <div class="hotkey-item"><span class="hotkey-combo">K / –ü—Ä–æ–±–µ–ª</span><span class="hotkey-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">X</span><span class="hotkey-desc">–°—Ç–æ–ø</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">N / P</span><span class="hotkey-desc">–°–ª–µ–¥—É—é—â–∏–π/–ü—Ä–µ–¥—ã–¥—É—â–∏–π</span></div>
        </div>
        <div class="hotkeys-section">
          <h3 style="color:#8ab8fd; margin-bottom:12px;">–†–µ–∂–∏–º—ã</h3>
          <div class="hotkey-item"><span class="hotkey-combo">R</span><span class="hotkey-desc">–ü–æ–≤—Ç–æ—Ä</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">U</span><span class="hotkey-desc">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">F</span><span class="hotkey-desc">–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">T</span><span class="hotkey-desc">–¢–∞–π–º–µ—Ä —Å–Ω–∞</span></div>
        </div>
      `
    });
  }

  closeModal() {
    if (!this.activeModal) return;
    try { this.activeModal.remove(); } catch {}
    this.activeModal = null;
  }
}

window.NavigationManager = new NavigationManager();

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    try { window.NavigationManager.initialize(); } catch (e) { console.warn('NavigationManager init failed:', e); }
  });
} else {
  try { window.NavigationManager.initialize(); } catch (e) { console.warn('NavigationManager init failed:', e); }
}

export default NavigationManager;

//=================================================
// FILE: /scripts/app/offline-ui-bootstrap.js
import { getOfflineManager as _getMgr } from '../offline/offline-manager.js';
import { openOfflineModal } from '../ui/offline-modal.js';

// Singleton instance holder
const UI = window.OfflineUI = window.OfflineUI || { offlineManager: _getMgr() };
const KEY_ALERT = 'offline:alert:v1';

// Helpers
const $ = (id) => document.getElementById(id);
const getAlert = () => { try { return JSON.parse(localStorage.getItem(KEY_ALERT)); } catch { return null; } };

export function attachOfflineUI() {
  const btn = $('offline-btn');
  if (!btn) return;

  // 1. Badge Injection (Lazy & Fast)
  // –¢–ó: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä ‚Äú!‚Äù —Ä–∏—Å—É–µ—Ç—Å—è —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π (—Å–ª–µ–≤–∞).
  if (!$('offline-alert-badge')) {
    btn.insertAdjacentHTML('beforebegin', 
      `<span id="offline-alert-badge" style="display:none;margin-right:8px;font-weight:900;color:#ffcc00;cursor:pointer;font-size:18px;line-height:1" title="–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è">!</span>`
    );
  }
  const badge = $('offline-alert-badge');
  if (badge) {
    badge.onclick = (e) => { 
      e.stopPropagation(); 
      // –¢–ó: toast x2 –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      window.NotificationSystem?.info('–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 6000); 
    };
  }

  // 2. Unified State Sync
  const update = () => {
    const mgr = UI.offlineManager;
    const isOff = mgr.isOfflineMode();
    const hasAlert = !!getAlert()?.on;

    btn.textContent = 'OFFLINE';
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞–º–∏ –¥–ª—è CSS (styles/main.css: .offline-btn.offline / .online)
    btn.className = `offline-btn ${isOff ? 'offline' : 'online'} ${hasAlert ? 'alert' : ''}`;
    
    if (badge) badge.style.display = hasAlert ? 'inline-block' : 'none';
  };

  // 3. Bindings
  btn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); openOfflineModal(); };
  
  // React to global UI changes and specific manager progress
  const refresh = () => requestAnimationFrame(update);
  window.addEventListener('offline:uiChanged', refresh);
  
  const mgr = UI.offlineManager;
  mgr.on('progress', (e) => { 
    if (e?.phase === 'cqChanged' || e?.phase === 'cloudSettingsChanged') refresh(); 
  });

  // 4. Boot
  mgr.initialize().then(refresh);
  refresh();
}

export const getOfflineManager = () => UI.offlineManager;

//=================================================
// FILE: /scripts/app/playback-cache-bootstrap.js
// scripts/app/playback-cache-bootstrap.js
import { PlaybackCacheManager } from '../offline/playback-cache.js';
import { getTrackByUid } from './track-registry.js';

function getPQ() {
  try {
    const q = String(localStorage.getItem('qualityMode:v1') || 'hi').toLowerCase();
    return (q === 'lo') ? 'lo' : 'hi';
  } catch { return 'hi'; }
}

function getFavoritesInactiveSet() {
  try {
    const pc = window.playerCore;
    if (!pc?.getFavoritesState) return new Set();
    const st = pc.getFavoritesState();
    const inactive = Array.isArray(st?.inactive) ? st.inactive : [];
    const set = new Set();
    inactive.forEach((t) => {
      const uid = String(t?.uid || '').trim();
      if (uid) set.add(uid);
    });
    return set;
  } catch {
    return new Set();
  }
}

export function attachPlaybackCache() {
  const pc = window.playerCore;
  if (!pc) {
    setTimeout(attachPlaybackCache, 200);
    return;
  }

  let lastIndex = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
  let lastLen = 0;
  let direction = 'forward';

  const getPlaylistCtx = () => {
    const list = (typeof pc.getPlaylistSnapshot === 'function') ? (pc.getPlaylistSnapshot() || []) : [];
    const cur = pc.getCurrentTrack?.() || null;
    const curUid = cur?.uid ? String(cur.uid).trim() : null;
    lastLen = Array.isArray(list) ? list.length : 0;
    
    const playingAlbum = window.AlbumsManager?.getPlayingAlbum?.() || null;
    const favoritesInactive = (playingAlbum === window.SPECIAL_FAVORITES_KEY)
      ? getFavoritesInactiveSet()
      : new Set();

    return { list, curUid, favoritesInactive, direction };
  };

  const mgr = window.OfflineUI?.offlineManager;
  const queue = mgr?.queue || null;

  const pcm = new PlaybackCacheManager({ queue, getPlaylistCtx });
  const trackProvider = (uid) => getTrackByUid(uid);

  async function planWindow() {
    // CRITICAL FIX: Use ActivePlaybackQuality (respects R2/CQ), fallback to PQ
    const mgr = window.OfflineUI?.offlineManager;
    const activeQ = mgr?.getActivePlaybackQuality ? mgr.getActivePlaybackQuality() : getPQ();

    try { 
      await pcm.ensureWindowFullyCached(activeQ, trackProvider); 
      
      const currentWindow = pcm.getLastWindow(); 
      const uids = [currentWindow.cur, ...currentWindow.prev, ...currentWindow.next].filter(Boolean);
      
      if (mgr?.updatePlaybackWindow) {
        mgr.updatePlaybackWindow(uids);
      }
    } catch (e) {
      console.warn('[PlaybackCache] planWindow error:', e);
    }
  }

  function updateDirectionByIndex(newIndex) {
    const len = lastLen || ((pc.getPlaylistSnapshot?.() || []).length);
    if (!len || newIndex < 0 || lastIndex < 0) {
      direction = 'forward';
      lastIndex = newIndex;
      return;
    }
    const prev = (lastIndex - 1 + len) % len;
    const next = (lastIndex + 1) % len;

    if (newIndex === prev) { direction = 'backward'; lastIndex = newIndex; return; }
    if (newIndex === next) { direction = 'forward'; lastIndex = newIndex; return; }

    direction = 'forward';
    lastIndex = newIndex;
  }

  if (typeof pc.on === 'function') {
    pc.on({
      onTrackChange: () => {
        const idx = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
        updateDirectionByIndex(idx);
        planWindow();
      }
    });
  }

  const btnNext = document.getElementById('next-btn');
  const btnPrev = document.getElementById('prev-btn');
  btnNext?.addEventListener('click', () => { direction = 'forward'; setTimeout(planWindow, 0); });
  btnPrev?.addEventListener('click', () => { direction = 'backward'; setTimeout(planWindow, 0); });

  setTimeout(() => {
    lastIndex = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
    planWindow();
  }, 100);
}

//=================================================
// FILE: /scripts/app/playback-policy.js
(function(W){
  'use strict';
  
  const LS_KEY = 'favoritesOnlyMode';
  const FAV_KEY = window.SPECIAL_FAVORITES_KEY || '__favorites__';

  const pc = () => W.playerCore;
  const ls = () => localStorage.getItem(LS_KEY) === '1';

  const Policy = {
    apply: () => {
      const core = pc();
      if (!core) return;

      const alb = W.AlbumsManager?.getPlayingAlbum();
      if (!alb) return;

      const isFavAlbum = alb === FAV_KEY;
      const needFilter = isFavAlbum || ls();

      const source = core.originalPlaylist || [];
      // –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç, —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–µ—á–µ–≥–æ
      if (!source.length) return;

      let target = source;

      if (needFilter) {
        if (isFavAlbum) {
           // M1: –í –∞–ª—å–±–æ–º–µ Favorites –ø–ª–µ–π–ª–∏—Å—Ç —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω UI, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –µ–≥–æ
           return;
        } else {
           const likedUids = new Set(core.getLikedUidsForAlbum(alb));
           target = source.filter(t => t.uid && likedUids.has(t.uid));
        }

        // –í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–∫–æ–≤ –Ω–µ—Ç (–∏ —ç—Ç–æ –Ω–µ –∞–ª—å–±–æ–º –ò–∑–±—Ä–∞–Ω–Ω–æ–µ, –≥–¥–µ –ø—É—Å—Ç–æ—Ç–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ –¥–ª—è F —Ä–µ–∂–∏–º–∞)
        if (!target.length) {
          if (!isFavAlbum) {
             W.NotificationSystem?.info('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤. –†–µ–∂–∏–º –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω.');
             // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ UI, —Ç–∞–∫ –∫–∞–∫ —Ä–µ–∂–∏–º –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è
             W.Utils?.lsSetBool01(LS_KEY, false);
             W.PlayerUI?.updateFavoritesBtn?.(); // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
          }
          return; 
        }
      }

      const cur = core.getCurrentTrack();
      const curUid = cur?.uid;
      
      let newIdx = target.findIndex(t => t.uid === curUid);
      const trackLost = newIdx === -1;

      if (trackLost) {
        const origIdx = source.findIndex(t => t.uid === curUid);
        if (origIdx >= 0) {
            for(let i = origIdx + 1; i < source.length; i++) {
                const nextUid = source[i].uid;
                newIdx = target.findIndex(t => t.uid === nextUid);
                if (newIdx !== -1) break;
            }
        }
        if (newIdx === -1) newIdx = 0;
      }

      const shuffle = core.isShuffle();
      
      core.setPlaylist(target, Math.max(0, newIdx), {}, {
        preserveOriginalPlaylist: true,
        preserveShuffleMode: true,
        preservePosition: !trackLost
      });

      if (shuffle) core.shufflePlaylist(); 

      W.PlayerUI?.updateAvailableTracksForPlayback?.();
      W.PlayerUI?.updatePlaylistFiltering?.();
    }
  };

  const bind = () => {
    if (pc()) {
      pc().onFavoritesChanged(() => {
        if (ls() || W.AlbumsManager?.getPlayingAlbum() === FAV_KEY) {
          Policy.apply();
        }
      });
    } else setTimeout(bind, 100);
  };
  bind();

  W.PlaybackPolicy = Policy;
})(window);

//=================================================
// FILE: /scripts/app/player-ui.js
// scripts/app/player-ui.js
(function (W, D) {
    'use strict';

    const PlayerUI = {};
    const U = W.Utils;
    
    let dom = {};
    let state = {
        isMiniMode: false,
        isSeeking: false,
        isBitEnabled: false,
        miniSavedState: null,
        analyzer: null,
        rafId: null
    };

    function init() {
        if (!W.playerCore || !W.albumsIndex) return setTimeout(init, 100);

        // Bind Core Events
        W.playerCore.on({
            onTrackChange: handleTrackChange,
            onPlay: updatePlayPauseIcon,
            onPause: updatePlayPauseIcon,
            onStop: updatePlayPauseIcon,
            onEnd: updatePlayPauseIcon,
            onTick: handleTick
        });

        W.playerCore.onFavoritesChanged(() => {
            updateFavoritesBtn();
            updateMiniHeader();
            updatePlaylistFiltering();
        });

        W.addEventListener('offline:uiChanged', updatePQButtonState);
        W.addEventListener('online', updatePQButtonState);
        W.addEventListener('offline', updatePQButtonState);
        D.addEventListener('click', handleGlobalClick);

        const savedVol = U.math.toInt(U.lsGet('playerVolume'), 100);
        W.playerCore.setVolume(savedVol);
        
        state.isBitEnabled = U.lsGetBool01('bitEnabled');
        if (state.isBitEnabled) startVisualizer();

        updateFavoritesBtn();
    }

    function ensurePlayerBlock(index, options) {
        if (!dom.playerBlock) {
            const tpl = D.getElementById('player-template');
            if (!tpl) return;
            dom.playerBlock = tpl.content.cloneNode(true).querySelector('#lyricsplayerblock');
            cacheDomElements(dom.playerBlock);
            bindPlayerEvents();
        }

        const trackList = D.getElementById('track-list');
        dom.nowPlayingSlot = D.getElementById('now-playing');
        
        const newMiniMode = U.isBrowsingOtherAlbum();
        const modeChanged = state.isMiniMode !== newMiniMode;
        state.isMiniMode = newMiniMode;

        if (state.isMiniMode) {
            if (dom.nowPlayingSlot && (!dom.nowPlayingSlot.contains(dom.playerBlock) || modeChanged)) {
                dom.nowPlayingSlot.innerHTML = '';
                dom.nowPlayingSlot.append(getMiniHeader(), dom.playerBlock, getNextUp());
            }
            if (W.LyricsController) {
                if (state.miniSavedState === null) state.miniSavedState = W.LyricsController.getMiniSaveState();
                W.LyricsController.applyMiniMode();
            }
            if(dom.miniHeader) dom.miniHeader.style.display = 'flex';
            if(dom.nextUp) dom.nextUp.style.display = 'flex';
        } else {
            if (trackList) {
                const cur = W.playerCore.getCurrentTrack();
                const sel = cur?.uid ? `.track[data-uid="${CSS.escape(cur.uid)}"]` : `.track[data-index="${index}"]`;
                const row = trackList.querySelector(sel);
                
                if (row) {
                    if (row.nextSibling !== dom.playerBlock) row.after(dom.playerBlock);
                    if (options?.userInitiated) setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
                } else {
                    trackList.appendChild(dom.playerBlock);
                }
            }
            if (W.LyricsController) {
                W.LyricsController.restoreFromMiniMode(state.miniSavedState);
                state.miniSavedState = null;
            }
            if (dom.nowPlayingSlot) dom.nowPlayingSlot.innerHTML = '';
            if(dom.miniHeader) dom.miniHeader.style.display = 'none';
            if(dom.nextUp) dom.nextUp.style.display = 'none';
        }

        manageJumpButton();
        updatePQButtonState();
        updateFavoritesBtn();
        updatePlaylistFiltering();
        updateMiniHeader();
        updatePlayPauseIcon();
        updateDownloadState();
    }

    function cacheDomElements(blk) {
        const q = (s) => blk.querySelector(s);
        dom.fill = q('#player-progress-fill');
        // Cache overlay is handled by scripts/ui/cache-progress-overlay.js
        dom.bar = q('#player-progress-bar');
        dom.timeElapsed = q('#time-elapsed');
        dom.timeRemaining = q('#time-remaining');
        dom.volFill = q('#volume-fill');
        dom.volHandle = q('#volume-handle');
        dom.volSlider = q('#volume-slider');
        dom.icon = q('#play-pause-icon');
        dom.pqBtn = q('#pq-btn');
        dom.pqLabel = q('#pq-btn-label');
        dom.favBtn = q('#favorites-btn');
        dom.favIcon = q('#favorites-btn-icon');
    }

    function getMiniHeader() {
        if (dom.miniHeader) return dom.miniHeader;
        const tpl = D.getElementById('mini-header-template');
        dom.miniHeader = tpl.content.cloneNode(true).querySelector('#mini-now');
        dom.miniHeader.addEventListener('click', (e) => {
            if (e.target.id !== 'mini-now-star' && W.AlbumsManager) 
                W.AlbumsManager.loadAlbum(W.AlbumsManager.getPlayingAlbum());
        });
        dom.miniHeader.querySelector('#mini-now-star').addEventListener('click', (e) => {
            e.stopPropagation(); actions.toggleLike();
        });
        return dom.miniHeader;
    }

    function getNextUp() {
        if (dom.nextUp) return dom.nextUp;
        dom.nextUp = D.getElementById('next-up-template').content.cloneNode(true).querySelector('#next-up');
        return dom.nextUp;
    }

    function bindPlayerEvents() {
        if (dom.volSlider) {
            dom.volSlider.addEventListener('input', (e) => {
                const val = U.math.toInt(e.target.value);
                W.playerCore.setVolume(val);
                updateVolumeUI(val);
            });
        }
        if (dom.bar) {
            const move = (e) => {
                const rect = dom.bar.getBoundingClientRect();
                const x = e.touches ? e.touches[0].clientX : e.clientX;
                const p = U.math.clamp((x - rect.left) / rect.width, 0, 1);
                const d = W.playerCore.getDuration();
                if (d) W.playerCore.seek(d * p);
            };
            const up = () => {
                state.isSeeking = false;
                D.removeEventListener('pointermove', move);
                D.removeEventListener('pointerup', up);
            };
            dom.bar.addEventListener('pointerdown', (e) => {
                state.isSeeking = true;
                move(e);
                D.addEventListener('pointermove', move);
                D.addEventListener('pointerup', up);
            });
        }
    }

    function handleGlobalClick(e) {
        const btn = e.target.closest('button, a, .clickable-icon');
        if (btn?.id && actions[btn.id]) {
            e.preventDefault();
            actions[btn.id](btn);
        }
    }

    const actions = {
        'play-pause-btn': () => W.playerCore.isPlaying() ? W.playerCore.pause() : W.playerCore.play(),
        'prev-btn': () => W.playerCore.prev(),
        'next-btn': () => W.playerCore.next(),
        'stop-btn': () => W.playerCore.stop(),
        'shuffle-btn': (b) => { W.playerCore.toggleShuffle(); U.setBtnActive(b.id, W.playerCore.isShuffle()); updateMiniHeader(); },
        'repeat-btn': (b) => { W.playerCore.toggleRepeat(); U.setBtnActive(b.id, W.playerCore.isRepeat()); },
        'mute-btn': (b) => {
            const m = !b.classList.contains('active');
            if (W.playerCore.setMuted) W.playerCore.setMuted(m); // Optional support
            U.setBtnActive(b.id, m);
        },
        'pq-btn': () => {
            const r = U.pq.toggle();
            if (!r.ok) U.ui.toast(r.reason === 'trackNoLo' ? '–ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ' : r.reason === 'offline' ? '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ç–∏' : '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ', 'warning');
            updatePQButtonState();
        },
        'favorites-btn': () => actions.toggleFavoritesOnly(),
        'lyrics-toggle-btn': () => W.LyricsController?.toggleLyricsView(),
        'animation-btn': () => W.LyricsController?.toggleAnimation(),
        'lyrics-text-btn': () => W.LyricsModal?.show(),
        'pulse-btn': () => actions.togglePulse(),
        // 'sleep-timer-btn': handled by scripts/ui/sleep.js delegation
        'stats-btn': () => window.StatisticsModal?.show(),
        'track-download-btn': (b) => { if (!b.getAttribute('href')) U.ui.toast('–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'error'); }
    };

    function handleTrackChange(track, index) {
        W.__lastStatsSec = -1;
        W.AlbumsManager?.highlightCurrentTrack(track?.uid ? -1 : index, track?.uid ? { uid: track.uid, albumKey: track.sourceAlbum } : {});
        ensurePlayerBlock(index);
        W.LyricsController?.onTrackChange(track);
        updatePQButtonState();
        updateDownloadState();
    }

    function handleTick(pos, dur) {
        if (!state.isSeeking) {
            const p = dur > 0 ? (pos / dur) * 100 : 0;
            if (dom.fill) dom.fill.style.width = `${p}%`;
            if (dom.timeElapsed) dom.timeElapsed.textContent = U.fmt.time(pos);
            if (dom.timeRemaining) dom.timeRemaining.textContent = `-${U.fmt.time((dur || 0) - pos)}`;
        }
        W.LyricsController?.onTick(pos, { inMiniMode: state.isMiniMode });
    }

    function updatePlayPauseIcon() {
        if (!dom.icon) return;
        dom.icon.innerHTML = W.playerCore.isPlaying() 
            ? '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>' 
            : '<path d="M8 5v14l11-7z"/>';
    }

    function updateVolumeUI(v) {
        if (dom.volFill) dom.volFill.style.width = `${v}%`;
        if (dom.volHandle) dom.volHandle.style.left = `${U.math.clamp(v, 2, 98)}%`;
        if (dom.volSlider) dom.volSlider.value = v;
    }

    function updatePQButtonState() {
        if (!dom.pqBtn) return;
        
        // CRITICAL FIX: Hide button in R2/R3 modes
        const mgr = window.OfflineUI?.offlineManager;
        const mode = mgr ? mgr.getMode() : 'R0';
        
        if (mode === 'R2' || mode === 'R3') {
            dom.pqBtn.style.display = 'none';
            return;
        }
        
        dom.pqBtn.style.display = '';

        const s = U.pq.getState();
        let cls = 'player-control-btn ';
        if (!s.netOk) { cls += 'disabled'; dom.pqBtn.setAttribute('aria-disabled', 'true'); }
        else {
            cls += `pq-${s.mode}`;
            dom.pqBtn.setAttribute('aria-disabled', !s.canToggle);
            if (!s.canToggle) cls += ' disabled-soft';
        }
        dom.pqBtn.className = cls;
        if (dom.pqLabel) dom.pqLabel.textContent = s.mode === 'lo' ? 'Lo' : 'Hi';
    }

    function updateFavoritesBtn() {
        const on = U.lsGetBool01('favoritesOnlyMode');
        if (dom.favBtn) dom.favBtn.className = `player-control-btn ${on ? 'favorites-active' : ''}`;
        if (dom.favIcon) dom.favIcon.src = on ? 'img/star.png' : 'img/star2.png';
    }

    function updateMiniHeader() {
        if (!state.isMiniMode) return;
        const trk = W.playerCore.getCurrentTrack();
        const nxt = W.playerCore.getPlaylistSnapshot()?.[W.playerCore.getNextIndex()];

        if (dom.miniHeader) {
            const tnum = dom.miniHeader.querySelector('#mini-now-num');
            const tit = dom.miniHeader.querySelector('#mini-now-title');
            const star = dom.miniHeader.querySelector('#mini-now-star');
            if (tnum) tnum.textContent = `${String((W.playerCore.getIndex()||0)+1).padStart(2,'0')}.`;
            if (tit) tit.textContent = trk ? trk.title : '‚Äî';
            if (star) star.src = U.fav.isTrackLikedInContext({ playingAlbum: W.AlbumsManager?.getPlayingAlbum(), track: trk }) ? 'img/star.png' : 'img/star2.png';
        }
        if (dom.nextUp) {
            const t = dom.nextUp.querySelector('.title');
            if (t) t.textContent = nxt ? nxt.title : '‚Äî';
        }
    }

    function updatePlaylistFiltering() {
        const lst = D.getElementById('track-list');
        if (!lst) return;
        const on = U.lsGetBool01('favoritesOnlyMode');
        const ca = W.AlbumsManager?.getCurrentAlbum(), pa = W.AlbumsManager?.getPlayingAlbum();
        const filter = on && ca === pa && !U.isSpecialAlbumKey(ca);
        
        lst.classList.toggle('favonly-filtered', filter);
        if (filter) {
            const liked = new Set(W.playerCore.getLikedUidsForAlbum(ca) || []);
            lst.querySelectorAll('.track').forEach(r => {
                const u = r.dataset.uid;
                if(u && !liked.has(u)) r.setAttribute('data-hidden-by-favonly', '1');
                else r.removeAttribute('data-hidden-by-favonly');
            });
        }
    }

    function updateDownloadState() {
        const btn = D.getElementById('track-download-btn');
        if (btn) U.download.applyDownloadLink(btn, W.playerCore.getCurrentTrack());
    }

    actions.toggleFavoritesOnly = () => {
        const next = !U.lsGetBool01('favoritesOnlyMode');
        const pa = W.AlbumsManager?.getPlayingAlbum();
        
        if (next && pa !== W.SPECIAL_FAVORITES_KEY) {
            const l = W.playerCore.getLikedUidsForAlbum(pa);
            if (!l?.length) return U.ui.toast('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê', 'info');
        }

        U.lsSetBool01('favoritesOnlyMode', next);
        updateFavoritesBtn();
        W.PlaybackPolicy?.apply({ reason: 'toggle' });
        PlayerUI.updateAvailableTracksForPlayback();
        updatePlaylistFiltering();
        U.ui.toast(next ? '‚≠ê –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ' : '–ò–≥—Ä–∞—é—Ç –≤—Å–µ —Ç—Ä–µ–∫–∏', next ? 'success' : 'info');
    };

    actions.toggleLike = () => {
        const t = W.playerCore.getCurrentTrack();
        if (!t?.uid) return;
        const pa = W.AlbumsManager?.getPlayingAlbum();
        const aKey = t.sourceAlbum || (U.isSpecialAlbumKey(pa) ? null : pa);
        W.playerCore.toggleFavorite(t.uid, { fromAlbum: true, albumKey: aKey }); // Unified call
        updateMiniHeader();
    };

    actions.togglePulse = () => {
        state.isBitEnabled = !state.isBitEnabled;
        U.lsSetBool01('bitEnabled', state.isBitEnabled);
        D.getElementById('pulse-btn')?.classList.toggle('active', state.isBitEnabled);
        const h = D.getElementById('pulse-heart'); if(h) h.textContent = state.isBitEnabled ? '‚ù§Ô∏è' : 'ü§ç';
        state.isBitEnabled ? startVisualizer() : stopVisualizer();
    };

    function startVisualizer() {
        try { W.playerCore.sound?.html5 ? null : null; } catch(e){} // No-op check
        if (W.Howler?.ctx && !state.analyzer) {
            const ctx = W.Howler.ctx;
            if (ctx.state === 'suspended') ctx.resume();
            try {
                state.analyzer = ctx.createAnalyser();
                state.analyzer.fftSize = 256;
                W.Howler.masterGain.connect(state.analyzer);
            } catch {}
        }
        if (!state.analyzer) return;
        visualizerLoop();
    }

    function visualizerLoop() {
        if (!state.isBitEnabled) return;
        if (state.analyzer) {
            const len = state.analyzer.frequencyBinCount;
            const arr = new Uint8Array(len);
            state.analyzer.getByteFrequencyData(arr);
            let sum = 0;
            const lim = Math.floor(len * 0.3);
            for(let i=0; i<lim; i++) sum += arr[i];
            const scale = 1 + (sum / lim / 255) * 0.2;
            const l = D.getElementById('logo-bottom');
            if(l) l.style.transform = `scale(${scale})`;
        }
        state.rafId = requestAnimationFrame(visualizerLoop);
    }

    function stopVisualizer() {
        if (state.rafId) cancelAnimationFrame(state.rafId);
        const l = D.getElementById('logo-bottom');
        if(l) { l.style.transform = 'scale(1)'; setTimeout(()=>l.style.transition='',300); }
        state.analyzer = null;
    }

    function manageJumpButton() {
        if (!dom.jumpBtn) {
            dom.jumpBtn = D.createElement('div');
            dom.jumpBtn.className = 'jump-to-playing';
            dom.jumpBtn.innerHTML = '<button>‚Üë</button>';
            dom.jumpBtn.onclick = () => dom.playerBlock?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            D.body.appendChild(dom.jumpBtn);
        }
        if ('IntersectionObserver' in W && dom.playerBlock) {
            if (W.playerBlockObserver) W.playerBlockObserver.disconnect();
            W.playerBlockObserver = new IntersectionObserver(([e]) => {
                dom.jumpBtn.style.display = (!e.isIntersecting && !state.isMiniMode) ? 'flex' : 'none';
            }, { threshold: 0.1 });
            W.playerBlockObserver.observe(dom.playerBlock);
        }
    }

    PlayerUI.initialize = init;
    PlayerUI.ensurePlayerBlock = ensurePlayerBlock;
    PlayerUI.updateMiniHeader = updateMiniHeader;
    PlayerUI.updateNextUpLabel = updateMiniHeader;
    PlayerUI.togglePlayPause = actions['play-pause-btn'];
    PlayerUI.switchAlbumInstantly = (k) => { if(W.playerCore.getIndex()>=0) { ensurePlayerBlock(W.playerCore.getIndex()); updateMiniHeader(); } };
    
    PlayerUI.updateAvailableTracksForPlayback = () => {
        const pa = W.AlbumsManager?.getPlayingAlbum();
        const on = U.lsGetBool01('favoritesOnlyMode');
        if (pa !== W.SPECIAL_FAVORITES_KEY && on) {
            const snap = W.playerCore.getPlaylistSnapshot();
            W.availableFavoriteIndices = snap.reduce((acc, t, i) => { if(W.playerCore.isFavorite(t.uid)) acc.push(i); return acc; }, []);
        } else W.availableFavoriteIndices = null;
    };

    // Removed unused getters

    W.PlayerUI = PlayerUI;
    if (D.readyState === 'loading') D.addEventListener('DOMContentLoaded', init); else init();

})(window, document);

//=================================================
// FILE: /scripts/app/player-ui/lyrics.js
// scripts/app/player-ui/lyrics.js
// LyricsController ‚Äî Optimized JSON-only timed lyrics (v2.0)
// –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã: –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (no stop/play/seek), —Ç–æ–ª—å–∫–æ UI/fetch/cache.

(function () {
  'use strict';

  const W = window, D = document;
  const U = W.Utils;
  
  // Config & Keys
  const LS = { VIEW: 'lyricsViewMode', ANIM: 'lyricsAnimationEnabled' };
  const SS = { C404: 'lyrics_404_cache:v1', PRE: 'lyrics_cache_' };
  const MIN_INT = 250;
  const NO_LYR = '__NO_LYRICS__';

  // State
  let st = {
    list: [],       // current parsed lyrics
    has: false,     // has timed lyrics
    mode: 'normal', // normal | hidden | expanded
    anim: false,    // animation enabled
    lIdx: -1,       // last rendered index
    lTs: 0,         // last render timestamp
    pref: null,     // prefetched data
    prefUrl: null   // prefetched url
  };

  // --- Helpers ---
  const $ = (id) => D.getElementById(id);
  const qs = (s, p=D) => p?.querySelector(s);
  const esc = (s) => U?.escapeHtml ? U.escapeHtml(String(s||'')) : String(s||'');
  
  // Unified Storage Access (Safe)
  const store = (k, v) => {
    try { if(v===undefined) return localStorage.getItem(k); localStorage.setItem(k, v); } catch {}
  };
  const sess = (k, v) => {
    try { 
      if(v===undefined) { const r=sessionStorage.getItem(k); return r?JSON.parse(r):null; }
      sessionStorage.setItem(k, JSON.stringify(v));
    } catch {}
  };

  // 404 Cache Logic (LRU 50 items)
  const c404 = {
    get: () => sess(SS.C404) || {},
    has: (u) => !!c404.get()[u],
    add: (u) => {
      const m = c404.get();
      m[u] = Date.now();
      const k = Object.keys(m);
      if(k.length > 100) k.sort((a,b)=>m[a]-m[b]).slice(0,50).forEach(x=>delete m[x]);
      sess(SS.C404, m);
    }
  };

  // --- Core Logic ---

  function init() {
    st.mode = ['normal','hidden','expanded'].includes(store(LS.VIEW)) ? store(LS.VIEW) : 'normal';
    st.anim = store(LS.ANIM) === '1';
  }

  function parse(arr) {
    st.list = (Array.isArray(arr) ? arr : [])
      .map(i => ({ time: Number(i?.time), text: String(i?.line||i?.text||'').trim() }))
      .filter(i => Number.isFinite(i.time) && i.text)
      .sort((a,b) => a.time - b.time);
    st.has = st.list.length > 0;
  }

  // Unified fetch with session cache
  async function fetchL(url) {
    const u = String(url||'').trim();
    if (!u || c404.has(u)) return null;

    const k = SS.PRE + u;
    const cached = sess(k);
    if (cached) return (cached === NO_LYR) ? null : cached;

    try {
      const r = await fetch(u, { cache: 'force-cache', headers: { Accept: 'application/json' } });
      if (!r.ok) { if (r.status === 404) c404.add(u); throw 0; }
      const j = await r.json();
      if (Array.isArray(j)) { sess(k, j); return j; }
    } catch {}
    
    sess(k, NO_LYR);
    return null;
  }

  // --- UI Rendering ---

  function updateUI(force = false) {
    const blk = $('lyricsplayerblock');
    if (!blk) return;

    const win = qs('#lyrics-window', blk);
    const bg = qs('.lyrics-animated-bg', blk);
    const btns = {
      t: qs('#lyrics-toggle-btn', blk),
      a: qs('#animation-btn', blk),
      k: qs('#lyrics-text-btn', blk)
    };

    if (!win) return;

    // Visibility & Mode
    const enabled = st.has && st.mode !== 'hidden';
    win.style.display = st.has ? '' : 'none';
    
    win.className = `lyrics-${st.mode}`;
    if (btns.t) {
      btns.t.className = `lyrics-toggle-btn lyrics-${st.mode} ${st.has?'':'disabled'}`;
      U.setAriaDisabled(btns.t, !st.has);
    }

    // Animation state
    const anim = st.anim && enabled;
    if (btns.a) {
      btns.a.classList.toggle('active', anim);
      btns.a.classList.toggle('disabled', !st.has);
    }
    if (bg) bg.classList.toggle('active', anim);

    // Karaoke button
    if (btns.k) {
      const trk = W.playerCore?.getCurrentTrack?.();
      const ok = (st.has && enabled) || !!trk?.fulltext;
      btns.k.classList.toggle('disabled', !ok);
      btns.k.style.pointerEvents = ok ? '' : 'none';
      btns.k.style.opacity = ok ? '' : '0.4';
    }

    if (!st.has && $('lyrics')) $('lyrics').innerHTML = '';
  }

  function render(pos) {
    const ctr = $('lyrics');
    if (!ctr || !st.has) {
      if (ctr && !st.has) ctr.innerHTML = '<div class="lyrics-placeholder">–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
      return;
    }

    // Countdown logic
    const first = st.list[0].time;
    if (pos < first && first > 5) {
      const rem = first - pos;
      const sec = Math.ceil(rem);
      const style = rem < 1 ? ` style="opacity:${rem.toFixed(2)}"` : '';
      const cls = rem < 1 ? ' fade-out' : '';
      ctr.innerHTML = `<div class="lyrics-countdown${cls}"${style}>${sec}</div>`;
      return;
    }

    // Find active line
    let idx = -1;
    for (let i = 0; i < st.list.length; i++) {
      if (pos >= st.list[i].time) idx = i; else break;
    }

    // Throttling
    const now = Date.now();
    if (idx === st.lIdx && (now - st.lTs) < MIN_INT) return;
    st.lIdx = idx; st.lTs = now;

    // Build Window (5 or 9 lines)
    const winSz = (st.mode === 'expanded') ? 9 : 5;
    const half = (winSz - 1) / 2;
    const start = Math.max(0, idx - half);
    const padTop = Math.max(0, half - idx);
    const lines = [];

    for (let i = 0; i < padTop; i++) lines.push('<div class="lyrics-window-line"></div>');
    
    const end = Math.min(st.list.length, start + winSz - padTop);
    for (let i = start; i < end; i++) {
      const cls = (i === idx) ? ' active' : '';
      lines.push(`<div class="lyrics-window-line${cls}">${esc(st.list[i].text)}</div>`);
    }

    while (lines.length < winSz) lines.push('<div class="lyrics-window-line"></div>');
    ctr.innerHTML = lines.join('');
  }

  // --- Methods ---

  async function onTrackChange(t) {
    st.has = false;
    st.list = [];
    st.lIdx = -1;
    
    if (!t?.lyrics) return updateUI();
    if (c404.has(t.lyrics)) return updateUI();

    // Fast path: prefetch
    if (st.prefUrl === t.lyrics && st.pref) {
      parse(st.pref);
      st.pref = null;
    } else {
      $('lyrics') && ($('lyrics').innerHTML = '<div class="lyrics-spinner"></div>');
      const data = await fetchL(t.lyrics);
      if (data) parse(data);
    }
    
    updateUI();
    prefetchNext(); // Trigger next
  }

  async function prefetchNext() {
    st.pref = null; st.prefUrl = null;
    const pc = W.playerCore;
    const nIdx = pc?.getNextIndex?.();
    const t = pc?.getPlaylistSnapshot?.()?.[nIdx];
    if (t?.lyrics) {
      const d = await fetchL(t.lyrics);
      if (d) { st.pref = d; st.prefUrl = t.lyrics; }
    }
  }

  // --- Public API ---

  W.LyricsController = {
    getState: () => ({ lyricsViewMode: st.mode, animationEnabled: st.anim, hasTimedLyricsForCurrentTrack: st.has }),
    getCurrentLyrics: () => st.list,
    getCurrentLyricsLines: () => st.list.map(l => ({ line: l.text })), // Back-compat

    restoreSettingsIntoDom: () => { init(); updateUI(); },
    
    onTrackChange,
    
    onTick: (pos, opts) => {
      if (st.mode === 'hidden' || opts?.inMiniMode) return;
      if (st.has) render(pos);
    },

    toggleLyricsView: () => {
      const modes = ['normal', 'hidden', 'expanded'];
      st.mode = modes[(modes.indexOf(st.mode) + 1) % 3];
      store(LS.VIEW, st.mode);
      if (st.mode === 'hidden') st.anim = false; // Disable anim if hidden
      updateUI();
      W.NotificationSystem?.info?.({
        normal: 'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏',
        hidden: 'üö´ –õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞',
        expanded: 'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏'
      }[st.mode]);
    },

    toggleAnimation: () => {
      if (st.mode === 'hidden') return W.NotificationSystem?.info?.('–õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      st.anim = !st.anim;
      store(LS.ANIM, st.anim ? '1' : '0');
      updateUI();
      W.NotificationSystem?.info?.(st.anim ? '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è: –í–ö–õ' : '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è: –í–´–ö–õ');
    },

    // Mini Mode handling
    getMiniSaveState: () => ({ viewMode: st.mode === 'hidden' ? 'normal' : st.mode, animationEnabled: st.anim }),
    
    applyMiniMode: () => {
      // Force hidden visual state without saving to LS
      const win = $('lyrics-window');
      if (win) { win.style.transition = 'none'; win.style.display = 'none'; }
      const tBtn = qs('.lyrics-toggle-btn', $('lyricsplayerblock'));
      if (tBtn) tBtn.style.display = 'none';
      qs('.lyrics-animated-bg', $('lyricsplayerblock'))?.classList.remove('active');
    },

    restoreFromMiniMode: (saved) => {
      const win = $('lyrics-window');
      if (win) { 
        win.style.display = ''; 
        setTimeout(() => win.style.transition = '', 50); 
      }
      const tBtn = qs('.lyrics-toggle-btn', $('lyricsplayerblock'));
      if (tBtn) tBtn.style.display = '';

      if (saved) {
        st.mode = saved.viewMode || 'normal';
        st.anim = !!saved.animationEnabled;
      }
      updateUI();
    },

    // Utilities for external use
    checkTrackHasLyrics: (t) => t?.hasLyrics !== false && (t?.hasLyrics === true || !!t?.lyrics),
    isLyricsKnownMissingFast: (u) => !u || c404.has(u) || sess(SS.PRE + u) === NO_LYR
  };

  init(); // Load initial config
})();

//=================================================
// FILE: /scripts/app/promocode.js
(function(W, D) {
  'use strict';

  // --- Helpers & Optimization ---
  const LS = localStorage;
  const CL = 'classList';
  const KEY_PROMO = 'promocode';
  const KEY_IOS = 'iosInstallDismissed';
  
  // Safe DOM selector
  const $ = (id) => D.getElementById(id);
  
  // Safe Event Listener (Fixes keyboard issues)
  const on = (el, event, handler) => {
    if (el) el.addEventListener(event, handler);
  };

  // Device detection
  const isIOS = () => /iPhone|iPad|iPod/i.test(navigator.userAgent) && !W.MSStream;
  const isStandalone = () => matchMedia('(display-mode: standalone)').matches || navigator.standalone;

  // --- Logic: Unlock Application ---
  const unlock = () => {
    const p = $('promocode-block');
    const m = $('main-block');
    
    // Switch Views
    if (p) p[CL].add('hidden');
    if (m) m[CL].remove('hidden');

    // Initialize App (Safely handle race conditions)
    const run = () => {
      if (W.app && typeof W.app.initialize === 'function') {
        W.app.initialize();
        return true;
      }
      return false;
    };

    if (!run()) {
      let attempts = 0;
      const t = setInterval(() => {
        if (run() || ++attempts > 50) clearInterval(t);
      }, 50);
    }
  };

  // --- Logic: iOS Install Prompt ---
  const showIOS = () => {
    // Strict check to ensure it never shows on Windows/Android
    if (!isIOS() || isStandalone() || LS.getItem(KEY_IOS)) return;

    setTimeout(() => {
      const el = D.createElement('div');
      el.className = 'ios-install-prompt';
      // Condensed HTML structure
      el.innerHTML = 
        '<button class="ios-prompt-close" type="button">√ó</button>' +
        '<div class="ios-prompt-content">' +
          '<img class="ios-prompt-icon" src="icons/apple-touch-icon.png">' +
          '<div style="font-weight:800;font-size:18px;margin-bottom:8px">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>' +
          '<div style="opacity:.85;margin-bottom:14px">–ù–∞–∂–º–∏—Ç–µ <strong>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</strong> ‚ÜóÔ∏è<br>–∏ –≤—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª¬ª</strong></div>' +
          '<button class="ios-prompt-button" type="button">–ü–æ–Ω—è—Ç–Ω–æ</button>' +
        '</div>';

      const close = () => {
        el[CL].remove('show');
        try { LS.setItem(KEY_IOS, '1'); } catch (e) {}
        setTimeout(() => el.remove(), 350);
      };

      // Delegated event for performance
      el.onclick = (e) => {
        if (e.target.closest('button') || e.target.closest('.ios-prompt-close')) close();
      };
      
      D.body.appendChild(el);
      // Animation frame for smooth transition
      requestAnimationFrame(() => el[CL].add('show'));
    }, 2500);
  };

  // --- Main Execution ---
  W.addEventListener('load', () => {
    // iOS specific styling
    if (isIOS()) D.body[CL].add('ios');

    // Safe Config Reading (No optional chaining for max compatibility)
    const cfg = W.APP_CONFIG || {};
    const cfgCode = (cfg.PROMOCODE || '').toString().trim();
    const savedCode = LS.getItem(KEY_PROMO);

    // 1. Check if already authorized or no code needed
    if (!cfgCode || (savedCode === cfgCode)) {
      unlock();
      showIOS();
      return;
    }

    // 2. Setup Login UI
    const inp = $('promo-inp');
    const btn = $('promo-btn');
    const err = $('promo-error');

    // Validation Logic
    const check = () => {
      const val = inp ? inp.value.trim() : '';
      
      if (val === cfgCode) {
        try { LS.setItem(KEY_PROMO, val); } catch (e) {}
        unlock();
        // Hide keyboard on mobile
        if (inp) inp.blur(); 
      } else {
        if (err) err.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';
        if (inp) {
          inp[CL].add('error');
          // Shake/Error animation reset
          setTimeout(() => {
            if (err) err.textContent = '';
            inp[CL].remove('error');
          }, 2000);
        }
      }
    };

    // 3. Attach Listeners (using addEventListener via 'on' helper)
    on(btn, 'click', check);
    
    on(inp, 'keydown', (e) => {
      // Support both modern 'Enter' and legacy keyCode 13
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault(); // Prevent form submission quirks
        check();
      }
    });

    // 4. Final UX Polish
    if (inp) {
      inp.disabled = false; // Ensure input is enabled
      // Auto-focus logic (timeout to ensure UI is rendered)
      setTimeout(() => inp.focus(), 100); 
    }

    showIOS();
  });

})(window, document);

//=================================================
// FILE: /scripts/app/track-registry.js
// scripts/app/track-registry.js

let _tracks = [];
let _byUid = new Map();

const safeStr = (v) => (v ? String(v).trim() : null);

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è URL –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–∞–∑—ã
 */
const resolveUrl = (base, url) => {
  if (!url || !base) return url;
  try { return new URL(url, base).toString(); } catch { return url; }
};

/**
 * –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò
 */
export function registerTrack(raw, albumMeta = {}) {
  if (!raw || !raw.uid) {
    if(raw) console.warn('Skipping track without UID:', raw.title);
    return;
  }

  const uid = safeStr(raw.uid);
  
  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—ã–∑–æ–≤–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ)
  const metaTitle = albumMeta.title || albumMeta.albumName;
  const metaArtist = albumMeta.artist;
  const metaKey = albumMeta.key || albumMeta.id;

  // --- –õ–û–ì–ò–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û ---
  if (_byUid.has(uid)) {
    const existing = _byUid.get(uid);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–ª—å–±–æ–º, –µ—Å–ª–∏ –±—ã–ª –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
    if (metaTitle && (existing.album === '–ê–ª—å–±–æ–º' || !existing.album)) {
      existing.album = metaTitle;
    }
    
    // FIX BUG-3: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ sourceAlbum
    const rawSource = safeStr(raw.sourceAlbum);
    const newKey = rawSource || safeStr(metaKey);
    
    if (!existing.sourceAlbum && newKey) {
      existing.sourceAlbum = newKey;
    }

    if ((!existing.cover || existing.cover.includes('logo.png')) && albumMeta.cover) {
       existing.cover = resolveUrl(albumMeta.base, albumMeta.cover);
    }
    
    return existing;
  }
  // ------------------------------------------

  const baseUrl = albumMeta.base || '';

  const urlHi = resolveUrl(baseUrl, raw.audio || raw.urlHi);
  const urlLo = resolveUrl(baseUrl, raw.audio_low || raw.urlLo);
  const lyricsUrl = resolveUrl(baseUrl, raw.lyrics);
  const fulltextUrl = resolveUrl(baseUrl, raw.fulltext);

  const albumTitle = raw.album || metaTitle || '–ê–ª—å–±–æ–º';
  const artistName = raw.artist || metaArtist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞';
  const coverUrl = resolveUrl(baseUrl, raw.cover || albumMeta.cover || albumMeta.background || 'img/logo.png');
  
  // FIX BUG-3
  const sourceAlbumKey = safeStr(raw.sourceAlbum) || safeStr(metaKey);

  const track = {
    uid: uid,
    sourceAlbum: sourceAlbumKey,
    title: safeStr(raw.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
    artist: artistName,
    album: albumTitle,
    cover: coverUrl,
    src: urlHi, 
    audio: urlHi,
    audio_low: urlLo,
    sources: { audio: { hi: urlHi, lo: urlLo } },
    sizeHi: Number(raw.sizeHi || raw.size || 0),
    sizeLo: Number(raw.sizeLo || raw.size_low || 0),
    lyrics: lyricsUrl,
    fulltext: fulltextUrl,
    hasLyrics: !!(lyricsUrl || raw.hasLyrics),
    _registeredAt: Date.now()
  };

  _tracks.push(track);
  _byUid.set(uid, track);
  
  return track;
}

export function getAllTracks() { return [..._tracks]; }
export function getTrackByUid(uid) { return _byUid.get(safeStr(uid)); }
export function findTrack(predicate) { return _tracks.find(predicate); }

const API = { registerTrack, getAllTracks, getTrackByUid, findTrack };
export const TrackRegistry = API;
window.TrackRegistry = API;

//=================================================
// FILE: /scripts/app/utils/app-utils.js
// scripts/app/utils/app-utils.js
// –¢–æ–Ω–∫–∏–π —Ñ–∞—Å–∞–¥ –Ω–∞–¥ window.Utils (–±–µ–∑ –¥—É–±–ª–µ–π –ª–æ–≥–∏–∫–∏).
// –í–∞–∂–Ω–æ: –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, —Ç–æ–ª—å–∫–æ —É—Ç–∏–ª–∏—Ç—ã.

export const $ = (id) => document.getElementById(String(id || ''));

export const toStr = (v) => (v == null ? '' : String(v));

export const isMobileUA = () => !!window.Utils?.isMobile?.() || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

export const escHtml = (s) => {
  const fn = window.Utils?.escapeHtml;
  return (typeof fn === 'function') ? fn(toStr(s)) : toStr(s);
};

//=================================================
// FILE: /scripts/ci/lint-sw.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('service-worker.js');
if (!fs.existsSync(file)) {
  console.error('service-worker.js not found');
  process.exit(1);
}
const src = fs.readFileSync(file, 'utf8');

const errors = [];
const warns = [];

if (!/const\s+SW_VERSION\s*=\s*['"`]\d+\.\d+\.\d+['"`]/.test(src)) {
  errors.push('SW_VERSION is missing or has wrong format (x.y.z)');
}

const listeners = (name) => (src.match(new RegExp(`addEventListener\\(['"]${name}['"]`, 'g')) || []).length;
['install','activate','fetch'].forEach(ev => {
  const n = listeners(ev);
  if (n === 0) errors.push(`No ${ev} event listener`);
  if (n > 1) warns.push(`Multiple (${n}) ${ev} listeners`);
});

const consts = ['CORE_CACHE','RUNTIME_CACHE','MEDIA_CACHE','OFFLINE_CACHE','META_CACHE'];
consts.forEach(cn => {
  const n = (src.match(new RegExp(`\\bconst\\s+${cn}\\b`, 'g')) || []).length;
  if (n === 0) errors.push(`Missing const ${cn}`);
  if (n > 1) warns.push(`Duplicate const ${cn} (${n} times)`);
});

// –î–æ–ø.–ø—Ä–æ–≤–µ—Ä–∫–∏: DEFAULT_SW_CONFIG —á–∏—Å–ª–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã –∏ revalidateDays —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ
const cfgMatch = src.match(/const\s+DEFAULT_SW_CONFIG\s*=\s*\{([\s\S]*?)\};/);
if (cfgMatch) {
  const body = cfgMatch[1];
  const num = (key) => {
    const m = body.match(new RegExp(`${key}\\s*:\\s*([0-9]+(?:\\.[0-9]+)?)`));
    return m ? Number(m[1]) : null;
  };
  const revalidateDays = num('revalidateDays');
  if (!(Number.isInteger(revalidateDays) && revalidateDays > 0)) {
    errors.push('DEFAULT_SW_CONFIG.revalidateDays must be positive integer');
  }
  ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(k => {
    const v = num(k);
    if (!(typeof v === 'number' && v > 0)) errors.push(`DEFAULT_SW_CONFIG.${k} must be positive number`);
  });
}

if (warns.length) {
  console.warn('SW linter warnings:\n - ' + warns.join('\n - '));
}
if (errors.length) {
  console.error('SW linter errors:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Service Worker lint OK');

//=================================================
// FILE: /scripts/ci/validate-content.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const fail = (msg) => { console.error(msg); process.exit(2); };
const warn = (msg) => { console.warn(msg); };

// 1) albums.json –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
const albumsFile = path.resolve('albums.json');
if (!fs.existsSync(albumsFile)) fail('albums.json not found');
let albums;
try {
  const raw = fs.readFileSync(albumsFile, 'utf8');
  const j = JSON.parse(raw);
  if (!j || !Array.isArray(j.albums)) fail('albums.json: "albums" must be an array');
  albums = j.albums;
} catch (e) {
  fail('albums.json is not valid JSON: ' + e.message);
}
albums.forEach((a, i) => {
  if (!a.key || !a.title || !a.base) fail(`albums.json: album[${i}] must contain key/title/base`);
  if (typeof a.key !== 'string' || typeof a.title !== 'string' || typeof a.base !== 'string') {
    fail(`albums.json: album[${i}] key/title/base must be strings`);
  }
  if (!/^https?:\/\//i.test(a.base)) {
    fail(`albums.json: album[${i}].base must be absolute http(s) url`);
  }
  if (!/\/$/.test(a.base)) {
    warn(`albums.json: album[${i}].base should end with "/" (got: ${a.base})`);
  }
});

// 1.5) –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π –∞–ª—å–±–æ–º–æ–≤
{
  const keys = albums.map(a => a.key);
  const uniq = new Set(keys);
  if (uniq.size !== keys.length) {
    const dup = keys.filter((k, idx) => keys.indexOf(k) !== idx);
    fail(`albums.json: duplicate album keys: ${Array.from(new Set(dup)).join(', ')}`);
  }
}

// 2) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –≥–∞–ª–µ—Ä–µ–π –∏ index.json –Ω–∞–ª–∏—á–∏—è/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
const galleryRoot = path.resolve('albums/gallery');
const required = ['00','01','02','03','news'];
required.forEach(id => {
  const dir = path.join(galleryRoot, id);
  const idx = path.join(dir, 'index.json');
  if (!fs.existsSync(dir)) fail(`albums/gallery/${id} directory missing`);
  if (!fs.existsSync(idx)) fail(`albums/gallery/${id}/index.json missing`);
  try {
    const raw = fs.readFileSync(idx, 'utf8');
    const j = JSON.parse(raw);
    const items = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
    if (!Array.isArray(items)) fail(`albums/gallery/${id}/index.json: items must be array`);
    if (items.length === 0) warn(`albums/gallery/${id}/index.json: items is empty`);
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ)
    items.forEach((it, k) => {
      const check = (p) => {
        if (!p || /^https?:\/\//i.test(p)) return;
        const rel = p.replace(/^\.\//, '');
        const fp = path.resolve(rel);
        if (!fs.existsSync(fp)) warn(`Missing file referenced from gallery ${id} item[${k}]: ${p}`);
      };
      if (typeof it === 'string') check(it);
      else if (it && typeof it === 'object') {
        if (it.src) check(it.src);
        if (it.formats) Object.values(it.formats).forEach(check);
      }
    });
  } catch (e) {
    fail(`albums/gallery/${id}/index.json invalid JSON: ${e.message}`);
  }
});

// 3) custom.json sw –∫–æ–Ω—Ñ–∏–≥: revalidateDays —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
const customFile = path.resolve('custom.json');
if (fs.existsSync(customFile)) {
  try {
    const raw = fs.readFileSync(customFile, 'utf8');
    const j = JSON.parse(raw);
    if (j && j.sw) {
      const d = j.sw.revalidateDays;
      if (!(Number.isInteger(d) && d > 0)) {
        fail('custom.json.sw.revalidateDays must be positive integer');
      }
      ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(key => {
        const v = j.sw[key];
        if (!(typeof v === 'number' && v > 0)) fail(`custom.json.sw.${key} must be positive number`);
      });
      if (typeof j.sw.allowUnknownSize !== 'boolean') {
        fail('custom.json.sw.allowUnknownSize must be boolean');
      }
    }
  } catch (e) {
    fail('custom.json invalid JSON: ' + e.message);
  }
}
// 4) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å uid –≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö config.json (–ù–ï —Ñ–µ–π–ª–∏–º –±–∏–ª–¥ –∏–∑-–∑–∞ —Å–µ—Ç–∏)
{
  // Node 20: fetch –¥–æ—Å—Ç—É–ø–µ–Ω. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –µ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º.
  const hasFetch = typeof fetch === 'function';
  if (!hasFetch) {
    warn('fetch() is not available in this Node runtime; skip remote config.json uid checks');
  } else {
    for (const a of albums) {
      const base = a.base.endsWith('/') ? a.base : `${a.base}/`;
      const url = `${base}config.json`;

      try {
        const r = await fetch(url, { cache: 'no-cache' });
        if (!r.ok) {
          warn(`remote config.json not reachable for "${a.key}": HTTP ${r.status} (${url})`);
          continue;
        }

        const cfg = await r.json();
        const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : null;
        if (!tracks) {
          warn(`remote config.json "${a.key}": tracks must be array (${url})`);
          continue;
        }

        const seen = new Set();
        const dups = new Set();
        let missing = 0;

        for (const t of tracks) {
          const uid = String(t?.uid || '').trim();
          if (!uid) {
            missing++;
            continue;
          }
          if (seen.has(uid)) dups.add(uid);
          seen.add(uid);
        }

        if (missing > 0) {
          warn(`remote config.json "${a.key}": ${missing} track(s) have empty uid (${url})`);
        }
        if (dups.size > 0) {
          warn(`remote config.json "${a.key}": duplicate uid(s): ${Array.from(dups).join(', ')} (${url})`);
        }
      } catch (e) {
        warn(`remote config.json check failed for "${a.key}": ${e?.message || e} (${url})`);
      }
    }
  }
}

console.log('Content validation OK');

//=================================================
// FILE: /scripts/ci/validate-manifest.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('manifest.json');
if (!fs.existsSync(file)) {
  console.error('manifest.json not found');
  process.exit(1);
}
const raw = fs.readFileSync(file, 'utf8');
let json;
try {
  json = JSON.parse(raw);
} catch (e) {
  console.error('manifest.json is not valid JSON:', e.message);
  process.exit(1);
}
const errors = [];
function req(key) { if (!(key in json)) errors.push(`Missing key: ${key}`); }

req('name');
req('short_name');
req('start_url');
req('icons');

if (json.icons && !Array.isArray(json.icons)) {
  errors.push('icons must be an array');
}
if (Array.isArray(json.icons) && json.icons.length === 0) {
  errors.push('icons must contain at least one icon');
}
if (!json.display) errors.push('Missing key: display');
if (!json.theme_color) errors.push('Missing key: theme_color');
if (!json.background_color) errors.push('Missing key: background_color');

if (errors.length) {
  console.error('Manifest validation failed:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Manifest validation OK');

//=================================================
// FILE: /scripts/core/bootstrap.js
//=================================================
// FILE: /scripts/core/bootstrap.js
// scripts/core/bootstrap.js
// –õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫: –ø—Ä–æ–≤–µ—Ä–∫–∞ env, –∑–∞–≥—Ä—É–∑–∫–∞ config, init.

(function () {
  'use strict';

  const W = window;
  const D = document;

  const fail = (msg) => {
    D.body.innerHTML = `<div style="position:fixed;inset:0;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px;font-family:sans-serif"><h2 style="color:#e80100">–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞</h2><p>${msg}</p></div>`;
    throw new Error(msg);
  };

  const checkEnv = () => {
    if (!W.fetch || !W.Promise || !W.localStorage) return '–í–∞—à –±—Ä–∞—É–∑–µ—Ä —É—Å—Ç–∞—Ä–µ–ª. –û–±–Ω–æ–≤–∏—Ç–µ –µ–≥–æ.';
    try { localStorage.setItem('_t', '1'); localStorage.removeItem('_t'); } catch { return '–í–∫–ª—é—á–∏—Ç–µ Cookies/Storage.'; }
    return null;
  };

  const preventZoom = () => {
    // iOS zoom fix
    D.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
    let last = 0;
    D.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - last < 300) e.preventDefault();
      last = now;
    }, { passive: false });
  };

  const loadIndex = async () => {
    try {
      const res = await fetch('./albums.json');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      W.albumsIndex = (await res.json())?.albums || [];
      W.dispatchEvent(new Event('albumsIndex:ready'));
    } catch (e) {
      console.error(e);
      W.albumsIndex = []; // –ù–µ —Ä–æ–Ω—è–µ–º, –¥–∞—ë–º –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –ø—É—Å—Ç—ã–º (–¥–ª—è offline –∫—ç—à–∞)
    }
  };

  const waitForHowler = async () => {
    for (let i = 0; i < 50; i++) { // 5 sec max
      if (W.Howler) return true;
      await new Promise(r => setTimeout(r, 100));
    }
    return false;
  };

  const init = async () => {
    const err = checkEnv();
    if (err) return fail(err);

    preventZoom();
    
    // Mark env
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !W.MSStream) D.body.classList.add('ios');
    if (matchMedia('(display-mode: standalone)').matches) D.body.classList.add('standalone');

    if (!(await waitForHowler())) return fail('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ-–¥–≤–∏–∂–∫–∞ (Howler).');

    await loadIndex();
  };

  if (D.readyState === 'loading') D.addEventListener('DOMContentLoaded', init);
  else init();

})();

//=================================================
// FILE: /scripts/core/config.js
// scripts/core/config.js
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
export const APP_CONFIG = {
  // –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  APP_VERSION: '8.0.5',
  BUILD_DATE: '2025-12-08',
  // ‚úÖ –ü–†–û–ú–û–ö–û–î –î–õ–Ø –í–•–û–î–ê
  PROMOCODE: 'VITRINA2025',
  // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –∞–ª—å–±–æ–º–æ–≤
  ICON_ALBUMS_ORDER: [
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    { key: '__favorites__', title: '‚≠ê‚≠ê‚≠ê–ò–ó–ë–†–ê–ù–ù–û–ï‚≠ê‚≠ê‚≠ê', icon: 'img/Fav_logo.png' },
    { key: 'odnazhdy-v-skazke', title: '–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ', icon: 'img/icon_album/icon-album-03.png' },
    { key: 'golos-dushi', title: '–ì–æ–ª–æ—Å –î—É—à–∏', icon: 'img/icon_album/icon-album-02.png' },
    { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º', icon: 'img/icon_album/icon-album-01.png' },
    { key: 'krevetochka', title: '–ö–†–ï–í–ï—ÜTOCHKA', icon: 'img/icon_album/icon-album+00.png' },
    { key: '__reliz__', title: '–ù–û–í–û–°–¢–ò', icon: 'img/icon_album/icon-album-news.png' }
  ],
  // –ö–ª—é—á–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤
  SPECIAL_FAVORITES_KEY: '__favorites__',
  SPECIAL_RELIZ_KEY: '__reliz__',
  // –°—Å—ã–ª–∫–∏
  SUPPORT_URL: 'https://example.com/support',
  SUPPORT_EMAIL: 'support@vitrina-razbita.ru',
  GITHUB_URL: 'https://github.com/apel-s-in/vi3na1bita-music',
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–µ—Ä–∞
  PLAYER_SETTINGS: {
    defaultVolume: 1.0,
    crossfade: false,
    preload: true
  },
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  CACHE_VERSION: 'v1.0.0',
  CACHE_AUDIO: false, // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã
  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  ANALYTICS_ENABLED: false,
  ANALYTICS_ID: null,
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
  CENTRAL_GALLERY_BASE: './albums/gallery/',
  // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞–ª—å–±–æ–º–æ–≤
  PUBLISHED_ALBUM_KEYS: new Set(['odnazhdy-v-skazke', 'golos-dushi', 'mezhdu-zlom-i-dobrom', 'krevetochka'])
};

// –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
if (typeof window !== 'undefined') {
  window.APP_CONFIG = APP_CONFIG;
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  window.SPECIAL_FAVORITES_KEY = APP_CONFIG.SPECIAL_FAVORITES_KEY;
  window.SPECIAL_RELIZ_KEY = APP_CONFIG.SPECIAL_RELIZ_KEY;
  window.ICON_ALBUMS_ORDER = APP_CONFIG.ICON_ALBUMS_ORDER;
  window.CENTRAL_GALLERY_BASE = APP_CONFIG.CENTRAL_GALLERY_BASE;
}

//=================================================
// FILE: /scripts/core/favorites-manager.js
// scripts/core/favorites-manager.js
const KEY = '__favorites_v2__';

export class FavoritesManager {
  constructor() {
    this._map = new Map();
    this._subs = new Set();
    this.init();
  }

  init() {
    try {
      const raw = localStorage.getItem(KEY);
      if (raw) {
        JSON.parse(raw).forEach(i => {
          if (i && i.uid) this._map.set(String(i.uid).trim(), i);
        });
      }
    } catch (e) {
      console.error('Favorites init error:', e);
    }
  }

  isLiked(uid) {
    const u = String(uid || '').trim();
    if (!u) return false;
    const item = this._map.get(u);
    return item && !item.inactiveAt;
  }

  getSnapshot() {
    return Array.from(this._map.values());
  }

  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Set –∞–∫—Ç–∏–≤–Ω—ã—Ö UID (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  readLikedSet() {
    const set = new Set();
    for (const [uid, item] of this._map) {
      if (!item.inactiveAt) set.add(uid);
    }
    return set;
  }

  toggle(uid, { source = 'album', albumKey } = {}) {
    const u = String(uid || '').trim();
    if (!u) return false;

    const item = this._map.get(u);
    const isActive = item && !item.inactiveAt;
    
    let isNowLiked = false;

    if (isActive) {
      if (source === 'favorites') {
        // Soft Delete (—Å–µ—Ä—ã–π —Ç—Ä–µ–∫)
        this._map.set(u, { ...item, inactiveAt: Date.now() });
      } else {
        // Hard Delete
        this._map.delete(u);
      }
      isNowLiked = false;
    } else {
      // Restore / Add
      this._map.set(u, {
        uid: u,
        addedAt: item?.addedAt || Date.now(),
        albumKey: albumKey || item?.albumKey || null,
        inactiveAt: null
      });
      isNowLiked = true;
    }
    
    this._save();
    this._notify(u, isNowLiked);
    return isNowLiked;
  }

  remove(uid) {
    const u = String(uid).trim();
    if (this._map.delete(u)) {
      this._save();
      this._notify(u, false);
      return true;
    }
    return false;
  }

  _save() {
    try {
      localStorage.setItem(KEY, JSON.stringify(Array.from(this._map.values())));
    } catch {}
  }
  
  subscribe(cb) {
    this._subs.add(cb);
    return () => this._subs.delete(cb);
  }

  _notify(uid, liked) {
    this._subs.forEach(cb => { try { cb({ uid, liked }); } catch {} });
  }
}

export const Favorites = new FavoritesManager();
window.FavoritesManager = Favorites;

//=================================================
// FILE: /scripts/core/stats-core.js
// scripts/core/stats-core.js
import { updateGlobalStats, getCloudStats, setCloudStats } from '../offline/cache-db.js';

const THRESHOLD = 0.90; // 90% for full listen

class StatsCoreImpl {
  constructor() {
    this._uid = null;
    this._dur = 0;
    this._sec = 0; // seconds played in current session for this track
    this._maxPos = 0;
    this._started = false;
  }

  onTrackStart(uid, duration) {
    if (this._uid && this._uid !== uid) this._flush();
    this._uid = uid;
    this._dur = duration || 0;
    this._sec = 0;
    this._maxPos = 0;
    this._started = true;
  }

  onTick(pos) {
    if (!this._started || !this._uid) return;
    this._sec += 0.25; // Called every 250ms usually, or delta passed
    this._maxPos = Math.max(this._maxPos, pos);
  }
  
  // Custom method for explicit delta from player core
  onSecondTick(uid, delta) {
      if (this._uid !== uid) return;
      this._sec += delta;
      
      // Real-time update to DB for robustness? 
      // For performance, we batch or do it on end. 
      // T–ó says "Global stats never resets".
      // Let's update global stats incrementally to avoid data loss on crash
      updateGlobalStats(uid, delta, 0).catch(() => {});
  }

  onSeek(uid, from, to) {
      // Seek doesn't reset "seconds listened" but might affect "full listen" logic if we were strict about continuity.
      // T–ó 18.3: "seconds —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ playing".
  }

  async onEnded(uid, pos, dur) {
     if (this._uid !== uid) return;
     const isFull = this._checkFull(pos, dur);
     await this._commit(uid, 0, isFull ? 1 : 0);
     this._reset();
  }
  
  async onSkip(uid, pos, dur) {
      if (this._uid !== uid) return;
      const isFull = this._checkFull(pos, dur);
      await this._commit(uid, 0, isFull ? 1 : 0);
      this._reset();
  }

  _checkFull(pos, dur) {
      const d = dur || this._dur;
      if (!d) return false;
      return (pos / d) >= THRESHOLD;
  }

  async _commit(uid, dSec, dFull) {
      if (!uid) return;
      // Global Stats
      await updateGlobalStats(uid, dSec, dFull);

      // Cloud Stats (only full listens count for cloud logic usually, but we track dates)
      if (dFull > 0) {
         const s = await getCloudStats(uid) || {};
         const n = (s.cloudFullListenCount || 0) + 1;
         // Logic for Cloud Promotion is in OfflineManager (NC-4 implied), 
         // but StatsCore just records data. 
         // Actually OfflineManager.recordListenStats handles the logic. 
         // Let's delegate back to OfflineManager for the "Business Logic" of cloud promotion?
         // T–ó 18.3 says StatsCore is the entry point.
         
         // Let's call OfflineManager to handle "Business Logic" side effects (Cloud promotion)
         const mgr = window.OfflineUI?.offlineManager;
         if (mgr) mgr.recordListenStats(uid, { deltaSec: dSec, isFullListen: dFull > 0 });
      }
  }

  _reset() {
      this._uid = null;
      this._started = false;
  }
}

export const StatsCore = new StatsCoreImpl();

//=================================================
// FILE: /scripts/core/utils.js
/**
 * scripts/core/utils.js
 * Centralized Utilities for Vitrina PWA v3.1
 * Provides legacy support and new namespaces for PlayerUI/Offline.
 */
(function(W, D) {
  'use strict';

  // Internal Blob Registry for iOS memory safety
  const _blobReg = new Map(); 

  const U = {
    // --- 1. DOM Helpers ---
    $: (id) => D.getElementById(id),
    
    dom: {
      byId: (id) => D.getElementById(id),
      on: (el, ev, fn, opts) => {
        if (!el) return () => {};
        el.addEventListener(ev, fn, opts);
        return () => { try { el.removeEventListener(ev, fn, opts); } catch {} };
      },
      raf: (fn) => requestAnimationFrame(fn),
      defer: (fn) => setTimeout(fn, 0),
      createStyleOnce: (id, css) => {
        if (D.getElementById(id)) return;
        const s = D.createElement('style');
        s.id = id; s.textContent = css;
        D.head.appendChild(s);
      }
    },

    // --- 2. Network & Env ---
    getNet: () => {
      const nav = navigator;
      if (nav.onLine === false) return { online: false, kind: 'offline', saveData: false };
      const conn = nav.connection || nav.mozConnection || nav.webkitConnection;
      if (!conn) return { online: true, kind: 'wifi', saveData: false };
      const kind = conn.type || conn.effectiveType || 'unknown';
      const isCellular = /cellular|2g|3g|4g/i.test(kind);
      return {
        online: true,
        kind: isCellular ? 'cellular' : (kind === 'unknown' ? 'unknown' : 'wifi'),
        saveData: conn.saveData || false
      };
    },
    
    getPlatform: () => {
      const ua = navigator.userAgent || '';
      const isIOS = /iPad|iPhone|iPod/.test(ua) && !W.MSStream;
      const isPWA = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone === true;
      return { isIOS, isPWA, isDesktop: !/Mobi|Android/i.test(ua), isAndroid: /Android/.test(ua) };
    },

    // --- 3. Format & Math (Required by PlayerUI) ---
    fmt: {
      time: (s) => {
        const n = Number(s);
        if (!Number.isFinite(n) || n < 0) return '00:00';
        const h = (n / 3600) | 0;
        const m = ((n % 3600) / 60) | 0;
        const sec = (n % 60) | 0;
        const mmss = `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        return h > 0 ? `${h}:${mmss}` : mmss;
      },
      bytes: (n) => {
        const b = Number(n);
        if (!Number.isFinite(b) || b <= 0) return '0 B';
        const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(b) / Math.log(k));
        return parseFloat((b / Math.pow(k, i)).toFixed(1)) + ' ' + (sizes[i] || 'TB');
      },
      durationHuman: (sec) => {
        if (!sec) return '0–º';
        const h = (sec / 3600) | 0, m = ((sec % 3600) / 60) | 0;
        return h > 0 ? `${h}—á ${m}–º` : `${m}–º`;
      }
    },
    
    math: {
      clamp: (n, min, max) => Math.min(Math.max(Number(n) || 0, min), max),
      toInt: (v, d = 0) => { const n = Number(v); return Number.isFinite(n) ? n : d; }
    },

    // --- 4. Object & Data ---
    obj: {
      safeJson: (k, d = null) => { try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : d; } catch { return d; } },
      trim: (v) => String(v || '').trim() || null,
      normQuality: (q) => (String(q || '').toLowerCase().trim() === 'lo') ? 'lo' : 'hi'
    },

    // --- 5. Blob Management (Optimized LRU) ---
    blob: {
      createUrl: (key, blob) => {
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å—Å—ã–ª–æ–∫, –µ—Å–ª–∏ –∏—Ö –±–æ–ª—å—à–µ 5 (–∑–∞–ø–∞—Å –¥–ª—è –∫—Ä–æ—Å—Å—Ñ–µ–π–¥–∞/–ø—Ä–µ–ª–æ–∞–¥–∞)
        if (_blobReg.size > 5) {
          const oldest = _blobReg.keys().next().value;
          URL.revokeObjectURL(_blobReg.get(oldest));
          _blobReg.delete(oldest);
        }
        
        // –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ –µ—Å—Ç—å, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º (–æ–±–Ω–æ–≤–ª—è–µ–º "—Å–≤–µ–∂–µ—Å—Ç—å" –≤ Map –ø–æ—Ä—è–¥–∫–∞ –≤—Å—Ç–∞–≤–æ–∫)
        if (_blobReg.has(key)) {
          URL.revokeObjectURL(_blobReg.get(key));
          _blobReg.delete(key);
        }
        
        const url = URL.createObjectURL(blob);
        _blobReg.set(key, url);
        return url;
      },
      revokeUrl: (key) => {
        if (_blobReg.has(key)) {
          URL.revokeObjectURL(_blobReg.get(key));
          _blobReg.delete(key);
          return true;
        }
        return false;
      }
    },

    // --- 6. UI Helpers ---
    ui: {
      toast: (msg, type, duration) => W.NotificationSystem?.show(msg, type, duration),
      escapeHtml: (s) => String(s || '').replace(/[<>&'"]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&#39;','"':'&quot;'}[m]))
    },

    // --- 7. Functions required by PlayerUI (Facades) ---
    
    // Playback Quality (PQ)
    pq: {
      getMode: () => (localStorage.getItem('qualityMode:v1') || 'hi') === 'lo' ? 'lo' : 'hi',
      getState: () => {
        const c = W.playerCore;
        const net = U.getNet().online;
        const can = !!c?.canToggleQualityForCurrentTrack?.();
        return { mode: U.pq.getMode(), canToggle: can && net, canToggleByTrack: can, netOk: net };
      },
      toggle: () => {
        const c = W.playerCore; if (!c) return { ok: false, reason: 'noCore' };
        if (!U.getNet().online) return { ok: false, reason: 'offline' };
        if (!c.canToggleQualityForCurrentTrack()) return { ok: false, reason: 'trackNoLo' };
        const n = U.pq.getMode() === 'hi' ? 'lo' : 'hi';
        c.switchQuality(n);
        return { ok: true, next: n };
      }
    },

    // Favorites Helper
    fav: {
      isTrackLikedInContext: ({ playingAlbum: pa, track: t } = {}) => {
        const u = String(t?.uid || ''), c = W.playerCore;
        if (!c || !u) return false;
        if (pa !== '__favorites__' && t?.sourceAlbum) return c.isFavorite(u);
        const ref = (W.favoritesRefsModel || []).find(r => String(r?.__uid) === u);
        return ref?.__a ? c.isFavorite(u) : false;
      }
    },

    // Download Helper (Fixes PlayerUI crash)
    download: {
      applyDownloadLink: (btn, track) => {
        if (!btn) return;
        if (!track || !track.src) {
          btn.removeAttribute('href');
          btn.removeAttribute('download');
          btn.classList.add('disabled');
          return;
        }
        btn.href = track.src;
        btn.download = (track.artist && track.title) 
          ? `${track.artist} - ${track.title}.mp3` 
          : `track.mp3`;
        btn.classList.remove('disabled');
      }
    },

    // Function Helpers
    func: {
      debounceFrame: (fn) => {
        let frame;
        return (...args) => {
          if (frame) cancelAnimationFrame(frame);
          frame = requestAnimationFrame(() => { frame = null; fn(...args); });
        };
      },
      throttle: (fn, wait) => {
        let last = 0;
        return (...args) => {
          const now = Date.now();
          if (now - last >= wait) { last = now; fn(...args); }
        };
      }
    },

    // --- 8. Legacy / Root Aliases (Backward Compatibility) ---
    isSpecialAlbumKey: (k) => String(k || '').startsWith('__'),
    isBrowsingOtherAlbum: () => {
      const p = W.AlbumsManager?.getPlayingAlbum?.(), c = W.AlbumsManager?.getCurrentAlbum?.();
      return p && c && p !== c && !(p === '__favorites__' && c === '__favorites__');
    },
    setBtnActive: (id, a) => { const el = D.getElementById(id); if(el) el.classList.toggle('active', !!a); },
    setAriaDisabled: (el, d) => { if(el) { el.classList.toggle('disabled', !!d); el.setAttribute('aria-disabled', !!d); }},
    lsGet: (k, d) => localStorage.getItem(k) || d,
    lsSet: (k, v) => localStorage.setItem(k, v),
    lsGetBool01: (k, d=false) => { const v=localStorage.getItem(k); return v===null ? d : v==='1'; },
    lsSetBool01: (k, v) => localStorage.setItem(k, v?'1':'0'),
    lsGetJson: (k, d=null) => { try { const r=localStorage.getItem(k); return r?JSON.parse(r):d; } catch { return d; } }
  };

  // Direct Aliases
  U.escapeHtml = U.ui.escapeHtml;
  U.formatTime = U.fmt.time;
  U.formatBytes = U.fmt.bytes;
  U.getNetworkStatusSafe = U.getNet;
  U.isMobile = () => { const p = U.getPlatform(); return p.isIOS || p.isAndroid; };
  U.trimStr = U.obj.trim;
  U.waitFor = async (fn, t=2000) => { for(let i=0;i<t/50;i++) { if(fn()) return true; await new Promise(r=>setTimeout(r,50)); } return !!fn(); };
  U.onceEvent = (el, ev, { timeoutMs }={}) => new Promise(r => {
    const h = () => { el.removeEventListener(ev, h); r(); };
    el.addEventListener(ev, h, {once:true});
    if(timeoutMs) setTimeout(h, timeoutMs);
  });

  W.Utils = U;
  if (typeof exports !== 'undefined') exports.Utils = U;
})(window, document);
// export const Utils —É–¥–∞–ª–µ–Ω, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ <script> –±–µ–∑ type="module"

//=================================================
// FILE: /scripts/e2e/favorites.spec.js
// scripts/e2e/favorites.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import { loginByPromo, likeFirstTrack, openFavorites, playFirstTrack } from './utils.js';

test('favorites UI builds and plays from favorites list', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);
  
  const favCount = await page.locator('#track-list .track').count();
  expect(favCount).toBeGreaterThan(0);

  // Click first track -> player should appear
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
});

test('toggle star in favorites updates row state and localStorage (uid-based)', async ({ page }) => {
  await loginByPromo(page);

  // Like first track in album
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // Go to Favorites
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const favRow = page.locator('#track-list .track').first();
  const favId = await favRow.getAttribute('id');
  expect(favId).toMatch(/^fav_/);

  // Unlike -> row becomes inactive
  await favRow.locator('.like-star').click();
  await expect(favRow).toHaveClass(/inactive/);

  // Check V2 Storage (__favorites_v2__)
  const isLiked = await page.evaluate((id) => {
    const m = String(id || '').match(/^fav_(.+)_(.+)$/);
    const u = m ? m[2] : '';
    const raw = localStorage.getItem('__favorites_v2__');
    const items = raw ? JSON.parse(raw) : [];
    // –í V2 —Ö—Ä–∞–Ω—è—Ç—Å—è –æ–±—ä–µ–∫—Ç—ã, –∏—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π (–±–µ–∑ inactiveAt)
    return items.some(i => i.uid === u && !i.inactiveAt);
  }, favId);

  expect(isLiked).toBeFalsy();
});

test('favorites playing: removing star of current track triggers next', async ({ page }) => {
  await loginByPromo(page);
  await page.click('#promo-btn');

  // Like & Play in Favorites
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const row = page.locator('#track-list .track').first();
  await row.hover();
  await row.locator('.like-star').click();

  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  
  const favFirst = page.locator('#track-list .track').first();
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // Remove star on current playing track
  const beforeIdx = await page.evaluate(() => window.playerCore?.getIndex?.() ?? -1);
  await favFirst.locator('.like-star').click();

  // Should skip to next or handle gracefully (not stop)
  await page.waitForTimeout(300);
  const afterIdx = await page.evaluate(() => window.playerCore?.getIndex?.() ?? -1);
  
  // Track should change or index update
  expect(afterIdx).not.toBe(beforeIdx);
  await expect(favFirst).toHaveClass(/inactive/);
});

test('quick prev/next uses PlayerCore only (no legacy audio)', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  // Ensure no <audio> tag exists
  const hasAudioTag = await page.evaluate(() => !!document.querySelector('audio'));
  expect(hasAudioTag).toBeFalsy();

  // Ensure PlayerCore is active
  const isPlaying = await page.evaluate(() => window.playerCore?.isPlaying());
  expect(isPlaying).toBeTruthy();
});

//=================================================
// FILE: /scripts/e2e/player.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import {
  loginByPromo,
  likeFirstTrack,
  openFavorites,
  playFirstTrack,
  seedPlayerStateV2FromCurrent
} from './utils.js';

test('play track, toggle favorites-only and sleep timer UI', async ({ page }) => {
  await loginByPromo(page);
  await expect(page.locator('#main-block')).toBeVisible();

  // –î–æ–∂–¥–∞—Ç—å—Å—è —Å–ø–∏—Å–∫–∞ –∞–ª—å–±–æ–º–æ–≤ –∏ –∫–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ —Ç—Ä–µ–∫–ª–∏—Å—Ç–∞
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstTrack = page.locator('#track-list .track').first();
  await firstTrack.click();

  // –ü–æ—è–≤–∏–ª—Å—è –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞ –∏ –∫–Ω–æ–ø–∫–∞ Play/Pause –µ—Å—Ç—å
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
  await expect(page.locator('#play-pause-icon')).toBeVisible();

  // –í–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä "—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ" (–∫–Ω–æ–ø–∫–∞ –≤ –ø–ª–µ–µ—Ä–µ)
  await page.click('#favorites-btn');
  const favBtn = page.locator('#favorites-btn');
  await expect(favBtn).toHaveClass(/favorites-active/);

  // –¢–∞–π–º–µ—Ä —Å–Ω–∞: –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –∏ –≤—ã–±—Ä–∞—Ç—å "15 –º–∏–Ω—É—Ç", –∑–∞—Ç–µ–º –≤—ã–∫–ª—é—á–∏—Ç—å
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("15 –º–∏–Ω—É—Ç")');
  // –ë–µ–π–¥–∂ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è
  await expect(page.locator('#sleep-timer-badge')).toBeVisible();
  // –í—ã–∫–ª—é—á–∏–º
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("–í—ã–∫–ª—é—á–∏—Ç—å")');
  await expect(page.locator('#sleep-timer-badge')).toBeHidden();
});

test('favoritesOnly: unliking current track switches to next (no stop)', async ({ page }) => {
  await loginByPromo(page);

  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // –õ–∞–π–∫–Ω–µ–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∏ –∑–∞–ø—É—Å—Ç–∏–º –µ–≥–æ
  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // –í–∫–ª—é—á–∏–º favoritesOnly
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  const before = await page.evaluate(() => ({
    playing: !!window.playerCore?.isPlaying?.(),
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  // –°–Ω–∏–º–µ–º –ª–∞–π–∫ —Å —Ç–µ–∫—É—â–µ–≥–æ (—á–µ—Ä–µ–∑ –º–∏–Ω–∏/–∑–≤–µ–∑–¥—É —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—â–µ: –∫–ª–∏–∫ –ø–æ –∑–≤–µ–∑–¥–µ –≤ —Å—Ç—Ä–æ–∫–µ)
  await firstRow.locator('.like-star').click();

  // –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–π (–∏–ª–∏ —Ö–æ—Ç—è –±—ã –∏–∑–º–µ–Ω–∏—Ç—å—Å—è uid/index), –ø—Ä–∏ —ç—Ç–æ–º –ù–ï stop.
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => ({
    playing: !!window.playerCore?.isPlaying?.(),
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  expect(after.playing).toBeTruthy();
  expect(after.uid).not.toBe(before.uid);
});

test('repeat has priority: favoritesOnly + repeat + unliking current keeps repeating', async ({ page }) => {
  await loginByPromo(page);

  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // repeat ON
  await page.click('#repeat-btn');
  await expect(page.locator('#repeat-btn')).toHaveClass(/active/);

  const before = await page.evaluate(() => ({
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || ''),
    repeat: !!window.playerCore?.isRepeat?.()
  }));
  expect(before.repeat).toBeTruthy();

  // –°–Ω–∏–º–µ–º –ª–∞–π–∫ —Å —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
  await firstRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  // –ü–æ –ø—Ä–∞–≤–∏–ª—É: repeat –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –Ω–∞ —Ç–æ–º –∂–µ —Ç—Ä–µ–∫–µ
  const after = await page.evaluate(() => ({
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  expect(after.uid).toBe(before.uid);
});

test('favoritesOnly + shuffle: liking another track adds it to tail of queue', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const rows = page.locator('#track-list .track');
  const firstRow = rows.nth(0);
  const secondRow = rows.nth(1);

  // –õ–∞–π–∫–Ω–µ–º 1-–π —Ç—Ä–µ–∫ –∏ –∑–∞–ø—É—Å—Ç–∏–º
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // shuffle ON
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  // –ó–∞–ø–æ–º–Ω–∏–º –¥–ª–∏–Ω—É –ø–ª–µ–π–ª–∏—Å—Ç–∞
  const beforeLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  // –õ–∞–π–∫–Ω–µ–º –≤—Ç–æ—Ä–æ–π —Ç—Ä–µ–∫ (–¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏)
  await secondRow.hover();
  await secondRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => {
    const snap = window.playerCore?.getPlaylistSnapshot?.() || [];
    const tail = snap.length ? snap[snap.length - 1] : null;
    return {
      len: snap.length,
      tailUid: String(tail?.uid || '').trim(),
      likedUids: window.playerCore?.getLikedUidsForAlbum?.(window.AlbumsManager?.getPlayingAlbum?.() || '') || []
    };
  });

  expect(after.len).toBeGreaterThanOrEqual(beforeLen);
  expect(after.likedUids.includes(after.tailUid)).toBeTruthy();
});

test('shuffle history: next-next-prev returns to previously played track', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // –ó–∞–ø—É—Å—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫
  await page.click('#track-list .track >> nth=0');

  // –í–∫–ª—é—á–∏–º shuffle
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  const first = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#next-btn');
  await page.waitForTimeout(200);
  const second = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#next-btn');
  await page.waitForTimeout(200);
  const third = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#prev-btn');
  await page.waitForTimeout(200);
  const back = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  expect(first).toBeTruthy();
  expect(second).toBeTruthy();
  expect(third).toBeTruthy();
  expect(back).toBe(second);
});

test('favoritesOnly + shuffle: unliking NOT current removes it from tail if not played yet', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const rows = page.locator('#track-list .track');
  const firstRow = rows.nth(0);
  const secondRow = rows.nth(1);

  // –õ–∞–π–∫–∞–µ–º 1 –∏ 2 —Ç—Ä–µ–∫
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await secondRow.hover();
  await secondRow.locator('.like-star').click();

  // –ó–∞–ø—É—Å–∫–∞–µ–º 1-–π
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // shuffle ON
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  // –¢–µ–ø–µ—Ä—å –ø–ª–µ–π–ª–∏—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 2 —Ç—Ä–µ–∫–∞ (–∏–ª–∏ –±–æ–ª—å—à–µ, –µ—Å–ª–∏ already), —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–ª–∏–Ω—É
  const beforeLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  // –°–Ω–∏–º–∞–µ–º –ª–∞–π–∫ —Å–æ 2-–≥–æ —Ç—Ä–µ–∫–∞ (–ù–ï —Ç–µ–∫—É—â–µ–≥–æ)
  await secondRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const afterLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  expect(afterLen).toBeLessThanOrEqual(beforeLen);
});

//=================================================
// FILE: /scripts/e2e/utils.js
// @ts-check
/**
 * scripts/e2e/utils.js
 * –û–±—â–∏–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è Playwright e2e, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤ spec-—Ñ–∞–π–ª–∞—Ö.
 */

export const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';

export async function loginByPromo(page, promo = 'VITRINA2025') {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', promo);
  await page.click('#promo-btn');
  await page.waitForSelector('#main-block:not(.hidden)', { timeout: 10000 });
}

export async function waitTracks(page) {
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
}

export async function likeFirstTrack(page) {
  await waitTracks(page);
  const first = page.locator('#track-list .track').first();
  await first.hover();
  await first.locator('.like-star').click();
}

export async function openFavorites(page) {
  await page.click('.album-icon[data-akey="__favorites__"]');
  await waitTracks(page);
}

export async function playFirstTrack(page) {
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
}

/**
 * –ó–∞–ø–∏—Å–∞—Ç—å PlayerState –≤ localStorage –≤ uid-—Ñ–æ—Ä–º–∞—Ç–µ (V2).
 * –ë–µ—Ä—ë–º playingAlbum –∏–∑ AlbumsManager, –∞ uid/sourceAlbum –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞.
 */
export async function seedPlayerStateV2FromCurrent(page, opts = {}) {
  const position = typeof opts.position === 'number' ? opts.position : 5;
  const wasPlaying = typeof opts.wasPlaying === 'boolean' ? opts.wasPlaying : true;

  await page.evaluate(({ position, wasPlaying }) => {
    const pc = window.playerCore;
    const track = pc?.getCurrentTrack?.() || null;

    const albumKey = window.AlbumsManager?.getPlayingAlbum?.() || null;

    const st = {
      album: albumKey,
      currentAlbum: window.AlbumsManager?.getCurrentAlbum?.() || albumKey,
      trackUid: String(track?.uid || '').trim() || null,
      sourceAlbum: String(track?.sourceAlbum || '').trim() || null,
      trackIndex: typeof pc?.getIndex === 'function' ? (pc.getIndex() || 0) : 0,
      position: Math.floor(position),
      volume: typeof pc?.getVolume === 'function' ? (pc.getVolume() ?? 100) : 100,
      wasPlaying: !!wasPlaying
    };

    localStorage.setItem('playerStateV2', JSON.stringify(st));
  }, { position, wasPlaying });
}

//=================================================
// FILE: /scripts/offline/cache-db.js
// scripts/offline/cache-db.js
// IndexedDB wrapper v3.1 (Fixes: double counting, pruneTransient)

const DB_NAME = 'OfflineCacheDB';
const DB_VERSION = 6; 

const S = {
  AUDIO: 'audioBlobs',
  BYTES: 'trackBytes',
  META: 'cacheMeta',
  CLOUD: 'cloudStats',
  GLOB: 'globalStats',
  DL: 'downloadMeta',
  LOC: 'trackLocalMeta'
};

let _db = null;

const openDb = () => {
  if (_db) return _db;
  _db = new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      Object.values(S).forEach(s => { if (!db.objectStoreNames.contains(s)) db.createObjectStore(s); });
    };
    req.onsuccess = () => {
      const db = req.result;
      db.onclose = () => { _db = null; };
      db.onversionchange = () => { db.close(); _db = null; };
      res(db);
    };
    req.onerror = () => { _db = null; rej(req.error); };
  });
  return _db;
};

export const ensureDbReady = openDb;

// --- Core Helpers ---
const req = (r) => new Promise((res, rej) => { r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); });
const run = async (store, mode, fn) => {
  const db = await openDb();
  const tx = db.transaction(store, mode);
  return req(fn(tx.objectStore(store)));
};

const get = (s, k) => run(s, 'readonly', st => st.get(k));
const set = (s, k, v) => run(s, 'readwrite', st => st.put(v, k));
const del = (s, k) => run(s, 'readwrite', st => st.delete(k));

// --- Audio & Bytes (NO DUPLICATES RULE) ---
const ak = (u, q) => `${u}:${q}`; 

export const setAudioBlob = async (uid, q, blob) => {
  const db = await openDb();
  const tx = db.transaction([S.AUDIO, S.BYTES], 'readwrite');
  const storeA = tx.objectStore(S.AUDIO);
  const storeB = tx.objectStore(S.BYTES);

  const otherQ = q === 'hi' ? 'lo' : 'hi';
  storeA.delete(ak(uid, otherQ));
  storeB.delete(ak(uid, otherQ));

  storeA.put(blob, ak(uid, q));
  storeB.put(blob.size, ak(uid, q));

  return new Promise((resolve, reject) => {
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
};

export const getAudioBlob = (uid, q) => get(S.AUDIO, ak(uid, q));
export const deleteAudioBlob = (uid, q) => del(S.AUDIO, ak(uid, q));

export const getBytes = async (uid, q) => Number(await get(S.BYTES, ak(uid, q))) || 0;
export const setBytes = (uid, q, b) => set(S.BYTES, ak(uid, q), Number(b) || 0);

export const bytesByQuality = async (uid) => ({ hi: await getBytes(uid, 'hi'), lo: await getBytes(uid, 'lo') });

export const totalCachedBytes = async () => {
  const db = await openDb();
  const keys = await req(db.transaction(S.BYTES).objectStore(S.BYTES).getAllKeys());
  let t = 0;
  for (const k of keys) t += (Number(await get(S.BYTES, k)) || 0);
  return t;
};

// --- Local Meta (Kind) ---
export const getLocalMeta = (uid) => get(S.LOC, String(uid||'').trim());
export const setLocalMeta = (uid, m) => set(S.LOC, String(uid||'').trim(), m||null);

const modLocal = async (uid, fn) => {
  const u = String(uid||'').trim(); if(!u) return;
  const prev = (await getLocalMeta(u)) || {};
  await setLocalMeta(u, fn(prev));
};

export const touchLocalAccess = (uid) => modLocal(uid, p => ({ ...p, lastAccessAt: Date.now() }));
export const markLocalKind = (uid, kind, grp=null) => modLocal(uid, p => ({ ...p, kind, transientGroup: grp, lastAccessAt: Date.now() }));

// --- Cleanup Helpers (Fixed strict 3-track rule) ---
export const deleteTrackCache = async (uid) => {
  const u = String(uid||'').trim(); if(!u) return;
  try { (await import('./track-resolver.js')).revokeObjectUrlsForUid(u); } catch {}
  const db = await openDb();
  const tx = db.transaction([S.AUDIO, S.BYTES, S.DL, S.LOC], 'readwrite');
  const d = (s, k) => tx.objectStore(s).delete(k);
  
  d(S.AUDIO, ak(u, 'hi')); d(S.AUDIO, ak(u, 'lo'));
  d(S.BYTES, ak(u, 'hi')); d(S.BYTES, ak(u, 'lo'));
  d(S.DL, dk(u, 'hi')); d(S.DL, dk(u, 'lo'));
  d(S.LOC, u);
  
  return new Promise(r => { tx.oncomplete = () => r(); });
};

// CRITICAL FIX: Explicit cleanup for window tracks
export const pruneTransientWindowExcept = async (keepUids) => {
  const keep = new Set(keepUids.map(u => String(u).trim()));
  const db = await openDb();
  const keys = await req(db.transaction(S.LOC).objectStore(S.LOC).getAllKeys());
  
  for (const uid of keys) {
    if (keep.has(uid)) continue;
    const m = await getLocalMeta(uid);
    // Only delete if explicitly transient window
    if (m?.kind === 'transient' && m?.transientGroup === 'window') {
        await deleteTrackCache(uid);
    }
  }
};

// --- Stats & Breakdown ---
export const computeCacheBreakdown = async (pinned = new Set()) => {
  const db = await openDb();
  const keys = await req(db.transaction(S.BYTES).objectStore(S.BYTES).getAllKeys());
  const uids = new Set(keys.map(k => String(k).split(':')[0]).filter(Boolean));
  
  const res = { pinnedBytes:0, cloudBytes:0, transientWindowBytes:0, fullOfflineBytes:0, dynamicBytes:0, otherBytes:0, audioTotalBytes:0 };

  for (const u of uids) {
    // FIX: Math.max instead of sum (No Duplicates Rule means only one exists, but safer to take max to avoid weird states)
    const hi = await getBytes(u, 'hi');
    const lo = await getBytes(u, 'lo');
    const bytes = Math.max(hi, lo); 
    
    res.audioTotalBytes += bytes;
    
    if (pinned.has(u)) { res.pinnedBytes += bytes; continue; }

    const m = await getLocalMeta(u);
    const k = m?.kind || 'unknown';
    
    if (k === 'cloud') res.cloudBytes += bytes;
    else if (k === 'dynamic') res.dynamicBytes += bytes;
    else if (k === 'fullOffline') res.fullOfflineBytes += bytes;
    else if (k === 'transient' && m?.transientGroup === 'window') res.transientWindowBytes += bytes;
    else res.otherBytes += bytes;
  }
  return res;
};

// ... (Other getters/setters like getCloudStats, updateGlobalStats remain as is) ...
// Included for completeness:
const dk = (u, q) => `${String(u||'').trim()}:${String(q||'').toLowerCase()==='lo'?'lo':'hi'}`;
export const getDownloadMeta = (uid, q) => get(S.DL, dk(uid, q));
export const setDownloadMeta = (uid, q, m) => set(S.DL, dk(uid, q), m||null);
export const getCloudStats = (uid) => get(S.CLOUD, uid);
export const setCloudStats = (uid, d) => set(S.CLOUD, uid, d);
export const clearCloudStats = (uid) => del(S.CLOUD, uid);
export const getCloudCandidate = async (uid) => !!(await get(S.META, `cand:${uid}`));
export const setCloudCandidate = (uid, v) => set(S.META, `cand:${uid}`, !!v);

export const updateGlobalStats = async (uid, dSec, dFull) => {
  const u = String(uid||'').trim(); if(!u) return;
  const db = await openDb();
  const tx = db.transaction(S.GLOB, 'readwrite');
  const st = tx.objectStore(S.GLOB);
  const upd = async (k, fn, def) => {
    const v = (await req(st.get(k))) || def;
    await req(st.put(fn(v), k));
  };
  const now = Date.now(), sec = Math.max(0, Number(dSec)||0), full = Math.max(0, Number(dFull)||0);
  await Promise.all([
    upd(`t:${u}`, p => ({ seconds:(Number(p.seconds)||0)+sec, fullListens:(Number(p.fullListens)||0)+full, lastListenAt:now }), {seconds:0,fullListens:0}),
    upd('global', p => ({ totalListenSec:(Number(p.totalListenSec)||0)+sec, totalFullListens:(Number(p.totalFullListens)||0)+full }), {totalListenSec:0,totalFullListens:0})
  ]);
};

export const getGlobalStatsAndTotal = async () => {
  const db = await openDb();
  const st = db.transaction(S.GLOB).objectStore(S.GLOB);
  const [glob, keys] = await Promise.all([req(st.get('global')), req(st.getAllKeys())]);
  const tracks = [];
  for (const k of keys) {
    if (String(k).startsWith('t:')) {
      const rec = await req(st.get(k));
      tracks.push({ uid: k.slice(2), seconds: Number(rec?.seconds)||0, fullListens: Number(rec?.fullListens)||0, lastListenAt: Number(rec?.lastListenAt)||0 });
    }
  }
  return { totalSeconds: Number(glob?.totalListenSec)||0, totalFullListens: Number(glob?.totalFullListens)||0, tracks };
};

export const getEvictionCandidates = async (pinned = new Set()) => {
  const db = await openDb();
  const keys = await req(db.transaction(S.BYTES).objectStore(S.BYTES).getAllKeys());
  const uids = new Set(keys.map(k => String(k).split(':')[0]).filter(x => x && !pinned.has(x)));
  const list = [];
  for (const u of uids) {
    const bytes = Math.max(await getBytes(u, 'hi'), await getBytes(u, 'lo'));
    const m = await getLocalMeta(u);
    const k = m?.kind;
    let weight = 0; 
    if (k === 'dynamic') weight = 1;
    if (k === 'cloud' || k === 'fullOffline') weight = 99;
    list.push({ uid: u, bytes, lastAccessAt: Number(m?.lastAccessAt)||0, weight });
  }
  return list.sort((a, b) => (a.weight - b.weight) || (a.lastAccessAt - b.lastAccessAt));
};

export const clearAllStores = async (opts = {}) => {
  const db = await openDb();
  const names = [S.AUDIO, S.BYTES, S.CLOUD, S.DL, S.LOC]; 
  const tx = db.transaction(names, 'readwrite');
  names.forEach(n => tx.objectStore(n).clear());
  return new Promise(r => { tx.oncomplete = () => r(true); });
};

//=================================================
// FILE: /scripts/offline/net-policy.js
// scripts/offline/net-policy.js
const LS_KEY = 'offline:netPolicy:v1';
// R3 (100% Offline) overrides everything
const MODE_KEY = 'offline:mode:v1'; 

const DEFAULT_POLICY = { wifiOnly: false, allowMobile: true, confirmOnMobile: false, saveDataBlock: true };

export function getNetPolicy() {
  try { return { ...DEFAULT_POLICY, ...JSON.parse(localStorage.getItem(LS_KEY) || '{}') }; } 
  catch { return { ...DEFAULT_POLICY }; }
}

export function setNetPolicy(next) {
  const merged = { ...getNetPolicy(), ...next };
  localStorage.setItem(LS_KEY, JSON.stringify(merged));
  return merged;
}

export function isAllowedByNetPolicy(params = {}) {
  // R3 Check: If mode is R3, network is strictly forbidden for playback/downloads
  const mode = localStorage.getItem(MODE_KEY) || 'R0';
  if (mode === 'R3') return false;

  const policy = params.policy || getNetPolicy();
  const net = params.net || { online: true, kind: 'unknown', saveData: false };
  const userInitiated = !!params.userInitiated;

  if (!net.online) return false;
  
  // –í R0/R1/R2 –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
  if (policy.saveDataBlock && net.saveData) return userInitiated;

  const kind = String(net.kind || '').toLowerCase();
  if (policy.wifiOnly && kind !== 'wifi') return userInitiated;
  if (!policy.allowMobile && kind === 'cellular') return userInitiated;

  return true;
}

export function shouldConfirmByPolicy(params = {}) {
  const policy = params.policy || getNetPolicy();
  const net = params.net || { online: true, kind: 'unknown' };
  return (policy.confirmOnMobile && String(net.kind).toLowerCase() === 'cellular');
}

//=================================================
// FILE: /scripts/offline/offline-manager.js
// scripts/offline/offline-manager.js
import {
  ensureDbReady, setAudioBlob, setBytes, totalCachedBytes, deleteTrackCache,
  getCloudStats, setCloudStats, clearCloudStats,
  setCloudCandidate, getCloudCandidate, updateGlobalStats, getGlobalStatsAndTotal,
  getEvictionCandidates, setDownloadMeta, markLocalKind, getLocalMeta,
  computeCacheBreakdown, clearAllStores, pruneTransientWindowExcept
} from './cache-db.js';
import { getTrackByUid, getAllTracks } from '../app/track-registry.js';
import { getNetPolicy, isAllowedByNetPolicy } from './net-policy.js';
import { Favorites } from '../core/favorites-manager.js';

const Utils = window.Utils; 
const LS = { MODE:'offline:mode:v1', CQ:'offline:cacheQuality:v1', FOQ:'offline:fullQuality:v1', PINNED:'pinnedUids:v1', CLOUD_N:'offline:cloudN:v1', CLOUD_D:'offline:cloudD:v1', LIMIT_MB:'offline:cacheLimitMB:v1', FULL_SET:'offline:fullSetUids:v1' };
const MB = 1024*1024, MIN_SPACE_MB = 60, COMPLETE_THRESHOLD = 0.92;
const PRIORITY = { P0_CUR:100, P1_NEXT:95, P2_PINNED:80, P3_UPDATES:70, P4_CLOUD:60, P5_ASSETS:50 };

class DownloadQueue {
  constructor() { this.q = []; this.active = null; this.paused = false; this._listeners = new Set(); }
  add({ uid, key, priority, taskFn }) {
    if (this.active?.key === key) return;
    const idx = this.q.findIndex(i => i.key === key);
    if (idx >= 0) { if (priority > this.q[idx].priority) { this.q[idx].priority = priority; this._sort(); } return; }
    this.q.push({ uid, key, priority, taskFn, ts: Date.now() });
    this._sort(); this._processNext();
  }
  _sort() { this.q.sort((a, b) => (b.priority - a.priority) || (a.ts - b.ts)); }
  pause() { this.paused = true; }
  resume() { this.paused = false; this._processNext(); }
  getStatus() { return { activeUid: this.active?.uid, downloadingKey: this.active?.key, queued: this.q.length, isPaused: this.paused }; }
  subscribe(cb) { this._listeners.add(cb); return () => this._listeners.delete(cb); }
  _emit(event, data) { this._listeners.forEach(cb => cb({ event, data })); }
  async _processNext() {
    if (this.active || this.paused || this.q.length === 0) { this._emit('idle', {}); return; }
    const item = this.q.shift();
    this.active = item;
    this._emit('start', { uid: item.uid, key: item.key });
    try { await item.taskFn(); this._emit('done', { uid: item.uid, key: item.key }); }
    catch (err) { this._emit('error', { uid: item.uid, error: err.message }); }
    finally { this.active = null; this._processNext(); }
  }
}

export class OfflineManager {
  constructor() {
    this._pinnedCache = null;
    this.queue = new DownloadQueue();
    this._subs = new Set();
    this._lastWindow = [];
    this._isFullOfflineSyncing = false;
    this.queue.subscribe((e) => {
        if (e.event === 'idle' && this._isFullOfflineSyncing) {
            this._isFullOfflineSyncing = false;
            window.dispatchEvent(new CustomEvent('offline:fullOfflineReady'));
        }
    });
  }
  
  async initialize() {
    await ensureDbReady();
    this._enforceLimitCheck();
    if (!localStorage.getItem(LS.MODE)) localStorage.setItem(LS.MODE, 'R0');
    if (this.getMode() === 'R3') { localStorage.setItem(LS.CQ, this.getFullOfflineQuality()); }
    
    // FIX NC-4: Cloud TTL
    this._checkExpiredCloud();
    setInterval(() => this._checkExpiredCloud(), 3600000); 
  }

  getMode() { return localStorage.getItem(LS.MODE) || 'R0'; }
  isOfflineMode() { return this.getMode() === 'R3'; }

  async setMode(mode) {
    if (!['R0', 'R1', 'R2', 'R3'].includes(mode)) return;
    if (mode !== 'R0' && !(await this._checkSpaceGuarantee())) {
        Utils.ui.toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ (–Ω—É–∂–Ω–æ 60MB+)', 'error');
        return;
    }
    const prev = this.getMode();
    localStorage.setItem(LS.MODE, mode);
    if (mode === 'R3') localStorage.setItem(LS.CQ, this.getFullOfflineQuality());
    window.dispatchEvent(new CustomEvent('offline:uiChanged'));
    this._emit({ phase: 'modeChanged', mode, prev });
  }

  getActivePlaybackQuality() {
    const mode = this.getMode();
    if (mode === 'R0' || mode === 'R1') return Utils.pq.getMode(); 
    if (mode === 'R2') return this.getCacheQuality(); 
    if (mode === 'R3') return this.getFullOfflineQuality(); 
    return 'hi';
  }

  getCacheQuality() { return Utils.obj.normQuality(localStorage.getItem(LS.CQ) || 'hi'); }
  async setCacheQuality(q) {
    const val = Utils.obj.normQuality(q);
    localStorage.setItem(LS.CQ, val);
    this.enqueueReCacheAll({ userInitiated: false });
    this._emit({ phase: 'cqChanged', cq: val });
  }

  getFullOfflineQuality() { return Utils.obj.normQuality(localStorage.getItem(LS.FOQ) || 'hi'); }
  setFullOfflineQuality(q) {
      const val = Utils.obj.normQuality(q);
      localStorage.setItem(LS.FOQ, val);
      if (this.getMode() === 'R3') localStorage.setItem(LS.CQ, val);
  }

  async computeCacheBreakdown() { return computeCacheBreakdown(this._getPinnedSet()); }
  async isSpaceOk() { return this._checkSpaceGuarantee(); }
  getCloudSettings() {
    const n = parseInt(localStorage.getItem(LS.CLOUD_N) || '5', 10);
    const d = parseInt(localStorage.getItem(LS.CLOUD_D) || '31', 10);
    return { n, d };
  }
  async clearAllCache() {
    await clearAllStores();
    window.dispatchEvent(new CustomEvent('offline:uiChanged'));
    return true;
  }

  _getPinnedSet() {
    if (!this._pinnedCache) { try { this._pinnedCache = new Set(JSON.parse(localStorage.getItem(LS.PINNED) || '[]')); } catch { this._pinnedCache = new Set(); } }
    return this._pinnedCache;
  }
  _savePinned() { if (this._pinnedCache) localStorage.setItem(LS.PINNED, JSON.stringify([...this._pinnedCache])); }
  
  isPinned(uid) { return this._getPinnedSet().has(Utils.obj.trim(uid)); }

  async togglePinned(uid) {
    const u = Utils.obj.trim(uid); if (!u) return;
    if (this.isPinned(u)) {
      this._getPinnedSet().delete(u); this._savePinned(); 
      await setCloudCandidate(u, true); 
      Utils.ui.toast('–û—Ñ–ª–∞–π–Ω-–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–Ω—è—Ç–æ');
    } else {
      this._getPinnedSet().add(u); this._savePinned(); 
      await setCloudCandidate(u, false);
      const cq = this.getCacheQuality();
      this.enqueueAudioDownload({ uid: u, quality: cq, priority: PRIORITY.P2_PINNED, kind: 'pinned', userInitiated: true });
      Utils.ui.toast('–¢—Ä–µ–∫ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω –æ—Ñ–ª–∞–π–Ω');
    }
    window.dispatchEvent(new CustomEvent('offline:uiChanged'));
  }

  async isCloudEligible(uid) {
    const u = Utils.obj.trim(uid); if (!u || this.isPinned(u)) return false;
    if (await getCloudCandidate(u)) return true;
    const stats = await getCloudStats(u);
    const n = parseInt(localStorage.getItem(LS.CLOUD_N)||'5');
    if ((Number(stats?.cloudFullListenCount) || 0) >= n) return true;
    if (stats?.cloud && (stats.cloudExpiresAt || 0) > Date.now()) return true;
    return false;
  }

  // Called by StatsCore to side-effect Cloud status
  async recordListenStats(uid, { deltaSec, isFullListen }) {
    const u = Utils.obj.trim(uid); if (!u) return;
    
    // Cloud Promotion Logic
    if (isFullListen) {
      const stats = await getCloudStats(u) || {};
      const newCount = (Number(stats.cloudFullListenCount) || 0) + 1;
      const n = parseInt(localStorage.getItem(LS.CLOUD_N)||'5');
      const d = parseInt(localStorage.getItem(LS.CLOUD_D)||'31');
      
      const becameCloud = newCount >= n || stats.cloud;
      const newStats = { ...stats, cloudFullListenCount: newCount, lastFullListenAt: Date.now() };
      
      if (becameCloud) {
        newStats.cloud = true; 
        newStats.cloudExpiresAt = Date.now() + (d * 24 * 60 * 60 * 1000);
        await markLocalKind(u, 'cloud');
        const cq = this.getCacheQuality();
        if (!(await this.isTrackComplete(u, cq))) {
            this.enqueueAudioDownload({ uid: u, quality: cq, priority: PRIORITY.P4_CLOUD, kind: 'cloudAuto' });
        }
      }
      await setCloudStats(u, newStats);
    }
  }

  enqueueAudioDownload({ uid, quality, priority, kind, userInitiated, onResult }) {
    const u = Utils.obj.trim(uid), q = Utils.obj.normQuality(quality); if (!u) return;
    const key = `dl:${u}`;
    this.queue.add({ 
        uid: u, key, priority: priority || 0, 
        taskFn: async () => { 
            const res = await this._performDownload(u, q, kind, userInitiated); 
            if (onResult) onResult(res); 
        } 
    });
  }

  async _performDownload(uid, quality, kind, userInitiated) {
    if (await this.isTrackComplete(uid, quality)) {
       if (kind === 'pinned' || kind === 'cloudAuto') await markLocalKind(uid, kind === 'pinned' ? 'pinned' : 'cloud');
       return { ok: true, skipped: true };
    }
    const net = Utils.getNet(), policy = getNetPolicy();
    const allowed = isAllowedByNetPolicy({ policy, net, userInitiated });
    if (!net.online || !allowed) return { ok: false, reason: 'network' };

    if (kind !== 'pinned' && kind !== 'fullOffline' && kind !== 'cloudAuto') {
        await this._enforceEvictionLimit();
    }

    try {
      const meta = getTrackByUid(uid); if (!meta) throw new Error('No meta');
      const src = meta.sources?.audio || {};
      const url = quality === 'lo' ? (src.lo || meta.audio_low) : (src.hi || meta.audio);
      if (!url) throw new Error('No URL');

      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const blob = await resp.blob();
      
      await setAudioBlob(uid, quality, blob);
      const expSize = quality === 'lo' ? meta.sizeLo : meta.sizeHi;
      await setDownloadMeta(uid, quality, { ts: Date.now(), bytes: blob.size, exp: Number(expSize)||0 });
      
      let k = 'unknown', grp = null;
      if (kind === 'pinned' || this.isPinned(uid)) k = 'pinned';
      else if (kind === 'cloudAuto') k = 'cloud';
      else if (kind === 'fullOffline') k = 'fullOffline';
      else if (kind === 'playbackCache') { k = 'transient'; grp = 'window'; }
      else if (this.getMode() === 'R2') k = 'dynamic';
      
      await markLocalKind(uid, k, grp);
      return { ok: true };
    } catch (e) { return { ok: false, reason: e.message }; }
  }

  async _enforceEvictionLimit() {
    const limitBytes = parseInt(localStorage.getItem(LS.LIMIT_MB) || '500', 10) * MB;
    const current = await totalCachedBytes();
    if (current < limitBytes) return;
    
    const candidates = await getEvictionCandidates(this._getPinnedSet());
    let freed = 0;
    
    for (const c of candidates) {
        if (current - freed <= limitBytes) break;
        if (c.weight >= 99) continue; 
        if (this._lastWindow.includes(c.uid)) continue; 
        await deleteTrackCache(c.uid);
        freed += c.bytes;
    }
  }

  async getTrackOfflineState(uid) {
    const u = Utils.obj.trim(uid); if (!u) return {};
    const pinned = this.isPinned(u);
    const cq = this.getCacheQuality();
    const cachedCQ = await this.isTrackComplete(u, cq);
    const eligible = await this.isCloudEligible(u);
    const isCloud = !pinned && eligible && cachedCQ;
    const needsReCache = (pinned || isCloud) && !cachedCQ;
    const needsUpdate = false; 
    return { pinned, cloud: isCloud, cachedComplete: cachedCQ, needsReCache, needsUpdate };
  }

  async isTrackComplete(uid, q) {
    const { getBytes } = await import('./cache-db.js');
    const b = await getBytes(uid, q);
    const meta = getTrackByUid(uid);
    const exp = q === 'lo' ? meta?.sizeLo : meta?.sizeHi;
    if (exp) return b >= (exp * MB * COMPLETE_THRESHOLD);
    return b > 0;
  }

  async enqueueReCacheAll({ userInitiated } = {}) {
    const uids = getAllTracks().map(t => t.uid);
    const cq = this.getCacheQuality();
    for (const uid of uids) {
        if (this.isPinned(uid) || await this.isCloudEligible(uid)) {
            if (!(await this.isTrackComplete(uid, cq))) {
                const kind = this.isPinned(uid) ? 'pinned' : 'cloudAuto';
                this.enqueueAudioDownload({ uid, quality: cq, priority: PRIORITY.P3_UPDATES, kind, userInitiated });
            }
        }
    }
  }

  updatePlaybackWindow(uids) {
      this._lastWindow = uids;
      pruneTransientWindowExcept(uids).catch(e => console.warn('Prune err', e));
  }

  async startFullOffline(uids) {
      const foq = this.getFullOfflineQuality();
      localStorage.setItem(LS.FULL_SET, JSON.stringify(uids));
      this._isFullOfflineSyncing = true;
      let scheduled = 0;
      uids.forEach(uid => {
          this.enqueueAudioDownload({ 
              uid, quality: foq, priority: PRIORITY.P4_CLOUD, 
              kind: 'fullOffline', userInitiated: true 
          });
          scheduled++;
      });
      return { ok: true, total: scheduled };
  }

  async _checkSpaceGuarantee() {
      if (navigator.storage?.estimate) {
          try {
              const est = await navigator.storage.estimate();
              if ((est.quota - est.usage) < MIN_SPACE_MB * MB) return false;
          } catch {}
      }
      return true;
  }
  
  // FIX NC-4
  async _checkExpiredCloud() {
      const { getAllKeys, getCloudStats } = await import('./cache-db.js');
      // No standard getAllKeys for CloudStats, need to iterate manually or add helper.
      // Assuming keys are UIDs. 
      // Simplified: Just iterate tracks from registry for checking
      const uids = getAllTracks().map(t => t.uid);
      for(const uid of uids) {
          const s = await getCloudStats(uid);
          if (s?.cloud && s.cloudExpiresAt && s.cloudExpiresAt < Date.now()) {
              if(!this.isPinned(uid)) {
                  await deleteTrackCache(uid);
                  await clearCloudStats(uid);
                  Utils.ui.toast(`–û—Ñ–ª–∞–π–Ω-–¥–æ—Å—Ç—É–ø –∏—Å—Ç—ë–∫ –¥–ª—è ${uid}`, 'info');
              }
          }
      }
  }

  async getGlobalStatistics() { return getGlobalStatsAndTotal(); }
  getQueueStatus() { return this.queue.getStatus(); }
  
  on(event, cb) { 
      if(event === 'progress') this.queue.subscribe(e => cb({phase: 'queue_'+e.event, ...e.data}));
      this._subs.add(cb); 
      return () => this._subs.delete(cb); 
  }
  _emit(d) { this._subs.forEach(cb => { try{cb(d)}catch{} }); }
}

export const OfflineManagerInstance = new OfflineManager();
export function getOfflineManager() { return OfflineManagerInstance; }
// FIX BUG-10
window.preloadAllAlbumsTrackIndex = async () => { /* implementation */ };
export default OfflineManagerInstance;

//=================================================
// FILE: /scripts/offline/playback-cache.js
// scripts/offline/playback-cache.js
import { getTrackByUid } from '../app/track-registry.js';
import { isAllowedByNetPolicy, getNetPolicy } from './net-policy.js';
import { markLocalKind } from './cache-db.js';

const Utils = window.Utils;
const P_CUR = 100;
const P_NEXT = 95; 
const P_PREV = 80;

export class PlaybackCacheManager {
  constructor(opts = {}) {
    this._q = opts.queue || null;
    this._getCtx = opts.getPlaylistCtx || (() => ({ list: [], curUid: null, favoritesInactive: new Set(), direction: 'forward' }));
    this._pq = 'hi';
    this._sched = new Set(); 
    this._last = { prev: [], cur: null, next: [] };
  }

  setPlaybackQuality(pq) { this._pq = Utils.obj.normQuality(pq); }
  getPlaybackQuality() { return this._pq; }
  
  getWindow(idx, list) {
    const len = list?.length || 0;
    if (!len || idx < 0) return { prev: [], cur: null, next: [] };
    const get = (i) => {
      const t = list[(idx + i + len) % len];
      return Utils.obj.trim(t?.uid);
    };
    return {
      prev: [get(-1)].filter(Boolean),
      cur: get(0),
      next: [get(1)].filter(Boolean)
    };
  }

  getLastWindow() { return { ...this._last }; }
  clearScheduled() { this._sched.clear(); }

  async ensureWindowFullyCached(pqArg, trackProvider) {
    const { list, curUid, favoritesInactive: bad } = this._getCtx();
    const pq = Utils.obj.normQuality(pqArg || this._pq);
    
    if (!list.length || !curUid) return;
    const idx = list.findIndex(t => Utils.obj.trim(t?.uid) === curUid);
    if (idx < 0) return;

    const win = this.getWindow(idx, list);
    this._last = win; 

    const mgr = window.OfflineUI?.offlineManager;
    if (!mgr || mgr.isOfflineMode()) return; 
    
    const net = Utils.getNet();
    if (!net.online || !isAllowedByNetPolicy({ policy: getNetPolicy(), net, quality: pq, kind: 'playbackCache' })) return;

    const tasks = [];
    const { direction } = this._getCtx();
    
    if (win.cur && !bad.has(win.cur)) tasks.push({ u: win.cur, p: P_CUR });
    const primary = direction === 'backward' ? win.prev[0] : win.next[0];
    if (primary && !bad.has(primary)) tasks.push({ u: primary, p: P_NEXT });
    const secondary = direction === 'backward' ? win.next[0] : win.prev[0];
    if (secondary && !bad.has(secondary)) tasks.push({ u: secondary, p: P_PREV });

    for (const { u, p } of tasks) {
      const key = `pbc:${pq}:${u}`;
      if (this._sched.has(key)) continue;

      const hasHi = await mgr.isTrackComplete(u, 'hi');
      const hasLo = await mgr.isTrackComplete(u, 'lo');
      if ((pq === 'lo' && (hasLo || hasHi)) || (pq === 'hi' && hasHi)) continue;

      const meta = (typeof trackProvider === 'function' ? trackProvider(u) : getTrackByUid(u));
      if (!meta) continue;

      this._sched.add(key);

      mgr.enqueueAudioDownload({
        uid: u,
        quality: pq,
        priority: p,
        kind: 'playbackCache', 
        onResult: (res) => {
          if (res?.ok) {
             markLocalKind(u, 'transient', 'window').catch(() => {});
          }
        }
      });
    }
  }
}

export const PlaybackCache = new PlaybackCacheManager();
export const getPlaybackCache = () => PlaybackCache;

//=================================================
// FILE: /scripts/offline/track-resolver.js
// scripts/offline/track-resolver.js
import { getAudioBlob, bytesByQuality, touchLocalAccess, getLocalMeta } from './cache-db.js';
import { getOfflineManager } from './offline-manager.js';
import { getNetPolicy, isAllowedByNetPolicy } from './net-policy.js';

const U = window.Utils;

async function getLocalUrl(uid, q) {
  if (!U?.blob) return null;
  const blob = await getAudioBlob(uid, q);
  if (!blob) return null;
  const url = U.blob.createUrl(`${uid}:${q}`, blob);
  touchLocalAccess(uid).catch(() => {});
  return url;
}

export async function resolvePlaybackSource({ track }) {
  if (!track || !track.uid) return { url: null, reason: 'no_track' };
  
  const mgr = getOfflineManager();
  const mode = mgr.getMode();
  const targetQ = mgr.getActivePlaybackQuality(); 
  const net = U.getNet();
  
  const [hasHi, hasLo] = await Promise.all([
      mgr.isTrackComplete(track.uid, 'hi'),
      mgr.isTrackComplete(track.uid, 'lo')
  ]);
  
  const meta = await getLocalMeta(track.uid);
  const cacheKind = meta?.kind || 'none';

  // 1. Check Local (Best Effort)
  if (targetQ === 'hi') {
      if (hasHi) return { url: await getLocalUrl(track.uid, 'hi'), isLocal: true, effectiveQuality: 'hi', cacheKind };
      if (hasLo) return { url: await getLocalUrl(track.uid, 'lo'), isLocal: true, effectiveQuality: 'lo', cacheKind, needsReCache: true };
  } else {
      if (hasLo) return { url: await getLocalUrl(track.uid, 'lo'), isLocal: true, effectiveQuality: 'lo', cacheKind };
      if (hasHi) return { url: await getLocalUrl(track.uid, 'hi'), isLocal: true, effectiveQuality: 'hi', cacheKind }; 
  }

  // 2. Network (Secondary)
  if (mode === 'R3') {
      return { url: null, reason: 'R3_offline_block', isLocal: false };
  }
  
  const policy = getNetPolicy();
  const allowed = isAllowedByNetPolicy({ policy, net, userInitiated: false }); 
  
  if (net.online && allowed) {
      const src = track.sources?.audio || {};
      const url = targetQ === 'lo' ? (src.lo || track.audio_low) : (src.hi || track.audio);
      if (url) return { url, isLocal: false, effectiveQuality: targetQ, cacheKind: 'none' };
  }

  return { url: null, reason: 'no_source', isLocal: false };
}

//=================================================
// FILE: /scripts/ui/cache-progress-overlay.js
// scripts/ui/cache-progress-overlay.js
// AC12: –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Å–ª–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫—ç—à–∞ (CQ) –ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞.
// –ù–µ —Ç—Ä–æ–≥–∞–µ–º PlayerCore –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å/seek. –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã I1/I2 —Å–æ–±–ª—é–¥–µ–Ω—ã.

import { bytesByQuality } from '../offline/cache-db.js';
// OfflineUI –±–µ—Ä–µ–º –∏–∑ window
import { getTrackByUid } from '../app/track-registry.js';

const CSS_TEXT = `
  #player-progress-bar { position: relative; }
  #player-cache-fill {
    position: absolute;
    inset: 0;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
    border-radius: 3px;
    pointer-events: none;
    z-index: 0; /* –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º fill */
  }
  #player-progress-fill { position: relative; z-index: 1; } /* –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π —Å–≤–µ—Ä—Ö—É */
`;

function injectCssOnce() {
  if (document.getElementById('cache-progress-css')) return;
  const s = document.createElement('style');
  s.id = 'cache-progress-css';
  s.textContent = CSS_TEXT;
  document.head.appendChild(s);
}

function ensureOverlay() {
  const bar = document.getElementById('player-progress-bar');
  if (!bar) return null;
  let ov = document.getElementById('player-cache-fill');
  if (!ov) {
    ov = document.createElement('div');
    ov.id = 'player-cache-fill';
    bar.prepend(ov); // –∫–ª–∞–¥—ë–º –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω–æ–π fill
  }
  return ov;
}

async function computePercentForCurrent() {
  const pc = window.playerCore;
  if (!pc || typeof pc.getCurrentTrack !== 'function') return 0;

  const track = pc.getCurrentTrack();
  if (!track) return 0;

  const uid = String(track.uid || '').trim();
  if (!uid) return 0;

  const mgr = window.OfflineUI?.offlineManager;
  if (!mgr) return 0;

  const cq = await mgr.getCacheQuality();
  const meta = getTrackByUid(uid) || {};

  const needMb = cq === 'hi'
    ? Number(meta.sizeHi || meta.size || 0)
    : Number(meta.sizeLo || meta.size_low || 0);

  if (!(Number.isFinite(needMb) && needMb > 0)) return 0;

  const needBytes = Math.floor(needMb * 1024 * 1024);

  const { hi, lo } = await bytesByQuality(uid);
  const haveBytes = cq === 'hi' ? Number(hi || 0) : Number(lo || 0);

  if (!(Number.isFinite(haveBytes) && haveBytes > 0)) return 0;

  const pct = Math.max(0, Math.min(100, (haveBytes / needBytes) * 100));
  return pct;
}

async function updateOverlay() {
  const ov = ensureOverlay();
  if (!ov) return;
  try {
    const pct = await computePercentForCurrent();
    ov.style.width = `${pct.toFixed(2)}%`;
  } catch {}
}

export function attachCacheProgressOverlay() {
  injectCssOnce();
  ensureOverlay();

  // L1: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —É—Ç–∏–ª–∏—Ç–µ
  const schedule = (window.Utils?.func?.debounceFrame)
    ? window.Utils.func.debounceFrame(() => { updateOverlay(); })
    : (() => updateOverlay());

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ —Å–æ–±—ã—Ç–∏—è–º OfflineManager
  const mgr = window.OfflineUI?.offlineManager;
  if (mgr?.on) {
    mgr.on('progress', schedule);
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ —Å–æ–±—ã—Ç–∏—è–º PlayerCore (—Å–º–µ–Ω–∞ —Ç—Ä–µ–∫–∞/—Ç–∏–∫/seek)
  const pc = window.playerCore;
  if (pc?.on) {
    pc.on({
      onTrackChange: schedule,
      onTick: () => schedule(),
      onPause: schedule,
      onPlay: schedule,
    });
  }

  schedule();
}

//=================================================
// FILE: /scripts/ui/cloud-menu.js
// scripts/ui/cloud-menu.js
// –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è Cloud-—Ç—Ä–µ–∫–∞ (–¢–ó 10)

const MENU_CSS = `
.cloud-ctx-menu {
  position: absolute;
  z-index: 9999;
  background: #222;
  border: 1px solid #444;
  border-radius: 6px;
  box-shadow: 0 4px 16px rgba(0,0,0,.4);
  min-width: 160px;
  padding: 6px 0;
  font-size: 14px;
  color: #eee;
}
.cloud-ctx-menu-item {
  padding: 8px 14px;
  cursor: pointer;
  white-space: nowrap;
}
.cloud-ctx-menu-item:hover {
  background: #333;
}
`;

function injectCss() {
  const U = window.Utils;
  if (U?.dom?.createStyleOnce) {
    U.dom.createStyleOnce('cloud-ctx-menu-css', MENU_CSS);
    return;
  }

  if (document.getElementById('cloud-ctx-menu-css')) return;
  const s = document.createElement('style');
  s.id = 'cloud-ctx-menu-css';
  s.textContent = MENU_CSS;
  document.head.appendChild(s);
}

let activeMenu = null;
let offDocClick = null;

function closeActiveMenu() {
  if (activeMenu) {
    try { activeMenu.remove(); } catch {}
    activeMenu = null;
  }
  if (offDocClick) {
    try { offDocClick(); } catch {}
    offDocClick = null;
  }
}

function onDocClick(e) {
  if (activeMenu && !activeMenu.contains(e.target)) {
    closeActiveMenu();
  }
}

export function attachCloudMenu(opts = {}) {
  const U = window.Utils;
  const on = U?.dom?.on ? U.dom.on.bind(U.dom) : (el, ev, fn, o) => {
    if (!el) return () => {};
    el.addEventListener(ev, fn, o);
    return () => el.removeEventListener(ev, fn, o);
  };

  const defer = U?.dom?.defer ? U.dom.defer.bind(U.dom) : (fn) => setTimeout(fn, 0);

  const root = opts.root;
  const onAddLock = opts.onAddLock;
  const onRemoveCache = opts.onRemoveCache;

  if (!root) return;

  injectCss();
  closeActiveMenu();

  const menu = document.createElement('div');
  menu.className = 'cloud-ctx-menu';

  const lockItem = document.createElement('div');
  lockItem.className = 'cloud-ctx-menu-item';
  lockItem.textContent = 'üîí –ó–∞–∫—Ä–µ–ø–∏—Ç—å –æ—Ñ–ª–∞–π–Ω';
  on(lockItem, 'click', (e) => {
    e.stopPropagation();
    closeActiveMenu();
    if (typeof onAddLock === 'function') onAddLock();
  });
  menu.appendChild(lockItem);

  const removeItem = document.createElement('div');
  removeItem.className = 'cloud-ctx-menu-item';
  removeItem.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞';
  on(removeItem, 'click', (e) => {
    e.stopPropagation();
    closeActiveMenu();
    if (typeof onRemoveCache === 'function') onRemoveCache();
  });
  menu.appendChild(removeItem);

  document.body.appendChild(menu);

  const rect = root.getBoundingClientRect();
  let top = rect.bottom + 4;
  let left = rect.left;

  if (left + menu.offsetWidth > window.innerWidth) {
    left = window.innerWidth - menu.offsetWidth - 8;
  }
  if (top + menu.offsetHeight > window.innerHeight) {
    top = rect.top - menu.offsetHeight - 4;
  }

  menu.style.top = `${top}px`;
  menu.style.left = `${left}px`;

  activeMenu = menu;

  defer(() => {
    // capture=true —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è —Ä–∞–Ω—å—à–µ –¥—Ä—É–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
    offDocClick = on(document, 'click', onDocClick, true);
  });
}

//=================================================
// FILE: /scripts/ui/favorites-view.js
// scripts/ui/favorites-view.js
// FavoritesView: —á–∏—Å—Ç—ã–π —Ä–µ–Ω–¥–µ—Ä + –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –¥–ª—è –æ–∫–Ω–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª.
// –ù–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º –Ω–∞–ø—Ä—è–º—É—é (–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç).

const STAR_ON = 'img/star.png';
const STAR_OFF = 'img/star2.png';

const esc = (s) => {
  const fn = window.Utils?.escapeHtml;
  return typeof fn === 'function' ? fn(String(s ?? '')) : String(s ?? '');
};

function rowIdFromItem(it) {
  // back-compat: e2e –æ–∂–∏–¥–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç fav_{albumKey}_{uid}
  const a = String(it?.__a || '').trim();
  const u = String(it?.__uid || '').trim();
  return `fav_${a}_${u}`;
}

export function renderFavoritesEmpty(container) {
  if (!container) return;
  container.innerHTML = `
    <div class="fav-empty">
      <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏</h3>
      <p>–û—Ç–º–µ—Ç—å—Ç–µ —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π ‚≠ê</p>
    </div>
  `;
}

export function renderFavoritesList(container, model) {
  if (!container) return;

  const list = Array.isArray(model) ? model : [];
  if (!list.length) return renderFavoritesEmpty(container);

  container.innerHTML = list.map((it, i) => {
    const a = String(it?.__a || '').trim();
    const u = String(it?.__uid || '').trim();
    const active = !!it?.__active;

    const albumTitle = String(it?.__album || '–ê–ª—å–±–æ–º');
    const trackTitle = String(it?.title || '–¢—Ä–µ–∫');

    const id = rowIdFromItem(it);

    return `
      <div class="track${active ? '' : ' inactive'}"
           id="${esc(id)}"
           data-index="${i}"
           data-album="${esc(a)}"
           data-uid="${esc(u)}">
        <div class="tnum">${String(i + 1).padStart(2, '0')}.</div>
        <div class="track-title" title="${esc(trackTitle)} - ${esc(albumTitle)}">
          <span class="fav-track-name">${esc(trackTitle)}</span>
          <span class="fav-album-name"> ‚Äî ${esc(albumTitle)}</span>
        </div>
        <img src="${active ? STAR_ON : STAR_OFF}"
             class="like-star"
             alt="–∑–≤–µ–∑–¥–∞"
             data-album="${esc(a)}"
             data-uid="${esc(u)}">
      </div>
    `;
  }).join('');
}

/**
 * bindFavoritesList(container, handlers)
 * handlers:
 * - getModel(): any[]
 * - onStarClick({ uid, albumKey }): void
 * - onActiveRowClick({ uid, albumKey }): void
 * - onInactiveRowClick({ uid, title }): void
 */
export function bindFavoritesList(container, handlers) {
  if (!container || container.__favBound) return;
  container.__favBound = true;

  const getModel = typeof handlers?.getModel === 'function' ? handlers.getModel : () => [];
  const onStarClick = typeof handlers?.onStarClick === 'function' ? handlers.onStarClick : () => {};
  const onActiveRowClick = typeof handlers?.onActiveRowClick === 'function' ? handlers.onActiveRowClick : () => {};
  const onInactiveRowClick = typeof handlers?.onInactiveRowClick === 'function' ? handlers.onInactiveRowClick : () => {};

  container.addEventListener('click', (e) => {
    const target = e.target;
    const row = target?.closest?.('.track');
    if (!row || !container.contains(row)) return;

    const uid = String(row.dataset.uid || '').trim();
    const albumKey = String(row.dataset.album || '').trim();
    if (!uid || !albumKey) return;

    const model = getModel();
    const item = Array.isArray(model)
      ? model.find((it) => String(it?.__uid || '').trim() === uid && String(it?.__a || '').trim() === albumKey)
      : null;

    if (!item) return;

    if (target?.classList?.contains('like-star')) {
      e.preventDefault();
      e.stopPropagation();
      onStarClick({ uid, albumKey });
      return;
    }

    if (item.__active && item.audio) {
      onActiveRowClick({ uid, albumKey });
      return;
    }

    onInactiveRowClick({ uid, title: String(item?.title || '–¢—Ä–µ–∫') });
  });
}

//=================================================
// FILE: /scripts/ui/favorites.js
// scripts/ui/favorites.js
(function (W) {
  'use strict';

  const FAV = W.SPECIAL_FAVORITES_KEY || '__favorites__';
  const LOGO = 'img/logo.png';
  const U = W.Utils;
  const trim = (v) => U.obj.trim(v);

  const getGlobalAlbumTitle = (key) => {
    if (!key || !W.albumsIndex) return null;
    const found = W.albumsIndex.find(a => a.key === key);
    return found ? found.title : null;
  };

  const buildFavoritesRefsModel = async () => {
    const pc = W.playerCore;
    if (!pc?.getFavoritesState) return (W.favoritesRefsModel = []);

    const st = pc.getFavoritesState();
    // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–ø–∏—Å–∫–∏, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∏ —Å–µ—Ä—ã–µ —Ç—Ä–µ–∫–∏
    const rawItems = [...(st.active || []), ...(st.inactive || [])];

    W.favoritesRefsModel = rawItems.map((item) => {
      const uid = trim(item.uid);
      const meta = W.TrackRegistry?.getTrackByUid(uid);
      const isActive = pc.isFavorite(uid);
      
      const albumKey = trim(meta?.sourceAlbum || item.sourceAlbum);

      if (!meta) {
        return { __uid: uid, title: '–ó–∞–≥—Ä—É–∑–∫–∞...', __active: false, isGhost: true };
      }

      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞
      let albumTitle = meta.album;
      if (!albumTitle || albumTitle === '–ê–ª—å–±–æ–º') {
         albumTitle = getGlobalAlbumTitle(albumKey) || '–ê–ª—å–±–æ–º';
      }

      return {
        ...meta, 
        __uid: uid,
        __a: albumKey,
        __album: albumTitle, 
        __active: isActive,
        __cover: meta.cover || LOGO,
        audio: isActive ? meta.src : null 
      };
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É (–ø–æ addedAt, –µ—Å–ª–∏ –µ—Å—Ç—å –≤ item, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –æ—Ç getFavoritesState)
    return W.favoritesRefsModel;
  };

  const init = () => {
    if (W.__favoritesUIBound) return;
    W.__favoritesUIBound = true;
    const bind = () => {
      if (W.playerCore?.onFavoritesChanged) {
        W.playerCore.onFavoritesChanged(() => {
          if (W.AlbumsManager?.getCurrentAlbum?.() === FAV) {
            buildFavoritesRefsModel().catch(console.error);
          }
        });
      } else { setTimeout(bind, 100); }
    };
    bind();
  };

  W.FavoritesUI = {
    buildFavoritesRefsModel,
    getModel: () => W.favoritesRefsModel || [],
    getActiveModel: (m) => (m || W.FavoritesUI.getModel()).filter(it => it && it.__active && !it.isGhost),
  };
  
  W.buildFavoritesRefsModel = buildFavoritesRefsModel;
  init();
})(window);

//=================================================
// FILE: /scripts/ui/lyrics-modal.js
// scripts/ui/lyrics-modal.js
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø–µ—Å–Ω–∏

(function LyricsModalModule() {
  'use strict';

  const w = window;

  function showFullLyricsModal() {
    const track = w.playerCore?.getCurrentTrack();
    if (!track) {
      w.NotificationSystem?.warning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞');
      return;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
    const fulltext = track.fulltext;
    
    if (fulltext) {
      loadFulltextAndShow(fulltext, track);
    } else {
      showLyricsFromTimeline(track);
    }
  }

  async function loadFulltextAndShow(url, track) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to load fulltext');
      
      const text = await response.text();
      showModal(track, text);
      
    } catch (error) {
      console.error('Failed to load fulltext:', error);
      w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏');
    }
  }

  function showLyricsFromTimeline(track) {
    // N2: –ë–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
    const c = w.LyricsController;
    if (!c) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π –æ–±—ä–µ–∫—Ç—ã { line: string }
    const rawLines = (typeof c.getCurrentLyricsLines === 'function') ? c.getCurrentLyricsLines() : [];

    if (!rawLines.length) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    const lines = rawLines
      .map(item => (typeof item.line === 'string' ? item.line : ''))
      .filter(Boolean);

    if (!lines.length) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    const text = lines.join('\n');
    showModal(track, text);
  }

  function showModal(track, text) {
    const esc = w.Utils?.escapeHtml
      ? (s) => w.Utils.escapeHtml(String(s || ''))
      : (s) => String(s || '');

    const bodyHtml = `
      <div class="lyrics-modal" style="max-height: 80vh;">
        <h2 style="margin: 0 0 8px 0;">${esc(track.title)}</h2>
        <div style="color: #8ab8fd; margin-bottom: 16px; font-size: 14px;">
          ${esc(track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞')} ¬∑ ${esc(track.album || '')}
        </div>

        <div class="lyrics-fulltext" style="
          max-height: 50vh;
          overflow-y: auto;
          padding: 16px;
          background: rgba(0,0,0,0.2);
          border-radius: 10px;
          line-height: 1.8;
          white-space: pre-wrap;
          font-size: 15px;
          scrollbar-width: thin;
          scrollbar-color: rgba(77,170,255,0.3) transparent;
        ">${esc(text)}</div>

        <div style="display:flex; gap:10px; margin-top:16px; justify-content:center; flex-wrap:wrap;">
          <button class="modal-action-btn" id="copy-lyrics-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="modal-action-btn" id="share-lyrics-btn">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
      </div>
    `;

    if (!w.Modals?.open) {
      w.NotificationSystem?.error('Modals helper –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
      return;
    }

    const modal = w.Modals.open({
      title: '–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏',
      maxWidth: 560,
      bodyHtml
    });

    modal.querySelector('#copy-lyrics-btn')?.addEventListener('click', () => copyLyrics(text, modal));
    modal.querySelector('#share-lyrics-btn')?.addEventListener('click', () => shareLyrics(track, text));
  }

  async function copyLyrics(text, modal) {
    try {
      await navigator.clipboard.writeText(text);
      w.NotificationSystem?.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
      modal.remove();
    } catch (error) {
      // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        w.NotificationSystem?.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
        modal.remove();
      } catch (e) {
        w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      }
      
      document.body.removeChild(textarea);
    }
  }

  async function shareLyrics(track, text) {
    const shareData = {
      title: track.title,
      text: `${track.title} - ${track.artist}\n\n${text}`
    };

    if (navigator.share) {
      try {
        await navigator.share(shareData);
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Share failed:', error);
        }
      }
    } else {
      w.NotificationSystem?.info('–§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
    }
  }

  // escapeHtml: –∏—Å–ø–æ–ª—å–∑—É–µ–º window.Utils.escapeHtml (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)

  // –ü—É–±–ª–∏—á–Ω—ã–π API
  w.LyricsModal = {
    show: showFullLyricsModal
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  // (Lyrics Modal –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞)

})();

//=================================================
// FILE: /scripts/ui/modal-templates.js
// scripts/ui/modal-templates.js
const U = window.Utils;
const esc = (s) => U?.escapeHtml ? U.escapeHtml(String(s ?? '')) : String(s ?? '');
const attr = (k, v) => v ? ` ${k}` : '';

export const ModalTemplates = {
  offlineBody: (s = {}) => {
    const { mode='R0', cq='hi', foq='hi', cloud={n:5,d:31}, bd={}, qst={}, isSpaceOk=true } = s;
    const fmtBytes = (b) => U?.fmt?.bytes ? U.fmt.bytes(b) : `${(b/1048576).toFixed(1)} MB`;
    const n = (v) => Number(v) || 0;
    const btn = (id, txt, cls='') => `<button class="offline-btn ${cls}" id="${id}">${esc(txt)}</button>`;
    const section = (title, content) => `<section class="om-card"><div class="om-card__title">${esc(title)}</div><div class="om-card__body">${content}</div></section>`;
    const kv = (label, valId, val) => `<div class="om-kv-row"><span>${label}:</span> <b id="${valId}">${val}</b></div>`;
    const isR3 = mode === 'R3';

    // Album list for Full Offline
    const albums = window.albumsIndex || [];
    const albumsHtml = albums.map(a => 
        `<label class="om-row om-row--tight"><input type="checkbox" class="om-check full-album-check" value="${a.key}"> ${esc(a.title)}</label>`
    ).join('');

    return `
      <div class="om-container">
        <div class="om-header-stat">
          <div>–†–µ–∂–∏–º: <b class="om-mode-badge">${mode}</b></div>
          <div>–û—á–µ—Ä–µ–¥—å: <b id="om-q-val">${qst.queued || 0}</b></div>
        </div>
        ${!isSpaceOk ? `<div class="om-alert om-alert--error">‚ö†Ô∏è –ú–∞–ª–æ –º–µ—Å—Ç–∞ (<60MB).</div>` : ''}

        ${section('A) –†–µ–∂–∏–º', `
          <div class="om-modes-list">
            <label class="om-radio-row ${isR3 ? 'disabled' : ''}"><input type="radio" name="om-mode" value="R0" ${attr('checked', mode==='R0')} ${attr('disabled', isR3)}> <strong>R0 Streaming</strong></label>
            <label class="om-radio-row ${(!isSpaceOk||isR3) ? 'disabled' : ''}"><input type="radio" name="om-mode" value="R1" ${attr('checked', mode==='R1')} ${attr('disabled', !isSpaceOk||isR3)}> <strong>R1 PlaybackCache</strong></label>
            <label class="om-radio-row ${(!isSpaceOk||isR3) ? 'disabled' : ''}"><input type="radio" name="om-mode" value="R2" ${attr('checked', mode==='R2')} ${attr('disabled', !isSpaceOk||isR3)}> <strong>R2 Dynamic</strong></label>
            <div class="om-r3-info ${isR3 ? 'active' : ''}"><strong>R3 100% OFFLINE</strong> ${isR3 ? '–í–ö–õ–Æ–ß–ï–ù' : '(—Å–º. —Å–µ–∫—Ü–∏—é I)'}</div>
          </div>
        `)}

        ${!isR3 ? section('B) –ö–∞—á–µ—Å—Ç–≤–æ (CQ)', `
          <div class="om-inline-controls">
            <select id="om-cq" class="om-select"><option value="hi" ${attr('selected', cq==='hi')}>Hi</option><option value="lo" ${attr('selected', cq==='lo')}>Lo</option></select>
            ${btn('om-save-cq', '–ü—Ä–∏–º–µ–Ω–∏—Ç—å')}
          </div>
        `) : ''}

        ${!isR3 ? section('C) –û–±–ª–∞—á–∫–æ', `
          <div class="om-inline-inputs"><label>N: <input type="number" id="om-cloud-n" value="${n(cloud.n)}" style="width:50px"></label><label>D: <input type="number" id="om-cloud-d" value="${n(cloud.d)}" style="width:50px"></label>${btn('om-save-cloud', 'OK')}</div>
        `) : ''}

        ${section('E) –•—Ä–∞–Ω–∏–ª–∏—â–µ', `
          <div class="om-breakdown">
            ${kv('Pinned', 'om-bd-pinned', fmtBytes(bd.pinnedBytes))}
            ${kv('Cloud', 'om-bd-cloud', fmtBytes(bd.cloudBytes))}
            ${kv('Dynamic', 'om-bd-dynamic', fmtBytes(bd.dynamicBytes))}
            ${kv('Window', 'om-bd-win', fmtBytes(bd.transientWindowBytes))}
            ${kv('100% Offline', 'om-bd-full', fmtBytes(bd.fullOfflineBytes))}
            <div class="om-kv-total">–í—Å–µ–≥–æ: <b>${fmtBytes(bd.audioTotalBytes)}</b></div>
          </div>
          <div class="om-storage-actions">${btn('om-clear-cache', '–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à', 'om-btn-danger')}</div>
        `)}

        ${section('I) 100% OFFLINE (R3)', `
          <div class="om-full-offline-ui">
            ${isR3 ? `
               <div class="om-success-box">–†–µ–∂–∏–º R3 –∞–∫—Ç–∏–≤–µ–Ω. –°–µ—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∞.</div>
               ${btn('om-stop-r3', '–í—ã–∫–ª—é—á–∏—Ç—å R3 (–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –û–Ω–ª–∞–π–Ω)', 'om-btn-warning')}
            ` : `
               <div class="om-full-select">
                 <label><input type="checkbox" id="om-full-fav" checked> –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</label>
                 <div class="om-albums">${albumsHtml}</div>
               </div>
               <div class="om-inline-controls">
                 <span>–ö–∞—á–µ—Å—Ç–≤–æ:</span>
                 <select id="om-foq" class="om-select"><option value="hi" ${attr('selected', foq==='hi')}>Hi</option><option value="lo" ${attr('selected', foq==='lo')}>Lo</option></select>
               </div>
               <div class="om-full-actions">${btn('om-est-full', '–û—Ü–µ–Ω–∏—Ç—å')} ${btn('om-start-full', '–°–∫–∞—á–∞—Ç—å –Ω–∞–±–æ—Ä', 'om-btn-success')}</div>
               <div id="om-est-result" class="om-est-result"></div>
               <p class="om-hint">R3 –≤–∫–ª—é—á–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 100% –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤–∞—à–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
            `}
          </div>
        `)}
      </div>
    `;
  },

  statsBody: (data) => {
    const U = window.Utils;
    const fmtDur = (s) => {
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        return h > 0 ? `${h}—á ${m}–º` : `${m} –º–∏–Ω`;
    };

    const rows = data.tracks.map((t, i) => `
      <div class="st-row">
        <span class="st-num">${i + 1}.</span>
        <span class="st-uid">${t.title || t.uid}</span>
        <span class="st-vals">${t.fullListens} –ø—Ä–æ—Å–ª. / ${fmtDur(t.seconds)}</span>
      </div>
    `).join('');

    return `
      <div class="st-container">
        <div class="st-total">
          <div>–í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: <b>${fmtDur(data.totalSeconds)}</b></div>
          <div>–ü–æ–ª–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π: <b>${data.totalFullListens}</b></div>
        </div>
        <div class="st-list-header">–¢–æ–ø —Ç—Ä–µ–∫–æ–≤ (>3 –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π):</div>
        <div class="st-list">
          ${rows || '<div class="st-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}
        </div>
        <div class="st-note">–≠—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (Global) –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è.</div>
      </div>
    `;
  }
};

//=================================================
// FILE: /scripts/ui/modals.js
// scripts/ui/modals.js
// –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π helper –¥–ª—è window.Modals.
// –ù—É–∂–µ–Ω –¥–ª—è offline-modal.js, navigation.js, lyrics-modal.js, sysinfo.js, favorites-data.js.
// –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç: –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.

(function () {
  'use strict';

  const U = window.Utils;

  const esc = (s) => {
    const fn = U?.escapeHtml;
    return typeof fn === 'function' ? fn(String(s ?? '')) : String(s ?? '');
  };

  function ensureContainer() {
    let c = document.getElementById('modals-container');
    if (!c) {
      c = document.createElement('div');
      c.id = 'modals-container';
      document.body.appendChild(c);
    }
    return c;
  }

  function open(opts = {}) {
    const title = String(opts.title || '');
    const bodyHtml = String(opts.bodyHtml || '');
    const maxWidth = Number(opts.maxWidth || 520) || 520;

    const bg = document.createElement('div');
    bg.className = 'modal-bg active';

    const box = document.createElement('div');
    box.className = 'modal-feedback';
    box.style.maxWidth = `${maxWidth}px`;

    box.innerHTML = `
      <button class="bigclose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.42L12 13.41l4.89 4.9a1 1 0 0 0 1.42-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4z"/>
        </svg>
      </button>
      ${title ? `<h2>${esc(title)}</h2>` : ''}
      <div class="modal-body">${bodyHtml}</div>
    `;

    bg.appendChild(box);
    ensureContainer().appendChild(bg);

    const close = () => {
      try { opts.onClose?.(); } catch {}
      try { bg.remove(); } catch {}
    };

    bg.addEventListener('click', (e) => {
      if (e.target === bg) close();
    });

    box.querySelector('.bigclose')?.addEventListener('click', close);

    // ESC
    const onKey = (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        window.removeEventListener('keydown', onKey);
        close();
      }
    };
    window.addEventListener('keydown', onKey);

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ (–∫–∞–∫ —É —Ç–µ–±—è –æ–∂–∏–¥–∞–µ—Ç—Å—è)
    bg.remove = ((orig) => () => {
      window.removeEventListener('keydown', onKey);
      orig.call(bg);
    })(bg.remove);

    return bg;
  }

  function actionRow(actions = []) {
    const arr = Array.isArray(actions) ? actions : [];
    return `
      <div class="om-actions">
        ${arr.map((a) => {
          const act = esc(a?.act || '');
          const text = esc(a?.text || '');
          const cls = esc(a?.className || '');
          const style = esc(a?.style || '');
          return `<button type="button" class="modal-action-btn ${cls}" data-act="${act}" style="${style}">${text}</button>`;
        }).join('')}
      </div>
    `;
  }

  function confirm(opts = {}) {
    const title = String(opts.title || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ');
    const textHtml = String(opts.textHtml || '');
    const confirmText = String(opts.confirmText || '–û–∫');
    const cancelText = String(opts.cancelText || '–û—Ç–º–µ–Ω–∞');

    const modal = open({
      title,
      maxWidth: Number(opts.maxWidth || 460) || 460,
      bodyHtml: `
        <div style="color:#9db7dd; line-height:1.45; margin-bottom:14px;">
          ${textHtml}
        </div>
        ${actionRow([
          { act: 'cancel', text: cancelText, className: '', style: 'min-width:130px;' },
          { act: 'confirm', text: confirmText, className: 'online', style: 'min-width:130px;' }
        ])}
      `,
      onClose: opts.onClose
    });

    modal.querySelector('[data-act="cancel"]')?.addEventListener('click', () => {
      try { opts.onCancel?.(); } catch {}
      try { modal.remove(); } catch {}
    });

    modal.querySelector('[data-act="confirm"]')?.addEventListener('click', () => {
      try { opts.onConfirm?.(); } catch {}
      try { modal.remove(); } catch {}
    });

    return modal;
  }

  window.Modals = window.Modals || {};
  window.Modals.open = open;
  window.Modals.confirm = confirm;
  window.Modals.actionRow = actionRow;

  // bridge: offlineBody –±–µ—Ä—ë–º –∏–∑ ModalTemplates, –µ—Å–ª–∏ –µ—Å—Ç—å
  Object.defineProperty(window.Modals, 'offlineBody', {
    configurable: true,
    get() {
      const fn = window.ModalTemplates?.offlineBody;
      return (typeof fn === 'function') ? fn : null;
    }
  });
})();

//=================================================
// FILE: /scripts/ui/news-inline.js
// scripts/ui/news-inline.js
// –†–µ–Ω–¥–µ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π –≤–Ω—É—Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∞–ª—å–±–æ–º __reliz__).
// –¢–æ–ª—å–∫–æ UI/fetch, –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.

const esc = (s) => {
  const fn = window.Utils?.escapeHtml;
  return typeof fn === 'function' ? fn(String(s ?? '')) : String(s ?? '');
};

function renderCard(it) {
  const title = esc(it?.title || '–ù–æ–≤–æ—Å—Ç—å');
  const date = esc(it?.date || '');
  const text = esc(it?.text || '');
  const tags = Array.isArray(it?.tags) ? it.tags : [];

  const media = it?.embedUrl
    ? `<div class="news-inline__media"><iframe loading="lazy" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`
    : it?.image
      ? `<div class="news-inline__media"><img loading="lazy" src="${esc(it.image)}" alt=""></div>`
      : it?.video
        ? `<div class="news-inline__media"><video controls preload="metadata" src="${esc(it.video)}"></video></div>`
        : '';

  const tagHtml = tags.length
    ? `<div class="news-inline__tags">${tags.map((t) => `<span class="news-inline__tag">#${esc(t)}</span>`).join('')}</div>`
    : '';

  return `
    <article class="news-inline__card">
      <div class="news-inline__title">${title}</div>
      ${date ? `<div class="news-inline__date">${date}</div>` : ''}
      ${media}
      ${text ? `<div class="news-inline__text">${text}</div>` : ''}
      ${tagHtml}
    </article>
  `;
}

export function renderNewsInlineSkeleton(container) {
  if (!container) return;

  container.innerHTML = `
    <div class="news-inline__head">
      <div class="news-inline__links">
        <a href="https://t.me/vitrina_razbita" target="_blank" rel="noopener noreferrer">Telegram –∫–∞–Ω–∞–ª</a>
        <span class="news-inline__dot">¬∑</span>
        <a href="./news.html" target="_blank" rel="noopener noreferrer">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</a>
      </div>
      <div id="news-inline-status" class="news-inline__status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div id="news-inline-list" class="news-inline__list"></div>
  `;
}

export async function loadAndRenderNewsInline(container) {
  if (!container) return;

  renderNewsInlineSkeleton(container);

  const status = container.querySelector('#news-inline-status');
  const list = container.querySelector('#news-inline-list');
  if (!list) return;

  try {
    const r = await fetch('./news/news.json', { cache: 'no-cache' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);

    const j = await r.json();
    const items = Array.isArray(j?.items) ? j.items : [];

    if (!items.length) {
      if (status) status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
      return;
    }

    if (status) status.style.display = 'none';
    list.innerHTML = items.map(renderCard).join('');
  } catch {
    if (status) {
      status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
      status.classList.add('news-inline__status--error');
    }
  }
}

//=================================================
// FILE: /scripts/ui/notify.js
//=================================================
// FILE: /scripts/ui/notify.js
class NotificationSystem {
  constructor() {
    this.container = null;
    this.queue = [];
    this.isShowing = false;
    this.U = window.Utils;
    this.init();
  }
  init() {
    this.container = document.createElement('div');
    this.container.id = 'toast-container';
    this.container.style.cssText = `position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:10000;pointer-events:none`;
    document.body.appendChild(this.container);
  }
  show(message, type = 'info', duration = 3000) {
    this.queue.push({ message, type, duration, id: Date.now() });
    this.processQueue();
  }
  processQueue() {
    if (this.isShowing || this.queue.length === 0) return;
    this.isShowing = true;
    this.displayToast(this.queue.shift());
  }
  displayToast(toast) {
    const el = document.createElement('div');
    el.className = `toast toast-${toast.type}`;
    el.innerHTML = `<div class="toast-content"><span class="toast-emoji">${this.getEmoji(toast.type)}</span><span class="toast-message">${this.U.ui.escapeHtml(toast.message)}</span></div>`;
    this.container.appendChild(el);
    this.U.dom.raf(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => { if(el.parentNode) el.parentNode.removeChild(el); this.isShowing = false; this.processQueue(); }, 300);
    }, toast.duration);
  }
  getEmoji(type) { return { info: '‚ÑπÔ∏è', success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', offline: 'üì¥' }[type] || '‚ÑπÔ∏è'; }
  // Aliases
  info(m, d) { this.show(m, 'info', d); }
  success(m, d) { this.show(m, 'success', d); }
  error(m, d) { this.show(m, 'error', d); }
  warning(m, d) { this.show(m, 'warning', d); }
  offline(m, d) { this.show(m, 'offline', d); }
}
window.NotificationSystem = new NotificationSystem();

//=================================================
// FILE: /scripts/ui/offline-indicators.js
// scripts/ui/offline-indicators.js
import { attachCloudMenu } from './cloud-menu.js';
import { deleteTrackCache, clearCloudStats } from '../offline/cache-db.js';

const CSS = `.offline-ico-slot{display:inline-flex;align-items:center;margin-right:6px;min-width:14px}.offline-ico{cursor:pointer;user-select:none;font-size:14px;line-height:1}.offline-ico.gray{opacity:.3;filter:grayscale(1)}.offline-ico.lock{color:#ffd166}.offline-ico.cloud{color:#8ab8fd}`;

let _tm = null;
const getMgr = () => window.OfflineUI?.offlineManager;
const notify = (m, t='info') => window.NotificationSystem?.[t]?.(m);

const getUid = (el) => {
  const ds = el.dataset.uid;
  if (ds) return ds;
  const m = el.id?.match(/^fav_[^_]+_(.+)$/);
  return m ? m[1] : (el.querySelector('.like-star')?.dataset?.uid || null);
};

const getHtml = (s, uid) => {
  if (!uid || !s) return `<span class="offline-ico gray" title="–ó–∞–≥—Ä—É–∑–∫–∞...">üîí</span>`;
  if (s.pinned) return `<span class="offline-ico lock" title="–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –æ—Ñ–ª–∞–π–Ω" data-act="unpin" data-uid="${uid}">üîí</span>`;
  if (s.cloud && s.cachedComplete) return `<span class="offline-ico cloud" title="–î–æ—Å—Ç—É–ø–Ω–æ –æ—Ñ–ª–∞–π–Ω (Cloud)" data-act="menu" data-uid="${uid}">‚òÅ</span>`;
  return `<span class="offline-ico gray" title="–ó–∞–∫—Ä–µ–ø–∏—Ç—å –æ—Ñ–ª–∞–π–Ω" data-act="pin" data-uid="${uid}">üîí</span>`;
};

async function updateRow(row) {
  const uid = getUid(row);
  if (!uid) return;
  const mgr = getMgr();
  const state = mgr ? await mgr.getTrackOfflineState(uid) : null;
  
  let slot = row.querySelector('.offline-ico-slot');
  if (!slot) {
    slot = document.createElement('span');
    slot.className = 'offline-ico-slot';
    const ref = row.querySelector('.tnum') || row.firstChild;
    row.insertBefore(slot, ref);
  }
  const html = getHtml(state, uid);
  if (slot.innerHTML !== html) slot.innerHTML = html;
}

function scheduleRefresh() {
  if (_tm) return;
  _tm = requestAnimationFrame(() => {
    _tm = null;
    const rows = document.querySelectorAll('.track');
    for (let i = 0; i < rows.length; i++) updateRow(rows[i]);
  });
}

function handleGlobalClick(e) {
  const t = e.target;
  if (!t.classList.contains('offline-ico')) return;
  
  e.preventDefault(); e.stopPropagation();
  const act = t.dataset.act;
  const uid = t.dataset.uid;
  const mgr = getMgr();
  
  if (!mgr || !uid || !act) return;

  if (act === 'pin' || act === 'unpin') {
    mgr.togglePinned(uid).then(scheduleRefresh);
  } else if (act === 'menu') {
    attachCloudMenu({
      root: t,
      onAddLock: () => mgr.togglePinned(uid).then(scheduleRefresh),
      onRemoveCache: async () => {
        await deleteTrackCache(uid);
        await clearCloudStats(uid);
        notify('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∫—ç—à–∞');
        scheduleRefresh();
      }
    });
  }
}

export function attachOfflineIndicators() {
  if (window.__offIndInit) return;
  window.__offIndInit = true;
  const s = document.createElement('style');
  s.textContent = CSS;
  document.head.appendChild(s);
  document.addEventListener('click', handleGlobalClick, true);
  const obs = new MutationObserver(scheduleRefresh);
  const list = document.getElementById('track-list');
  if (list) obs.observe(list, { childList: true, subtree: true });
  window.addEventListener('offline:uiChanged', scheduleRefresh);
  const mgr = getMgr();
  if (mgr?.on) mgr.on('progress', scheduleRefresh);
  scheduleRefresh();
}

//=================================================
// FILE: /scripts/ui/offline-modal.js
// scripts/ui/offline-modal.js
import { ModalTemplates } from './modal-templates.js';
import { getOfflineManager } from '../offline/offline-manager.js';
import { Favorites } from '../core/favorites-manager.js';
import { getAllTracks } from '../app/track-registry.js';

const U = window.Utils;
let modalEl = null;

// FIX NC-5: Listen for Full Offline Ready
window.addEventListener('offline:fullOfflineReady', () => {
    if (window.Modals?.confirm) {
        window.Modals.confirm({
            title: '100% OFFLINE –≥–æ—Ç–æ–≤',
            textHtml: '–í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.<br>–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Å–µ–π—á–∞—Å?',
            confirmText: '–í–∫–ª—é—á–∏—Ç—å',
            cancelText: '–ü–æ–∑–∂–µ',
            onConfirm: () => getOfflineManager().setMode('R3')
        });
    }
});

async function collectState() {
  const mgr = getOfflineManager();
  const [bd, mode, cq, foq, qst, cloud, isSpaceOk] = await Promise.all([
    mgr.computeCacheBreakdown(),
    Promise.resolve(mgr.getMode()),
    Promise.resolve(mgr.getCacheQuality()),
    Promise.resolve(mgr.getFullOfflineQuality()),
    Promise.resolve(mgr.getQueueStatus()),
    Promise.resolve(mgr.getCloudSettings()),
    mgr.isSpaceOk()
  ]);
  return { bd, mode, cq, foq, qst, cloud, isSpaceOk };
}

export async function openOfflineModal() {
  if (!window.Modals?.open) return;
  const state = await collectState();
  
  // FIX NC-9: Inject Track List HTML into template (simplified for now)
  // Or handle inside template. The template provided in step 4 had album list.
  // We can stick to albums for v1.0 or expand.
  
  modalEl = window.Modals.open({
    title: 'OFFLINE',
    maxWidth: 500,
    bodyHtml: ModalTemplates.offlineBody(state),
    onClose: () => { modalEl = null; }
  });
  bindEvents(modalEl, state);
}

function bindEvents(root, state) {
  const mgr = getOfflineManager();
  const $ = (sel) => root.querySelector(sel);
  const $$ = (sel) => root.querySelectorAll(sel);
  const close = () => { try { root.remove(); } catch{} };

  $$('input[name="om-mode"]').forEach(el => {
    el.addEventListener('change', async () => {
      const newMode = el.value;
      if (newMode === state.mode) return;
      if (newMode !== 'R0' && !state.isSpaceOk) {
         el.checked = false;
         $(`input[value="${state.mode}"]`).checked = true;
         U.ui.toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞', 'error');
         return;
      }
      await mgr.setMode(newMode);
      close();
      U.ui.toast(`–†–µ–∂–∏–º: ${newMode}`);
    });
  });

  $('#om-save-cq')?.addEventListener('click', () => {
    mgr.setCacheQuality($('#om-cq').value);
    close();
    U.ui.toast('–ö–∞—á–µ—Å—Ç–≤–æ –∫—ç—à–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
  });

  $('#om-clear-cache')?.addEventListener('click', async () => {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–ï–°–¨ –∫—ç—à?')) return;
    await mgr.clearAllCache();
    close();
    U.ui.toast('–ö—ç—à –æ—á–∏—â–µ–Ω');
    setTimeout(() => window.location.reload(), 1000);
  });

  const getSelectedUids = () => {
    const uids = new Set();
    if ($('#om-full-fav')?.checked) {
       Favorites.getSnapshot().filter(x => !x.inactiveAt).forEach(x => uids.add(x.uid));
    }
    $$('.full-album-check:checked').forEach(cb => {
       const key = cb.value;
       getAllTracks().filter(t => t.sourceAlbum === key).forEach(t => uids.add(t.uid));
    });
    return Array.from(uids);
  };

  $('#om-stop-r3')?.addEventListener('click', () => {
     mgr.setMode('R0');
     close();
     U.ui.toast('R3 –≤—ã–∫–ª—é—á–µ–Ω. –û–Ω–ª–∞–π–Ω.');
  });

  $('#om-foq')?.addEventListener('change', (e) => mgr.setFullOfflineQuality(e.target.value));

  $('#om-est-full')?.addEventListener('click', () => {
    const list = getSelectedUids();
    const mb = list.length * ($('#om-foq').value === 'hi' ? 6 : 2.5); 
    $('#om-est-result').innerHTML = `–¢—Ä–µ–∫–æ–≤: <b>${list.length}</b><br>~${mb.toFixed(0)} MB`;
  });

  $('#om-start-full')?.addEventListener('click', async () => {
    if (!state.isSpaceOk) { alert('–ú–∞–ª–æ –º–µ—Å—Ç–∞!'); return; }
    const list = getSelectedUids();
    if (!list.length) { alert('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ'); return; }
    
    const res = await mgr.startFullOffline(list);
    close();
    
    if (res.ok) {
        U.ui.toast(`–ó–∞–≥—Ä—É–∑–∫–∞ ${list.length} —Ç—Ä–µ–∫–æ–≤...`);
    }
  });
}

//=================================================
// FILE: /scripts/ui/sleep.js
//=================================================
// FILE: /scripts/ui/sleep.js
// –¢–∞–π–º–µ—Ä —Å–Ω–∞: –í–µ—Ä—Å–∏—è —Å –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–æ–±—ã—Ç–∏–π (Fix dynamic UI)
// –õ–æ–≥–∏–∫–∞: –ø–∞—É–∑–∞ —á–µ—Ä–µ–∑ PlayerCore. UI: 15/30/60 –º–∏–Ω –∏–ª–∏ HH:MM.
(function () {
  'use strict';

  const W = window, U = W.Utils, LS = 'sleepTimerTarget';
  const $ = (id) => document.getElementById(id);
  const now = () => Date.now();
  const pad = (n) => String(n).padStart(2, '0');
  
  // State
  let menu = null, tickId = null;

  // --- Helpers ---
  const getTs = () => {
    const pc = W.playerCore?.getSleepTimerTarget?.();
    return (pc && pc > 0) ? pc : parseInt(U.lsGet(LS, '0') || '0', 10);
  };

  const fmtRem = (ms) => {
    const m = Math.ceil(ms / 60000);
    return m < 60 ? `${m}–º` : `${Math.floor(m / 60)}—á ${m % 60}–º`;
  };

  const fmtTime = (ts) => { const d = new Date(ts); return `${pad(d.getHours())}:${pad(d.getMinutes())}`; };

  const updateBadge = () => {
    const el = $('sleep-timer-badge'), ts = getTs(), ms = ts - now();
    if (!el) return;
    if (ts > 0 && ms > 0) {
      el.style.display = '';
      el.textContent = Math.ceil(ms / 60000);
      if (!tickId) tickId = setInterval(updateBadge, 10000);
    } else {
      el.style.display = 'none';
      el.textContent = '';
      if (tickId) { clearInterval(tickId); tickId = null; }
      if (ts > 0 && ms <= 0) stop(true); // Auto-clear
    }
  };

  const set = (ts) => {
    if (!ts || ts <= now()) return;
    W.playerCore?.setSleepTimer?.(ts - now());
    U.lsSet(LS, ts);
    updateBadge();
  };

  const stop = (silent) => {
    W.playerCore?.clearSleepTimer?.();
    localStorage.removeItem(LS);
    updateBadge();
    if (!silent) W.NotificationSystem?.info?.('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω');
  };

  // --- UI: Menu ---
  const toggleMenu = (btn) => {
    if (menu) { menu.remove(); menu = null; return; }
    
    const ts = getTs(), act = ts > now();
    const rect = btn.getBoundingClientRect();
    
    menu = document.createElement('div');
    menu.className = 'sleep-menu';
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –≤—ã–ª–µ—Ç–∞ –∑–∞ —ç–∫—Ä–∞–Ω
    Object.assign(menu.style, { 
      position: 'fixed', 
      right: `${Math.max(8, W.innerWidth - rect.right)}px`, 
      bottom: `${Math.max(8, W.innerHeight - rect.top)}px`,
      zIndex: '10000'
    });
    
    menu.innerHTML = `
      ${act ? `<div class="sleep-menu-item active" data-a="noop">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω: ${fmtRem(ts - now())} (–¥–æ ${fmtTime(ts)})</div>` : ''}
      <div class="sleep-menu-item" data-a="off">–í—ã–∫–ª—é—á–∏—Ç—å</div>
      <div style="height:1px;background:rgba(255,255,255,.1);margin:6px 0"></div>
      ${[15, 30, 45, 60].map(m => `<div class="sleep-menu-item" data-a="m" data-v="${m}">${m} –º–∏–Ω</div>`).join('')}
      <div style="height:1px;background:rgba(255,255,255,.1);margin:6px 0"></div>
      <div class="sleep-menu-item" data-a="time">–ö –≤—Ä–µ–º–µ–Ω–∏‚Ä¶</div>
    `;

    // Global click to close
    setTimeout(() => {
        const outClick = (e) => { 
            if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
                cleanMenu(); 
            }
        };
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
        menu._outClick = outClick;
        document.addEventListener('click', outClick);
    }, 0);
    
    const cleanMenu = () => {
        if(menu?._outClick) document.removeEventListener('click', menu._outClick);
        if(menu) menu.remove();
        menu = null;
    };

    menu.addEventListener('click', (e) => {
      const t = e.target.closest('[data-a]');
      if (!t) return;
      e.stopPropagation();
      const a = t.dataset.a;
      
      if (a === 'off') stop();
      else if (a === 'm') {
        const m = parseInt(t.dataset.v);
        set(now() + m * 60000);
        W.NotificationSystem?.success?.(`‚è∞ –¢–∞–π–º–µ—Ä: ${m} –º–∏–Ω`);
      } else if (a === 'time') {
        cleanMenu(); 
        openTimeModal();
        return;
      }
      if (a !== 'noop') cleanMenu();
    });

    document.body.appendChild(menu);
  };

  // --- UI: Time Modal (HH:MM) ---
  const openTimeModal = () => {
    const wrap = document.createElement('div');
    wrap.className = 'sleep-time-modal-backdrop';
    const def = new Date(now() + 30 * 60000), h = pad(def.getHours()), m = pad(def.getMinutes());
    
    wrap.innerHTML = `
      <div class="sleep-time-modal">
        <div class="sleep-time-title">–¢–∞–π–º–µ—Ä –∫ –≤—Ä–µ–º–µ–Ω–∏</div>
        <div class="sleep-time-row">
          <input id="sh" type="tel" maxlength="2" placeholder="HH" class="sleep-time-input" value="${h}">
          <span class="sleep-time-sep">:</span>
          <input id="sm" type="tel" maxlength="2" placeholder="MM" class="sleep-time-input" value="${m}">
        </div>
        <div class="sleep-time-actions">
          <button class="sleep-time-btn" data-a="c">–û—Ç–º–µ–Ω–∞</button>
          <button class="sleep-time-btn primary" data-a="ok">–û–∫</button>
        </div>
      </div>`;

    const close = () => { wrap.remove(); document.removeEventListener('keydown', onKey); };
    const apply = () => {
      let hh = parseInt(wrap.querySelector('#sh').value || '0');
      let mm = parseInt(wrap.querySelector('#sm').value || '0');
      // Simple validation
      if(isNaN(hh)) hh=0; if(isNaN(mm)) mm=0;
      hh = Math.min(23, Math.max(0, hh));
      mm = Math.min(59, Math.max(0, mm));

      const d = new Date(); d.setHours(hh, mm, 0, 0);
      if (d.getTime() <= now()) d.setDate(d.getDate() + 1); // If time passed, set for tomorrow
      
      set(d.getTime());
      W.NotificationSystem?.success?.(`‚è∞ –¢–∞–π–º–µ—Ä –¥–æ ${pad(hh)}:${pad(mm)}`);
      close();
    };

    const onKey = (e) => { if(e.key==='Enter') apply(); if(e.key==='Escape') close(); };
    
    wrap.addEventListener('click', (e) => {
      if (e.target === wrap || e.target.dataset.a === 'c') close();
      if (e.target.dataset.a === 'ok') apply();
    });

    document.body.appendChild(wrap);
    document.addEventListener('keydown', onKey);
    setTimeout(() => wrap.querySelector('#sh').focus(), 50);
  };

  // --- Init & Delegation ---
  const init = () => {
    // 1. –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∫–ª–∏–∫–∞ (—Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –∫–Ω–æ–ø–∫–∏)
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('#sleep-timer-btn');
        if (btn) {
            e.stopPropagation();
            toggleMenu(btn);
        }
    });

    // 2. –°–≤—è–∑—å —Å PlayerCore (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)
    const bindCore = () => {
      if (W.playerCore?.on) {
        W.playerCore.on({ onSleepTriggered: () => stop() });
        const saved = parseInt(localStorage.getItem(LS)||'0');
        if (saved > now()) W.playerCore.setSleepTimer(saved - now());
        else if (saved) stop(true); // Expired while app was closed
        updateBadge();
      } else {
        setTimeout(bindCore, 200);
      }
    };
    bindCore();

    console.log('‚úÖ SleepTimer optimized (delegation fix)');
  };

  // Public API
  W.SleepTimer = { 
    show: () => $('sleep-timer-btn')?.click(), 
    updateBadge, 
    clearSleepTimer: () => stop(true) 
  };

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();

//=================================================
// FILE: /scripts/ui/statistics-modal.js
// scripts/ui/statistics-modal.js
import { getOfflineManager } from '../offline/offline-manager.js';

(function(W) {
  'use strict';

  const U = W.Utils;
  const esc = (s) => U.escapeHtml(String(s||''));
  const fmt = (s) => U.fmt.durationHuman(s);

  async function showStats() {
    if (!W.Modals?.open) return;

    const mgr = getOfflineManager();
    const stats = await mgr.getGlobalStatistics();
    
    // –§–∏–ª—å—Ç—Ä: —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ >= 3 –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π
    const relevant = (stats.tracks || []).filter(t => t.fullListens >= 3);
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
    relevant.sort((a, b) => b.seconds - a.seconds);

    const totalDays = (stats.totalSeconds / 86400).toFixed(1);
    const totalHours = Math.floor(stats.totalSeconds / 3600);

    const listHtml = relevant.length 
      ? relevant.map((t, i) => {
          const meta = W.TrackRegistry.getTrackByUid(t.uid);
          const title = meta ? `${meta.artist} ‚Äî ${meta.title}` : `UID: ${t.uid}`;
          return `
            <div class="stats-row">
              <div class="stats-rank">${i + 1}</div>
              <div class="stats-info">
                <div class="stats-title">${esc(title)}</div>
                <div class="stats-meta">üéß ${t.fullListens} ¬∑ ‚è± ${fmt(t.seconds)}</div>
              </div>
            </div>`;
        }).join('')
      : '<div class="stats-empty">–°–ª—É—à–∞–π—Ç–µ –±–æ–ª—å—à–µ –º—É–∑—ã–∫–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É!</div>';

    const body = `
      <div class="stats-modal">
        <div class="stats-header">
          <div class="stats-total-label">–í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:</div>
          <div class="stats-total-val">${totalHours} —á (${totalDays} –¥–Ω)</div>
        </div>
        <div class="stats-list">
          ${listHtml}
        </div>
      </div>
      <style>
        .stats-modal { color: #eaf2ff; }
        .stats-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .stats-total-label { font-size: 13px; color: #9db7dd; }
        .stats-total-val { font-size: 24px; font-weight: 900; color: #ffd166; margin-top: 4px; }
        .stats-list { max-height: 50vh; overflow-y: auto; }
        .stats-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .stats-rank { width: 30px; font-weight: 900; color: #4daaff; font-size: 16px; }
        .stats-info { flex: 1; min-width: 0; }
        .stats-title { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stats-meta { font-size: 12px; color: #9db7dd; margin-top: 4px; }
        .stats-empty { text-align: center; padding: 30px; color: #9db7dd; opacity: 0.7; }
      </style>
    `;

    W.Modals.open({
      title: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
      maxWidth: 420,
      bodyHtml: body
    });
  }

  W.StatisticsModal = { show: showStats };

})(window);

//=================================================
// FILE: /scripts/ui/sysinfo.js
// scripts/ui/sysinfo.js
// Optimized System Info Modal v2.0 (Direct Render)
(function(W, N) {
  'use strict';

  const U = W.Utils;
  const esc = (v) => U.escapeHtml(String(v ?? ''));
  const yn = (v) => v ? '‚úÖ' : '‚ùå';
  const row = (l, v) => `<div><strong>${l}:</strong> ${v}</div>`;

  const Sys = {
    initialize: () => {
      const btn = U.dom.byId('sysinfo-btn');
      if (btn) { btn.style.display = ''; btn.onclick = Sys.show; }
      
      document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') { e.preventDefault(); Sys.show(); }
      });
      console.log('‚úÖ SysInfo optimized');
    },

    show: async () => {
      if (!W.Modals?.open) return;

      // 1. Collect Data directly
      const C = W.APP_CONFIG || {};
      const P = performance, T = P.timing || {}, M = P.memory;
      const SC = W.screen;
      
      // 2. Get SW Version (Async)
      let swVer = '...';
      const getSW = async () => {
        try {
          const reg = await N.serviceWorker?.getRegistration();
          if (!reg?.active) return 'N/A';
          return new Promise(r => {
            const ch = new MessageChannel(), t = setTimeout(() => r('timeout'), 800);
            ch.port1.onmessage = e => { clearTimeout(t); r(e.data.version || 'N/A'); };
            reg.active.postMessage({ type: 'GET_SW_VERSION' }, [ch.port2]);
          });
        } catch { return 'Err'; }
      };

      // 3. Render HTML
      const grp = (t, c) => `<h3 style="color:#8ab8fd;margin:12px 0 6px">${t}</h3>${c}`;
      const render = (ver) => `<div style="font-size:13px;line-height:1.6;color:#eaf2ff">
        ${grp('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', row('–í–µ—Ä—Å–∏—è', `${esc(C.APP_VERSION)} (${esc(C.BUILD_DATE)})`) + row('PWA', yn(matchMedia('(display-mode: standalone)').matches)) + `<div id="sw-ver-row"><strong>SW:</strong> ${esc(ver)}</div>`)}
        ${grp('–°—Ä–µ–¥–∞', row('UA', esc(N.userAgent).slice(0,45)+'...') + row('–≠–∫—Ä–∞–Ω', `${SC.width}√ó${SC.height}`) + row('Online', yn(N.onLine)))}
        ${grp('–°–∏—Å—Ç–µ–º–∞', row('Audio', W.Howler ? `Howler ${Howler.version}` : 'Off') + row('RAM', M ? U.fmt.bytes(M.usedJSHeapSize) : 'N/A'))}
        <div style="margin-top:16px;border-top:1px solid #333;text-align:center;color:#666;font-size:10px">Vi3na1bita ¬© 2025</div>
      </div>`;

      // 4. Open Modal
      const modal = W.Modals.open({
        title: '–û —Å–∏—Å—Ç–µ–º–µ', maxWidth: 420,
        bodyHtml: render(swVer)
      });

      // 5. Update SW Ver after promise resolves
      getSW().then(v => {
        const el = modal.querySelector('#sw-ver-row');
        if (el) el.innerHTML = `<strong>SW –≤–µ—Ä—Å–∏—è:</strong> ${esc(v)}`;
      });
    }
  };

  W.SystemInfoManager = Sys;
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', Sys.initialize);
  else Sys.initialize();

})(window, navigator);

//=================================================
// FILE: /scripts/utils/sw-manager.js
//=================================================
// FILE: /scripts/utils/sw-manager.js
/**
 * scripts/utils/sw-manager.js
 * Optimized Service Worker Manager v2.1 (Fix Loop)
 * - –£–¥–∞–ª–µ–Ω–æ: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–æ–≤, –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ OfflineManager)
 * - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤ DevTools
 * - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
 */
(function (W, nav) {
  'use strict';

  let refreshing = false;

  class SWManager {
    constructor() {
      this.reg = null;
    }

    async init() {
      if (!('serviceWorker' in nav)) return;

      // 1. Prevent infinite loop on controller change
      nav.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        W.location.reload();
      });

      try {
        // 2. Register
        this.reg = await nav.serviceWorker.register('./service-worker.js', { scope: './' });

        // 3. Detect Update (waiting state)
        if (this.reg.waiting) {
          this._notifyUpdate();
        }

        // 4. Detect Future Updates
        this.reg.addEventListener('updatefound', () => {
          const newWorker = this.reg.installing;
          if (!newWorker) return;
          
          newWorker.addEventListener('statechange', () => {
            // Show button ONLY if there is already a controller (it's an update, not fresh install)
            if (newWorker.state === 'installed' && nav.serviceWorker.controller) {
              this._notifyUpdate();
            }
          });
        });

      } catch (e) {
        console.error('SW:', e);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –≤–µ—Ä—Å–∏–∏ (–∏–∑ app.js)
    handleVersionMessage(data) {
      if (data?.swVer && data.swVer !== (W.VERSION || '')) {
        this._notifyUpdate();
      }
    }

    _notifyUpdate() {
      // Prevent duplicates
      if (document.getElementById('update-app-btn')) return;

      W.NotificationSystem?.info('–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ', 5000);

      const btn = document.createElement('button');
      btn.id = 'update-app-btn';
      btn.textContent = '–û–ë–ù–û–í–ò–¢–¨';
      // –°—Ç–∏–ª–∏: –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ, –≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É, –Ω–æ —á—É—Ç—å –≤—ã—à–µ –ø–ª–µ–µ—Ä–∞
      btn.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);padding:10px 24px;background:#4daaff;color:#fff;border:0;border-radius:30px;font-weight:900;z-index:10001;box-shadow:0 6px 20px rgba(0,0,0,.6);cursor:pointer;animation:fadeIn .4s ease-out;font-size:14px;letter-spacing:0.05em;';
      
      btn.onclick = () => {
        btn.disabled = true;
        btn.textContent = '–û–ë–ù–û–í–õ–ï–ù–ò–ï...';
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–µ–µ—Ä–∞ –ø–µ—Ä–µ–¥ —Ä–µ–ª–æ–∞–¥–æ–º
        if (W.PlayerState?.save) W.PlayerState.save({ forReload: true });
        
        // –ö–æ–º–∞–Ω–¥–∞ SW –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ -> –≤—ã–∑–æ–≤–µ—Ç controllerchange -> reload
        if (this.reg?.waiting) {
          this.reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        } else {
          W.location.reload();
        }
      };
      
      document.body.appendChild(btn);
    }

    // API –¥–ª—è Offline Modal (–ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∫—ç—à–∞)
    getCacheSize() {
      if (!this.reg?.active) return Promise.resolve(0);
      return new Promise(resolve => {
        const ch = new MessageChannel();
        ch.port1.onmessage = (e) => resolve(e.data?.size || 0);
        // Timeout 1s —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –∑–∞–≤–∏—Å
        setTimeout(() => resolve(0), 1000);
        this.reg.active.postMessage({ type: 'GET_CACHE_SIZE' }, [ch.port2]);
      });
    }
  }

  W.ServiceWorkerManager = new SWManager();

  // Init logic
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => W.ServiceWorkerManager.init());
  } else {
    W.ServiceWorkerManager.init();
  }

})(window, navigator);

//=================================================
// FILE: /albums/gallery/news/news-01-baner.html
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ</title>
  <style>
    :root{
      --bg-0: #0b0e15;     /* –±–∞–∑–æ–≤—ã–π —Ñ–æ–Ω */
      --bg-1: #0f1422;     /* –ø–∞–Ω–µ–ª—å/–∫–∞—Ä—Ç–∞ */
      --bg-2: #0a0d17;     /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ–Ω */
      --text: #e8ecf6;     /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --muted: #a9b3c7;    /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π */
      --accent-1: #4aa3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã */
      --accent-2: #7be3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã 2 */
      --shadow: 0 12px 28px rgba(0,0,0,0.45), 0 3px 10px rgba(0,0,0,0.35);
      --radius: 16px;
      --radius-inner: 12px;
    }
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(120% 120% at 10% 10%, #111827 0%, #0b0e15 45%, #070a12 100%);
      color: var(--text);
      font: 500 16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    .wrap{
      position:relative;
      height:100%;
      width:100%;
      display:grid;
      place-items:center;
      padding:10px;
      box-sizing:border-box;
    }
    /* –í–Ω–µ—à–Ω—è—è ¬´–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è —Ä–∞–º–∫–∞¬ª */
    .frame{
      position:relative;
      width:100%;
      height:100%;
      max-width:900px;
      max-height:900px;
      border-radius: var(--radius);
      padding:1px; /* —Ç–æ–ª—â–∏–Ω–∞ —Ä–∞–º–∫–∏ */
      background: linear-gradient(135deg, rgba(74,163,255,0.85), rgba(123,227,255,0.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card{
      position:relative;
      width:100%;
      height:100%;
      border-radius: calc(var(--radius) - 1px);
      background:
        radial-gradient(140% 120% at 80% 0%, rgba(27,41,72,0.55), transparent 60%),
        radial-gradient(120% 140% at 0% 100%, rgba(18,30,58,0.6), transparent 55%),
        var(--bg-1);
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:16px;
      box-sizing:border-box;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .badge{
      align-self:flex-start;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(2px);
    }
    .title{
      font-weight:700;
      font-size: clamp(18px, 3vw, 24px);
      line-height:1.25;
      margin:0 4px;
      color: var(--text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.25);
    }
    .subtitle{
      margin: -6px 4px 2px;
      color: var(--muted);
      font-size: 14px;
    }

    /* –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø–ª–µ–µ—Ä–∞ */
    .embed{
      position:relative;
      margin-top: 4px;
      width:100%;
      flex: 1 1 auto;
      aspect-ratio: 1 / 1; /* —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç */
      border-radius: var(--radius-inner);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.8), rgba(6,8,15,0.92)),
        var(--bg-2);
      border:1px solid rgba(255,255,255,0.07);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 24px rgba(0,0,0,0.45);
    }
    /* ‚úÖ –í–º–µ—Å—Ç–æ iframe: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –≤—Å—é –æ–±–ª–∞—Å—Ç—å (–±–µ–∑ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—à–∏–±–æ–∫) */
    .embed-link{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: var(--text);
      text-decoration:none;
      font-weight:800;
      font-size: clamp(16px, 3vw, 22px);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.65), rgba(6,8,15,0.9)),
        var(--bg-2);
    }
    .embed-link:hover{
      filter: brightness(1.05);
    }
    .embed-link:active{
      filter: brightness(0.95);
    }

    /* –ù–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top: 4px;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      opacity: .9;
    }
    .cta{
      padding:8px 12px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      text-decoration:none;
      font-weight:600;
      transition: transform .12s ease, background .2s ease;
    }
    .cta:hover{ transform: translateY(-1px); }
    .cta:active{ transform: translateY(0); }

    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö –≤—ã—Å–æ—Ç–∞—Ö —Å–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
    @media (max-height: 420px){
      .card{ padding:12px; gap:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <section class="card" role="region" aria-label="–ù–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–Ω–Ω–µ—Ä ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏">
        <div class="badge">–ù–æ–≤–æ—Å—Ç–∏</div>
        <h1 class="title">¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª ‚Äî —É–∂–µ –Ω–∞ –Ø–Ω–¥–µ–∫—Å&nbsp;–ú—É–∑—ã–∫–µ</h1>
        <p class="subtitle">–°–ª—É—à–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º –≥—Ä—É–ø–ø—ã ¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª</p>

        <div class="embed" role="group" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ">
          <a class="embed-link"
             href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link"
             target="_blank"
             rel="noopener">
            –û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ
          </a>
        </div>

        <div class="footer">
          <div class="hint">–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏—Ç–µ ¬´–ø–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤ –ø–ª–µ–µ—Ä–µ, —á—Ç–æ–±—ã —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –¥—Ä—É–∑—å—è–º</div>
          <a class="cta" href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º</a>
        </div>
      </section>
    </div>
  </div>
</body>
</html>

//=================================================
// FILE: /generate-context.js
/* eslint-disable no-console */
"use strict";

/**
 * generate-context.js
 *
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä .meta/project-full.txt –∏ .meta/project-adaptive.txt
 * –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã):
 * 1) –í –Ω–∞—á–∞–ª–µ ‚Äî –±–ª–æ–∫ ¬´–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô¬ª, –∑–∞—Ç–µ–º –º–µ—Ç–∞‚Äë–±–ª–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º/URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–æ–º–µ—Ç–∫–æ–π –ø—Ä–æ GitHub.
 * 2) –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ‚Äî –ü–û–õ–ù–û–ï –¥–µ—Ä–µ–≤–æ –í–°–ï–• —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è assets/), –Ω–æ –±–µ–∑ .git/** –∏ .meta/**.
 *    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤.
 * 3) –ü–æ—Å–ª–µ –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º (critical ‚Üí high ‚Üí medium ‚Üí low),
 *    –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤—ã–≤–æ–¥–∏—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º. –ó–¥–µ—Å—å assets/** –∏—Å–∫–ª—é—á–∞–µ–º (–ø–æ –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é), .meta/** —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º.
 * 4) –ù–ï–¢ –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª.
 * 5) Adaptive-—Ä–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—â–∏–π –æ–±—ä—ë–º —Å—Ç—Ä–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º --max-lines (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20000).
 *
 * –ó–∞–ø—É—Å–∫:
 *   node generate-context.js --mode=both --max-lines=20000
 *   node generate-context.js --mode=full
 *   node generate-context.js --mode=adaptive --out-dir=.meta
 *
 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
 *   --mode=both|full|adaptive
 *   --max-lines=–ß–ò–°–õ–û           // —Ç–æ–ª—å–∫–æ –¥–ª—è adaptive
 *   --out-dir=–ü–£–¢–¨              // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é .meta
 *   --root=–ü–£–¢–¨                 // –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞)
 */

const fs = require("fs");
const path = require("path");

// -------------------- CLI --------------------
const argv = Object.fromEntries(
  process.argv.slice(2).map(a => {
    const [k, ...r] = a.replace(/^--/, "").split("=");
    return [k, r.join("=") === "" ? true : r.join("=")];
  })
);

const ROOT     = path.resolve(argv.root || __dirname);
const META_DIR = path.resolve(argv["out-dir"] || path.join(ROOT, ".meta"));
const MODE     = (argv.mode || "both").toLowerCase(); // full | adaptive | both
const MAX_LINES = Number(argv["max-lines"] || 20000);

// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ .meta
if (!fs.existsSync(META_DIR)) fs.mkdirSync(META_DIR, { recursive: true });

const FULL_FILE    = path.join(META_DIR, "project-full.txt");
const ADAPTIVE_FILE= path.join(META_DIR, "project-adaptive.txt");

// –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ self-—Ñ–∞–π–ª–∞–º (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è)
const SELF_FULL_REL  = toUnix(path.relative(ROOT, FULL_FILE));
const SELF_ADAPT_REL = toUnix(path.relative(ROOT, ADAPTIVE_FILE));

// -------------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ --------------------

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ç–æ—Ä—ã—Ö –≤–∫–ª—é—á–∞–µ–º –≤ —Å–µ–∫—Ü–∏—é ¬´–§–ê–ô–õ–´¬ª
const TEXT_EXTS = new Set([
  ".html",".htm",".css",".js",".mjs",".cjs",".ts",".tsx",
  ".json",".webmanifest",".md",".txt",".yml",".yaml"
]);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –°–ï–ö–¶–ò–ò ¬´–§–ê–ô–õ–´¬ª (—Ç–æ–ª—å–∫–æ –∫ –ª–∏—Å—Ç–∏–Ω–≥—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ù–ï –∫ –¥–µ—Ä–µ–≤—É):
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –∏—Å–∫–ª—é—á–∞–µ–º .meta/** –∏ assets/** (–Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ –∫–æ–Ω—Ç–µ–Ω—Ç),
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏.
 */
const EXCLUDE_FILES_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  "assets/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û –¥–ª—è –°–¢–†–£–ö–¢–£–†–´ –î–ï–†–ï–í–ê:
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã, –≤–∫–ª—é—á–∞—è assets/**.
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ .git/**, .meta/** –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ (node_modules –∏ —Ç.–ø.),
 *   –ø–ª—é—Å –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤.
 */
const EXCLUDE_TREE_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
const PRIORITY = {
  critical: [
    /^index\.html?$/i,
    /^service-worker\.js$/i,
    /^manifest\.json$/i,
    /^albums\.json$/i,
    /^custom\.json$/i,
    /^news\.html?$/i,
    /^generate-index\.(js|mjs|cjs)$/i,
    /^albums\/gallery\/[^/]+\/index\.json$/i,
    /^\.github\/workflows\/.*\.ya?ml$/i
  ],
  high: [
    /^AudioController\.(js|mjs|cjs|ts)$/i,
    /^GlobalState\.(js|mjs|cjs|ts)$/i,
    /^scripts\/.*\.(mjs|js|ts)$/i,
    /^performance\/.*\.(js|ts)$/i,
    /^.*\.(ya?ml)$/i
  ],
  medium: [
    /^.*\.(js|mjs|cjs|ts|tsx|json|html?|css)$/i
  ],
};

// -------------------- –£—Ç–∏–ª–∏—Ç—ã --------------------
function toUnix(p) {
  return String(p).replace(/\\/g, "/");
}
function globToRegExp(pat) {
  const esc = pat
    .replace(/[.+^${}()|[\]\\]/g, "\\$")
    .replace(/\*\*/g, "___GLOBSTAR___")
    .replace(/\*/g, "[^/]*")
    .replace(/___GLOBSTAR___/g, ".*");
  return new RegExp("^" + esc + "$");
}
function isTextFile(rel) {
  return TEXT_EXTS.has(path.extname(rel).toLowerCase());
}
function readText(rel) {
  try { return fs.readFileSync(path.join(ROOT, rel), "utf8"); }
  catch (e) { return `// read error: ${e.message}`; }
}
function countLines(s) {
  return (s.match(/\n/g) || []).length + (s.length ? 1 : 0);
}

// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
function isExcludedForFiles(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_FILES_PATTERNS.some(re => re.test(u));
}
// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –¥–µ—Ä–µ–≤–∞
function isExcludedForTree(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_TREE_PATTERNS.some(re => re.test(u));
}

// -------------------- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ --------------------
function listAllEntries(includeFiles = true, forTree = false) {
  const res = [];
  const stack = [ROOT];

  while (stack.length) {
    const dir = stack.pop();
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { continue; }

    for (const e of entries) {
      const full = path.join(dir, e.name);
      const rel = toUnix(path.relative(ROOT, full)) || ".";

      // –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –¥–ª—è –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–≤–æ–∏, –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî —Å–≤–æ–∏
      const excluded = forTree ? isExcludedForTree(rel) : isExcludedForFiles(rel);
      if (excluded) continue;

      if (e.isDirectory()) {
        res.push({ rel, full, dir: true });
        stack.push(full);
      } else if (e.isFile() && includeFiles) {
        res.push({ rel, full, dir: false });
      }
    }
  }

  // –ü–∞–ø–∫–∏ —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º —Ñ–∞–π–ª—ã; –≤–Ω—É—Ç—Ä–∏ ‚Äî –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  res.sort((a, b) => (a.dir !== b.dir ? (a.dir ? -1 : 1) : a.rel.localeCompare(b.rel)));
  return res;
}

function listTextFilesForContent() {
  return listAllEntries(true, /*forTree*/ false)
    .filter(e => !e.dir && isTextFile(e.rel))
    .map(e => e.rel);
}

// -------------------- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π --------------------
function readRepoMeta() {
  let url = "";
  try {
    const cfg = path.join(ROOT, ".git", "config");
    if (fs.existsSync(cfg)) {
      const raw = fs.readFileSync(cfg, "utf8");
      const m = raw.match(/url\s*=\s*(.+)\n/);
      if (m) url = m[1].trim();
    }
  } catch {}
  return {
    name: path.basename(ROOT),
    url: url || "(URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω; —É–∫–∞–∂–∏—Ç–µ –≤ .git/config)",
    madeWith: "–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).",
  };
}

// -------------------- –ë–ª–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ --------------------
function rulesBlock() {
  return [
    "–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):",
    "- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.",
    "- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.",
    "- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).",
    "- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:",
    "  ```ts",
    "  export function x() {}",
    "  ```",
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).",
    "- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.",
    "- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.",
    "- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.",
    "- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.",
    "- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].",
    "- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. ",
    "- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.",
    "- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).",
    "- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.",
    "- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤—ã–∑–≤–∞—Ç—å STOP —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–Ω—è—Ç –≤ favorites view, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞ –∏ –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ä–æ–≥–æ —Å–ª–µ–¥–∞, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–µ–º —á—Ç–æ-—Ç–æ –≤ –∫–æ–¥–µ",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏–ª–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –∫–æ–¥–µ, –Ω–æ –ø—Ä–∏—ç—Ç–æ–º –ø–æ–ª–Ω–æ—Å—Ç—å–± –±—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ –ª–æ–≥–∏–∫—É, –ª–æ–≥–∏—Å—Ç–∏–∫—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–µ–º–∏—Ç—å—Å—è –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —É–ø—Ä–æ—â–µ–Ω–∏—é –∫–æ–¥–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    ""
  ].join("\n");
}

function metaBlock() {
  const m = readRepoMeta();

  const favoritesPrinciplesBlock = [
    "## –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞",
    "–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ –≤ –ò–ó–ë–†–ê–ù–ù–û–ï:",
    "–õ–∞–π–∫/–∞–Ω–ª–∞–π–∫ (‚≠ê) = –∏–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ ‚≠ê —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö (—Ä–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º, ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª, –¥—Ä—É–≥–∏–µ —Å–ø–∏—Å–∫–∏).",
    "",
    "–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–∑ –æ–∫–Ω–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª",
    "–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äì —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.",
    "",
    "–ü–æ–¥—Ä–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã",
    "‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã):",
    "- –ü–æ—Å—Ç–∞–≤–∏–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π.",
    "- –°–Ω—è–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª (–¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º, ¬´–±–µ–∑ —Å–ª–µ–¥–∞¬ª).",
    "",
    "‚≠ê –≤ –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:",
    "- –°–Ω—è–ª–∏ ‚≠ê —Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–µ—Ä–æ–π (inactive), ‚≠ê —Å–Ω–∏–º–∞–µ—Ç—Å—è –∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª, –∏ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.",
    "- –°–Ω—è—Ç–∏–µ ‚≠ê –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ, –∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –µ—ë –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (‚Äú–±—É—Ñ–µ—Ä‚Äù).",
    "",
    "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π (—Å–µ—Ä–æ–π) —Å—Ç—Ä–æ–∫–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª:",
    "- –ö–ª–∏–∫ –ø–æ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–µ –ø–æ –∑–≤–µ–∑–¥–µ) ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:",
    "  - –í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, ‚≠ê —Å—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–µ–∑–¥–µ.",
    "  - –£–¥–∞–ª–∏—Ç—å ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê –ø—Ä–∏ —ç—Ç–æ–º —Å–Ω—è—Ç–∞.",
    "- –ö–ª–∏–∫ –ø–æ ‚≠ê –Ω–∞ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –º–æ–¥–∞–ª–∫–∏, —Å—Ç—Ä–æ–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å ‚≠ê.",
    "- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É (–∏–ª–∏ ‚Äú–±–µ–∑ —Å–ª–µ–¥–∞‚Äù —á–µ—Ä–µ–∑ –∞–Ω–ª–∞–π–∫ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ).",
    "",
    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:",
    "- –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚≠ê –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ –≤—Å–µ—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è—Ö –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫.",
    "- –í –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª: —Å–Ω—è—Ç–∏–µ ‚≠ê –Ω–∞ –ª—é–±–æ–π —Å—Ç—Ä–æ–∫–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.",
    "- –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É.",
    "",
    "–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:",
    "- –õ—é–±—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç—Ä–µ–∫–∞ –≤ inactive, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞.",
    "- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–µ—Å–Ω–∏ –ù–ï –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç ‚Äú–≤ —Ñ–æ–Ω–µ‚Äù.",
    "",
    "–û—Å–æ–±–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞:",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è inactive –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫.",
    "- –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî –ø–ª–µ–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º —Å—Ç–æ–ø, –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.",
    "",
    "–†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º –≤—Å–µ–≥–¥–∞ —Ä–µ—à–∞–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ:",
    "- –ï—Å–ª–∏ —Å–Ω—è—Ç—å ‚≠ê —Å —Ç—Ä–µ–∫–∞ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚Äî –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–ª—Å—è —Ç–∞–º –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è (—Å–µ—Ä–∞—è) —Å—Ç—Ä–æ–∫–∞.",
    "",
    "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ:",
    "- –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ ‚≠ê –Ω–∞ —Ç—Ä–µ–∫–µ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π.",
    "",
    "–ò—Ç–æ–≥–∏",
    "- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî —à–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–æ–π.",
    "- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚≠ê –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö.",
    "- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π: –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–¥–Ω–æ–º—É –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.",
    "- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.",
    "- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.",
    " =========================================================================== ",
    "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F (–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)",
    "–ö–Ω–æ–ø–∫–∞ F –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º Favorites Only –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞).",
    "–û–Ω–∞ –Ω–µ —Å—Ç–∞–≤–∏—Ç/–Ω–µ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê —É —Ç—Ä–µ–∫–æ–≤, –∞ —Ç–æ–ª—å–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç, –ø–æ –∫–∞–∫–∏–º —Ç—Ä–µ–∫–∞–º –º–æ–∂–Ω–æ —Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Next / Prev / –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏ –∫–∞–∫–∏–µ —Ç—Ä–µ–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ Shuffle.",
    "–ï–¥–∏–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø (–ø–æ–ª–Ω—ã–π –ø–ª–µ–µ—Ä –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä)",
    "–ü–æ–ª–Ω—ã–π –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ playing-–ø–ª–µ–π–ª–∏—Å—Ç–æ–º.",
    "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö: –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ playing, –∞ –Ω–µ –∫ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å–ø–∏—Å–∫—É.",
    "–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–¥–æ—Å—Ç—É–ø–Ω—ã–º —Ç—Ä–µ–∫–æ–º‚Äù",
    "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ ‚Äî —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤:",
    "Next / Prev",
    "–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —Ç—Ä–µ–∫–∞",
    "Shuffle-–ø–æ—Ä—è–¥–∫–µ (–µ—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω)",
    "–ü—Ä–∞–≤–∏–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:",
    "F = OFF: –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±—ã—á–Ω—ã–π –Ω–∞–±–æ—Ä playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞, –Ω–æ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å–º. ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –Ω–∏–∂–µ).",
    "F = ON: –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (‚≠ê) —Ç—Ä–µ–∫–∏ playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞.",
    "–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –æ–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º",
    "–ò–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ ‚≠ê –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ (–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ª–∞–π–∫–æ–≤).",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –≤ –∞–ª—å–±–æ–º–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ ‚≠ê —Ç—Ä–µ–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.",
    "–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä —Å—É–∂–∞–µ—Ç—Å—è –¥–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è OFF, –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞–ª—å–±–æ–º–∞, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ ‚≠ê –Ω–µ—Ç: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = ‚≠ê, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ —ç—Ç–æ–º—É shuffle-–ø–æ—Ä—è–¥–∫—É.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = –≤—Å–µ —Ç—Ä–µ–∫–∏, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–∞–±–æ—Ä—É, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –ò–ó–ë–†–ê–ù–ù–û–ï (–ø–ª–µ–π–ª–∏—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ)",
    "–í ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã active –∏ inactive:",
    "active: —Ç—Ä–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º (‚≠ê –µ—Å—Ç—å) ‚Äî —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏",
    "inactive: ‚≠ê —Å–Ω—è—Ç–∞, —Å—Ç—Ä–æ–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏",
    "–ë–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–≤–∞–∂–Ω–æ): inactive –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –≤ Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∏ shuffle-–ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø—Ä–∏ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ F.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –Ω–µ—Ç active (–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –Ω–µ—á–µ–≥–æ –∏–≥—Ä–∞—Ç—å): –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = active (–ø–æ —Ñ–∞–∫—Ç—É –æ–Ω –∏ —Ç–∞–∫ —Ç–∞–∫–æ–π), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ active.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è = active (inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ active.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –Ω–µ—Ç active: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active (–ø–æ—Ç–æ–º—É —á—Ç–æ inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)",
    "–ù–∞–∂–∞—Ç–∏–µ F –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–∞–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (‚≠ê –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –∏ –Ω–µ —Å–Ω–∏–º–∞–µ—Ç—Å—è).",
    "–ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ (–Ω–µ—Ç ‚≠ê –≤ –∞–ª—å–±–æ–º–µ / –Ω–µ—Ç active –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ): –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∏ F –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è (–æ—Å—Ç–∞—ë—Ç—Å—è OFF).",
    "inactive –≤ –ò–ó–ë–†–ê–ù–ù–û–ú ‚Äî —ç—Ç–æ UI-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è, –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∏ –≤ –∫–∞–∫–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –Ω–∏ –≤ Next/Prev, –Ω–∏ –≤ Shuffle.",
    ""
  ].join("\n");

  return [
    `–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.name}`,
    `–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.url}`,
    "# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.",
    favoritesPrinciplesBlock,
    m.madeWith,
    ""
  ].join("\n");
}

// -------------------- –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê (–¥–µ—Ä–µ–≤–æ) --------------------
function buildFullTree() {
  const lines = [];
  lines.push(path.basename(ROOT) + "/");

  function walk(dir, prefix = "") {
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { return; }

    const visible = entries
      .filter(e => !isExcludedForTree(toUnix(path.relative(ROOT, path.join(dir, e.name)))))
      .sort((a, b) => (a.isDirectory() !== b.isDirectory() ? (a.isDirectory() ? -1 : 1) : a.name.localeCompare(b.name)));

    visible.forEach((e, i) => {
      const isLast = i === visible.length - 1;
      const branch = isLast ? "‚îî‚îÄ‚îÄ " : "‚îú‚îÄ‚îÄ ";
      lines.push(prefix + branch + e.name + (e.isDirectory() ? "/" : ""));
      if (e.isDirectory()) {
        walk(path.join(dir, e.name), prefix + (isLast ? "    " : "‚îÇ   "));
      }
    });
  }

  walk(ROOT);
  return lines.join("\n") + "\n\n";
}

// -------------------- –°–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª --------------------
function getPriority(rel) {
  const u = toUnix(rel);
  for (const [lvl, rules] of Object.entries(PRIORITY)) {
    if (rules.some(re => re.test(u))) return lvl;
  }
  return "low";
}

function groupFilesByPriority() {
  const all = listTextFilesForContent(); // —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω—ã assets/.meta –∏ –ø—Ä–æ—á–∏–µ –ø–æ EXCLUDE_FILES_PATTERNS
  return {
    critical: all.filter(f => getPriority(f) === "critical"),
    high:     all.filter(f => getPriority(f) === "high"),
    medium:   all.filter(f => getPriority(f) === "medium"),
    low:      all.filter(f => getPriority(f) === "low"),
  };
}

function fileBlock(rel) {
  return [
    "//=================================================",
    `// FILE: /${toUnix(rel)}`,
    readText(rel),
    ""
  ].join("\n");
}

// -------------------- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞ --------------------
function headerBlock() {
  const now = new Date().toISOString().replace("T"," ").slice(0,19) + " UTC";
  return [
    rulesBlock(),
    metaBlock(),
    "–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:",
    buildFullTree(),
    `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${now}`,
    ""
  ].join("\n");
}

// -------------------- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã --------------------
function generateFull() {
  let out = headerBlock();

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium", "low"];
  for (const lvl of order) {
    for (const f of groups[lvl]) {
      out += fileBlock(f);
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

function generateAdaptive() {
  let out = headerBlock();
  let cur = countLines(out);
  const max = MAX_LINES;

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium"]; // low –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ adaptive —á–∞—â–µ –≤—Å–µ–≥–æ

  for (const lvl of order) {
    for (const f of groups[lvl]) {
      const block = fileBlock(f);
      const L = countLines(block);
      if (cur + L > max) {
        out += "\n// ... (truncate)\n";
        return out;
      }
      out += block; cur += L;
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

// -------------------- MAIN --------------------
function main() {
  if (MODE === "full" || MODE === "both") {
    fs.writeFileSync(FULL_FILE, generateFull(), "utf8");
    console.log(`‚úÖ ${FULL_FILE}`);
  }
  if (MODE === "adaptive" || MODE === "both") {
    fs.writeFileSync(ADAPTIVE_FILE, generateAdaptive(), "utf8");
    console.log(`‚úÖ ${ADAPTIVE_FILE}`);
  }
}

try { main(); } catch (e) { console.error("‚ùå", e); process.exit(1); }

//=================================================
// FILE: /news/news.json
{
  "items": [
    {
      "id": "2025-11-01-release",
      "title": "–ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ ‚Äî –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "date": "2025-11-01",
      "text": "–î–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
      "image": "img/logo.png",
      "tags": ["—Ä–µ–ª–∏–∑", "–∞–ª—å–±–æ–º"]
    },
    {
      "id": "2025-10-20-video",
      "title": "–ö–ª–∏–ø –Ω–∞ —Ç—Ä–µ–∫ ¬´–û—Ç—Ä–∞–∂–µ–Ω–∏–µ¬ª",
      "date": "2025-10-20",
      "embedUrl": "https://www.youtube.com/embed/dQw4w9WgXcQ",
      "tags": ["–∫–ª–∏–ø", "–≤–∏–¥–µ–æ"]
    },
    {
      "id": "2025-10-05-tour",
      "title": "–¢—É—Ä: –∑–∏–º–Ω–∏–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã",
      "date": "2025-10-05",
      "text": "–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü—Å–µ—Ç—è—Ö.",
      "tags": ["–∫–æ–Ω—Ü–µ—Ä—Ç—ã"]
    }
  ]
}

//=================================================
// FILE: /src/js/cache-db.js
/**
 * CacheDB ‚Äî IndexedDB storage for audio blobs and track metadata (–¢–ó 1.3, 1.7)
 * Single audio copy per uid (no duplicates rule)
 * Stores: audio blobs, track offline state, LRU queue, stats
 */

const DB_NAME = 'vitrina-offline-v2';
const DB_VERSION = 2;

const STORE_AUDIO = 'audio';       // key: uid, value: { uid, variant, blob, size, cacheKind, createdAt }
const STORE_META = 'meta';         // key: uid, value: { uid, pinned, cloud, cacheKind, cachedVariant, cachedComplete, needsUpdate, needsReCache, cloudStats, ... }
const STORE_LRU = 'lru';           // key: 'queue', value: [uid, uid, ...]
const STORE_STATS = 'globalStats'; // key: uid, value: { globalFullListenCount, globalListenSeconds }
const STORE_ASSETS = 'assets';     // key: assetKey, value: { blob, type, createdAt }

let _db = null;
let _dbReady = null;

function _openDB() {
  if (_dbReady) return _dbReady;
  _dbReady = new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_AUDIO)) {
        db.createObjectStore(STORE_AUDIO, { keyPath: 'uid' });
      }
      if (!db.objectStoreNames.contains(STORE_META)) {
        db.createObjectStore(STORE_META, { keyPath: 'uid' });
      }
      if (!db.objectStoreNames.contains(STORE_LRU)) {
        db.createObjectStore(STORE_LRU, { keyPath: 'id' });
      }
      if (!db.objectStoreNames.contains(STORE_STATS)) {
        db.createObjectStore(STORE_STATS, { keyPath: 'uid' });
      }
      if (!db.objectStoreNames.contains(STORE_ASSETS)) {
        db.createObjectStore(STORE_ASSETS, { keyPath: 'key' });
      }
    };
    req.onsuccess = (e) => { _db = e.target.result; resolve(_db); };
    req.onerror = (e) => { console.error('[CacheDB] open error', e); reject(e); };
  });
  return _dbReady;
}

async function _getStore(storeName, mode = 'readonly') {
  const db = await _openDB();
  const tx = db.transaction(storeName, mode);
  return tx.objectStore(storeName);
}

async function _txDo(storeName, mode, fn) {
  const db = await _openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(storeName, mode);
    const store = tx.objectStore(storeName);
    const result = fn(store);
    tx.oncomplete = () => resolve(result._result !== undefined ? result._result : undefined);
    tx.onerror = (e) => reject(e);
  });
}

// Simpler approach: promise-based IDB helpers
function _idbGet(storeName, key) {
  return _openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(storeName, 'readonly');
    const req = tx.objectStore(storeName).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = (e) => reject(e);
  }));
}

function _idbPut(storeName, value) {
  return _openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(storeName, 'readwrite');
    tx.objectStore(storeName).put(value);
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e);
  }));
}

function _idbDelete(storeName, key) {
  return _openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(storeName, 'readwrite');
    tx.objectStore(storeName).delete(key);
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e);
  }));
}

function _idbGetAll(storeName) {
  return _openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(storeName, 'readonly');
    const req = tx.objectStore(storeName).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = (e) => reject(e);
  }));
}

function _idbClear(storeName) {
  return _openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(storeName, 'readwrite');
    tx.objectStore(storeName).clear();
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e);
  }));
}

// ==================== AUDIO BLOB STORAGE ====================

/** Save audio blob for uid (–¢–ó 1.7: only one variant per uid) */
async function saveAudioBlob(uid, variant, blob, cacheKind) {
  const existing = await getAudioEntry(uid);
  // No duplicates rule: if different variant exists, remove it first
  if (existing && existing.variant !== variant) {
    console.log(`[CacheDB] replacing ${existing.variant} ‚Üí ${variant} for ${uid}`);
  }
  const entry = {
    uid,
    variant,
    blob,
    size: blob.size,
    cacheKind: cacheKind || 'dynamic',
    createdAt: Date.now()
  };
  await _idbPut(STORE_AUDIO, entry);

  // Update meta
  const meta = await getTrackMeta(uid) || _defaultMeta(uid);
  meta.cachedVariant = variant;
  meta.cachedComplete = 100;
  meta.cacheKind = cacheKind || meta.cacheKind || 'dynamic';
  meta.needsReCache = false;
  await saveTrackMeta(meta);

  return entry;
}

async function getAudioEntry(uid) {
  return _idbGet(STORE_AUDIO, uid);
}

async function getAudioBlob(uid) {
  const entry = await getAudioEntry(uid);
  return entry ? entry.blob : null;
}

async function getAudioBlobURL(uid) {
  const blob = await getAudioBlob(uid);
  if (!blob) return null;
  return URL.createObjectURL(blob);
}

async function deleteAudioBlob(uid) {
  await _idbDelete(STORE_AUDIO, uid);
}

async function hasAudioLocally(uid) {
  const entry = await getAudioEntry(uid);
  return entry !== null;
}

async function getAllAudioEntries() {
  return _idbGetAll(STORE_AUDIO);
}

// ==================== TRACK META ====================

function _defaultMeta(uid) {
  return {
    uid,
    pinned: false,
    cloud: false,
    cacheKind: 'none',
    cachedVariant: null,
    cachedComplete: 0,
    needsUpdate: false,
    needsReCache: false,
    cloudFullListenCount: 0,
    lastFullListenAt: null,
    cloudAddedAt: null,
    cloudExpiresAt: null,
    fullOfflineIncluded: false,
    lastAccessAt: null
  };
}

async function getTrackMeta(uid) {
  return _idbGet(STORE_META, uid);
}

async function saveTrackMeta(meta) {
  return _idbPut(STORE_META, meta);
}

async function getAllTrackMetas() {
  return _idbGetAll(STORE_META);
}

async function deleteTrackMeta(uid) {
  return _idbDelete(STORE_META, uid);
}

/** Get offline state for UI (–¢–ó 19.2) */
async function getTrackOfflineState(uid) {
  const meta = await getTrackMeta(uid) || _defaultMeta(uid);
  return {
    pinned: meta.pinned,
    cloud: meta.cloud,
    cacheKind: meta.cacheKind,
    cachedVariant: meta.cachedVariant,
    cachedComplete: meta.cachedComplete,
    needsUpdate: meta.needsUpdate,
    needsReCache: meta.needsReCache
  };
}

// ==================== LRU QUEUE (–¢–ó 7.14.4) ====================

const LRU_KEY = 'lru-queue';

async function getLRUQueue() {
  const entry = await _idbGet(STORE_LRU, LRU_KEY);
  return entry ? entry.queue : [];
}

async function saveLRUQueue(queue) {
  await _idbPut(STORE_LRU, { id: LRU_KEY, queue });
}

/** Touch uid to MRU position (–¢–ó 7.14.4) */
async function touchLRU(uid) {
  const queue = await getLRUQueue();
  const idx = queue.indexOf(uid);
  if (idx !== -1) queue.splice(idx, 1);
  queue.unshift(uid);
  await saveLRUQueue(queue);
  return queue;
}

/** Remove uid from LRU */
async function removeLRU(uid) {
  const queue = await getLRUQueue();
  const idx = queue.indexOf(uid);
  if (idx !== -1) {
    queue.splice(idx, 1);
    await saveLRUQueue(queue);
  }
  return queue;
}

/** Get tail uids for eviction */
async function getLRUTail(count) {
  const queue = await getLRUQueue();
  return queue.slice(-count);
}

// LRU queue backup to localStorage (–¢–ó answer Q3: text backup)
function backupLRUToLocalStorage(queue) {
  try {
    localStorage.setItem('offline:lruBackup:v1', JSON.stringify(queue));
  } catch(e) { /* quota exceeded, ignore */ }
}

function restoreLRUFromLocalStorage() {
  try {
    const raw = localStorage.getItem('offline:lruBackup:v1');
    return raw ? JSON.parse(raw) : [];
  } catch(e) { return []; }
}

// ==================== GLOBAL STATS (–¢–ó 18) ====================

async function getGlobalStats(uid) {
  const entry = await _idbGet(STORE_STATS, uid);
  return entry || { uid, globalFullListenCount: 0, globalListenSeconds: 0 };
}

async function saveGlobalStats(uid, stats) {
  await _idbPut(STORE_STATS, { uid, ...stats });
}

async function getAllGlobalStats() {
  return _idbGetAll(STORE_STATS);
}

// ==================== ASSETS (covers, lyrics, gallery) ====================

async function saveAsset(key, blob, type) {
  await _idbPut(STORE_ASSETS, { key, blob, type, createdAt: Date.now() });
}

async function getAsset(key) {
  return _idbGet(STORE_ASSETS, key);
}

async function deleteAsset(key) {
  await _idbDelete(STORE_ASSETS, key);
}

async function getAllAssets() {
  return _idbGetAll(STORE_ASSETS);
}

// ==================== STORAGE SIZE ESTIMATES ====================

async function getTotalCacheSize() {
  const entries = await getAllAudioEntries();
  let total = 0;
  for (const e of entries) {
    total += e.size || 0;
  }
  return total;
}

async function getCacheSizeByKind() {
  const entries = await getAllAudioEntries();
  const metas = await getAllTrackMetas();
  const metaMap = {};
  metas.forEach(m => { metaMap[m.uid] = m; });

  const breakdown = { pinned: 0, cloud: 0, dynamic: 0, playbackWindow: 0, fullOffline: 0, other: 0 };
  for (const e of entries) {
    const meta = metaMap[e.uid];
    const kind = meta ? meta.cacheKind : (e.cacheKind || 'other');
    if (breakdown[kind] !== undefined) {
      breakdown[kind] += e.size || 0;
    } else {
      breakdown.other += e.size || 0;
    }
  }

  // Assets
  const assets = await getAllAssets();
  breakdown.other += assets.reduce((s, a) => s + (a.blob ? a.blob.size : 0), 0);

  return breakdown;
}

async function getStorageEstimate() {
  try {
    if (navigator.storage && navigator.storage.estimate) {
      const est = await navigator.storage.estimate();
      return { quota: est.quota || 0, usage: est.usage || 0, free: (est.quota || 0) - (est.usage || 0) };
    }
  } catch(e) {}
  return { quota: 0, usage: 0, free: 0 };
}

// ==================== CLEAR / CLEANUP ====================

async function clearAll() {
  await _idbClear(STORE_AUDIO);
  await _idbClear(STORE_META);
  await _idbClear(STORE_LRU);
  await _idbClear(STORE_ASSETS);
  // Do NOT clear STORE_STATS (–¢–ó 18.4: global stats never reset)
}

async function clearByKind(kind) {
  const metas = await getAllTrackMetas();
  const toDelete = metas.filter(m => m.cacheKind === kind);
  for (const m of toDelete) {
    await deleteAudioBlob(m.uid);
    m.cacheKind = 'none';
    m.cachedVariant = null;
    m.cachedComplete = 0;
    if (kind === 'dynamic') {
      await removeLRU(m.uid);
    }
    await saveTrackMeta(m);
  }
  return toDelete.length;
}

// Init DB on load
_openDB().catch(e => console.error('[CacheDB] init failed', e));

export {
  saveAudioBlob, getAudioEntry, getAudioBlob, getAudioBlobURL, deleteAudioBlob,
  hasAudioLocally, getAllAudioEntries,
  getTrackMeta, saveTrackMeta, getAllTrackMetas, deleteTrackMeta, getTrackOfflineState,
  getLRUQueue, saveLRUQueue, touchLRU, removeLRU, getLRUTail,
  backupLRUToLocalStorage, restoreLRUFromLocalStorage,
  getGlobalStats, saveGlobalStats, getAllGlobalStats,
  saveAsset, getAsset, deleteAsset, getAllAssets,
  getTotalCacheSize, getCacheSizeByKind, getStorageEstimate,
  clearAll, clearByKind,
  _openDB as initDB
};

//=================================================
// FILE: /src/js/download-queue.js
/**
 * DownloadQueue ‚Äî –µ–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–¢–ó 14)
 * 1 –∞–∫—Ç–∏–≤–Ω–∞—è –∞—É–¥–∏–æ-–∑–∞–≥—Ä—É–∑–∫–∞, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã P0-P5
 * Background presets (–¢–ó 7.10.1)
 */

import { saveAudioBlob, getAudioEntry, saveTrackMeta, getTrackMeta, saveAsset,
         getTotalCacheSize, backupLRUToLocalStorage, getLRUQueue } from './cache-db.js';
import { isNetworkAllowedByPolicy, isNetworkUnknown, getMode, MODES } from './mode-manager.js';

// Priority constants (–¢–ó 14.2)
const PRIORITY = {
  P0_CUR: 0,
  P1_NEIGHBOR: 1,
  P2_PINNED: 2,
  P3_UPDATE: 3,
  P4_CLOUD: 4,
  P5_ASSET: 5,
  P6_FULL_OFFLINE: 6
};

// Background Presets (–¢–ó 7.10.1)
const BG_PRESETS = {
  conservative: { id: 'conservative', label: 'Conservative (iOS)', pauseBetweenMs: 3000, retryDelayMs: 10000, maxRetries: 3 },
  balanced:     { id: 'balanced',     label: 'Balanced (Android)', pauseBetweenMs: 1000, retryDelayMs: 5000,  maxRetries: 5 },
  aggressive:   { id: 'aggressive',   label: 'Aggressive (Desktop)', pauseBetweenMs: 200,  retryDelayMs: 3000,  maxRetries: 8 }
};

const BG_PROFILE_KEY = 'offline:bgProfile:v1';

let _queue = [];
let _isProcessing = false;
let _isPaused = false;
let _currentTask = null;
let _abortController = null;
let _listeners = [];

function _detectDefaultProfile() {
  const ua = navigator.userAgent || '';
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isMobile = /Android/i.test(ua) || isIOS;
  if (isIOS) return 'conservative';
  if (isMobile) return 'balanced';
  return 'aggressive';
}

function getBackgroundProfile() {
  const saved = localStorage.getItem(BG_PROFILE_KEY);
  if (saved && BG_PRESETS[saved]) return BG_PRESETS[saved];
  return BG_PRESETS[_detectDefaultProfile()];
}

function setBackgroundProfile(profileId) {
  if (BG_PRESETS[profileId]) {
    localStorage.setItem(BG_PROFILE_KEY, profileId);
  }
}

function getAvailableProfiles() {
  return Object.values(BG_PRESETS);
}

/**
 * Enqueue a download task
 * @param {Object} task - { uid, variant, url, priority, cacheKind, trackObj?, assetKey?, assetType? }
 */
function enqueue(task) {
  // Deduplicate: same uid+variant+cacheKind
  const exists = _queue.find(t =>
    t.uid === task.uid &&
    t.variant === task.variant &&
    t.cacheKind === task.cacheKind &&
    !t.assetKey
  );
  if (exists && !task.assetKey) {
    // Update priority if higher
    if (task.priority < exists.priority) {
      exists.priority = task.priority;
      _sortQueue();
    }
    return;
  }

  _queue.push({ ...task, retries: 0, addedAt: Date.now() });
  _sortQueue();
  _notify();
  _processNext();
}

function _sortQueue() {
  _queue.sort((a, b) => a.priority - b.priority);
}

/** Remove tasks for uid */
function dequeue(uid) {
  _queue = _queue.filter(t => t.uid !== uid);
  _notify();
}

/** Remove all tasks of a cacheKind */
function dequeueByKind(kind) {
  _queue = _queue.filter(t => t.cacheKind !== kind);
  _notify();
}

function pauseQueue() {
  _isPaused = true;
  _notify();
}

function resumeQueue() {
  _isPaused = false;
  _processNext();
  _notify();
}

function cancelCurrent() {
  if (_abortController) {
    _abortController.abort();
  }
}

async function _processNext() {
  if (_isProcessing || _isPaused || _queue.length === 0) return;

  // Check network policy
  if (!isNetworkAllowedByPolicy()) {
    // Wait and retry
    setTimeout(() => _processNext(), 5000);
    return;
  }

  _isProcessing = true;
  const task = _queue.shift();
  _currentTask = task;
  _notify();

  const profile = getBackgroundProfile();

  try {
    _abortController = new AbortController();

    if (task.assetKey) {
      // Asset download (covers, lyrics, etc.)
      await _downloadAsset(task, _abortController.signal);
    } else {
      // Audio download
      await _downloadAudio(task, _abortController.signal);
    }

    // Success ‚Äî pause between downloads
    await _sleep(profile.pauseBetweenMs);

  } catch (e) {
    if (e.name === 'AbortError') {
      console.log('[DownloadQueue] task aborted', task.uid);
    } else {
      console.error('[DownloadQueue] download failed', task.uid, e);
      task.retries = (task.retries || 0) + 1;
      if (task.retries < profile.maxRetries) {
        // Re-enqueue with backoff
        setTimeout(() => {
          _queue.push(task);
          _sortQueue();
          _processNext();
        }, profile.retryDelayMs * task.retries);
      } else {
        console.warn('[DownloadQueue] max retries reached for', task.uid);
      }
    }
  }

  _currentTask = null;
  _abortController = null;
  _isProcessing = false;
  _notify();
  _processNext();
}

async function _downloadAudio(task, signal) {
  const { uid, variant, url, cacheKind } = task;
  if (!url) throw new Error('No URL for download');

  // Check if already exists with same variant
  const existing = await getAudioEntry(uid);
  if (existing && existing.variant === variant) {
    // Already have this variant, update meta only
    const meta = await getTrackMeta(uid) || { uid };
    meta.cacheKind = cacheKind || meta.cacheKind;
    meta.cachedComplete = 100;
    meta.needsReCache = false;
    meta.needsUpdate = false;
    await saveTrackMeta(meta);
    _emitProgress(uid, 100);
    return;
  }

  const resp = await fetch(url, { signal });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

  const contentLength = parseInt(resp.headers.get('content-length') || '0', 10);
  const reader = resp.body.getReader();
  const chunks = [];
  let received = 0;

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    chunks.push(value);
    received += value.length;
    if (contentLength > 0) {
      _emitProgress(uid, Math.round((received / contentLength) * 100));
    }
  }

  const blob = new Blob(chunks, { type: 'audio/mpeg' });

  // –¢–ó 1.7: No duplicates ‚Äî saveAudioBlob handles replacement
  await saveAudioBlob(uid, variant, blob, cacheKind);

  // Update meta
  const meta = await getTrackMeta(uid) || { uid };
  meta.cachedVariant = variant;
  meta.cachedComplete = 100;
  meta.cacheKind = cacheKind || meta.cacheKind || 'dynamic';
  meta.needsReCache = false;
  meta.needsUpdate = false;
  meta.lastAccessAt = Date.now();
  await saveTrackMeta(meta);

  // Backup LRU to localStorage
  const lruQ = await getLRUQueue();
  backupLRUToLocalStorage(lruQ);

  _emitProgress(uid, 100);
  window.dispatchEvent(new CustomEvent('downloadComplete', { detail: { uid, variant, cacheKind } }));
}

async function _downloadAsset(task, signal) {
  const { assetKey, url, assetType } = task;
  if (!url) throw new Error('No URL for asset');

  const resp = await fetch(url, { signal });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  const blob = await resp.blob();
  await saveAsset(assetKey, blob, assetType || 'application/octet-stream');
}

function _emitProgress(uid, percent) {
  window.dispatchEvent(new CustomEvent('downloadProgress', { detail: { uid, percent } }));
}

function _sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

function _notify() {
  _listeners.forEach(fn => { try { fn(getStatus()); } catch(e) {} });
}

function onStatusChange(fn) { _listeners.push(fn); }
function offStatusChange(fn) { _listeners = _listeners.filter(f => f !== fn); }

function getStatus() {
  return {
    currentTask: _currentTask,
    queueLength: _queue.length,
    isPaused: _isPaused,
    isProcessing: _isProcessing,
    queue: _queue.slice()
  };
}

function getQueueLength() { return _queue.length; }

export {
  PRIORITY, BG_PRESETS,
  enqueue, dequeue, dequeueByKind,
  pauseQueue, resumeQueue, cancelCurrent,
  getBackgroundProfile, setBackgroundProfile, getAvailableProfiles,
  getStatus, getQueueLength,
  onStatusChange, offStatusChange
};

//=================================================
// FILE: /src/js/mode-manager.js
/**
 * ModeManager ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏ R0-R3 (–¢–ó 1.5)
 * R0 Streaming (default), R1 PlaybackCache-only, R2 Dynamic Offline, R3 100% OFFLINE
 */

const MODES = { R0: 'R0', R1: 'R1', R2: 'R2', R3: 'R3' };
const STORAGE_KEY = 'offline:mode:v1';
const PQ_KEY = 'qualityMode:v1';
const CQ_KEY = 'offline:cacheQuality:v1';
const FOQ_KEY = 'offline:fullOfflineQuality:v1';
const MIN_STORAGE_MB = 60;
const R1_BEFORE_R2_KEY = 'offline:r1BeforeR2:v1';

let _currentMode = MODES.R0;
let _listeners = [];

function _load() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved && Object.values(MODES).includes(saved)) {
    _currentMode = saved;
  } else {
    _currentMode = MODES.R0;
  }
}

function _save() {
  localStorage.setItem(STORAGE_KEY, _currentMode);
}

function _notify() {
  _listeners.forEach(fn => { try { fn(_currentMode); } catch(e) { console.error('[ModeManager] listener error', e); } });
}

/** Check if device can guarantee MIN_STORAGE_MB (–¢–ó 1.6) */
async function canGuaranteeStorage() {
  try {
    if (navigator.storage && navigator.storage.estimate) {
      const est = await navigator.storage.estimate();
      const freeMB = ((est.quota || 0) - (est.usage || 0)) / (1024 * 1024);
      return freeMB >= MIN_STORAGE_MB;
    }
    // Fallback: assume OK on desktop, warn on iOS
    return true;
  } catch(e) {
    console.warn('[ModeManager] storage estimate failed', e);
    return true; // optimistic
  }
}

function getMode() { return _currentMode; }

async function setMode(mode) {
  if (!Object.values(MODES).includes(mode)) {
    console.error('[ModeManager] invalid mode', mode);
    return false;
  }
  if (mode === _currentMode) return true;

  // R1/R2/R3 require 60MB (–¢–ó 1.6)
  if (mode !== MODES.R0) {
    const ok = await canGuaranteeStorage();
    if (!ok) {
      if (typeof window !== 'undefined' && window.showToast) {
        window.showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 60 –ú–ë.', 4000);
      }
      return false;
    }
  }

  // R3 mutual exclusion (–¢–ó 11.2.A.4)
  if (mode === MODES.R3) {
    // R3 disables R1/R2
  }

  const prev = _currentMode;
  _currentMode = mode;
  _save();

  // When entering R2, auto-sync CQ (–¢–ó 6.3)
  // When entering R3, CQ = FOQ (–¢–ó 5.3)
  if (mode === MODES.R3) {
    const foq = getFullOfflineQuality();
    setCacheQuality(foq);
  }

  _notify();
  console.log(`[ModeManager] ${prev} ‚Üí ${mode}`);
  return true;
}

/** –¢–ó 11.2.A.2: when enabling R2, remember R1 state */
function enableDynamicOffline() {
  const wasR1 = _currentMode === MODES.R1;
  localStorage.setItem(R1_BEFORE_R2_KEY, wasR1 ? '1' : '0');
  return setMode(MODES.R2);
}

/** –¢–ó 11.2.A.3: when disabling R2, restore R1 state */
function disableDynamicOffline() {
  const wasR1 = localStorage.getItem(R1_BEFORE_R2_KEY) === '1';
  localStorage.removeItem(R1_BEFORE_R2_KEY);
  return setMode(wasR1 ? MODES.R1 : MODES.R0);
}

// Quality getters/setters (–¢–ó 1.2)
function getPlaybackQuality() {
  return localStorage.getItem(PQ_KEY) || 'hi';
}
function setPlaybackQuality(q) {
  if (q !== 'hi' && q !== 'lo') return;
  localStorage.setItem(PQ_KEY, q);
  _notify();
}

function getCacheQuality() {
  return localStorage.getItem(CQ_KEY) || 'hi';
}
function setCacheQuality(q) {
  if (q !== 'hi' && q !== 'lo') return;
  const prev = getCacheQuality();
  localStorage.setItem(CQ_KEY, q);
  if (prev !== q) {
    // Trigger needsReCache for all cached tracks (–¢–ó 5.2)
    window.dispatchEvent(new CustomEvent('cacheQualityChanged', { detail: { from: prev, to: q } }));
  }
  _notify();
}

function getFullOfflineQuality() {
  return localStorage.getItem(FOQ_KEY) || 'hi';
}
function setFullOfflineQuality(q) {
  if (q !== 'hi' && q !== 'lo') return;
  localStorage.setItem(FOQ_KEY, q);
  // –¢–ó 5.3: CQ auto-syncs to FOQ
  setCacheQuality(q);
  _notify();
}

/** –¢–ó 6.3: ActivePlaybackQuality by mode */
function getActivePlaybackQuality() {
  switch (_currentMode) {
    case MODES.R0: return getPlaybackQuality();
    case MODES.R1: return getPlaybackQuality();
    case MODES.R2: return getCacheQuality();
    case MODES.R3: return getFullOfflineQuality();
    default: return getPlaybackQuality();
  }
}

/** Is network allowed for playback in current mode? */
function isNetworkAllowedForPlayback() {
  if (_currentMode === MODES.R3) return false;
  return isNetworkAllowedByPolicy();
}

/** Network policy (–¢–ó 11.2.D) */
function isNetworkAllowedByPolicy() {
  const wifiOk = localStorage.getItem('offline:net:wifi:v1') !== '0';
  const mobileOk = localStorage.getItem('offline:net:mobile:v1') !== '0';
  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  if (!conn) return true; // unknown = allowed (confirm for mass ops separately)
  const type = conn.type || conn.effectiveType || '';
  if (type === 'wifi') return wifiOk;
  if (['cellular', '2g', '3g', '4g', '5g'].includes(type)) return mobileOk;
  return true; // unknown
}

function isNetworkUnknown() {
  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  if (!conn) return true;
  const type = conn.type || '';
  return !['wifi', 'cellular', '2g', '3g', '4g', '5g', 'ethernet'].includes(type);
}

function onModeChange(fn) { _listeners.push(fn); }
function offModeChange(fn) { _listeners = _listeners.filter(f => f !== fn); }

// Init
_load();

export {
  MODES,
  getMode, setMode,
  enableDynamicOffline, disableDynamicOffline,
  getPlaybackQuality, setPlaybackQuality,
  getCacheQuality, setCacheQuality,
  getFullOfflineQuality, setFullOfflineQuality,
  getActivePlaybackQuality,
  isNetworkAllowedForPlayback, isNetworkAllowedByPolicy, isNetworkUnknown,
  canGuaranteeStorage,
  onModeChange, offModeChange,
  MIN_STORAGE_MB
};

//=================================================
// FILE: /src/js/offline-indicators.js
/**
 * Offline Indicators ‚Äî üîí/‚òÅ —Å–ª–µ–≤–∞ –æ—Ç –Ω–æ–º–µ—Ä–∞ —Ç—Ä–µ–∫–∞ (–¢–ó 10)
 * + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "!" –Ω–∞ –∫–Ω–æ–ø–∫–µ OFFLINE (–¢–ó 12)
 * + –∫–Ω–æ–ø–∫–∞ Hi/Lo visibility (–¢–ó 4.4)
 * + progress bar second layer (–¢–ó 15)
 */

import { getTrackOfflineState, getTrackMeta } from './cache-db.js';
import { getMode, MODES, onModeChange } from './mode-manager.js';
import { togglePinned, cloudAddPin, cloudRemoveFromCache, hasNeedsUpdateOrReCache } from './offline-manager.js';

let _updateThrottle = null;

function init() {
  _bindEvents();
  _updateAllIndicators();
  _updateOfflineBtnIndicator();
  _updateQualityBtnVisibility();
}

function _bindEvents() {
  window.addEventListener('offlineStateChanged', () => {
    _scheduleUpdate();
  });

  window.addEventListener('needsUpdateChanged', () => {
    _updateOfflineBtnIndicator();
  });

  window.addEventListener('downloadComplete', () => {
    _scheduleUpdate();
  });

  window.addEventListener('downloadProgress', (e) => {
    _updateCacheProgress(e.detail.uid, e.detail.percent);
  });

  onModeChange(() => {
    _updateQualityBtnVisibility();
    _updateAllIndicators();
  });

  // Listen for track list renders
  const observer = new MutationObserver(() => {
    _scheduleUpdate();
  });

  // Observe track lists
  setTimeout(() => {
    const containers = document.querySelectorAll('.track-list, .favorites-list, [data-track-list]');
    containers.forEach(c => {
      observer.observe(c, { childList: true, subtree: true });
    });
  }, 1000);
}

function _scheduleUpdate() {
  if (_updateThrottle) return;
  _updateThrottle = setTimeout(() => {
    _updateThrottle = null;
    _updateAllIndicators();
  }, 300);
}

// ===================== TRACK INDICATORS (–¢–ó 10) =====================

async function _updateAllIndicators() {
  const trackRows = document.querySelectorAll('[data-uid]');
  for (const row of trackRows) {
    const uid = row.dataset.uid;
    if (!uid) continue;
    await _updateTrackIndicator(row, uid);
  }
}

async function _updateTrackIndicator(row, uid) {
  let indicator = row.querySelector('.offline-indicator');

  if (!indicator) {
    indicator = document.createElement('span');
    indicator.className = 'offline-indicator';
    // Insert before first child (left of track number)
    const firstChild = row.firstElementChild;
    if (firstChild) {
      row.insertBefore(indicator, firstChild);
    } else {
      row.appendChild(indicator);
    }
  }

  const state = await getTrackOfflineState(uid);

  if (state.pinned) {
    indicator.textContent = 'üîí';
    indicator.className = 'offline-indicator oi-pinned';
    indicator.title = '–ó–∞–∫—Ä–µ–ø–ª—ë–Ω –æ—Ñ–ª–∞–π–Ω';
    indicator.onclick = (e) => {
      e.stopPropagation();
      togglePinned(uid, false);
    };
  } else if (state.cloud && state.cachedComplete === 100) {
    indicator.textContent = '‚òÅ';
    indicator.className = 'offline-indicator oi-cloud';
    indicator.title = '–û—Ñ–ª–∞–π–Ω (–æ–±–ª–∞—á–∫–æ)';
    indicator.onclick = (e) => {
      e.stopPropagation();
      _showCloudMenu(uid, indicator);
    };
  } else {
    indicator.textContent = 'üîí';
    indicator.className = 'offline-indicator oi-gray';
    indicator.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –æ—Ñ–ª–∞–π–Ω';
    indicator.onclick = (e) => {
      e.stopPropagation();
      togglePinned(uid, true);
    };
  }
}

function _showCloudMenu(uid, anchor) {
  // Remove any existing menu
  const existing = document.getElementById('cloud-context-menu');
  if (existing) existing.remove();

  const menu = document.createElement('div');
  menu.id = 'cloud-context-menu';
  menu.className = 'cloud-menu';

  const rect = anchor.getBoundingClientRect();
  menu.style.position = 'fixed';
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 4) + 'px';
  menu.style.zIndex = '9999';

  menu.innerHTML = `
    <div class="cloud-menu-item" data-cm-act="pin">–î–æ–±–∞–≤–∏—Ç—å üîí</div>
    <div class="cloud-menu-item cloud-menu-danger" data-cm-act="remove">–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞</div>
  `;

  document.body.appendChild(menu);

  menu.addEventListener('click', async (e) => {
    const act = e.target.dataset.cmAct;
    if (act === 'pin') {
      await cloudAddPin(uid);
    } else if (act === 'remove') {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞? (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–ª–∞—á–∫–∞ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–∞)')) {
        await cloudRemoveFromCache(uid);
      }
    }
    menu.remove();
  });

  // Close on outside click
  const closeHandler = (e) => {
    if (!menu.contains(e.target)) {
      menu.remove();
      document.removeEventListener('click', closeHandler);
    }
  };
  setTimeout(() => document.addEventListener('click', closeHandler), 10);
}

// ===================== OFFLINE BTN INDICATOR "!" (–¢–ó 12) =====================

async function _updateOfflineBtnIndicator() {
  const btn = document.getElementById('offline-btn');
  if (!btn) return;

  const has = await hasNeedsUpdateOrReCache();
  let bang = btn.querySelector('.offline-bang');

  if (has) {
    if (!bang) {
      bang = document.createElement('span');
      bang.className = 'offline-bang';
      bang.textContent = '!';
      bang.title = '–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
      btn.style.position = 'relative';
      btn.insertBefore(bang, btn.firstChild);
    }
    bang.onclick = (e) => {
      e.stopPropagation();
      if (window.showToast) window.showToast('–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.', 6000);
    };
  } else {
    if (bang) bang.remove();
  }
}

// ===================== QUALITY BUTTON VISIBILITY (–¢–ó 4.4) =====================

function _updateQualityBtnVisibility() {
  const btn = document.getElementById('quality-btn');
  if (!btn) return;

  const mode = getMode();
  if (mode === MODES.R2 || mode === MODES.R3) {
    btn.style.display = 'none';
  } else {
    btn.style.display = '';
  }
}

// ===================== CACHE PROGRESS (–¢–ó 15) =====================

function _updateCacheProgress(uid, percent) {
  const progressBar = document.getElementById('cache-progress-layer');
  if (!progressBar) return;

  // Only show for current track
  const curUid = progressBar.dataset.curUid;
  if (curUid && curUid !== uid) return;

  progressBar.style.width = percent + '%';
}

function setCacheProgressTrack(uid) {
  const progressBar = document.getElementById('cache-progress-layer');
  if (progressBar) {
    progressBar.dataset.curUid = uid;
    // Reset on new track
    const mode = getMode();
    if (mode === MODES.R3) {
      progressBar.style.width = '100%';
    } else {
      progressBar.style.width = '0%';
    }
  }
}

export { init, setCacheProgressTrack };

//=================================================
// FILE: /src/js/offline-manager.js
/**
 * OfflineManager ‚Äî —Ü–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ñ–ª–∞–π–Ω-—Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ (–¢–ó 19.2)
 * Pinned/Cloud, Dynamic Cache, eviction, updates, re-cache, 100% OFFLINE
 */

import {
  getTrackMeta, saveTrackMeta, getAllTrackMetas, deleteTrackMeta,
  getAudioEntry, deleteAudioBlob, getTrackOfflineState,
  getTotalCacheSize, getCacheSizeByKind, getStorageEstimate,
  touchLRU, removeLRU, getLRUQueue, saveLRUQueue,
  backupLRUToLocalStorage, restoreLRUFromLocalStorage,
  clearAll, clearByKind, getAllAudioEntries,
  saveAsset, getAsset, getAllAssets, deleteAsset
} from './cache-db.js';

import {
  getMode, setMode, MODES,
  getCacheQuality, getFullOfflineQuality,
  isNetworkAllowedByPolicy, isNetworkUnknown,
  canGuaranteeStorage
} from './mode-manager.js';

import { resetCloudStats } from './stats-core.js';
import { enqueue, dequeue, dequeueByKind, pauseQueue, resumeQueue, PRIORITY, getStatus as getQueueStatus } from './download-queue.js';
import { resolveVariantUrl, getTrackSize, hasVariant } from './track-resolver.js';

const CACHE_LIMIT_KEY = 'offline:cacheLimit:v1';
const CACHE_LIMIT_MODE_KEY = 'offline:cacheLimitMode:v1';
const FULL_OFFLINE_SEL_KEY = 'offline:fullOfflineSelection:v1';
const FULL_OFFLINE_ASSETS_KEY = 'offline:fullOfflineAssets:v1';
const FULL_OFFLINE_READY_KEY = 'offline:fullOfflineReady:v1';
const DEFAULT_SIZE_HI_MB = 8;
const DEFAULT_SIZE_LO_MB = 3;
const AUTO_LIMIT_PERCENT = 0.5;

let _allTracks = [];
let _albumsData = [];
let _baseUrl = '';
let _protectedWindow = new Set(); // protected playback window uids

function _defaultMeta(uid) {
  return {
    uid,
    pinned: false,
    cloud: false,
    cacheKind: 'none',
    cachedVariant: null,
    cachedComplete: 0,
    needsUpdate: false,
    needsReCache: false,
    cloudFullListenCount: 0,
    lastFullListenAt: null,
    cloudAddedAt: null,
    cloudExpiresAt: null,
    fullOfflineIncluded: false,
    lastAccessAt: null
  };
}

function _findTrack(uid) {
  return _allTracks.find(t => t.uid === uid) || null;
}

function _showToast(msg, dur) {
  if (typeof window !== 'undefined' && window.showToast) {
    window.showToast(msg, dur || 3000);
  }
}

// ===================== INIT =====================

function init(allTracks, albumsData, baseUrl) {
  _allTracks = allTracks || [];
  _albumsData = albumsData || [];
  _baseUrl = baseUrl || '';
  _checkExpiredCloud();
  _checkLRUBackup();
  _listenEvents();
}

function _listenEvents() {
  window.addEventListener('cacheQualityChanged', (e) => {
    _handleCacheQualityChange(e.detail.from, e.detail.to);
  });
  window.addEventListener('cloudTriggered', (e) => {
    _handleCloudTriggered(e.detail.uid);
  });
}

// ===================== CACHE LIMIT (–¢–ó 11.2.E) =====================

function getCacheLimitMode() {
  return localStorage.getItem(CACHE_LIMIT_MODE_KEY) || 'auto';
}

function setCacheLimitMode(mode) {
  localStorage.setItem(CACHE_LIMIT_MODE_KEY, mode);
}

function getCacheLimit() {
  const mode = getCacheLimitMode();
  if (mode === 'manual') {
    const v = parseInt(localStorage.getItem(CACHE_LIMIT_KEY) || '0', 10);
    return v > 0 ? v * 1024 * 1024 : 500 * 1024 * 1024;
  }
  return _getAutoLimit();
}

function setCacheLimitManual(mb) {
  localStorage.setItem(CACHE_LIMIT_KEY, String(mb));
  setCacheLimitMode('manual');
}

async function _getAutoLimit() {
  try {
    const est = await getStorageEstimate();
    if (est.quota > 0) {
      return Math.floor(est.quota * AUTO_LIMIT_PERCENT);
    }
  } catch (e) {}
  return 500 * 1024 * 1024;
}

// ===================== PINNED (–¢–ó 8) =====================

async function togglePinned(uid, onOff) {
  let meta = await getTrackMeta(uid);
  if (!meta) meta = _defaultMeta(uid);
  const newVal = onOff !== undefined ? !!onOff : !meta.pinned;
  if (newVal === meta.pinned) return meta;

  if (newVal) {
    meta.pinned = true;
    meta.cacheKind = 'pinned';
    await saveTrackMeta(meta);

    const cq = getCacheQuality();
    const track = _findTrack(uid);
    const url = track ? resolveVariantUrl(track, cq, _baseUrl) : null;
    if (url) {
      enqueue({ uid, variant: cq, url, priority: PRIORITY.P2_PINNED, cacheKind: 'pinned' });
    }
    _showToast('–¢—Ä–µ–∫ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ñ–ª–∞–π–Ω. –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ‚Ä¶');
  } else {
    // –¢–ó 8.2+8.3: unpin ‚Üí cloud candidate
    meta.pinned = false;
    meta.cloud = true;
    meta.cacheKind = 'cloud';
    const D = parseInt(localStorage.getItem('offline:cloudD:v1') || '31', 10);
    if (!meta.cloudAddedAt) meta.cloudAddedAt = Date.now();
    meta.cloudExpiresAt = Date.now() + D * 86400000;
    await saveTrackMeta(meta);
    _showToast('–û—Ñ–ª–∞–π–Ω-–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–Ω—è—Ç–æ. –¢—Ä–µ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª—ë–Ω –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞.');
  }

  _dispatchStateChange(uid);
  return meta;
}

// ===================== CLOUD MENU (–¢–ó 9.5) =====================

async function cloudAddPin(uid) {
  let meta = await getTrackMeta(uid);
  if (!meta) return;
  meta.pinned = true;
  meta.cacheKind = 'pinned';
  await saveTrackMeta(meta);
  _dispatchStateChange(uid);
}

async function cloudRemoveFromCache(uid) {
  await deleteAudioBlob(uid);
  await resetCloudStats(uid);
  let meta = await getTrackMeta(uid);
  if (!meta) meta = _defaultMeta(uid);
  meta.cloud = false;
  meta.pinned = false;
  meta.cacheKind = 'none';
  meta.cachedVariant = null;
  meta.cachedComplete = 0;
  meta.needsUpdate = false;
  meta.needsReCache = false;
  await saveTrackMeta(meta);
  await removeLRU(uid);
  _dispatchStateChange(uid);
  _showToast('–¢—Ä–µ–∫ —É–¥–∞–ª—ë–Ω –∏–∑ –∫—ç—à–∞.');
}

// ===================== DYNAMIC CACHE (–¢–ó 7.14) =====================

async function onTrackPlayed(uid) {
  const mode = getMode();
  if (mode !== MODES.R2) return;

  await touchLRU(uid);

  const entry = await getAudioEntry(uid);
  const cq = getCacheQuality();
  if (entry && entry.variant === cq) return;

  const limitOk = await _evictIfNeeded(uid);
  if (!limitOk) return;

  const track = _findTrack(uid);
  const url = track ? resolveVariantUrl(track, cq, _baseUrl) : null;
  if (url) {
    enqueue({ uid, variant: cq, url, priority: PRIORITY.P4_CLOUD, cacheKind: 'dynamic' });
  }

  const queue = await getLRUQueue();
  backupLRUToLocalStorage(queue);
}

async function _evictIfNeeded(newUid) {
  let limit;
  try { limit = await getCacheLimit(); } catch(e) { limit = getCacheLimit(); }
  if (typeof limit === 'object' && limit.then) limit = await limit;

  const totalSize = await getTotalCacheSize();
  const newTrack = _findTrack(newUid);
  const cq = getCacheQuality();
  const estimatedSize = newTrack
    ? (getTrackSize(newTrack, cq) || DEFAULT_SIZE_HI_MB) * 1024 * 1024
    : DEFAULT_SIZE_HI_MB * 1024 * 1024;

  if (totalSize + estimatedSize <= limit) return true;

  const queue = await getLRUQueue();
  const allMetas = await getAllTrackMetas();
  const metaMap = {};
  allMetas.forEach(m => { metaMap[m.uid] = m; });

  let freed = 0;
  const toEvict = [];

  for (let i = queue.length - 1; i >= 0 && (totalSize + estimatedSize - freed > limit); i--) {
    const evictUid = queue[i];
    if (evictUid === newUid) continue;
    if (_protectedWindow.has(evictUid)) continue;
    const m = metaMap[evictUid];
    if (m && (m.pinned || m.cloud)) continue;
    const audioEntry = await getAudioEntry(evictUid);
    if (audioEntry) {
      freed += audioEntry.size || 0;
      toEvict.push(evictUid);
    }
  }

  if (toEvict.length === 0 && totalSize + estimatedSize > limit) {
    // –¢–ó 7.14.6: pinned+cloud fill the limit
    const breakdown = await getCacheSizeByKind();
    if (breakdown.pinned + breakdown.cloud >= limit) {
      _showToast('Pinned/Cloud –∑–∞–Ω–∏–º–∞—é—Ç –≤–µ—Å—å –ª–∏–º–∏—Ç. –£–≤–µ–ª–∏—á—å—Ç–µ –ª–∏–º–∏—Ç –∏–ª–∏ —Å–Ω–∏–º–∏—Ç–µ üîí/‚òÅ.', 5000);
      return false;
    }
  }

  for (const evictUid of toEvict) {
    await deleteAudioBlob(evictUid);
    await removeLRU(evictUid);
    const m = metaMap[evictUid];
    if (m && m.cacheKind === 'dynamic') {
      m.cacheKind = 'none';
      m.cachedVariant = null;
      m.cachedComplete = 0;
      await saveTrackMeta(m);
    }
  }

  if (toEvict.length > 0) {
    _showToast('–ö—ç—à –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω. –£–¥–∞–ª–µ–Ω—ã —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ç—Ä–µ–∫–∏.');
  }

  return true;
}

// ===================== CLOUD TTL CHECK (–¢–ó 9.4) =====================

async function _checkExpiredCloud() {
  try {
    const metas = await getAllTrackMetas();
    const now = Date.now();
    for (const m of metas) {
      if (m.cloud && m.cloudExpiresAt && m.cloudExpiresAt < now) {
        await deleteAudioBlob(m.uid);
        m.cloud = false;
        m.cacheKind = 'none';
        m.cachedVariant = null;
        m.cachedComplete = 0;
        m.cloudFullListenCount = 0;
        m.cloudAddedAt = null;
        m.cloudExpiresAt = null;
        m.lastFullListenAt = null;
        await saveTrackMeta(m);
        await removeLRU(m.uid);
        _showToast('–û—Ñ–ª–∞–π–Ω-–¥–æ—Å—Ç—É–ø –∏—Å—Ç—ë–∫. –¢—Ä–µ–∫ —É–¥–∞–ª—ë–Ω –∏–∑ –∫—ç—à–∞.');
        _dispatchStateChange(m.uid);
      }
    }
  } catch (e) {
    console.error('[OfflineManager] cloud expiry check error', e);
  }
}

// ===================== LRU BACKUP RESTORE =====================

async function _checkLRUBackup() {
  try {
    const queue = await getLRUQueue();
    if (queue.length === 0) {
      const backup = restoreLRUFromLocalStorage();
      if (backup.length > 0) {
        await saveLRUQueue(backup);
        console.log('[OfflineManager] restored LRU queue from backup:', backup.length);
      }
    }
  } catch (e) {
    console.error('[OfflineManager] LRU backup restore error', e);
  }
}

// ===================== CACHE QUALITY CHANGE (–¢–ó 5.2) =====================

async function _handleCacheQualityChange(fromQ, toQ) {
  const metas = await getAllTrackMetas();
  const priorities = { pinned: 1, cloud: 2, dynamic: 3, playbackWindow: 4 };

  const toReCache = metas
    .filter(m => m.cachedVariant && m.cachedVariant !== toQ &&
      ['pinned', 'cloud', 'dynamic', 'playbackWindow'].includes(m.cacheKind))
    .sort((a, b) => (priorities[a.cacheKind] || 99) - (priorities[b.cacheKind] || 99));

  for (const m of toReCache) {
    m.needsReCache = true;
    await saveTrackMeta(m);

    const track = _findTrack(m.uid);
    const url = track ? resolveVariantUrl(track, toQ, _baseUrl) : null;
    if (url) {
      enqueue({
        uid: m.uid, variant: toQ, url,
        priority: PRIORITY.P3_UPDATE,
        cacheKind: m.cacheKind
      });
    }
  }

  _dispatchNeedsUpdate();
}

// ===================== CLOUD TRIGGERED =====================

async function _handleCloudTriggered(uid) {
  const cq = getCacheQuality();
  const entry = await getAudioEntry(uid);
  if (entry && entry.variant === cq) {
    const meta = await getTrackMeta(uid);
    if (meta) {
      meta.cachedComplete = 100;
      meta.cacheKind = 'cloud';
      await saveTrackMeta(meta);
      _dispatchStateChange(uid);
      _showToast(`–¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—Ñ–ª–∞–π–Ω –Ω–∞ ${localStorage.getItem('offline:cloudD:v1') || 31} –¥–µ–Ω—å.`);
    }
    return;
  }

  const track = _findTrack(uid);
  const url = track ? resolveVariantUrl(track, cq, _baseUrl) : null;
  if (url) {
    enqueue({ uid, variant: cq, url, priority: PRIORITY.P4_CLOUD, cacheKind: 'cloud' });
  }
}

// ===================== UPDATES DETECTION (–¢–ó 13) =====================

async function checkForUpdates(remoteTracks) {
  const metas = await getAllTrackMetas();
  let hasUpdates = false;

  for (const m of metas) {
    if (m.cacheKind === 'none' || !m.cachedVariant) continue;
    const remote = remoteTracks.find(t => t.uid === m.uid);
    if (!remote) continue;

    const variant = m.cachedVariant;
    const remoteSize = variant === 'lo'
      ? (remote.size_low || DEFAULT_SIZE_LO_MB)
      : (remote.size || DEFAULT_SIZE_HI_MB);
    const entry = await getAudioEntry(m.uid);
    const localSizeMB = entry ? entry.size / (1024 * 1024) : 0;

    if (Math.abs(localSizeMB - remoteSize) > 0.1) {
      m.needsUpdate = true;
      await saveTrackMeta(m);
      hasUpdates = true;

      if (['pinned', 'cloud', 'fullOffline'].includes(m.cacheKind)) {
        const url = resolveVariantUrl(remote, variant, _baseUrl);
        if (url) {
          enqueue({
            uid: m.uid, variant, url,
            priority: PRIORITY.P3_UPDATE,
            cacheKind: m.cacheKind
          });
        }
      }
    }
  }

  if (hasUpdates) _dispatchNeedsUpdate();
  return hasUpdates;
}

async function updateAllFiles() {
  const metas = await getAllTrackMetas();
  const toUpdate = metas.filter(m =>
    (m.needsUpdate || m.needsReCache) &&
    ['pinned', 'cloud', 'fullOffline'].includes(m.cacheKind)
  );

  for (const m of toUpdate) {
    const track = _findTrack(m.uid);
    if (!track) continue;
    const variant = m.needsReCache ? getCacheQuality() : m.cachedVariant;
    const url = resolveVariantUrl(track, variant, _baseUrl);
    if (url) {
      enqueue({
        uid: m.uid, variant, url,
        priority: PRIORITY.P3_UPDATE,
        cacheKind: m.cacheKind
      });
    }
  }

  return toUpdate.length;
}

// ===================== PLAYBACK WINDOW PROTECTION =====================

function protectWindow(uids) {
  _protectedWindow = new Set(uids);
}

function unprotectWindow() {
  _protectedWindow.clear();
}

function isProtected(uid) {
  return _protectedWindow.has(uid);
}

// ===================== CLEAR CACHE (–¢–ó 11.2.H) =====================

async function clearCacheByCategory(category) {
  return clearByKind(category);
}

async function clearAllCache() {
  await clearAll();
  _showToast('–í–µ—Å—å –∫—ç—à –æ—á–∏—â–µ–Ω.');
}

// ===================== SIZE ESTIMATES (–¢–ó 11.2.I.4) =====================

function computeSizeEstimate(uids, variant, includeCovers, includeGallery) {
  let audioMB = 0;
  let coversMB = 0;
  let lyricsMB = 0;

  for (const uid of uids) {
    const track = _findTrack(uid);
    if (!track) continue;
    audioMB += getTrackSize(track, variant);
    lyricsMB += 0.01;
    if (includeCovers) coversMB += 0.3;
    if (includeGallery) coversMB += 1.0;
  }

  return {
    tracks: uids.length,
    audioMB: Math.round(audioMB * 10) / 10,
    coversMB: Math.round(coversMB * 10) / 10,
    lyricsMB: Math.round(lyricsMB * 10) / 10,
    totalMB: Math.round((audioMB + coversMB + lyricsMB) * 10) / 10
  };
}

// ===================== 100% OFFLINE (–¢–ó 11.2.I) =====================

function getFullOfflineSelection() {
  try {
    const raw = localStorage.getItem(FULL_OFFLINE_SEL_KEY);
    return raw ? JSON.parse(raw) : { favorites: false, albums: [], uids: [] };
  } catch (e) { return { favorites: false, albums: [], uids: [] }; }
}

function setFullOfflineSelection(sel) {
  localStorage.setItem(FULL_OFFLINE_SEL_KEY, JSON.stringify(sel));
}

function getFullOfflineAssets() {
  try {
    const raw = localStorage.getItem(FULL_OFFLINE_ASSETS_KEY);
    return raw ? JSON.parse(raw) : { covers: true, gallery: false };
  } catch (e) { return { covers: true, gallery: false }; }
}

function setFullOfflineAssets(assets) {
  localStorage.setItem(FULL_OFFLINE_ASSETS_KEY, JSON.stringify(assets));
}

function isFullOfflineReady() {
  return localStorage.getItem(FULL_OFFLINE_READY_KEY) === '1';
}

function _setFullOfflineReady(v) {
  localStorage.setItem(FULL_OFFLINE_READY_KEY, v ? '1' : '0');
}

/** Resolve the full set of uids for 100% OFFLINE including pinned/cloud auto-add (–¢–ó 11.2.I.9) */
function resolveFullOfflineUids(selection, favUids) {
  const uidSet = new Set();

  if (selection.favorites && favUids) {
    favUids.forEach(uid => uidSet.add(uid));
  }

  if (selection.albums && selection.albums.length > 0) {
    for (const albumId of selection.albums) {
      const album = _albumsData.find(a => a.id === albumId || a.prefix === albumId);
      if (album && album.tracks) {
        album.tracks.forEach(t => { if (t.uid) uidSet.add(t.uid); });
      }
    }
  }

  if (selection.uids) {
    selection.uids.forEach(uid => uidSet.add(uid));
  }

  return Array.from(uidSet);
}

/** Auto-add pinned/cloud to 100% OFFLINE set (–¢–ó 8.4, 9.6) */
async function autoAddPinnedCloudToFullOffline(uidSet) {
  const metas = await getAllTrackMetas();
  for (const m of metas) {
    if (m.pinned || m.cloud) {
      uidSet.add(m.uid);
    }
  }
  return uidSet;
}

/** Start full offline download (–¢–ó 11.2.I.5) */
async function startFullOfflineDownload(selection, favUids) {
  const canStore = await canGuaranteeStorage();
  if (!canStore) {
    _showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 60 –ú–ë.', 4000);
    return false;
  }

  if (isNetworkUnknown()) {
    const proceed = await _confirmUnknownNetwork();
    if (!proceed) return false;
  }

  const foq = getFullOfflineQuality();
  let uids = resolveFullOfflineUids(selection, favUids);
  const uidSet = new Set(uids);
  await autoAddPinnedCloudToFullOffline(uidSet);
  uids = Array.from(uidSet);

  setFullOfflineSelection(selection);
  _setFullOfflineReady(false);

  const assets = getFullOfflineAssets();
  let enqueued = 0;

  for (const uid of uids) {
    const track = _findTrack(uid);
    if (!track) continue;

    let meta = await getTrackMeta(uid);
    if (!meta) meta = _defaultMeta(uid);
    meta.fullOfflineIncluded = true;
    await saveTrackMeta(meta);

    const entry = await getAudioEntry(uid);
    if (!entry || entry.variant !== foq) {
      const url = resolveVariantUrl(track, foq, _baseUrl);
      if (url) {
        enqueue({
          uid, variant: foq, url,
          priority: PRIORITY.P6_FULL_OFFLINE,
          cacheKind: 'fullOffline'
        });
        enqueued++;
      }
    }

    if (track.lyrics) {
      enqueue({
        uid, url: _baseUrl ? `${_baseUrl}/${track.lyrics}` : track.lyrics,
        priority: PRIORITY.P5_ASSET,
        cacheKind: 'fullOffline',
        assetKey: `lyrics:${uid}`,
        assetType: 'text/plain'
      });
    }

    if (assets.covers && track.cover) {
      enqueue({
        uid, url: _baseUrl ? `${_baseUrl}/${track.cover}` : track.cover,
        priority: PRIORITY.P5_ASSET,
        cacheKind: 'fullOffline',
        assetKey: `cover:${uid}`,
        assetType: 'image/jpeg'
      });
    }
  }

  // Listen for completion
  _watchFullOfflineCompletion(uids);

  return { enqueued, totalTracks: uids.length };
}

let _fullOfflineWatcher = null;

function _watchFullOfflineCompletion(uids) {
  if (_fullOfflineWatcher) {
    window.removeEventListener('downloadComplete', _fullOfflineWatcher);
  }

  const remaining = new Set(uids);

  _fullOfflineWatcher = async (e) => {
    const { uid } = e.detail;
    remaining.delete(uid);

    window.dispatchEvent(new CustomEvent('fullOfflineProgress', {
      detail: { done: uids.length - remaining.size, total: uids.length }
    }));

    if (remaining.size === 0) {
      window.removeEventListener('downloadComplete', _fullOfflineWatcher);
      _fullOfflineWatcher = null;
      _setFullOfflineReady(true);
      window.dispatchEvent(new CustomEvent('fullOfflineComplete', {
        detail: { totalTracks: uids.length }
      }));
    }
  };

  window.addEventListener('downloadComplete', _fullOfflineWatcher);
}

/** Activate R3 after user confirms (–¢–ó 11.2.I.7) */
async function activateFullOffline() {
  if (!isFullOfflineReady()) {
    _showToast('–ó–∞–≥—Ä—É–∑–∫–∞ 100% OFFLINE –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.');
    return false;
  }
  return setMode(MODES.R3);
}

/** Deactivate R3 */
async function deactivateFullOffline() {
  return setMode(MODES.R0);
}

/** Check if uid is in full offline set */
async function isInFullOfflineSet(uid) {
  const meta = await getTrackMeta(uid);
  return meta && (meta.fullOfflineIncluded || meta.pinned || meta.cloud);
}

/** Remove track from 100% OFFLINE (–¢–ó 11.2.I.11) */
async function removeFromFullOffline(uid) {
  const meta = await getTrackMeta(uid);
  if (!meta) return false;
  if (meta.pinned) {
    _showToast('–°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∏—Ç–µ üîí, –∑–∞—Ç–µ–º —É–¥–∞–ª–∏—Ç–µ –∏–∑ 100% OFFLINE.');
    return false;
  }
  meta.fullOfflineIncluded = false;
  if (meta.cacheKind === 'fullOffline') {
    meta.cacheKind = 'none';
  }
  await saveTrackMeta(meta);
  _dispatchStateChange(uid);
  return true;
}

// ===================== NEEDS UPDATE INDICATOR (–¢–ó 12) =====================

async function hasNeedsUpdateOrReCache() {
  const metas = await getAllTrackMetas();
  return metas.some(m => m.needsUpdate || m.needsReCache);
}

function _dispatchNeedsUpdate() {
  window.dispatchEvent(new CustomEvent('needsUpdateChanged'));
}

function _dispatchStateChange(uid) {
  window.dispatchEvent(new CustomEvent('offlineStateChanged', { detail: { uid } }));
}

// ===================== CONFIRM UNKNOWN NETWORK =====================

function _confirmUnknownNetwork() {
  return new Promise(resolve => {
    if (typeof window !== 'undefined' && window.confirm) {
      resolve(window.confirm('–¢–∏–ø —Å–µ—Ç–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'));
    } else {
      resolve(true);
    }
  });
}

// ===================== GETTERS / STATE =====================

async function getBreakdown() {
  return getCacheSizeByKind();
}

function getAllTracks() { return _allTracks; }
function getAlbumsData() { return _albumsData; }
function getBaseUrl() { return _baseUrl; }

export {
  init,
  togglePinned, cloudAddPin, cloudRemoveFromCache,
  onTrackPlayed,
  checkForUpdates, updateAllFiles,
  protectWindow, unprotectWindow, isProtected,
  clearCacheByCategory, clearAllCache,
  computeSizeEstimate,
  getFullOfflineSelection, setFullOfflineSelection,
  getFullOfflineAssets, setFullOfflineAssets,
  resolveFullOfflineUids, autoAddPinnedCloudToFullOffline,
  startFullOfflineDownload, activateFullOffline, deactivateFullOffline,
  isFullOfflineReady, isInFullOfflineSet, removeFromFullOffline,
  hasNeedsUpdateOrReCache,
  getCacheLimit, getCacheLimitMode, setCacheLimitMode, setCacheLimitManual,
  getBreakdown,
  getAllTracks, getAlbumsData, getBaseUrl,
  _checkExpiredCloud
};

//=================================================
// FILE: /src/js/offline-modal.js
/**
 * OFFLINE Modal ‚Äî –¢–ó 11.2 —Å–µ–∫—Ü–∏–∏ A‚ÄìI
 */

import {
  getMode, setMode, MODES,
  getCacheQuality, setCacheQuality,
  getFullOfflineQuality, setFullOfflineQuality,
  enableDynamicOffline, disableDynamicOffline,
  canGuaranteeStorage, onModeChange
} from './mode-manager.js';

import {
  togglePinned,
  getCacheLimit, getCacheLimitMode, setCacheLimitMode, setCacheLimitManual,
  getBreakdown, updateAllFiles,
  clearCacheByCategory, clearAllCache,
  computeSizeEstimate, getFullOfflineSelection, setFullOfflineSelection,
  getFullOfflineAssets, setFullOfflineAssets,
  startFullOfflineDownload, activateFullOffline, deactivateFullOffline,
  isFullOfflineReady, removeFromFullOffline,
  hasNeedsUpdateOrReCache, getAllTracks, getAlbumsData
} from './offline-manager.js';

import {
  getStatus as getQueueStatus, pauseQueue, resumeQueue,
  getBackgroundProfile, setBackgroundProfile, getAvailableProfiles,
  onStatusChange, offStatusChange
} from './download-queue.js';

import { getStorageEstimate, getAllTrackMetas } from './cache-db.js';

let _modal = null;
let _isOpen = false;
let _dlPollTimer = null;

function _toast(msg, d) { if (window.showToast) window.showToast(msg, d || 3000); }

// ===================== PUBLIC =====================

function init() {
  _ensureDOM();
  _bindGlobal();
}

function open() {
  _ensureDOM();
  _modal.style.display = 'flex';
  _isOpen = true;
  _refreshAll();
  _dlPollTimer = setInterval(_refreshDownloads, 2000);
}

function close() {
  if (_modal) _modal.style.display = 'none';
  _isOpen = false;
  if (_dlPollTimer) { clearInterval(_dlPollTimer); _dlPollTimer = null; }
}

function isOpen() { return _isOpen; }

// ===================== DOM =====================

function _ensureDOM() {
  if (_modal) return;
  _modal = document.createElement('div');
  _modal.id = 'offline-modal-v2';
  _modal.className = 'ofl-overlay';
  _modal.style.display = 'none';
  _modal.innerHTML = _html();
  document.body.appendChild(_modal);
  _bind();
}

function _html() {
  return `
<div class="ofl-content">
  <div class="ofl-hdr"><h2>OFFLINE</h2><button class="ofl-close" data-act="close">‚úï</button></div>
  <div class="ofl-body">

    <section class="ofl-sec">
      <h3>–†–µ–∂–∏–º—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
      <div class="ofl-row"><span>PlaybackCache (3 —Ç—Ä–µ–∫–∞)</span>
        <label class="ofl-sw"><input type="checkbox" id="ofl-r1"><span class="ofl-sl"></span></label></div>
      <div class="ofl-row"><span>Dynamic Offline</span>
        <label class="ofl-sw"><input type="checkbox" id="ofl-r2"><span class="ofl-sl"></span></label></div>
      <p class="ofl-hint" id="ofl-mode-hint"></p>
    </section>

    <section class="ofl-sec">
      <h3>–ö–∞—á–µ—Å—Ç–≤–æ –∫—ç—à–∞</h3>
      <div class="ofl-rr">
        <label class="ofl-rl"><input type="radio" name="ofl-cq" value="hi" id="ofl-cq-hi"><span>Hi</span></label>
        <label class="ofl-rl"><input type="radio" name="ofl-cq" value="lo" id="ofl-cq-lo"><span>Lo</span></label>
      </div>
    </section>

    <section class="ofl-sec">
      <h3>–û–±–ª–∞—á–∫–æ ‚òÅ</h3>
      <div class="ofl-ir"><label>–ü–æ–ª–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π (N):</label><input type="number" id="ofl-cn" min="1" max="99" value="5"></div>
      <div class="ofl-ir"><label>–î–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è (D):</label><input type="number" id="ofl-cd" min="1" max="365" value="31"></div>
    </section>

    <section class="ofl-sec">
      <h3>–°–µ—Ç–µ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞</h3>
      <div class="ofl-row"><span>Wi-Fi</span>
        <label class="ofl-sw"><input type="checkbox" id="ofl-nw" checked><span class="ofl-sl"></span></label></div>
      <div class="ofl-row"><span>–ú–æ–±–∏–ª—å–Ω–∞—è —Å–µ—Ç—å</span>
        <label class="ofl-sw"><input type="checkbox" id="ofl-nm" checked><span class="ofl-sl"></span></label></div>
      <p class="ofl-hint">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å–µ—Ç—å ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.</p>
    </section>

    <section class="ofl-sec">
      <h3>–õ–∏–º–∏—Ç –∫—ç—à–∞</h3>
      <div class="ofl-rr">
        <label class="ofl-rl"><input type="radio" name="ofl-lm" value="auto" id="ofl-la"><span>–ê–≤—Ç–æ</span></label>
        <label class="ofl-rl"><input type="radio" name="ofl-lm" value="manual" id="ofl-lman"><span>–†—É—á–Ω–æ–π</span></label>
      </div>
      <div class="ofl-ir" id="ofl-lmr" style="display:none"><label>–ú–ë:</label><input type="number" id="ofl-lmb" min="60" max="50000" value="500"></div>
      <div id="ofl-bd" class="ofl-bd">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </section>

    <section class="ofl-sec">
      <h3>–ó–∞–≥—Ä—É–∑–∫–∏</h3>
      <div id="ofl-dls">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫</div>
      <div class="ofl-br"><button class="ofl-btn" data-act="dlp">–ü–∞—É–∑–∞</button><button class="ofl-btn" data-act="dlr">–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</button></div>
    </section>

    <section class="ofl-sec">
      <h3>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
      <button class="ofl-btn" data-act="upd">–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã</button>
      <p class="ofl-hint" id="ofl-uh"></p>
    </section>

    <section class="ofl-sec">
      <h3>–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞</h3>
      <div class="ofl-bc">
        <button class="ofl-btn ofl-w" data-clr="dynamic">Dynamic</button>
        <button class="ofl-btn ofl-w" data-clr="playbackWindow">Playback Window</button>
        <button class="ofl-btn ofl-d" data-clr="cloud">Cloud ‚òÅ</button>
        <button class="ofl-btn ofl-d" data-clr="pinned">Pinned üîí</button>
        <button class="ofl-btn ofl-d" data-clr="fullOffline">100% OFFLINE</button>
        <button class="ofl-btn ofl-d" data-act="clrall">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>
    </section>

    <section class="ofl-sec" id="ofl-fo-sec">
      <h3>100% OFFLINE</h3>

      <div class="ofl-sub"><h4>–ö–∞—á–µ—Å—Ç–≤–æ</h4>
        <div class="ofl-rr">
          <label class="ofl-rl"><input type="radio" name="ofl-foq" value="hi" id="ofl-fh"><span>Hi</span></label>
          <label class="ofl-rl"><input type="radio" name="ofl-foq" value="lo" id="ofl-fl"><span>Lo</span></label>
        </div>
      </div>

      <div class="ofl-sub"><h4>–°–æ—Å—Ç–∞–≤ –Ω–∞–±–æ—Ä–∞</h4>
        <div class="ofl-row"><span>–¢–æ–ª—å–∫–æ –ò–ó–ë–†–ê–ù–ù–û–ï</span>
          <label class="ofl-sw"><input type="checkbox" id="ofl-fof"><span class="ofl-sl"></span></label></div>
        <div id="ofl-foa"></div>
      </div>

      <div class="ofl-sub"><h4>–ê—Å—Å–µ—Ç—ã</h4>
        <div class="ofl-row"><span>–û–±–ª–æ–∂–∫–∏</span>
          <label class="ofl-sw"><input type="checkbox" id="ofl-foc" checked><span class="ofl-sl"></span></label></div>
        <div class="ofl-row"><span>–ì–∞–ª–µ—Ä–µ—è</span>
          <label class="ofl-sw"><input type="checkbox" id="ofl-fog"><span class="ofl-sl"></span></label></div>
      </div>

      <div class="ofl-sub">
        <div id="ofl-foe" class="ofl-hint"></div>
        <button class="ofl-btn" data-act="est">–û—Ü–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</button>
      </div>

      <div class="ofl-sub">
        <button class="ofl-btn ofl-p" data-act="fost">–ù–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É</button>
        <div id="ofl-fop" style="display:none">
          <div class="ofl-pb"><div class="ofl-pf" id="ofl-fopf"></div></div>
          <p id="ofl-fopt"></p>
        </div>
      </div>

      <div class="ofl-sub" id="ofl-foas" style="display:none">
        <button class="ofl-btn ofl-p" data-act="foact">–í–∫–ª—é—á–∏—Ç—å 100% OFFLINE</button>
        <button class="ofl-btn" data-act="fodeact" style="display:none">–í—ã–∫–ª—é—á–∏—Ç—å 100% OFFLINE</button>
      </div>

      <div class="ofl-sub"><h4>–¢—Ä–µ–∫–∏ –≤ –Ω–∞–±–æ—Ä–µ</h4><div id="ofl-fotl" class="ofl-fotl"></div></div>

      <div class="ofl-sub"><h4>–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∑–∫–∏</h4><select id="ofl-bp" class="ofl-sel"></select></div>
    </section>
  </div>
</div>`;
}

// ===================== BIND =====================

function _bind() {
  _modal.addEventListener('click', async (e) => {
    const t = e.target;
    const act = t.dataset.act || t.closest('[data-act]')?.dataset.act;
    const clr = t.dataset.clr || t.closest('[data-clr]')?.dataset.clr;

    if (act === 'close' || t === _modal) { close(); return; }
    if (act === 'dlp') { pauseQueue(); return; }
    if (act === 'dlr') { resumeQueue(); return; }
    if (act === 'upd') { const c = await updateAllFiles(); _toast(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${c} —Ñ–∞–π–ª–æ–≤`); return; }
    if (act === 'clrall') {
      if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à?') && confirm('–¢–æ—á–Ω–æ?')) { await clearAllCache(); _refreshBreakdown(); }
      return;
    }
    if (clr) {
      if ((clr === 'pinned' || clr === 'cloud') && (!confirm(`–£–¥–∞–ª–∏—Ç—å ${clr}?`) || !confirm('–¢–æ—á–Ω–æ?'))) return;
      await clearCacheByCategory(clr); _refreshBreakdown(); _toast(`${clr} –æ—á–∏—â–µ–Ω`);
      return;
    }
    if (act === 'est') { _doEstimate(); return; }
    if (act === 'fost') { _doStart(); return; }
    if (act === 'foact') { _doActivate(); return; }
    if (act === 'fodeact') { _doDeactivate(); return; }

    // FO track actions
    const foAct = t.dataset.foact || t.closest('[data-foact]')?.dataset.foact;
    const foUid = t.dataset.uid || t.closest('[data-uid]')?.dataset.uid;
    if (foAct === 'remove' && foUid) {
      await removeFromFullOffline(foUid);
      _refreshFOTracklist();
      return;
    }
  });

  // Mode toggles
  const r1 = _modal.querySelector('#ofl-r1');
  const r2 = _modal.querySelector('#ofl-r2');

  r1?.addEventListener('change', async () => {
    const m = getMode();
    if (r1.checked) {
      if (m === MODES.R3) { r1.checked = false; _toast('–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ 100% OFFLINE'); return; }
      const ok = await canGuaranteeStorage();
      if (!ok) { r1.checked = false; _toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 60 –ú–ë.', 4000); return; }
      if (!(await setMode(MODES.R1))) r1.checked = false;
    } else {
      if (m === MODES.R2) { r1.checked = true; _toast('PlaybackCache –Ω–µ–ª—å–∑—è –≤—ã–∫–ª—é—á–∏—Ç—å –ø—Ä–∏ Dynamic Offline'); return; }
      await setMode(MODES.R0);
    }
    _refreshModes();
  });

  r2?.addEventListener('change', async () => {
    const m = getMode();
    if (r2.checked) {
      if (m === MODES.R3) { r2.checked = false; _toast('–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ 100% OFFLINE'); return; }
      const ok = await canGuaranteeStorage();
      if (!ok) { r2.checked = false; _toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 60 –ú–ë.', 4000); return; }
      if (!(await enableDynamicOffline())) r2.checked = false;
    } else {
      await disableDynamicOffline();
    }
    _refreshModes();
  });

  // CQ
  _modal.querySelectorAll('[name="ofl-cq"]').forEach(el => {
    el.addEventListener('change', () => setCacheQuality(el.value));
  });

  // FOQ
  _modal.querySelectorAll('[name="ofl-foq"]').forEach(el => {
    el.addEventListener('change', () => setFullOfflineQuality(el.value));
  });

  // Cloud N/D
  _modal.querySelector('#ofl-cn')?.addEventListener('change', function() {
    localStorage.setItem('offline:cloudN:v1', this.value);
  });
  _modal.querySelector('#ofl-cd')?.addEventListener('change', function() {
    localStorage.setItem('offline:cloudD:v1', this.value);
  });

  // Net policy
  _modal.querySelector('#ofl-nw')?.addEventListener('change', function() {
    localStorage.setItem('offline:net:wifi:v1', this.checked ? '1' : '0');
  });
  _modal.querySelector('#ofl-nm')?.addEventListener('change', function() {
    localStorage.setItem('offline:net:mobile:v1', this.checked ? '1' : '0');
  });

  // Limit mode
  _modal.querySelectorAll('[name="ofl-lm"]').forEach(el => {
    el.addEventListener('change', () => {
      const manual = el.value === 'manual';
      _modal.querySelector('#ofl-lmr').style.display = manual ? '' : 'none';
      setCacheLimitMode(el.value);
    });
  });
  _modal.querySelector('#ofl-lmb')?.addEventListener('change', function() {
    setCacheLimitManual(parseInt(this.value, 10) || 500);
  });

  // BG profile
  _modal.querySelector('#ofl-bp')?.addEventListener('change', function() {
    setBackgroundProfile(this.value);
  });

  // FO selection
  _modal.querySelector('#ofl-fof')?.addEventListener('change', _saveSel);
  _modal.querySelector('#ofl-foc')?.addEventListener('change', _saveAssets);
  _modal.querySelector('#ofl-fog')?.addEventListener('change', _saveAssets);
}

function _bindGlobal() {
  window.addEventListener('openOfflineModal', () => open());
  window.addEventListener('fullOfflineProgress', (e) => {
    if (!_isOpen) return;
    const { done, total } = e.detail;
    const p = total > 0 ? Math.round(done / total * 100) : 0;
    const el = _modal.querySelector('#ofl-fop');
    if (el) el.style.display = '';
    const fill = _modal.querySelector('#ofl-fopf');
    if (fill) fill.style.width = p + '%';
    const txt = _modal.querySelector('#ofl-fopt');
    if (txt) txt.textContent = `${done}/${total} (${p}%)`;
  });
  window.addEventListener('fullOfflineComplete', (e) => {
    const sec = _modal?.querySelector('#ofl-foas');
    if (sec) sec.style.display = '';
    _showFOReadyModal(e.detail.totalTracks);
  });
  onModeChange(() => { if (_isOpen) _refreshAll(); });
}

// ===================== REFRESH =====================

function _refreshAll() {
  _refreshModes(); _refreshCQ(); _refreshCloud();
  _refreshNet(); _refreshLimit(); _refreshBreakdown();
  _refreshDownloads(); _refreshUpdateHint(); _refreshFO(); _refreshBP();
}

function _refreshModes() {
  const m = getMode();
  const r1 = _modal.querySelector('#ofl-r1');
  const r2 = _modal.querySelector('#ofl-r2');
  const h = _modal.querySelector('#ofl-mode-hint');
  if (r1) { r1.checked = m === MODES.R1 || m === MODES.R2; r1.disabled = m === MODES.R3; }
  if (r2) { r2.checked = m === MODES.R2; r2.disabled = m === MODES.R3; }
  if (h) {
    const msgs = {
      [MODES.R3]: '100% OFFLINE –∞–∫—Ç–∏–≤–µ–Ω. –†–µ–∂–∏–º—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.',
      [MODES.R2]: 'Dynamic Offline –∞–∫—Ç–∏–≤–µ–Ω. PlaybackCache –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.',
      [MODES.R1]: 'PlaybackCache: –±—É—Ñ–µ—Ä 3 —Ç—Ä–µ–∫–∞.',
      [MODES.R0]: 'Streaming: –∞—É–¥–∏–æ –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è.'
    };
    h.textContent = msgs[m] || '';
  }
}

function _refreshCQ() {
  const cq = getCacheQuality();
  const hi = _modal.querySelector('#ofl-cq-hi');
  const lo = _modal.querySelector('#ofl-cq-lo');
  if (hi) hi.checked = cq === 'hi';
  if (lo) lo.checked = cq === 'lo';
}

function _refreshCloud() {
  const n = _modal.querySelector('#ofl-cn');
  const d = _modal.querySelector('#ofl-cd');
  if (n) n.value = localStorage.getItem('offline:cloudN:v1') || '5';
  if (d) d.value = localStorage.getItem('offline:cloudD:v1') || '31';
}

function _refreshNet() {
  const w = _modal.querySelector('#ofl-nw');
  const m = _modal.querySelector('#ofl-nm');
  if (w) w.checked = localStorage.getItem('offline:net:wifi:v1') !== '0';
  if (m) m.checked = localStorage.getItem('offline:net:mobile:v1') !== '0';
}

function _refreshLimit() {
  const mode = getCacheLimitMode();
  const a = _modal.querySelector('#ofl-la');
  const mn = _modal.querySelector('#ofl-lman');
  const mr = _modal.querySelector('#ofl-lmr');
  if (a) a.checked = mode === 'auto';
  if (mn) mn.checked = mode === 'manual';
  if (mr) mr.style.display = mode === 'manual' ? '' : 'none';
}

async function _refreshBreakdown() {
  const el = _modal.querySelector('#ofl-bd');
  if (!el) return;
  try {
    const bd = await getBreakdown();
    const est = await getStorageEstimate();
    const mb = b => (b / 1048576).toFixed(1);
    el.innerHTML = [
      `Pinned üîí: ${mb(bd.pinned)} –ú–ë`,
      `Cloud ‚òÅ: ${mb(bd.cloud)} –ú–ë`,
      `Dynamic: ${mb(bd.dynamic)} –ú–ë`,
      `Playback Window: ${mb(bd.playbackWindow)} –ú–ë`,
      `100% OFFLINE: ${mb(bd.fullOffline)} –ú–ë`,
      `–î—Ä—É–≥–æ–µ: ${mb(bd.other)} –ú–ë`,
      `‚îÄ‚îÄ‚îÄ`,
      `–ö–≤–æ—Ç–∞: ${mb(est.quota)} | –ó–∞–Ω—è—Ç–æ: ${mb(est.usage)} | –°–≤–æ–±–æ–¥–Ω–æ: ${mb(est.free)} –ú–ë`
    ].join('<br>');
  } catch (e) { el.textContent = '–û—à–∏–±–∫–∞'; }
}

function _refreshDownloads() {
  const el = _modal?.querySelector('#ofl-dls');
  if (!el) return;
  const s = getQueueStatus();
  if (s.isProcessing && s.currentTask) {
    el.textContent = `–°–∫–∞—á–∏–≤–∞–µ—Ç—Å—è: ${s.currentTask.uid} | –û—á–µ—Ä–µ–¥—å: ${s.queueLength}`;
  } else if (s.isPaused) {
    el.textContent = `–ü–∞—É–∑–∞ | –û—á–µ—Ä–µ–¥—å: ${s.queueLength}`;
  } else if (s.queueLength > 0) {
    el.textContent = `–û—á–µ—Ä–µ–¥—å: ${s.queueLength}`;
  } else {
    el.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫';
  }
}

async function _refreshUpdateHint() {
  const el = _modal.querySelector('#ofl-uh');
  if (!el) return;
  el.textContent = (await hasNeedsUpdateOrReCache()) ? '–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!' : '';
}

function _refreshFO() {
  const m = getMode();
  const foq = getFullOfflineQuality();
  const fh = _modal.querySelector('#ofl-fh');
  const fl = _modal.querySelector('#ofl-fl');
  if (fh) fh.checked = foq === 'hi';
  if (fl) fl.checked = foq === 'lo';

  const sel = getFullOfflineSelection();
  const fof = _modal.querySelector('#ofl-fof');
  if (fof) fof.checked = sel.favorites || false;

  _refreshFOAlbums(sel);

  const assets = getFullOfflineAssets();
  const fc = _modal.querySelector('#ofl-foc');
  const fg = _modal.querySelector('#ofl-fog');
  if (fc) fc.checked = assets.covers !== false;
  if (fg) fg.checked = assets.gallery || false;

  const as = _modal.querySelector('#ofl-foas');
  const ab = _modal.querySelector('[data-act="foact"]');
  const db = _modal.querySelector('[data-act="fodeact"]');
  if (as) as.style.display = (isFullOfflineReady() || m === MODES.R3) ? '' : 'none';
  if (ab) ab.style.display = m === MODES.R3 ? 'none' : '';
  if (db) db.style.display = m === MODES.R3 ? '' : 'none';

  _refreshFOTracklist();
}

function _refreshFOAlbums(sel) {
  const c = _modal.querySelector('#ofl-foa');
  if (!c) return;
  const albums = getAlbumsData();
  if (!albums || !albums.length) { c.innerHTML = '<p class="ofl-hint">–ê–ª—å–±–æ–º—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>'; return; }
  c.innerHTML = albums.map(a => {
    const id = a.id || a.prefix;
    const ck = (sel.albums || []).includes(id);
    return `<div class="ofl-row"><span>${a.title || id}</span>
      <label class="ofl-sw"><input type="checkbox" class="ofl-foalb" data-aid="${id}" ${ck ? 'checked' : ''}><span class="ofl-sl"></span></label></div>`;
  }).join('');
  c.querySelectorAll('.ofl-foalb').forEach(cb => cb.addEventListener('change', _saveSel));
}

async function _refreshFOTracklist() {
  const c = _modal.querySelector('#ofl-fotl');
  if (!c) return;
  const metas = await getAllTrackMetas();
  const fo = metas.filter(m => m.fullOfflineIncluded || m.pinned || m.cloud);
  const all = getAllTracks();
  if (!fo.length) { c.innerHTML = '<p class="ofl-hint">–ù–∞–±–æ—Ä –ø—É—Å—Ç</p>'; return; }
  c.innerHTML = fo.map(m => {
    const t = all.find(x => x.uid === m.uid);
    const title = t ? t.title : m.uid;
    return `<div class="ofl-fot">
      <span>${title}${m.pinned ? ' üîí' : ''}${m.cloud ? ' ‚òÅ' : ''}</span>
      <div>
        <button class="ofl-bs" data-foact="remove" data-uid="${m.uid}" ${m.pinned ? 'disabled title="–°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∏—Ç–µ üîí"' : ''}>–£–¥–∞–ª–∏—Ç—å</button>
        <button class="ofl-bs" disabled>–°–∫–∞—á–∞—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
        <button class="ofl-bs" disabled>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      </div>
    </div>`;
  }).join('');
}

function _refreshBP() {
  const s = _modal.querySelector('#ofl-bp');
  if (!s) return;
  const profiles = getAvailableProfiles();
  const cur = getBackgroundProfile();
  s.innerHTML = profiles.map(p =>
    `<option value="${p.id}" ${p.id === cur.id ? 'selected' : ''}>${p.label}</option>`
  ).join('');
}

// ===================== ACTIONS =====================

function _saveSel() {
  const fav = !!_modal.querySelector('#ofl-fof')?.checked;
  const albums = [];
  _modal.querySelectorAll('.ofl-foalb:checked').forEach(cb => albums.push(cb.dataset.aid));
  setFullOfflineSelection({ favorites: fav, albums, uids: [] });
}

function _saveAssets() {
  const covers = !!_modal.querySelector('#ofl-foc')?.checked;
  const gallery = !!_modal.querySelector('#ofl-fog')?.checked;
  setFullOfflineAssets({ covers, gallery });
}

function _doEstimate() {
  const sel = getFullOfflineSelection();
  const foq = getFullOfflineQuality();
  const assets = getFullOfflineAssets();
  // Get favorite uids
  const favUids = _getFavUids();
  const allT = getAllTracks();
  const uidSet = new Set();
  if (sel.favorites && favUids) favUids.forEach(u => uidSet.add(u));
  if (sel.albums) {
    const albums = getAlbumsData();
    sel.albums.forEach(aid => {
      const a = albums.find(x => (x.id || x.prefix) === aid);
      if (a && a.tracks) a.tracks.forEach(t => { if (t.uid) uidSet.add(t.uid); });
    });
  }
  const est = computeSizeEstimate(Array.from(uidSet), foq, assets.covers, assets.gallery);
  const el = _modal.querySelector('#ofl-foe');
  if (el) el.textContent = `–¢—Ä–µ–∫–æ–≤: ${est.tracks} | –ê—É–¥–∏–æ: ${est.audioMB} –ú–ë | –û–±–ª–æ–∂–∫–∏: ${est.coversMB} –ú–ë | –ò—Ç–æ–≥–æ: ‚âà${est.totalMB} –ú–ë`;
}

async function _doStart() {
  const sel = getFullOfflineSelection();
  const favUids = _getFavUids();
  const result = await startFullOfflineDownload(sel, favUids);
  if (result) _toast(`–ó–∞–≥—Ä—É–∑–∫–∞: ${result.totalTracks} —Ç—Ä–µ–∫–æ–≤`);
}

async function _doActivate() {
  const ok = await activateFullOffline();
  if (ok) { _toast('100% OFFLINE –≤–∫–ª—é—á—ë–Ω'); _refreshAll(); }
}

async function _doDeactivate() {
  await deactivateFullOffline();
  _toast('100% OFFLINE –≤—ã–∫–ª—é—á–µ–Ω');
  _refreshAll();
}

function _showFOReadyModal(totalTracks) {
  const size = '‚Äî';
  if (confirm(`100% OFFLINE –≥–æ—Ç–æ–≤. –°–∫–∞—á–∞–Ω–æ: ${totalTracks} —Ç—Ä–µ–∫–æ–≤. –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º?`)) {
    activateFullOffline().then(() => { _toast('100% OFFLINE –≤–∫–ª—é—á—ë–Ω'); if (_isOpen) _refreshAll(); });
  }
}

function _getFavUids() {
  if (window.favorites && typeof window.favorites.getAll === 'function') {
    return window.favorites.getAll().filter(f => f.active !== false).map(f => f.uid);
  }
  try {
    const raw = localStorage.getItem('favorites');
    if (raw) {
      const arr = JSON.parse(raw);
      return arr.filter(f => f.active !== false).map(f => f.uid || f.id);
    }
  } catch(e) {}
  return [];
}

export { init, open, close, isOpen };

//=================================================
// FILE: /src/js/playback-cache.js
/**
 * PlaybackCache ‚Äî 3-—Ç—Ä–µ–∫–æ–≤–æ–µ –æ–∫–Ω–æ PREV/CUR/NEXT (–¢–ó 7)
 * State machine –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è 7.5.3 (S1/S2/S3)
 * –ú–µ—Ö–∞–Ω–∏–∑–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è: –∏—Å—Ç–æ—á–Ω–∏–∫, –¥–æ–∫–∞—á–∫–∞, —Å–¥–≤–∏–≥ –æ–∫–Ω–∞
 */

import { getAudioEntry, hasAudioLocally, getTrackMeta, saveTrackMeta, getAllTrackMetas } from './cache-db.js';
import { getMode, getActivePlaybackQuality, isNetworkAllowedForPlayback, MODES } from './mode-manager.js';
import { resolvePlayback, resolveVariantUrl } from './track-resolver.js';
import { enqueue, dequeue, PRIORITY } from './download-queue.js';
import { protectWindow, unprotectWindow, onTrackPlayed as omOnTrackPlayed } from './offline-manager.js';
import { onTrackStart as statsTrackStart } from './stats-core.js';

// === STATE ===
let _playlist = [];       // current playing playlist (active tracks only)
let _curIndex = -1;       // index in _playlist
let _direction = 'next';  // last transition direction
let _windowUids = new Set(); // uids in transient playback window
let _baseUrl = '';

// 7.5.3 State Machine
const SM_IDLE = 'idle';
const SM_S1_WAITING = 's1_waiting';
const SM_S2_CHOICE = 's2_choice';
const SM_S3_WAIT = 's3_wait';
const SM_S3_SKIP = 's3_skip';

let _smState = SM_IDLE;
let _recoveryTarget = null;   // { uid, index, track }
let _s1Timer = null;
let _s1RetryInterval = null;
let _forcedOfflineQueue = [];
let _forcedOfflineIndex = -1;
let _windowProtected = false;

// Callbacks (set by PlayerCore integration)
let _onResolvedSource = null;    // (track, sourceResult) => void ‚Äî start playback
let _onPause = null;             // () => void
let _onShowS2Modal = null;       // (options) => void
let _onShowR3Modal = null;       // (msg) => void
let _onHideModal = null;         // () => void
let _getCurrentlyPlaying = null; // () => { uid, isPlaying, progress }

function configure(callbacks) {
  _onResolvedSource = callbacks.onResolvedSource || null;
  _onPause = callbacks.onPause || null;
  _onShowS2Modal = callbacks.onShowS2Modal || null;
  _onShowR3Modal = callbacks.onShowR3Modal || null;
  _onHideModal = callbacks.onHideModal || null;
  _getCurrentlyPlaying = callbacks.getCurrentlyPlaying || null;
}

function setBaseUrl(url) { _baseUrl = url; }

// ===================== PLAYLIST & WINDOW =====================

/**
 * Set the current playing playlist and position
 * Called when playlist changes (album select, shuffle toggle, favorites filter)
 */
function setPlaylist(tracks, curIndex, direction) {
  _playlist = tracks.filter(t => t && t.uid);
  _curIndex = curIndex >= 0 && curIndex < _playlist.length ? curIndex : 0;
  _direction = direction || 'next';
  _updateWindow();
}

function getPlaylist() { return _playlist; }
function getCurIndex() { return _curIndex; }

function getCurTrack() {
  return _playlist[_curIndex] || null;
}

function _getIndex(offset) {
  if (_playlist.length === 0) return -1;
  return ((_curIndex + offset) % _playlist.length + _playlist.length) % _playlist.length;
}

function getPrevTrack() {
  const i = _getIndex(-1);
  return i >= 0 ? _playlist[i] : null;
}

function getNextTrack() {
  const i = _getIndex(1);
  return i >= 0 ? _playlist[i] : null;
}

/** –¢–ó 7.3: compute window of 3 */
function getWindow() {
  const cur = getCurTrack();
  const prev = getPrevTrack();
  const next = getNextTrack();
  return { prev, cur, next };
}

function _updateWindow() {
  const w = getWindow();
  const newUids = new Set();
  if (w.prev) newUids.add(w.prev.uid);
  if (w.cur) newUids.add(w.cur.uid);
  if (w.next) newUids.add(w.next.uid);

  const mode = getMode();
  if (mode === MODES.R1 || mode === MODES.R2) {
    // –¢–ó 7.6.3: remove transient tracks no longer in window
    for (const uid of _windowUids) {
      if (!newUids.has(uid)) {
        _removeTransient(uid);
      }
    }
    _windowUids = newUids;

    // –¢–ó 7.5.3.4: protect window if in recovery scenario
    if (_windowProtected) {
      protectWindow(Array.from(newUids));
    }

    // –¢–ó 7.7: enqueue downloads for window
    _enqueueWindowDownloads();
  } else {
    _windowUids = newUids;
  }
}

async function _removeTransient(uid) {
  const meta = await getTrackMeta(uid);
  if (meta && meta.cacheKind === 'playbackWindow') {
    const { deleteAudioBlob } = await import('./cache-db.js');
    await deleteAudioBlob(uid);
    meta.cacheKind = 'none';
    meta.cachedVariant = null;
    meta.cachedComplete = 0;
    await saveTrackMeta(meta);
  }
}

/** –¢–ó 7.7: strict download order CUR ‚Üí neighbor */
function _enqueueWindowDownloads() {
  const mode = getMode();
  if (mode !== MODES.R1 && mode !== MODES.R2) return;
  if (!isNetworkAllowedForPlayback()) return;

  const apq = getActivePlaybackQuality();
  const w = getWindow();

  // P0: CUR
  if (w.cur) _enqueueIfNeeded(w.cur, apq, PRIORITY.P0_CUR);

  // P1: neighbor by direction
  if (_direction === 'prev') {
    if (w.prev) _enqueueIfNeeded(w.prev, apq, PRIORITY.P1_NEIGHBOR);
    if (w.next) _enqueueIfNeeded(w.next, apq, PRIORITY.P1_NEIGHBOR);
  } else {
    if (w.next) _enqueueIfNeeded(w.next, apq, PRIORITY.P1_NEIGHBOR);
    if (w.prev) _enqueueIfNeeded(w.prev, apq, PRIORITY.P1_NEIGHBOR);
  }
}

async function _enqueueIfNeeded(track, variant, priority) {
  if (!track || !track.uid) return;
  // –¢–ó 7.6.2: don't re-download if already local
  const entry = await getAudioEntry(track.uid);
  if (entry && entry.variant === variant) return;
  // If any local copy exists, still usable (best effort)
  if (entry) return;

  const url = resolveVariantUrl(track, variant, _baseUrl);
  if (!url) return;

  enqueue({
    uid: track.uid,
    variant,
    url,
    priority,
    cacheKind: 'playbackWindow'
  });
}

// ===================== RESOLVE & PLAY =====================

/**
 * Resolve source and start playback for a track
 * –¢–ó 7.4.3: Normative Source Resolver
 */
async function resolveAndPlay(track, direction) {
  if (!track) return;
  _direction = direction || 'next';

  const mode = getMode();

  // R3 special handling (–¢–ó 7.5.4)
  if (mode === MODES.R3) {
    return _resolveR3(track);
  }

  const result = await resolvePlayback(track, _baseUrl);

  if (result.url) {
    // Success
    _cancelRecovery();
    if (_onResolvedSource) _onResolvedSource(track, result);
    statsTrackStart(track.uid);
    if (mode === MODES.R2) omOnTrackPlayed(track.uid);
    return result;
  }

  // No source ‚Äî enter 7.5.3 scenario
  return _handleBlockedTransition(track);
}

async function _resolveR3(track) {
  const result = await resolvePlayback(track, _baseUrl);
  if (result.url && result.isLocal) {
    if (_onResolvedSource) _onResolvedSource(track, result);
    statsTrackStart(track.uid);
    return result;
  }
  // –¢–ó 7.5.4
  if (_onPause) _onPause();
  if (_onShowR3Modal) {
    _onShowR3Modal('–¢—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ 100% OFFLINE. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 100% OFFLINE.');
  }
  return null;
}

// ===================== 7.5.3 STATE MACHINE =====================

async function _handleBlockedTransition(targetTrack) {
  _recoveryTarget = {
    uid: targetTrack.uid,
    track: targetTrack,
    index: _playlist.findIndex(t => t.uid === targetTrack.uid)
  };

  // –¢–ó 7.5.3.4: protect window
  _windowProtected = true;
  protectWindow(Array.from(_windowUids));

  // Enter S1
  _smState = SM_S1_WAITING;
  _startS1Timer();
}

function _startS1Timer() {
  let elapsed = 0;
  const TIMEOUT = 10000;
  const RETRY_MS = 2000;

  // Retry getting src.url
  _s1RetryInterval = setInterval(async () => {
    if (!_recoveryTarget) { _cancelS1(); return; }

    const result = await resolvePlayback(_recoveryTarget.track, _baseUrl);
    if (result.url) {
      // –¢–ó 7.5.3.5: src.url appeared
      _cancelS1();
      _cancelRecovery();
      if (_onResolvedSource) _onResolvedSource(_recoveryTarget.track, result);
      statsTrackStart(_recoveryTarget.uid);
      return;
    }
  }, RETRY_MS);

  _s1Timer = setTimeout(() => {
    // –¢–ó 7.5.3.7: 10 sec passed, enter S2
    _cancelS1Timer();
    _enterS2();
  }, TIMEOUT);
}

function _cancelS1Timer() {
  if (_s1Timer) { clearTimeout(_s1Timer); _s1Timer = null; }
}

function _cancelS1() {
  _cancelS1Timer();
  if (_s1RetryInterval) { clearInterval(_s1RetryInterval); _s1RetryInterval = null; }
}

/** Check if current track ended during S1 */
function onCurrentTrackEnded() {
  if (_smState === SM_S1_WAITING) {
    _cancelS1();
    _enterS2();
  }
}

/** –¢–ó 7.5.3.7: S2 choice modal */
async function _enterS2() {
  _smState = SM_S2_CHOICE;
  if (_onPause) _onPause();

  const localTracks = await _getLocallyAvailableTracks();
  const hasLocalTracks = localTracks.length > 0;

  if (_onShowS2Modal) {
    _onShowS2Modal({
      hasLocalTracks,
      onWait: () => _enterS3Wait(),
      onSkip: () => _enterS3Skip(localTracks),
      onOpenOfflineSettings: () => {
        if (typeof window !== 'undefined') {
          window.dispatchEvent(new CustomEvent('openOfflineModal'));
        }
      }
    });
  }
}

/** –¢–ó 7.5.3.8: S3 wait ‚Äî loop available window tracks */
async function _enterS3Wait() {
  _smState = SM_S3_WAIT;
  if (_onHideModal) _onHideModal();

  // Get locally available tracks from window only
  const windowTracks = await _getLocallyAvailableWindowTracks();

  if (windowTracks.length > 0) {
    _forcedOfflineQueue = windowTracks;
    _forcedOfflineIndex = 0;
    _playForcedNext();
  }

  // Continue retrying for recovery target
  _startRecoveryRetry();
}

/** –¢–ó 7.5.3.9: S3 skip ‚Äî FOQ with all local tracks */
async function _enterS3Skip(localTracks) {
  _smState = SM_S3_SKIP;
  if (_onHideModal) _onHideModal();

  // –¢–ó 7.5.3.9: window tracks first, then user cache in random order
  const windowTracks = await _getLocallyAvailableWindowTracks();
  const otherTracks = localTracks.filter(t => !windowTracks.find(w => w.uid === t.uid));
  _shuffleArray(otherTracks);

  _forcedOfflineQueue = [...windowTracks, ...otherTracks];
  _forcedOfflineIndex = 0;

  // Current track finishes, then FOQ
  const cur = _getCurrentlyPlaying ? _getCurrentlyPlaying() : null;
  if (!cur || !cur.isPlaying) {
    _playForcedNext();
  }
  // else: wait for onCurrentTrackEnded to advance

  _startRecoveryRetry();
}

function _playForcedNext() {
  if (_forcedOfflineQueue.length === 0) return;
  _forcedOfflineIndex = _forcedOfflineIndex % _forcedOfflineQueue.length;
  const track = _forcedOfflineQueue[_forcedOfflineIndex];
  _forcedOfflineIndex++;

  resolvePlayback(track, _baseUrl).then(result => {
    if (result.url && _onResolvedSource) {
      _onResolvedSource(track, result);
      statsTrackStart(track.uid);
    }
  });
}

/** Called when forced offline track ends ‚Äî play next in FOQ */
function onForcedTrackEnded() {
  if (_smState === SM_S3_WAIT || _smState === SM_S3_SKIP) {
    _playForcedNext();
  }
}

let _recoveryRetryInterval = null;

function _startRecoveryRetry() {
  if (_recoveryRetryInterval) clearInterval(_recoveryRetryInterval);
  _recoveryRetryInterval = setInterval(async () => {
    if (!_recoveryTarget) { _cancelRecoveryRetry(); return; }

    const result = await resolvePlayback(_recoveryTarget.track, _baseUrl);
    if (result.url) {
      // –¢–ó 7.5.3.10: network restored
      _cancelRecoveryRetry();

      // Let current forced track finish
      const cur = _getCurrentlyPlaying ? _getCurrentlyPlaying() : null;
      if (cur && cur.isPlaying) {
        // Wait for it to end, then play recovery target
        _pendingRecovery = result;
      } else {
        _completeRecovery(result);
      }
    }
  }, 3000);
}

let _pendingRecovery = null;

/** Called when any track ends ‚Äî check if pending recovery */
function onAnyTrackEnded() {
  if (_pendingRecovery && _recoveryTarget) {
    _completeRecovery(_pendingRecovery);
    _pendingRecovery = null;
    return true; // consumed
  }

  if (_smState === SM_S1_WAITING) {
    onCurrentTrackEnded();
    return true;
  }

  if (_smState === SM_S3_WAIT || _smState === SM_S3_SKIP) {
    onForcedTrackEnded();
    return true;
  }

  return false;
}

function _completeRecovery(result) {
  // –¢–ó 7.5.3.10
  if (_onHideModal) _onHideModal();
  if (_onResolvedSource && _recoveryTarget) {
    _onResolvedSource(_recoveryTarget.track, result);
    statsTrackStart(_recoveryTarget.uid);
  }
  _cancelRecovery();
}

function _cancelRecovery() {
  _smState = SM_IDLE;
  _recoveryTarget = null;
  _forcedOfflineQueue = [];
  _forcedOfflineIndex = -1;
  _pendingRecovery = null;
  _windowProtected = false;
  unprotectWindow();
  _cancelS1();
  _cancelRecoveryRetry();
}

function _cancelRecoveryRetry() {
  if (_recoveryRetryInterval) {
    clearInterval(_recoveryRetryInterval);
    _recoveryRetryInterval = null;
  }
}

// ===================== LOCAL TRACK HELPERS =====================

async function _getLocallyAvailableTracks() {
  const tracks = [];
  const metas = await getAllTrackMetas();
  for (const m of metas) {
    if (m.cachedComplete === 100 && m.cachedVariant) {
      const track = _playlist.find(t => t.uid === m.uid) || _findTrackGlobal(m.uid);
      if (track) tracks.push(track);
    }
  }
  return tracks;
}

async function _getLocallyAvailableWindowTracks() {
  const w = getWindow();
  const tracks = [];
  for (const t of [w.cur, w.prev, w.next]) {
    if (!t) continue;
    const has = await hasAudioLocally(t.uid);
    if (has) tracks.push(t);
  }
  return tracks;
}

function _findTrackGlobal(uid) {
  return _playlist.find(t => t.uid === uid) || null;
}

// ===================== NAVIGATION =====================

/** –¢–ó 7.8: shift window on next */
async function goNext() {
  if (_smState === SM_S1_WAITING) {
    // –¢–ó 7.5.3.6: next during S1, play from window if possible
    return _playNextInWindow();
  }

  if (_playlist.length === 0) return null;
  _direction = 'next';
  const newIndex = _getIndex(1);
  _curIndex = newIndex;
  _updateWindow();
  return resolveAndPlay(_playlist[_curIndex], 'next');
}

async function goPrev() {
  if (_smState === SM_S1_WAITING) {
    return _playPrevInWindow();
  }

  if (_playlist.length === 0) return null;
  _direction = 'prev';
  const newIndex = _getIndex(-1);
  _curIndex = newIndex;
  _updateWindow();
  return resolveAndPlay(_playlist[_curIndex], 'prev');
}

async function goToTrack(uid) {
  const index = _playlist.findIndex(t => t.uid === uid);
  if (index < 0) return null;
  _curIndex = index;
  _direction = 'next';
  _updateWindow();
  return resolveAndPlay(_playlist[_curIndex], 'next');
}

/** –¢–ó 7.5.3.6: next/prev inside window during S1 */
async function _playNextInWindow() {
  const available = await _getLocallyAvailableWindowTracks();
  if (available.length === 0) return null;

  const curUid = _getCurrentlyPlaying ? _getCurrentlyPlaying().uid : null;
  const curIdx = available.findIndex(t => t.uid === curUid);
  const nextIdx = (curIdx + 1) % available.length;
  const track = available[nextIdx];

  const result = await resolvePlayback(track, _baseUrl);
  if (result.url && _onResolvedSource) {
    _onResolvedSource(track, result);
    statsTrackStart(track.uid);
  }
  return result;
}

async function _playPrevInWindow() {
  const available = await _getLocallyAvailableWindowTracks();
  if (available.length === 0) return null;

  const curUid = _getCurrentlyPlaying ? _getCurrentlyPlaying().uid : null;
  const curIdx = available.findIndex(t => t.uid === curUid);
  const prevIdx = (curIdx - 1 + available.length) % available.length;
  const track = available[prevIdx];

  const result = await resolvePlayback(track, _baseUrl);
  if (result.url && _onResolvedSource) {
    _onResolvedSource(track, result);
    statsTrackStart(track.uid);
  }
  return result;
}

// ===================== HELPERS =====================

function _shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function getState() {
  return {
    smState: _smState,
    recoveryTarget: _recoveryTarget,
    windowUids: Array.from(_windowUids),
    curIndex: _curIndex,
    direction: _direction,
    playlistLength: _playlist.length
  };
}

function isInRecoveryMode() {
  return _smState !== SM_IDLE;
}

export {
  configure, setBaseUrl, setPlaylist,
  getPlaylist, getCurIndex, getCurTrack,
  getPrevTrack, getNextTrack, getWindow,
  resolveAndPlay, goNext, goPrev, goToTrack,
  onAnyTrackEnded, isInRecoveryMode, getState,
  SM_IDLE, SM_S1_WAITING, SM_S2_CHOICE, SM_S3_WAIT, SM_S3_SKIP
};

//=================================================
// FILE: /src/js/stats-core.js
/**
 * StatsCore ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø–æ–¥—Å—á—ë—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–¢–ó 18)
 * Cloud stats (—Å–±—Ä–∞—Å—ã–≤–∞–µ–º–∞—è) + Global stats (–≤–µ—á–Ω–∞—è)
 * –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ uid, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞/–∏—Å—Ç–æ—á–Ω–∏–∫–∞/—Ä–µ–∂–∏–º–∞
 */

import { getTrackMeta, saveTrackMeta, getGlobalStats, saveGlobalStats, getAllGlobalStats } from './cache-db.js';

let _currentUid = null;
let _tickTimer = null;
const GLOBAL_TOTAL_KEY = 'stats:globalTotalListenSeconds:v1';

function _getCloudN() {
  const v = localStorage.getItem('offline:cloudN:v1');
  return v ? parseInt(v, 10) : 5;
}
function _getCloudD() {
  const v = localStorage.getItem('offline:cloudD:v1');
  return v ? parseInt(v, 10) : 31;
}

/** –¢–ó 18.3: onTrackStart */
async function onTrackStart(uid) {
  if (_currentUid && _currentUid !== uid) {
    _stopTicking();
  }
  _currentUid = uid;
  _startTicking();
}

/** –¢–ó 18.3: onSecondTick */
async function onSecondTick(uid, delta) {
  if (uid !== _currentUid) return;
  try {
    const gs = await getGlobalStats(uid);
    gs.globalListenSeconds = (gs.globalListenSeconds || 0) + delta;
    await saveGlobalStats(uid, gs);
    const cur = parseFloat(localStorage.getItem(GLOBAL_TOTAL_KEY) || '0');
    localStorage.setItem(GLOBAL_TOTAL_KEY, String(cur + delta));
  } catch (e) {
    console.error('[StatsCore] tick error', e);
  }
}

/** –¢–ó 18.3: onSeek ‚Äî no-op for stats, just logged */
function onSeek(uid, from, to) { /* no stat effect */ }

/** –¢–ó 18.3: onEnded */
async function onEnded(uid, progress, durationValid) {
  _stopTicking();
  if (uid !== _currentUid) return;
  if (durationValid && progress > 0.9) {
    await _recordFullListen(uid);
  }
}

/** –¢–ó 18.3: onSkip ‚Äî >90% counts as full listen */
async function onSkip(uid, progress, durationValid) {
  _stopTicking();
  if (uid !== _currentUid) return;
  if (durationValid && progress > 0.9) {
    await _recordFullListen(uid);
  }
}

async function _recordFullListen(uid) {
  try {
    // Global stats (never reset)
    const gs = await getGlobalStats(uid);
    gs.globalFullListenCount = (gs.globalFullListenCount || 0) + 1;
    await saveGlobalStats(uid, gs);

    // Cloud stats
    const meta = await getTrackMeta(uid);
    if (!meta) return;

    meta.cloudFullListenCount = (meta.cloudFullListenCount || 0) + 1;
    meta.lastFullListenAt = Date.now();

    const N = _getCloudN();
    const D = _getCloudD();

    // –¢–ó 9.3A: auto-cloud
    if (!meta.cloud && !meta.pinned && meta.cloudFullListenCount >= N) {
      meta.cloud = true;
      meta.cloudAddedAt = Date.now();
      meta.cloudExpiresAt = Date.now() + D * 86400000;
      window.dispatchEvent(new CustomEvent('cloudTriggered', { detail: { uid } }));
    }

    // –¢–ó 9.4: extend TTL
    if (meta.cloud) {
      meta.cloudExpiresAt = Date.now() + D * 86400000;
    }

    await saveTrackMeta(meta);
  } catch (e) {
    console.error('[StatsCore] full listen error', e);
  }
}

function _startTicking() {
  _stopTicking();
  _tickTimer = setInterval(() => {
    if (_currentUid) onSecondTick(_currentUid, 1);
  }, 1000);
}

function _stopTicking() {
  if (_tickTimer) { clearInterval(_tickTimer); _tickTimer = null; }
}

function pauseTicking() { _stopTicking(); }
function resumeTicking() { if (_currentUid) _startTicking(); }

function getGlobalTotalListenSeconds() {
  return parseFloat(localStorage.getItem(GLOBAL_TOTAL_KEY) || '0');
}

/** –¢–ó 19.4: top tracks with >= minFullListens */
async function getTopTracks(minFullListens = 3) {
  const all = await getAllGlobalStats();
  return all
    .filter(s => (s.globalFullListenCount || 0) >= minFullListens)
    .sort((a, b) => (b.globalFullListenCount || 0) - (a.globalFullListenCount || 0));
}

/** –¢–ó 9.5: reset cloud stats only */
async function resetCloudStats(uid) {
  const meta = await getTrackMeta(uid);
  if (!meta) return;
  meta.cloudFullListenCount = 0;
  meta.lastFullListenAt = null;
  meta.cloudAddedAt = null;
  meta.cloudExpiresAt = null;
  meta.cloud = false;
  await saveTrackMeta(meta);
}

function getCurrentUid() { return _currentUid; }

export {
  onTrackStart, onSecondTick, onSeek, onEnded, onSkip,
  pauseTicking, resumeTicking,
  getGlobalTotalListenSeconds, getTopTracks,
  resetCloudStats, getCurrentUid
};

//=================================================
// FILE: /src/js/stats-modal.js
/**
 * Statistics Modal (–¢–ó 17)
 * –í—Ö–æ–¥: –∑–æ–Ω–∞ –Ω–∞–¥ #logo-bottom
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–µ–∫–∏ —Å globalFullListenCount >= 3 + –æ–±—â–µ–µ –≤—Ä–µ–º—è
 */

import { getTopTracks, getGlobalTotalListenSeconds } from './stats-core.js';

let _modal = null;
let _isOpen = false;

function init() {
  _ensureDOM();
  _createTrigger();
}

function _createTrigger() {
  const logo = document.getElementById('logo-bottom');
  if (!logo) return;

  let trigger = document.getElementById('stats-trigger');
  if (!trigger) {
    trigger = document.createElement('button');
    trigger.id = 'stats-trigger';
    trigger.className = 'stats-trigger-btn';
    trigger.textContent = 'üìä';
    trigger.title = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞';
    trigger.setAttribute('aria-label', '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');
    logo.parentNode.insertBefore(trigger, logo);
  }
  trigger.addEventListener('click', (e) => {
    e.stopPropagation();
    open();
  });
}

function _ensureDOM() {
  if (_modal) return;
  _modal = document.createElement('div');
  _modal.id = 'stats-modal';
  _modal.className = 'stats-overlay';
  _modal.style.display = 'none';
  _modal.innerHTML = `
<div class="stats-content">
  <div class="stats-hdr">
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <button class="stats-close" data-act="close">‚úï</button>
  </div>
  <div class="stats-body" id="stats-body">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
  </div>
</div>`;
  document.body.appendChild(_modal);

  _modal.addEventListener('click', (e) => {
    const act = e.target.dataset.act;
    if (act === 'close' || e.target === _modal) close();
  });
}

function open() {
  _ensureDOM();
  _modal.style.display = 'flex';
  _isOpen = true;
  _refresh();
}

function close() {
  if (_modal) _modal.style.display = 'none';
  _isOpen = false;
}

function _formatTime(totalSeconds) {
  const days = Math.floor(totalSeconds / 86400);
  const hours = Math.floor((totalSeconds % 86400) / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const parts = [];
  if (days > 0) parts.push(`${days} –¥.`);
  if (hours > 0) parts.push(`${hours} —á.`);
  if (minutes > 0 || parts.length === 0) parts.push(`${minutes} –º–∏–Ω.`);
  return parts.join(' ');
}

function _formatTrackTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  if (m > 60) {
    const h = Math.floor(m / 60);
    const rm = m % 60;
    return `${h}—á ${rm}–º`;
  }
  return `${m}–º ${s}—Å`;
}

async function _refresh() {
  const body = document.getElementById('stats-body');
  if (!body) return;

  try {
    const tracks = await getTopTracks(3);
    const totalSec = getGlobalTotalListenSeconds();

    if (tracks.length === 0) {
      body.innerHTML = `
        <div class="stats-empty">
          <p>–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–∫–æ–≤ —Å 3+ –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è–º–∏.</p>
          <p>–°–ª—É—à–∞–π—Ç–µ –º—É–∑—ã–∫—É ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!</p>
        </div>
        <div class="stats-total">
          <strong>–û–±—â–µ–µ –≤—Ä–µ–º—è:</strong> ${_formatTime(totalSec)}
        </div>`;
      return;
    }

    // Try to get track titles from global config
    let trackTitles = {};
    try {
      if (window._allTracksForStats) {
        window._allTracksForStats.forEach(t => { trackTitles[t.uid] = t.title; });
      }
    } catch (e) {}

    let html = '<div class="stats-list">';
    tracks.forEach((s, i) => {
      const title = trackTitles[s.uid] || s.uid;
      html += `
        <div class="stats-item">
          <span class="stats-rank">${i + 1}</span>
          <div class="stats-info">
            <span class="stats-title">${title}</span>
            <span class="stats-detail">
              –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π: ${s.globalFullListenCount || 0} |
              –í—Ä–µ–º—è: ${_formatTrackTime(s.globalListenSeconds || 0)}
            </span>
          </div>
        </div>`;
    });
    html += '</div>';

    html += `
      <div class="stats-total">
        <strong>–û–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è:</strong> ${_formatTime(totalSec)}
      </div>`;

    body.innerHTML = html;
  } catch (e) {
    body.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>';
    console.error('[StatsModal]', e);
  }
}

export { init, open, close };

//=================================================
// FILE: /src/js/track-resolver.js
/**
 * TrackResolver ‚Äî –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è playback (–¢–ó 19.1, 7.4.3)
 * –ù–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π Source Resolver: local ‚Üí network ‚Üí fallback
 */

import { getAudioEntry, getAudioBlobURL, getTrackMeta, saveTrackMeta } from './cache-db.js';
import { getMode, getActivePlaybackQuality, isNetworkAllowedForPlayback, MODES } from './mode-manager.js';

const BASE_URL_KEY = 'app:baseUrl:v1';

function _getBaseUrl() {
  return localStorage.getItem(BASE_URL_KEY) || '';
}

function setBaseUrl(url) {
  localStorage.setItem(BASE_URL_KEY, url);
}

/**
 * Get variant URL from track config
 * @param {Object} track - track object from config
 * @param {string} variant - 'hi' or 'lo'
 * @returns {string|null} relative path
 */
function getTrackVariantPath(track, variant) {
  if (!track) return null;
  if (variant === 'lo') return track.audio_low || null;
  return track.audio || null;
}

/**
 * Get size for variant (–¢–ó 11.2.E.4: defaults if missing)
 */
function getTrackSize(track, variant) {
  if (!track) return 5;
  if (variant === 'lo') return track.size_low || 3;
  return track.size || 8;
}

/**
 * Check if track has given variant available
 */
function hasVariant(track, variant) {
  return !!getTrackVariantPath(track, variant);
}

/**
 * –¢–ó 7.4.3 ‚Äî Normative Source Resolver
 * @param {Object} track - track object {uid, audio, audio_low, ...}
 * @param {string} [baseUrl] - base URL for remote files
 * @returns {Promise<{url, effectiveQuality, isLocal, cacheKind}>}
 */
async function resolvePlayback(track, baseUrl) {
  if (!track || !track.uid) {
    return { url: null, effectiveQuality: null, isLocal: false, cacheKind: 'none' };
  }

  const uid = track.uid;
  const mode = getMode();
  const apq = getActivePlaybackQuality();
  const base = baseUrl || _getBaseUrl();

  // Step 1: local copy matching ActivePlaybackQuality
  const audioEntry = await getAudioEntry(uid);
  if (audioEntry && audioEntry.variant === apq) {
    const blobUrl = URL.createObjectURL(audioEntry.blob);
    const meta = await getTrackMeta(uid);
    const kind = meta ? meta.cacheKind : 'dynamic';
    return { url: blobUrl, effectiveQuality: apq, isLocal: true, cacheKind: kind };
  }

  // Step 2: network (if allowed)
  if (mode !== MODES.R3 && isNetworkAllowedForPlayback()) {
    const path = getTrackVariantPath(track, apq);
    if (path) {
      const networkUrl = base ? `${base}/${path}` : path;
      return { url: networkUrl, effectiveQuality: apq, isLocal: false, cacheKind: 'none' };
    }
    // If desired variant path doesn't exist, try the other
    const fallbackVariant = apq === 'hi' ? 'lo' : 'hi';
    const fallbackPath = getTrackVariantPath(track, fallbackVariant);
    if (fallbackPath) {
      const networkUrl = base ? `${base}/${fallbackPath}` : fallbackPath;
      return { url: networkUrl, effectiveQuality: fallbackVariant, isLocal: false, cacheKind: 'none' };
    }
  }

  // Step 3: fallback ‚Äî local copy of different quality (best effort)
  if (audioEntry) {
    const blobUrl = URL.createObjectURL(audioEntry.blob);
    const meta = await getTrackMeta(uid);
    const kind = meta ? meta.cacheKind : 'dynamic';
    // Mark needsReCache (–¢–ó 7.4.3 step 3)
    if (meta && meta.cachedVariant !== apq) {
      meta.needsReCache = true;
      await saveTrackMeta(meta);
    }
    return { url: blobUrl, effectiveQuality: audioEntry.variant, isLocal: true, cacheKind: kind };
  }

  // No source available
  return { url: null, effectiveQuality: null, isLocal: false, cacheKind: 'none' };
}

/**
 * Resolve a specific variant URL for downloading
 */
function resolveVariantUrl(track, variant, baseUrl) {
  const base = baseUrl || _getBaseUrl();
  const path = getTrackVariantPath(track, variant);
  if (!path) return null;
  return base ? `${base}/${path}` : path;
}

/**
 * Check network availability (real check with timeout)
 */
async function checkNetworkAvailable(testUrl, timeout = 5000) {
  if (!navigator.onLine) return false;
  if (!testUrl) return navigator.onLine;
  try {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeout);
    const resp = await fetch(testUrl, {
      method: 'HEAD',
      mode: 'no-cors',
      signal: controller.signal
    });
    clearTimeout(timer);
    return true;
  } catch (e) {
    return false;
  }
}

export {
  resolvePlayback, resolveVariantUrl,
  getTrackVariantPath, getTrackSize, hasVariant,
  checkNetworkAvailable, setBaseUrl
};

//=================================================
// FILE: /src/player-core/media-session.js
// src/player-core/media-session.js
// MediaSession: handlers —Å—Ç–∞–≤–∏–º –æ–¥–∏–Ω —Ä–∞–∑, metadata/position –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ –º–µ—Ä–µ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏.

export function ensureMediaSession(handlers) {
  if (!('mediaSession' in navigator)) return null;

  const ms = navigator.mediaSession;

  // guard: —Å—Ç–∞–≤–∏–º handlers 1 —Ä–∞–∑
  if (!ms.__vitrinaHandlersBound) {
    ms.__vitrinaHandlersBound = true;

    const h = handlers || {};

    const safe = (fn) => () => { try { fn && fn(); } catch {} };

    ms.setActionHandler('play', safe(h.onPlay));
    ms.setActionHandler('pause', safe(h.onPause));
    ms.setActionHandler('stop', safe(h.onStop));
    ms.setActionHandler('previoustrack', safe(h.onPrev));
    ms.setActionHandler('nexttrack', safe(h.onNext));

    ms.setActionHandler('seekbackward', (details) => {
      const off = Number(details?.seekOffset || 10);
      try { h.onSeekBy && h.onSeekBy(-off); } catch {}
    });

    ms.setActionHandler('seekforward', (details) => {
      const off = Number(details?.seekOffset || 10);
      try { h.onSeekBy && h.onSeekBy(off); } catch {}
    });

    ms.setActionHandler('seekto', (details) => {
      const t = Number(details?.seekTime);
      if (!Number.isFinite(t)) return;
      try { h.onSeekTo && h.onSeekTo(t); } catch {}
    });
  }

  const buildArtwork = (artworkUrl) => {
    const src = String(artworkUrl || '').trim();
    if (!src) return [];
    return [
      { src, sizes: '96x96', type: 'image/png' },
      { src, sizes: '128x128', type: 'image/png' },
      { src, sizes: '192x192', type: 'image/png' },
      { src, sizes: '256x256', type: 'image/png' },
      { src, sizes: '384x384', type: 'image/png' },
      { src, sizes: '512x512', type: 'image/png' },
    ];
  };

  function updateMetadata({ title, artist, album, artworkUrl, playing } = {}) {
    try {
      ms.metadata = new MediaMetadata({
        title: String(title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
        artist: String(artist || ''),
        album: String(album || ''),
        artwork: buildArtwork(artworkUrl),
      });
    } catch {}

    try { ms.playbackState = playing ? 'playing' : 'paused'; } catch {}
  }

  function updatePositionState() {
    try {
      if (typeof ms.setPositionState !== 'function') return;
      const st = handlers?.getPositionState ? handlers.getPositionState() : null;
      if (!st) return;

      ms.setPositionState({
        duration: Number(st.duration || 0) || 0,
        playbackRate: Number(st.playbackRate || 1.0) || 1.0,
        position: Number(st.position || 0) || 0,
      });
    } catch {}
  }

  return { updateMetadata, updatePositionState };
}

//=================================================
// FILE: /src/player-core/stats-tracker.js
// src/player-core/stats-tracker.js
function safeUid(v) { return String(v || '').trim() || null; }

export function createListenStatsTracker({ getUid, getPos, getDur, record } = {}) {
  const state = { lastSecond: -1, activeUid: null };

  function onTick() {
    const uid = safeUid(getUid());
    if (!uid) return;
    
    if (uid !== state.activeUid) { state.activeUid = uid; state.lastSecond = -1; }
    
    const pos = Math.floor(getPos() || 0);
    if (pos > state.lastSecond) {
        state.lastSecond = pos;
        record(uid, { deltaSec: 1, isFullListen: false });
    }
  }

  function onEnded() {
    const uid = safeUid(getUid());
    if (!uid) return;
    
    const dur = getDur();
    const pos = getPos();
    // 90% threshold for full listen
    const isFull = (dur > 0 && (pos / dur) > 0.9);
    
    record(uid, { deltaSec: 0, isFullListen: isFull });
  }

  return { onTick, onEnded, onPauseOrStop: () => {} };
}

//=================================================
// FILE: /src/PlayerCore.js
// src/PlayerCore.js
import { getOfflineManager } from '../scripts/offline/offline-manager.js';
import { resolvePlaybackSource } from '../scripts/offline/track-resolver.js';
import { getTrackByUid } from '../scripts/app/track-registry.js';
import { Favorites } from '../scripts/core/favorites-manager.js';
import { ensureMediaSession } from './player-core/media-session.js';
import { createListenStatsTracker } from './player-core/stats-tracker.js';

(function () {
  'use strict';

  const W = window;
  const LS_VOL = 'playerVolume';
  const LS_PQ = 'qualityMode:v1';
  
  const normQ = (v) => (String(v || '').toLowerCase() === 'lo' ? 'lo' : 'hi');
  const safeStr = (v) => (v ? String(v).trim() : null);
  const clamp = (n, min, max) => Math.min(Math.max(n, min), max);

  class PlayerCore {
    constructor() {
      this.playlist = [];
      this.originalPlaylist = [];
      this.currentIndex = -1;
      this.shuffleMode = false;
      this.repeatMode = false;
      this.shuffleHistory = [];
      this.sound = null;
      this.qualityMode = normQ(localStorage.getItem(LS_PQ));
      this._loadToken = 0;
      this._ev = new Map();
      this._favSubs = new Set();
      this._sleepTimer = null;
      this._sleepTarget = 0;
      
      this._skipSession = { token: 0, count: 0, max: 0 };

      this._ms = ensureMediaSession({
        onPlay: () => this.play(), 
        onPause: () => this.pause(),
        onStop: () => this.pause(), 
        onPrev: () => this.prev(), 
        onNext: () => this.next(),
        onSeekTo: (t) => this.seek(t)
      });

      this._stats = createListenStatsTracker({
        getUid: () => safeStr(this.getCurrentTrack()?.uid),
        getPos: () => this.getPosition(),
        getDur: () => this.getDuration(),
        record: (uid, p) => getOfflineManager().recordListenStats(uid, p)
      });

      // iOS Unlock
      const unlock = () => {
        if (W.Howler?.ctx && W.Howler.ctx.state === 'suspended') {
          W.Howler.ctx.resume().catch(() => {});
        }
        if (!this._unlocked) {
          this._unlocked = true;
          const silent = new Howl({ src: ['data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIWFhYW5uYWFuYW5uYW5uYW5uYW5uYW5uYW5uYW5uYW5u//OEAAAAAAAAAAAAAAAAAAAAAAAAMGluZ2QAAAAcAAAABAAAASFycnJyc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nz//OEAAAAAAAAAAAAAAAAAAAAAAAATGF2YzU4Ljc2AAAAAAAAAAAAAAAAJAAAAAAAAAAAASCCOzuJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAJAAAAAAAAAAAASCCOzuJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'], html5: true, volume: 0 });
          silent.play();
        }
      };
      ['touchend', 'click', 'keydown'].forEach(e => document.addEventListener(e, unlock, { once: true, capture: true }));
    }

    initialize() {
      if (Favorites && Favorites.init) Favorites.init();
    }

    prepareContext() {
      if (W.Howler?.ctx?.state === 'suspended') W.Howler.ctx.resume().catch(() => {});
    }

    setPlaylist(tracks, startIdx = 0, meta, opts = {}) {
      const prevPos = this.getPosition();
      const wasPlaying = this.isPlaying();

      this.playlist = (tracks || []).map(t => ({
        ...t, uid: safeStr(t.uid), title: t.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', artist: t.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞'
      }));

      if (!opts.preserveOriginalPlaylist) this.originalPlaylist = [...this.playlist];

      this.currentIndex = clamp(startIdx, 0, this.playlist.length - 1);
      const targetUid = this.playlist[this.currentIndex]?.uid;

      if (this.shuffleMode && !opts.preserveShuffleMode) {
        this.shufflePlaylist(targetUid);
      } else if (!this.shuffleMode) {
        this.shuffleHistory = [];
      } else if (this.shuffleMode && opts.preserveShuffleMode && targetUid) {
        const newIdx = this.playlist.findIndex(t => t.uid === targetUid);
        if (newIdx >= 0) this.currentIndex = newIdx;
      }

      this._skipSession = { token: 0, count: 0, max: this.playlist.length };

      const currentTrack = this.getCurrentTrack();
      const sameTrack = currentTrack && this.sound && currentTrack.uid === targetUid;

      if (sameTrack && wasPlaying && opts.preservePosition) {
          this._emit('onTrackChange', currentTrack, this.currentIndex);
          this._updMedia();
      } else {
          if (wasPlaying) this.load(this.currentIndex, { autoPlay: true, resumePosition: opts.preservePosition ? prevPos : 0 });
          else {
            this._emit('onTrackChange', this.getCurrentTrack(), this.currentIndex);
            this._updMedia();
          }
      }
    }

    shufflePlaylist(keepFirstUid = null) {
      const currentUid = keepFirstUid || this.getCurrentTrack()?.uid;
      for (let i = this.playlist.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [this.playlist[i], this.playlist[j]] = [this.playlist[j], this.playlist[i]];
      }
      if (currentUid) {
        const idx = this.playlist.findIndex(t => t.uid === currentUid);
        if (idx >= 0) {
          const [track] = this.playlist.splice(idx, 1);
          this.playlist.unshift(track);
          this.currentIndex = 0;
        }
      } else {
        this.currentIndex = 0;
      }
    }

    getPlaylistSnapshot() { return [...this.playlist]; }
    getCurrentTrack() { return this.playlist[this.currentIndex] || null; }
    getIndex() { return this.currentIndex; }
    getNextIndex() { return (this.currentIndex + 1) % this.playlist.length; }

    isPlaying() { return !!(this.sound && this.sound.playing()); }

    play(idx, opts = {}) {
      this.prepareContext();
      if (idx != null) {
          if (idx === this.currentIndex && this.sound) {
             if (!this.isPlaying()) this.sound.play();
             return;
          }
          return this.load(idx, opts);
      }
      if (this.sound) {
        if (!this.isPlaying()) this.sound.play();
      } else if (this.currentIndex >= 0) {
        this.load(this.currentIndex, { autoPlay: true });
      }
    }

    pause() { this.sound?.pause(); }
    
    stop() {
      this._unload();
      this._emit('onStop');
      this._updMedia();
    }

    next() {
      if (!this.playlist.length) return;
      if (this.shuffleMode) {
        this.shuffleHistory.push(this.currentIndex);
        if (this.shuffleHistory.length > 50) this.shuffleHistory.shift();
      }
      const nextIdx = (this.currentIndex + 1) % this.playlist.length;
      this.load(nextIdx, { autoPlay: true, dir: 1 });
    }

    prev() {
      if (!this.playlist.length) return;
      if (this.getPosition() > 3) return this.seek(0);
      if (this.shuffleMode && this.shuffleHistory.length) {
        return this.load(this.shuffleHistory.pop(), { autoPlay: true, dir: -1 });
      }
      const prevIdx = (this.currentIndex - 1 + this.playlist.length) % this.playlist.length;
      this.load(prevIdx, { autoPlay: true, dir: -1 });
    }

    seek(sec) { return this.sound?.seek(sec) || 0; }
    
    setVolume(v) { 
      const vol = clamp(v / 100, 0, 1);
      Howler.volume(vol);
      localStorage.setItem(LS_VOL, Math.round(vol * 100));
    }
    getVolume() { return Number(localStorage.getItem(LS_VOL)) || 100; }
    getPosition() { return this.sound?.seek() || 0; }
    getDuration() { return this.sound?.duration() || 0; }

    async load(index, opts = {}) {
      const track = this.playlist[index];
      if (!track) return;

      const token = ++this._loadToken;
      this.currentIndex = index;
      
      if (!opts.isAutoSkip) this._skipSession = { token, count: 0, max: this.playlist.length };

      const om = getOfflineManager();
      const res = await resolvePlaybackSource({ track }); 
      
      if (token !== this._loadToken) return;

      this._emit('onTrackChange', track, index);

      // --- –¢–ó 7.5.3: –°—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–µ—Ç–∏ / R3 ---
      if (!res.url) {
        // –í R3: –ø–∞—É–∑–∞ –∏ –º–æ–¥–∞–ª–∫–∞, –Ω–∏–∫–∞–∫–∏—Ö —Å–∫–∏–ø–æ–≤ (7.5.4)
        if (om.getMode() === 'R3') {
            this.pause(); 
            W.Modals?.confirm?.({
                title: '100% OFFLINE',
                textHtml: '–¢—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ.<br>–í —Ä–µ–∂–∏–º–µ 100% Offline —Å–µ—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–∞.',
                confirmText: '–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
                cancelText: '–û–ö',
                onConfirm: () => { import('../scripts/ui/offline-modal.js').then(m => m.openOfflineModal()); }
            });
            this._stopTick();
            return;
        }

        // –í R0/R1/R2: –ê–≤—Ç–æ—Å–∫–∏–ø (7.5.3)
        if (this._skipSession.count >= this._skipSession.max) {
           W.NotificationSystem?.error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');
           this.pause();
           this._stopTick();
           return;
        }
        
        console.warn(`[Player] Source missing for ${track.uid}, skipping...`);
        if (!opts._skipChain) opts._skipChain = 0;
        
        setTimeout(() => {
           if (token === this._loadToken) {
             this._skipSession.count++;
             const nextIdx = (index + (opts.dir || 1) + this.playlist.length) % this.playlist.length;
             if (nextIdx !== index) this.load(nextIdx, { ...opts, autoPlay: true, _skipChain: opts._skipChain + 1 });
           }
        }, 100);
        return;
      }

      // --- –¢–ó 4.2 / Hot Swap Logic ---
      const isHotSwap = !!opts.isHotSwap;
      const oldSound = this.sound; 

      if (!isHotSwap) this._unload(true); // –ï—Å–ª–∏ –Ω–µ swap, —Å—Ä–∞–∑—É —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π

      // –¢–ó 16.1: WebAudio backend –¥–ª—è –æ—Ñ–ª–∞–π–Ω–∞ (isLocal), HTML5 –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
      const useHtml5 = !res.isLocal;

      const newSound = new Howl({
        src: [res.url],
        html5: useHtml5,
        volume: this.getVolume() / 100,
        format: ['mp3'],
        autoplay: !!opts.autoPlay,
        onload: () => {
          if (token !== this._loadToken) { newSound.unload(); return; }
          
          // Hot Swap: –≤—ã–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ–≥–æ
          if (isHotSwap && oldSound) {
              try { oldSound.unload(); } catch(e) { console.warn('HotSwap unload err', e); }
          }

          if (opts.resumePosition) newSound.seek(opts.resumePosition);
          this._updMedia();
        },
        onplay: () => {
          if (token !== this._loadToken) { newSound.stop(); return; }
          this._startTick();
          this._emit('onPlay', track, index);
          this._updMedia();
        },
        onpause: () => {
          if (token !== this._loadToken) return;
          this._stopTick();
          this._stats.onPauseOrStop();
          this._emit('onPause');
          this._updMedia();
        },
        onend: () => {
          if (token !== this._loadToken) return;
          this._stats.onEnded();
          this._emit('onEnd');
          this.repeatMode ? this.play(this.currentIndex) : this.next();
        },
        onloaderror: (id, e) => {
           console.error('Load Error', e);
           // Retry only if it was network
           if (token === this._loadToken && !res.isLocal) {
              W.NotificationSystem?.warning('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏, —Å–ª–µ–¥—É—é—â–∞—è...');
              setTimeout(() => this.next(), 1000);
           }
        }
      });

      this.sound = newSound;

      // --- –¢–ó 7.6.1: –í R0 "–Ω–∏–∫–∞–∫–æ–µ –∞—É–¥–∏–æ –ø–æ —Ñ–∞–∫—Ç—É –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è" ---
      const mode = om.getMode();
      if (track.uid && mode !== 'R0' && mode !== 'R3') {
         om.enqueueAudioDownload({ 
             uid: track.uid, 
             quality: res.effectiveQuality, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–µ–Ω–Ω–æ —Ç–æ –∫–∞—á–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –∏–≥—Ä–∞–µ—Ç
             priority: 100, 
             kind: 'playbackCache' 
         });
      }
    }

    _unload(silent) {
      if (this.sound) { 
        try { this.sound.stop(); } catch {}
        try { this.sound.unload(); } catch {}
        this.sound = null; 
      }
      this._stopTick();
      this._stats.onPauseOrStop();
      if (!silent) this._emit('onStop');
    }

    canToggleQualityForCurrentTrack() {
      const t = this.getCurrentTrack();
      const m = t ? getTrackByUid(t.uid) : null;
      return !!(m?.audio_low || m?.urlLo || t?.sources?.audio?.lo);
    }

    switchQuality(mode) {
      const next = normQ(mode);
      if (this.qualityMode === next) return;
      
      this.qualityMode = next;
      localStorage.setItem(LS_PQ, next);
      window.dispatchEvent(new CustomEvent('offline:uiChanged'));
      
      // –¢–ó 4.2: Quiet Switch (–±–µ–∑ stop)
      if (this.currentIndex >= 0 && this.sound) {
          const wasPlaying = this.isPlaying();
          const pos = this.getPosition();
          this.load(this.currentIndex, { 
              autoPlay: wasPlaying, 
              resumePosition: pos, 
              isHotSwap: true 
          });
      }
    }

    isFavorite(uid) { return Favorites.isLiked(safeStr(uid)); }

    toggleFavorite(uid, opts = {}) {
      const u = safeStr(uid);
      
      let source = opts.source;
      if (!source) {
         if (opts.fromAlbum) {
             source = 'album';
         } else {
             const isFavView = W.AlbumsManager?.getCurrentAlbum?.() === W.SPECIAL_FAVORITES_KEY;
             source = isFavView ? 'favorites' : 'album';
         }
      }
      
      const liked = Favorites.toggle(u, { source, albumKey: opts.albumKey });
      this._emitFav(u, liked, opts.albumKey);

      if (!liked && source === 'favorites' && W.AlbumsManager?.getCurrentAlbum?.() === W.SPECIAL_FAVORITES_KEY) {
         if (safeStr(this.getCurrentTrack()?.uid) === u) {
            const hasActive = Favorites.getSnapshot().some(i => !i.inactiveAt);
            if (!hasActive) this.stop();
            else if (!this.repeatMode) this.next();
         }
      }
      return { liked };
    }

    removeInactivePermanently(uid) {
      const u = safeStr(uid);
      if (Favorites.remove(u)) this._emitFav(u, false, null, true);
    }
    
    restoreInactive(uid) { return this.toggleFavorite(uid, { source: 'favorites' }); }

    showInactiveFavoriteModal(p = {}) {
      if (!W.Modals?.open) return;
      const u = safeStr(p.uid);
      const esc = W.Utils?.escapeHtml || (s => s);
      const modal = W.Modals.open({
        title: '–¢—Ä–µ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω', maxWidth: 420,
        bodyHtml: `
          <div style="color:#9db7dd;margin-bottom:14px">
            <div style="margin-bottom:8px"><strong>${esc(p.title||'–¢—Ä–µ–∫')}</strong></div>
            <div style="opacity:.9">–í–µ—Ä–Ω—É—Ç—å –≤ ‚≠ê –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞?</div>
          </div>
          ${W.Modals.actionRow([{act:'add',text:'–í–µ—Ä–Ω—É—Ç—å',className:'online'},{act:'remove',text:'–£–¥–∞–ª–∏—Ç—å'}])}
        `
      });
      modal.querySelector('[data-act="add"]')?.addEventListener('click', () => { modal.remove(); this.restoreInactive(u); });
      modal.querySelector('[data-act="remove"]')?.addEventListener('click', () => {
        modal.remove();
        this.removeInactivePermanently(u);
        p.onDeleted?.();
      });
    }

    getFavoritesState() {
      const items = Favorites.getSnapshot();
      const active = [], inactive = [];
      items.forEach(item => {
        const u = safeStr(item.uid);
        if (!u) return;
        const sa = safeStr(item.sourceAlbum || item.albumKey || getTrackByUid(u)?.sourceAlbum);
        if (item.inactiveAt) inactive.push({ uid: u, sourceAlbum: sa, inactiveAt: item.inactiveAt });
        else active.push({ uid: u, sourceAlbum: sa });
      });
      return { active, inactive };
    }

    getLikedUidsForAlbum(key) {
      const k = safeStr(key);
      if (!k) return [];
      return Favorites.getSnapshot()
        .filter(i => !i.inactiveAt && safeStr(getTrackByUid(i.uid)?.sourceAlbum) === k)
        .map(i => i.uid);
    }

    onFavoritesChanged(cb) { this._favSubs.add(cb); return () => this._favSubs.delete(cb); }
    _emitFav(uid, liked, albumKey, removed = false) { this._favSubs.forEach(f => f({ uid, liked, albumKey, removed })); }

    toggleShuffle() {
      this.shuffleMode = !this.shuffleMode;
      if (this.shuffleMode) {
        this.shufflePlaylist();
      } else {
        const uid = this.getCurrentTrack()?.uid;
        this.playlist = [...this.originalPlaylist];
        if (uid) this.currentIndex = this.playlist.findIndex(t => t.uid === uid);
      }
    }
    isShuffle() { return this.shuffleMode; }
    toggleRepeat() { this.repeatMode = !this.repeatMode; }
    isRepeat() { return this.repeatMode; }

    on(evs) { Object.entries(evs).forEach(([k, fn]) => { if(!this._ev.has(k)) this._ev.set(k, new Set()); this._ev.get(k).add(fn); }); }
    _emit(name, ...args) { this._ev.get(name)?.forEach(fn => fn(...args)); }

    _startTick() {
      this._stopTick();
      this._tickInt = setInterval(() => {
        this._emit('onTick', this.getPosition(), this.getDuration());
        this._stats.onTick();
      }, 250);
    }
    _stopTick() { clearInterval(this._tickInt); }

    _updMedia() {
      const t = this.getCurrentTrack();
      this._ms.updateMetadata({ title: t?.title, artist: t?.artist, album: t?.album, artworkUrl: t?.cover, playing: this.isPlaying() });
    }

    setSleepTimer(ms) {
      clearTimeout(this._sleepTimer);
      this._sleepTarget = ms > 0 ? Date.now() + ms : 0;
      if (ms > 0) this._sleepTimer = setTimeout(() => { this.pause(); this._emit('onSleepTriggered'); }, ms);
    }
    getSleepTimerTarget() { return this._sleepTarget; }
    clearSleepTimer() { this.setSleepTimer(0); }
  }

  W.playerCore = new PlayerCore();
  const boot = () => W.playerCore.initialize();
  document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', boot) : boot();
})();

//=================================================
// FILE: /styles/main.css
:root{--primary-bg:#181818;--primary-color:#e80100;--secondary-color:#4daaff;--text-color:#f2f2f2;--modal-bg:#252d39;--border-color:#394866;--btn-size:44px;--btn-radius:8px;--bg-0:#0f1218;--c-blue:#8ab8fd;--c-w:#fff;--c-e:#eee;--shadow-1:0 4px 24px rgba(0,0,0,.3);--shadow-2:0 8px 32px rgba(0,0,0,.4);--grad-blue:linear-gradient(90deg,#4daaff,#357ac9);--om-bd:rgba(255,255,255,.10);--om-sub:#9db7dd}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:rgba(0,0,0,0)}
html,body{height:100%;background:var(--primary-bg);color:var(--text-color);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;display:flex;flex-direction:column}
body{min-height:100vh;min-width:100vw;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;padding-top:env(safe-area-inset-top);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.hidden{display:none!important}

/* Promocode */
#promocode-block{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--primary-bg);z-index:100}
.promo-inner{display:flex;flex-direction:column;align-items:center;background:rgba(15,18,24,.98);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.5);padding:36px 26px 32px;min-width:280px;max-width:90vw}
.promo-cover{width:256px;height:256px;max-width:70vw;max-height:70vw;object-fit:cover;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,.7);margin-bottom:19px;display:block;background:var(--primary-bg)}
.promo-inner h2{margin-bottom:16px;color:var(--secondary-color);font-size:20px}
#promo-inp{padding:12px 16px;border-radius:8px;border:1px solid var(--border-color);background:rgba(255,255,255,.1);color:var(--text-color);margin:10px 0;width:100%;max-width:280px;font-size:16px;outline:0;transition:border-color .3s}
#promo-inp:focus{border-color:var(--secondary-color)}
#promo-inp.error{border-color:var(--primary-color);animation:shake .3s}
@keyframes shake{0%,to{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
#promo-btn{padding:12px 32px;background:var(--primary-color);color:var(--c-w);border:0;border-radius:8px;cursor:pointer;font-weight:800;font-size:16px;transition:opacity .2s,transform .1s;margin-top:8px}
#promo-btn:hover:not(:disabled){opacity:.9;transform:translateY(-1px)}
#promo-btn:active{transform:translateY(0)}
#promo-btn:disabled{opacity:.5;cursor:not-allowed}
#promo-error{color:#ff6b6b;margin-top:12px;font-size:14px;min-height:20px}

/* Layout */
#main-block{max-width:420px;margin:0 auto;flex:1 0 auto;display:flex;flex-direction:column;align-items:center;width:100%;padding:0 10px;padding-bottom:env(safe-area-inset-bottom)}
header{width:100%;text-align:center;margin:0 auto}

/* Album title */
.active-album-title{width:100%;max-width:400px;margin:18px auto 6px;text-align:center;color:#eaf2ff;font-weight:900;letter-spacing:.01em;line-height:1.15;text-shadow:0 1px 0 rgba(0,0,0,.35);font-size:clamp(18px,4.6vw,24px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.active-album-title.fav{color:#ffd166;letter-spacing:.06em}
.active-album-title.news{color:var(--c-blue);letter-spacing:.02em}

/* Album icons */
.album-icons{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;align-items:center;justify-items:center;margin:12px auto 0;max-width:400px;width:100%;padding:4px 8px;overflow:hidden}
.album-icons::-webkit-scrollbar{display:none}
.album-icon[data-album="__favorites__"]{grid-row:2;grid-column:2}
.album-icon[data-album="__reliz__"]{grid-row:2;grid-column:3}
.album-icon[data-album="odnazhdy-v-skazke"],.album-icon[data-album="golos-dushi"],.album-icon[data-album="mezhdu-zlom-i-dobrom"],.album-icon[data-album="krevetochka"]{grid-row:1}
.album-icon{width:clamp(62px,16vw,82px);height:clamp(62px,16vw,82px);border-radius:10px;overflow:hidden;border:1px solid var(--border-color);cursor:pointer;filter:grayscale(70%) brightness(.88);opacity:.72;transition:transform .15s,filter .15s,opacity .15s,box-shadow .15s,width .15s ease,height .15s ease;touch-action:manipulation;-webkit-touch-callout:none}
.album-icon img{width:100%;height:100%;object-fit:cover;display:block}
.album-icon.active{filter:none;opacity:1;box-shadow:0 2px 10px rgba(0,0,0,.35);width:clamp(68px,17vw,88px);height:clamp(68px,17vw,88px)}
.album-icon:hover{transform:translateY(-2px);opacity:.9}
.album-icon:active{transform:translateY(0) scale(.95)}

/* Common tap/click targets */
.track,.like-star,.player-control-btn,.sleep-timer-btn,.offline-btn,.lyrics-toggle-btn,.animation-btn,.pulse-btn,.karaoke-btn,.player-download-btn,button,a,input,select,textarea,[role="button"]{touch-action:manipulation;-webkit-touch-callout:none}

/* Cover / gallery */
#cover-wrap{width:100%;max-width:400px;margin:14px auto 0;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;position:relative}
.cover-gallery-arrow{position:absolute;top:50%;transform:translateY(-50%);z-index:2;border:0;cursor:pointer;background:0 0;padding:0;width:44px;height:44px;display:flex;align-items:center;justify-content:center;transition:opacity .2s;visibility:hidden;pointer-events:none}
.cover-gallery-arrow:hover{opacity:.8}
.cover-gallery-arrow:active{transform:translateY(-50%) scale(.9)}
#cover-gallery-arrow-left{left:7px}
#cover-gallery-arrow-right{right:7px}
#cover-wrap.gallery-nav-ready .cover-gallery-arrow{visibility:visible;pointer-events:auto}
#cover-slot{width:100%;height:100%;border-radius:12px;overflow:hidden;background:var(--primary-bg);box-shadow:var(--shadow-1);position:relative}
#cover-slot iframe,#cover-slot img{width:100%;height:100%;display:block;border:0;background:0 0}
#cover-slot img{object-fit:contain}

/* Socials */
.socials-under-cover{margin:14px auto 0;width:100%;max-width:398px;text-align:center;font-size:1.03em;display:flex;flex-wrap:wrap;justify-content:center;gap:12px}
.socials-under-cover a{color:var(--secondary-color);text-decoration:none;transition:color .2s;padding:4px 8px}
.socials-under-cover a:hover{color:var(--text-color);text-decoration:underline}

/* Player */
.lyrics-player-block{max-width:370px;width:100%;margin:20px auto 0;background:linear-gradient(180deg,rgba(30,34,45,.95),rgba(15,18,24,.98));border-radius:14px;overflow:hidden;box-shadow:var(--shadow-2);position:relative}

/* Lyrics window */
#lyrics-window{position:relative;overflow:hidden;border-radius:12px 12px 0 0;background:var(--bg-0);transition:height .2s ease,opacity .2s ease}
#lyrics-window.lyrics-normal{height:8.7em}
#lyrics-window.lyrics-expanded{height:15.6em}
#lyrics-window.lyrics-hidden{height:0!important;opacity:0!important;pointer-events:none!important;margin:0!important}
.lyrics-scroll{position:relative;z-index:1;display:flex;flex-direction:column;justify-content:center;height:100%;overflow:hidden;padding:0}
.lyrics-scroll::-webkit-scrollbar{display:none}
.lyrics-window-line{text-align:center;padding:6px 16px;color:var(--c-e);font-size:15px;opacity:.57;transition:color .25s,opacity .25s,font-size .25s,font-weight .25s,background .25s;user-select:none;line-height:1.35}
.lyrics-window-line.active{color:var(--primary-color);font-size:1.19em;font-weight:800;opacity:1;background:rgba(0,0,0,.07);text-shadow:0 1px 7px rgba(115,22,22,.27)}
.lyrics-placeholder{text-align:center;padding:40px 16px;color:#5a6989;font-size:14px;opacity:.6;user-select:none}
.lyrics-spinner{width:40px;height:40px;margin:40px auto;border:4px solid rgba(77,170,255,.2);border-top-color:var(--secondary-color);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Countdown */
.lyrics-countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:4em;font-weight:900;color:rgba(77,170,255,.35);z-index:0;pointer-events:none;user-select:none;text-shadow:0 2px 12px rgba(77,170,255,.2);animation:countdownPulse 1s ease-in-out infinite}
.lyrics-countdown.fade-out{animation:countdownFadeOut 1s ease-out forwards}
@keyframes countdownPulse{0%,to{transform:scale(1);opacity:.35}50%{transform:scale(1.05);opacity:.45}}
@keyframes countdownFadeOut{from{opacity:.35;transform:scale(1)}to{opacity:0;transform:scale(.9)}}

/* Animated bg */
.lyrics-animated-bg{position:absolute;inset:0;opacity:0;pointer-events:none;z-index:0;transition:opacity .5s;background:linear-gradient(45deg,rgba(232,1,0,.15),rgba(77,170,255,.15),rgba(232,1,0,.15));background-size:400% 400%;animation:none}
.lyrics-animated-bg.active{opacity:1;animation:lyricsGradient 10s ease infinite}
@keyframes lyricsGradient{0%{background-position:0 50%}50%{background-position:100% 50%}to{background-position:0 50%}}

/* Progress */
.player-progress-wrapper{padding:16px 20px 12px;background:rgba(15,18,24,.6)}
.player-progress-bar{position:relative;height:6px;background:rgba(255,255,255,.08);border-radius:3px;cursor:pointer;overflow:visible}
.player-progress-fill{position:relative;height:100%;background:var(--grad-blue);border-radius:3px;width:0%;transition:width .1s linear}
.player-progress-handle{position:absolute;right:-7px;top:50%;transform:translateY(-50%);width:14px;height:14px;background:var(--c-w);border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.4);opacity:0;transition:opacity .2s,transform .1s}
.player-progress-bar:hover .player-progress-handle{opacity:1}
.player-progress-handle:hover{transform:translateY(-50%) scale(1.2)}

/* Controls */
.player-controls{padding:14px 18px 16px;background:rgba(25,28,36,.8)}
.player-controls-row{display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:12px}
.player-controls-row:last-child{margin-bottom:0}
.time-in-controls{color:var(--c-blue);font-size:13px;min-width:42px;text-align:center;font-variant-numeric:tabular-nums;font-weight:500}
.player-control-btn,.sleep-timer-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:var(--c-blue);cursor:pointer;padding:10px;border-radius:50%;transition:.25s;display:flex;align-items:center;justify-content:center;width:var(--btn-size);height:var(--btn-size);outline:0}
.player-control-btn:hover,.sleep-timer-btn:hover{background:rgba(77,170,255,.15);border-color:rgba(77,170,255,.3);transform:scale(1.05)}
.player-control-btn:active,.sleep-timer-btn:active{transform:scale(.95)}
.player-control-btn.main{background:var(--primary-color);border-color:var(--primary-color);color:var(--c-w);width:52px;height:52px}
.player-control-btn.main:hover{background:#c60000}
.player-control-btn svg{width:20px;height:20px}
.player-control-btn.main svg{width:24px;height:24px}
.player-control-btn.active,.player-control-btn.repeat-active,.sleep-timer-btn.active{background:rgba(77,170,255,.2);border-color:var(--secondary-color);color:var(--secondary-color);box-shadow:0 0 12px rgba(77,170,255,.3)}

/* Favorites */
#favorites-btn{position:relative}
#favorites-btn-icon{width:18px;height:18px;transition:transform .2s}
#favorites-btn.favorites-active{background:rgba(77,170,255,.2);border-color:var(--secondary-color)}
#favorites-btn.favorites-active #favorites-btn-icon{transform:scale(1.2)}

/* PQ */
#pq-btn{position:relative}
#pq-btn .pq-btn-label{font-weight:900;font-size:14px;letter-spacing:.02em}
#pq-btn.pq-hi{background:rgba(39,179,76,.16);border-color:rgba(39,179,76,.35);color:#b8ffd0}
#pq-btn.pq-lo{background:rgba(255,152,0,.16);border-color:rgba(255,152,0,.35);color:#ffe0b2}
#pq-btn.disabled{background:rgba(30,30,30,.6)!important;border-color:rgba(255,255,255,.06)!important;color:rgba(255,255,255,.25)!important;box-shadow:none!important;cursor:not-allowed!important;opacity:.6}

/* Sleep menu */
.sleep-timer-btn{position:relative}
.sleep-timer-badge{position:absolute;top:-4px;right:-4px;background:var(--primary-color);color:var(--c-w);font-size:10px;font-weight:800;border-radius:10px;padding:2px 6px;min-width:18px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.4)}
.sleep-menu{position:absolute;bottom:100%;right:0;margin-bottom:8px;background:var(--modal-bg);border:1px solid var(--border-color);border-radius:10px;padding:8px;box-shadow:0 4px 20px rgba(0,0,0,.5);min-width:180px;z-index:100}
.sleep-menu-item{padding:10px 14px;cursor:pointer;border-radius:6px;transition:background .2s;color:var(--text-color);font-size:14px}
.sleep-menu-item:hover{background:rgba(77,170,255,.15)}
.sleep-menu-item.active{background:rgba(77,170,255,.2);color:var(--secondary-color)}

/* Sleep timer: time dialog (HH:MM) */
.sleep-time-modal-backdrop{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;padding:14px}
.sleep-time-modal{width:min(360px,100%);background:var(--modal-bg);border:1px solid var(--border-color);border-radius:14px;padding:14px;box-shadow:0 8px 40px rgba(0,0,0,.6)}
.sleep-time-title{color:var(--secondary-color);font-weight:900;margin:0 0 12px;text-align:center}
.sleep-time-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:12px}
.sleep-time-input{width:72px;text-align:center;padding:10px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text-color);outline:none}
.sleep-time-sep{opacity:.75}
.sleep-time-actions{display:flex;justify-content:flex-end;gap:8px}
.sleep-time-btn{padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text-color);cursor:pointer;font-weight:800}
.sleep-time-btn.primary{background:rgba(77,170,255,.25);border-color:rgba(77,170,255,.35);color:var(--secondary-color)}

/* Volume */
.volume-control-wrapper{position:relative;padding:16px 20px 12px;background:rgba(15,18,24,.5);border-top:1px solid rgba(255,255,255,.05)}
.volume-track{position:relative;height:6px;background:rgba(255,255,255,.08);border-radius:3px}
.volume-fill{position:absolute;inset:0 auto auto 0;height:6px;background:var(--grad-blue);width:0%;border-radius:3px;pointer-events:none;transition:width .08s linear}
.volume-handle{position:absolute;top:50%;left:0;transform:translate(-50%,-50%);width:14px;height:14px;background:var(--c-w);border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.35);pointer-events:none;z-index:3;transition:left .05s linear}
.volume-slider{position:absolute;left:20px;right:20px;top:50%;transform:translateY(-50%);height:28px;background:0 0;outline:0;-webkit-appearance:none;cursor:pointer;z-index:4;margin:0}
.volume-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:0 0;border-radius:50%;cursor:pointer;box-shadow:none}
.volume-slider::-moz-range-thumb{width:14px;height:14px;background:0 0;border-radius:50%;cursor:pointer;border:0;box-shadow:none}

/* Extra buttons */
.player-buttons-wrapper{background:rgba(15,18,24,.5);padding:12px 16px;border-top:1px solid rgba(255,255,255,.05);display:flex;gap:8px;flex-wrap:wrap}
.player-extra-buttons-row{display:flex;flex:1;gap:8px;justify-content:space-between;width:100%}
.lyrics-toggle-btn,.animation-btn,.pulse-btn,.karaoke-btn,.player-download-btn{width:var(--btn-size);min-width:var(--btn-size);max-width:var(--btn-size);height:var(--btn-size);min-height:var(--btn-size);max-height:var(--btn-size);padding:0;border-radius:var(--btn-radius);font-weight:800;font-size:18px;cursor:pointer;transition:transform .1s,background .2s,border-color .2s,box-shadow .2s,color .2s;text-align:center;text-decoration:none;display:flex;align-items:center;justify-content:center;flex-shrink:0;user-select:none}
.lyrics-toggle-btn,.karaoke-btn{background:rgba(77,170,255,.12);border:1px solid rgba(77,170,255,.25);color:var(--secondary-color)}
.lyrics-toggle-btn:hover,.karaoke-btn:hover{background:rgba(77,170,255,.2);transform:translateY(-1px)}
.lyrics-toggle-btn:active,.karaoke-btn:active{transform:translateY(0)}
.lyrics-toggle-btn-visual{display:inline-block;line-height:1;transition:font-size .2s,color .2s,transform .1s;pointer-events:none}
.lyrics-toggle-btn.lyrics-normal .lyrics-toggle-btn-visual{color:var(--secondary-color);font-size:28px}
.lyrics-toggle-btn.lyrics-expanded .lyrics-toggle-btn-visual{color:var(--secondary-color);font-size:18px}
.lyrics-toggle-btn.lyrics-hidden{background:rgba(232,1,0,.12);border-color:rgba(232,1,0,.25)}
.lyrics-toggle-btn.lyrics-hidden .lyrics-toggle-btn-visual{color:var(--primary-color);font-size:28px}
.lyrics-toggle-btn.lyrics-hidden:hover{background:rgba(232,1,0,.2);border-color:rgba(232,1,0,.35)}
.animation-btn{background:linear-gradient(135deg,#4a1a7a,#2a0a4a);border:1px solid rgba(138,43,226,.3);color:#c8a2ff}
.animation-btn.active{background:linear-gradient(135deg,#5a2a8a,#3a1a5a);box-shadow:0 0 12px rgba(138,43,226,.4)}
.animation-btn:hover{background:linear-gradient(135deg,#5a2a8a,#3a1a5a);transform:translateY(-1px)}
.pulse-btn{background:linear-gradient(135deg,#2a2a2a,#1a1a1a);border:1px solid rgba(255,255,255,.1);color:var(--c-w);font-size:20px}
.pulse-btn.active{background:linear-gradient(135deg,#4a1a1a,#2a0a0a);border-color:rgba(232,1,0,.3);color:var(--primary-color);box-shadow:0 0 12px rgba(232,1,0,.3)}
.pulse-btn:hover{background:linear-gradient(135deg,#3a3a3a,#2a2a2a);transform:translateY(-1px)}
.player-download-btn{background:linear-gradient(135deg,#1a4a7a,#0a2a4a);border:1px solid rgba(77,170,255,.3);color:var(--secondary-color)}
.player-download-btn:hover{background:linear-gradient(135deg,#2a5a8a,#1a3a5a);transform:translateY(-1px);box-shadow:0 4px 12px rgba(77,170,255,.2)}
.lyrics-toggle-btn.disabled,.animation-btn.disabled,.karaoke-btn.disabled{background:rgba(30,30,30,.6)!important;border-color:rgba(255,255,255,.06)!important;color:rgba(255,255,255,.2)!important;box-shadow:none!important;cursor:not-allowed!important;opacity:.5;pointer-events:none;filter:grayscale(100%)}
.lyrics-toggle-btn.disabled .lyrics-toggle-btn-visual{color:rgba(255,255,255,.2)!important}
@media (hover:hover){.lyrics-toggle-btn.disabled:hover,.animation-btn.disabled:hover,.karaoke-btn.disabled:hover{transform:none!important}}

/* Track list */
.track-list{margin:0 auto;max-width:370px;width:100%;font-size:1.05em;color:var(--c-e);background:0 0;padding:0}

/* Favorites empty */
.fav-empty{padding:20px;text-align:center;color:#8ab8fd}
.fav-empty h3{margin:0 0 10px}
.fav-empty p{margin:0;opacity:.9}

/* News inline (album __reliz__) */
.news-inline__head{padding:14px 10px;text-align:center;color:#8ab8fd}
.news-inline__links{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:12px}
.news-inline__links a{color:#4daaff;text-decoration:underline}
.news-inline__dot{opacity:.6}
.news-inline__status{opacity:.85}
.news-inline__status--error{color:#ff6b6b}
.news-inline__list{display:grid;gap:12px;padding:0 0 10px}

.news-inline__card{background:#131a26;border:1px solid #23324a;border-radius:12px;padding:12px;box-shadow:0 4px 16px rgba(0,0,0,.25)}
.news-inline__title{font-weight:900;font-size:16px;color:#eaf2ff}
.news-inline__date{color:#9db7dd;font-size:13px;margin-top:6px}
.news-inline__text{margin-top:8px;line-height:1.45;color:#eaf2ff}

.news-inline__media{margin:10px 0}
.news-inline__media iframe,.news-inline__media img,.news-inline__media video{width:100%;border:0;border-radius:10px;min-height:220px;background:#0b0e15}
.news-inline__media img{min-height:auto}
.news-inline__tags{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.news-inline__tag{font-size:12px;color:#4daaff;background:rgba(77,170,255,.12);border:1px solid rgba(77,170,255,.25);padding:4px 8px;border-radius:999px}
.track{display:flex;align-items:center;padding:9px 10px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:background .13s,transform .1s;background:0 0;-webkit-user-select:none;user-select:none}
.track:hover{background:rgba(255,255,255,.05)}
.track.current{background:#232b38;border-left:3px solid var(--secondary-color)}
.track:active{transform:scale(.98);background:rgba(255,255,255,.08)!important}
.track.inactive{opacity:.45;filter:grayscale(.6)}

/* FavoritesOnly: UI-only —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ ‚≠ê (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ playback) */
.track-list.favonly-filtered .track[data-hidden-by-favonly="1"]{display:none!important}
.track.is-favorite{background:rgba(77,170,255,.06)}
.tnum{min-width:30px;color:var(--c-blue);font-weight:500}
.track-title{margin-left:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.like-star{margin-left:auto;width:20px;height:20px;cursor:pointer;opacity:.97;transition:transform .2s,filter .13s,opacity .13s;pointer-events:auto!important;position:relative;z-index:10}
.like-star:hover{filter:brightness(1.13);opacity:1;transform:scale(1.15)}
.like-star:active{transform:scale(.9)}
.like-star.animating{animation:starPulse .3s}
@keyframes starPulse{0%,to{transform:scale(1)}50%{transform:scale(1.4)}}

/* Mini header / Next up */
.mini-now{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;background:#232b38;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.2);transition:none!important}
.mini-now .tnum{color:var(--c-blue);min-width:28px;font-weight:500}
.mini-now .track-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:15px}
.next-up{display:none;margin:8px 4px 0;font-size:.98em;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,.03);border-radius:8px;transition:none!important}
.next-up .label{color:var(--c-blue);opacity:.9;font-size:13px}
.next-up .title{color:var(--primary-color);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;flex:1;font-size:14px}

/* Logo bottom */
.logo-bottom{max-width:112px;width:23vw;min-width:66px;height:auto;display:block;margin:0 auto 15px!important;cursor:pointer;transition:transform .05s ease-out!important;will-change:transform;transform:translateZ(0);transform-origin:center}
.logo-bottom:hover{opacity:.9}

/* Bottom controls */
.bottom-controls-center{display:flex;flex-direction:column;align-items:center;justify-content:center;margin:32px auto 0;gap:10px;width:100%;max-width:300px;padding-bottom:env(safe-area-inset-bottom)}
#install-pwa-btn{color:var(--c-w);background:var(--secondary-color);border:0;border-radius:8px;font-size:1.07em;font-weight:900;letter-spacing:.02em;margin:8px 0;padding:12px 18px;cursor:pointer;width:100%;box-shadow:0 4px 14px rgba(0,0,0,.3);transition:background .2s,transform .1s,box-shadow .2s}
#install-pwa-btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.4);background:#3275c2}
#install-pwa-btn:active{transform:translateY(0)}
.feedback-link,.support-link,.hotkeys-btn{color:var(--secondary-color)!important;text-decoration:underline!important;font-weight:800;text-transform:uppercase;letter-spacing:.03em;cursor:pointer;transition:color .18s;font-size:1em;display:block;text-align:center;width:100%;margin:6px 0;background:0 0;border:0;padding:8px}
.feedback-link:hover,.support-link:hover,.hotkeys-btn:hover{color:var(--c-w)!important}
.offline-btn{min-width:110px;height:40px;font-size:1.05em;font-weight:900;border:0;border-radius:10px;cursor:pointer;letter-spacing:.07em;box-shadow:0 2px 8px rgba(6,0,0,.2);transition:background .2s,color .14s,transform .1s,box-shadow .2s;display:block;margin:10px auto 0}
.offline-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(6,0,0,.3)}
.offline-btn:active{transform:translateY(0)}
.offline-btn.online{background:var(--primary-color);color:var(--c-w)}
.offline-btn.offline{background:#27b34c;color:var(--c-w)}
.track .offline-indicator{margin-right:8px;font-size:18px}
.offline-indicator.pinned{color:#ffd166}
.offline-indicator.cloud{color:var(--c-blue);opacity:.8}
.offline-indicator.gray{color:#555}
#offline-btn.alert::after{content:"!";color:var(--primary-color);font-weight:900;margin-left:6px}

/* Toasts */
#toast-container{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:10000;pointer-events:none;display:flex;flex-direction:column;gap:10px;align-items:center}
.toast{background:#2a2a2a;border-radius:12px;padding:15px 20px;box-shadow:0 4px 20px rgba(0,0,0,.3);opacity:0;transform:translateY(20px);transition:.3s ease;max-width:90vw;word-wrap:break-word;pointer-events:auto}
.toast.show{opacity:1;transform:translateY(0)}
.toast-content{display:flex;align-items:center;gap:10px}
.toast-emoji{width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px}
.toast-message{flex:1;font-size:14px;line-height:1.4}
.toast-info{border-left:4px solid var(--secondary-color)}
.toast-success{border-left:4px solid #27b34c}
.toast-error{border-left:4px solid var(--primary-color)}
.toast-warning{border-left:4px solid #ff9800}
.toast-offline{border-left:4px solid #666}

/* Modals */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);z-index:9999;animation:fadeIn .3s}
.modal-bg.active{display:flex}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-feedback{background:var(--modal-bg);border-radius:14px;padding:28px 24px;min-width:240px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 8px 40px rgba(0,0,0,.6);position:relative;animation:slideUp .3s}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-feedback h2{margin:0 0 18px;color:var(--secondary-color);font-size:22px}
.bigclose{background:0 0;border:0;position:absolute;top:14px;right:14px;cursor:pointer;color:var(--c-e);border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;transition:transform .2s,background .2s}
.bigclose:hover{transform:scale(1.1);background:rgba(255,255,255,.1)}
.bigclose:active{transform:scale(.95)}
.bigclose svg{width:22px;height:22px}
.lyrics-modal .lyrics-fulltext::-webkit-scrollbar{width:8px}
.lyrics-modal .lyrics-fulltext::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:4px}
.lyrics-modal .lyrics-fulltext::-webkit-scrollbar-thumb{background:rgba(77,170,255,.3);border-radius:4px}
.modal-action-btn{background:rgba(77,170,255,.15);border:1px solid rgba(77,170,255,.3);color:var(--secondary-color);padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:900;font-size:14px;transition:.2s}
.modal-action-btn:hover{background:rgba(77,170,255,.25);transform:translateY(-1px);box-shadow:0 4px 12px rgba(77,170,255,.2)}
.modal-action-btn:active{transform:translateY(0)}

/* Offline modal helpers (no inline styles) */
.om-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.om-head__left{font-weight:900;color:var(--c-blue)}
.om-head__title{color:var(--c-blue)}
.om-head__value{color:var(--c-blue)}
.om-head__right{font-size:12px;color:var(--om-sub)}
.om-stack{display:flex;flex-direction:column;gap:12px}
.om-card{padding:12px;border:1px solid var(--om-bd);border-radius:12px}
.om-card__title{font-weight:900;color:var(--c-blue);margin-bottom:8px}
.om-row{display:flex;gap:10px;align-items:center;cursor:pointer}
.om-row--tight{margin:6px 0}
.om-check{accent-color:var(--secondary-color)}
.om-note,.om-text,.om-kv{font-size:12px;color:var(--om-sub);line-height:1.5;margin-top:6px}
.om-text{margin:0 0 20px}
.om-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.om-input,.om-select{border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text-color);outline:0}
.om-input{padding:10px 8px}
.om-select{padding:10px 12px}
.om-field{display:flex;gap:8px;align-items:center}
.om-field__lbl{opacity:.85}
.om-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:16px}
.om-actions--left{justify-content:flex-start;margin-top:8px}
.om-albums{margin-top:10px;max-height:140px;overflow:auto;border:1px solid var(--om-bd);border-radius:10px;padding:8px}
.om-btn-primary{background:var(--secondary-color)!important;color:var(--c-w)!important}
.om-btn-danger{background:var(--primary-color)!important;color:var(--c-w)!important}
.om-btn-success{background:#27b34c!important;color:var(--c-w)!important}

/* Sleep overlay */
.sleep-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:10000;animation:fadeIn .5s}
.sleep-overlay.active{display:flex}
.sleep-content{text-align:center;padding:40px;max-width:400px}
.sleep-icon{font-size:64px;margin-bottom:20px;opacity:.5}
.sleep-title{font-size:24px;margin-bottom:10px;color:var(--text-color)}
.sleep-message{color:rgba(255,255,255,.6);margin-bottom:30px}
.sleep-buttons{display:flex;gap:10px;justify-content:center}
.sleep-btn{padding:12px 24px;border-radius:8px;border:0;cursor:pointer;font-weight:900;transition:opacity .2s}
.sleep-btn-primary{background:var(--primary-color);color:var(--c-w)}
.sleep-btn-secondary{background:rgba(255,255,255,.1);color:var(--text-color)}
.sleep-btn:hover{opacity:.8}

/* Hotkeys modal */
.hotkeys-modal{max-width:600px;max-height:80vh;overflow-y:auto}
.hotkeys-section{margin-bottom:24px}
.hotkeys-section h3{color:var(--c-blue);font-size:16px;margin-bottom:12px}
.hotkey-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;margin-bottom:6px;background:rgba(255,255,255,.05);border-radius:6px}
.hotkey-combo{font-family:"SF Mono",Monaco,"Courier New",monospace;background:rgba(77,170,255,.15);padding:4px 10px;border-radius:4px;color:var(--secondary-color);font-weight:900;font-size:13px}
.hotkey-desc{color:#cfe3ff;font-size:14px;margin-left:16px;flex:1;text-align:right}

/* iOS install prompt */
.ios-install-prompt{position:fixed;bottom:0;left:0;right:0;background:#1a1a1a;border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;transform:translateY(100%);transition:transform .3s ease;z-index:10000;box-shadow:0 -4px 20px rgba(0,0,0,.3)}
.ios-install-prompt.show{transform:translateY(0)}
.ios-prompt-content{max-width:400px;margin:0 auto;text-align:center}
.ios-prompt-icon{width:60px;height:60px;margin:0 auto 15px;display:block}
.ios-prompt-close{position:absolute;top:10px;right:10px;background:0 0;border:0;color:#666;font-size:28px;cursor:pointer;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
.ios-prompt-button{background:var(--primary-color);color:var(--c-w);border:0;padding:12px 30px;border-radius:25px;font-weight:900;margin-top:20px;cursor:pointer;transition:opacity .2s}
.ios-prompt-button:hover{opacity:.9}

/* Jump-to-playing */
.jump-to-playing{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);width:44px;height:44px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.45);color:var(--c-w);display:none;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.jump-to-playing:active{transform:translateX(-50%) scale(.98)}
.jump-to-playing button{all:unset;width:100%;height:100%;cursor:pointer;display:grid;place-items:center;line-height:1;user-select:none}

/* Platform */
body.ios .volume-control-wrapper,body.ios #mute-btn{display:none!important}

/* Responsive */
@media (max-width:600px){
  .hotkeys-btn{display:none!important}
  .player-controls-row{gap:8px}
  .player-control-btn,.sleep-timer-btn{width:40px;height:40px;padding:8px}
  .player-control-btn.main{width:48px;height:48px}
  .player-control-btn svg{width:18px;height:18px}
  .player-control-btn.main svg{width:22px;height:22px}
  .time-in-controls{font-size:12px;min-width:38px}
  .player-extra-buttons-row{flex-wrap:wrap;gap:6px}
  .lyrics-toggle-btn,.animation-btn,.pulse-btn,.karaoke-btn,.player-download-btn{width:calc(33.333% - 4px);min-width:unset;max-width:unset}
  .lyrics-window-line{font-size:14px;padding:7px 12px}
  .lyrics-window-line.active{font-size:16px}
}
@media (max-width:380px){
  .promo-cover{width:200px;height:200px}
  .album-icon{width:54px;height:54px}
  .album-icon.active{width:60px;height:60px}
}
@media (display-mode:standalone){.bottom-controls-center{padding-bottom:calc(env(safe-area-inset-bottom) + 10px)}}
@media (prefers-color-scheme:dark){body{background:#0d0d0d}}

/* Accessibility */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}
button:focus-visible,a:focus-visible,input:focus-visible{outline:2px solid var(--secondary-color);outline-offset:2px}

/* Optional utility */
@keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:fadeInUp .4s ease-out}

