–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.
- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).
- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  ```ts
  export function x() {}
  ```
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.
- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.
- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.
- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].
- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. 
- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.
- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤—ã–∑–≤–∞—Ç—å STOP —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–Ω—è—Ç –≤ favorites view, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞ –∏ –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ä–æ–≥–æ —Å–ª–µ–¥–∞, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–µ–º —á—Ç–æ-—Ç–æ –≤ –∫–æ–¥–µ
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏–ª–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –∫–æ–¥–µ, –Ω–æ –ø—Ä–∏—ç—Ç–æ–º –ø–æ–ª–Ω–æ—Å—Ç—å–± –±—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ –ª–æ–≥–∏–∫—É, –ª–æ–≥–∏—Å—Ç–∏–∫—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–µ–º–∏—Ç—å—Å—è –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —É–ø—Ä–æ—â–µ–Ω–∏—é –∫–æ–¥–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: vi3na1bita-music
–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: https://github.com/apel-s-in/vi3na1bita-music
# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.
## –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞
–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ –≤ –ò–ó–ë–†–ê–ù–ù–û–ï:
–õ–∞–π–∫/–∞–Ω–ª–∞–π–∫ (‚≠ê) = –∏–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞.
–°–æ—Å—Ç–æ—è–Ω–∏–µ ‚≠ê —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö (—Ä–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º, ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª, –¥—Ä—É–≥–∏–µ —Å–ø–∏—Å–∫–∏).

–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–∑ –æ–∫–Ω–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª
–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äì —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.

–ü–æ–¥—Ä–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã):
- –ü–æ—Å—Ç–∞–≤–∏–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π.
- –°–Ω—è–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª (–¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º, ¬´–±–µ–∑ —Å–ª–µ–¥–∞¬ª).

‚≠ê –≤ –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:
- –°–Ω—è–ª–∏ ‚≠ê —Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–µ—Ä–æ–π (inactive), ‚≠ê —Å–Ω–∏–º–∞–µ—Ç—Å—è –∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª, –∏ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.
- –°–Ω—è—Ç–∏–µ ‚≠ê –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ, –∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –µ—ë –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (‚Äú–±—É—Ñ–µ—Ä‚Äù).

–ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π (—Å–µ—Ä–æ–π) —Å—Ç—Ä–æ–∫–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª:
- –ö–ª–∏–∫ –ø–æ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–µ –ø–æ –∑–≤–µ–∑–¥–µ) ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:
  - –í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, ‚≠ê —Å—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–µ–∑–¥–µ.
  - –£–¥–∞–ª–∏—Ç—å ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê –ø—Ä–∏ —ç—Ç–æ–º —Å–Ω—è—Ç–∞.
- –ö–ª–∏–∫ –ø–æ ‚≠ê –Ω–∞ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –º–æ–¥–∞–ª–∫–∏, —Å—Ç—Ä–æ–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å ‚≠ê.
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É (–∏–ª–∏ ‚Äú–±–µ–∑ —Å–ª–µ–¥–∞‚Äù —á–µ—Ä–µ–∑ –∞–Ω–ª–∞–π–∫ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ).

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
- –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚≠ê –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ –≤—Å–µ—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è—Ö –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫.
- –í –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª: —Å–Ω—è—Ç–∏–µ ‚≠ê –Ω–∞ –ª—é–±–æ–π —Å—Ç—Ä–æ–∫–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.
- –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É.

–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:
- –õ—é–±—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç—Ä–µ–∫–∞ –≤ inactive, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞.
- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–µ—Å–Ω–∏ –ù–ï –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç ‚Äú–≤ —Ñ–æ–Ω–µ‚Äù.

–û—Å–æ–±–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞:
- –ï—Å–ª–∏ —Ç—Ä–µ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è inactive –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫.
- –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî –ø–ª–µ–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º —Å—Ç–æ–ø, –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

–†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º –≤—Å–µ–≥–¥–∞ —Ä–µ—à–∞–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ:
- –ï—Å–ª–∏ —Å–Ω—è—Ç—å ‚≠ê —Å —Ç—Ä–µ–∫–∞ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚Äî –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–ª—Å—è —Ç–∞–º –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è (—Å–µ—Ä–∞—è) —Å—Ç—Ä–æ–∫–∞.

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ:
- –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ ‚≠ê –Ω–∞ —Ç—Ä–µ–∫–µ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π.

–ò—Ç–æ–≥–∏
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî —à–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–æ–π.
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚≠ê –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö.
- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π: –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–¥–Ω–æ–º—É –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.
- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.
- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.
 =========================================================================== 
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F (–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)
–ö–Ω–æ–ø–∫–∞ F –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º Favorites Only –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞).
–û–Ω–∞ –Ω–µ —Å—Ç–∞–≤–∏—Ç/–Ω–µ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê —É —Ç—Ä–µ–∫–æ–≤, –∞ —Ç–æ–ª—å–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç, –ø–æ –∫–∞–∫–∏–º —Ç—Ä–µ–∫–∞–º –º–æ–∂–Ω–æ —Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Next / Prev / –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏ –∫–∞–∫–∏–µ —Ç—Ä–µ–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ Shuffle.
–ï–¥–∏–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø (–ø–æ–ª–Ω—ã–π –ø–ª–µ–µ—Ä –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä)
–ü–æ–ª–Ω—ã–π –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ playing-–ø–ª–µ–π–ª–∏—Å—Ç–æ–º.
–ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö: –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ playing, –∞ –Ω–µ –∫ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å–ø–∏—Å–∫—É.
–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–¥–æ—Å—Ç—É–ø–Ω—ã–º —Ç—Ä–µ–∫–æ–º‚Äù
–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ ‚Äî —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤:
Next / Prev
–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —Ç—Ä–µ–∫–∞
Shuffle-–ø–æ—Ä—è–¥–∫–µ (–µ—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω)
–ü—Ä–∞–≤–∏–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:
F = OFF: –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±—ã—á–Ω—ã–π –Ω–∞–±–æ—Ä playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞, –Ω–æ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å–º. ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –Ω–∏–∂–µ).
F = ON: –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (‚≠ê) —Ç—Ä–µ–∫–∏ playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞.
–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –æ–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º
–ò–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ ‚≠ê –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ (–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ª–∞–π–∫–æ–≤).
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –≤ –∞–ª—å–±–æ–º–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ ‚≠ê —Ç—Ä–µ–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä —Å—É–∂–∞–µ—Ç—Å—è –¥–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è OFF, –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞–ª—å–±–æ–º–∞, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ ‚≠ê –Ω–µ—Ç: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = ‚≠ê, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ —ç—Ç–æ–º—É shuffle-–ø–æ—Ä—è–¥–∫—É.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = –≤—Å–µ —Ç—Ä–µ–∫–∏, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–∞–±–æ—Ä—É, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –ò–ó–ë–†–ê–ù–ù–û–ï (–ø–ª–µ–π–ª–∏—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ)
–í ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã active –∏ inactive:
active: —Ç—Ä–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º (‚≠ê –µ—Å—Ç—å) ‚Äî —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
inactive: ‚≠ê —Å–Ω—è—Ç–∞, —Å—Ç—Ä–æ–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
–ë–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–≤–∞–∂–Ω–æ): inactive –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –≤ Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∏ shuffle-–ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø—Ä–∏ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ F.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –Ω–µ—Ç active (–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –Ω–µ—á–µ–≥–æ –∏–≥—Ä–∞—Ç—å): –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = active (–ø–æ —Ñ–∞–∫—Ç—É –æ–Ω –∏ —Ç–∞–∫ —Ç–∞–∫–æ–π), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ active.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è = active (inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ active.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –Ω–µ—Ç active: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active (–ø–æ—Ç–æ–º—É —á—Ç–æ inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
–ù–∞–∂–∞—Ç–∏–µ F –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–∞–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (‚≠ê –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –∏ –Ω–µ —Å–Ω–∏–º–∞–µ—Ç—Å—è).
–ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ (–Ω–µ—Ç ‚≠ê –≤ –∞–ª—å–±–æ–º–µ / –Ω–µ—Ç active –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ): –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∏ F –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è (–æ—Å—Ç–∞—ë—Ç—Å—è OFF).
inactive –≤ –ò–ó–ë–†–ê–ù–ù–û–ú ‚Äî —ç—Ç–æ UI-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è, –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∏ –≤ –∫–∞–∫–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –Ω–∏ –≤ Next/Prev, –Ω–∏ –≤ Shuffle.

–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).

–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:
vi3na1bita-music/
‚îú‚îÄ‚îÄ .git/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ applypatch-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fsmonitor-watchman.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-update.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-applypatch.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-merge-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-push.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-rebase.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-receive.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prepare-commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ push-to-checkout.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sendemail-validate.sample
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update.sample
‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exclude
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ qwen-code-c0a6e5d8-7ce2-4015-b9e8-16c1eb5626f1
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ qwen-code-c670b9c3-90a8-4bf4-a12a-b54705b66530
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HEAD
‚îÇ   ‚îú‚îÄ‚îÄ objects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pack/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-e41464e8014712f0aa90a9038a35f9c546d82a2d.idx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-e41464e8014712f0aa90a9038a35f9c546d82a2d.pack
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ pack-e41464e8014712f0aa90a9038a35f9c546d82a2d.rev
‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ qwen-code-c0a6e5d8-7ce2-4015-b9e8-16c1eb5626f1
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ qwen-code-c670b9c3-90a8-4bf4-a12a-b54705b66530
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tags/
‚îÇ   ‚îú‚îÄ‚îÄ config
‚îÇ   ‚îú‚îÄ‚îÄ config.worktree
‚îÇ   ‚îú‚îÄ‚îÄ description
‚îÇ   ‚îú‚îÄ‚îÄ FETCH_HEAD
‚îÇ   ‚îú‚îÄ‚îÄ HEAD
‚îÇ   ‚îî‚îÄ‚îÄ index
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ e2e.yml
‚îÇ       ‚îú‚îÄ‚îÄ generate-context.yml
‚îÇ       ‚îî‚îÄ‚îÄ validate.yml
‚îú‚îÄ‚îÄ .meta/
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ albums/
‚îÇ   ‚îú‚îÄ‚îÄ gallery/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ news/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ thumbs/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ news-cover-02-thumb.jpg
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ news-cover-02-thumb.webp
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-01-baner.html
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.avif
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.png
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ news-cover-02.webp
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ icons/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ apple-touch-icon.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-16.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-32.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-192.png
‚îÇ   ‚îî‚îÄ‚îÄ icon-512.png
‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îú‚îÄ‚îÄ desktop/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@2x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@3x.png
‚îÇ   ‚îú‚îÄ‚îÄ icon_album/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.png
‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@2x.jpg
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ bg.png
‚îÇ   ‚îú‚îÄ‚îÄ logo.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-01.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-02.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-03.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-04.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-21.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-22.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-23.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-24.png
‚îÇ   ‚îú‚îÄ‚îÄ star.png
‚îÇ   ‚îî‚îÄ‚îÄ star2.png
‚îú‚îÄ‚îÄ news/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ news.json
‚îú‚îÄ‚îÄ performance/
‚îÇ   ‚îî‚îÄ‚îÄ rum.js
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player-ui/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lyrics.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app-utils.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ albums.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ navigation.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-ui-bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-cache-bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-policy.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player-ui.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promocode.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track-registry.js
‚îÇ   ‚îú‚îÄ‚îÄ ci/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lint-sw.mjs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate-content.mjs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validate-manifest.mjs
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.spec.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player.spec.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ offline/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache-db.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ net-policy.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-manager.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-cache.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track-resolver.js
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache-progress-overlay.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cloud-menu.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-view.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lyrics-modal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modal-templates.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modals.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ news-inline.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notify.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-indicators.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-modal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sleep.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sysinfo.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui-utils.js
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sw-manager.js
‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ player-core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ media-session.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stats-tracker.js
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ PlayerCore.js
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îî‚îÄ‚îÄ main.css
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ albums.json
‚îú‚îÄ‚îÄ custom.json
‚îú‚îÄ‚îÄ generate-context.js
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ news.html
‚îî‚îÄ‚îÄ service-worker.js


–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: 2026-01-22 15:22:15 UTC
//=================================================
// FILE: /.github/workflows/e2e.yml
name: E2E smoke

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npx -y playwright@1.48.2 install --with-deps

      - name: Start static server
        run: |
          npx -y http-server -p 4173 -c-1 . &
          echo $! > server.pid
          sleep 2

      - name: Run smoke tests
        env:
          BASE_URL: http://127.0.0.1:4173
        run: npx -y @playwright/test@1.48.2 scripts/e2e

      - name: Stop server
        if: always()
        run: kill $(cat server.pid) || true

//=================================================
// FILE: /.github/workflows/generate-context.yml
name: Generate .meta context

on:
  push:
    branches: [ main, master ]
    # –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤–æ—Ä–∫—Ñ–ª–æ—É –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤, –º–µ–Ω—è—é—â–∏—Ö —Ç–æ–ª—å–∫–æ .meta
    paths-ignore:
      - '.meta/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate .meta
        run: |
          node generate-context.js --mode=both --max-lines=20000
          ls -la .meta || true

      - name: Commit .meta
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: generate .meta context"
          branch: ${{ github.ref_name }}
          file_pattern: ".meta/**"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

//=================================================
// FILE: /.github/workflows/validate.yml
name: Validate manifest and SW

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run manifest validator
        run: node scripts/ci/validate-manifest.mjs

      - name: Run SW linter
        run: node scripts/ci/lint-sw.mjs

      - name: Validate albums and galleries
        run: node scripts/ci/validate-content.mjs

  remote-validate:
    name: Remote content validate (informational)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Remote validate (warnings only)
        run: node scripts/ci/validate-content.mjs

//=================================================
// FILE: /albums.json
{
  "albums": [
    {
      "key": "mezhdu-zlom-i-dobrom",
      "title": "–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "base": "https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/"
    },
    {
      "key": "golos-dushi",
      "title": "–ì–æ–ª–æ—Å –î—É—à–∏",
      "base": "https://apel-s-in.github.io/vi3na1bita-golos-dushi/"
    },
    {
      "key": "odnazhdy-v-skazke",
      "title": "–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ",
      "base": "https://apel-s-in.github.io/vi3na1bita-odnazhdy-v-skazke/"
    },
    {
      "key": "krevetochka",
      "title": "–ö–†–ï–í–ï„ÉÑTOCHKA",
      "base": "https://apel-s-in.github.io/krevetochka/"
    }
  ]
}

//=================================================
// FILE: /albums/gallery/00/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-01.webp",
        "full": "albums/gallery/00/00-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-02.webp",
        "full": "albums/gallery/00/00-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/01/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-01.webp",
        "full": "albums/gallery/01/01-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-02.webp",
        "full": "albums/gallery/01/01-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-03.webp",
        "full": "albums/gallery/01/01-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-04.webp",
        "full": "albums/gallery/01/01-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/02/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-01.webp",
        "full": "albums/gallery/02/02-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-02.webp",
        "full": "albums/gallery/02/02-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-03.webp",
        "full": "albums/gallery/02/02-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-04.webp",
        "full": "albums/gallery/02/02-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/03/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-01.webp",
        "full": "albums/gallery/03/03-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-02.webp",
        "full": "albums/gallery/03/03-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-03.webp",
        "full": "albums/gallery/03/03-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-04.webp",
        "full": "albums/gallery/03/03-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/news/index.json
{
  "items": [
    { "type": "html", "src": "albums/gallery/news/news-01-baner.html" },
    {
      "formats": {
        "webp": "albums/gallery/news/news-cover-02.webp",
        "full": "albums/gallery/news/news-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /custom.json
{
  "rumEndpoint": "",
  "sw": {
    "mediaMaxCacheMB": 150,
    "nonRangeMaxStoreMB": 25,
    "nonRangeMaxStoreMBSlow": 10,
    "allowUnknownSize": false,
    "revalidateDays": 7
  },
  "items": [
    {
      "type": "ym",
      "title": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
      "subtitle": "–Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∞",
      "url": "https://music.yandex.ru/artist/24739002?utm_source=web&utm_medium=copy_link",
      "cover": ""
    },
    {
      "type": "tgPost",
      "title": "–°–≤–µ–∂–∏–π –ø–æ—Å—Ç –≤ Telegram",
      "url": "https://t.me/vitrina_razbita/28",
      "height": 480
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 3,
      "hash": "b8300406c5f33725de",
      "containerId": "vk_playlist_165137_3"
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 2,
      "hash": "d70fba309dc0bea296",
      "containerId": "vk_playlist_165137_2"
    }
  ]
}

//=================================================
// FILE: /index.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">

  <link rel="preload" href="img/logo.png" as="image">
  <link rel="stylesheet" href="styles/main.css">

  <!-- Howler first -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>

  <!-- Core -->
  <script src="./scripts/core/utils.js"></script>
  <script src="./scripts/core/bootstrap.js"></script>
  <script src="./scripts/core/config.js" type="module"></script>
  <script src="./scripts/utils/sw-manager.js" defer></script>

  <!-- Player Core -->
  <script src="./src/PlayerCore.js" type="module"></script>

  <!-- UI Modules -->
  <script src="./scripts/ui/notify.js" defer></script>
  <script src="./scripts/ui/modals.js" defer></script>
  <script src="./scripts/ui/favorites.js" defer></script>
  <script src="./scripts/ui/sleep.js" defer></script>
  <script src="./scripts/ui/lyrics-modal.js" defer></script>
  <script src="./scripts/ui/modal-templates.js" type="module"></script>
  <script src="./scripts/ui/sysinfo.js" defer></script>

  <!-- App Modules -->
  <script src="./scripts/app/promocode.js" defer></script>
  <script src="./scripts/app/playback-policy.js" defer></script>
  <script src="./scripts/app/player-ui/lyrics.js" defer></script>
  <script src="./scripts/app/player-ui.js" defer></script>
  <script src="./scripts/app/gallery.js" type="module"></script>
  <script src="./scripts/app/albums.js" type="module"></script>
  <script src="./scripts/app/navigation.js" type="module"></script>

  <script src="./scripts/app.js" type="module"></script>

  <script src="./performance/rum.js" defer></script>
</head>
<body>
  <!-- Promocode Screen -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons" aria-label="–ê–ª—å–±–æ–º—ã"></div>

      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left"
                title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff"
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div id="cover-slot" aria-label="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞"></div>

        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right"
                title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff"
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <div id="now-playing" style="width:100%; max-width:395px; margin:8px auto 0 auto;"></div>
    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>

      <button id="install-pwa-btn" style="display: none;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï</button>
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;">–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</button>
      <button id="sysinfo-btn" style="display:none;">–û –°–ò–°–¢–ï–ú–ï</button>

      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>

      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>

      <button class="offline-btn" id="offline-btn">OFFLINE</button>
    </div>
  </div>

  <div id="modals-container"></div>

  <template id="mini-header-template">
    <div class="mini-now" id="mini-now">
      <span class="tnum" id="mini-now-num">--.</span>
      <span class="track-title" id="mini-now-title">‚Äî</span>
      <img src="img/star2.png" class="like-star" id="mini-now-star" alt="–∑–≤–µ–∑–¥–∞">
    </div>
  </template>

  <template id="next-up-template">
    <div class="next-up" id="next-up">
      <span class="label">–î–∞–ª–µ–µ:</span>
      <span class="title" title="">‚Äî</span>
    </div>
  </template>

  <template id="player-template">
    <!-- (—Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
    <div class="lyrics-player-block" id="lyricsplayerblock">
      <div id="lyrics-window" class="lyrics-normal">
        <div class="lyrics-animated-bg"></div>
        <div class="lyrics-scroll" id="lyrics">
          <div class="lyrics-placeholder lyrics-spinner"></div>
        </div>
      </div>

      <div class="player-progress-wrapper">
        <div class="player-progress-bar" id="player-progress-bar">
          <div class="player-progress-fill" id="player-progress-fill">
            <div class="player-progress-handle"></div>
          </div>
        </div>
      </div>

      <div class="player-controls">
        <div class="player-controls-row">
          <span class="time-in-controls" id="time-elapsed">00:00</span>

          <button class="player-control-btn" id="prev-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫ (P)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M11 5L4 12l7 7V5zm9 0v14l-7-7 7-7z"/>
            </svg>
          </button>

          <button class="player-control-btn main" id="play-pause-btn" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞ (K)">
            <svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>

          <button class="player-control-btn" id="stop-btn" title="–°—Ç–æ–ø (X)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12"/>
            </svg>
          </button>

          <button class="player-control-btn" id="next-btn" title="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ (N)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M13 5l7 7-7 7V5zM4 5v14l7-7-7-7z"/>
            </svg>
          </button>

          <span class="time-in-controls" id="time-remaining">--:--</span>
        </div>

        <div class="player-controls-row">
          <button class="player-control-btn" id="pq-btn" title="–ö–∞—á–µ—Å—Ç–≤–æ (Hi/Lo)">
            <span class="pq-btn-label" id="pq-btn-label">Hi</span>
          </button>

          <button class="player-control-btn" id="mute-btn" title="–ë–µ–∑ –∑–≤—É–∫–∞ (M)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
            </svg>
          </button>

          <button class="player-control-btn" id="shuffle-btn" title="–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (U)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 17h2.735a4 4 0 003.43-1.942l3.67-6.116A4 4 0 0116.265 7H21m0 0l-3-3m3 3l-3 3"/>
              <path d="M3 7h2.735a4 4 0 013.43 1.942l3.67 6.116A4 4 0 0016.265 17H21m0 0l-3 3m3-3l-3-3"/>
            </svg>
          </button>

          <button class="player-control-btn" id="repeat-btn" title="–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ (R)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 2l4 4-4 4"/>
              <path d="M3 11V9a4 4 0 014-4h14"/>
              <path d="M7 22l-4-4 4-4"/>
              <path d="M21 13v2a4 4 0 01-4 4H3"/>
              <circle cx="12" cy="12" r="1" fill="currentColor"/>
            </svg>
          </button>

          <button class="sleep-timer-btn" id="sleep-timer-btn" title="–¢–∞–π–º–µ—Ä —Å–Ω–∞ (T)">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"></circle>
              <path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none;">0</span>
          </button>

          <button class="player-control-btn" id="favorites-btn" title="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (F)">
            <img src="img/star2.png" alt="‚òÖ" id="favorites-btn-icon"/>
          </button>
        </div>
      </div>

      <div class="volume-control-wrapper">
        <div class="volume-track" id="volume-track">
          <div class="volume-fill" id="volume-fill"></div>
          <div class="volume-handle" id="volume-handle"></div>
        </div>
        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100" aria-label="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
      </div>

      <div class="player-buttons-wrapper">
        <div class="player-extra-buttons-row">
          <button class="lyrics-toggle-btn lyrics-normal" id="lyrics-toggle-btn" title="–†–µ–∂–∏–º –ª–∏—Ä–∏–∫–∏ (Y)">
            <span class="lyrics-toggle-btn-visual">–¢</span>
          </button>

          <button class="animation-btn" id="animation-btn" title="–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ (A)">A</button>

          <button class="karaoke-btn" id="lyrics-text-btn" title="–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏">üìù</button>

          <button class="stats-btn" id="stats-btn" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" style="background:none; border:none; cursor:pointer; font-size:18px; opacity:0.8; padding:0 8px;">üìä</button>

          <button class="pulse-btn" id="pulse-btn" title="–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞">
            <span id="pulse-heart">ü§ç</span>
          </button>

          <a class="player-download-btn" href="#" id="track-download-btn" download title="–°–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫">üíæ</a>
        </div>
      </div>
    </div>
  </template>

  <script>
    const VERSION = String(window.APP_CONFIG?.APP_VERSION || '8.0.4');
    const BUILD_DATE = String(window.APP_CONFIG?.BUILD_DATE || '2025-12-07');

    window.autoNextDisabled = false;
    window.sleepTimerTarget = null;
    window.sleepTimerInterval = null;

    window.VERSION = VERSION;
    window.BUILD_DATE = BUILD_DATE;

    console.log(`üéµ –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ v${VERSION} (${BUILD_DATE})`);
  </script>
</body>
</html>

//=================================================
// FILE: /manifest.json
{
  "name": "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "short_name": "Vi3na1bita",
  "description": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#181818",
  "theme_color": "#181818",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "categories": ["music", "entertainment"],
  "screenshots": []
}

//=================================================
// FILE: /news.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0e15;
      --panel: #131a26;
      --text: #eaf2ff;
      --muted: #9db7dd;
      --accent: #4daaff;
      --danger: #E80100;
      --border: #23324a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 14px;
      background: var(--bg); color: var(--text);
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
    }
    .container { max-width: 760px; margin: 0 auto; }
    h1 { margin: 6px 0 16px; font-size: 22px; }
    .news-list { display: grid; gap: 14px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .date { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .media { margin: 10px 0; }
    .media iframe, .media img, .media video {
      width: 100%; border: 0; border-radius: 8px; min-height: 220px; background: #0b0e15;
    }
    .card p { margin: 8px 0; line-height: 1.45; }
    .tags { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 12px; color: var(--accent); background: rgba(77,170,255,.12); border: 1px solid rgba(77,170,255,.25); padding: 4px 8px; border-radius: 999px; }
    .error { color: var(--danger); background: rgba(232,1,0,.1); border: 1px solid rgba(232,1,0,.2); padding: 10px; border-radius: 8px; }
    .loading { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ù–æ–≤–æ—Å—Ç–∏</h1>
    <div id="status" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="news" class="news-list"></div>
  </div>

  <script>
    async function loadNews() {
      const status = document.getElementById('status');
      const listEl = document.getElementById('news');
      try {
        const r = await fetch('./news/news.json', { cache: 'no-cache' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const items = Array.isArray(j.items) ? j.items : [];
        status.style.display = 'none';
        if (!items.length) {
          status.style.display = '';
          status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
          return;
        }
        listEl.innerHTML = items.map(renderCard).join('');
      } catch (e) {
        status.className = 'error';
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
      }
    }
    function esc(s) {
      // –µ–¥–∏–Ω—ã–π esc –±–µ–∑ –¥—É–±–ª–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ (–∑–¥–µ—Å—å standalone, –ø–æ—ç—Ç–æ–º—É –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω–æ)
      return String(s || '').replace(/[<>&'"]/g, (m) => ({
        '<': '&lt;', '>': '&gt;', '&': '&amp;', "'": '&#39;', '"': '&quot;'
      })[m]);
    }
    function renderCard(it) {
      const title = esc(it.title || '–ù–æ–≤–æ—Å—Ç—å');
      const date = esc(it.date || '');
      const text = esc(it.text || '');
      const tags = Array.isArray(it.tags) ? it.tags : [];
      let media = '';
      if (it.embedUrl) {
        media = `<div class="media"><iframe loading="lazy" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`;
      } else if (it.image) {
        media = `<div class="media"><img loading="lazy" src="${esc(it.image)}" alt=""></div>`;
      } else if (it.video) {
        media = `<div class="media"><video controls preload="metadata" src="${esc(it.video)}"></video></div>`;
      }
      return `<article class="card">
        <h2>${title}</h2>
        ${date ? `<div class="date">${date}</div>` : ''}
        ${media}
        ${text ? `<p>${text}</p>` : ''}
        ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join('')}</div>` : ''}
      </article>`;
    }
    loadNews();
  </script>
</body>
</html>

//=================================================
// FILE: /service-worker.js
// service-worker.js
// –ï–¥–∏–Ω—ã–π Service Worker –¥–ª—è PWA "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"

const SW_VERSION = '8.1.0';

// –û—Å–Ω–æ–≤–Ω—ã–µ –∫—ç—à–∏ (–æ–∂–∏–¥–∞—é—Ç—Å—è lint-sw.mjs)
const CORE_CACHE = `vitrina-core-v${SW_VERSION}`;
const RUNTIME_CACHE = `vitrina-runtime-v${SW_VERSION}`;
const MEDIA_CACHE = `vitrina-media-v${SW_VERSION}`;
const OFFLINE_CACHE = `vitrina-offline-v${SW_VERSION}`;
const META_CACHE = `vitrina-meta-v${SW_VERSION}`;

// –ö–æ–Ω—Ñ–∏–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ–∂–∏–¥–∞–µ—Ç—Å—è lint-sw.mjs)
const DEFAULT_SW_CONFIG = {
  mediaMaxCacheMB: 150,
  nonRangeMaxStoreMB: 25,
  nonRangeMaxStoreMBSlow: 10,
  allowUnknownSize: false,
  revalidateDays: 7
};

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ ¬´—è–¥—Ä–∞¬ª
const STATIC_ASSETS = [
  './',
  './index.html',
  './news.html',
  './manifest.json',
  './styles/main.css',
  './img/logo.png',
  './img/star.png',
  './img/star2.png',
  './icons/favicon-32.png',
  './icons/favicon-16.png',
  './icons/apple-touch-icon.png',

  // –°–∫—Ä–∏–ø—Ç—ã —è–¥—Ä–∞ –∏ UI
  './scripts/core/bootstrap.js',
  './scripts/core/config.js',
  './scripts/app/gallery.js',
  './scripts/ui/notify.js',
  './scripts/ui/favorites.js',
  // './scripts/ui/favorites-view.js', // —É–¥–∞–ª–µ–Ω–æ: –º–æ–¥—É–ª—å –ª–∏—à–Ω–∏–π
  './scripts/ui/sleep.js',
  './scripts/ui/lyrics-modal.js',
  './scripts/ui/sysinfo.js',
  './scripts/app/background-audio.js',
  // './scripts/app/background-events.js', // –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: —É–¥–∞–ª–µ–Ω–æ –∏–∑ precache
  './scripts/app/player-ui.js',
  './scripts/app/albums.js',
  './scripts/app/navigation.js',
  './scripts/app.js',
  './src/PlayerCore.js',

  // Howler.js (CDN)
  // –í–ê–ñ–ù–û: –Ω–µ precache –Ω–∞ install, —á—Ç–æ–±—ã –Ω–µ —Ä–æ–Ω—è—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É SW –∏–∑-–∑–∞ opaque/CORS/CDN-–æ—à–∏–±–æ–∫.
  // CDN –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ —Å–µ—Ç–∏; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–∫—ç—à–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ runtime-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é.
];

// ‚úÖ –¢–æ—á–Ω—ã–π static-match: –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç–∏ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ URL –≤–Ω—É—Ç—Ä–∏ scope –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ç—Ä–æ–≥–æ.
// –≠—Ç–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –ª–æ–∂–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏–∑-–∑–∞ endsWith –∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –ø—Ä–∏ querystring/hash.
const normalizeUrlForMatch = (href) => {
  try {
    const u = new URL(href);
    u.hash = '';
    u.search = '';
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º "/" –∫–∞–∫ "/index.html" –¥–ª—è cache-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    if (u.pathname.endsWith('/')) u.pathname += 'index.html';
    return u.href;
  } catch {
    return String(href || '');
  }
};

const STATIC_URLS = (() => {
  const scope = (self.registration && self.registration.scope) ? self.registration.scope : self.location.origin + '/';
  const set = new Set();

  for (const asset of STATIC_ASSETS) {
    // –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ (http(s) –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –Ω–æ —É —Ç–µ–±—è –∏—Ö –Ω–µ—Ç)
    try {
      const abs = new URL(asset, scope).href;
      set.add(normalizeUrlForMatch(abs));
    } catch {}
  }

  return set;
})();

// ========== INSTALL ==========
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CORE_CACHE)
      .then((cache) => cache.addAll(STATIC_ASSETS))
      .then(() => self.skipWaiting())
  );
});

// ========== ACTIVATE ==========
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((names) =>
      Promise.all(
        names.map((name) => {
          if (
            name !== CORE_CACHE &&
            name !== RUNTIME_CACHE &&
            name !== MEDIA_CACHE &&
            name !== OFFLINE_CACHE &&
            name !== META_CACHE
          ) {
            return caches.delete(name);
          }
          return undefined;
        })
      )
    ).then(() => self.clients.claim())
  );
});

// ========== FETCH ==========
self.addEventListener('fetch', (event) => {
  const { request } = event;

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ-GET –∑–∞–ø—Ä–æ—Å—ã
  if (request.method !== 'GET') {
    return;
  }

  const url = new URL(request.url);

  // –ê—É–¥–∏–æ-—Ñ–∞–π–ª—ã ‚Äî –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∫—ç—à–∞, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥)
  if (/\.(mp3|ogg|m4a|flac)$/i.test(url.pathname)) {
    event.respondWith(fetch(request));
    return;
  }

  // –°—Ç–∞—Ç–∏–∫–∞: cache-first –∏–∑ CORE/RUNTIME (—Ç–æ—á–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
  const isStatic = STATIC_URLS.has(normalizeUrlForMatch(url.href));

  if (isStatic) {
    event.respondWith(
      caches.match(request).then((cached) => {
        if (cached) return cached;
        return fetch(request).then((resp) => {
          return caches.open(RUNTIME_CACHE).then((cache) => {
            cache.put(request, resp.clone());
            return resp;
          });
        });
      })
    );
    return;
  }

  // –û—Å—Ç–∞–ª—å–Ω–æ–µ: network-first —Å fallback –≤ RUNTIME_CACHE
  event.respondWith(
    fetch(request)
      .then((resp) => {
        const copy = resp.clone();
        caches.open(RUNTIME_CACHE).then((cache) => cache.put(request, copy));
        return resp;
      })
      .catch(() => caches.match(request))
  );
});

// ========== MESSAGE API (–¥–ª—è sysinfo.js –∏ ServiceWorkerManager) ==========
self.addEventListener('message', (event) => {
  const { data, ports } = event;
  if (!data || typeof data !== 'object') return;

  const type = data.type;

  // –û—Ç–≤–µ—Ç –≤–µ—Ä—Å–∏–∏ SW –¥–ª—è sysinfo.js
  if (type === 'GET_SW_VERSION') {
    const port = ports && ports[0];
    if (port) {
      port.postMessage({ version: SW_VERSION });
    }
    return;
  }

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
  if (type === 'SKIP_WAITING') {
    self.skipWaiting();
    return;
  }

  // –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ API ServiceWorkerManager ‚Äî —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å
  if (type === 'CLEAR_CACHE') {
    const cacheType = data.payload && data.payload.cacheType;
    let targetNames = [CORE_CACHE, RUNTIME_CACHE, MEDIA_CACHE, OFFLINE_CACHE, META_CACHE];

    if (cacheType === 'media') {
      targetNames = [MEDIA_CACHE];
    } else if (cacheType === 'offline') {
      targetNames = [OFFLINE_CACHE];
    }

    event.waitUntil(
      caches.keys().then((names) =>
        Promise.all(
          names.map((name) => {
            if (targetNames.includes(name)) {
              return caches.delete(name);
            }
            return undefined;
          })
        )
      )
    );
    return;
  }

  if (type === 'CACHE_AUDIO') {
    // –í —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Ç–æ–ª—å–∫–æ –Ω–µ –ø–∞–¥–∞–µ–º.
    // –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ.
    return;
  }

  if (type === 'WARM_OFFLINE_SHELL') {
    const port = ports && ports[0];
    const urls = (data.payload && Array.isArray(data.payload.urls)) ? data.payload.urls : [];

    event.waitUntil((async () => {
      try {
        const cache = await caches.open(OFFLINE_CACHE);

        // –ö–ª–∞–¥—ë–º —è–¥—Ä–æ + –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ URL (covers/lyrics/json/news/etc.)
        // addAll –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –∏–∑-–∑–∞ –æ–¥–Ω–æ–≥–æ –ø–ª–æ—Ö–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞, –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º best-effort.
        const all = STATIC_ASSETS.concat(urls);

        for (const u of all) {
          try { await cache.add(u); } catch {}
        }

        if (port) port.postMessage({ ok: true, cached: urls.length });
      } catch (e) {
        if (port) port.postMessage({ ok: false, error: String(e?.message || e) });
      }
    })());

    return;
  }

  if (type === 'GET_CACHE_SIZE') {
    const port = ports && ports[0];
    if (!port) return;

    // ‚úÖ –û–±–ª–µ–≥—á—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç:
    // - –ù–ï —á–∏—Ç–∞–µ–º body (arrayBuffer), —á—Ç–æ–±—ã –Ω–µ —Ñ—Ä–∏–∑–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
    // - –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∏ —Å—É–º–º–∞—Ä–Ω—ã–π Content-Length (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω).
    event.waitUntil(
      (async () => {
        let totalBytes = 0;
        let totalEntries = 0;

        try {
          const names = await caches.keys();
          for (const name of names) {
            const cache = await caches.open(name);
            const reqs = await cache.keys();
            totalEntries += reqs.length;

            for (const req of reqs) {
              const resp = await cache.match(req);
              if (!resp) continue;

              const len = resp.headers.get('content-length');
              if (len) {
                const n = Number(len);
                if (Number.isFinite(n) && n > 0) totalBytes += n;
              }
            }
          }
        } catch (e) {
          // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        }

        port.postMessage({
          size: totalBytes,
          entries: totalEntries,
          approx: true
        });
      })()
    );
    return;
  }
});

//=================================================
// FILE: /performance/rum.js
;(function(){
  // –ù–µ–±–æ–ª–µ–∑–Ω–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞: —á—Ç–æ–±—ã <script src="./performance/rum.js"> –Ω–µ –¥–∞–≤–∞–ª 404
  // –∏ –Ω–µ –ª–æ–º–∞–ª –º–µ—Ç—Ä–∏–∫–∏. –ï—Å–ª–∏ –≤ custom.json –ø–æ—è–≤–∏—Ç—Å—è endpoint ‚Äî –≤–∞—à –∫–æ–¥ –≤ index.html
  // –≤—ã–∑–æ–≤–µ—Ç initRUM(...) –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏.
  if (typeof window.initRUM !== 'function') {
    window.initRUM = function initRUM() { /* no-op */ };
  }
})();

//=================================================
// FILE: /scripts/app.js
// scripts/app.js
// –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (clean + –±–µ–∑ –¥—É–±–ª–µ–π)
// –í–ê–ñ–ù–û: iOS unlock –ù–ï —Ç—É—Ç, –∞ –≤ PlayerCore.
(function () {
  'use strict';

  const w = window;

  class Application {
    constructor() {
      this.initialized = false;
      this.__swMsgBound = false;
    }

    async initialize() {
      if (this.initialized) return;
      this.initialized = true;

      try {
        await this.loadAlbumsIndex();

        // OFFLINE: —Å—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        try {
          const offlineBoot = await import('./app/offline-ui-bootstrap.js');
          offlineBoot?.attachOfflineUI?.();
        } catch (e) {
          console.error('‚ùå Critical: Offline Bootstrap failed:', e);
        }

        await new Promise(r => setTimeout(r, 50));

        try {
          const [indicatorsMod, overlayMod, pcBoot] = await Promise.all([
            import('./ui/offline-indicators.js'),
            import('./ui/cache-progress-overlay.js'),
            import('./app/playback-cache-bootstrap.js'),
          ]);
          indicatorsMod?.attachOfflineIndicators?.();
          overlayMod?.attachCacheProgressOverlay?.();
          pcBoot?.attachPlaybackCache?.();
        } catch (e) {
          console.warn('‚ö†Ô∏è Offline UI subsystems partial failure:', e);
        }

        // OFFLINE: preload TrackRegistry once
        try {
          const key = 'offline:preloadAllTracksOnce:v1';
          if (localStorage.getItem(key) !== '1') {
            const mod = await import('./ui/offline-modal.js');
            if (mod?.preloadAllAlbumsTrackIndex) {
              await mod.preloadAllAlbumsTrackIndex();
              localStorage.setItem(key, '1');
            }
          }
        } catch (e) {
          console.warn('OFFLINE preloadAllAlbumsTrackIndex failed:', e);
        }

        await this.initializeFavorites();
        await this.initializeGallery();
        await this.initializeAlbums();
        await this.initializePlayerUI();

        this.initializeModules();

        if (w.PlayerState?.apply) await w.PlayerState.apply();

        this.setupHotkeys();
        this.setupPWAInstall();
        this.setupServiceWorkerMessaging();
      } catch (error) {
        console.error('‚ùå Failed to initialize app:', error);
        w.NotificationSystem?.error?.('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
      }
    }

    async loadAlbumsIndex() {
      if (Array.isArray(w.albumsIndex) && w.albumsIndex.length) return;

      try {
        if (w.Utils?.onceEvent) await w.Utils.onceEvent(window, 'albumsIndex:ready', { timeoutMs: 8000 });
        else await new Promise(r => setTimeout(r, 200));
      } catch {}

      w.albumsIndex = Array.isArray(w.albumsIndex) ? w.albumsIndex : [];
    }

    async _waitForReady(checkFn, maxMs = 2000) {
      const waitFor = w.Utils?.waitFor;
      if (typeof waitFor === 'function') return waitFor(checkFn, maxMs, 50);

      const started = Date.now();
      while (!checkFn() && (Date.now() - started) < maxMs) { // eslint-disable-next-line no-await-in-loop
        await new Promise(r => setTimeout(r, 50));
      }
      return checkFn();
    }

    async initializeFavorites() {
      // Favorites —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ PlayerCore + FavoritesUI.
      // –°—Ç–∞—Ä—ã–π FavoritesManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º (–∏–∑–±–∞–≤–ª—è–µ–º—Å—è –æ—Ç –¥—É–±–ª–µ–π –∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö DOM —Å–æ–±—ã—Ç–∏–π).
      return;
    }

    async initializeGallery() {
      if (await this._waitForReady(() => !!w.GalleryManager?.initialize)) {
        w.GalleryManager.initialize();
      }
    }

    async initializeAlbums() {
      if (await this._waitForReady(() => !!w.AlbumsManager?.initialize)) {
        w.AlbumsManager.initialize();
      }
    }

    async initializePlayerUI() {
      if (await this._waitForReady(() => !!w.PlayerUI?.initialize)) {
        w.PlayerUI.initialize();
      }
    }

    initializeModules() {
      const maybeInit = (obj) => { try { obj?.initialize?.(); } catch {} };
      maybeInit(w.SleepTimer);
      maybeInit(w.LyricsModal);
      maybeInit(w.SystemInfoManager);
      maybeInit(w.BackgroundAudioManager);
    }

    setupServiceWorkerMessaging() {
      if (!('serviceWorker' in navigator) || this.__swMsgBound) return;
      this.__swMsgBound = true;

      const handle = (event) => {
        const msg = event?.data || {};
        if (!msg || typeof msg !== 'object') return;

        if (msg.type === 'SW_VERSION') {
          const swVer = String(msg.version || '').trim();
          const appVer = String(w.VERSION || '').trim();
          if (!swVer || (appVer && swVer === appVer)) return;
          try { w.ServiceWorkerManager?.handleVersionMessage?.({ swVer, appVer }); } catch {}
        }
      };

      navigator.serviceWorker.addEventListener('message', handle);
      window.addEventListener('message', handle);
    }

    setupHotkeys() {
      document.addEventListener('keydown', (e) => {
        if (['INPUT', 'TEXTAREA'].includes(e.target?.tagName)) return;

        const key = String(e.key || '').toLowerCase();
        const pc = w.playerCore;

        switch (key) {
          case 'k':
          case ' ':
            e.preventDefault();
            w.PlayerUI?.togglePlayPause?.();
            break;

          case 'n': e.preventDefault(); pc?.next?.(); break;
          case 'p': e.preventDefault(); pc?.prev?.(); break;
          case 'x': e.preventDefault(); pc?.stop?.(); break;

          case 'm': e.preventDefault(); document.getElementById('mute-btn')?.click(); break;
          case 'r': e.preventDefault(); document.getElementById('repeat-btn')?.click(); break;
          case 'u': e.preventDefault(); document.getElementById('shuffle-btn')?.click(); break;
          case 'a': e.preventDefault(); document.getElementById('animation-btn')?.click(); break;
          case 'b': e.preventDefault(); document.getElementById('pulse-btn')?.click(); break;
          case 'f': e.preventDefault(); document.getElementById('favorites-btn')?.click(); break;
          case 't': e.preventDefault(); w.SleepTimer?.show?.(); break;
          case 'y': e.preventDefault(); document.getElementById('lyrics-toggle-btn')?.click(); break;

          case 'arrowleft': e.preventDefault(); pc?.seek?.(Math.max(0, (pc.getPosition?.() || 0) - 5)); break;
          case 'arrowright': e.preventDefault(); pc?.seek?.(Math.min(pc.getDuration?.() || 0, (pc.getPosition?.() || 0) + 5)); break;

          case 'arrowup': {
            e.preventDefault();
            const v = pc?.getVolume?.() ?? 100;
            pc?.setVolume?.(Math.min(100, v + 5));
            break;
          }
          case 'arrowdown': {
            e.preventDefault();
            const v = pc?.getVolume?.() ?? 100;
            pc?.setVolume?.(Math.max(0, v - 5));
            break;
          }
        }
      });
    }

    setupPWAInstall() {
      let deferredPrompt = null;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;

        const btn = document.getElementById('install-pwa-btn');
        if (!btn) return;

        btn.style.display = 'block';
        btn.onclick = async () => {
          if (!deferredPrompt) return;

          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;

          if (outcome === 'accepted') w.NotificationSystem?.success?.('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');

          deferredPrompt = null;
          btn.style.display = 'none';
        };
      });

      window.addEventListener('appinstalled', () => {
        w.NotificationSystem?.success?.('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
        const btn = document.getElementById('install-pwa-btn');
        if (btn) btn.style.display = 'none';
      });
    }
  }

  w.app = new Application();
})();

//=================================================
// FILE: /scripts/app/albums.js
// scripts/app/albums.js
const APP_CONFIG = window.APP_CONFIG;

import { registerTrack } from './track-registry.js';
import { $, toStr, escHtml, isMobileUA } from './utils/app-utils.js';
import { renderFavoritesList, renderFavoritesEmpty, bindFavoritesList } from '../ui/favorites-view.js';
import { loadAndRenderNewsInline } from '../ui/news-inline.js';

const FAV = window.SPECIAL_FAVORITES_KEY || '__favorites__';
const NEWS = window.SPECIAL_RELIZ_KEY || '__reliz__';

const STAR_ON = 'img/star.png';
const STAR_OFF = 'img/star2.png';
const LOGO = 'img/logo.png';

function setStar(img, liked) {
  if (!img) return;
  try { img.src = liked ? STAR_ON : STAR_OFF; } catch {}
}

function firstUrl(base, rel) {
  return rel ? new URL(rel, base).toString() : null;
}

function normalizeSocials(raw) {
  if (Array.isArray(raw?.social_links)) return raw.social_links;
  if (Array.isArray(raw?.socials)) return raw.socials.map((s) => ({ label: s?.title, url: s?.url }));
  return [];
}

function buildAlbumIconSrc(baseIcon, isMobile) {
  const p1 = isMobile
    ? baseIcon.replace(/icon_album\/(.+)\.png$/i, 'icon_album/mobile/$1@1x.jpg')
    : baseIcon.replace(/\.png$/i, '@1x.png');
  const p2 = isMobile ? p1.replace(/@1x\.jpg$/i, '@2x.jpg') : p1.replace(/@1x\.png$/i, '@2x.png');
  return { p1, p2 };
}

function normalizeTracks(tracks, base, albumKey) {
  const out = [];

  for (let i = 0; i < tracks.length; i++) {
    const t = tracks[i] || {};

    const fileHi = firstUrl(base, t.audio);
    const fileLo = firstUrl(base, t.audio_low);

    const lyrics = firstUrl(base, t.lyrics) || firstUrl(base, t.lrc);
    const fulltext = firstUrl(base, t.fulltext);

    const uid = typeof t.uid === 'string' && t.uid.trim() ? t.uid.trim() : null;

    const sizeHi = typeof t.size === 'number' ? t.size : null;
    const sizeLo = typeof t.size_low === 'number' ? t.size_low : null;

    const hasLyrics = typeof t.hasLyrics === 'boolean' ? t.hasLyrics : !!lyrics;
    const sources = fileHi || fileLo ? { audio: { hi: fileHi, lo: fileLo } } : null;

    const tr = {
      num: i + 1,
      title: t.title || `–¢—Ä–µ–∫ ${i + 1}`,

      // back-compat:
      file: fileHi,

      fileHi,
      fileLo,
      sizeHi,
      sizeLo,
      sources,

      lyrics,
      fulltext,
      uid,
      hasLyrics,
    };

    out.push(tr);

    if (uid) {
      try {
        registerTrack({
          uid,
          title: tr.title,
          audio: tr.fileHi || tr.file || null,
          audio_low: tr.fileLo || null,
          size: tr.sizeHi || null,
          size_low: tr.sizeLo || null,
          lyrics: tr.lyrics || null,
          fulltext: tr.fulltext || null,
          sourceAlbum: albumKey,
        });
      } catch {}
    }
  }

  return out;
}

class AlbumsManager {
  constructor() {
    this.currentAlbum = null;
    this.playingAlbum = null;

    this.albumsData = new Map();
    this.albumCoverUrlCache = new Map();

    // cache –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –Ω–∞ –∫–ª–∏–∫–∞—Ö
    // albumKey -> { tracksForCore, uidToIndex }
    this._corePlaylistCache = new Map();

    this.isLoading = false;
    this.isGalleryVisible = true;

    this._favSyncBound = false;
    this._favoritesViewBound = false;
  }

  async initialize() {
    await this._ensureAlbumsIndexReady();
    if (!Array.isArray(window.albumsIndex) || window.albumsIndex.length === 0) return;

    this.renderAlbumIcons();
    this._bindFavoritesAlbumSync();

    const key = localStorage.getItem('currentAlbum') || this._pickDefaultAlbumKey();
    if (key) await this.loadAlbum(key);
  }

  async _ensureAlbumsIndexReady() {
    if ((!Array.isArray(window.albumsIndex) || window.albumsIndex.length === 0) && window.Utils?.onceEvent) {
      try { await window.Utils.onceEvent(window, 'albumsIndex:ready', { timeoutMs: 8000 }); } catch {}
    }
    if (!Array.isArray(window.albumsIndex) || window.albumsIndex.length === 0) {
      console.error('‚ùå No albums found (albumsIndex is empty)');
    }
  }

  _pickDefaultAlbumKey() {
    const order = Array.isArray(APP_CONFIG?.ICON_ALBUMS_ORDER) ? APP_CONFIG.ICON_ALBUMS_ORDER : [];
    const keys = order.map((x) => x?.key).filter(Boolean);
    const idx = Array.isArray(window.albumsIndex) ? window.albumsIndex : [];

    const firstRegular = keys.find((k) => !toStr(k).startsWith('__') && idx.some((a) => a.key === k));
    return firstRegular || idx?.[0]?.key || null;
  }

  _bindFavoritesAlbumSync() {
    if (this._favSyncBound) return;
    this._favSyncBound = true;

    const pc = window.playerCore;
    if (!pc?.onFavoritesChanged) return;

    pc.onFavoritesChanged((d) => {
      const a = toStr(d?.albumKey).trim();
      const u = toStr(d?.uid).trim();
      if (!a || !u) return;

      const liked = !!d?.liked;
      const sel = `.like-star[data-album="${CSS.escape(a)}"][data-uid="${CSS.escape(u)}"]`;
      document.querySelectorAll(sel).forEach((img) => setStar(img, liked));
    });
  }

  renderAlbumIcons() {
    const container = $('album-icons');
    if (!container) return;

    container.innerHTML = '';

    const isMobile = isMobileUA();
    const order = Array.isArray(APP_CONFIG?.ICON_ALBUMS_ORDER) ? APP_CONFIG.ICON_ALBUMS_ORDER : [];
    const idx = Array.isArray(window.albumsIndex) ? window.albumsIndex : [];

    for (const it of order) {
      const key = it?.key;
      if (!key) continue;
      if (!toStr(key).startsWith('__') && !idx.some((a) => a.key === key)) continue;

      const title = it?.title || '';
      const baseIcon = it?.icon || LOGO;
      const { p1, p2 } = buildAlbumIconSrc(baseIcon, isMobile);

      const el = document.createElement('div');
      el.className = 'album-icon';
      el.dataset.album = key;
      el.dataset.akey = key;
      el.title = title;
      el.innerHTML = `<img src="${p1}" srcset="${p2} 2x" alt="${escHtml(title)}" draggable="false" loading="lazy" width="60" height="60">`;

      const onActivate = (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.handleAlbumIconClick(key);
      };

      el.addEventListener('click', onActivate);
      el.addEventListener('pointerup', onActivate, { passive: false });

      container.appendChild(el);
    }
  }

  async handleAlbumIconClick(albumKey) {
    if (this.currentAlbum === albumKey && !toStr(albumKey).startsWith('__')) {
      this.toggleGalleryVisibility();
      return;
    }
    await this.loadAlbum(albumKey);
  }

  toggleGalleryVisibility() {
    this.isGalleryVisible = !this.isGalleryVisible;
    const coverWrap = $('cover-wrap');
    if (coverWrap) coverWrap.style.display = this.isGalleryVisible ? '' : 'none';
    window.NotificationSystem?.info(this.isGalleryVisible ? 'üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –ø–æ–∫–∞–∑–∞–Ω–∞' : 'üö´ –ì–∞–ª–µ—Ä–µ—è —Å–∫—Ä—ã—Ç–∞');
  }

  async loadAlbum(albumKey) {
    if (this.isLoading) return;
    this.isLoading = true;

    try {
      this.isGalleryVisible = true;
      this.clearUI();

      if (albumKey === FAV) await this.loadFavoritesAlbum();
      else if (albumKey === NEWS) await this.loadNewsAlbum();
      else await this.loadRegularAlbum(albumKey);

      this.currentAlbum = albumKey;
      this.updateActiveIcon(albumKey);
      localStorage.setItem('currentAlbum', albumKey);

      $('track-list')?.classList.remove('filtered');

      window.PlayerUI?.switchAlbumInstantly?.(albumKey);
      window.PlayerState?.save?.();
    } catch (e) {
      console.error('‚ùå Failed to load album:', e);
      window.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–∞');
    } finally {
      this.isLoading = false;
    }
  }

  async loadRegularAlbum(albumKey) {
    const albumInfo = window.albumsIndex?.find((a) => a.key === albumKey);
    if (!albumInfo) throw new Error(`Album ${albumKey} not found`);

    let albumData = this.albumsData.get(albumKey);
    if (!albumData) {
      const base = albumInfo.base.endsWith('/') ? albumInfo.base : `${albumInfo.base}/`;

      const res = await fetch(`${base}config.json`, { cache: 'no-cache' });
      if (!res.ok) throw new Error(`Failed to load config.json for ${albumKey}: HTTP ${res.status}`);

      const raw = (await res.json()) || {};
      const tracksRaw = Array.isArray(raw.tracks) ? raw.tracks : [];

      albumData = {
        title: raw.albumName || albumInfo.title,
        artist: raw.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        cover: raw.cover || 'cover.jpg',
        social_links: normalizeSocials(raw),
        tracks: normalizeTracks(tracksRaw, base, albumKey),
      };

      this.albumsData.set(albumKey, albumData);
      this._corePlaylistCache.delete(albumKey);
    }

    await this.loadGallery(albumKey);

    try {
      const url = await window.GalleryManager?.getFirstCoverUrl?.(albumKey);
      this.albumCoverUrlCache.set(albumKey, url || LOGO);
    } catch {
      this.albumCoverUrlCache.set(albumKey, LOGO);
    }

    try {
      const count = window.GalleryManager?.getItemsCount?.() || 0;
      if (count <= 0) {
        const slot = $('cover-slot');
        if (slot) slot.innerHTML = `<img src="${LOGO}" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
    } catch {}

    this.renderAlbumTitle(albumData.title || albumInfo.title);
    this.renderSocials(albumData.social_links);
    this.renderTrackList(albumData.tracks, albumInfo);

    window.PlayerUI?.updateMiniHeader?.();
    window.PlayerUI?.updateNextUpLabel?.();

    const coverWrap = $('cover-wrap');
    if (coverWrap) coverWrap.style.display = '';
  }

  async loadGallery(albumKey) {
    await window.GalleryManager?.loadGallery?.(albumKey);
  }

  _getTracksForCore(albumKey, albumData) {
    const cached = this._corePlaylistCache.get(albumKey);
    if (cached?.tracksForCore?.length && cached?.uidToIndex) return cached;

    const coverUrl = this.albumCoverUrlCache.get(albumKey) || LOGO;

    const tracksForCore = (Array.isArray(albumData?.tracks) ? albumData.tracks : [])
      .filter((t) => t && (t.fileHi || t.file || t.fileLo))
      .map((t) => ({
        src: t.fileHi || t.file || t.fileLo,
        sources: t.sources || null,
        title: t.title,
        artist: albumData.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: albumKey,
        cover: coverUrl,
        lyrics: t.lyrics || null,
        fulltext: t.fulltext || null,
        uid: typeof t.uid === 'string' && t.uid.trim() ? t.uid.trim() : null,
        hasLyrics: t.hasLyrics,
      }))
      .filter((t) => !!t.uid && !!t.src);

    const uidToIndex = new Map();
    tracksForCore.forEach((t, i) => uidToIndex.set(String(t.uid), i));

    const pack = { tracksForCore, uidToIndex };
    this._corePlaylistCache.set(albumKey, pack);
    return pack;
  }

  async loadFavoritesAlbum() {
    this.renderAlbumTitle('‚≠ê‚≠ê‚≠ê –ò–ó–ë–†–ê–ù–ù–û–ï ‚≠ê‚≠ê‚≠ê', 'fav');

    const coverWrap = $('cover-wrap');
    if (coverWrap) coverWrap.style.display = 'none';

    const container = $('track-list');
    if (!container) return;

    const getModel = () => {
      const m = window.FavoritesUI?.getModel?.();
      if (Array.isArray(m)) return m;
      return Array.isArray(window.favoritesRefsModel) ? window.favoritesRefsModel : [];
    };

    const rebuild = async () => {
      try { await window.FavoritesUI?.buildFavoritesRefsModel?.(); } catch {}
      const model = getModel();
      if (!model.length) renderFavoritesEmpty(container);
      else renderFavoritesList(container, model);
    };

    if (!this._favoritesViewBound) {
      this._favoritesViewBound = true;

      bindFavoritesList(container, {
        getModel,

        onStarClick: ({ uid, albumKey }) => {
          window.playerCore?.toggleFavorite?.(uid, { fromAlbum: false, albumKey });
        },

        onActiveRowClick: async ({ uid, albumKey }) => {
          const model = getModel();
          const active = model.filter((it) => it && it.__active && it.audio);

          const activeIndex = active.findIndex(
            (it) => String(it?.__uid || '').trim() === uid && String(it?.__a || '').trim() === albumKey
          );

          if (activeIndex >= 0) await this.ensureFavoritesPlayback(activeIndex);
        },

        onInactiveRowClick: ({ uid, title }) => {
          window.playerCore?.showInactiveFavoriteModal?.({
            uid,
            title,
            onDeleted: async () => window.PlayerUI?.updateAvailableTracksForPlayback?.(),
          });
        },
      });

      const pc = window.playerCore;
      if (pc?.onFavoritesChanged) {
        pc.onFavoritesChanged(async () => {
          if (this.currentAlbum !== FAV) return;
          await rebuild();
          window.PlayerUI?.updateAvailableTracksForPlayback?.();
          window.PlayerUI?.ensurePlayerBlock?.(-1);
        });
      }
    }

    await rebuild();
  }

  async ensureFavoritesPlayback(activeIndex) {
    let model = null;
    try { model = window.FavoritesUI?.getModel?.(); } catch {}
    if (!Array.isArray(model)) model = window.favoritesRefsModel;

    const list = Array.isArray(model) ? model : [];
    if (!list.length) return void window.NotificationSystem?.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');

    const active = list.filter((it) => it && it.__active && it.audio);
    if (!active.length) return void window.NotificationSystem?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');

    const startIndex = Number.isFinite(activeIndex) && activeIndex >= 0 ? activeIndex : 0;
    const clicked = active[startIndex] || active[0];

    const tracks = active.map((it) => ({
      src: it.audio,
      sources: it.sources || null,
      title: it.title,
      artist: it.__artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      album: FAV,
      cover: it.__cover || LOGO,
      lyrics: it.lyrics || null,
      fulltext: it.fulltext || null,
      uid: typeof it.__uid === 'string' && it.__uid.trim() ? it.__uid.trim() : null,
      sourceAlbum: it.__a,
      hasLyrics: it.hasLyrics,
    })).filter((t) => !!t.uid && !!t.src);

    if (!tracks.length) return void window.NotificationSystem?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');

    window.playerCore.setPlaylist(
      tracks,
      startIndex,
      { artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞', album: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', cover: LOGO },
      { preservePosition: false }
    );

    window.playerCore.play(startIndex);

    this.setPlayingAlbum(FAV);

    const cu = toStr(clicked?.__uid).trim();
    const ca = toStr(clicked?.__a).trim();
    this.highlightCurrentTrack(-1, { uid: cu, albumKey: ca });

    window.PlayerUI?.ensurePlayerBlock?.(startIndex, { userInitiated: true });
    window.PlayerUI?.updateAvailableTracksForPlayback?.();
  }

  async loadNewsAlbum() {
    this.renderAlbumTitle('üì∞ –ù–û–í–û–°–¢–ò üì∞', 'news');
    await this.loadGallery(NEWS);

    const coverWrap = $('cover-wrap');
    if (coverWrap) coverWrap.style.display = '';

    const container = $('track-list');
    if (!container) return;

    await loadAndRenderNewsInline(container);
  }

  renderAlbumTitle(title, modifier = '') {
    const el = $('active-album-title');
    if (!el) return;
    el.textContent = title;
    el.className = 'active-album-title';
    if (modifier) el.classList.add(modifier);
  }

  renderSocials(links) {
    const container = $('social-links');
    if (!container) return;

    container.innerHTML = '';

    const normalized = Array.isArray(links)
      ? links.map((l) => ({ label: l?.label || l?.title || '–°—Å—ã–ª–∫–∞', url: l?.url })).filter((l) => !!l.url)
      : [];

    for (const link of normalized) {
      const a = document.createElement('a');
      a.href = link.url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = link.label;
      container.appendChild(a);
    }
  }

  renderTrackList(tracks, albumInfo) {
    const container = $('track-list');
    if (!container) return;
    container.innerHTML = '';

    for (let i = 0; i < tracks.length; i++) {
      container.appendChild(this.createTrackElement(tracks[i], albumInfo.key, i));
    }
  }

  createTrackElement(track, albumKey, index) {
    const el = document.createElement('div');
    el.className = 'track';
    el.id = `trk${index}`;
    el.dataset.index = String(index);
    el.dataset.album = albumKey;

    const uid = typeof track?.uid === 'string' && track.uid.trim() ? track.uid.trim() : '';
    el.dataset.uid = uid;

    const liked = window.playerCore?.isFavorite?.(uid) || false;
    const numText = `${String(track?.num || index + 1).padStart(2, '0')}.`;

    el.innerHTML = `
      <div class="tnum">${numText}</div>
      <div class="track-title">${toStr(track?.title || '')}</div>
      <img src="${liked ? STAR_ON : STAR_OFF}"
           class="like-star"
           alt="–∑–≤–µ–∑–¥–∞"
           data-album="${albumKey}"
           data-uid="${uid}">
    `;

    el.addEventListener('click', (e) => {
      if (e.target?.classList?.contains('like-star')) return;

      const albumData = this.albumsData.get(albumKey);
      if (!albumData || !window.playerCore) {
        this.highlightCurrentTrack(index);
        window.NotificationSystem?.error('–ê–ª—å–±–æ–º –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é');
        return;
      }

      const { tracksForCore, uidToIndex } = this._getTracksForCore(albumKey, albumData);
      const playIndex = uidToIndex.get(uid);

      if (!Number.isFinite(playIndex)) {
        window.NotificationSystem?.warning('–¢—Ä–µ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
        return;
      }

      const snapshot = window.playerCore.getPlaylistSnapshot?.() || [];
      const needsNew =
        snapshot.length !== tracksForCore.length ||
        snapshot.some((t, i) => String(t?.uid || '').trim() !== String(tracksForCore[i]?.uid || '').trim());

      if (needsNew) {
        const coverUrl = this.albumCoverUrlCache.get(albumKey) || LOGO;

        window.playerCore.setPlaylist(
          tracksForCore,
          playIndex,
          {
            artist: albumData.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
            album: albumData.title || '',
            cover: coverUrl,
          },
          { preservePosition: false }
        );
      }

      this.highlightCurrentTrack(index);
      window.playerCore.play(playIndex);

      this.setPlayingAlbum(albumKey);
      window.PlayerUI?.ensurePlayerBlock?.(index, { userInitiated: true });
    });

    const star = el.querySelector('.like-star');
    star?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();

      const trackUid = toStr(star.dataset.uid).trim();
      if (!trackUid) return void window.NotificationSystem?.warning('UID —Ç—Ä–µ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ config.json');
      if (!window.playerCore?.toggleFavorite) return void window.NotificationSystem?.error('PlayerCore –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');

      const isLiked = !!window.playerCore?.isFavorite?.(trackUid);
      const next = !isLiked;

      setStar(star, next);
      star.classList.add('animating');
      setTimeout(() => star.classList.remove('animating'), 320);

      window.playerCore.toggleFavorite(trackUid, { fromAlbum: true, albumKey });
    });

    return el;
  }

  highlightCurrentTrack(index, opts = {}) {
    document.querySelectorAll('.track.current').forEach((n) => n.classList.remove('current'));

    const uid = toStr(opts?.uid).trim();
    const albumKey = toStr(opts?.albumKey).trim();

    if (this.currentAlbum === FAV && uid && albumKey) {
      const sel = `.track[data-album="${CSS.escape(albumKey)}"][data-uid="${CSS.escape(uid)}"]`;
      document.querySelector(sel)?.classList.add('current');
      return;
    }

    if (uid) {
      const sel = `.track[data-uid="${CSS.escape(uid)}"]`;
      document.querySelector(sel)?.classList.add('current');
      return;
    }

    if (!Number.isFinite(index) || index < 0) return;
    document.querySelector(`.track[data-index="${index}"]`)?.classList.add('current');
  }

  updateActiveIcon(albumKey) {
    document.querySelectorAll('.album-icon').forEach((icon) => {
      icon.classList.toggle('active', icon.dataset.album === albumKey);
    });
  }

  clearUI() {
    const tl = $('track-list');
    if (tl) tl.innerHTML = '';
    const sl = $('social-links');
    if (sl) sl.innerHTML = '';
    window.GalleryManager?.clear?.();
  }

  getCurrentAlbum() { return this.currentAlbum; }
  getPlayingAlbum() { return this.playingAlbum; }
  setPlayingAlbum(albumKey) { this.playingAlbum = albumKey || null; }

  getAlbumData(albumKey) { return this.albumsData.get(albumKey); }
  getAlbumConfigByKey(albumKey) { return this.albumsData.get(albumKey); }

  getTrackUid(_albumKey, trackUid) { return toStr(trackUid).trim() || null; }
}

window.AlbumsManager = new AlbumsManager();
export default AlbumsManager;

//=================================================
// FILE: /scripts/app/gallery.js
// scripts/app/gallery.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–µ–π –æ–±–ª–æ–∂–µ–∫

class GalleryManager {
  constructor() {
    this.items = [];
    this.currentIndex = 0;
    this.autoplayInterval = null;
    this.isAutoplayEnabled = false;
    this.transitionLock = false;
    
    this.prefetchedUrls = new Set();
    this.imageLoader = null;
    
    this.ALBUM_GALLERY_MAP = {
      'krevetochka': '00',
      'mezhdu-zlom-i-dobrom': '01',
      'golos-dushi': '02',
      'odnazhdy-v-skazke': '03',
      '__reliz__': 'news'
    };
    
    this.ALLOWED_IDS = new Set(['00', '01', '02', '03', 'news']);
    this.GALLERY_BASE = './albums/gallery/';
  }

  initialize() {
    this.setupNavigation();
    this.setupSwipeGestures();
    this.setupVisibilityHandler();
    console.log('‚úÖ GalleryManager initialized');
  }

  getCentralId(albumKey) {
    if (!albumKey || albumKey === '__favorites__') return null;
    const id = this.ALBUM_GALLERY_MAP[albumKey];
    return (id && this.ALLOWED_IDS.has(id)) ? id : null;
  }

  async loadGallery(albumKey) {
    const id = this.getCentralId(albumKey);
    
    if (!id) {
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
      return;
    }

    // ‚úÖ –ö—ç—à–∏—Ä—É–µ–º 404 –¥–ª—è –≥–∞–ª–µ—Ä–µ–π —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    const gallery404Key = `gallery_404_cache:v1`;
    let gallery404Cache = {};
    try {
      const raw = sessionStorage.getItem(gallery404Key);
      gallery404Cache = raw ? JSON.parse(raw) : {};
    } catch {}

    if (gallery404Cache[id]) {
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
      return;
    }

    try {
      const baseDir = `${this.GALLERY_BASE}${id}/`;
      const response = await fetch(`${baseDir}index.json`, { cache: 'force-cache' });
      
      if (!response.ok) {
        // ‚úÖ –ö—ç—à–∏—Ä—É–µ–º 404
        if (response.status === 404) {
          gallery404Cache[id] = Date.now();
          try { sessionStorage.setItem(gallery404Key, JSON.stringify(gallery404Cache)); } catch {}
        }
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      const rawItems = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);

      this.items = rawItems
        .map(item => this.normalizeItem(item, baseDir))
        .filter(Boolean);

      this.currentIndex = 0;
      
      if (this.items.length > 0) {
        this.renderItem(0);
        this.updateNavigationState();
        this.startAutoplay();
      }

      console.log(`‚úÖ Gallery loaded: ${this.items.length} items`);
    } catch (error) {
      // ‚úÖ –¢–∏—Ö–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏ (–Ω–µ –∑–∞—Å–æ—Ä—è–µ–º –∫–æ–Ω—Å–æ–ª—å)
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º logo.png –∫–∞–∫ fallback
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
    }
  }

  normalizeItem(raw, baseDir) {
    if (!raw) return null;

    const toAbs = (p) => {
      if (!p) return null;
      const s = String(p).replace(/^\.?\//, '');
      if (/^https?:\/\//i.test(s)) return s;
      if (/^(albums|img|icons|assets)\//i.test(s)) return `./${s}`;
      return baseDir + s;
    };

    if (typeof raw === 'string') {
      const isHtml = /\.html(\?|#|$)/i.test(raw);
      return {
        type: isHtml ? 'html' : 'img',
        src: toAbs(raw),
        formats: null
      };
    }

    const type = String(raw.type || '').toLowerCase() === 'html' ? 'html' : 'img';

    if (type === 'html') {
      return {
        type: 'html',
        src: toAbs(raw.src || ''),
        formats: null
      };
    }

    const formats = {
      webp: toAbs(raw.formats?.webp || null),
      full: toAbs(raw.formats?.full || raw.src || null),
      thumb: toAbs(raw.formats?.thumb || null)
    };

    return {
      type: 'img',
      src: formats.full || toAbs(raw.src || ''),
      formats
    };
  }

  renderItem(index) {
    if (this.transitionLock) return;
    if (!this.items.length) return;

    this.transitionLock = true;
    this.currentIndex = (index + this.items.length) % this.items.length;

    const item = this.items[this.currentIndex];
    const slot = document.getElementById('cover-slot');
    
    if (!slot || !item) {
      this.transitionLock = false;
      return;
    }

    if (this.imageLoader) {
      this.imageLoader.onload = null;
      this.imageLoader.onerror = null;
      this.imageLoader = null;
    }

    if (item.type === 'html') {
      this.renderHtml(slot, item.src);
    } else {
      this.renderImage(slot, item);
    }

    setTimeout(() => {
      this.prefetchNext();
      this.transitionLock = false;
    }, 200);
  }

  renderHtml(slot, src) {
    const iframe = document.createElement('iframe');
    
    // ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ html-–±–∞–Ω–Ω–µ—Ä—ã (albums/gallery/...) –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ.
    // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞) –Ω—É–∂–µ–Ω allow-same-origin.
    // ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º security-–æ—à–∏–±–∫–∏ –æ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –±–∞–Ω–Ω–µ—Ä–∞:
    // –Ω–µ –¥–∞—ë–º outer-iframe same-origin.
    iframe.setAttribute('sandbox', 'allow-scripts allow-popups allow-forms');
    iframe.setAttribute('referrerpolicy', 'no-referrer');
    iframe.loading = 'lazy';
    iframe.src = src;

    this.clearSlot(slot);
    slot.appendChild(iframe);
  }

  renderImage(slot, item) {
    const img = new Image();
    this.imageLoader = img;

    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';

    const src = item.formats?.webp || item.formats?.full || item.src;

    img.onload = () => {
      if (this.imageLoader !== img) return;

      const picture = document.createElement('picture');

      if (item.formats?.webp) {
        const source = document.createElement('source');
        source.type = 'image/webp';
        source.srcset = item.formats.webp;
        picture.appendChild(source);
      }

      const displayImg = document.createElement('img');
      displayImg.src = src;
      displayImg.alt = '–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞';
      displayImg.decoding = 'async';
      displayImg.referrerPolicy = 'no-referrer';
      displayImg.style.cssText = 'opacity: 0; transition: opacity .15s ease-out';

      picture.appendChild(displayImg);

      this.clearSlot(slot);
      slot.appendChild(picture);

      requestAnimationFrame(() => {
        displayImg.style.opacity = '1';
      });
    };

    img.onerror = () => console.warn('Failed to load image:', src);
    img.src = src;
  }

  clearSlot(slot) {
    while (slot.firstChild) {
      if (slot.firstChild.tagName === 'IFRAME') {
        slot.firstChild.src = 'about:blank';
      }
      slot.removeChild(slot.firstChild);
    }
  }

  prefetchNext() {
    if (this.items.length < 2) return;

    const nextIndex = (this.currentIndex + 1) % this.items.length;
    const item = this.items[nextIndex];

    if (!item || item.type !== 'img') return;

    const webp = item.formats?.webp || null;

    if (this.prefetchedUrls.size > 20) this.prefetchedUrls.clear();

    if (webp && !this.prefetchedUrls.has(webp)) {
      const img = new Image();
      img.src = webp;
      this.prefetchedUrls.add(webp);
    }
  }

  setupNavigation() {
    const leftBtn = document.getElementById('cover-gallery-arrow-left');
    const rightBtn = document.getElementById('cover-gallery-arrow-right');

    leftBtn?.addEventListener('click', () => {
      if (!this.items.length) return;
      this.renderItem(this.currentIndex - 1);
      this.restartAutoplay();
    });

    rightBtn?.addEventListener('click', () => {
      if (!this.items.length) return;
      this.renderItem(this.currentIndex + 1);
      this.restartAutoplay();
    });
  }

  setupSwipeGestures() {
    const wrap = document.getElementById('cover-wrap');
    if (!wrap) return;

    let startX = null;

    wrap.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
    }, { passive: true });

    wrap.addEventListener('touchend', (e) => {
      if (startX === null) return;

      const dx = e.changedTouches[0].clientX - startX;

      if (Math.abs(dx) > 50) {
        if (dx > 0) {
          this.renderItem(this.currentIndex - 1);
        } else {
          this.renderItem(this.currentIndex + 1);
        }
        this.restartAutoplay();
      }

      startX = null;
    }, { passive: true });
  }

  setupVisibilityHandler() {
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // ‚úÖ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≥–∞–ª–µ—Ä–µ—é (–ø–ª–µ–µ—Ä –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
        this.stopAutoplay();
      } else {
        // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –∫—Ä—É—Ç–∏—Ç—å
        if (this.items.length > 1) {
          this.startAutoplay();
        }
      }
    });
  }

  updateNavigationState() {
    const wrap = document.getElementById('cover-wrap');
    if (!wrap) return;

    if (this.items.length > 1) {
      wrap.classList.add('gallery-nav-ready');
    } else {
      wrap.classList.remove('gallery-nav-ready');
    }
  }

  startAutoplay() {
    if (this.items.length <= 1) return;
    if (this.autoplayInterval) return;

    this.autoplayInterval = setInterval(() => {
      this.renderItem(this.currentIndex + 1);
    }, 5000);

    this.isAutoplayEnabled = true;
  }

  stopAutoplay() {
    if (this.autoplayInterval) {
      clearInterval(this.autoplayInterval);
      this.autoplayInterval = null;
    }
    this.isAutoplayEnabled = false;
  }

  restartAutoplay() {
    this.stopAutoplay();
    this.startAutoplay();
  }

  clear() {
    this.stopAutoplay();
    this.items = [];
    this.currentIndex = 0;
    this.prefetchedUrls.clear();
    
    if (this.imageLoader) {
      this.imageLoader.onload = null;
      this.imageLoader.onerror = null;
      this.imageLoader = null;
    }

    const slot = document.getElementById('cover-slot');
    if (slot) this.clearSlot(slot);

    this.updateNavigationState();
  }

  getItemsCount() {
    return this.items.length;
  }

  getCurrentIndex() {
    return this.currentIndex;
  }

  /**
   * ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –ø–µ—Ä–≤–æ–π –æ–±–ª–æ–∂–∫–∏ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏ –¥–ª—è albumKey
   * (webp –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ), –ª–∏–±–æ img/logo.png.
   * –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
   */
  async getFirstCoverUrl(albumKey) {
    const id = this.getCentralId(albumKey);
    if (!id) return 'img/logo.png';

    const baseDir = `${this.GALLERY_BASE}${id}/`;

    try {
      const response = await fetch(`${baseDir}index.json`, { cache: 'force-cache' });
      if (!response.ok) return 'img/logo.png';

      const data = await response.json();
      const rawItems = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
      const first = rawItems && rawItems.length ? rawItems[0] : null;
      if (!first) return 'img/logo.png';

      const norm = this.normalizeItem(first, baseDir);
      if (!norm || norm.type !== 'img') return 'img/logo.png';

      return norm.formats?.webp || norm.formats?.full || norm.src || 'img/logo.png';
    } catch {
      return 'img/logo.png';
    }
  }
}

window.GalleryManager = new GalleryManager();

export default GalleryManager;

//=================================================
// FILE: /scripts/app/navigation.js
// scripts/app/navigation.js
// –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

class NavigationManager {
  constructor() {
    this.activeModal = null;
    this.U = window.Utils;
    this.$ = (id) => this.U.dom.byId(id);
    this.on = (el, ev, fn, opts) => this.U.dom.on(el, ev, fn, opts);
  }

  initialize() {
    this.setupEventListeners();
    console.log('‚úÖ NavigationManager initialized');
  }

  setupEventListeners() {
    const feedbackLink = this.$('feedback-link');
    this.on(feedbackLink, 'click', (e) => {
      e.preventDefault();
      this.showFeedbackModal();
    });

    const supportLink = this.$('support-link');
    if (supportLink) {
      supportLink.href = window.APP_CONFIG?.SUPPORT_URL || 'https://example.com/support';
    }

    const hotkeysBtn = this.$('hotkeys-btn');
    this.on(hotkeysBtn, 'click', (e) => {
      e.preventDefault();
      this.showHotkeysModal();
    });
  }

  showFeedbackModal() {
    this.closeModal();
    if (!window.Modals?.open) return;

    this.activeModal = window.Modals.open({
      title: '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å',
      maxWidth: 420,
      bodyHtml: `
        <p style="margin-bottom:20px; color:#8ab8fd; text-align:center;">
          –ï—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞—à–ª–∏ –æ—à–∏–±–∫—É?<br>–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º!
        </p>
        <div style="display:flex; flex-direction:column; gap:15px; max-width:300px; margin:0 auto;">
          <a href="https://t.me/vitrina_razbita" target="_blank"
             style="background:#0088cc; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            Telegram
          </a>
          <a href="mailto:${window.APP_CONFIG?.SUPPORT_EMAIL || 'support@vitrina-razbita.ru'}" target="_blank"
             style="background:#4daaff; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            Email
          </a>
          <a href="${window.APP_CONFIG?.GITHUB_URL || 'https://github.com/apel-s-in/vi3na1bita-music'}" target="_blank"
             style="background:#333; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            GitHub
          </a>
        </div>
      `
    });
  }

  showHotkeysModal() {
    this.closeModal();
    if (!window.Modals?.open) return;

    this.activeModal = window.Modals.open({
      title: '–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏',
      maxWidth: 520,
      bodyHtml: `
        <div class="hotkeys-section">
          <h3 style="color:#8ab8fd; margin-bottom:12px;">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
          <div class="hotkey-item"><span class="hotkey-combo">K / –ü—Ä–æ–±–µ–ª</span><span class="hotkey-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">X</span><span class="hotkey-desc">–°—Ç–æ–ø</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">N / P</span><span class="hotkey-desc">–°–ª–µ–¥—É—é—â–∏–π/–ü—Ä–µ–¥—ã–¥—É—â–∏–π</span></div>
        </div>
        <div class="hotkeys-section">
          <h3 style="color:#8ab8fd; margin-bottom:12px;">–†–µ–∂–∏–º—ã</h3>
          <div class="hotkey-item"><span class="hotkey-combo">R</span><span class="hotkey-desc">–ü–æ–≤—Ç–æ—Ä</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">U</span><span class="hotkey-desc">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">F</span><span class="hotkey-desc">–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">T</span><span class="hotkey-desc">–¢–∞–π–º–µ—Ä —Å–Ω–∞</span></div>
        </div>
      `
    });
  }

  closeModal() {
    if (!this.activeModal) return;
    try { this.activeModal.remove(); } catch {}
    this.activeModal = null;
  }
}

window.NavigationManager = new NavigationManager();

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    try { window.NavigationManager.initialize(); } catch (e) { console.warn('NavigationManager init failed:', e); }
  });
} else {
  try { window.NavigationManager.initialize(); } catch (e) { console.warn('NavigationManager init failed:', e); }
}

export default NavigationManager;

//=================================================
// FILE: /scripts/app/offline-ui-bootstrap.js
// scripts/app/offline-ui-bootstrap.js
// –ï–¥–∏–Ω–∞—è offline-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ (ESM).
// –ü–æ –¢–ó_–ù—å—é: –∫–Ω–æ–ø–∫–∞ OFFLINE –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É, toggle —É–±—Ä–∞–Ω.
// –ù–ï —Ç—Ä–æ–≥–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç I1).

import { OfflineManager } from '../offline/offline-manager.js';
import { openOfflineModal } from '../ui/offline-modal.js';

if (!window.OfflineUI || typeof window.OfflineUI !== 'object') {
  window.OfflineUI = { offlineManager: null };
}

export const OfflineUI = window.OfflineUI;

const ALERT_KEY = 'offline:alert:v1';

function readAlertFlag() {
  // { on, ts, reason } or null
  const j = window.Utils?.lsGetJson ? window.Utils.lsGetJson(ALERT_KEY, null) : null;
  return !!j?.on;
}

function ensureAlertBadge(btn) {
  if (!btn) return null;

  let badge = document.getElementById('offline-alert-badge');
  if (badge) return badge;

  badge = document.createElement('span');
  badge.id = 'offline-alert-badge';
  badge.textContent = '!';
  badge.style.display = 'none';
  badge.style.marginRight = '8px';
  badge.style.fontWeight = '900';
  badge.style.color = '#ffcc00';
  badge.style.cursor = 'pointer';
  badge.title = '–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';

  btn.parentNode.insertBefore(badge, btn);

  const on = window.Utils?.dom?.on || ((el, ev, fn, opts) => {
    if (!el) return () => {};
    el.addEventListener(ev, fn, opts);
    return () => el.removeEventListener(ev, fn, opts);
  });

  on(badge, 'click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    window.NotificationSystem?.info('–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 6000); // x2 –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  });

  return badge;
}

function attachOfflineAlertIndicator() {
  const U = window.Utils;
  const btn = U?.dom?.byId ? U.dom.byId('offline-btn') : document.getElementById('offline-btn');
  if (!btn) return;

  const badge = ensureAlertBadge(btn);
  if (!badge) return;

  const render = () => {
    badge.style.display = readAlertFlag() ? '' : 'none';
  };

  window.addEventListener('offline:uiChanged', render);
  render();
}

function setOfflineBtnUI() {
  const U = window.Utils;
  const btn = U?.dom?.byId ? U.dom.byId('offline-btn') : document.getElementById('offline-btn');
  if (!btn) return;

  const mgr = window.OfflineUI?.offlineManager;
  const isOffline = !!mgr?.isOfflineMode?.();

  btn.textContent = 'OFFLINE';
  btn.classList.toggle('offline', isOffline);
  btn.classList.toggle('online', !isOffline);
  btn.classList.toggle('alert', readAlertFlag());
}

export function attachOfflineUI() {
  const U = window.Utils;

  if (window.OfflineUI && window.OfflineUI.offlineManager) {
    attachOfflineAlertIndicator();
    setOfflineBtnUI();
    return;
  }

  const mgr = new OfflineManager();
  mgr.initialize();

  if (!window.OfflineUI) window.OfflineUI = {};
  window.OfflineUI.offlineManager = mgr;
  OfflineUI.offlineManager = mgr;

  const btn = U?.dom?.byId ? U.dom.byId('offline-btn') : document.getElementById('offline-btn');

  if (btn) {
    const on = U?.dom?.on || ((el, ev, fn, opts) => {
      if (!el) return () => {};
      el.addEventListener(ev, fn, opts);
      return () => el.removeEventListener(ev, fn, opts);
    });

    on(btn, 'click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openOfflineModal();
    });
  }

  attachOfflineAlertIndicator();
  setOfflineBtnUI();

  window.addEventListener('offline:uiChanged', () => setOfflineBtnUI());

  mgr.on('progress', (ev) => {
    if (ev?.phase === 'cqChanged' || ev?.phase === 'cloudSettingsChanged') {
      setOfflineBtnUI();
    }
  });
}

export function getOfflineManager() {
  return window.OfflineUI?.offlineManager || null;
}

//=================================================
// FILE: /scripts/app/playback-cache-bootstrap.js
// scripts/app/playback-cache-bootstrap.js
// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Playback Cache –æ–∫–Ω–∞ PREV/CUR/NEXT —Å PlayerCore.
// –ë–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–æ–∫ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å.

import { PlaybackCacheManager } from '../offline/playback-cache.js';
import { getTrackByUid } from './track-registry.js';

function getPQ() {
  try {
    const q = String(localStorage.getItem('qualityMode:v1') || 'hi').toLowerCase();
    return (q === 'lo') ? 'lo' : 'hi';
  } catch { return 'hi'; }
}

function getFavoritesInactiveSet() {
  // ‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è inactive ‚Äî PlayerCore.getFavoritesState().
  // –≠—Ç–æ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –ø–æ—Å—Ç—Ä–æ–µ–Ω –ª–∏ window.favoritesRefsModel.
  try {
    const pc = window.playerCore;
    if (!pc?.getFavoritesState) return new Set();

    const st = pc.getFavoritesState();
    const inactive = Array.isArray(st?.inactive) ? st.inactive : [];

    const set = new Set();
    inactive.forEach((t) => {
      const uid = String(t?.uid || '').trim();
      if (uid) set.add(uid);
    });

    return set;
  } catch {
    return new Set();
  }
}

export function attachPlaybackCache() {
  const pc = window.playerCore;
  if (!pc) {
    setTimeout(attachPlaybackCache, 200);
    return;
  }

  let lastIndex = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
  let lastLen = 0;
  let direction = 'forward';

  const getPlaylistCtx = () => {
    const list = (typeof pc.getPlaylistSnapshot === 'function') ? (pc.getPlaylistSnapshot() || []) : [];
    const cur = pc.getCurrentTrack?.() || null;
    const curUid = cur?.uid ? String(cur.uid).trim() : null;
    lastLen = Array.isArray(list) ? list.length : 0;
    
    const playingAlbum = window.AlbumsManager?.getPlayingAlbum?.() || null;
    const favoritesInactive = (playingAlbum === window.SPECIAL_FAVORITES_KEY)
      ? getFavoritesInactiveSet()
      : new Set();

    return {
      list,
      curUid,
      favoritesInactive,
      direction
    };
  };

  const mgr = window.OfflineUI?.offlineManager;
  const queue = mgr?.queue || null;

  const pcm = new PlaybackCacheManager({
    queue,
    getPlaylistCtx
  });

  const trackProvider = (uid) => getTrackByUid(uid);

  async function planWindow() {
    const pq = getPQ();
    try { 
      await pcm.ensureWindowFullyCached(pq, trackProvider); 
    } catch (e) {
      console.warn('[PlaybackCache] planWindow error:', e);
    }
  }

  function updateDirectionByIndex(newIndex) {
    const len = lastLen || ((pc.getPlaylistSnapshot?.() || []).length);
    if (!len || newIndex < 0 || lastIndex < 0) {
      direction = 'forward';
      lastIndex = newIndex;
      return;
    }

    const prev = (lastIndex - 1 + len) % len;
    const next = (lastIndex + 1) % len;

    if (newIndex === prev) {
      direction = 'backward';
      lastIndex = newIndex;
      return;
    }

    if (newIndex === next) {
      direction = 'forward';
      lastIndex = newIndex;
      return;
    }

    direction = 'forward';
    lastIndex = newIndex;
  }

  if (typeof pc.on === 'function') {
    pc.on({
      onTrackChange: () => {
        const idx = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
        updateDirectionByIndex(idx);
        planWindow();
      }
    });
  }

  const btnNext = document.getElementById('next-btn');
  const btnPrev = document.getElementById('prev-btn');
  btnNext?.addEventListener('click', () => { direction = 'forward'; setTimeout(planWindow, 0); });
  btnPrev?.addEventListener('click', () => { direction = 'backward'; setTimeout(planWindow, 0); });

  setTimeout(() => {
    lastIndex = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
    planWindow();
  }, 100);
}

//=================================================
// FILE: /scripts/app/playback-policy.js
// scripts/app/playback-policy.js
// –ü–æ–ª–∏—Ç–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ (favoritesOnly + shuffle) –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–µ–µ—Ä–∞.
(function () {
  'use strict';

  const w = window, U = w.Utils;
  const LS_FAV_ONLY = 'favoritesOnlyMode';

  const trim = (v) => (U?.trimStr ? U.trimStr(v) : (String(v ?? '').trim() || null));
  const isSpecial = (k) => (U?.isSpecialAlbumKey ? U.isSpecialAlbumKey(k) : (String(k || '').startsWith('__')));

  const playingAlbumKey = () => w.AlbumsManager?.getPlayingAlbum?.() || null;

  const likedUidsForPlayingAlbum = () => {
    const a = playingAlbumKey();
    if (!a || a === w.SPECIAL_FAVORITES_KEY || isSpecial(a)) return [];
    const uids = w.playerCore?.getLikedUidsForAlbum?.(a) || [];
    return Array.isArray(uids) ? uids.map(trim).filter(Boolean) : [];
  };

  const originalSnapshot = () => {
    const o = w.playerCore?.originalPlaylist || [];
    return Array.isArray(o) ? o.slice() : [];
  };

  const currentSnapshot = () => {
    const s = w.playerCore?.getPlaylistSnapshot?.() || [];
    return Array.isArray(s) ? s.slice() : [];
  };

  const buildFavOnlyFromOriginal = (original, likedUids) => {
    if (!original?.length || !likedUids?.length) return [];
    const set = new Set(likedUids);
    return original.filter(t => {
      const uid = trim(t?.uid);
      return uid && set.has(uid);
    });
  };

  const findIndexByUid = (list, uid) => {
    const u = trim(uid);
    if (!u || !Array.isArray(list)) return -1;
    return list.findIndex(t => trim(t?.uid) === u);
  };

  const setFavOnlyModeUI = (enabled) => {
    const btn = document.getElementById('favorites-btn');
    const icon = document.getElementById('favorites-btn-icon');
    if (!btn || !icon) return;
    btn.classList.toggle('favorites-active', !!enabled);
    icon.src = enabled ? 'img/star.png' : 'img/star2.png';
    U?.lsSetBool01 ? U.lsSetBool01(LS_FAV_ONLY, !!enabled) : (function(){ try{ localStorage.setItem(LS_FAV_ONLY, enabled ? '1':'0'); } catch {} })();
  };

  const ensureAvailable = () => {
    try { w.PlayerUI?.updateAvailableTracksForPlayback?.(); } catch {}
  };

  /**
   * opts:
   * - reason: 'toggle' | 'favoritesChanged' | 'init'
   * - changed: { albumKey, uid, liked }
   */
  function apply(opts = {}) {
    const pc = w.playerCore;
    if (!pc) return;

    const album = playingAlbumKey();
    if (!album) return;

    if (album === w.SPECIAL_FAVORITES_KEY || isSpecial(album)) return void ensureAvailable();

    const favOnlyEnabled = U?.lsGetBool01 ? U.lsGetBool01(LS_FAV_ONLY, false) : (localStorage.getItem(LS_FAV_ONLY) === '1');
    if (!favOnlyEnabled) return void ensureAvailable();

    const likedUids = likedUidsForPlayingAlbum();
    if (!likedUids.length) {
      setFavOnlyModeUI(false);
      w.NotificationSystem?.info?.('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
      return void ensureAvailable();
    }

    const original = originalSnapshot();
    const current = currentSnapshot();

    const curTrack = pc.getCurrentTrack?.();
    const curUid = trim(curTrack?.uid);

    const target = buildFavOnlyFromOriginal(original, likedUids);
    if (!target.length) {
      setFavOnlyModeUI(false);
      w.NotificationSystem?.info?.('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
      return void ensureAvailable();
    }

    const repeat = !!pc.isRepeat?.();

    // Shuffle fast-path for favoritesChanged
    if (!!pc.isShuffle?.() && opts?.reason === 'favoritesChanged') {
      const d = opts?.changed || {};
      const changedAlbum = trim(d.albumKey);
      const changedUid = trim(d.uid);
      const liked = !!d.liked;

      if (changedAlbum === album && changedUid) {
        if (liked) {
          const inCurrent = current.some(t => trim(t?.uid) === changedUid);
          if (!inCurrent) {
            const add = target.find(t => trim(t?.uid) === changedUid) || null;
            if (add) {
              pc.appendToPlaylistTail?.([add]);
              ensureAvailable();
              return;
            }
          }
        } else if (!repeat) {
          if (pc.removeFromPlaylistTailIfNotPlayed?.({ uid: changedUid })) {
            ensureAvailable();
            return;
          }
        }
      }
    }

    // Unlike current handling (6.1), ignore if repeat on (6.3)
    if (!repeat && opts?.reason === 'favoritesChanged' && curUid) {
      const d = opts?.changed || {};
      const changedAlbum = trim(d.albumKey);
      const changedUid = trim(d.uid);
      const liked = !!d.liked;

      if (!liked && changedAlbum === album && changedUid === curUid && !likedUids.includes(changedUid)) {
        const filtered = target.filter(t => trim(t?.uid) !== changedUid);
        if (!filtered.length) {
          setFavOnlyModeUI(false);
          w.NotificationSystem?.info?.('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
          return void ensureAvailable();
        }

        const shuffleOn = !!pc.isShuffle?.();

        pc.setPlaylist(filtered, 0, {}, { preserveOriginalPlaylist: true, preserveShuffleMode: true, resetHistory: false });

        if (shuffleOn) {
          pc.shufflePlaylist?.();
        }

        pc.next();
        ensureAvailable();
        return;
      }
    }

    // Base: rebuild playlist to favorites-only, keep current uid if present
    const startIndex = curUid ? Math.max(0, findIndexByUid(target, curUid)) : 0;

    // ‚úÖ –í–ê–ñ–ù–û: –µ—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–∞ –æ—á–µ—Ä–µ–¥–∏ (favoritesOnly / like/unlike)
    // –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å shuffle-–ø–æ—Ä—è–¥–æ–∫ –∏–º–µ–Ω–Ω–æ –ø–æ –ù–û–í–û–ú–£ –Ω–∞–±–æ—Ä—É target.
    // preserveShuffleMode=true –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ–ª–∞–≥ shuffle –≤–∫–ª—é—á—ë–Ω–Ω—ã–º, –Ω–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫.
    const shuffleOn = !!pc.isShuffle?.();

    pc.setPlaylist(
      target,
      startIndex,
      {},
      {
        preserveOriginalPlaylist: true,
        preserveShuffleMode: true,
        resetHistory: false
      }
    );

    if (shuffleOn) {
      // –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ —Ç–µ–∫—É—â–∏–º
      pc.shufflePlaylist?.();
    }

    ensureAvailable();
  }

  w.PlaybackPolicy = { apply };
})();

//=================================================
// FILE: /scripts/app/player-ui.js
// scripts/app/player-ui.js
// UI –ø–ª–µ–µ—Ä–∞ –Ω–∞ PlayerCore (clean + –±–µ–∑ –¥—É–±–ª–µ–π)
(function () {
  'use strict';

  const w = window, U = w.Utils;
  const $ = (id) => U.dom.byId(id);
  const on = (el, ev, fn, opts) => U.dom.on(el, ev, fn, opts);
  const raf = (fn) => U.dom.raf(fn);

  const STAR_ON = 'img/star.png';
  const STAR_OFF = 'img/star2.png';

  const LS = { FAV_ONLY: 'favoritesOnlyMode', VOL: 'playerVolume', BIT: 'bitEnabled' };

  const st = {
    seeking: false,
    muted: false,

    inMiniMode: false,
    savedLyricsMini: null,

    ensureTimer: null,

    jumpObserver: null,
    lastNativeRow: null,

    bitEnabled: false,
    bitIntensity: 100,
    audioContext: null,
    analyser: null,
    animFrame: null,

    seekAbort: null,
  };

  function initialize() {
    if (w.__playerUIInitialized) return;
    w.__playerUIInitialized = true;

    if (!Array.isArray(w.albumsIndex) || !w.albumsIndex.length) {
      w.__playerUIInitialized = false;
      setTimeout(initialize, 100);
      return;
    }

    restoreSettings();
    attachPlayerCoreEvents();
    attachFavoritesRealtimeSync();
    attachNetworkPQSync();
  }

  function attachPlayerCoreEvents() {
    if (!w.playerCore) return void setTimeout(attachPlayerCoreEvents, 100);

    w.playerCore.on({
      onTrackChange: (track, index) => {
        if (!track) return;

        w.__lastStatsSec = -1;

        // ‚úÖ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏–¥—Ç–∏ –ø–æ uid, –ø–æ—Ç–æ–º—É —á—Ç–æ index –ø—Ä–∏ favoritesOnly
        // –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É playing-–ø–ª–µ–π–ª–∏—Å—Ç—É –∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å DOM data-index.
        try {
          const cur = w.playerCore?.getCurrentTrack?.() || track || null;
          const curUid = String(cur?.uid || '').trim();
          const playingAlbum = w.AlbumsManager?.getPlayingAlbum?.() || null;

          // –î–ª—è favorites –ø–ª–µ–π–ª–∏—Å—Ç–∞ —É—Ç–æ—á–Ω—è–µ–º sourceAlbum, –∏–Ω–∞—á–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫—É.
          if (curUid && playingAlbum === w.SPECIAL_FAVORITES_KEY) {
            const sa = String(cur?.sourceAlbum || '').trim();
            w.AlbumsManager?.highlightCurrentTrack?.(-1, { uid: curUid, albumKey: sa });
          } else if (curUid) {
            w.AlbumsManager?.highlightCurrentTrack?.(-1, { uid: curUid });
          } else {
            // fallback: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ uid –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            w.AlbumsManager?.highlightCurrentTrack?.(index);
          }
        } catch {}

        ensurePlayerBlock(index);
        try { w.LyricsController?.onTrackChange?.(track); } catch {}

        const fulltextBtn = $('lyrics-text-btn');
        if (fulltextBtn) {
          const has = !!track.fulltext;
          U.setAriaDisabled(fulltextBtn, !has);
          fulltextBtn.style.pointerEvents = has ? '' : 'none';
          fulltextBtn.style.opacity = has ? '' : '0.4';
        }

        try { U.download.applyDownloadLink($('track-download-btn'), track); } catch {}
        updatePQButton();

        // ‚úÖ –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ UI –≥–¥–µ-—Ç–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–ª—Å—è/–æ–±–Ω–æ–≤–∏–ª—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É F
        try { setFavoritesOnlyUI(U.lsGetBool01(LS.FAV_ONLY, false)); } catch {}
      },

      onPlay: updatePlayPauseIcon,
      onPause: updatePlayPauseIcon,
      onStop: updatePlayPauseIcon,
      onEnd: updatePlayPauseIcon,

      onTick: (pos, dur) => {
        updateProgress(pos, dur);
        try { w.LyricsController?.onTick?.(pos, { inMiniMode: st.inMiniMode }); } catch {}
      },
    });
  }

  function attachFavoritesRealtimeSync() {
    if (w.__favoritesChangedBound) return;
    w.__favoritesChangedBound = true;

    const pc = w.playerCore;
    if (!pc?.onFavoritesChanged) {
      // –µ—Å–ª–∏ PlayerCore –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ
      w.__favoritesChangedBound = false;
      return void setTimeout(attachFavoritesRealtimeSync, 100);
    }

    pc.onFavoritesChanged((changed) => {
      try {
        updateMiniHeader();
        updateNextUpLabel();
        w.PlaybackPolicy?.apply?.({ reason: 'favoritesChanged', changed: changed || {} });
        updateAvailableTracksForPlayback();

        // ‚úÖ –µ—Å–ª–∏ –ª–∞–π–∫/–∞–Ω–ª–∞–π–∫ –∏–∑–º–µ–Ω–∏–ª –Ω–∞–±–æ—Ä ‚≠ê ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
        try { applyFavoritesOnlyListFilter(); } catch {}
      } catch (err) {
        console.warn('onFavoritesChanged handler failed:', err);
      }
    });
  }

  function attachNetworkPQSync() {
    try {
      if (w.NetworkManager?.subscribe) w.NetworkManager.subscribe(() => { try { updatePQButton(); } catch {} });
      else {
        window.addEventListener('online', () => { try { updatePQButton(); } catch {} });
        window.addEventListener('offline', () => { try { updatePQButton(); } catch {} });
      }
    } catch {}
  }

  // --------------------------
  // Jump-to-playing
  // --------------------------
  function ensureJumpButton() {
    let wrap = document.querySelector('.jump-to-playing');
    if (wrap) return wrap;

    wrap = document.createElement('div');
    wrap.className = 'jump-to-playing';
    wrap.innerHTML = '<button type="button" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ–∫—É—â–µ–º—É —Ç—Ä–µ–∫—É">‚Üë</button>';

    on(wrap, 'click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const block = $('lyricsplayerblock');
      const target = st.lastNativeRow || block;
      if (target) { try { target.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch {} }
    });

    document.body.appendChild(wrap);
    return wrap;
  }

  function setJumpVisible(onOff) {
    ensureJumpButton().style.display = onOff ? 'flex' : 'none';
  }

  function ensureJumpObserver() {
    const playerBlock = $('lyricsplayerblock');

    if (!playerBlock || U.isBrowsingOtherAlbum() || !('IntersectionObserver' in window)) {
      setJumpVisible(false);
      if (st.jumpObserver) { try { st.jumpObserver.disconnect(); } catch {} }
      return;
    }

    if (!st.jumpObserver) {
      st.jumpObserver = new IntersectionObserver((entries) => {
        const entry = entries && entries[0];
        if (!entry) return;
        setJumpVisible(entry.intersectionRatio === 0 && !U.isBrowsingOtherAlbum());
      }, { threshold: [0] });
    }

    try { st.jumpObserver.disconnect(); } catch {}
    st.jumpObserver.observe(playerBlock);
  }

  // --------------------------
  // Player block placement
  // --------------------------
  function ensurePlayerBlock(trackIndex, options = {}) {
    // ‚úÖ –í–ê–ñ–ù–û: –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ —Å–ø–∏—Å–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–∑–±—Ä–∞–Ω–Ω–æ–µ) DOM-—É–∑–µ–ª #lyricsplayerblock
    // –º–æ–∂–µ—Ç –±—ã—Ç—å —É–Ω–∏—á—Ç–æ–∂–µ–Ω. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ index –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, –Ω–æ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –µ—Å—Ç—å.
    // doEnsurePlayerBlock —É–º–µ–µ—Ç —è–∫–æ—Ä–∏—Ç—å—Å—è –ø–æ uid —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞, –ø–æ—ç—Ç–æ–º—É –Ω–µ –≤—ã—Ö–æ–¥–∏–º —Ä–∞–Ω–Ω–∏–º return.
    const safeIndex = (Number.isFinite(trackIndex) && trackIndex >= 0) ? trackIndex : -1;

    if (st.ensureTimer) clearTimeout(st.ensureTimer);
    st.ensureTimer = setTimeout(() => {
      st.ensureTimer = null;
      doEnsurePlayerBlock(safeIndex, options && typeof options === 'object' ? options : {});
    }, 50);
  }

  function doEnsurePlayerBlock(trackIndex, options = {}) {
    let block = $('lyricsplayerblock');
    if (!block) block = createPlayerBlock();

    const inMini = U.isBrowsingOtherAlbum();
    st.inMiniMode = inMini;

    if (inMini) {
      const nowPlaying = $('now-playing');
      if (!nowPlaying) return;

      if (!nowPlaying.contains(block)) {
        nowPlaying.innerHTML = '';
        nowPlaying.appendChild(createMiniHeader());
        nowPlaying.appendChild(block);
        nowPlaying.appendChild(createNextUpElement());
      }

      if (st.savedLyricsMini == null) st.savedLyricsMini = w.LyricsController?.getMiniSaveState?.() || null;
      try { w.LyricsController?.applyMiniMode?.(); } catch {}

      $('mini-now') && ($('mini-now').style.display = 'flex');
      $('next-up') && ($('next-up').style.display = 'flex');
    } else {
      const list = $('track-list');
      if (!list) return;

      // ‚úÖ –í–ê–ñ–ù–û: index –∏–∑ PlayerCore = –∏–Ω–¥–µ–∫—Å –≤ —Ç–µ–∫—É—â–µ–º playing-–ø–ª–µ–π–ª–∏—Å—Ç–µ.
      // –ö–æ–≥–¥–∞ –≤–∫–ª—é—á—ë–Ω FavoritesOnly (F), –ø–ª–µ–π–ª–∏—Å—Ç –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è, –∏ —ç—Ç–æ—Ç index
      // –±–æ–ª—å—à–µ –ù–ï —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å data-index —Å—Ç—Ä–æ–∫–∏ –≤ DOM.
      // –ü–æ—ç—Ç–æ–º—É —è–∫–æ—Ä–∏–º—Å—è –ø–æ uid —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–ª—é—á).
      const cur = w.playerCore?.getCurrentTrack?.() || null;
      const curUid = String(cur?.uid || '').trim();

      let row = null;

      if (curUid) {
        // 1) –û–±—ã—á–Ω—ã–µ –∞–ª—å–±–æ–º—ã: —Å—Ç—Ä–æ–∫–∏ –∏–º–µ—é—Ç data-uid
        row = list.querySelector(`.track[data-uid="${CSS.escape(curUid)}"]`);

        // 2) –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: —Å—Ç—Ä–æ–∫–∏ —Ç–æ–∂–µ –∏–º–µ—é—Ç data-uid, –Ω–æ uid –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è –º–µ–∂–¥—É –∞–ª—å–±–æ–º–∞–º–∏
        // (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏), –ø–æ—ç—Ç–æ–º—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ sourceAlbum.
        if (!row) {
          const sa = String(cur?.sourceAlbum || '').trim();
          if (sa) {
            row = list.querySelector(`.track[data-uid="${CSS.escape(curUid)}"][data-album="${CSS.escape(sa)}"]`);
          }
        }
      }

      // fallback (–µ—Å–ª–∏ uid –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç / —Å—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞): —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ data-index
      if (!row && Number.isFinite(trackIndex) && trackIndex >= 0) {
        row = list.querySelector(`.track[data-index="${trackIndex}"]`);
      }

      st.lastNativeRow = row || null;

      if (!row) {
        if (!block.parentNode) list.appendChild(block);
      } else if (row.nextSibling !== block) {
        row.nextSibling ? row.parentNode.insertBefore(block, row.nextSibling) : row.parentNode.appendChild(block);
      }

      if (row && options.userInitiated) setTimeout(() => { try { row.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch {} }, 50);

      try { w.LyricsController?.restoreFromMiniMode?.(st.savedLyricsMini); } catch {}
      st.savedLyricsMini = null;

      $('mini-now') && ($('mini-now').style.display = 'none');
      $('next-up') && ($('next-up').style.display = 'none');
    }

    // ‚úÖ –í—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º.
    // –í –º–∏–Ω–∏-—Ä–µ–∂–∏–º–µ –±–ª–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–≤—Å—Ç–∞–≤–ª–µ–Ω, –∏ –±–µ–∑ —ç—Ç–æ–≥–æ "–∑–≤–µ–∑–¥–∞" –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è,
    // —Ö–æ—Ç—è —Ä–µ–∂–∏–º —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.
    try { setFavoritesOnlyUI(U.lsGetBool01(LS.FAV_ONLY, false)); } catch {}

    // ‚úÖ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç—Ä–µ–∫–∞/–∞–ª—å–±–æ–º–∞)
    try { applyFavoritesOnlyListFilter(); } catch {}

    updateMiniHeader();
    updateNextUpLabel();
    ensureJumpObserver();
  }

  function createPlayerBlock() {
    const tpl = document.getElementById('player-template');

    const fallback = () => {
      const d = document.createElement('div');
      d.className = 'lyrics-player-block';
      d.id = 'lyricsplayerblock';
      bindPlayerEvents(d);
      return d;
    };

    if (!tpl || !('content' in tpl)) return fallback();

    const node = tpl.content.cloneNode(true);
    const block = node.querySelector('#lyricsplayerblock');
    if (!block) return fallback();

    const ls = w.LyricsController?.getState?.() || { lyricsViewMode: 'normal', animationEnabled: false };

    const setMode = (el, base, mode) => {
      if (!el) return;
      el.classList.remove(`${base}-normal`, `${base}-hidden`, `${base}-expanded`);
      el.classList.add(`${base}-${mode}`);
    };

    setMode(block.querySelector('#lyrics-window'), 'lyrics', ls.lyricsViewMode);
    block.querySelector('.lyrics-animated-bg')?.classList.toggle('active', !!ls.animationEnabled);
    setMode(block.querySelector('#lyrics-toggle-btn'), 'lyrics', ls.lyricsViewMode);

    bindPlayerEvents(block);
    return block;
  }

  function createMiniHeader() {
    const tpl = document.getElementById('mini-header-template');
    const el = (tpl && 'content' in tpl) ? (tpl.content.cloneNode(true).querySelector('#mini-now') || null) : null;

    const header = el || (() => {
      const d = document.createElement('div');
      d.className = 'mini-now';
      d.id = 'mini-now';
      d.innerHTML =
        '<span class="tnum" id="mini-now-num">--.</span>' +
        '<span class="track-title" id="mini-now-title">‚Äî</span>' +
        '<img src="img/star2.png" class="like-star" id="mini-now-star" alt="–∑–≤–µ–∑–¥–∞">';
      return d;
    })();

    on(header, 'click', (e) => {
      if (e.target?.id === 'mini-now-star') return;
      const key = w.AlbumsManager?.getPlayingAlbum?.();
      if (key && key !== w.SPECIAL_RELIZ_KEY) w.AlbumsManager?.loadAlbum?.(key);
    });

    on(header.querySelector('#mini-now-star'), 'click', (e) => {
      e.stopPropagation();
      toggleLikePlaying();
    });

    return header;
  }

  function createNextUpElement() {
    const tpl = document.getElementById('next-up-template');
    return (tpl && 'content' in tpl)
      ? (tpl.content.cloneNode(true).querySelector('#next-up') || document.createElement('div'))
      : (() => {
          const d = document.createElement('div');
          d.className = 'next-up';
          d.id = 'next-up';
          d.innerHTML = '<span class="label">–î–∞–ª–µ–µ:</span><span class="title" title="">‚Äî</span>';
          return d;
        })();
  }

  // --------------------------
  // Mini header / Next up
  // --------------------------
  function updateMiniHeader() {
    const header = $('mini-now');
    if (!header) return;

    if (!U.isBrowsingOtherAlbum()) return void (header.style.display = 'none');

    const track = w.playerCore?.getCurrentTrack?.();
    const index = w.playerCore?.getIndex?.();
    if (!track || !Number.isFinite(index) || index < 0) return void (header.style.display = 'none');

    header.style.display = 'flex';

    header.querySelector('#mini-now-num') && (header.querySelector('#mini-now-num').textContent = `${String(index + 1).padStart(2, '0')}.`);
    header.querySelector('#mini-now-title') && (header.querySelector('#mini-now-title').textContent = track.title || '‚Äî');

    const star = header.querySelector('#mini-now-star');
    if (star) {
      const playingAlbum = w.AlbumsManager?.getPlayingAlbum?.();
      star.src = U.fav.isTrackLikedInContext({ playingAlbum, track }) ? STAR_ON : STAR_OFF;
    }
  }

  function updateNextUpLabel() {
    const nextUp = $('next-up');
    if (!nextUp) return;

    if (!U.isBrowsingOtherAlbum()) return void (nextUp.style.display = 'none');

    const nextIndex = w.playerCore?.getNextIndex?.();
    if (!Number.isFinite(nextIndex) || nextIndex < 0) return void (nextUp.style.display = 'none');

    const snap = w.playerCore?.getPlaylistSnapshot?.() || [];
    const nextTrack = snap[nextIndex];
    if (!nextTrack) return void (nextUp.style.display = 'none');

    nextUp.style.display = 'flex';
    const t = nextUp.querySelector('.title');
    if (t) { t.textContent = nextTrack.title || '‚Äî'; t.title = nextTrack.title || '‚Äî'; }
  }

  function switchAlbumInstantly() {
    const idx = w.playerCore?.getIndex?.();
    if (Number.isFinite(idx) && idx >= 0) ensurePlayerBlock(idx);
    updateMiniHeader();
    updateNextUpLabel();
    w.PlayerState?.save?.();
  }

  // --------------------------
  // Events binding
  // --------------------------
  function bindPlayerEvents(block) {
    if (!block || block.__eventsBound) return;
    block.__eventsBound = true;

    on(block, 'click', (e) => {
      const el = e.target?.closest?.('button, a');
      if (!el || !block.contains(el)) return;

      switch (el.id) {
        case 'play-pause-btn': return void togglePlayPause();
        case 'prev-btn': return void w.playerCore?.prev?.();
        case 'next-btn': return void w.playerCore?.next?.();
        case 'stop-btn': return void w.playerCore?.stop?.();

        case 'repeat-btn': return void toggleRepeat();
        case 'shuffle-btn': return void toggleShuffle();

        case 'pq-btn':
          e.preventDefault(); e.stopPropagation();
          return void togglePQ();

        case 'mute-btn': return void toggleMute();

        case 'lyrics-toggle-btn': return void w.LyricsController?.toggleLyricsView?.();
        case 'animation-btn': return void w.LyricsController?.toggleAnimation?.();

        case 'pulse-btn': return void togglePulse();

        case 'favorites-btn':
          e.preventDefault(); e.stopPropagation();
          return void toggleFavoritesOnly();

        case 'sleep-timer-btn': return void w.SleepTimer?.show?.();
        case 'lyrics-text-btn': return void w.LyricsModal?.show?.();
        case 'stats-btn': return void w.StatisticsModal?.show?.();

        case 'track-download-btn': {
          const track = w.playerCore?.getCurrentTrack?.();
          if (!track?.src) { e.preventDefault(); w.NotificationSystem?.error?.('–¢—Ä–µ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è'); }
          return;
        }
      }
    });

    const volumeSlider = block.querySelector('#volume-slider');
    on(volumeSlider, 'input', onVolumeChange);

    const volumeWrap = block.querySelector('.volume-control-wrapper');
    if (volumeWrap && !volumeWrap.__bound) {
      volumeWrap.__bound = true;

      const setFromX = (clientX) => {
        const slider = block.querySelector('#volume-slider');
        const track = block.querySelector('.volume-track');
        if (!slider || !track) return;

        const rect = track.getBoundingClientRect();
        if (!rect.width) return;

        const p = U.clamp((clientX - rect.left) / rect.width, 0, 1);
        slider.value = String(Math.round(p * 100));
        onVolumeChange({ target: slider });
      };

      on(volumeWrap, 'pointerdown', (e) => { if (typeof e.clientX === 'number') setFromX(e.clientX); });
      on(volumeWrap, 'pointermove', (e) => { if (e?.buttons === 1 && typeof e.clientX === 'number') setFromX(e.clientX); });
    }

    const bar = block.querySelector('#player-progress-bar');
    if (bar && !bar.__seekBound) {
      bar.__seekBound = true;
      on(bar, 'pointerdown', (ev) => {
        try { ev.preventDefault(); } catch {}
        st.seeking = true;
        attachSeekDocListeners();
        handleSeeking(ev);
      });
    }
  }

  function attachSeekDocListeners() {
    if (st.seekAbort) return;
    const ctrl = new AbortController();
    st.seekAbort = ctrl;

    const end = () => { st.seeking = false; detachSeekDocListeners(); };

    const opts = { signal: ctrl.signal, passive: false };
    document.addEventListener('pointermove', handleSeeking, opts);
    document.addEventListener('pointerup', end, opts);
    document.addEventListener('pointercancel', end, opts);
  }

  function detachSeekDocListeners() {
    const ctrl = st.seekAbort;
    if (!ctrl) return;
    try { ctrl.abort(); } catch {}
    st.seekAbort = null;
  }

  // --------------------------
  // Playback controls
  // --------------------------
  function togglePlayPause() {
    const pc = w.playerCore;
    if (!pc) return;
    pc.isPlaying?.() ? pc.pause?.() : pc.play?.();
  }

  function updatePlayPauseIcon() {
    const icon = $('play-pause-icon');
    if (!icon || !w.playerCore) return;
    icon.innerHTML = w.playerCore.isPlaying?.()
      ? '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>'
      : '<path d="M8 5v14l11-7z"/>';
  }

  // --------------------------
  // Seek + Progress
  // --------------------------
  function handleSeeking(e) {
    if (!st.seeking || !w.playerCore) return;

    const bar = $('player-progress-bar');
    if (!bar) return;

    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const rect = bar.getBoundingClientRect();
    const p = rect.width ? U.clamp((clientX - rect.left) / rect.width, 0, 1) : 0;

    const dur = w.playerCore.getDuration?.() || 0;
    w.playerCore.seek?.(dur * p);
  }

  function updateProgress(pos, dur) {
    if (st.seeking) return;

    const fill = $('player-progress-fill');
    const elapsed = $('time-elapsed');
    const remaining = $('time-remaining');

    const duration = (typeof dur === 'number' && dur > 0) ? dur : 0;
    const percent = duration ? (pos / duration) * 100 : 0;

    if (fill) fill.style.width = `${U.clamp(percent, 0, 100)}%`;
    if (elapsed) elapsed.textContent = U.formatTime(pos);
    if (remaining) remaining.textContent = `-${U.formatTime((duration || 0) - (pos || 0))}`;
  }

  // --------------------------
  // Volume
  // --------------------------
  function renderVolumeUI(value) {
    const v = U.clamp(Number(value) || 0, 0, 100);
    const p = v / 100;

    const fill = $('volume-fill');
    const handle = $('volume-handle');
    const track = $('volume-track');

    if (fill) fill.style.width = `${p * 100}%`;

    if (handle && track) {
      const rect = track.getBoundingClientRect();
      const half = 7;
      const x = U.clamp(rect.width * p, half, Math.max(half, rect.width - half));
      handle.style.left = `${x}px`;
    }
  }

  function onVolumeChange(e) {
    const v = U.clamp(U.toInt(e?.target?.value, 0), 0, 100);
    w.playerCore?.setVolume?.(v);
    raf(() => renderVolumeUI(v));
    U.lsSet(LS.VOL, v);
  }

  // --------------------------
  // PQ (Hi/Lo)
  // --------------------------
  function updatePQButton() {
    const btn = $('pq-btn');
    const label = $('pq-btn-label');
    if (!btn || !label) return;

    const stt = U.pq.getState();
    const mode = stt.mode;

    btn.classList.toggle('pq-hi', mode === 'hi');
    btn.classList.toggle('pq-lo', mode === 'lo');
    U.setAriaDisabled(btn, !stt.canToggle);

    btn.style.pointerEvents = ''; // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ—Å—Ç—ã –ø–æ –∫–ª–∏–∫—É
    label.textContent = mode === 'lo' ? 'Lo' : 'Hi';
  }

  function togglePQ() {
    if (!w.playerCore) return;
    const r = U.pq.toggle();

    if (!r.ok) {
      if (r.reason === 'offline') w.NotificationSystem?.warning?.('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ç–∏');
      else if (r.reason === 'trackNoLo') w.NotificationSystem?.info?.('–î–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞ Lo –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
      updatePQButton();
      return;
    }
    updatePQButton();
  }

  // --------------------------
  // Repeat / Shuffle / Mute
  // --------------------------
  function toggleMute() {
    if (!w.playerCore) return;
    st.muted = !st.muted;
    w.playerCore.setMuted?.(st.muted);
    U.setBtnActive('mute-btn', st.muted);
  }

  function toggleRepeat() {
    if (!w.playerCore) return;
    w.playerCore.toggleRepeat?.();
    U.setBtnActive('repeat-btn', !!w.playerCore.isRepeat?.());
  }

  function toggleShuffle() {
    if (!w.playerCore) return;
    w.playerCore.toggleShuffle?.();
    U.setBtnActive('shuffle-btn', !!w.playerCore.isShuffle?.());
    w.PlaybackPolicy?.apply?.({ reason: 'toggle' });
    updateAvailableTracksForPlayback();
  }

  // --------------------------
  // Pulse (bit)
  // --------------------------
  function togglePulse() {
    st.bitEnabled = !st.bitEnabled;
    U.lsSetBool01(LS.BIT, st.bitEnabled);

    $('pulse-btn')?.classList.toggle('active', st.bitEnabled);
    const heart = $('pulse-heart');
    if (heart) heart.textContent = st.bitEnabled ? '‚ù§Ô∏è' : 'ü§ç';

    st.bitEnabled ? startBitEffect() : stopBitEffect();
  }

  function startBitEffect() {
    try { w.playerCore?.rebuildCurrentSound?.({ preferWebAudio: true }); } catch {}

    try {
      if (w.Howler?.ctx && w.Howler?.masterGain) {
        st.audioContext = st.audioContext || w.Howler.ctx;
        if (st.audioContext.state === 'suspended') { try { st.audioContext.resume(); } catch {} }

        if (!st.analyser) {
          const a = st.audioContext.createAnalyser();
          a.fftSize = 256;
          a.smoothingTimeConstant = 0.85;
          try { w.Howler.masterGain.connect(a); st.analyser = a; } catch { st.analyser = null; }
        }
      }
    } catch { st.analyser = null; }

    if (!st.analyser) {
      st.bitEnabled = false;
      U.lsSetBool01(LS.BIT, false);
      $('pulse-btn')?.classList.remove('active');
      const heart = $('pulse-heart');
      if (heart) heart.textContent = 'ü§ç';
      w.NotificationSystem?.warning?.('–ü—É–ª—å—Å–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: –±—Ä–∞—É–∑–µ—Ä/—Ä–µ–∂–∏–º –Ω–µ –¥–∞—ë—Ç Web Audio –∞–Ω–∞–ª–∏–∑');
      return;
    }

    animateBit();
  }

  function animateBit() {
    if (!st.bitEnabled) return;

    let intensity = 0;
    if (st.analyser && st.audioContext?.state === 'running') {
      try {
        const data = new Uint8Array(st.analyser.frequencyBinCount);
        st.analyser.getByteFrequencyData(data);

        const bassRange = Math.max(1, Math.floor(data.length * 0.3));
        let sum = 0;
        for (let i = 0; i < bassRange; i++) sum += data[i];
        intensity = ((sum / bassRange) / 255) * (st.bitIntensity / 100);
      } catch {}
    }

    const logo = $('logo-bottom');
    if (logo) logo.style.transform = `scale(${1 + intensity * 0.2})`;

    st.animFrame = requestAnimationFrame(animateBit);
  }

  function stopBitEffect() {
    if (st.animFrame) { cancelAnimationFrame(st.animFrame); st.animFrame = null; }

    const logo = $('logo-bottom');
    if (logo) {
      logo.style.transition = 'transform 0.3s ease-out';
      logo.style.transform = 'scale(1)';
      setTimeout(() => { if (logo) logo.style.transition = ''; }, 300);
    }
    st.analyser = null;
  }

  // --------------------------
  // Favorites-only
  // --------------------------
  function setFavoritesOnlyUI(onOff) {
    const btn = $('favorites-btn');
    const icon = $('favorites-btn-icon');
    if (!btn || !icon) return;
    btn.classList.toggle('favorites-active', !!onOff);
    icon.src = onOff ? STAR_ON : STAR_OFF;
  }

  function toggleFavoritesOnly() {
    const playingAlbum = w.AlbumsManager?.getPlayingAlbum?.() || null;
    const nextOn = !U.lsGetBool01(LS.FAV_ONLY, false);

    if (nextOn) {
      if (playingAlbum === w.SPECIAL_FAVORITES_KEY) {
        const model = Array.isArray(w.favoritesRefsModel) ? w.favoritesRefsModel : [];
        if (!model.some(it => it && it.__active && it.audio)) {
          w.NotificationSystem?.info?.('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
          U.lsSetBool01(LS.FAV_ONLY, false);
          setFavoritesOnlyUI(false);
          return;
        }
      } else if (playingAlbum && !U.isSpecialAlbumKey(playingAlbum)) {
        const liked = w.playerCore?.getLikedUidsForAlbum?.(playingAlbum) || [];
        if (!Array.isArray(liked) || !liked.length) {
          w.NotificationSystem?.info?.('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
          U.lsSetBool01(LS.FAV_ONLY, false);
          setFavoritesOnlyUI(false);
          return;
        }
      } else {
        w.NotificationSystem?.info?.('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
        U.lsSetBool01(LS.FAV_ONLY, false);
        setFavoritesOnlyUI(false);
        return;
      }
    }

    U.lsSetBool01(LS.FAV_ONLY, nextOn);
    setFavoritesOnlyUI(nextOn);

    nextOn ? w.NotificationSystem?.success?.('‚≠ê –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏') : w.NotificationSystem?.info?.('–ò–≥—Ä–∞—é—Ç –≤—Å–µ —Ç—Ä–µ–∫–∏');

    updateAvailableTracksForPlayback();
    w.PlaybackPolicy?.apply?.({ reason: 'toggle' });

    // ‚úÖ UI-only —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
    try { applyFavoritesOnlyListFilter(); } catch {}
  }

  function toggleLikePlaying() {
    const pc = w.playerCore;
    const track = pc?.getCurrentTrack?.();
    const uid = String(track?.uid || '').trim();
    if (!uid) return;

    // mini ‚Äî —ç—Ç–æ –ù–ï favorites view, –∑–Ω–∞—á–∏—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ "–∫–∞–∫ –∏–∑ —Ä–æ–¥–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞"
    // –í–ê–ñ–ù–û: –ø–µ—Ä–µ–¥–∞—ë–º albumKey, –∏–Ω–∞—á–µ PlayerCore –º–æ–∂–µ—Ç –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å likedTrackUids:v1 –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
    const sourceAlbum = String(track?.sourceAlbum || '').trim();
    const playingAlbum = String(w.AlbumsManager?.getPlayingAlbum?.() || '').trim();

    const albumKey =
      sourceAlbum ||
      (!U.isSpecialAlbumKey(playingAlbum) ? playingAlbum : '');

    pc?.toggleFavorite?.(uid, { fromAlbum: true, albumKey: albumKey || null });
    updateMiniHeader();
  }

  // --------------------------
  // Legacy availableFavoriteIndices
  // --------------------------
  function updateAvailableTracksForPlayback() {
    const playingAlbum = w.AlbumsManager?.getPlayingAlbum?.();
    const snap = w.playerCore?.getPlaylistSnapshot?.() || [];
    if (!playingAlbum || !snap.length) return;

    if (playingAlbum === w.SPECIAL_FAVORITES_KEY) return void (w.availableFavoriteIndices = null);

    if (!U.lsGetBool01(LS.FAV_ONLY, false)) return void (w.availableFavoriteIndices = null);

    const likedUids = w.playerCore?.getLikedUidsForAlbum?.(playingAlbum) || [];
    if (!likedUids.length) return void (w.availableFavoriteIndices = null);

    const set = new Set(likedUids.map(x => String(x || '').trim()).filter(Boolean));
    w.availableFavoriteIndices = [];
    snap.forEach((t, idx) => {
      const uid = String(t?.uid || '').trim();
      if (uid && set.has(uid)) w.availableFavoriteIndices.push(idx);
    });
  }

  // --------------------------
  // Favorites-only: UI list filter (visual)
  // --------------------------
  function applyFavoritesOnlyListFilter() {
    const list = $('track-list');
    if (!list) return;

    const enabled = U.lsGetBool01(LS.FAV_ONLY, false);
    const currentAlbum = w.AlbumsManager?.getCurrentAlbum?.() || null;
    const playingAlbum = w.AlbumsManager?.getPlayingAlbum?.() || null;

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –º—ã —Å–º–æ—Ç—Ä–∏–º –¢–û–¢ –ñ–ï –æ–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∏–≥—Ä–∞–µ—Ç.
    // –í "–ò–∑–±—Ä–∞–Ω–Ω–æ–º" –∏ –≤ special-–∞–ª—å–±–æ–º–∞—Ö –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º (—Ç–∞–º —Å–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ active/inactive).
    const isRegular =
      currentAlbum &&
      playingAlbum &&
      currentAlbum === playingAlbum &&
      !U.isSpecialAlbumKey(currentAlbum);

    list.classList.toggle('favonly-filtered', !!(enabled && isRegular));

    if (!(enabled && isRegular)) return;

    const liked = w.playerCore?.getLikedUidsForAlbum?.(currentAlbum) || [];
    const set = new Set((Array.isArray(liked) ? liked : []).map(x => String(x || '').trim()).filter(Boolean));

    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ ‚≠ê, –Ω–æ:
    // - —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ uid –Ω–µ —Ç—Ä–æ–≥–∞–µ–º (–ø—É—Å–∫–∞–π –æ—Å—Ç–∞—é—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏, —á—Ç–æ–±—ã –Ω–µ ‚Äú—Å–ª–æ–º–∞—Ç—å‚Äù —Å–ø–∏—Å–æ–∫)
    // - —Ç–µ–∫—É—â–∏–π playing —Ç—Ä–µ–∫ –Ω–µ –ø—Ä–∏–Ω—É–∂–¥–∞–µ–º (–æ–Ω –∏ —Ç–∞–∫ –ª–∞–π–∫–Ω—É—Ç –ø—Ä–∏ favoritesOnly)
    const rows = list.querySelectorAll('.track');
    rows.forEach((row) => {
      const uid = String(row?.dataset?.uid || '').trim();
      if (!uid) {
        row.removeAttribute('data-hidden-by-favonly');
        return;
      }

      const shouldShow = set.has(uid);
      if (shouldShow) row.removeAttribute('data-hidden-by-favonly');
      else row.setAttribute('data-hidden-by-favonly', '1');
    });
  }

  // --------------------------
  // Restore settings
  // --------------------------
  function restoreSettings() {
    setFavoritesOnlyUI(U.lsGetBool01(LS.FAV_ONLY, false));

    let volume = 50;
    const saved = U.lsGet(LS.VOL, null);
    if (saved !== null) volume = U.toInt(saved, 50);
    else U.lsSet(LS.VOL, volume);

    w.playerCore?.setVolume?.(volume);
    $('volume-slider') && ($('volume-slider').value = String(volume));
    renderVolumeUI(volume);

    try { w.LyricsController?.restoreSettingsIntoDom?.(); } catch {}

    st.bitEnabled = U.lsGetBool01(LS.BIT, false);
    $('pulse-heart') && ($('pulse-heart').textContent = st.bitEnabled ? '‚ù§Ô∏è' : 'ü§ç');
    if (st.bitEnabled) setTimeout(startBitEffect, 1000);

    if (U.lsGetBool01(LS.FAV_ONLY, false) && U.waitFor) {
      U.waitFor(() => !!w.playerCore, 2000, 50).then(() => { try { w.PlaybackPolicy?.apply?.({ reason: 'init' }); } catch {} });
    }

    try { updatePQButton(); } catch {}
  }

  // --------------------------
  // Public API
  // --------------------------
  w.PlayerUI = {
    initialize,
    ensurePlayerBlock,
    updateMiniHeader,
    updateNextUpLabel,
    togglePlayPause,
    toggleLikePlaying,
    switchAlbumInstantly,
    toggleFavoritesOnly,
    updateAvailableTracksForPlayback,

    get currentLyrics() { return w.LyricsController?.getCurrentLyrics?.() || []; },
    get currentLyricsLines() { return w.LyricsController?.getCurrentLyricsLines?.() || []; },
  };

  w.toggleFavoritesOnly = toggleFavoritesOnly;

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initialize);
  else initialize();
})();

//=================================================
// FILE: /scripts/app/player-ui/lyrics.js
// scripts/app/player-ui/lyrics.js
// LyricsController ‚Äî –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å –ª–∏—Ä–∏–∫–∏ –¥–ª—è PlayerUI.
// –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã: –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (no stop/play/seek), —Ç–æ–ª—å–∫–æ UI –∏ fetch/cache.

(function LyricsControllerModule() {
  'use strict';

  const w = window;

  const LYRICS_404_CACHE_KEY = 'lyrics_404_cache:v1';
  const LYRICS_MIN_INTERVAL = 250;

  let currentLyrics = [];
  let hasTimedLyricsForCurrentTrack = false;

  let lyricsViewMode = 'normal'; // 'normal' | 'hidden' | 'expanded'
  let animationEnabled = false;

  let lyricsLastIdx = -1;
  let lyricsLastTs = 0;

  let prefetchedLyrics = null;
  let prefetchedLyricsUrl = null;

  const esc = (s) => (w.Utils?.escapeHtml ? w.Utils.escapeHtml(String(s || '')) : String(s || ''));

  function readLyricsViewMode() {
    const saved = localStorage.getItem('lyricsViewMode');
    return (saved === 'normal' || saved === 'hidden' || saved === 'expanded') ? saved : 'normal';
  }

  function readAnimationEnabled() {
    return localStorage.getItem('lyricsAnimationEnabled') === '1';
  }

  function writeLyricsViewMode(mode) {
    const m = (mode === 'hidden' || mode === 'expanded') ? mode : 'normal';
    try { localStorage.setItem('lyricsViewMode', m); } catch {}
    return m;
  }

  function writeAnimationEnabled(on) {
    try { localStorage.setItem('lyricsAnimationEnabled', on ? '1' : '0'); } catch {}
    return !!on;
  }

  function getLyrics404Cache() {
    try {
      const raw = sessionStorage.getItem(LYRICS_404_CACHE_KEY);
      const j = raw ? JSON.parse(raw) : {};
      return j && typeof j === 'object' ? j : {};
    } catch {
      return {};
    }
  }

  function setLyrics404Cache(url) {
    try {
      const cache = getLyrics404Cache();
      cache[url] = Date.now();

      const keys = Object.keys(cache);
      if (keys.length > 100) {
        keys.sort((a, b) => cache[a] - cache[b]).slice(0, 50).forEach((k) => { delete cache[k]; });
      }

      sessionStorage.setItem(LYRICS_404_CACHE_KEY, JSON.stringify(cache));
    } catch {}
  }

  function isLyrics404Cached(url) {
    return !!getLyrics404Cache()[String(url || '').trim()];
  }

  function isLyricsKnownMissingFast(lyricsUrl) {
    const url = String(lyricsUrl || '').trim();
    if (!url) return true;
    if (isLyrics404Cached(url)) return true;

    try {
      const cacheKey = `lyrics_cache_${url}`;
      const cached = sessionStorage.getItem(cacheKey);
      if (!cached) return false;
      const parsed = JSON.parse(cached);
      return (parsed === null || parsed === '__NO_LYRICS__');
    } catch {
      return false;
    }
  }

  function checkTrackHasLyrics(track) {
    if (!track) return false;
    if (track.hasLyrics === false) return false;
    if (track.hasLyrics === true) return true;
    return !!track.lyrics;
  }

  function detectLyricsFormat(url, content) {
    const u = String(url || '').toLowerCase();
    if (u.endsWith('.lrc')) return 'lrc';
    if (u.endsWith('.json')) return 'json';
    if (u.endsWith('.txt')) return 'lrc';

    const trimmed = String(content || '').trim();
    if (!trimmed) return 'unknown';

    if (trimmed[0] === '[' || trimmed[0] === '{') {
      try { JSON.parse(trimmed); return 'json'; } catch {}
    }

    // –µ—Å—Ç—å —Ç–∞–π–º–∫–æ–¥—ã [mm:ss] –∏–ª–∏ [mm:ss.xx]
    if (/$$\d{1,2}:\d{2}(?:[.:]\d{1,3})?$$/.test(trimmed)) return 'lrc';

    return 'unknown';
  }

  function parseLyricsInto(source, out) {
    out.length = 0;

    if (Array.isArray(source)) {
      for (const item of source) {
        if (!item) continue;
        const time = Number(item.time);
        if (!Number.isFinite(time)) continue;
        const text = String(item.line || item.text || '').trim();
        if (!text) continue;
        out.push({ time, text });
      }
      out.sort((a, b) => a.time - b.time);
      return;
    }

    const text = String(source || '');
    const lines = text.split('\n');

    for (const line of lines) {
      const s = line.trim();
      if (!s) continue;

      // –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ [ar:], [ti:], etc.
      if (/^$$[a-z]{2,8}:(.*)$$\s*$/i.test(s)) continue;

      // [mm:ss.xx]text OR [mm:ss]text
      const m = s.match(/^$$(\d{1,2}):(\d{2})(?:[.:](\d{1,3}))?$$(.*)$/);
      if (!m) continue;

      const mm = parseInt(m[1], 10);
      const ss = parseInt(m[2], 10);
      const fracRaw = m[3];
      const tail = String(m[4] || '').trim();

      if (!Number.isFinite(mm) || !Number.isFinite(ss) || !tail) continue;

      let t = mm * 60 + ss;
      if (fracRaw) {
        const fracNum = parseInt(fracRaw, 10);
        if (Number.isFinite(fracNum)) t += (fracRaw.length === 3) ? (fracNum / 1000) : (fracNum / 100);
      }

      out.push({ time: t, text: tail });
    }

    out.sort((a, b) => a.time - b.time);
  }

  function parseLyrics(source) {
    const out = [];
    parseLyricsInto(source, out);
    currentLyrics = out;
  }

  function setLyricsAvailability(enabled) {
    const playerBlock = document.getElementById('lyricsplayerblock');
    if (!playerBlock) return;

    const lyricsWindow = playerBlock.querySelector('#lyrics-window');
    const lyricsBtn = playerBlock.querySelector('#lyrics-toggle-btn');
    const animBtn = playerBlock.querySelector('#animation-btn');
    const karaokeBtn = playerBlock.querySelector('#lyrics-text-btn');
    const bg = playerBlock.querySelector('.lyrics-animated-bg');
    const container = document.getElementById('lyrics');

    if (lyricsWindow) lyricsWindow.style.display = enabled ? '' : 'none';

    const setDisabled = (el, disabled) => {
      if (!el) return;
      el.classList.toggle('disabled', !!disabled);
      el.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      el.setAttribute('tabindex', disabled ? '-1' : '0');
      el.style.pointerEvents = disabled ? 'none' : '';
    };

    setDisabled(lyricsBtn, !enabled);
    setDisabled(animBtn, !enabled);

    if (karaokeBtn) {
      const track = w.playerCore?.getCurrentTrack?.();
      const hasFulltext = !!track?.fulltext;
      const hasTimed = enabled && hasTimedLyricsForCurrentTrack && currentLyrics.length > 0;
      const karaokeEnabled = hasFulltext || hasTimed;

      karaokeBtn.classList.toggle('disabled', !karaokeEnabled);
      karaokeBtn.style.pointerEvents = karaokeEnabled ? '' : 'none';
      karaokeBtn.style.opacity = karaokeEnabled ? '' : '0.4';
    }

    if (!enabled) {
      animationEnabled = false;
      if (bg) bg.classList.remove('active');
      if (animBtn) animBtn.classList.remove('active');

      lyricsViewMode = 'hidden';
      if (container) container.innerHTML = '';
    } else {
      lyricsViewMode = readLyricsViewMode();
      animationEnabled = readAnimationEnabled();

      if (animBtn) animBtn.classList.toggle('active', animationEnabled);
      if (bg) bg.classList.toggle('active', animationEnabled && lyricsViewMode !== 'hidden');
    }

    renderLyricsViewMode();
  }

  function renderLyricsViewMode() {
    const playerBlock = document.getElementById('lyricsplayerblock');
    if (!playerBlock) return;

    const lyricsWindow = playerBlock.querySelector('#lyrics-window');
    const btn = playerBlock.querySelector('#lyrics-toggle-btn');
    if (!lyricsWindow || !btn) return;

    lyricsWindow.classList.remove('lyrics-normal', 'lyrics-hidden', 'lyrics-expanded');
    btn.classList.remove('lyrics-normal', 'lyrics-hidden', 'lyrics-expanded');

    const cls = `lyrics-${lyricsViewMode}`;
    lyricsWindow.classList.add(cls);
    btn.classList.add(cls);

    const bg = playerBlock.querySelector('.lyrics-animated-bg');
    const animBtn = playerBlock.querySelector('#animation-btn');

    if (lyricsViewMode === 'hidden') {
      bg?.classList.remove('active');
      animBtn?.classList.remove('active');
    } else if (animationEnabled) {
      bg?.classList.add('active');
      animBtn?.classList.add('active');
    }
  }

  function renderLyrics(position) {
    const container = document.getElementById('lyrics');
    if (!container) return;

    if (!Array.isArray(currentLyrics) || currentLyrics.length === 0) {
      container.innerHTML = '<div class="lyrics-placeholder">–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
      return;
    }

    const firstLineTime = currentLyrics[0]?.time || 0;
    const COUNTDOWN_THRESHOLD = 5;

    const windowSize = (lyricsViewMode === 'expanded') ? 9 : 5;
    const centerLine = Math.floor(windowSize / 2);

    if (position < firstLineTime && firstLineTime > COUNTDOWN_THRESHOLD) {
      const remaining = firstLineTime - position;
      const secondsLeft = Math.ceil(remaining);
      if (remaining < 1) {
        container.innerHTML =
          `<div class="lyrics-countdown fade-out" style="opacity:${remaining.toFixed(2)};">${secondsLeft}</div>`;
        return;
      }
      container.innerHTML = `<div class="lyrics-countdown">${secondsLeft}</div>`;
      return;
    }

    let activeIdx = -1;
    for (let i = 0; i < currentLyrics.length; i++) {
      if (position >= currentLyrics[i].time) activeIdx = i;
      else break;
    }

    const start = Math.max(0, activeIdx - centerLine);
    const padTop = Math.max(0, centerLine - activeIdx);

    const rows = [];
    for (let p = 0; p < padTop; p++) rows.push('<div class="lyrics-window-line"></div>');

    for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
      const cls = (i === activeIdx) ? 'lyrics-window-line active' : 'lyrics-window-line';
      rows.push(`<div class="${cls}">${esc(currentLyrics[i]?.text || '')}</div>`);
    }

    while (rows.length < windowSize) rows.push('<div class="lyrics-window-line"></div>');
    container.innerHTML = rows.join('');
  }

  function renderLyricsEnhanced(position, opts = {}) {
    if (lyricsViewMode === 'hidden') return;
    if (opts && opts.inMiniMode) return;
    if (!Array.isArray(currentLyrics) || currentLyrics.length === 0) return;

    let activeIdx = -1;
    for (let i = 0; i < currentLyrics.length; i++) {
      if (position >= currentLyrics[i].time) activeIdx = i;
      else break;
    }

    const now = Date.now();
    if (activeIdx === lyricsLastIdx && (now - lyricsLastTs) < LYRICS_MIN_INTERVAL) return;

    lyricsLastIdx = activeIdx;
    lyricsLastTs = now;

    renderLyrics(position);
  }

  async function prefetchNextTrackLyrics() {
    prefetchedLyrics = null;
    prefetchedLyricsUrl = null;

    const pc = w.playerCore;
    if (!pc) return;

    const nextIndex = pc.getNextIndex?.();
    if (!Number.isFinite(nextIndex) || nextIndex < 0) return;

    const playlist = pc.getPlaylistSnapshot?.() || [];
    const nextTrack = playlist[nextIndex];
    if (!nextTrack?.lyrics) return;

    const lyricsUrl = String(nextTrack.lyrics || '').trim();
    if (!lyricsUrl || isLyrics404Cached(lyricsUrl)) return;

    const cacheKey = `lyrics_cache_${lyricsUrl}`;
    const cached = sessionStorage.getItem(cacheKey);

    if (cached) {
      try {
        const parsed = JSON.parse(cached);
        if (parsed && parsed !== '__NO_LYRICS__') {
          const temp = [];
          parseLyricsInto(parsed, temp);
          if (temp.length > 0) {
            prefetchedLyrics = temp;
            prefetchedLyricsUrl = lyricsUrl;
          }
        }
      } catch {}
      return;
    }

    try {
      const response = await fetch(lyricsUrl, { cache: 'force-cache', headers: { Accept: 'application/json, text/plain, */*' } });
      if (!response.ok) {
        if (response.status === 404) setLyrics404Cache(lyricsUrl);
        return;
      }

      const bodyText = await response.text();
      const format = detectLyricsFormat(lyricsUrl, bodyText);

      let dataToCache = bodyText;
      const tempLyrics = [];

      if (format === 'json') {
        try {
          const asJson = JSON.parse(bodyText);
          if (Array.isArray(asJson)) {
            dataToCache = asJson;
            parseLyricsInto(asJson, tempLyrics);
          }
        } catch {}
      } else {
        parseLyricsInto(bodyText, tempLyrics);
      }

      try { sessionStorage.setItem(cacheKey, JSON.stringify(dataToCache)); } catch {}

      if (tempLyrics.length > 0) {
        prefetchedLyrics = tempLyrics;
        prefetchedLyricsUrl = lyricsUrl;
      }
    } catch {}
  }

  async function loadLyrics(lyricsUrl) {
    currentLyrics = [];
    lyricsLastIdx = -1;
    hasTimedLyricsForCurrentTrack = false;

    const container = document.getElementById('lyrics');
    if (!container) return;

    const url = String(lyricsUrl || '').trim();
    if (!url) return void setLyricsAvailability(false);

    if (isLyrics404Cached(url)) return void setLyricsAvailability(false);

    // prefetched
    if (prefetchedLyricsUrl === url && prefetchedLyrics) {
      currentLyrics = prefetchedLyrics;
      prefetchedLyrics = null;
      prefetchedLyricsUrl = null;

      hasTimedLyricsForCurrentTrack = currentLyrics.length > 0;
      setLyricsAvailability(hasTimedLyricsForCurrentTrack);
      renderLyricsViewMode();

      prefetchNextTrackLyrics();
      return;
    }

    // session cache
    const cacheKey = `lyrics_cache_${url}`;
    const cached = sessionStorage.getItem(cacheKey);

    if (cached) {
      try {
        const parsed = JSON.parse(cached);
        if (parsed === null || parsed === '__NO_LYRICS__') {
          setLyricsAvailability(false);
          prefetchNextTrackLyrics();
          return;
        }

        parseLyrics(parsed);

        if (!currentLyrics.length) {
          setLyricsAvailability(false);
          prefetchNextTrackLyrics();
          return;
        }

        hasTimedLyricsForCurrentTrack = true;
        setLyricsAvailability(true);
        renderLyricsViewMode();
        prefetchNextTrackLyrics();
        return;
      } catch {
        try { sessionStorage.removeItem(cacheKey); } catch {}
      }
    }

    container.innerHTML = '<div class="lyrics-spinner"></div>';

    try {
      const response = await fetch(url, { cache: 'force-cache', headers: { Accept: 'application/json, text/plain, */*' } });

      if (!response.ok) {
        if (response.status === 404) setLyrics404Cache(url);
        setLyricsAvailability(false);
        prefetchNextTrackLyrics();
        return;
      }

      const contentType = response.headers.get('content-type') || '';
      const bodyText = await response.text();
      const format = detectLyricsFormat(url, bodyText);

      if (format === 'json' || contentType.includes('application/json')) {
        try {
          const asJson = JSON.parse(bodyText);
          if (!Array.isArray(asJson)) {
            try { sessionStorage.setItem(cacheKey, JSON.stringify('__NO_LYRICS__')); } catch {}
            setLyricsAvailability(false);
            prefetchNextTrackLyrics();
            return;
          }
          try { sessionStorage.setItem(cacheKey, JSON.stringify(asJson)); } catch {}
          parseLyrics(asJson);
        } catch {
          try { sessionStorage.setItem(cacheKey, JSON.stringify('__NO_LYRICS__')); } catch {}
          setLyricsAvailability(false);
          prefetchNextTrackLyrics();
          return;
        }
      } else {
        try { sessionStorage.setItem(cacheKey, JSON.stringify(bodyText)); } catch {}
        parseLyrics(bodyText);
      }

      if (!currentLyrics.length) {
        setLyricsAvailability(false);
        prefetchNextTrackLyrics();
        return;
      }

      hasTimedLyricsForCurrentTrack = true;
      setLyricsAvailability(true);
      renderLyricsViewMode();
      prefetchNextTrackLyrics();
    } catch {
      setLyricsAvailability(false);
      prefetchNextTrackLyrics();
    }
  }

  function onTrackChange(track) {
    try {
      const has = checkTrackHasLyrics(track);
      const knownMissing = (!track?.lyrics) ? true : isLyricsKnownMissingFast(track.lyrics);
      if (!has || knownMissing) {
        hasTimedLyricsForCurrentTrack = false;
        setLyricsAvailability(false);
        return;
      }
    } catch {}

    loadLyrics(track?.lyrics).then(() => {
      if (hasTimedLyricsForCurrentTrack && lyricsViewMode !== 'hidden') renderLyrics(0);
    });
  }

  function toggleLyricsView() {
    const modes = ['normal', 'hidden', 'expanded'];
    const i = modes.indexOf(lyricsViewMode);
    lyricsViewMode = writeLyricsViewMode(modes[(i === -1 ? 0 : (i + 1) % modes.length)]);
    renderLyricsViewMode();

    const msgMap = { normal: 'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏', hidden: 'üö´ –õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞', expanded: 'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏' };
    w.NotificationSystem?.info?.(msgMap[lyricsViewMode] || '');
  }

  function toggleAnimation() {
    if (lyricsViewMode === 'hidden') return void w.NotificationSystem?.info?.('–õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');

    animationEnabled = writeAnimationEnabled(!animationEnabled);

    const playerBlock = document.getElementById('lyricsplayerblock');
    const bg = playerBlock?.querySelector?.('.lyrics-animated-bg');
    const btn = document.getElementById('animation-btn');

    if (bg) bg.classList.toggle('active', animationEnabled);
    if (btn) btn.classList.toggle('active', animationEnabled);

    w.NotificationSystem?.info?.(animationEnabled ? '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏: –í–ö–õ' : '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏: –í–´–ö–õ');
  }

  function applyMiniMode() {
    const playerBlock = document.getElementById('lyricsplayerblock');
    if (!playerBlock) return;

    const lyricsWindow = playerBlock.querySelector('#lyrics-window');
    if (lyricsWindow) {
      lyricsWindow.style.transition = 'none';
      lyricsWindow.style.display = 'none';
      setTimeout(() => { if (lyricsWindow) lyricsWindow.style.transition = ''; }, 50);
    }

    playerBlock.querySelector('.lyrics-toggle-btn')?.style && (playerBlock.querySelector('.lyrics-toggle-btn').style.display = 'none');

    animationEnabled = false;
    playerBlock.querySelector('.lyrics-animated-bg')?.classList.remove('active');
    document.getElementById('animation-btn')?.classList.remove('active');
  }

  function restoreFromMiniMode(saved) {
    const playerBlock = document.getElementById('lyricsplayerblock');
    if (!playerBlock) return;

    const lyricsWindow = playerBlock.querySelector('#lyrics-window');
    if (lyricsWindow) {
      lyricsWindow.style.transition = 'none';
      lyricsWindow.style.display = '';
      setTimeout(() => { if (lyricsWindow) lyricsWindow.style.transition = ''; }, 50);
    }

    const toggleBtn = playerBlock.querySelector('.lyrics-toggle-btn');
    if (toggleBtn) toggleBtn.style.display = '';

    if (!hasTimedLyricsForCurrentTrack) {
      lyricsViewMode = writeLyricsViewMode('hidden');
      animationEnabled = writeAnimationEnabled(false);
      setLyricsAvailability(false);
      return;
    }

    if (saved && (saved.viewMode === 'normal' || saved.viewMode === 'hidden' || saved.viewMode === 'expanded')) {
      lyricsViewMode = writeLyricsViewMode(saved.viewMode);
    } else {
      lyricsViewMode = readLyricsViewMode();
    }

    if (saved && typeof saved.animationEnabled === 'boolean') {
      animationEnabled = writeAnimationEnabled(saved.animationEnabled);
    } else {
      animationEnabled = readAnimationEnabled();
    }

    renderLyricsViewMode();
  }

  function restoreSettingsIntoDom() {
    lyricsViewMode = readLyricsViewMode();
    animationEnabled = readAnimationEnabled();
    renderLyricsViewMode();
  }

  function getState() {
    return { lyricsViewMode, animationEnabled, hasTimedLyricsForCurrentTrack };
  }

  function getMiniSaveState() {
    return { viewMode: (lyricsViewMode !== 'hidden') ? lyricsViewMode : 'normal', animationEnabled: !!animationEnabled };
  }

  w.LyricsController = {
    getState,
    getCurrentLyrics() { return currentLyrics; },
    getCurrentLyricsLines() { return Array.isArray(currentLyrics) ? currentLyrics.map(l => ({ line: l.text })) : []; },

    restoreSettingsIntoDom,
    onTrackChange,
    onTick: renderLyricsEnhanced,

    toggleLyricsView,
    toggleAnimation,

    getMiniSaveState,
    applyMiniMode,
    restoreFromMiniMode,

    checkTrackHasLyrics,
    isLyricsKnownMissingFast,
  };
})();

//=================================================
// FILE: /scripts/app/promocode.js
// scripts/app/promocode.js
// Promocode gate + iOS install prompt
// –ù–µ —Ç—Ä–æ–≥–∞–µ–º playback. –¢–æ–ª—å–∫–æ UI –≤—Ö–æ–¥–∞.

(function PromocodeModule() {
  'use strict';

  function isIOS() {
    return /iPhone|iPad|iPod/i.test(navigator.userAgent) && !window.MSStream;
  }

  function isStandalone() {
    return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  }

  function unlockAppDirectly() {
    const promocodeBlock = document.getElementById('promocode-block');
    const mainBlock = document.getElementById('main-block');

    if (promocodeBlock) promocodeBlock.classList.add('hidden');
    if (mainBlock) mainBlock.classList.remove('hidden');

    const tryInit = () => {
      if (window.app && typeof window.app.initialize === 'function') {
        window.app.initialize();
        return true;
      }
      return false;
    };

    if (!tryInit()) {
      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (tryInit() || tries > 50) clearInterval(t);
      }, 60);
    }
  }

  function detectIOSAndShowInstallGuide() {
    const ios = isIOS();
    const standalone = isStandalone();
    if (!ios || standalone) return;

    setTimeout(() => {
      if (localStorage.getItem('iosInstallDismissed') === '1') return;

      const el = document.createElement('div');
      el.className = 'ios-install-prompt';
      el.innerHTML = `
        <button class="ios-prompt-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" type="button">√ó</button>
        <div class="ios-prompt-content">
          <img class="ios-prompt-icon" src="icons/apple-touch-icon.png" alt="–ò–∫–æ–Ω–∫–∞">
          <div style="font-weight:800; font-size:18px; margin-bottom:8px;">
            –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          </div>
          <div style="opacity:.85; margin-bottom:14px;">
            –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</strong> ‚ÜóÔ∏è<br>
            –∏ –≤—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª¬ª</strong>
          </div>
          <button class="ios-prompt-button" type="button">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
      `;

      const dismiss = () => {
        el.classList.remove('show');
        try { localStorage.setItem('iosInstallDismissed', '1'); } catch {}
        setTimeout(() => { try { el.remove(); } catch {} }, 350);
      };

      el.querySelector('.ios-prompt-close')?.addEventListener('click', dismiss);
      el.querySelector('.ios-prompt-button')?.addEventListener('click', dismiss);

      document.body.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
    }, 3000);
  }

  function setupPromocodeGate() {
    if (isIOS()) document.body.classList.add('ios');

    const PROMO = String(window.APP_CONFIG?.PROMOCODE || '').trim();

    const savedPromo = localStorage.getItem('promocode');
    if (PROMO && savedPromo === PROMO) {
      unlockAppDirectly();
      detectIOSAndShowInstallGuide();
      return;
    }

    const promoInput = document.getElementById('promo-inp');
    const promoBtn = document.getElementById('promo-btn');
    const promoError = document.getElementById('promo-error');

    const checkPromo = () => {
      const value = String(promoInput?.value || '').trim();
      if (PROMO && value === PROMO) {
        localStorage.setItem('promocode', value);
        unlockAppDirectly();
      } else {
        if (promoError) promoError.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';
        promoInput?.classList?.add('error');
        setTimeout(() => {
          if (promoError) promoError.textContent = '';
          promoInput?.classList?.remove('error');
        }, 2000);
      }
    };

    promoBtn?.addEventListener('click', checkPromo);
    promoInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkPromo();
    });

    detectIOSAndShowInstallGuide();
  }

  window.addEventListener('load', setupPromocodeGate);
})();

//=================================================
// FILE: /scripts/app/track-registry.js
// scripts/app/track-registry.js
// –†–µ–µ—Å—Ç—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ (–¢–ó 7.1)

const registry = new Map();

export function registerTrack(track) {
  if (!track) return;
  const uid = String(track.uid || '').trim();
  if (!uid) return;

  const existing = registry.get(uid);
  const merged = existing ? { ...existing, ...track } : { ...track };

  merged.uid = uid;

  if (track.sources?.audio?.hi) merged.urlHi = track.sources.audio.hi;
  if (track.sources?.audio?.lo) merged.urlLo = track.sources.audio.lo;
  if (track.audio) merged.urlHi = merged.urlHi || track.audio;
  if (track.audio_low) merged.urlLo = merged.urlLo || track.audio_low;

  // ‚úÖ Sizes normalization (critical for offline completeness detection)
  // Support both legacy fields (size/size_low) and normalized fields (sizeHi/sizeLo).
  const sizeHi =
    (typeof track.sizeHi === 'number' ? track.sizeHi : null) ??
    (typeof track.size === 'number' ? track.size : null);

  const sizeLo =
    (typeof track.sizeLo === 'number' ? track.sizeLo : null) ??
    (typeof track.size_low === 'number' ? track.size_low : null);

  if (typeof sizeHi === 'number') merged.sizeHi = sizeHi;
  if (typeof sizeLo === 'number') merged.sizeLo = sizeLo;

  // Keep legacy keys too (some code paths still read them)
  if (typeof track.size === 'number') merged.size = track.size;
  if (typeof track.size_low === 'number') merged.size_low = track.size_low;

  registry.set(uid, merged);
}

export function registerTracks(tracks) {
  if (!Array.isArray(tracks)) return;
  tracks.forEach(t => registerTrack(t));
}

export function getTrackByUid(uid) {
  const u = String(uid || '').trim();
  if (!u) return null;
  return registry.get(u) || null;
}

export function getAllTracks() {
  return Array.from(registry.values());
}

export function clearRegistry() {
  registry.clear();
}

// ‚úÖ –ü—É–±–ª–∏–∫—É–µ–º —Ä–µ–µ—Å—Ç—Ä –≤ window –¥–ª—è OFFLINE –º–æ–¥–∞–ª–∫–∏/updates/re-cache (v1.0).
// –≠—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —Ç–æ–ª—å–∫–æ —É–ø—Ä–æ—â–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∏–∑ UI/IIFE –∫ ESM –¥–∞–Ω–Ω—ã–º.
try {
  window.TrackRegistry = {
    registerTrack,
    registerTracks,
    getTrackByUid,
    getAllTracks,
    clearRegistry
  };
} catch {}


//=================================================
// FILE: /scripts/app/utils/app-utils.js
// scripts/app/utils/app-utils.js

export const $ = (id) => document.getElementById(id);

export const toStr = (v) => (v == null ? '' : String(v));

export const isMobileUA = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

function _escFallback(s) {
  const v = toStr(s);
  return v.replace(/[<>&'"]/g, (m) => ({
    '<': '&lt;', '>': '&gt;', '&': '&amp;', "'": '&#39;', '"': '&quot;'
  }[m]));
}

export const escHtml = (s) => {
  const fn = window.Utils?.escapeHtml;
  return (typeof fn === 'function') ? fn(toStr(s)) : _escFallback(s);
};

//=================================================
// FILE: /scripts/ci/lint-sw.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('service-worker.js');
if (!fs.existsSync(file)) {
  console.error('service-worker.js not found');
  process.exit(1);
}
const src = fs.readFileSync(file, 'utf8');

const errors = [];
const warns = [];

if (!/const\s+SW_VERSION\s*=\s*['"`]\d+\.\d+\.\d+['"`]/.test(src)) {
  errors.push('SW_VERSION is missing or has wrong format (x.y.z)');
}

const listeners = (name) => (src.match(new RegExp(`addEventListener\\(['"]${name}['"]`, 'g')) || []).length;
['install','activate','fetch'].forEach(ev => {
  const n = listeners(ev);
  if (n === 0) errors.push(`No ${ev} event listener`);
  if (n > 1) warns.push(`Multiple (${n}) ${ev} listeners`);
});

const consts = ['CORE_CACHE','RUNTIME_CACHE','MEDIA_CACHE','OFFLINE_CACHE','META_CACHE'];
consts.forEach(cn => {
  const n = (src.match(new RegExp(`\\bconst\\s+${cn}\\b`, 'g')) || []).length;
  if (n === 0) errors.push(`Missing const ${cn}`);
  if (n > 1) warns.push(`Duplicate const ${cn} (${n} times)`);
});

// –î–æ–ø.–ø—Ä–æ–≤–µ—Ä–∫–∏: DEFAULT_SW_CONFIG —á–∏—Å–ª–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã –∏ revalidateDays —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ
const cfgMatch = src.match(/const\s+DEFAULT_SW_CONFIG\s*=\s*\{([\s\S]*?)\};/);
if (cfgMatch) {
  const body = cfgMatch[1];
  const num = (key) => {
    const m = body.match(new RegExp(`${key}\\s*:\\s*([0-9]+(?:\\.[0-9]+)?)`));
    return m ? Number(m[1]) : null;
  };
  const revalidateDays = num('revalidateDays');
  if (!(Number.isInteger(revalidateDays) && revalidateDays > 0)) {
    errors.push('DEFAULT_SW_CONFIG.revalidateDays must be positive integer');
  }
  ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(k => {
    const v = num(k);
    if (!(typeof v === 'number' && v > 0)) errors.push(`DEFAULT_SW_CONFIG.${k} must be positive number`);
  });
}

if (warns.length) {
  console.warn('SW linter warnings:\n - ' + warns.join('\n - '));
}
if (errors.length) {
  console.error('SW linter errors:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Service Worker lint OK');


//=================================================
// FILE: /scripts/ci/validate-content.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const fail = (msg) => { console.error(msg); process.exit(2); };
const warn = (msg) => { console.warn(msg); };

// 1) albums.json –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
const albumsFile = path.resolve('albums.json');
if (!fs.existsSync(albumsFile)) fail('albums.json not found');
let albums;
try {
  const raw = fs.readFileSync(albumsFile, 'utf8');
  const j = JSON.parse(raw);
  if (!j || !Array.isArray(j.albums)) fail('albums.json: "albums" must be an array');
  albums = j.albums;
} catch (e) {
  fail('albums.json is not valid JSON: ' + e.message);
}
albums.forEach((a, i) => {
  if (!a.key || !a.title || !a.base) fail(`albums.json: album[${i}] must contain key/title/base`);
  if (typeof a.key !== 'string' || typeof a.title !== 'string' || typeof a.base !== 'string') {
    fail(`albums.json: album[${i}] key/title/base must be strings`);
  }
  if (!/^https?:\/\//i.test(a.base)) {
    fail(`albums.json: album[${i}].base must be absolute http(s) url`);
  }
  if (!/\/$/.test(a.base)) {
    warn(`albums.json: album[${i}].base should end with "/" (got: ${a.base})`);
  }
});

// 1.5) –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π –∞–ª—å–±–æ–º–æ–≤
{
  const keys = albums.map(a => a.key);
  const uniq = new Set(keys);
  if (uniq.size !== keys.length) {
    const dup = keys.filter((k, idx) => keys.indexOf(k) !== idx);
    fail(`albums.json: duplicate album keys: ${Array.from(new Set(dup)).join(', ')}`);
  }
}

// 2) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –≥–∞–ª–µ—Ä–µ–π –∏ index.json –Ω–∞–ª–∏—á–∏—è/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
const galleryRoot = path.resolve('albums/gallery');
const required = ['00','01','02','03','news'];
required.forEach(id => {
  const dir = path.join(galleryRoot, id);
  const idx = path.join(dir, 'index.json');
  if (!fs.existsSync(dir)) fail(`albums/gallery/${id} directory missing`);
  if (!fs.existsSync(idx)) fail(`albums/gallery/${id}/index.json missing`);
  try {
    const raw = fs.readFileSync(idx, 'utf8');
    const j = JSON.parse(raw);
    const items = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
    if (!Array.isArray(items)) fail(`albums/gallery/${id}/index.json: items must be array`);
    if (items.length === 0) warn(`albums/gallery/${id}/index.json: items is empty`);
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ)
    items.forEach((it, k) => {
      const check = (p) => {
        if (!p || /^https?:\/\//i.test(p)) return;
        const rel = p.replace(/^\.\//, '');
        const fp = path.resolve(rel);
        if (!fs.existsSync(fp)) warn(`Missing file referenced from gallery ${id} item[${k}]: ${p}`);
      };
      if (typeof it === 'string') check(it);
      else if (it && typeof it === 'object') {
        if (it.src) check(it.src);
        if (it.formats) Object.values(it.formats).forEach(check);
      }
    });
  } catch (e) {
    fail(`albums/gallery/${id}/index.json invalid JSON: ${e.message}`);
  }
});

// 3) custom.json sw –∫–æ–Ω—Ñ–∏–≥: revalidateDays —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
const customFile = path.resolve('custom.json');
if (fs.existsSync(customFile)) {
  try {
    const raw = fs.readFileSync(customFile, 'utf8');
    const j = JSON.parse(raw);
    if (j && j.sw) {
      const d = j.sw.revalidateDays;
      if (!(Number.isInteger(d) && d > 0)) {
        fail('custom.json.sw.revalidateDays must be positive integer');
      }
      ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(key => {
        const v = j.sw[key];
        if (!(typeof v === 'number' && v > 0)) fail(`custom.json.sw.${key} must be positive number`);
      });
      if (typeof j.sw.allowUnknownSize !== 'boolean') {
        fail('custom.json.sw.allowUnknownSize must be boolean');
      }
    }
  } catch (e) {
    fail('custom.json invalid JSON: ' + e.message);
  }
}
// 4) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å uid –≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö config.json (–ù–ï —Ñ–µ–π–ª–∏–º –±–∏–ª–¥ –∏–∑-–∑–∞ —Å–µ—Ç–∏)
{
  // Node 20: fetch –¥–æ—Å—Ç—É–ø–µ–Ω. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –µ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º.
  const hasFetch = typeof fetch === 'function';
  if (!hasFetch) {
    warn('fetch() is not available in this Node runtime; skip remote config.json uid checks');
  } else {
    for (const a of albums) {
      const base = a.base.endsWith('/') ? a.base : `${a.base}/`;
      const url = `${base}config.json`;

      try {
        const r = await fetch(url, { cache: 'no-cache' });
        if (!r.ok) {
          warn(`remote config.json not reachable for "${a.key}": HTTP ${r.status} (${url})`);
          continue;
        }

        const cfg = await r.json();
        const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : null;
        if (!tracks) {
          warn(`remote config.json "${a.key}": tracks must be array (${url})`);
          continue;
        }

        const seen = new Set();
        const dups = new Set();
        let missing = 0;

        for (const t of tracks) {
          const uid = String(t?.uid || '').trim();
          if (!uid) {
            missing++;
            continue;
          }
          if (seen.has(uid)) dups.add(uid);
          seen.add(uid);
        }

        if (missing > 0) {
          warn(`remote config.json "${a.key}": ${missing} track(s) have empty uid (${url})`);
        }
        if (dups.size > 0) {
          warn(`remote config.json "${a.key}": duplicate uid(s): ${Array.from(dups).join(', ')} (${url})`);
        }
      } catch (e) {
        warn(`remote config.json check failed for "${a.key}": ${e?.message || e} (${url})`);
      }
    }
  }
}

console.log('Content validation OK');

//=================================================
// FILE: /scripts/ci/validate-manifest.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('manifest.json');
if (!fs.existsSync(file)) {
  console.error('manifest.json not found');
  process.exit(1);
}
const raw = fs.readFileSync(file, 'utf8');
let json;
try {
  json = JSON.parse(raw);
} catch (e) {
  console.error('manifest.json is not valid JSON:', e.message);
  process.exit(1);
}
const errors = [];
function req(key) { if (!(key in json)) errors.push(`Missing key: ${key}`); }

req('name');
req('short_name');
req('start_url');
req('icons');

if (json.icons && !Array.isArray(json.icons)) {
  errors.push('icons must be an array');
}
if (Array.isArray(json.icons) && json.icons.length === 0) {
  errors.push('icons must contain at least one icon');
}
if (!json.display) errors.push('Missing key: display');
if (!json.theme_color) errors.push('Missing key: theme_color');
if (!json.background_color) errors.push('Missing key: background_color');

if (errors.length) {
  console.error('Manifest validation failed:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Manifest validation OK');

//=================================================
// FILE: /scripts/core/bootstrap.js
// scripts/core/bootstrap.js
(function () {
  'use strict';

  class AppBootstrap {
    async init() {
      if (!this._compat()) return;

      if (!(await this._waitForHowler())) return;

      this._markEnv();
      this._preventWeirdIOSZoom();
      this._errors();
      await this._loadAlbumsIndex();
    }

    _compat() {
      const missing = [];
      if (!this._hasLS()) missing.push('LocalStorage');
      if (typeof fetch === 'undefined') missing.push('Fetch API');
      if (typeof Promise === 'undefined') missing.push('Promises');
      if (!document.addEventListener) missing.push('Event Listeners');
      if (missing.length) return this._compatFail(missing), false;
      return true;
    }

    _hasLS() {
      try { localStorage.setItem('__t', '1'); localStorage.removeItem('__t'); return true; } catch { return false; }
    }

    _compatFail(missing) {
      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–æ–≤–µ—Ä–ª–µ–π), –Ω–æ –±–µ–∑ –æ–≥—Ä–æ–º–Ω–æ–≥–æ HTML-—à–∞–±–ª–æ–Ω–∞
      document.body.innerHTML =
        '<div style="position:fixed;inset:0;background:#181818;color:#fff;display:flex;align-items:center;justify-content:center;font-family:sans-serif;padding:20px;text-align:center;z-index:99999">' +
          '<div>' +
            '<h1 style="color:#E80100;margin:0 0 16px">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h1>' +
            '<p style="margin:0 0 12px">–î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É—é—Ç—Å—è:</p>' +
            '<div style="color:#bbb">' + missing.map(s => '‚Ä¢ ' + s).join('<br>') + '</div>' +
          '</div>' +
        '</div>';
    }

    async _waitForHowler() {
      const ok = await (window.Utils?.waitFor
        ? window.Utils.waitFor(() => typeof Howl !== 'undefined', 5000, 100)
        : this._poll(() => typeof Howl !== 'undefined', 5000, 100));

      if (ok) return true;

      window.NotificationSystem?.error?.('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ-–±–∏–±–ª–∏–æ—Ç–µ–∫—É. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
      return false;
    }

    async _poll(fn, maxMs, step) {
      let t = 0;
      while (!fn() && t < maxMs) { // eslint-disable-next-line no-await-in-loop
        await new Promise(r => setTimeout(r, step));
        t += step;
      }
      return !!fn();
    }

    _markEnv() {
      try { if (window.Utils?.isIOS?.()) document.body.classList.add('ios'); } catch {}
      try { if (window.Utils?.isStandalone?.()) document.body.classList.add('standalone'); } catch {}
    }

    _preventWeirdIOSZoom() {
      // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–≤–æ—é –ª–æ–≥–∏–∫—É, –Ω–æ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ
      document.body.addEventListener('touchstart', (e) => {
        if (e.touches && e.touches.length > 1) e.preventDefault();
      }, { passive: false });

      let last = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - last <= 300 && now - last > 0) {
          const tag = e.target?.tagName;
          const interactive = ['A', 'BUTTON', 'INPUT', 'SELECT', 'TEXTAREA'].includes(tag) ||
            e.target?.closest?.('.track, .album-icon, .like-star, .player-control-btn, .offline-btn');
          if (!interactive) e.preventDefault();
        }
        last = now;
      }, { passive: false });

      document.addEventListener('contextmenu', (e) => {
        if (e.target?.tagName === 'IMG' || e.target?.closest?.('#cover-slot')) e.preventDefault();
      });
    }

    _errors() {
      window.addEventListener('error', (e) => { console.error('Global error:', e.error || e.message); });
      window.addEventListener('unhandledrejection', (e) => { console.error('Unhandled rejection:', e.reason); });
    }

    async _loadAlbumsIndex() {
      try {
        const r = await fetch('./albums.json', { cache: 'no-cache', headers: { Accept: 'application/json' } });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        window.albumsIndex = Array.isArray(data?.albums) ? data.albums : [];
      } catch (e) {
        console.error('Failed to load albums.json:', e);
        window.albumsIndex = [];
        window.NotificationSystem?.error?.('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤');
      } finally {
        try { window.dispatchEvent(new Event('albumsIndex:ready')); } catch {}
      }
    }
  }

  const run = () => new AppBootstrap().init();
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run);
  else run();
})();

//=================================================
// FILE: /scripts/core/config.js
// scripts/core/config.js
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
export const APP_CONFIG = {
  // –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  APP_VERSION: '8.0.4',
  BUILD_DATE: '2025-11-08',
  // ‚úÖ –ü–†–û–ú–û–ö–û–î –î–õ–Ø –í–•–û–î–ê
  PROMOCODE: 'VITRINA2025',
  // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –∞–ª—å–±–æ–º–æ–≤
  ICON_ALBUMS_ORDER: [
    { key: '__favorites__', title: '‚≠ê‚≠ê‚≠ê–ò–ó–ë–†–ê–ù–ù–û–ï‚≠ê‚≠ê‚≠ê', icon: 'img/icon_album/icon-album-00.png' },
    { key: 'odnazhdy-v-skazke', title: '–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ', icon: 'img/icon_album/icon-album-03.png' },
    { key: 'golos-dushi', title: '–ì–æ–ª–æ—Å –î—É—à–∏', icon: 'img/icon_album/icon-album-02.png' },
    { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º', icon: 'img/icon_album/icon-album-01.png' },
    { key: 'krevetochka', title: '–ö–†–ï–í–ï—ÜTOCHKA', icon: 'img/icon_album/icon-album+00.png' },
    { key: '__reliz__', title: '–ù–û–í–û–°–¢–ò', icon: 'img/icon_album/icon-album-news.png' }
  ],
  // –ö–ª—é—á–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤
  SPECIAL_FAVORITES_KEY: '__favorites__',
  SPECIAL_RELIZ_KEY: '__reliz__',
  // –°—Å—ã–ª–∫–∏
  SUPPORT_URL: 'https://example.com/support',
  SUPPORT_EMAIL: 'support@vitrina-razbita.ru',
  GITHUB_URL: 'https://github.com/apel-s-in/vi3na1bita-music',
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–µ—Ä–∞
  PLAYER_SETTINGS: {
    defaultVolume: 1.0,
    crossfade: false,
    preload: true
  },
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  CACHE_VERSION: 'v1.0.0',
  CACHE_AUDIO: false, // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã
  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  ANALYTICS_ENABLED: false,
  ANALYTICS_ID: null,
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
  CENTRAL_GALLERY_BASE: './albums/gallery/',
  // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞–ª—å–±–æ–º–æ–≤
  PUBLISHED_ALBUM_KEYS: new Set(['odnazhdy-v-skazke', 'golos-dushi', 'mezhdu-zlom-i-dobrom', 'krevetochka'])
};

// –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
if (typeof window !== 'undefined') {
  window.APP_CONFIG = APP_CONFIG;
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  window.SPECIAL_FAVORITES_KEY = APP_CONFIG.SPECIAL_FAVORITES_KEY;
  window.SPECIAL_RELIZ_KEY = APP_CONFIG.SPECIAL_RELIZ_KEY;
  window.ICON_ALBUMS_ORDER = APP_CONFIG.ICON_ALBUMS_ORDER;
  window.CENTRAL_GALLERY_BASE = APP_CONFIG.CENTRAL_GALLERY_BASE;
}

//=================================================
// FILE: /scripts/core/utils.js
// scripts/core/utils.js ‚Äî –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã (clean + –º–µ–Ω—å—à–µ –¥—É–±–ª–µ–π)
(function () {
  'use strict';

  const W = window;

  const Utils = {
    // ===== DOM =====
    dom: (() => {
      const m = new Map();
      const byId = (id) => {
        const key = String(id || '');
        if (!key) return null;
        const cached = m.get(key);
        if (cached && cached.isConnected) return cached;
        const el = document.getElementById(key);
        if (el) m.set(key, el);
        else m.delete(key);
        return el || null;
      };

      const on = (el, ev, fn, opts) => {
        if (!el) return () => {};
        el.addEventListener(ev, fn, opts);
        return () => { try { el.removeEventListener(ev, fn, opts); } catch {} };
      };

      const raf = (fn) => requestAnimationFrame(fn);

      const qs = (sel, root = document) => root.querySelector(sel);
      const qsa = (sel, root = document) => root.querySelectorAll(sel);

      const createStyleOnce = (id, cssText) => {
        const key = String(id || '').trim();
        if (!key) return null;
        const existing = document.getElementById(key);
        if (existing) return existing;
        const s = document.createElement('style');
        s.id = key;
        s.textContent = String(cssText || '');
        document.head.appendChild(s);
        return s;
      };

      const onDocClickOutside = (targetEl, handler, opts = {}) => {
        const capture = opts.capture !== false;
        const doc = opts.doc || document;
        const fn = (e) => {
          try {
            if (!targetEl || targetEl.contains(e.target)) return;
            handler && handler(e);
          } catch {}
        };
        doc.addEventListener('click', fn, capture);
        return () => { try { doc.removeEventListener('click', fn, capture); } catch {} };
      };

      const onEscape = (handler, opts = {}) => {
        const doc = opts.doc || document;
        const fn = (e) => { if (e?.key === 'Escape') { try { handler && handler(e); } catch {} } };
        doc.addEventListener('keydown', fn, { passive: true });
        return () => { try { doc.removeEventListener('keydown', fn, { passive: true }); } catch {} };
      };

      return { byId, on, raf, qs, qsa, createStyleOnce, onDocClickOutside, onEscape };
    })(),

    // Back-compat
    $(id) { return Utils.dom.byId(id); },
    $q(sel, root) { return Utils.dom.qs(sel, root); },
    $qa(sel, root) { return Utils.dom.qsa(sel, root); },

    // ===== Common =====
    clamp(n, a, b) {
      n = Number(n); a = Number(a); b = Number(b);
      return Number.isFinite(n) && Number.isFinite(a) && Number.isFinite(b) ? Math.max(a, Math.min(b, n)) : a;
    },

    toInt(v, d = 0) {
      const n = parseInt(String(v ?? ''), 10);
      return Number.isFinite(n) ? n : d;
    },

    trimStr(v) {
      const s = String(v ?? '').trim();
      return s || null;
    },

    escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = String(s || '');
      return d.innerHTML;
    },

    formatTime(s) {
      const n = Number(s);
      if (!Number.isFinite(n) || n < 0) return '--:--';
      const m = Math.floor(n / 60);
      const sec = Math.floor(n % 60);
      return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    },

    async waitFor(fn, maxMs = 2000, step = 50) {
      let t = 0;
      while (!fn() && t < maxMs) { // eslint-disable-next-line no-await-in-loop
        await new Promise(r => setTimeout(r, step));
        t += step;
      }
      return !!fn();
    },

    onceEvent(target, eventName, opts = {}) {
      const timeoutMs = (opts && Number.isFinite(opts.timeoutMs)) ? opts.timeoutMs : null;
      return new Promise((resolve, reject) => {
        let tm = null;
        const onEv = (ev) => { cleanup(); resolve(ev); };
        const cleanup = () => {
          try { target.removeEventListener(eventName, onEv); } catch {}
          if (tm) clearTimeout(tm);
        };
        try { target.addEventListener(eventName, onEv, { once: true }); } catch {}
        if (timeoutMs != null) {
          tm = setTimeout(() => { cleanup(); reject(new Error(`Timeout waiting for event "${eventName}"`)); }, timeoutMs);
        }
      });
    },

    debounceFrame(fn) {
      let rafId = 0, lastArgs = null;
      return function (...args) {
        lastArgs = args;
        if (rafId) return;
        rafId = requestAnimationFrame(() => { rafId = 0; fn.apply(this, lastArgs); });
      };
    },

    isMobile() { return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); },
    isIOS() { return /iPad|iPhone|iPod/.test(navigator.userAgent) && !W.MSStream; },
    isStandalone() { return W.matchMedia('(display-mode: standalone)').matches || W.navigator.standalone; },

    // ===== Network =====
    getNetworkStatusSafe() {
      try { if (W.NetworkManager?.getStatus) return W.NetworkManager.getStatus(); } catch {}
      return { online: navigator.onLine !== false, kind: 'unknown', saveData: false };
    },

    isOnline() {
      try { if (W.NetworkManager?.getStatus) return !!W.NetworkManager.getStatus().online; } catch {}
      return navigator.onLine !== false;
    },

    // ===== Bytes =====
    formatBytes(n) {
      const b = Number(n) || 0;
      if (b < 1024) return `${Math.floor(b)} B`;
      if (b < 1024 * 1024) return `${(b / 1024).toFixed(1)} KB`;
      if (b < 1024 * 1024 * 1024) return `${(b / (1024 * 1024)).toFixed(1)} MB`;
      return `${(b / (1024 * 1024 * 1024)).toFixed(2)} GB`;
    },

    // ===== Storage =====
    lsGet(key, fallback = null) {
      try {
        const v = localStorage.getItem(String(key || ''));
        return v === null ? fallback : v;
      } catch { return fallback; }
    },

    lsSet(key, value) {
      try { localStorage.setItem(String(key || ''), String(value)); return true; } catch { return false; }
    },

    lsRemove(key) {
      try { localStorage.removeItem(String(key || '')); return true; } catch { return false; }
    },

    lsGetBool01(key, fallback = false) {
      return Utils.lsGet(key, fallback ? '1' : '0') === '1';
    },

    lsSetBool01(key, on) {
      return Utils.lsSet(key, on ? '1' : '0');
    },

    lsGetJson(key, fallback = null) {
      try {
        const raw = localStorage.getItem(String(key || ''));
        if (!raw) return fallback;
        const j = JSON.parse(raw);
        return (j === null || j === undefined) ? fallback : j;
      } catch { return fallback; }
    },

    lsSetJson(key, value) {
      try { localStorage.setItem(String(key || ''), JSON.stringify(value)); return true; } catch { return false; }
    },

    // ===== UI helpers =====
    setBtnActive(id, active) {
      const el = Utils.dom.byId(id);
      if (el) el.classList.toggle('active', !!active);
    },

    setAriaDisabled(el, disabled) {
      if (!el) return;
      el.classList.toggle('disabled', !!disabled);
      el.setAttribute('aria-disabled', disabled ? 'true' : 'false');
    },

    // ===== App helpers =====
    isSpecialAlbumKey(key) {
      const k = String(key || '');
      return !!k && k.startsWith('__');
    },

    isBrowsingOtherAlbum() {
      const playing = W.AlbumsManager?.getPlayingAlbum?.();
      const current = W.AlbumsManager?.getCurrentAlbum?.();
      if (!playing) return false;
      if (playing === W.SPECIAL_FAVORITES_KEY && current === W.SPECIAL_FAVORITES_KEY) return false;
      return playing !== current;
    },

    // ===== Favorites helpers =====
    fav: {
      isTrackLikedInContext({ playingAlbum, track } = {}) {
        const pc = W.playerCore;
        const pa = String(playingAlbum || '').trim();
        const uid = String(track?.uid || '').trim();
        if (!pc || !pa || !uid) return false;

        if (pa !== W.SPECIAL_FAVORITES_KEY) return !!pc?.isFavorite?.(uid);

        const srcAlbum = String(track?.sourceAlbum || '').trim();
        if (srcAlbum) return !!pc?.isFavorite?.(uid);

        const ref = Array.isArray(W.favoritesRefsModel)
          ? W.favoritesRefsModel.find(it => String(it?.__uid || '').trim() === uid)
          : null;

        const a = String(ref?.__a || '').trim();
        return a ? !!pc?.isFavorite?.(uid) : false;
      }
    },

    // ===== PQ helpers =====
    pq: {
      key: 'qualityMode:v1',

      getMode() {
        const raw = String(Utils.lsGet(Utils.pq.key, W.playerCore?.getQualityMode?.() || 'hi')).toLowerCase();
        return raw === 'lo' ? 'lo' : 'hi';
      },

      getState() {
        const pc = W.playerCore;
        const mode = Utils.pq.getMode();
        const canToggleByTrack = !!pc?.canToggleQualityForCurrentTrack?.();
        const netOk = Utils.isOnline();
        return { mode, canToggle: canToggleByTrack && netOk, canToggleByTrack, netOk };
      },

      toggle() {
        const pc = W.playerCore;
        if (!pc) return { ok: false, reason: 'noPlayerCore' };
        const st = Utils.pq.getState();
        if (!st.netOk) return { ok: false, reason: 'offline' };
        if (!st.canToggleByTrack) return { ok: false, reason: 'trackNoLo' };
        const next = st.mode === 'hi' ? 'lo' : 'hi';
        pc.switchQuality?.(next);
        return { ok: true, next };
      }
    },

    // ===== Download helpers =====
    download: {
      getSizeHintMB({ albumData, track } = {}) {
        try {
          const uid = String(track?.uid || '').trim();
          if (!uid || !albumData || !Array.isArray(albumData.tracks)) return '';

          const byUid = albumData.tracks.find(t => t && String(t.uid || '').trim() === uid);
          if (!byUid) return '';

          const curSrc = String(track?.src || '').trim();
          const loSrc = String(byUid.fileLo || '').trim();

          const size = (curSrc && loSrc && curSrc === loSrc)
            ? (typeof byUid.sizeLo === 'number' ? byUid.sizeLo : null)
            : (typeof byUid.sizeHi === 'number' ? byUid.sizeHi : (typeof byUid.size === 'number' ? byUid.size : null));

          return (typeof size === 'number') ? ` (~${size.toFixed(2)} –ú–ë)` : '';
        } catch { return ''; }
      },

      applyDownloadLink(anchorEl, track) {
        if (!anchorEl) return;

        if (!track?.src) {
          anchorEl.href = '#';
          anchorEl.removeAttribute('download');
          anchorEl.title = '–°–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫';
          return;
        }

        anchorEl.href = track.src;
        anchorEl.download = `${track.title}.mp3`;

        const playingAlbumKey = W.AlbumsManager?.getPlayingAlbum?.();
        const albumData = playingAlbumKey ? W.AlbumsManager?.getAlbumData?.(playingAlbumKey) : null;
        const hint = Utils.download.getSizeHintMB({ albumData, track });
        anchorEl.title = hint ? `–°–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫${hint}` : '–°–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫';
      }
    }
  };

  W.Utils = Utils;
})();

//=================================================
// FILE: /scripts/e2e/favorites.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import { loginByPromo, likeFirstTrack, openFavorites, playFirstTrack } from './utils.js';

test('favorites UI builds and plays from favorites list', async ({ page }) => {
  await loginByPromo(page);

  await likeFirstTrack(page);
  await openFavorites(page);
  const favCount = await page.locator('#track-list .track').count();
  expect(favCount).toBeGreaterThan(0);

  // –ö–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
});

test('toggle star in favorites updates row state and localStorage (uid-based)', async ({ page }) => {
  await loginByPromo(page);

  // –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –æ—Ç–º–µ—Ç–∏–º —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // –í–æ–π—Ç–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const favRow = page.locator('#track-list .track').first();
  const favId = await favRow.getAttribute('id'); // —Ñ–æ—Ä–º–∞—Ç fav_{albumKey}_{uid}
  expect(favId).toMatch(/^fav_/);

  // –°–Ω–∏–º–µ–º –∑–≤–µ–∑–¥—É ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–µ—Ç .inactive –∏ uid –ø—Ä–æ–ø–∞–¥—ë—Ç –∏–∑ likedTrackUids:v1
  await favRow.locator('.like-star').click();
  await expect(favRow).toHaveClass(/inactive/);

  // –ü—Ä–æ–≤–µ—Ä–∏–º localStorage: likedTrackUids:v1 –±–æ–ª—å—à–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç–æ—Ç uid –≤ –º–∞—Å—Å–∏–≤–µ —Å—Ç—Ä–æ–∫
  const { albumKey, uid, present } = await page.evaluate((id) => {
    const m = String(id || '').match(/^fav_(.+)_(.+)$/);
    const a = m ? m[1] : '';
    const u = m ? m[2] : '';
    const raw = localStorage.getItem('likedTrackUids:v1');
    const map = raw ? JSON.parse(raw) : {};
    const arr = Array.isArray(map[a]) ? map[a] : [];
    return { albumKey: a, uid: u, present: arr.includes(u) };
  }, favId);

  expect(albumKey).toBeTruthy();
  expect(uid).toBeTruthy();
  expect(present).toBeFalsy();
});

test('favorites view: add to favorites, play and verify mini-mode when browsing other album', async ({ page }) => {
  await loginByPromo(page);

  await likeFirstTrack(page);
  await openFavorites(page);

  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  const otherIcon = page
    .locator('.album-icon')
    .filter({ hasNot: page.locator('[data-akey="__favorites__"]') })
    .nth(1);
  await otherIcon.click();

  await expect(page.locator('#mini-now')).toBeVisible();
});

// –î–æ–ø. —Ç–µ—Å—Ç: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (PlayerState.applyState)
test('reload restores state via PlayerState.applyState', async ({ page }) => {
  await loginByPromo(page);
  await playFirstTrack(page);

  // ‚úÖ –°–∏–¥–∏—Ä—É–µ–º state —Ç–æ–ª—å–∫–æ V2/uid
  await page.evaluate(() => {
    const pc = window.playerCore;
    const track = pc?.getCurrentTrack?.() || null;
    const albumKey = window.AlbumsManager?.getPlayingAlbum?.() || null;

    const st = {
      album: albumKey,
      currentAlbum: window.AlbumsManager?.getCurrentAlbum?.() || albumKey,
      trackUid: String(track?.uid || '').trim() || null,
      sourceAlbum: String(track?.sourceAlbum || '').trim() || null,
      trackIndex: typeof pc?.getIndex === 'function' ? (pc.getIndex() || 0) : 0,
      position: Math.floor(pc?.getPosition?.() || 5),
      volume: typeof pc?.getVolume === 'function' ? (pc.getVolume() ?? 100) : 100,
      wasPlaying: true
    };

    localStorage.setItem('playerStateV2', JSON.stringify(st));
  });

  await page.reload({ waitUntil: 'load' });
  await loginByPromo(page);

  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getPosition?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç setSinkId: —Å–∫–∏–ø, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
test('optional audio output setSinkId (skip when unsupported)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  const supported = await page.evaluate(() => {
    const dest = (window.Howler && window.Howler.ctx && window.Howler.ctx.destination) ? window.Howler.ctx.destination : null;
    return !!(dest && typeof dest.setSinkId === 'function' && navigator.mediaDevices);
  });
  // –ù–∏—á–µ–≥–æ –Ω–µ –∞—Å—Å–µ—Ä—Ç–∏–º: —Ç–µ—Å—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π.
});

test('sysinfo modal shows after GET_SW_INFO', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –ñ–¥—ë–º –∏–Ω–∏ SW
  await page.waitForTimeout(800);
  const sysbtn = page.locator('#sysinfo-btn');
  await expect(sysbtn).toBeVisible({ timeout: 5000 });
  await sysbtn.click();

  const modal = page.locator('.modal-bg .modal-feedback').filter({ hasText: '–û —Å–∏—Å—Ç–µ–º–µ' });
  await expect(modal).toBeVisible({ timeout: 5000 });
  await expect(modal).toContainText(/SW –≤–µ—Ä—Å–∏—è:/);
});

// –ù–æ–≤—ã–π —Ç–µ—Å—Ç: –±—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏ Prev/Next —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ ‚Äî –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç legacy <audio>
test('quick prev/next uses PlayerCore only (no legacy audio starts)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  await page.evaluate(async () => {
    await new Promise(r => setTimeout(r, 50));
    window.PlayerControls && window.PlayerControls.previousTrack && window.PlayerControls.previousTrack();
    window.PlayerControls && window.PlayerControls.nextTrack && window.PlayerControls.nextTrack();
  });

  const res = await page.evaluate(() => ({
    hasPc: !!window.playerCore,
    hasAudioEl: !!document.getElementById('audio')
  }));
  expect(res.hasPc).toBeTruthy();
  expect(res.hasAudioEl).toBeFalsy();
});

test('SW update flow persists state and restores after reload', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');
  await page.waitForTimeout(200);
  await page.evaluate(() => {
    if (window.playerCore && typeof window.playerCore.play === 'function') {
      window.playerCore.play(0);
      try { window.playerCore.seek(7); } catch {}
    }
  });

  await page.evaluate(() => {
    window.confirm = () => true;
    const evt = new MessageEvent('message', { data: { type: 'SW_VERSION', version: '9.9.9' } });
    try { window.dispatchEvent(evt); } catch {}
  });

  const hasResume = await page.evaluate(() => !!sessionStorage.getItem('resumeAfterReloadV2'));
  expect(hasResume).toBeTruthy();

  await page.reload({ waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getPosition?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

// –ù–û–í–´–ô –¢–ï–°–¢: —Å–Ω—è–ª –∑–≤–µ–∑–¥—É —É —Ç–µ–∫—É—â–µ–≥–æ –≤ —Ä–µ–∂–∏–º–µ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ‚Üí next() –∏ UI –æ–±–Ω–æ–≤–∏–ª—Å—è
test('favorites playing: removing star of current track triggers next and updates UI', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –û—Ç–º–µ—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π –≤ –∞–ª—å–±–æ–º–µ
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // –û—Ç–∫—Ä–æ–µ–º ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª –∏ –∑–∞–ø—É—Å—Ç–∏–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ç—Ä–µ–∫–∞
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const favFirst = page.locator('#track-list .track').first();
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // –°–Ω–∏–º–µ–º –∑–≤–µ–∑–¥—É –Ω–∞ —ç—Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ
  const beforeIdx = await page.evaluate(() => (window.playerCore?.getIndex?.() ?? window.playingTrack ?? 0));
  await favFirst.locator('.like-star').click();

  // –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
  await page.waitForTimeout(300);
  const afterIdx = await page.evaluate(() => (window.playerCore?.getIndex?.() ?? window.playingTrack ?? 0));
  expect(afterIdx).not.toBe(beforeIdx);

  // –°—Ç—Ä–æ–∫–∞ —Å—Ç–∞–ª–∞ inactive, –∞ –∫–ª–∞—Å—Å .current –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –¥—Ä—É–≥–æ–π —ç–ª–µ–º–µ–Ω—Ç
  await expect(favFirst).toHaveClass(/inactive/);
  const currentCount = await page.locator('#track-list .track.current').count();
  expect(currentCount).toBe(1);

  // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –º–∏–Ω–∏-—Ä–µ–∂–∏–º –≤–æ–∑–º–æ–∂–µ–Ω ‚Äî ¬´–î–∞–ª–µ–µ¬ª/–º–∏–Ω–∏-—à–∞–ø–∫–∞ –æ–±–Ω–æ–≤—è—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ (–Ω–µ —Å—Ç—Ä–æ–≥–æ –∞—Å—Å–µ—Ä—Ç–∏–º –≤–∏–¥–∏–º–æ—Å—Ç—å)
  await page.evaluate(() => {
    window.PlayerUI && window.PlayerUI.updateNextUpLabel && window.PlayerUI.updateNextUpLabel();
    window.PlayerUI && window.PlayerUI.updateMiniHeader && window.PlayerUI.updateMiniHeader();
  });
});

test('mini-player star toggles favorite in __favorites__ and syncs with list (uid-based)', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });

  // –í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // 1. –û—Ç–º–µ—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π –≤ –∞–ª—å–±–æ–º–Ω–æ–º —Å–ø–∏—Å–∫–µ
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // 2. –ü–µ—Ä–µ–π–¥—ë–º –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª –∏ –∑–∞–ø—É—Å—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const favFirst = page.locator('#track-list .track').first();
  const favId = await favFirst.getAttribute('id'); // fav_{albumKey}_{uid}
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // 3. –ü–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏–ª—Å—è mini-—Ä–µ–∂–∏–º
  const otherIcon = page
    .locator('.album-icon')
    .filter({ hasNot: page.locator('[data-akey="__favorites__"]') })
    .nth(1);
  await otherIcon.click();

  // –ú–∏–Ω–∏-–ø–ª–µ–µ—Ä –≤–∏–¥–∏–º
  const miniStar = page.locator('#mini-now-star');
  await expect(page.locator('#mini-now')).toBeVisible({ timeout: 5000 });
  await expect(miniStar).toBeVisible();

  // 4. –ù–∞–∂–º—ë–º –∑–≤–µ–∑–¥—É –≤ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä–µ (toggleLikePlaying)
  await miniStar.click();
  await page.waitForTimeout(200);

  // 5. –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ favorites-—Å–ø–∏—Å–∫–µ –∏ likedTrackUids:v1 —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const favRowAfter = page.locator(`#${favId}`);
  const starAfter = favRowAfter.locator('.like-star');

  const { albumKey, uid, present } = await page.evaluate((favRowId) => {
    const m = String(favRowId || '').match(/^fav_(.+)_(.+)$/);
    const a = m ? m[1] : '';
    const u = m ? m[2] : '';
    const raw = localStorage.getItem('likedTrackUids:v1');
    const map = raw ? JSON.parse(raw) : {};
    const arr = Array.isArray(map[a]) ? map[a] : [];
    return { albumKey: a, uid: u, present: arr.includes(u) };
  }, favId);

  expect(albumKey).toBeTruthy();
  expect(uid).toBeTruthy();

  await expect(starAfter).toBeVisible();
  if (present) {
    await expect(favRowAfter).not.toHaveClass(/inactive/);
  } else {
    await expect(favRowAfter).toHaveClass(/inactive/);
  }
});

//=================================================
// FILE: /scripts/e2e/player.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import {
  loginByPromo,
  likeFirstTrack,
  openFavorites,
  playFirstTrack,
  seedPlayerStateV2FromCurrent
} from './utils.js';

test('play track, toggle favorites-only and sleep timer UI', async ({ page }) => {
  await loginByPromo(page);
  await expect(page.locator('#main-block')).toBeVisible();

  // –î–æ–∂–¥–∞—Ç—å—Å—è —Å–ø–∏—Å–∫–∞ –∞–ª—å–±–æ–º–æ–≤ –∏ –∫–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ —Ç—Ä–µ–∫–ª–∏—Å—Ç–∞
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstTrack = page.locator('#track-list .track').first();
  await firstTrack.click();

  // –ü–æ—è–≤–∏–ª—Å—è –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞ –∏ –∫–Ω–æ–ø–∫–∞ Play/Pause –µ—Å—Ç—å
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
  await expect(page.locator('#play-pause-icon')).toBeVisible();

  // –í–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä "—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ" (–∫–Ω–æ–ø–∫–∞ –≤ –ø–ª–µ–µ—Ä–µ)
  await page.click('#favorites-btn');
  const favBtn = page.locator('#favorites-btn');
  await expect(favBtn).toHaveClass(/favorites-active/);

  // –¢–∞–π–º–µ—Ä —Å–Ω–∞: –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –∏ –≤—ã–±—Ä–∞—Ç—å "15 –º–∏–Ω—É—Ç", –∑–∞—Ç–µ–º –≤—ã–∫–ª—é—á–∏—Ç—å
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("15 –º–∏–Ω—É—Ç")');
  // –ë–µ–π–¥–∂ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è
  await expect(page.locator('#sleep-timer-badge')).toBeVisible();
  // –í—ã–∫–ª—é—á–∏–º
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("–í—ã–∫–ª—é—á–∏—Ç—å")');
  await expect(page.locator('#sleep-timer-badge')).toBeHidden();
});

test('favoritesOnly: unliking current track switches to next (no stop)', async ({ page }) => {
  await loginByPromo(page);

  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // –õ–∞–π–∫–Ω–µ–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∏ –∑–∞–ø—É—Å—Ç–∏–º –µ–≥–æ
  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // –í–∫–ª—é—á–∏–º favoritesOnly
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  const before = await page.evaluate(() => ({
    playing: !!window.playerCore?.isPlaying?.(),
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  // –°–Ω–∏–º–µ–º –ª–∞–π–∫ —Å —Ç–µ–∫—É—â–µ–≥–æ (—á–µ—Ä–µ–∑ –º–∏–Ω–∏/–∑–≤–µ–∑–¥—É —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—â–µ: –∫–ª–∏–∫ –ø–æ –∑–≤–µ–∑–¥–µ –≤ —Å—Ç—Ä–æ–∫–µ)
  await firstRow.locator('.like-star').click();

  // –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–π (–∏–ª–∏ —Ö–æ—Ç—è –±—ã –∏–∑–º–µ–Ω–∏—Ç—å—Å—è uid/index), –ø—Ä–∏ —ç—Ç–æ–º –ù–ï stop.
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => ({
    playing: !!window.playerCore?.isPlaying?.(),
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  expect(after.playing).toBeTruthy();
  expect(after.uid).not.toBe(before.uid);
});

test('repeat has priority: favoritesOnly + repeat + unliking current keeps repeating', async ({ page }) => {
  await loginByPromo(page);

  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // repeat ON
  await page.click('#repeat-btn');
  await expect(page.locator('#repeat-btn')).toHaveClass(/active/);

  const before = await page.evaluate(() => ({
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || ''),
    repeat: !!window.playerCore?.isRepeat?.()
  }));
  expect(before.repeat).toBeTruthy();

  // –°–Ω–∏–º–µ–º –ª–∞–π–∫ —Å —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
  await firstRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  // –ü–æ –ø—Ä–∞–≤–∏–ª—É: repeat –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –Ω–∞ —Ç–æ–º –∂–µ —Ç—Ä–µ–∫–µ
  const after = await page.evaluate(() => ({
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  expect(after.uid).toBe(before.uid);
});

test('favoritesOnly + shuffle: liking another track adds it to tail of queue', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const rows = page.locator('#track-list .track');
  const firstRow = rows.nth(0);
  const secondRow = rows.nth(1);

  // –õ–∞–π–∫–Ω–µ–º 1-–π —Ç—Ä–µ–∫ –∏ –∑–∞–ø—É—Å—Ç–∏–º
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // shuffle ON
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  // –ó–∞–ø–æ–º–Ω–∏–º –¥–ª–∏–Ω—É –ø–ª–µ–π–ª–∏—Å—Ç–∞
  const beforeLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  // –õ–∞–π–∫–Ω–µ–º –≤—Ç–æ—Ä–æ–π —Ç—Ä–µ–∫ (–¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏)
  await secondRow.hover();
  await secondRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => {
    const snap = window.playerCore?.getPlaylistSnapshot?.() || [];
    const tail = snap.length ? snap[snap.length - 1] : null;
    return {
      len: snap.length,
      tailUid: String(tail?.uid || '').trim(),
      likedUids: window.playerCore?.getLikedUidsForAlbum?.(window.AlbumsManager?.getPlayingAlbum?.() || '') || []
    };
  });

  expect(after.len).toBeGreaterThanOrEqual(beforeLen);
  expect(after.likedUids.includes(after.tailUid)).toBeTruthy();
});

test('shuffle history: next-next-prev returns to previously played track', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // –ó–∞–ø—É—Å—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫
  await page.click('#track-list .track >> nth=0');

  // –í–∫–ª—é—á–∏–º shuffle
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  const first = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#next-btn');
  await page.waitForTimeout(200);
  const second = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#next-btn');
  await page.waitForTimeout(200);
  const third = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#prev-btn');
  await page.waitForTimeout(200);
  const back = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  expect(first).toBeTruthy();
  expect(second).toBeTruthy();
  expect(third).toBeTruthy();
  expect(back).toBe(second);
});

test('favoritesOnly + shuffle: unliking NOT current removes it from tail if not played yet', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const rows = page.locator('#track-list .track');
  const firstRow = rows.nth(0);
  const secondRow = rows.nth(1);

  // –õ–∞–π–∫–∞–µ–º 1 –∏ 2 —Ç—Ä–µ–∫
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await secondRow.hover();
  await secondRow.locator('.like-star').click();

  // –ó–∞–ø—É—Å–∫–∞–µ–º 1-–π
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // shuffle ON
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  // –¢–µ–ø–µ—Ä—å –ø–ª–µ–π–ª–∏—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 2 —Ç—Ä–µ–∫–∞ (–∏–ª–∏ –±–æ–ª—å—à–µ, –µ—Å–ª–∏ already), —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–ª–∏–Ω—É
  const beforeLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  // –°–Ω–∏–º–∞–µ–º –ª–∞–π–∫ —Å–æ 2-–≥–æ —Ç—Ä–µ–∫–∞ (–ù–ï —Ç–µ–∫—É—â–µ–≥–æ)
  await secondRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const afterLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  expect(afterLen).toBeLessThanOrEqual(beforeLen);
});

//=================================================
// FILE: /scripts/e2e/utils.js
// @ts-check
/**
 * scripts/e2e/utils.js
 * –û–±—â–∏–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è Playwright e2e, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤ spec-—Ñ–∞–π–ª–∞—Ö.
 */

export const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';

export async function loginByPromo(page, promo = 'VITRINA2025') {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', promo);
  await page.click('#promo-btn');
  await page.waitForSelector('#main-block:not(.hidden)', { timeout: 10000 });
}

export async function waitTracks(page) {
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
}

export async function likeFirstTrack(page) {
  await waitTracks(page);
  const first = page.locator('#track-list .track').first();
  await first.hover();
  await first.locator('.like-star').click();
}

export async function openFavorites(page) {
  await page.click('.album-icon[data-akey="__favorites__"]');
  await waitTracks(page);
}

export async function playFirstTrack(page) {
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
}

/**
 * –ó–∞–ø–∏—Å–∞—Ç—å PlayerState –≤ localStorage –≤ uid-—Ñ–æ—Ä–º–∞—Ç–µ (V2).
 * –ë–µ—Ä—ë–º playingAlbum –∏–∑ AlbumsManager, –∞ uid/sourceAlbum –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞.
 */
export async function seedPlayerStateV2FromCurrent(page, opts = {}) {
  const position = typeof opts.position === 'number' ? opts.position : 5;
  const wasPlaying = typeof opts.wasPlaying === 'boolean' ? opts.wasPlaying : true;

  await page.evaluate(({ position, wasPlaying }) => {
    const pc = window.playerCore;
    const track = pc?.getCurrentTrack?.() || null;

    const albumKey = window.AlbumsManager?.getPlayingAlbum?.() || null;

    const st = {
      album: albumKey,
      currentAlbum: window.AlbumsManager?.getCurrentAlbum?.() || albumKey,
      trackUid: String(track?.uid || '').trim() || null,
      sourceAlbum: String(track?.sourceAlbum || '').trim() || null,
      trackIndex: typeof pc?.getIndex === 'function' ? (pc.getIndex() || 0) : 0,
      position: Math.floor(position),
      volume: typeof pc?.getVolume === 'function' ? (pc.getVolume() ?? 100) : 100,
      wasPlaying: !!wasPlaying
    };

    localStorage.setItem('playerStateV2', JSON.stringify(st));
  }, { position, wasPlaying });
}

//=================================================
// FILE: /scripts/offline/cache-db.js
// scripts/offline/cache-db.js
// IndexedDB wrapper –¥–ª—è offline-–∫—ç—à–∞ (–¢–ó_–ù—å—é)

const DB_NAME = 'OfflineCacheDB';
const DB_VERSION = 5;

const STORE_AUDIO = 'audioBlobs';
const STORE_BYTES = 'trackBytes';
const STORE_META = 'cacheMeta';
const STORE_CLOUD_STATS = 'cloudStats';
const STORE_CLOUD_CANDIDATE = 'cloudCandidate';
const STORE_GLOBAL_STATS = 'globalStats';

// Meta per (uid:quality) for updates/re-cache (–¢–ó 13)
const STORE_DL_META = 'downloadMeta';

// Local cache meta per uid for eviction/breakdown (–¢–ó 1.3 / 11.2.E / 13)
const STORE_LOCAL_META = 'trackLocalMeta';

let dbPromise = null;

function openDb() {
  if (dbPromise) return dbPromise;

  dbPromise = new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);

    req.onupgradeneeded = (e) => {
      const db = e.target.result;

      if (!db.objectStoreNames.contains(STORE_AUDIO)) {
        db.createObjectStore(STORE_AUDIO);
      }
      if (!db.objectStoreNames.contains(STORE_BYTES)) {
        db.createObjectStore(STORE_BYTES);
      }
      if (!db.objectStoreNames.contains(STORE_META)) {
        db.createObjectStore(STORE_META);
      }
      if (!db.objectStoreNames.contains(STORE_CLOUD_STATS)) {
        db.createObjectStore(STORE_CLOUD_STATS);
      }
      if (!db.objectStoreNames.contains(STORE_CLOUD_CANDIDATE)) {
        db.createObjectStore(STORE_CLOUD_CANDIDATE);
      }
      if (!db.objectStoreNames.contains(STORE_GLOBAL_STATS)) {
        db.createObjectStore(STORE_GLOBAL_STATS);
      }

      if (!db.objectStoreNames.contains(STORE_DL_META)) {
        db.createObjectStore(STORE_DL_META);
      }

      if (!db.objectStoreNames.contains(STORE_LOCAL_META)) {
        db.createObjectStore(STORE_LOCAL_META);
      }
    };

    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });

  return dbPromise;
}

export async function ensureDbReady() {
  await openDb();
}

async function getStore(name, mode = 'readonly') {
  const db = await openDb();
  const tx = db.transaction(name, mode);
  return tx.objectStore(name);
}

function promisifyReq(req) {
  return new Promise((resolve, reject) => {
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

// Audio blobs
export async function getAudioBlob(uid, quality) {
  const key = `${uid}:${quality}`;
  const store = await getStore(STORE_AUDIO);
  return promisifyReq(store.get(key));
}

export async function setAudioBlob(uid, quality, blob) {
  const key = `${uid}:${quality}`;
  const store = await getStore(STORE_AUDIO, 'readwrite');
  return promisifyReq(store.put(blob, key));
}

export async function deleteAudioBlob(uid, quality) {
  const key = `${uid}:${quality}`;
  const store = await getStore(STORE_AUDIO, 'readwrite');
  return promisifyReq(store.delete(key));
}

// Bytes tracking
export async function getBytes(uid, quality) {
  const key = `${uid}:${quality}`;
  const store = await getStore(STORE_BYTES);
  const val = await promisifyReq(store.get(key));
  return Number(val) || 0;
}

export async function setBytes(uid, quality, bytes) {
  const key = `${uid}:${quality}`;
  const store = await getStore(STORE_BYTES, 'readwrite');
  return promisifyReq(store.put(Number(bytes) || 0, key));
}

export async function bytesByQuality(uid) {
  const hi = await getBytes(uid, 'hi');
  const lo = await getBytes(uid, 'lo');
  return { hi, lo };
}

export async function totalCachedBytes() {
  const store = await getStore(STORE_BYTES);
  const keys = await promisifyReq(store.getAllKeys());
  let total = 0;
  for (const k of keys) {
    const v = await promisifyReq(store.get(k));
    total += Number(v) || 0;
  }
  return total;
}

// Cache Quality meta
export async function getCacheQuality() {
  const store = await getStore(STORE_META);
  const val = await promisifyReq(store.get('cacheQuality'));
  return (val === 'lo') ? 'lo' : 'hi';
}

export async function setCacheQuality(q) {
  const store = await getStore(STORE_META, 'readwrite');
  return promisifyReq(store.put(q === 'lo' ? 'lo' : 'hi', 'cacheQuality'));
}

// Cloud stats per track
export async function getCloudStats(uid) {
  const store = await getStore(STORE_CLOUD_STATS);
  return promisifyReq(store.get(uid));
}

export async function setCloudStats(uid, data) {
  const store = await getStore(STORE_CLOUD_STATS, 'readwrite');
  return promisifyReq(store.put(data, uid));
}

export async function clearCloudStats(uid) {
  const store = await getStore(STORE_CLOUD_STATS, 'readwrite');
  return promisifyReq(store.delete(uid));
}

// Cloud candidate flag
export async function getCloudCandidate(uid) {
  const store = await getStore(STORE_CLOUD_CANDIDATE);
  const val = await promisifyReq(store.get(uid));
  return !!val;
}

export async function setCloudCandidate(uid, val) {
  const store = await getStore(STORE_CLOUD_CANDIDATE, 'readwrite');
  return promisifyReq(store.put(!!val, uid));
}

export async function clearCloudCandidate(uid) {
  const store = await getStore(STORE_CLOUD_CANDIDATE, 'readwrite');
  return promisifyReq(store.delete(uid));
}

// Global statistics (–¢–ó 7.11 / 17)
// –•—Ä–∞–Ω–µ–Ω–∏–µ:
// - per-track: key `t:${uid}` => { seconds, fullListens, lastListenAt }
// - totals: key `total` => { totalSeconds }
// Back-compat:
// - key `global` => { totalListenSec, totalFullListens } (–æ—Å—Ç–∞–≤–ª—è–µ–º, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—ã–µ UI –Ω–µ –ø–∞–¥–∞–ª–∏)

function safeUid(v) {
  const s = String(v || '').trim();
  return s || null;
}

export async function updateGlobalStats(uid, deltaSec, deltaFullListens) {
  const u = safeUid(uid);
  if (!u) return false;

  const dSec = Math.max(0, Number(deltaSec) || 0);
  const dFull = Math.max(0, Number(deltaFullListens) || 0);

  const store = await getStore(STORE_GLOBAL_STATS, 'readwrite');

  // per-track
  const tKey = `t:${u}`;
  const prevT = (await promisifyReq(store.get(tKey))) || { seconds: 0, fullListens: 0, lastListenAt: 0 };
  const nextT = {
    seconds: (Number(prevT.seconds) || 0) + dSec,
    fullListens: (Number(prevT.fullListens) || 0) + dFull,
    lastListenAt: Date.now()
  };
  await promisifyReq(store.put(nextT, tKey));

  // totals
  const totalKey = 'total';
  const prevTotal = (await promisifyReq(store.get(totalKey))) || { totalSeconds: 0 };
  const nextTotal = { totalSeconds: (Number(prevTotal.totalSeconds) || 0) + dSec };
  await promisifyReq(store.put(nextTotal, totalKey));

  // Back-compat aggregate (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)
  const prevLegacy = (await promisifyReq(store.get('global'))) || { totalListenSec: 0, totalFullListens: 0 };
  const nextLegacy = {
    totalListenSec: (Number(prevLegacy.totalListenSec) || 0) + dSec,
    totalFullListens: (Number(prevLegacy.totalFullListens) || 0) + dFull
  };
  await promisifyReq(store.put(nextLegacy, 'global'));

  return true;
}

export async function getGlobalStatsAndTotal() {
  const store = await getStore(STORE_GLOBAL_STATS);

  const legacy = (await promisifyReq(store.get('global'))) || { totalListenSec: 0, totalFullListens: 0 };
  const total = (await promisifyReq(store.get('total'))) || { totalSeconds: 0 };

  // –°–æ–±–∏—Ä–∞–µ–º per-track —Å–ø–∏—Å–æ–∫
  const keys = await promisifyReq(store.getAllKeys());
  const tracks = [];
  for (const k of keys) {
    if (typeof k === 'string' && k.startsWith('t:')) {
      const uid = k.slice(2);
      // eslint-disable-next-line no-await-in-loop
      const rec = await promisifyReq(store.get(k));
      tracks.push({
        uid,
        seconds: Number(rec?.seconds) || 0,
        fullListens: Number(rec?.fullListens) || 0,
        lastListenAt: Number(rec?.lastListenAt) || 0
      });
    }
  }

  const totalBytes = await totalCachedBytes();

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏ –Ω–æ–≤—ã–π, –∏ legacy —Ñ–æ—Ä–º–∞—Ç
  return {
    totalBytes,

    // legacy (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â–∏–π offline-modal.js)
    totalListenSec: Number(legacy.totalListenSec) || 0,
    totalFullListens: Number(legacy.totalFullListens) || 0,

    // –Ω–æ–≤—ã–π (–¢–ó 17)
    totalSeconds: Number(total.totalSeconds) || 0,
    tracks
  };
}
// Download meta for updates (–¢–ó 13)
function dlMetaKey(uid, quality) {
  return `${String(uid || '').trim()}:${String(quality || '').toLowerCase() === 'lo' ? 'lo' : 'hi'}`;
}

/**
 * meta shape example:
 * { downloadedAt, bytes, expectedMB, expectedField } where expectedField='size'|'size_low'
 */
export async function getDownloadMeta(uid, quality) {
  const key = dlMetaKey(uid, quality);
  const store = await getStore(STORE_DL_META);
  return promisifyReq(store.get(key));
}

export async function setDownloadMeta(uid, quality, meta) {
  const key = dlMetaKey(uid, quality);
  const store = await getStore(STORE_DL_META, 'readwrite');
  return promisifyReq(store.put(meta || null, key));
}

export async function deleteDownloadMeta(uid, quality) {
  const key = dlMetaKey(uid, quality);
  const store = await getStore(STORE_DL_META, 'readwrite');
  return promisifyReq(store.delete(key));
}

// Delete track cache
export async function deleteTrackCache(uid) {
  const u = String(uid || '').trim();
  if (!u) return;

  // –°–Ω–∞—á–∞–ª–∞ –æ—Å–≤–æ–±–æ–¥–∏–º objectURL (–µ—Å–ª–∏ —Ç—Ä–µ–∫ –∫–æ–≥–¥–∞-–ª–∏–±–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–ª—Å—è –∫–∞–∫ blob)
  try {
    const mod = await import('./track-resolver.js');
    if (typeof mod.revokeObjectUrlsForUid === 'function') mod.revokeObjectUrlsForUid(u);
  } catch {}

  await deleteAudioBlob(u, 'hi');
  await deleteAudioBlob(u, 'lo');

  const storeBytes = await getStore(STORE_BYTES, 'readwrite');
  await promisifyReq(storeBytes.delete(`${u}:hi`));
  await promisifyReq(storeBytes.delete(`${u}:lo`));

  // meta for updates
  try { await deleteDownloadMeta(u, 'hi'); } catch {}
  try { await deleteDownloadMeta(u, 'lo'); } catch {}

  // local meta
  try {
    const storeLocal = await getStore(STORE_LOCAL_META, 'readwrite');
    await promisifyReq(storeLocal.delete(u));
  } catch {}
}

// Clear all
export async function clearAllStores(opts = {}) {
  const keepCacheQuality = !!opts?.keepCacheQuality;
  const cq = keepCacheQuality ? await getCacheQuality() : null;

  const db = await openDb();
  const storeNames = [STORE_AUDIO, STORE_BYTES, STORE_CLOUD_STATS, STORE_CLOUD_CANDIDATE, STORE_DL_META, STORE_LOCAL_META];

  for (const name of storeNames) {
    const tx = db.transaction(name, 'readwrite');
    const store = tx.objectStore(name);
    await promisifyReq(store.clear());
  }

  if (keepCacheQuality && cq) {
    await setCacheQuality(cq);
  }

  return true;
}

// ===== Local meta (kind/LRU/transient grouping) =====
// kind: 'cloud' | 'transient' | 'unknown'
// transientGroup: 'window' | 'extra' | null
// lastAccessAt: number (ms)

export async function getLocalMeta(uid) {
  const u = String(uid || '').trim();
  if (!u) return null;
  const store = await getStore(STORE_LOCAL_META);
  return promisifyReq(store.get(u));
}

export async function setLocalMeta(uid, meta) {
  const u = String(uid || '').trim();
  if (!u) return false;
  const store = await getStore(STORE_LOCAL_META, 'readwrite');
  await promisifyReq(store.put(meta || null, u));
  return true;
}

export async function touchLocalAccess(uid) {
  const u = String(uid || '').trim();
  if (!u) return false;

  const prev = (await getLocalMeta(u)) || {};
  const next = {
    ...prev,
    lastAccessAt: Date.now(),
  };
  await setLocalMeta(u, next);
  return true;
}

export async function markLocalCloud(uid) {
  const u = String(uid || '').trim();
  if (!u) return false;

  const prev = (await getLocalMeta(u)) || {};
  const next = {
    ...prev,
    kind: 'cloud',
    transientGroup: null,
    lastAccessAt: Date.now(),
  };
  await setLocalMeta(u, next);
  return true;
}

export async function markLocalTransient(uid, group = 'window') {
  const u = String(uid || '').trim();
  if (!u) return false;

  const g = (group === 'extra') ? 'extra' : 'window';

  const prev = (await getLocalMeta(u)) || {};
  // cloud –Ω–µ –ø–æ–Ω–∏–∂–∞–µ–º –¥–æ transient (–µ—Å–ª–∏ —É–∂–µ cloud)
  const kind = (prev.kind === 'cloud') ? 'cloud' : 'transient';

  const next = {
    ...prev,
    kind,
    transientGroup: (kind === 'transient') ? g : null,
    lastAccessAt: Date.now(),
  };
  await setLocalMeta(u, next);
  return true;
}

export async function computeCacheBreakdown(pinnedSet = new Set()) {
  // —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ audio bytes (hi+lo) –ø–æ uid
  const storeBytes = await getStore(STORE_BYTES);
  const keys = await promisifyReq(storeBytes.getAllKeys());

  const uidSet = new Set();
  for (const k of keys) {
    const uid = String(k).split(':')[0];
    if (uid) uidSet.add(uid);
  }

  let pinnedBytes = 0;
  let cloudBytes = 0;
  let windowTransientBytes = 0;
  let extraTransientBytes = 0;
  let unknownTransientBytes = 0;

  for (const uid of uidSet) {
    const hiB = await getBytes(uid, 'hi');
    const loB = await getBytes(uid, 'lo');
    const bytes = hiB + loB;

    if (pinnedSet.has(uid)) {
      pinnedBytes += bytes;
      continue;
    }

    const meta = await getLocalMeta(uid);
    const kind = String(meta?.kind || 'unknown');
    const tg = String(meta?.transientGroup || '');

    if (kind === 'cloud') {
      cloudBytes += bytes;
    } else if (kind === 'transient') {
      if (tg === 'extra') extraTransientBytes += bytes;
      else if (tg === 'window') windowTransientBytes += bytes;
      else unknownTransientBytes += bytes;
    } else {
      // –±–µ–∑ –º–µ—Ç—ã —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ transient/unknown (—É–¥–∞–ª—è–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ cloud)
      unknownTransientBytes += bytes;
    }
  }

  return {
    pinnedBytes,
    cloudBytes,
    transientWindowBytes: windowTransientBytes,
    transientExtraBytes: extraTransientBytes,
    transientUnknownBytes: unknownTransientBytes,
    audioTotalBytes: pinnedBytes + cloudBytes + windowTransientBytes + extraTransientBytes + unknownTransientBytes
  };
}

// Eviction candidates (–¢–ó 1.3 / 13):
// - pinned –∏—Å–∫–ª—é—á–∞–µ–º
// - –ø–æ—Ä—è–¥–æ–∫: extra transient -> window transient -> unknown transient -> cloud
// - –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã: LRU –ø–æ lastAccessAt (—Å—Ç–∞—Ä—ã–µ —É–¥–∞–ª—è–µ–º –ø–µ—Ä–≤—ã–º–∏)
export async function getEvictionCandidates(pinnedSet = new Set()) {
  const storeBytes = await getStore(STORE_BYTES);
  const bytesKeys = await promisifyReq(storeBytes.getAllKeys());

  const uidSet = new Set();
  for (const k of bytesKeys) {
    const uid = String(k).split(':')[0];
    if (uid && !pinnedSet.has(uid)) uidSet.add(uid);
  }

  const candidates = [];
  for (const uid of uidSet) {
    const hiB = await getBytes(uid, 'hi');
    const loB = await getBytes(uid, 'lo');
    const bytes = hiB + loB;

    const meta = await getLocalMeta(uid);
    const kind = String(meta?.kind || 'unknown');
    const tg = String(meta?.transientGroup || '');
    const lastAccessAt = Number(meta?.lastAccessAt || 0) || 0;

    // weight: –º–µ–Ω—å—à–µ = —É–¥–∞–ª—è–µ–º —Ä–∞–Ω—å—à–µ
    // transient extra=0, transient window=1, transient unknown=2, cloud=3
    let weight = 2;
    if (kind === 'cloud') weight = 3;
    else if (kind === 'transient' && tg === 'extra') weight = 0;
    else if (kind === 'transient' && tg === 'window') weight = 1;
    else if (kind === 'transient') weight = 2;
    else weight = 2;

    candidates.push({ uid, bytes, lastAccessAt, weight, kind, transientGroup: tg });
  }

  candidates.sort((a, b) => (a.weight - b.weight) || (a.lastAccessAt - b.lastAccessAt));
  return candidates;
}

// Expired cloud
export async function getExpiredCloudUids() {
  const store = await getStore(STORE_CLOUD_STATS);
  const allStats = await promisifyReq(store.getAll());
  const allKeys = await promisifyReq(store.getAllKeys());

  const now = Date.now();
  const expired = [];

  for (let i = 0; i < allKeys.length; i++) {
    const uid = allKeys[i];
    const st = allStats[i];

    if (st?.cloud === true) {
      const exp = Number(st?.cloudExpiresAt || 0);
      if (exp > 0 && exp < now) {
        expired.push(uid);
      }
    }
  }

  return expired;
}

//=================================================
// FILE: /scripts/offline/net-policy.js
// scripts/offline/net-policy.js
// –ü–æ–ª–∏—Ç–∏–∫–∞ —Å–µ—Ç–∏ –¥–ª—è offline-–∑–∞–≥—Ä—É–∑–æ–∫ (–¢–ó 11)

const LS_KEY = 'offline:netPolicy:v1';

const DEFAULT_POLICY = {
  wifiOnly: false,
  allowMobile: true,
  confirmOnMobile: false,
  saveDataBlock: true
};

export function getNetPolicy() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return { ...DEFAULT_POLICY };
    const j = JSON.parse(raw);
    return { ...DEFAULT_POLICY, ...j };
  } catch {
    return { ...DEFAULT_POLICY };
  }
}

export function setNetPolicy(next) {
  const cur = getNetPolicy();
  const merged = { ...cur, ...next };
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(merged));
  } catch {}
  return merged;
}

export function isAllowedByNetPolicy(params = {}) {
  const policy = params.policy || getNetPolicy();
  const net = params.net || { online: true, kind: 'unknown', saveData: false };
  const userInitiated = !!params.userInitiated;

  if (!net.online) return false;

  if (policy.saveDataBlock && net.saveData) {
    return userInitiated;
  }

  const kind = String(net.kind || '').toLowerCase();

  if (policy.wifiOnly && kind !== 'wifi') {
    return userInitiated;
  }

  if (!policy.allowMobile && (kind === 'cellular' || kind === '4g' || kind === '3g' || kind === '2g')) {
    return userInitiated;
  }

  return true;
}

export function shouldConfirmByPolicy(params = {}) {
  const policy = params.policy || getNetPolicy();
  const net = params.net || { online: true, kind: 'unknown' };

  const kind = String(net.kind || '').toLowerCase();
  const isMobile = (kind === 'cellular' || kind === '4g' || kind === '3g' || kind === '2g');

  return !!(policy.confirmOnMobile && isMobile);
}

//=================================================
// FILE: /scripts/offline/offline-manager.js
// scripts/offline/offline-manager.js
// OfflineManager (ESM) ‚Äî –µ–¥–∏–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä CQ/pinned/cloud/queue (–¢–ó_–ù–¨–Æ)
// –í–∞–∂–Ω–æ: –ù–ï —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º (–Ω–µ –¥–µ–ª–∞–µ—Ç stop/play/seek)

import {
  bytesByQuality,
  deleteTrackCache,
  getCacheQuality,
  setCacheQuality,
  ensureDbReady,
  getAudioBlob,
  setAudioBlob,
  setBytes,
  getCloudStats,
  setCloudStats,
  clearCloudStats,
  getCloudCandidate,
  setCloudCandidate,
  clearCloudCandidate,
  totalCachedBytes,
  clearAllStores,
  updateGlobalStats,
  getGlobalStatsAndTotal,
  getEvictionCandidates,
  getExpiredCloudUids,
  getDownloadMeta,
  setDownloadMeta,
  markLocalCloud,
  markLocalTransient
} from './cache-db.js';

import { resolvePlaybackSource, isTrackAvailableOffline } from './track-resolver.js';
import { getTrackByUid } from '../app/track-registry.js';
import { getNetPolicy, isAllowedByNetPolicy, shouldConfirmByPolicy } from './net-policy.js';

const LS = {
  OFFLINE_MODE: 'offlineMode:v1',
  CQ: 'offline:cacheQuality:v1',
  PINNED: 'pinnedUids:v1',
  CLOUD_N: 'offline:cloudN:v1',
  CLOUD_D: 'offline:cloudD:v1',
  ALERT: 'offline:alert:v1',
};

const MB = 1024 * 1024;
const DEFAULT_CACHE_LIMIT_MB = 500;
// –¢–ó 14.2: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ—á–µ—Ä–µ–¥–∏ (1 –∞–∫—Ç–∏–≤–Ω–∞—è –∞—É–¥–∏–æ-–∑–∞–≥—Ä—É–∑–∫–∞)
// –í–∞–∂–Ω–æ: playback-cache (P0/P1) –∑–∞–¥–∞—ë—Ç—Å—è –≤ playback-cache.js –µ—â—ë –≤—ã—à–µ (100/90).
const DL_PRIORITY = {
  P2_PINNED: 80,
  P3_UPDATES: 70,     // updates / re-cache
  P4_CLOUD_FILL: 60,  // cloud fill / cloud-candidate
  P5_OFFLINE_ALL: 50  // 100% OFFLINE (–º–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
};

function normUid(v) {
  const s = String(v || '').trim();
  return s || null;
}

function normQ(v) {
  return String(v || '').toLowerCase() === 'lo' ? 'lo' : 'hi';
}

function readJson(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    const j = JSON.parse(raw);
    return (j === null || j === undefined) ? fallback : j;
  } catch {
    return fallback;
  }
}

function writeJson(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
}

function getNetworkStatusSafe() {
  const fn = window.Utils?.getNetworkStatusSafe;
  if (typeof fn === 'function') return fn();
  return { online: navigator.onLine !== false, kind: 'unknown', saveData: false };
}

function readCloudN() {
  const raw = Number(localStorage.getItem(LS.CLOUD_N) || 5);
  const n = Number.isFinite(raw) ? Math.floor(raw) : 5;
  return Math.max(1, Math.min(50, n));
}

function readCloudD() {
  const raw = Number(localStorage.getItem(LS.CLOUD_D) || 31);
  const d = Number.isFinite(raw) ? Math.floor(raw) : 31;
  return Math.max(1, Math.min(365, d));
}

function setAlert(on, reason) {
  try {
    localStorage.setItem(LS.ALERT, JSON.stringify({
      on: !!on,
      ts: Date.now(),
      reason: String(reason || '')
    }));
  } catch {}
  try { window.dispatchEvent(new CustomEvent('offline:uiChanged')); } catch {}
}

class Emitter {
  constructor() { this._m = new Map(); }
  on(type, cb) {
    const arr = this._m.get(type) || [];
    arr.push(cb);
    this._m.set(type, arr);
    return () => this._m.set(type, (this._m.get(type) || []).filter(fn => fn !== cb));
  }
  emit(type, payload) {
    (this._m.get(type) || []).forEach(fn => { try { fn(payload); } catch {} });
  }
}

class DownloadQueue {
  constructor({ onProgress } = {}) {
    this._items = [];
    this._running = false;
    this._runningKey = null;
    this._paused = false;
    this._onProgress = (typeof onProgress === 'function') ? onProgress : null;
  }

  size() { return this._items.length; }
  isRunning() { return this._running; }
  isPaused() { return this._paused; }

  hasTask(key) {
    const k = String(key || '').trim();
    if (!k) return false;
    if (this._runningKey === k) return true;
    return this._items.some(t => String(t?.key || '').trim() === k);
  }

  add(task) {
    if (!task || typeof task.run !== 'function') return;

    const pr = Number(task.priority || 0);
    const item = { ...task, priority: Number.isFinite(pr) ? pr : 0, __ts: Date.now() };

    const idx = this._items.findIndex(t => Number(t?.priority || 0) < item.priority);
    if (idx === -1) this._items.push(item);
    else this._items.splice(idx, 0, item);

    this._tick();
  }

  pause() { this._paused = true; }
  resume() { this._paused = false; this._tick(); }

  async _tick() {
    if (this._running || this._paused) return;
    
    const task = this._items.shift();
    if (!task) return;

    this._running = true;
    this._runningKey = String(task.key || '') || null;

    try {
      this._onProgress?.({ uid: task.uid || null, phase: 'start', key: task.key || '' });
      await task.run();
      this._onProgress?.({ uid: task.uid || null, phase: 'done', key: task.key || '' });
    } catch (e) {
      this._onProgress?.({ uid: task.uid || null, phase: 'error', key: task.key || '', error: String(e?.message || e) });
    } finally {
      this._running = false;
      this._runningKey = null;
      this._tick();
    }
  }
}

export class OfflineManager {
  constructor() {
    this._em = new Emitter();
    this._initialized = false;

    this.mass = {
      active: false,
      total: 0,
      done: 0,
      error: 0,
      skipped: 0,
      startedAt: 0
    };

    this.queue = new DownloadQueue({
      onProgress: (ev) => this._em.emit('progress', ev)
    });

    // ‚úÖ –ê–≥—Ä–µ–≥–∞—Ç—ã –¥–ª—è OFFLINE modal (—á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å await-loop –ø–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º)
    this._needs = {
      ready: false,
      totalTracked: 0,
      needsUpdate: 0,
      needsReCache: 0,
      lastComputedAt: 0
    };
  }

  async initialize() {
    if (this._initialized) return;
    this._initialized = true;

    try { await ensureDbReady(); } catch {}

    this._checkExpiredCloud();
    setInterval(() => this._checkExpiredCloud(), 60 * 60 * 1000);

    // ‚úÖ –§–æ–Ω–æ–≤—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ (best-effort; –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º initialize)
    try { this.refreshNeedsAggregates({ force: true }); } catch {}
  }

  on(type, cb) { return this._em.on(type, cb); }

  // Offline mode
  isOfflineMode() {
    try { return localStorage.getItem(LS.OFFLINE_MODE) === '1'; } catch { return false; }
  }

  setOfflineMode(enabled) {
    try { localStorage.setItem(LS.OFFLINE_MODE, enabled ? '1' : '0'); } catch {}
    try { window.dispatchEvent(new CustomEvent('offline:uiChanged')); } catch {}
  }

  // Cache Quality (CQ)
  async getCacheQuality() {
    try {
      const cq = String(localStorage.getItem(LS.CQ) || '').toLowerCase();
      if (cq === 'hi' || cq === 'lo') return cq;
    } catch {}
    return getCacheQuality();
  }

  async setCacheQuality(cq) {
    const v = normQ(cq);
    try { localStorage.setItem(LS.CQ, v); } catch {}
    try { await setCacheQuality(v); } catch {}

    this._em.emit('progress', { uid: null, phase: 'cqChanged', cq: v });

    // –¢–ó 5.2: —Å–º–µ–Ω–∞ CQ –ø–æ–º–µ—á–∞–µ—Ç pinned/cloud –∫–∞–∫ needsReCache –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–∏—Ö—É—é –∑–∞–º–µ–Ω—É "–ø–æ –æ–¥–Ω–æ–º—É".
    // –ú—ã –Ω–µ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ–≥–æ: blob –∑–∞–º–µ–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
    setAlert(true, '–ò–∑–º–µ–Ω–µ–Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ –∫—ç—à–∞. –ó–∞–ø—É—â–µ–Ω re-cache pinned/cloud.');

    try {
      // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI: —Å—Ç–∞–≤–∏–º –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å –∏ –≤—ã—Ö–æ–¥–∏–º.
      this.enqueueReCacheAllByCQ({ userInitiated: false });
    } catch {}

    return v;
  }

  // Cloud settings
  getCloudSettings() {
    return { n: readCloudN(), d: readCloudD() };
  }

  setCloudSettings(next = {}) {
    const nRaw = Number(next?.n);
    const dRaw = Number(next?.d);

    const n = Number.isFinite(nRaw) ? Math.floor(nRaw) : readCloudN();
    const d = Number.isFinite(dRaw) ? Math.floor(dRaw) : readCloudD();

    const safeN = Math.max(1, Math.min(50, n));
    const safeD = Math.max(1, Math.min(365, d));

    try { localStorage.setItem(LS.CLOUD_N, String(safeN)); } catch {}
    try { localStorage.setItem(LS.CLOUD_D, String(safeD)); } catch {}

    this._em.emit('progress', { uid: null, phase: 'cloudSettingsChanged', n: safeN, d: safeD });
    return { n: safeN, d: safeD };
  }

  // Pinned
  _getPinnedSet() {
    const arr = readJson(LS.PINNED, []);
    const uids = Array.isArray(arr) ? arr.map(x => String(x || '').trim()).filter(Boolean) : [];
    return new Set(uids);
  }

  _setPinnedSet(set) {
    writeJson(LS.PINNED, Array.from(set));
  }

  getPinnedUids() {
    return Array.from(this._getPinnedSet());
  }

  isPinned(uid) {
    return this._getPinnedSet().has(normUid(uid) || '');
  }

  async pin(uid) {
    const u = normUid(uid);
    if (!u) return false;

    const set = this._getPinnedSet();
    if (!set.has(u)) {
      set.add(u);
      this._setPinnedSet(set);
    }

    try { await setCloudCandidate(u, false); } catch {}

    this.enqueuePinnedDownload(u, { userInitiated: true });

    window.NotificationSystem?.info('–¢—Ä–µ–∫ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ñ–ª–∞–π–Ω. –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ‚Ä¶', 3500);
    this._em.emit('progress', { uid: u, phase: 'pinned' });
    return true;
  }

  async unpin(uid) {
    const u = normUid(uid);
    if (!u) return false;

    const set = this._getPinnedSet();
    if (set.has(u)) {
      set.delete(u);
      this._setPinnedSet(set);
    }

    try { await setCloudCandidate(u, true); } catch {}

    window.NotificationSystem?.info('–û—Ñ–ª–∞–π–Ω-–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–Ω—è—Ç–æ. –¢—Ä–µ–∫ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å Cloud ‚òÅ', 3500);

    const cq = await this.getCacheQuality();
    this.enqueueAudioDownload({
      uid: u,
      quality: cq,
      key: `cloudCandidate:${cq}:${u}`,
      priority: DL_PRIORITY.P4_CLOUD_FILL,
      userInitiated: false,
      isMass: false,
      kind: 'cloudCandidate'
    });

    this._em.emit('progress', { uid: u, phase: 'unpinned' });
    return true;
  }

  enqueuePinnedDownload(uid, opts = {}) {
    const u = normUid(uid);
    if (!u) return;

    const userInitiated = !!opts?.userInitiated;
    this.getCacheQuality().then((cq) => {
      this.enqueueAudioDownload({
        uid: u,
        quality: cq,
        key: `pinned:${cq}:${u}`,
        priority: DL_PRIORITY.P2_PINNED,
        userInitiated,
        isMass: false,
        kind: 'pinned'
      });
    }).catch(() => {});
  }

  enqueuePinnedDownloadAll() {
    const list = this.getPinnedUids();
    list.forEach((uid) => this.enqueuePinnedDownload(uid, { userInitiated: true }));
    this._em.emit('progress', { uid: null, phase: 'pinnedQueueEnqueued', count: list.length });
  }

  // –¢–ó 13: "–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã" ‚Äî —Ç–∏—Ö–æ, –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ playback.
  // v1.0: –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ pinned –∏ cloud (transient –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –º–µ—Ç–∞-—Å–ª–æ—è).
  async enqueueUpdateAll() {
    const cq = await this.getCacheQuality();

    const pinned = this.getPinnedUids();

    // cloud: —Ç–µ, —É –∫–æ–≥–æ cloud=true (eligible –ø–æ TTL) ‚Äî –≤–æ–∑—å–º—ë–º —á–µ—Ä–µ–∑ stats
    // –í v1.0 –Ω–µ—Ç getAllCloudUids, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–π–¥—ë–º –ø–æ –≤—Å–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ç—Ä–µ–∫–∞–º –≤ —Ä–µ–µ—Å—Ç—Ä–µ
    const all = (typeof window.TrackRegistry?.getAllTracks === 'function')
      ? window.TrackRegistry.getAllTracks()
      : [];

    const cloudUids = [];
    for (const t of all) {
      const uid = normUid(t?.uid);
      if (!uid) continue;
      if (this._getPinnedSet().has(uid)) continue;
      // eslint-disable-next-line no-await-in-loop
      const eligible = await this.isCloudEligible(uid);
      if (eligible) cloudUids.push(uid);
    }

    const uniqPinned = Array.from(new Set(pinned));
    const uniqCloud = Array.from(new Set(cloudUids));

    const plan = uniqPinned.concat(uniqCloud);

    plan.forEach((uid) => {
      this.enqueueAudioDownload({
        uid,
        quality: cq,
        key: `update:${cq}:${uid}`,
        priority: DL_PRIORITY.P3_UPDATES, // P3
        userInitiated: false,
        isMass: true,
        kind: 'update'
      });
    });

    setAlert(true, '–ó–∞–ø—É—â–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤.');
    this._em.emit('progress', { uid: null, phase: 'updatesEnqueued', count: plan.length });
    return { ok: true, count: plan.length };
  }

  // –¢–ó 5.2: "–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –∑–∞–º–µ–Ω–∞" –ø—Ä–∏ —Å–º–µ–Ω–µ CQ.
  // –í v1.0 –¥–µ–ª–∞–µ–º —Å—Ç—Ä–æ–≥–æ: re-cache —Ç–æ–ª—å–∫–æ pinned + cloud (eligible), –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç P3.
  // –°—Ç–∞—Ä—ã–µ –∫–æ–ø–∏–∏ –Ω–µ —É–¥–∞–ª—è–µ–º –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –Ω–æ–≤—ã—Ö: overwrite –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è blob.
  async enqueueReCacheAllByCQ(opts = {}) {
    const cq = await this.getCacheQuality();
    const userInitiated = !!opts.userInitiated;

    const pinned = this.getPinnedUids();

    // cloud: –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ä–µ–µ—Å—Ç—Ä—É TrackRegistry (–≤ –∏–¥–µ–∞–ª–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å preloaded)
    const all = (typeof window.TrackRegistry?.getAllTracks === 'function')
      ? window.TrackRegistry.getAllTracks()
      : [];

    const cloudUids = [];
    for (const t of all) {
      const uid = normUid(t?.uid);
      if (!uid) continue;
      if (this._getPinnedSet().has(uid)) continue;
      // eslint-disable-next-line no-await-in-loop
      const eligible = await this.isCloudEligible(uid);
      if (eligible) cloudUids.push(uid);
    }

    const uniqPinned = Array.from(new Set(pinned));
    const uniqCloud = Array.from(new Set(cloudUids));

    // –ü–æ—Ä—è–¥–æ–∫ –ø–æ –¢–ó 5.2: pinned -> cloud -> extra transient
    const plan = uniqPinned.concat(uniqCloud);

    let count = 0;

    for (const uid of plan) {
      const u = normUid(uid);
      if (!u) continue;

      // –ï—Å–ª–∏ —É–∂–µ –≤ CQ –ø–æ–ª–Ω–∞—è –∫–æ–ø–∏—è ‚Äî –Ω–µ —Å—Ç–∞–≤–∏–º –∑–∞–¥–∞—á—É.
      // eslint-disable-next-line no-await-in-loop
      const cqComplete = await this.isTrackComplete(u, cq);
      if (cqComplete) continue;

      this.enqueueAudioDownload({
        uid: u,
        quality: cq,
        key: `recache:${cq}:${u}`,
        priority: DL_PRIORITY.P3_UPDATES, // P3
        userInitiated,
        isMass: true,
        kind: 'recache'
      });

      count++;
    }

    if (count > 0) {
      this._em.emit('progress', { uid: null, phase: 'recacheEnqueued', count, cq });
      setAlert(true, '–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
    }

    return { ok: true, count, cq };
  }

  // Track cache state
  async isTrackComplete(uid, quality) {
    const u = normUid(uid);
    if (!u) return false;

    const q = normQ(quality);
    const meta = getTrackByUid(u);
    if (!meta) return false;

    const needMb = (q === 'hi')
      ? Number(meta.sizeHi || meta.size || 0)
      : Number(meta.sizeLo || meta.size_low || 0);

    if (!(Number.isFinite(needMb) && needMb > 0)) return false;
    const needBytes = Math.floor(needMb * MB);

    const have = await bytesByQuality(u);
    const got = (q === 'hi') ? Number(have.hi || 0) : Number(have.lo || 0);
    if (!(Number.isFinite(got) && got > 0)) return false;

    return got >= Math.floor(needBytes * 0.92);
  }

  async hasAnyComplete(uids) {
    const list = Array.isArray(uids) ? uids : [];
    if (!list.length) return false;

    const cq = await this.getCacheQuality();
    const alt = cq === 'hi' ? 'lo' : 'hi';

    for (const uid of list) {
      if (await this.isTrackComplete(uid, cq)) return true;
    }
    for (const uid of list) {
      if (await this.isTrackComplete(uid, alt)) return true;
    }
    return false;
  }

  async getCacheSizeBytes() {
    return totalCachedBytes();
  }

  async getCacheBreakdown() {
    try {
      const pinnedSet = this._getPinnedSet();
      // computeCacheBreakdown —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑ cache-db.js
      const { computeCacheBreakdown } = await import('./cache-db.js');
      return computeCacheBreakdown(pinnedSet);
    } catch {
      return null;
    }
  }

  async clearAllCache() {
    try {
      const ok = await clearAllStores({ keepCacheQuality: true });
      this._setPinnedSet(new Set());
      this._em.emit('progress', { uid: null, phase: 'allCacheCleared' });
      setAlert(false, '');
      return !!ok;
    } catch {
      return false;
    }
  }

  // Queue API
  enqueueAudioDownload(params = {}) {
    const u = normUid(params?.uid);
    if (!u) return { ok: false, reason: 'noUid' };

    const q = normQ(params?.quality);
    const kind = String(params?.kind || '').trim() || 'generic';
    const userInitiated = !!params?.userInitiated;
    const isMass = !!params?.isMass;

    const pr = Number(params?.priority || 0);
    const priority = Number.isFinite(pr) ? pr : 0;

    const key = String(params?.key || '').trim() || `${kind}:${q}:${u}`;
    const onResult = (typeof params?.onResult === 'function') ? params.onResult : null;

    if (this.queue.hasTask(key)) return { ok: true, enqueued: false, dedup: true, key };

    this.queue.add({
      key,
      uid: u,
      priority,
      run: async () => {
        const r = await this.cacheTrackAudio(u, q, { userInitiated, isMass, kind });
        try { onResult?.(r); } catch {}
      }
    });

    return { ok: true, enqueued: true, key };
  }

  // 100% OFFLINE
  async startFullOffline(uids) {
    const uniq = Array.from(new Set((Array.isArray(uids) ? uids : [])
      .map(x => String(x || '').trim())
      .filter(Boolean)));

    if (!uniq.length) return { ok: false, reason: 'empty' };

    await this.checkEviction();

    this.mass = {
      active: true,
      total: uniq.length,
      done: 0,
      error: 0,
      skipped: 0,
      startedAt: Date.now()
    };

    this._em.emit('progress', { uid: null, phase: 'offlineAllStart', total: uniq.length });

    const cq = await this.getCacheQuality();

    uniq.forEach((uid) => {
      const u = String(uid || '').trim();
      const taskKey = `offlineAll:${cq}:${u}`;

      this.enqueueAudioDownload({
        uid: u,
        quality: cq,
        key: taskKey,
        priority: DL_PRIORITY.P5_OFFLINE_ALL,
        userInitiated: false,
        isMass: true,
        kind: 'offlineAll',
        onResult: (r) => {
          if (r?.ok) this.mass.done++;
          else if (String(r?.reason || '').includes('Skipped')) this.mass.skipped++;
          else this.mass.error++;

          if (this.mass.done + this.mass.error + this.mass.skipped >= this.mass.total) {
            this.mass.active = false;
            this._em.emit('progress', { uid: null, phase: 'offlineAllDone', ...this.mass });
            window.NotificationSystem?.success('–ó–∞–≥—Ä—É–∑–∫–∞ 100% OFFLINE –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
          }
        }
      });
    });

    return { ok: true, total: uniq.length };
  }

  getMassStatus() { return { ...this.mass }; }

  // Queue control (–¢–ó 11.2.F)
  pauseQueue() { try { this.queue?.pause?.(); } catch {} }
  resumeQueue() { try { this.queue?.resume?.(); } catch {} }

  getQueueStatus() {
    return {
      downloadingKey: this.queue?._runningKey || null,
      downloading: this.queue?.isRunning?.() || false,
      paused: this.queue?.isPaused?.() || false,
      queued: this.queue?.size?.() || 0
    };
  }

  // ===== 100% OFFLINE helpers (–¢–ó 11.2.I) =====
  // selection: { mode: 'favorites'|'albums', albumKeys?: string[] }
  async computeSizeEstimate(selection = {}) {
    const cq = await this.getCacheQuality();

    const toMb = (v) => {
      const n = Number(v);
      return (Number.isFinite(n) && n > 0) ? n : 0;
    };

    const uniq = (arr) => Array.from(new Set((Array.isArray(arr) ? arr : []).map(x => String(x || '').trim()).filter(Boolean)));

    // –°–æ–±–∏—Ä–∞–µ–º uid-—ã –Ω–∞–±–æ—Ä–∞
    let uids = [];
    if (selection.mode === 'favorites') {
      // "—Ç–æ–ª—å–∫–æ –ò–ó–ë–†–ê–ù–ù–û–ï" = –≤—Å–µ ‚≠ê (liked) –∏–∑ –æ–±—ã—á–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤ (–ø–æ storage likedTrackUids:v1).
      // –ë–µ—Ä—ë–º –ø–æ –∫–∞–∂–¥–æ–º—É –∞–ª—å–±–æ–º—É (–∫—Ä–æ–º–µ special) –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º uid.
      const pc = window.playerCore;
      const idx = Array.isArray(window.albumsIndex) ? window.albumsIndex : [];
      const all = [];

      if (pc?.getLikedUidsForAlbum) {
        for (const a of idx) {
          const key = String(a?.key || '').trim();
          if (!key || key.startsWith('__')) continue;
          const arr = pc.getLikedUidsForAlbum(key) || [];
          if (Array.isArray(arr) && arr.length) all.push(...arr.map(x => String(x || '').trim()));
        }
      }

      uids = uniq(all);
    } else if (selection.mode === 'albums') {
      const keys = uniq(selection.albumKeys);
      const allTracks = (typeof window.TrackRegistry?.getAllTracks === 'function')
        ? window.TrackRegistry.getAllTracks()
        : (typeof window.getAllTracks === 'function' ? window.getAllTracks() : []);
      // –í —Ç–≤–æ—ë–º –ø—Ä–æ–µ–∫—Ç–µ getAllTracks —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑ scripts/app/track-registry.js, –Ω–æ –≤ window –æ–Ω –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è.
      // –ü–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–µ—Å—Ç—Ä —á–µ—Ä–µ–∑ Offline preload (preloadAllAlbumsTrackIndex) –∏ getTrackByUid.
      // –ó–¥–µ—Å—å –æ—Ü–µ–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ uid, –Ω–∞–π–¥–µ–Ω–Ω—ã–º –≤ TrackRegistry Map —á–µ—Ä–µ–∑ window.OfflineUI preload.
      uids = uniq(allTracks
        .filter(t => keys.includes(String(t?.sourceAlbum || t?.albumKey || t?.album || '').trim()))
        .map(t => String(t?.uid || '').trim()));
    } else {
      return { ok: false, reason: 'badSelection', tracksMB: 0, coversMB: 0, lyricsMB: 0, totalMB: 0, count: 0 };
    }

    // –û—Ü–µ–Ω–∫–∞ –ø–æ size/size_low –∏–∑ TrackRegistry
    let tracksMB = 0;
    for (const uid of uids) {
      const meta = getTrackByUid(uid);
      if (!meta) continue;
      const mb = (cq === 'lo')
        ? (toMb(meta.sizeLo || meta.size_low) || toMb(meta.sizeHi || meta.size))
        : (toMb(meta.sizeHi || meta.size) || toMb(meta.sizeLo || meta.size_low));
      tracksMB += mb;
    }

    // assets (covers/lyrics/fulltext) ‚Äî –≤ v1.0 —Å—á–∏—Ç–∞–µ–º 0 –≤ –º–µ–≥–∞–±–∞–π—Ç–∞—Ö, –Ω–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–≥—Ä–µ–µ–º SW shell/urls.
    const coversMB = 0;
    const lyricsMB = 0;
    const totalMB = tracksMB + coversMB + lyricsMB;

    return { ok: true, cq, tracksMB, coversMB, lyricsMB, totalMB, count: uids.length, uids };
  }

  async canGuaranteeStorageForMB(totalMB) {
    const needBytes = Math.floor((Number(totalMB) || 0) * MB);

    // iOS –∏ –≤–æ–æ–±—â–µ: –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å—á–∏—Ç–∞–µ–º "–Ω–µ–ª—å–∑—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å"
    try {
      if (navigator.storage && typeof navigator.storage.estimate === 'function') {
        const est = await navigator.storage.estimate();
        const quota = Number(est?.quota || 0);
        const usage = Number(est?.usage || 0);
        if (quota > 0) {
          const free = Math.max(0, quota - usage);
          // –∑–∞–ø–∞—Å 10%
          const ok = free >= needBytes * 1.1;
          return { ok, quota, usage, free };
        }
      }
    } catch {}

    return { ok: false, unknown: true };
  }

  // back-compat (—á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç–∞—Ä—ã–π UI –≤ –∏—Å—Ç–æ—Ä–∏–∏)
  async _canGuaranteeStorageForMB(totalMB) {
    return this.canGuaranteeStorageForMB(totalMB);
  }

  async startFullOfflineSelection(selection = {}) {
    // Confirm Unknown network (–¢–ó 11.2.D + 11.2.I)
    const policy = getNetPolicy();
    const net = getNetworkStatusSafe();

    if (!net.online) return { ok: false, reason: 'offline' };

    // Unknown type confirm (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ: kind === 'unknown' => confirm –¥–ª—è mass)
    const kind = String(net.kind || '').toLowerCase();
    const needConfirm = (kind === 'unknown');

    if (needConfirm) {
      return { ok: false, reason: 'needsConfirm', policy, net };
    }

    const est = await this.computeSizeEstimate(selection);
    if (!est.ok) return est;

    const guarantee = await this._canGuaranteeStorageForMB(est.totalMB);
    if (!guarantee.ok) {
      return { ok: false, reason: 'cannotGuaranteeStorage', estimate: est, guarantee };
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—É–¥–∏–æ-—á–∞—Å—Ç—å —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π startFullOffline(uids)
    const res = await this.startFullOffline(est.uids);

    return { ...res, estimate: est, guarantee };
  }

  // Cloud logic (–¢–ó 9)
  async isCloudEligible(uid) {
    const u = normUid(uid);
    if (!u) return false;

    if (this._getPinnedSet().has(u)) return false;

    const { n } = this.getCloudSettings();
    const now = Date.now();

    const st = await getCloudStats(u);
    const candidate = await getCloudCandidate(u);

    if (st?.cloud === true) {
      const exp = Number(st?.cloudExpiresAt || 0);
      return Number.isFinite(exp) && exp > 0 && exp >= now;
    }

    const count = Number(st?.cloudFullListenCount || 0);
    const cloudByAuto = Number.isFinite(count) && count >= n;

    return !!(candidate || cloudByAuto);
  }

  async getIndicators(uid) {
    const u = normUid(uid);
    if (!u) return { pinned: false, cloud: false, cachedComplete: false };

    const pinned = this._getPinnedSet().has(u);
    const cq = await this.getCacheQuality();
    const cachedComplete = await this.isTrackComplete(u, cq);
    const eligible = await this.isCloudEligible(u);

    const cloud = (!pinned) && (!!cachedComplete) && (!!eligible);

    return { pinned, cloud, cachedComplete };
  }

  // –¢–ó 19.2: –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–µ–∫–∞ –¥–ª—è UI/–∞–ª–µ—Ä—Ç–æ–≤/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  async getTrackOfflineState(uid) {
    const u = normUid(uid);
    if (!u) {
      return { pinned: false, cloud: false, cachedHiComplete: false, cachedLoComplete: false, needsUpdate: false, needsReCache: false };
    }

    const pinned = this._getPinnedSet().has(u);

    const cachedHiComplete = await this.isTrackComplete(u, 'hi');
    const cachedLoComplete = await this.isTrackComplete(u, 'lo');

    const eligible = await this.isCloudEligible(u);
    const cq = await this.getCacheQuality();
    const cqComplete = await this.isTrackComplete(u, cq);

    const cloud = (!pinned) && eligible && cqComplete;

    // needsReCache: pinned –∏–ª–∏ cloud-–∫–∞–Ω–¥–∏–¥–∞—Ç/auto-cloud, –Ω–æ –≤ CQ –Ω–µ—Ç –ø–æ–ª–Ω–æ–π –∫–æ–ø–∏–∏
    const needsReCache = (pinned || eligible) && !cqComplete;

    // needsUpdate: –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ –ø–æ–ª–Ω–∞—è –∫–æ–ø–∏—è –≤ CQ –µ—Å—Ç—å, –Ω–æ remote size –¥–ª—è —ç—Ç–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è
    let needsUpdate = false;
    try {
      const meta = getTrackByUid(u);
      if (meta) {
        const dm = await getDownloadMeta(u, cq);
        const curExpected = (cq === 'lo')
          ? Number(meta.sizeLo || meta.size_low || 0)
          : Number(meta.sizeHi || meta.size || 0);

        const prevExpected = Number(dm?.expectedMB || 0);

        // –µ—Å–ª–∏ –æ–±–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã –∏ —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è –∑–∞–º–µ—Ç–Ω–æ ‚Äî –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        if (cqComplete && Number.isFinite(curExpected) && curExpected > 0 && Number.isFinite(prevExpected) && prevExpected > 0) {
          const diff = Math.abs(curExpected - prevExpected);
          if (diff >= 0.05) needsUpdate = true; // 50KB –≤ MB-–µ–¥–∏–Ω–∏—Ü–∞—Ö (–≥—Ä—É–±–∞—è –¥–µ–ª—å—Ç–∞)
        }
      }
    } catch {}

    return { pinned, cloud, cachedHiComplete, cachedLoComplete, needsUpdate, needsReCache };
  }

  async cloudMenu(uid, action) {
    const u = normUid(uid);
    const act = String(action || '').trim();
    if (!u || !act) return false;

    if (act === 'add-lock') {
      await this.pin(u);
      return true;
    }

    if (act === 'remove-cache') {
      const ok = confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–ª–∞—á–∫–∞ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–∞)?');
      if (!ok) return false;

      await deleteTrackCache(u);
      try { await clearCloudStats(u); } catch {}
      try { await clearCloudCandidate(u); } catch {}

      window.NotificationSystem?.success('–¢—Ä–µ–∫ —É–¥–∞–ª—ë–Ω –∏–∑ –∫—ç—à–∞');
      this._em.emit('progress', { uid: u, phase: 'cacheRemoved' });
      return true;
    }

    return false;
  }

  async _maybeActivateCloudAfterCqComplete(uid) {
    const u = normUid(uid);
    if (!u) return false;

    if (this._getPinnedSet().has(u)) return false;

    const cq = await this.getCacheQuality();
    const complete = await this.isTrackComplete(u, cq);
    if (!complete) return false;

    const { n, d } = this.getCloudSettings();
    const ttlMs = d * 24 * 60 * 60 * 1000;
    const now = Date.now();

    const st = await getCloudStats(u);
    if (st?.cloud === true) return true;

    const candidate = await getCloudCandidate(u);
    const count = Number(st?.cloudFullListenCount || 0);
    const cloudByAuto = Number.isFinite(count) && count >= n;

    if (!candidate && !cloudByAuto) return false;

    await setCloudStats(u, {
      cloudFullListenCount: Math.max(0, count),
      lastFullListenAt: Number(st?.lastFullListenAt || 0),
      cloudAddedAt: now,
      cloudExpiresAt: now + ttlMs,
      cloud: true
    });

    try { await clearCloudCandidate(u); } catch {}

    // local kind: cloud (–¥–ª—è breakdown/eviction)
    try { await markLocalCloud(u); } catch {}

    window.NotificationSystem?.info('–¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—Ñ–ª–∞–π–Ω –Ω–∞ ' + d + ' –¥–Ω–µ–π.');
    this._em.emit('progress', { uid: u, phase: 'cloudActivated' });
    return true;
  }

  async _checkExpiredCloud() {
    try {
      const expired = await getExpiredCloudUids();
      
      for (const uid of expired) {
        if (this._getPinnedSet().has(uid)) continue;

        await deleteTrackCache(uid);
        await clearCloudStats(uid);
        await clearCloudCandidate(uid);
        
        this._em.emit('progress', { uid, phase: 'cloudExpired' });
      }

      if (expired.length > 0) {
        window.NotificationSystem?.info(`–û—Ñ–ª–∞–π–Ω-–¥–æ—Å—Ç—É–ø –∏—Å—Ç—ë–∫. –£–¥–∞–ª–µ–Ω–æ ${expired.length} —Ç—Ä–µ–∫(–æ–≤).`);
      }
    } catch {}
  }

  // Stats (–¢–ó 7.11)
  async recordListenStats(uid, ctx = {}) {
    const u = normUid(uid);
    if (!u) return;

    const deltaSec = Number(ctx?.deltaSec || 0);
    const isFullListen = !!ctx?.isFullListen;

    if (deltaSec > 0 || isFullListen) {
      await updateGlobalStats(u, deltaSec, isFullListen ? 1 : 0);
    }

    if (isFullListen) {
      await this._updateCloudStatsOnFullListen(u);
    }
  }

  async _updateCloudStatsOnFullListen(uid) {
    const u = normUid(uid);
    if (!u) return;

    const now = Date.now();
    const { n, d } = this.getCloudSettings();
    const ttlMs = d * 24 * 60 * 60 * 1000;

    const prev = await getCloudStats(u);

    const prevCount = Number(prev?.cloudFullListenCount || 0);
    const nextCount = prevCount + 1;

    const becameCloud = nextCount >= n;
    const nextCloud = becameCloud ? true : (prev?.cloud === true);

    const cloudExpiresAt = nextCloud ? (now + ttlMs) : 0;
    const cloudAddedAt = nextCloud
      ? (Number(prev?.cloudAddedAt || 0) > 0 ? Number(prev.cloudAddedAt) : now)
      : 0;

    await setCloudStats(u, {
      cloudFullListenCount: nextCount,
      lastFullListenAt: now,
      cloudAddedAt,
      cloudExpiresAt,
      cloud: nextCloud
    });

    if (nextCloud) {
      try { await markLocalCloud(u); } catch {}
    }

    this._em.emit('progress', { uid: u, phase: 'cloudStats', cloud: nextCloud, count: nextCount });
  }

  async getGlobalStatistics() {
    return getGlobalStatsAndTotal();
  }

  // Eviction (–¢–ó 13)
  async checkEviction(limitMB = DEFAULT_CACHE_LIMIT_MB) {
    const total = await this.getCacheSizeBytes();
    const limitBytes = Math.floor(Number(limitMB || 0) * MB);
    if (!(limitBytes > 0) || total <= limitBytes) return;

    const pinnedSet = this._getPinnedSet();
    const candidates = await getEvictionCandidates(pinnedSet);

    let freed = 0;
    const evictedUids = [];

    for (const c of candidates) {
      if ((total - freed) <= limitBytes) break;

      await deleteTrackCache(c.uid);
      // –í–ê–ñ–ù–û (–¢–ó): cloud-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      // "‚òÅ ‚Üí –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞". Eviction —ç—Ç–æ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –¥–æ–ª–∂–µ–Ω.

      freed += c.bytes;
      evictedUids.push(c.uid);
    }

    if (freed > 0) {
      window.NotificationSystem?.info('–ö—ç—à –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω. –£–¥–∞–ª–µ–Ω—ã —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ç—Ä–µ–∫–∏.');
      this._em.emit('progress', { uid: null, phase: 'eviction', freed, count: evictedUids.length });
    }
  }

  // Download implementation
  async cacheTrackAudio(uid, quality, options = {}) {
    const u = normUid(uid);
    if (!u) return { ok: false, reason: 'noUid' };

    const q = normQ(quality);
    const userInitiated = !!options?.userInitiated;
    const isMass = !!options?.isMass;

    const track = getTrackByUid(u);
    if (!track) return { ok: false, reason: 'noTrackMeta' };

    const alreadyComplete = await this.isTrackComplete(u, q);
    if (alreadyComplete) {
      await this._maybeActivateCloudAfterCqComplete(u);
      return { ok: true, skipped: true, reason: 'Skipped: already complete' };
    }

    const urlHi = track?.urlHi || track?.audio || null;
    const urlLo = track?.urlLo || track?.audio_low || null;
    const url = (q === 'lo') ? (urlLo || urlHi) : (urlHi || urlLo);

    if (!url) return { ok: false, reason: 'noUrl' };

    const policy = getNetPolicy();
    const net = getNetworkStatusSafe();

    if (!net.online) {
      return { ok: false, reason: 'offline' };
    }

    const allowed = isAllowedByNetPolicy({
      policy,
      net,
      quality: q,
      kind: isMass ? 'mass' : 'single',
      userInitiated
    });

    if (!allowed) {
      if (userInitiated && shouldConfirmByPolicy({ policy, net })) {
        return { ok: false, reason: 'needsConfirm', policy, net };
      }
      return { ok: false, reason: 'policyBlocked' };
    }

    await this.checkEviction();

    try {
      this._em.emit('progress', { uid: u, phase: 'downloading', quality: q });

      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) {
        return { ok: false, reason: `httpError:${resp.status}` };
      }

      const blob = await resp.blob();
      const bytes = blob.size;

      if (bytes < 1000) {
        return { ok: false, reason: 'tooSmall' };
      }

      await setAudioBlob(u, q, blob);
      await setBytes(u, q, bytes);

      // –¢–ó 13: —Ñ–∏–∫—Å–∏—Ä—É–µ–º "—Å–∫–∞—á–∞–Ω–æ –ø—Ä–∏ —Ç–∞–∫–æ–º-—Ç–æ expected size" –¥–ª—è –¥–µ—Ç–µ–∫—Ç–∞ updates
      try {
        const expectedMB = (q === 'lo')
          ? Number(track.sizeLo || track.size_low || 0)
          : Number(track.sizeHi || track.size || 0);

        const expectedField = (q === 'lo') ? 'size_low' : 'size';

        await setDownloadMeta(u, q, {
          downloadedAt: Date.now(),
          bytes,
          expectedMB: Number.isFinite(expectedMB) ? expectedMB : 0,
          expectedField
        });
      } catch {}

      // Local meta for breakdown/eviction:
      // - playbackCache => transient(window)
      // - cloudCandidate/offlineAll/update/pinned => transient(window) –Ω–∞ —ç—Ç–∞–ø–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è,
      //   cloud —Å—Ç–∞–Ω–µ—Ç cloud —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ cloud=true (–≤ _maybeActivateCloudAfterCqComplete / fullListen)
      try {
        const k = String(options?.kind || '');
        if (k === 'playbackCache') {
          await markLocalTransient(u, 'window');
        } else {
          await markLocalTransient(u, 'window');
        }
      } catch {}

      this._em.emit('progress', { uid: u, phase: 'downloaded', quality: q, bytes });

      await this._maybeActivateCloudAfterCqComplete(u);

      return { ok: true, bytes, quality: q };
    } catch (e) {
      return { ok: false, reason: String(e?.message || 'fetchError') };
    }
  }

  // Resolve playback (–¢–ó 6.1, 7.4)
  async resolveForPlayback(track, pq) {
    const cq = await this.getCacheQuality();
    const offlineMode = this.isOfflineMode();
    const net = getNetworkStatusSafe();

    return resolvePlaybackSource({
      track,
      pq: normQ(pq),
      cq,
      offlineMode,
      network: net
    });
  }

  // Check track availability offline
  async isTrackAvailableOffline(uid) {
    return isTrackAvailableOffline(uid);
  }

  // ===== Aggregates: needsUpdate / needsReCache =====
  getNeedsAggregates() {
    return { ...this._needs };
  }

  async refreshNeedsAggregates(opts = {}) {
    const force = !!opts.force;
    const now = Date.now();

    if (!force && this._needs.lastComputedAt && (now - this._needs.lastComputedAt) < 5000) {
      return this.getNeedsAggregates();
    }

    const all = (typeof window.TrackRegistry?.getAllTracks === 'function')
      ? window.TrackRegistry.getAllTracks()
      : [];

    let needsUpdate = 0;
    let needsReCache = 0;
    let totalTracked = 0;

    try {
      for (const t of all) {
        const uid = normUid(t?.uid);
        if (!uid) continue;
        totalTracked++;

        // eslint-disable-next-line no-await-in-loop
        const st = await this.getTrackOfflineState(uid);
        if (st?.needsUpdate) needsUpdate++;
        if (st?.needsReCache) needsReCache++;
      }
    } catch {
      // best-effort
    }

    this._needs = {
      ready: true,
      totalTracked,
      needsUpdate,
      needsReCache,
      lastComputedAt: now
    };

    // UI badge "!" –∏ –ø—Ä–æ—á–µ–µ
    if (needsUpdate > 0 || needsReCache > 0) setAlert(true, '–ï—Å—Ç—å —Ç—Ä–µ–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
    else setAlert(false, '');

    this._em.emit('progress', { uid: null, phase: 'needsAggregatesChanged', ...this._needs });

    return this.getNeedsAggregates();
  }
}

let _instance = null;

export function getOfflineManager() {
  if (!_instance) {
    _instance = new OfflineManager();
  }
  return _instance;
}

export async function initOfflineManager() {
  const mgr = getOfflineManager();
  await mgr.initialize();
  return mgr;
}

//=================================================
// FILE: /scripts/offline/playback-cache.js
// scripts/offline/playback-cache.js
// PlaybackCache (ESM) ‚Äî –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–Ω–∞ PREV/CUR/NEXT (–¢–ó 7)
// –°–∫–∞—á–∏–≤–∞–µ—Ç –†–ï–ê–õ–¨–ù–´–ï —Ç—Ä–µ–∫–∏ –¥–ª—è playback, —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ–∫–Ω–æ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

import { getTrackByUid } from '../app/track-registry.js';
import { isAllowedByNetPolicy, getNetPolicy } from './net-policy.js';
import { markLocalTransient } from './cache-db.js';

// –¢–ó 7.3: –æ–∫–Ω–æ –≤—Å–µ–≥–¥–∞ —Ä–æ–≤–Ω–æ 3 —ç–ª–µ–º–µ–Ω—Ç–∞ PREV/CUR/NEXT
const WINDOW_PREV = 1;
const WINDOW_NEXT = 1;

// –¢–ó 14.2: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ—á–µ—Ä–µ–¥–∏ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º: P0 > P1 > P2 > P3 > P4 > P5)
const PRIORITY_CURRENT = 100;   // P0: CUR –¥–æ 100%
const PRIORITY_ADJACENT = 90;   // P1: —Å–æ—Å–µ–¥ (NEXT/PREV) –¥–æ 100%

function normUid(v) {
  const s = String(v || '').trim();
  return s || null;
}

function normQ(v) {
  return String(v || '').toLowerCase() === 'lo' ? 'lo' : 'hi';
}

function getNetworkStatusSafe() {
  const fn = window.Utils?.getNetworkStatusSafe;
  if (typeof fn === 'function') return fn();
  return { online: navigator.onLine !== false, kind: 'unknown', saveData: false };
}

export class PlaybackCacheManager {
  constructor(opts = {}) {
    this._queue = opts.queue || null;
    this._getPlaylistCtx = opts.getPlaylistCtx || (() => ({ list: [], curUid: null, favoritesInactive: new Set(), direction: 'forward' }));
    this._currentIdx = -1;
    this._playlist = [];
    this._pq = 'hi';
    this._scheduled = new Set();
    this._lastWindow = { prev: [], cur: null, next: [] };
    this._direction = 'forward';
  }

  setQueue(queue) {
    this._queue = queue;
  }

  setPlaybackQuality(pq) {
    this._pq = normQ(pq);
  }

  getPlaybackQuality() {
    return this._pq;
  }

  getWindow(idx, playlist) {
    const pl = playlist || this._playlist;
    const len = pl.length;

    if (len === 0 || idx < 0 || idx >= len) {
      return { prev: [], cur: null, next: [] };
    }

    const cur = pl[idx] || null;
    const curUid = normUid(cur?.uid);
    const prev = [];
    const next = [];

    // ‚úÖ T–ó 7.3: —Ü–∏–∫–ª–∏—á–Ω–æ—Å—Ç—å –æ–∫–Ω–∞ (wrap-around)
    for (let i = 1; i <= WINDOW_PREV; i++) {
      const pi = (idx - i + len) % len;
      const t = pl[pi];
      if (t) prev.unshift(normUid(t.uid));
    }

    for (let i = 1; i <= WINDOW_NEXT; i++) {
      const ni = (idx + i) % len;
      const t = pl[ni];
      if (t) next.push(normUid(t.uid));
    }

    return { prev: prev.filter(Boolean), cur: curUid, next: next.filter(Boolean) };
  }

  async ensureWindowFullyCached(pq, trackProvider) {
    const ctx = this._getPlaylistCtx();
    const list = ctx.list || [];
    const curUid = ctx.curUid || null;
    const inactive = ctx.favoritesInactive || new Set();
    const direction = ctx.direction || 'forward';

    this._direction = direction;

    if (!list.length || !curUid) return;

    const idx = list.findIndex(t => normUid(t?.uid) === curUid);
    if (idx < 0) return;

    this._currentIdx = idx;
    this._playlist = list;

    const window = this.getWindow(idx, list);
    this._lastWindow = window;

    const mgr = window.OfflineUI?.offlineManager;
    if (!mgr) return;

    const offlineMode = mgr.isOfflineMode?.();
    if (!offlineMode) return;

    const policy = getNetPolicy();
    const net = getNetworkStatusSafe();

    if (!net.online) return;

    const allowed = isAllowedByNetPolicy({
      policy,
      net,
      quality: pq || this._pq,
      kind: 'playbackCache',
      userInitiated: false
    });

    if (!allowed) return;

    // –¢–ó 7.7: —Å—Ç—Ä–æ–≥–æ CUR -> —Å–æ—Å–µ–¥ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é.
    const tasks = [];

    if (window.cur && !inactive.has(window.cur)) {
      tasks.push({ uid: window.cur, priority: PRIORITY_CURRENT });
    }

    // —Å–æ—Å–µ–¥ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é = –æ–¥–∏–Ω uid (—Ç–∞–∫ –∫–∞–∫ –æ–∫–Ω–æ 3-—Ç—Ä–µ–∫–æ–≤–æ–µ)
    const neighbor = (direction === 'backward')
      ? (window.prev && window.prev.length ? window.prev[window.prev.length - 1] : null)
      : (window.next && window.next.length ? window.next[0] : null);

    if (neighbor && !inactive.has(neighbor)) {
      tasks.push({ uid: neighbor, priority: PRIORITY_ADJACENT });
    }

    const quality = normQ(pq || this._pq);

    for (const task of tasks) {
      const u = normUid(task.uid);
      if (!u) continue;

      const key = `playbackCache:${quality}:${u}`;

      if (this._scheduled.has(key)) continue;
      this._scheduled.add(key);

      const complete = await mgr.isTrackComplete(u, quality);
      if (complete) continue;

      const trackMeta = typeof trackProvider === 'function' ? trackProvider(u) : getTrackByUid(u);
      if (!trackMeta) continue;

      mgr.enqueueAudioDownload({
        uid: u,
        quality,
        key,
        priority: task.priority,
        userInitiated: false,
        isMass: false,
        kind: 'playbackCache',
        onResult: async (r) => {
          // –¢–ó 7.6/1.3: —Ñ–∞–π–ª—ã –æ–∫–Ω–∞ —Å—á–∏—Ç–∞–µ–º transient(window)
          if (r && r.ok) {
            try { await markLocalTransient(u, 'window'); } catch {}
          }
        }
      });
    }
  }

  clearScheduled() {
    this._scheduled.clear();
  }

  getLastWindow() {
    return { ...this._lastWindow };
  }

  getCurrentIndex() {
    return this._currentIdx;
  }
}

let _instance = null;

export function getPlaybackCache() {
  if (!_instance) {
    _instance = new PlaybackCacheManager();
  }
  return _instance;
}

export const PlaybackCache = {
  setPlaybackQuality: (pq) => getPlaybackCache().setPlaybackQuality(pq),
  getPlaybackQuality: () => getPlaybackCache().getPlaybackQuality(),
  getWindow: (idx, pl) => getPlaybackCache().getWindow(idx, pl),
  ensureWindowFullyCached: (pq, tp) => getPlaybackCache().ensureWindowFullyCached(pq, tp),
  clearScheduled: () => getPlaybackCache().clearScheduled(),
  getLastWindow: () => getPlaybackCache().getLastWindow(),
  getCurrentIndex: () => getPlaybackCache().getCurrentIndex()
};

//=================================================
// FILE: /scripts/offline/track-resolver.js
// scripts/offline/track-resolver.js
// TrackResolver (ESM) ‚Äî –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ PQ‚ÜîCQ (–¢–ó 6.1)
// –ö–ª—é—á–µ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ: CQ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ CQ –≤—ã—à–µ PQ

import { bytesByQuality, getAudioBlob, touchLocalAccess, getLocalMeta } from './cache-db.js';
import { getTrackByUid } from '../app/track-registry.js';

const MB = 1024 * 1024;
const COMPLETE_THRESHOLD = 0.92;

function normQ(v) {
  return String(v || '').toLowerCase() === 'lo' ? 'lo' : 'hi';
}

function safeUrl(v) {
  const s = String(v || '').trim();
  return s || null;
}

const objectUrlCache = new Map();
const OBJECT_URL_TTL_MS = 30 * 60 * 1000;

function revokeObjectUrlByKey(key) {
  const rec = objectUrlCache.get(key);
  if (!rec) return false;
  try { URL.revokeObjectURL(rec.url); } catch {}
  objectUrlCache.delete(key);
  return true;
}

export function revokeObjectUrlsForUid(uid) {
  const u = String(uid || '').trim();
  if (!u) return 0;
  let n = 0;
  if (revokeObjectUrlByKey(`${u}:hi`)) n++;
  if (revokeObjectUrlByKey(`${u}:lo`)) n++;
  return n;
}

function getCachedObjectUrl(key) {
  const rec = objectUrlCache.get(key);
  if (!rec) return null;
  if ((Date.now() - rec.ts) > OBJECT_URL_TTL_MS) {
    try { URL.revokeObjectURL(rec.url); } catch {}
    objectUrlCache.delete(key);
    return null;
  }
  return rec.url;
}

function setCachedObjectUrl(key, url) {
  objectUrlCache.set(key, { url, ts: Date.now() });
  return url;
}

async function getLocalBlobUrl(uid, quality) {
  const u = String(uid || '').trim();
  if (!u) return null;

  const q = normQ(quality);
  const key = `${u}:${q}`;

  const cached = getCachedObjectUrl(key);
  if (cached) return cached;

  const blob = await getAudioBlob(u, q);
  if (!blob) return null;

  const url = URL.createObjectURL(blob);
  return setCachedObjectUrl(key, url);
}

async function isLocalComplete(uid, quality) {
  const u = String(uid || '').trim();
  if (!u) return false;

  const q = normQ(quality);
  const meta = getTrackByUid(u);
  if (!meta) return false;

  const needMb = q === 'hi'
    ? Number(meta.sizeHi || meta.size || 0)
    : Number(meta.sizeLo || meta.size_low || 0);

  if (!(Number.isFinite(needMb) && needMb > 0)) return false;

  const needBytes = Math.floor(needMb * MB);
  const have = await bytesByQuality(u);
  const gotBytes = q === 'hi' ? Number(have.hi || 0) : Number(have.lo || 0);

  if (!(Number.isFinite(gotBytes) && gotBytes > 0)) return false;

  return gotBytes >= Math.floor(needBytes * COMPLETE_THRESHOLD);
}

function getNetworkStatus() {
  try {
    if (window.NetworkManager?.getStatus) {
      return window.NetworkManager.getStatus();
    }
  } catch {}
  return { online: navigator.onLine !== false, kind: 'unknown' };
}

/**
 * resolvePlaybackSource ‚Äî –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–¢–ó 6.1, 7.4)
 * 
 * –ü–æ—Ä—è–¥–æ–∫ –≤—ã–±–æ—Ä–∞ (–¢–ó 7.4.2):
 * 1. –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ ‚â• PQ
 * 2. –°–µ—Ç–µ–≤–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ = PQ (–µ—Å–ª–∏ —Å–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞)
 * 3. –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ < PQ (fallback)
 * 4. null (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –æ—Ñ–ª–∞–π–Ω)
 * 
 * –ü—Ä–∞–≤–∏–ª–æ PQ‚ÜîCQ (–¢–ó 6.1):
 * - CQ –≤–ª–∏—è–µ—Ç –Ω–∞ playback –¢–û–õ–¨–ö–û –µ—Å–ª–∏ CQ > PQ
 * - PQ=Hi, CQ=Lo ‚Üí –∏–≥—Ä–∞–µ–º Hi (–Ω–µ —É—Ö—É–¥—à–∞–µ–º!)
 * - PQ=Lo, CQ=Hi, –ª–æ–∫–∞–ª—å–Ω–æ –µ—Å—Ç—å Hi ‚Üí –∏–≥—Ä–∞–µ–º Hi (—É–ª—É—á—à–µ–Ω–∏–µ)
 */
export async function resolvePlaybackSource(params) {
  const track = params?.track || null;
  const pq = normQ(params?.pq);
  const cq = normQ(params?.cq);
  const offlineMode = !!params?.offlineMode;
  const network = params?.network || getNetworkStatus();

  const uid = String(track?.uid || '').trim() || null;
  const netOnline = !!network?.online;

  const sources = track?.sources || null;
  const urlHi = safeUrl(sources?.audio?.hi || track?.audio || track?.src);
  const urlLo = safeUrl(sources?.audio?.lo || track?.audio_low);

  const pickNetworkUrl = (q) => {
    if (q === 'lo') return urlLo || urlHi;
    return urlHi || urlLo;
  };

  const localHiComplete = uid ? await isLocalComplete(uid, 'hi') : false;
  const localLoComplete = uid ? await isLocalComplete(uid, 'lo') : false;

  const localQuality = localHiComplete ? 'hi' : (localLoComplete ? 'lo' : null);

  // –¢–ó 6.1: CQ > PQ: –º–æ–∂–µ–º —É–ª—É—á—à–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º
  const cqHigherThanPq = (cq === 'hi' && pq === 'lo');
  
  let effectiveQuality = pq;
  if (cqHigherThanPq && localHiComplete) {
    effectiveQuality = 'hi';
  }

  // –°–ï–¢–¨ –ù–ï–î–û–°–¢–£–ü–ù–ê
  if (!netOnline) {
    if (effectiveQuality === 'hi' && localHiComplete) {
      const url = await getLocalBlobUrl(uid, 'hi');
      if (url) {
        try { await touchLocalAccess(uid); } catch {}
        const lm = await getLocalMeta(uid);
        const localKind = (lm?.kind === 'cloud' || lm?.kind === 'transient') ? lm.kind : 'transient';
        return { url, effectiveQuality: 'hi', isLocal: true, localQuality, localKind, reason: 'offline:localHi' };
      }
    }
    
    if (effectiveQuality === 'lo' && (localLoComplete || localHiComplete)) {
      const prefQ = localHiComplete ? 'hi' : 'lo';
      const url = await getLocalBlobUrl(uid, prefQ);
      if (url) {
        try { await touchLocalAccess(uid); } catch {}
        const lm = await getLocalMeta(uid);
        const localKind = (lm?.kind === 'cloud' || lm?.kind === 'transient') ? lm.kind : 'transient';
        return { url, effectiveQuality: prefQ, isLocal: true, localQuality, localKind, reason: `offline:local${prefQ.charAt(0).toUpperCase() + prefQ.slice(1)}` };
      }
    }

    if (localHiComplete) {
      const url = await getLocalBlobUrl(uid, 'hi');
      if (url) {
        try { await touchLocalAccess(uid); } catch {}
        const lm = await getLocalMeta(uid);
        const localKind = (lm?.kind === 'cloud' || lm?.kind === 'transient') ? lm.kind : 'transient';
        return { url, effectiveQuality: 'hi', isLocal: true, localQuality, localKind, reason: 'offline:fallbackHi' };
      }
    }
    if (localLoComplete) {
      const url = await getLocalBlobUrl(uid, 'lo');
      if (url) {
        try { await touchLocalAccess(uid); } catch {}
        const lm = await getLocalMeta(uid);
        const localKind = (lm?.kind === 'cloud' || lm?.kind === 'transient') ? lm.kind : 'transient';
        return { url, effectiveQuality: 'lo', isLocal: true, localQuality, localKind, reason: 'offline:fallbackLo' };
      }
    }

    return { url: null, effectiveQuality, isLocal: false, localQuality: null, reason: 'offline:noLocal' };
  }

  // –°–ï–¢–¨ –î–û–°–¢–£–ü–ù–ê
  
  // –¢–ó 11.2.A: –µ—Å–ª–∏ OFFLINE mode OFF ‚Äî —Ç–æ–ª—å–∫–æ —Å–µ—Ç—å
  if (!offlineMode) {
    const url = pickNetworkUrl(effectiveQuality);
    return { url, effectiveQuality, isLocal: false, localQuality, reason: 'online:streamOnly' };
  }

  // OFFLINE mode ON: –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
  
  if (effectiveQuality === 'hi' && localHiComplete) {
    const url = await getLocalBlobUrl(uid, 'hi');
    if (url) {
      try { await touchLocalAccess(uid); } catch {}
      const lm = await getLocalMeta(uid);
      const localKind = (lm?.kind === 'cloud' || lm?.kind === 'transient') ? lm.kind : 'transient';
      return { url, effectiveQuality: 'hi', isLocal: true, localQuality, localKind, reason: 'offlineMode:localHi' };
    }
  }

  if (effectiveQuality === 'lo') {
    if (localHiComplete) {
      const url = await getLocalBlobUrl(uid, 'hi');
      if (url) {
        try { await touchLocalAccess(uid); } catch {}
        const lm = await getLocalMeta(uid);
        const localKind = (lm?.kind === 'cloud' || lm?.kind === 'transient') ? lm.kind : 'transient';
        return { url, effectiveQuality: 'hi', isLocal: true, localQuality, localKind, reason: 'offlineMode:localHiForLo' };
      }
    }
    if (localLoComplete) {
      const url = await getLocalBlobUrl(uid, 'lo');
      if (url) {
        try { await touchLocalAccess(uid); } catch {}
        const lm = await getLocalMeta(uid);
        const localKind = (lm?.kind === 'cloud' || lm?.kind === 'transient') ? lm.kind : 'transient';
        return { url, effectiveQuality: 'lo', isLocal: true, localQuality, localKind, reason: 'offlineMode:localLo' };
      }
    }
  }

  const netUrl = pickNetworkUrl(effectiveQuality);
  if (netUrl) {
    return { url: netUrl, effectiveQuality, isLocal: false, localQuality, reason: 'offlineMode:network' };
  }

  if (localHiComplete) {
    const url = await getLocalBlobUrl(uid, 'hi');
    if (url) {
      return { url, effectiveQuality: 'hi', isLocal: true, localQuality, reason: 'offlineMode:fallbackHi' };
    }
  }
  if (localLoComplete) {
    const url = await getLocalBlobUrl(uid, 'lo');
    if (url) {
      return { url, effectiveQuality: 'lo', isLocal: true, localQuality, reason: 'offlineMode:fallbackLo' };
    }
  }

  return { url: null, effectiveQuality, isLocal: false, localQuality: null, reason: 'offlineMode:noSource' };
}

/**
 * isTrackAvailableOffline ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–∫–∞ –æ—Ñ–ª–∞–π–Ω
 */
export async function isTrackAvailableOffline(uid) {
  const u = String(uid || '').trim();
  if (!u) return false;
  
  const hiComplete = await isLocalComplete(u, 'hi');
  if (hiComplete) return true;
  
  const loComplete = await isLocalComplete(u, 'lo');
  return loComplete;
}

export const TrackResolver = { 
  resolvePlaybackSource,
  isTrackAvailableOffline,
  isLocalComplete
};

//=================================================
// FILE: /scripts/ui/cache-progress-overlay.js
// scripts/ui/cache-progress-overlay.js
// AC12: –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Å–ª–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫—ç—à–∞ (CQ) –ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞.
// –ù–µ —Ç—Ä–æ–≥–∞–µ–º PlayerCore –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å/seek. –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã I1/I2 —Å–æ–±–ª—é–¥–µ–Ω—ã.

import { bytesByQuality } from '../offline/cache-db.js';
// OfflineUI –±–µ—Ä–µ–º –∏–∑ window
import { getTrackByUid } from '../app/track-registry.js';

const CSS_TEXT = `
  #player-progress-bar { position: relative; }
  #player-cache-fill {
    position: absolute;
    inset: 0;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
    border-radius: 3px;
    pointer-events: none;
    z-index: 0; /* –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º fill */
  }
  #player-progress-fill { position: relative; z-index: 1; } /* –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π —Å–≤–µ—Ä—Ö—É */
`;

function injectCssOnce() {
  if (document.getElementById('cache-progress-css')) return;
  const s = document.createElement('style');
  s.id = 'cache-progress-css';
  s.textContent = CSS_TEXT;
  document.head.appendChild(s);
}

function ensureOverlay() {
  const bar = document.getElementById('player-progress-bar');
  if (!bar) return null;
  let ov = document.getElementById('player-cache-fill');
  if (!ov) {
    ov = document.createElement('div');
    ov.id = 'player-cache-fill';
    bar.prepend(ov); // –∫–ª–∞–¥—ë–º –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω–æ–π fill
  }
  return ov;
}

async function computePercentForCurrent() {
  const pc = window.playerCore;
  if (!pc || typeof pc.getCurrentTrack !== 'function') return 0;

  const track = pc.getCurrentTrack();
  if (!track) return 0;

  const uid = String(track.uid || '').trim();
  if (!uid) return 0;

  const mgr = window.OfflineUI?.offlineManager;
  if (!mgr) return 0;

  const cq = await mgr.getCacheQuality();
  const meta = getTrackByUid(uid) || {};

  const needMb = cq === 'hi'
    ? Number(meta.sizeHi || meta.size || 0)
    : Number(meta.sizeLo || meta.size_low || 0);

  if (!(Number.isFinite(needMb) && needMb > 0)) return 0;

  const needBytes = Math.floor(needMb * 1024 * 1024);

  const { hi, lo } = await bytesByQuality(uid);
  const haveBytes = cq === 'hi' ? Number(hi || 0) : Number(lo || 0);

  if (!(Number.isFinite(haveBytes) && haveBytes > 0)) return 0;

  const pct = Math.max(0, Math.min(100, (haveBytes / needBytes) * 100));
  return pct;
}

async function updateOverlay() {
  const ov = ensureOverlay();
  if (!ov) return;
  try {
    const pct = await computePercentForCurrent();
    ov.style.width = `${pct.toFixed(2)}%`;
  } catch {}
}

export function attachCacheProgressOverlay() {
  injectCssOnce();
  ensureOverlay();

  const schedule = (window.Utils?.debounceFrame)
    ? window.Utils.debounceFrame(() => { updateOverlay(); })
    : (() => updateOverlay());

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ —Å–æ–±—ã—Ç–∏—è–º OfflineManager
  const mgr = window.OfflineUI?.offlineManager;
  if (mgr?.on) {
    mgr.on('progress', schedule);
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ —Å–æ–±—ã—Ç–∏—è–º PlayerCore (—Å–º–µ–Ω–∞ —Ç—Ä–µ–∫–∞/—Ç–∏–∫/seek)
  const pc = window.playerCore;
  if (pc?.on) {
    pc.on({
      onTrackChange: schedule,
      onTick: () => schedule(),
      onPause: schedule,
      onPlay: schedule,
    });
  }

  schedule();
}

//=================================================
// FILE: /scripts/ui/cloud-menu.js
// scripts/ui/cloud-menu.js
// –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è Cloud-—Ç—Ä–µ–∫–∞ (–¢–ó 10)

const MENU_CSS = `
.cloud-ctx-menu {
  position: absolute;
  z-index: 9999;
  background: #222;
  border: 1px solid #444;
  border-radius: 6px;
  box-shadow: 0 4px 16px rgba(0,0,0,.4);
  min-width: 160px;
  padding: 6px 0;
  font-size: 14px;
  color: #eee;
}
.cloud-ctx-menu-item {
  padding: 8px 14px;
  cursor: pointer;
  white-space: nowrap;
}
.cloud-ctx-menu-item:hover {
  background: #333;
}
`;

function injectCss() {
  const U = window.Utils;
  if (U?.dom?.createStyleOnce) {
    U.dom.createStyleOnce('cloud-ctx-menu-css', MENU_CSS);
    return;
  }

  if (document.getElementById('cloud-ctx-menu-css')) return;
  const s = document.createElement('style');
  s.id = 'cloud-ctx-menu-css';
  s.textContent = MENU_CSS;
  document.head.appendChild(s);
}

let activeMenu = null;
let offDocClick = null;

function closeActiveMenu() {
  if (activeMenu) {
    try { activeMenu.remove(); } catch {}
    activeMenu = null;
  }
  if (offDocClick) {
    try { offDocClick(); } catch {}
    offDocClick = null;
  }
}

function onDocClick(e) {
  if (activeMenu && !activeMenu.contains(e.target)) {
    closeActiveMenu();
  }
}

export function attachCloudMenu(opts = {}) {
  const U = window.Utils;
  const on = U?.dom?.on ? U.dom.on.bind(U.dom) : (el, ev, fn, o) => {
    if (!el) return () => {};
    el.addEventListener(ev, fn, o);
    return () => el.removeEventListener(ev, fn, o);
  };

  const defer = U?.dom?.defer ? U.dom.defer.bind(U.dom) : (fn) => setTimeout(fn, 0);

  const root = opts.root;
  const onAddLock = opts.onAddLock;
  const onRemoveCache = opts.onRemoveCache;

  if (!root) return;

  injectCss();
  closeActiveMenu();

  const menu = document.createElement('div');
  menu.className = 'cloud-ctx-menu';

  const lockItem = document.createElement('div');
  lockItem.className = 'cloud-ctx-menu-item';
  lockItem.textContent = 'üîí –ó–∞–∫—Ä–µ–ø–∏—Ç—å –æ—Ñ–ª–∞–π–Ω';
  on(lockItem, 'click', (e) => {
    e.stopPropagation();
    closeActiveMenu();
    if (typeof onAddLock === 'function') onAddLock();
  });
  menu.appendChild(lockItem);

  const removeItem = document.createElement('div');
  removeItem.className = 'cloud-ctx-menu-item';
  removeItem.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞';
  on(removeItem, 'click', (e) => {
    e.stopPropagation();
    closeActiveMenu();
    if (typeof onRemoveCache === 'function') onRemoveCache();
  });
  menu.appendChild(removeItem);

  document.body.appendChild(menu);

  const rect = root.getBoundingClientRect();
  let top = rect.bottom + 4;
  let left = rect.left;

  if (left + menu.offsetWidth > window.innerWidth) {
    left = window.innerWidth - menu.offsetWidth - 8;
  }
  if (top + menu.offsetHeight > window.innerHeight) {
    top = rect.top - menu.offsetHeight - 4;
  }

  menu.style.top = `${top}px`;
  menu.style.left = `${left}px`;

  activeMenu = menu;

  defer(() => {
    // capture=true —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è —Ä–∞–Ω—å—à–µ –¥—Ä—É–≥–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
    offDocClick = on(document, 'click', onDocClick, true);
  });
}

//=================================================
// FILE: /scripts/ui/favorites-view.js
// scripts/ui/favorites-view.js
// FavoritesView: —á–∏—Å—Ç—ã–π —Ä–µ–Ω–¥–µ—Ä + –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –¥–ª—è –æ–∫–Ω–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª.
// –ù–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º –Ω–∞–ø—Ä—è–º—É—é (–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç).

const STAR_ON = 'img/star.png';
const STAR_OFF = 'img/star2.png';

const esc = (s) => {
  const fn = window.Utils?.escapeHtml;
  return typeof fn === 'function' ? fn(String(s ?? '')) : String(s ?? '');
};

function rowIdFromItem(it) {
  // back-compat: e2e –æ–∂–∏–¥–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç fav_{albumKey}_{uid}
  const a = String(it?.__a || '').trim();
  const u = String(it?.__uid || '').trim();
  return `fav_${a}_${u}`;
}

export function renderFavoritesEmpty(container) {
  if (!container) return;
  container.innerHTML = `
    <div class="fav-empty">
      <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏</h3>
      <p>–û—Ç–º–µ—Ç—å—Ç–µ —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π ‚≠ê</p>
    </div>
  `;
}

export function renderFavoritesList(container, model) {
  if (!container) return;

  const list = Array.isArray(model) ? model : [];
  if (!list.length) return renderFavoritesEmpty(container);

  container.innerHTML = list.map((it, i) => {
    const a = String(it?.__a || '').trim();
    const u = String(it?.__uid || '').trim();
    const active = !!it?.__active;

    const albumTitle = String(it?.__album || '–ê–ª—å–±–æ–º');
    const trackTitle = String(it?.title || '–¢—Ä–µ–∫');

    const id = rowIdFromItem(it);

    return `
      <div class="track${active ? '' : ' inactive'}"
           id="${esc(id)}"
           data-index="${i}"
           data-album="${esc(a)}"
           data-uid="${esc(u)}">
        <div class="tnum">${String(i + 1).padStart(2, '0')}.</div>
        <div class="track-title" title="${esc(trackTitle)} - ${esc(albumTitle)}">
          <span class="fav-track-name">${esc(trackTitle)}</span>
          <span class="fav-album-name"> ‚Äî ${esc(albumTitle)}</span>
        </div>
        <img src="${active ? STAR_ON : STAR_OFF}"
             class="like-star"
             alt="–∑–≤–µ–∑–¥–∞"
             data-album="${esc(a)}"
             data-uid="${esc(u)}">
      </div>
    `;
  }).join('');
}

/**
 * bindFavoritesList(container, handlers)
 * handlers:
 * - getModel(): any[]
 * - onStarClick({ uid, albumKey }): void
 * - onActiveRowClick({ uid, albumKey }): void
 * - onInactiveRowClick({ uid, title }): void
 */
export function bindFavoritesList(container, handlers) {
  if (!container || container.__favBound) return;
  container.__favBound = true;

  const getModel = typeof handlers?.getModel === 'function' ? handlers.getModel : () => [];
  const onStarClick = typeof handlers?.onStarClick === 'function' ? handlers.onStarClick : () => {};
  const onActiveRowClick = typeof handlers?.onActiveRowClick === 'function' ? handlers.onActiveRowClick : () => {};
  const onInactiveRowClick = typeof handlers?.onInactiveRowClick === 'function' ? handlers.onInactiveRowClick : () => {};

  container.addEventListener('click', (e) => {
    const target = e.target;
    const row = target?.closest?.('.track');
    if (!row || !container.contains(row)) return;

    const uid = String(row.dataset.uid || '').trim();
    const albumKey = String(row.dataset.album || '').trim();
    if (!uid || !albumKey) return;

    const model = getModel();
    const item = Array.isArray(model)
      ? model.find((it) => String(it?.__uid || '').trim() === uid && String(it?.__a || '').trim() === albumKey)
      : null;

    if (!item) return;

    if (target?.classList?.contains('like-star')) {
      e.preventDefault();
      e.stopPropagation();
      onStarClick({ uid, albumKey });
      return;
    }

    if (item.__active && item.audio) {
      onActiveRowClick({ uid, albumKey });
      return;
    }

    onInactiveRowClick({ uid, title: String(item?.title || '–¢—Ä–µ–∫') });
  });
}

//=================================================
// FILE: /scripts/ui/favorites.js
// scripts/ui/favorites.js
// FavoritesUI: UI-–º–æ–¥–µ–ª—å ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –ø–æ–≤–µ—Ä—Ö PlayerCore.
// –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: src/PlayerCore.js.
// –£—Å–∫–æ—Ä–µ–Ω–∏–µ: –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–æ–≤ –±–µ—Ä—ë–º –∏–∑ window.TrackRegistry (preload –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º).
// –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã:
// - –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é (–∫—Ä–æ–º–µ helper playFirstActiveFavorite —á–µ—Ä–µ–∑ AlbumsManager, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ)
// - inactive ‚Äî —á–∏—Å—Ç–æ UI-–±—É—Ñ–µ—Ä, –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

(function FavoritesUIModule() {
  'use strict';

  const w = window;
  const FAV = w.SPECIAL_FAVORITES_KEY || '__favorites__';
  const LOGO = 'img/logo.png';
  const COVER_TTL_MS = 12 * 60 * 60 * 1000;

  const trim = (v) => {
    const s = String(v ?? '').trim();
    return s || null;
  };

  const albumCoverCache = new Map(); // albumKey -> { ts, url }

  function getAlbumTitleFromIndex(albumKey) {
    const a = trim(albumKey);
    const idx = Array.isArray(w.albumsIndex) ? w.albumsIndex : [];
    return (idx.find(x => x && x.key === a)?.title) || '–ê–ª—å–±–æ–º';
  }

  async function getAlbumCoverUrl(albumKey) {
    const a = trim(albumKey);
    if (!a) return LOGO;

    const now = Date.now();

    // sessionStorage cache (–±—ã—Å—Ç—Ä—ã–π)
    try {
      const sKey = `favCoverCache:v1:${a}`;
      const raw = sessionStorage.getItem(sKey);
      if (raw) {
        const obj = JSON.parse(raw);
        if (obj && obj.url && obj.ts && (now - obj.ts) < COVER_TTL_MS) {
          albumCoverCache.set(a, { ts: obj.ts, url: obj.url });
          return obj.url;
        }
      }
    } catch {}

    const cached = albumCoverCache.get(a);
    if (cached && (now - cached.ts) < COVER_TTL_MS) return cached.url;

    try {
      const url = await w.GalleryManager?.getFirstCoverUrl?.(a);
      const safe = (url && typeof url === 'string') ? url : LOGO;
      albumCoverCache.set(a, { ts: now, url: safe });
      try { sessionStorage.setItem(`favCoverCache:v1:${a}`, JSON.stringify({ url: safe, ts: now })); } catch {}
      return safe;
    } catch {
      albumCoverCache.set(a, { ts: now, url: LOGO });
      return LOGO;
    }
  }

  function getTrackMeta(uid) {
    const u = trim(uid);
    if (!u) return null;

    const reg = w.TrackRegistry;
    if (!reg || typeof reg.getTrackByUid !== 'function') return null;

    return reg.getTrackByUid(u) || null;
  }

  function getAudioUrl(meta) {
    // TrackRegistry –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç urlHi/urlLo + –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å audio/audio_low
    const hi = trim(meta?.urlHi || meta?.audio);
    const lo = trim(meta?.urlLo || meta?.audio_low);
    return hi || lo || null;
  }

  function getLyricsUrl(meta) { return trim(meta?.lyrics); }

  function getFulltextUrl(meta) { return trim(meta?.fulltext); }

  async function buildFavoritesRefsModel() {
    const pc = w.playerCore;
    if (!pc?.getFavoritesState) {
      w.favoritesRefsModel = [];
      return [];
    }

    const state = pc.getFavoritesState();

    // state.active/inactive: { uid, sourceAlbum }
    const refs = []
      .concat((Array.isArray(state?.active) ? state.active : []).map(t => ({ uid: trim(t?.uid), a: trim(t?.sourceAlbum) })))
      .concat((Array.isArray(state?.inactive) ? state.inactive : []).map(t => ({ uid: trim(t?.uid), a: trim(t?.sourceAlbum) })))
      .filter(x => x && x.uid && x.a);

    if (!refs.length) {
      w.favoritesRefsModel = [];
      return [];
    }

    // –û–±–ª–æ–∂–∫–∏ –ø–æ–ª—É—á–∞–µ–º 1 —Ä–∞–∑ –Ω–∞ –∞–ª—å–±–æ–º (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
    const albumKeys = Array.from(new Set(refs.map(r => r.a).filter(Boolean)));
    const coverByAlbum = new Map();
    await Promise.all(albumKeys.map(async (a) => {
      coverByAlbum.set(a, await getAlbumCoverUrl(a));
    }));

    // Active –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ likedTrackUids:v1 –¥–ª—è —ç—Ç–æ–≥–æ –∞–ª—å–±–æ–º–∞ (–∏–ª–∏ fallback isFavorite)
    const out = refs.map((ref) => {
      const a = ref.a;
      const uid = ref.uid;

      const meta = getTrackMeta(uid);

      const isActive = (a && typeof pc.getLikedUidsForAlbum === 'function')
        ? pc.getLikedUidsForAlbum(a).includes(uid)
        : !!pc.isFavorite?.(uid);

      const cover = coverByAlbum.get(a) || LOGO;

      // –í–ê–ñ–ù–û: inactive –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç audio/lyrics/fulltext
      const audio = (isActive && meta) ? getAudioUrl(meta) : null;
      const lyrics = (isActive && meta) ? getLyricsUrl(meta) : null;
      const fulltext = (isActive && meta) ? getFulltextUrl(meta) : null;

      return {
        title: meta?.title || '–¢—Ä–µ–∫',
        uid,

        audio,
        lyrics,
        fulltext,

        __a: a,
        __uid: uid,
        __artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        __album: getAlbumTitleFromIndex(a),
        __active: isActive,
        __cover: cover
      };
    });

    w.favoritesRefsModel = out;
    return out;
  }

  function getModel() {
    const m = w.favoritesRefsModel;
    return Array.isArray(m) ? m : [];
  }

  function getActiveModel(model) {
    const list = Array.isArray(model) ? model : getModel();
    return list.filter(it => it && it.__active && it.audio);
  }

  async function playFirstActiveFavorite() {
    try {
      await buildFavoritesRefsModel();
      const model = getModel();
      const idx = model.findIndex(it => it && it.__active && it.audio);
      if (idx < 0) return;
      await w.AlbumsManager?.ensureFavoritesPlayback?.(idx);
    } catch {}
  }

  // –ê–≤—Ç–æ-–ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –º–æ–¥–µ–ª–∏ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç favorites view
  if (!w.__favoritesUIBound) {
    w.__favoritesUIBound = true;

    const bind = () => {
      const pc = w.playerCore;
      if (!pc?.onFavoritesChanged) return void setTimeout(bind, 100);

      pc.onFavoritesChanged(() => {
        if (w.AlbumsManager?.getCurrentAlbum?.() === FAV) {
          buildFavoritesRefsModel().catch(() => {});
        }
      });
    };

    bind();
  }

  w.FavoritesUI = {
    buildFavoritesRefsModel,
    getModel,
    getActiveModel,
    getAlbumCoverUrl,
    playFirstActiveFavorite
  };

  // Back-compat alias
  w.buildFavoritesRefsModel = buildFavoritesRefsModel;
})();

//=================================================
// FILE: /scripts/ui/lyrics-modal.js
// scripts/ui/lyrics-modal.js
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø–µ—Å–Ω–∏

(function LyricsModalModule() {
  'use strict';

  const w = window;

  function showFullLyricsModal() {
    const track = w.playerCore?.getCurrentTrack();
    if (!track) {
      w.NotificationSystem?.warning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞');
      return;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
    const fulltext = track.fulltext;
    
    if (fulltext) {
      loadFulltextAndShow(fulltext, track);
    } else {
      showLyricsFromTimeline(track);
    }
  }

  async function loadFulltextAndShow(url, track) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to load fulltext');
      
      const text = await response.text();
      showModal(track, text);
      
    } catch (error) {
      console.error('Failed to load fulltext:', error);
      w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏');
    }
  }

  function showLyricsFromTimeline(track) {
    // –°–æ–±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ —Ç–∞–π–º–ª–∞–π–Ω–∞ –ª–∏—Ä–∏–∫–∏, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑ PlayerUI
    if (!w.PlayerUI) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –±—ç–∫–æ–º–ø–∞—Ç-API currentLyricsLines, –µ—Å–ª–∏ –µ—Å—Ç—å,
    // –∏–Ω–∞—á–µ –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å —Å—ã—Ä—ã–µ currentLyrics –∏ –≤—ã—Ç–∞—â–∏—Ç—å text.
    const rawLines = Array.isArray(w.PlayerUI.currentLyricsLines)
      ? w.PlayerUI.currentLyricsLines
      : (Array.isArray(w.PlayerUI.currentLyrics) ? w.PlayerUI.currentLyrics : []);

    if (!rawLines.length) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    const lines = rawLines
      .map(item => (typeof item.line === 'string' ? item.line : (item.text || '')))
      .filter(Boolean);

    if (!lines.length) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    const text = lines.join('\n');
    showModal(track, text);
  }

  function showModal(track, text) {
    const esc = w.Utils?.escapeHtml
      ? (s) => w.Utils.escapeHtml(String(s || ''))
      : (s) => String(s || '');

    const bodyHtml = `
      <div class="lyrics-modal" style="max-height: 80vh;">
        <h2 style="margin: 0 0 8px 0;">${esc(track.title)}</h2>
        <div style="color: #8ab8fd; margin-bottom: 16px; font-size: 14px;">
          ${esc(track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞')} ¬∑ ${esc(track.album || '')}
        </div>

        <div class="lyrics-fulltext" style="
          max-height: 50vh;
          overflow-y: auto;
          padding: 16px;
          background: rgba(0,0,0,0.2);
          border-radius: 10px;
          line-height: 1.8;
          white-space: pre-wrap;
          font-size: 15px;
          scrollbar-width: thin;
          scrollbar-color: rgba(77,170,255,0.3) transparent;
        ">${esc(text)}</div>

        <div style="display:flex; gap:10px; margin-top:16px; justify-content:center; flex-wrap:wrap;">
          <button class="modal-action-btn" id="copy-lyrics-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="modal-action-btn" id="share-lyrics-btn">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
      </div>
    `;

    if (!w.Modals?.open) {
      w.NotificationSystem?.error('Modals helper –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
      return;
    }

    const modal = w.Modals.open({
      title: '–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏',
      maxWidth: 560,
      bodyHtml
    });

    modal.querySelector('#copy-lyrics-btn')?.addEventListener('click', () => copyLyrics(text, modal));
    modal.querySelector('#share-lyrics-btn')?.addEventListener('click', () => shareLyrics(track, text));
  }

  async function copyLyrics(text, modal) {
    try {
      await navigator.clipboard.writeText(text);
      w.NotificationSystem?.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
      modal.remove();
    } catch (error) {
      // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        w.NotificationSystem?.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
        modal.remove();
      } catch (e) {
        w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      }
      
      document.body.removeChild(textarea);
    }
  }

  async function shareLyrics(track, text) {
    const shareData = {
      title: track.title,
      text: `${track.title} - ${track.artist}\n\n${text}`
    };

    if (navigator.share) {
      try {
        await navigator.share(shareData);
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Share failed:', error);
        }
      }
    } else {
      w.NotificationSystem?.info('–§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
    }
  }

  // escapeHtml: –∏—Å–ø–æ–ª—å–∑—É–µ–º window.Utils.escapeHtml (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)

  // –ü—É–±–ª–∏—á–Ω—ã–π API
  w.LyricsModal = {
    show: showFullLyricsModal
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  // (Lyrics Modal –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞)

})();

//=================================================
// FILE: /scripts/ui/modal-templates.js
// scripts/ui/modal-templates.js
'use strict';

// –í–∞–∂–Ω–æ: —ç—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî ESM, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤ index.html –∫–∞–∫ type="module".
// –ó–∞–¥–∞—á–∞: –¥–µ—Ä–∂–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏.

const esc = (s) => {
  const f = window.Utils?.escapeHtml;
  return typeof f === 'function' ? f(String(s ?? '')) : String(s ?? '');
};

function section(title, body) {
  return `
    <section class="om-card">
      <div class="om-card__title">${esc(title)}</div>
      ${body}
    </section>
  `;
}

function rowCheck({ id, label, checked }) {
  return `
    <label class="om-row">
      <input class="om-check" type="checkbox" id="${esc(id)}" ${checked ? 'checked' : ''}>
      <span>${esc(label)}</span>
    </label>
  `;
}

function btn({ id, text, className = '' }) {
  return `<button class="offline-btn ${esc(className)}" id="${esc(id)}">${esc(text)}</button>`;
}

function select({ id, options, value }) {
  const v = String(value ?? '');
  return `
    <select class="om-select" id="${esc(id)}">
      ${options.map((o) => {
        const ov = String(o.value);
        const ot = String(o.text);
        return `<option value="${esc(ov)}" ${ov === v ? 'selected' : ''}>${esc(ot)}</option>`;
      }).join('')}
    </select>
  `;
}

function inputNumber({ id, min, max, value, disabled }) {
  return `
    <input class="om-input"
           type="number"
           id="${esc(id)}"
           min="${esc(min)}"
           max="${esc(max)}"
           value="${esc(value)}"
           ${disabled ? 'disabled' : ''}>
  `;
}

export const ModalTemplates = {
  wrap: ({ title = '', body = '' } = {}) => `
    ${title ? `<h2>${esc(title)}</h2>` : ''}
    <div class="modal-body">${body}</div>
  `,

  offlineBody: (s = {}) => {
    const cq = String(s.cq ?? 'hi');
    const isOff = !!s.isOff;

    const cloudN = Number(s.cloud?.n ?? 5) || 5;
    const cloudD = Number(s.cloud?.d ?? 31) || 31;

    const pol = s.policy || {};
    const limit = s.limit || { mode: 'auto', mb: 500 };

    const albums = Array.isArray(s.albums) ? s.albums : [];

    const head = `
      <div class="om-head">
        <div class="om-head__left">
          <span class="om-head__title">–°–µ—Ç—å:</span>
          <b id="om-net-label" class="om-head__value">‚Äî</b>
        </div>
        <div class="om-head__right">CQ=<b id="om-cq-label">${esc(cq)}</b></div>
      </div>
    `;

    const secA = section('A) Offline mode', `
      ${rowCheck({ id: 'om-offline-mode', label: '–í–∫–ª—é—á–∏—Ç—å OFFLINE mode', checked: isOff })}
      <div class="om-note">OFFLINE=OFF: —Å—Ç—Ä–∏–º–∏–Ω–≥. –ö—ç—à –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
    `);

    const secB = section('B) Cache quality (CQ)', `
      <div class="om-inline">
        ${select({
          id: 'om-cq',
          value: cq,
          options: [{ value: 'hi', text: 'Hi' }, { value: 'lo', text: 'Lo' }]
        })}
        ${btn({ id: 'om-cq-save', text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', className: 'om-btn-primary' })}
      </div>
      <div class="om-note">–°–º–µ–Ω–∞ CQ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∏—Ö–∏–π re-cache pinned/cloud.</div>
    `);

    const secC = section('C) Cloud settings', `
      <div class="om-inline">
        <label class="om-field"><span class="om-field__lbl">N</span>${inputNumber({ id: 'om-cloud-n', min: 1, max: 50, value: cloudN })}</label>
        <label class="om-field"><span class="om-field__lbl">D</span>${inputNumber({ id: 'om-cloud-d', min: 1, max: 365, value: cloudD })}</label>
        ${btn({ id: 'om-cloud-save', text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' })}
      </div>
    `);

    const secD = section('D) Network policy', `
      ${rowCheck({ id: 'om-pol-wifiOnly', label: 'Wi‚ÄëFi only', checked: !!pol.wifiOnly })}
      ${rowCheck({ id: 'om-pol-allowMobile', label: '–†–∞–∑—Ä–µ—à–∏—Ç—å mobile', checked: !!pol.allowMobile })}
      ${rowCheck({ id: 'om-pol-confirmOnMobile', label: 'Confirm –Ω–∞ mobile', checked: !!pol.confirmOnMobile })}
      ${rowCheck({ id: 'om-pol-saveDataBlock', label: '–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ Save‚ÄëData', checked: !!pol.saveDataBlock })}
      ${btn({ id: 'om-pol-save', text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å policy' })}
    `);

    const secE = section('E) Cache limit + breakdown', `
      <div class="om-inline">
        ${select({
          id: 'om-limit-mode',
          value: limit.mode,
          options: [
            { value: 'auto', text: 'auto' },
            { value: 'manual', text: 'manual (MB)' }
          ]
        })}
        ${inputNumber({ id: 'om-limit-mb', min: 50, max: 5000, value: Number(limit.mb ?? 500) || 500, disabled: limit.mode !== 'manual' })}
        ${btn({ id: 'om-limit-save', text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' })}
      </div>

      <div class="om-kv">
        <div>audio total: <b id="om-e-audio-total">‚Äî</b></div>
        <div>pinned: <b id="om-e-pinned">‚Äî</b></div>
        <div>cloud: <b id="om-e-cloud">‚Äî</b></div>
        <div>transient window: <b id="om-e-tw">‚Äî</b></div>
        <div>transient extra: <b id="om-e-te">‚Äî</b></div>
        <div>transient unknown: <b id="om-e-tu">‚Äî</b></div>
        <div>other (SW cache): <b id="om-e-sw-total">‚Äî</b></div>
      </div>
    `);

    const secF = section('F) –ó–∞–≥—Ä—É–∑–∫–∏', `
      <div class="om-kv">
        <div>–°–∫–∞—á–∏–≤–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å: <b id="om-f-downloading">‚Äî</b></div>
        <div>–í –æ—á–µ—Ä–µ–¥–∏: <b id="om-f-queued">0</b></div>
      </div>
      <div class="om-actions om-actions--left">
        ${btn({ id: 'om-queue-toggle', text: '–ü–∞—É–∑–∞/–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' })}
      </div>
    `);

    const secG = section('G) –û–±–Ω–æ–≤–ª–µ–Ω–∏—è', `
      <div class="om-kv">
        <div>needsUpdate: <b id="om-g-needsUpdate">0</b></div>
        <div>needsReCache: <b id="om-g-needsReCache">0</b></div>
      </div>
      <div class="om-actions om-actions--left">
        ${btn({ id: 'om-upd-all', text: '–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã' })}
        ${btn({ id: 'om-recache-all', text: 'Re-cache –ø–æ CQ' })}
      </div>
    `);

    const secH = section('H) –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞', `
      <div class="om-actions om-actions--left">
        ${btn({ id: 'om-clear-all', text: '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë', className: 'om-btn-danger' })}
      </div>
    `);

    const albumsBox = `
      <div id="om-albums-box" class="om-albums">
        ${albums.map((a) => `
          <label class="om-row om-row--tight">
            <input class="om-check om-alb" type="checkbox" data-k="${esc(a.key)}">
            <span>${esc(a.title)}</span>
          </label>
        `).join('')}
      </div>
    `;

    const secI = section('I) 100% OFFLINE', `
      <div class="om-inline">
        ${select({
          id: 'om-full-mode',
          value: 'favorites',
          options: [
            { value: 'favorites', text: '—Ç–æ–ª—å–∫–æ –ò–ó–ë–†–ê–ù–ù–û–ï' },
            { value: 'albums', text: '–≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–ª—å–±–æ–º—ã' }
          ]
        })}
        ${btn({ id: 'om-full-est', text: '–û—Ü–µ–Ω–∏—Ç—å' })}
        ${btn({ id: 'om-full-start', text: '–°—Ç–∞—Ä—Ç', className: 'om-btn-success' })}
      </div>
      ${albumsBox}
      <div id="om-full-out" class="om-note">–û—Ü–µ–Ω–∫–∞: ‚Äî</div>
    `);

    const secStats = section('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', `
      <div class="om-kv">
        <div>globalTotalListenSeconds: <b id="om-stats-total">‚Äî</b></div>
      </div>
    `);

    return `<div class="om">${head}${secA}${secB}${secC}${secD}${secE}${secF}${secG}${secH}${secI}${secStats}</div>`;
  }
};

try {
  window.ModalTemplates = ModalTemplates;
} catch {}

//=================================================
// FILE: /scripts/ui/modals.js
// scripts/ui/modals.js
// –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π helper –¥–ª—è window.Modals.
// –ù—É–∂–µ–Ω –¥–ª—è offline-modal.js, navigation.js, lyrics-modal.js, sysinfo.js, favorites-data.js.
// –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç: –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.

(function () {
  'use strict';

  const U = window.Utils;

  const esc = (s) => {
    const fn = U?.escapeHtml;
    return typeof fn === 'function' ? fn(String(s ?? '')) : String(s ?? '');
  };

  function ensureContainer() {
    let c = document.getElementById('modals-container');
    if (!c) {
      c = document.createElement('div');
      c.id = 'modals-container';
      document.body.appendChild(c);
    }
    return c;
  }

  function open(opts = {}) {
    const title = String(opts.title || '');
    const bodyHtml = String(opts.bodyHtml || '');
    const maxWidth = Number(opts.maxWidth || 520) || 520;

    const bg = document.createElement('div');
    bg.className = 'modal-bg active';

    const box = document.createElement('div');
    box.className = 'modal-feedback';
    box.style.maxWidth = `${maxWidth}px`;

    box.innerHTML = `
      <button class="bigclose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.42L12 13.41l4.89 4.9a1 1 0 0 0 1.42-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4z"/>
        </svg>
      </button>
      ${title ? `<h2>${esc(title)}</h2>` : ''}
      <div class="modal-body">${bodyHtml}</div>
    `;

    bg.appendChild(box);
    ensureContainer().appendChild(bg);

    const close = () => {
      try { opts.onClose?.(); } catch {}
      try { bg.remove(); } catch {}
    };

    bg.addEventListener('click', (e) => {
      if (e.target === bg) close();
    });

    box.querySelector('.bigclose')?.addEventListener('click', close);

    // ESC
    const onKey = (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        window.removeEventListener('keydown', onKey);
        close();
      }
    };
    window.addEventListener('keydown', onKey);

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ (–∫–∞–∫ —É —Ç–µ–±—è –æ–∂–∏–¥–∞–µ—Ç—Å—è)
    bg.remove = ((orig) => () => {
      window.removeEventListener('keydown', onKey);
      orig.call(bg);
    })(bg.remove);

    return bg;
  }

  function actionRow(actions = []) {
    const arr = Array.isArray(actions) ? actions : [];
    return `
      <div class="om-actions">
        ${arr.map((a) => {
          const act = esc(a?.act || '');
          const text = esc(a?.text || '');
          const cls = esc(a?.className || '');
          const style = esc(a?.style || '');
          return `<button type="button" class="modal-action-btn ${cls}" data-act="${act}" style="${style}">${text}</button>`;
        }).join('')}
      </div>
    `;
  }

  function confirm(opts = {}) {
    const title = String(opts.title || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ');
    const textHtml = String(opts.textHtml || '');
    const confirmText = String(opts.confirmText || '–û–∫');
    const cancelText = String(opts.cancelText || '–û—Ç–º–µ–Ω–∞');

    const modal = open({
      title,
      maxWidth: Number(opts.maxWidth || 460) || 460,
      bodyHtml: `
        <div style="color:#9db7dd; line-height:1.45; margin-bottom:14px;">
          ${textHtml}
        </div>
        ${actionRow([
          { act: 'cancel', text: cancelText, className: '', style: 'min-width:130px;' },
          { act: 'confirm', text: confirmText, className: 'online', style: 'min-width:130px;' }
        ])}
      `,
      onClose: opts.onClose
    });

    modal.querySelector('[data-act="cancel"]')?.addEventListener('click', () => {
      try { opts.onCancel?.(); } catch {}
      try { modal.remove(); } catch {}
    });

    modal.querySelector('[data-act="confirm"]')?.addEventListener('click', () => {
      try { opts.onConfirm?.(); } catch {}
      try { modal.remove(); } catch {}
    });

    return modal;
  }

  window.Modals = window.Modals || {};
  window.Modals.open = open;
  window.Modals.confirm = confirm;
  window.Modals.actionRow = actionRow;

  // bridge: offlineBody –±–µ—Ä—ë–º –∏–∑ ModalTemplates, –µ—Å–ª–∏ –µ—Å—Ç—å
  Object.defineProperty(window.Modals, 'offlineBody', {
    configurable: true,
    get() {
      const fn = window.ModalTemplates?.offlineBody;
      return (typeof fn === 'function') ? fn : null;
    }
  });
})();

//=================================================
// FILE: /scripts/ui/news-inline.js
// scripts/ui/news-inline.js
// –†–µ–Ω–¥–µ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π –≤–Ω—É—Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∞–ª—å–±–æ–º __reliz__).
// –¢–æ–ª—å–∫–æ UI/fetch, –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.

const esc = (s) => {
  const fn = window.Utils?.escapeHtml;
  return typeof fn === 'function' ? fn(String(s ?? '')) : String(s ?? '');
};

function renderCard(it) {
  const title = esc(it?.title || '–ù–æ–≤–æ—Å—Ç—å');
  const date = esc(it?.date || '');
  const text = esc(it?.text || '');
  const tags = Array.isArray(it?.tags) ? it.tags : [];

  const media = it?.embedUrl
    ? `<div class="news-inline__media"><iframe loading="lazy" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`
    : it?.image
      ? `<div class="news-inline__media"><img loading="lazy" src="${esc(it.image)}" alt=""></div>`
      : it?.video
        ? `<div class="news-inline__media"><video controls preload="metadata" src="${esc(it.video)}"></video></div>`
        : '';

  const tagHtml = tags.length
    ? `<div class="news-inline__tags">${tags.map((t) => `<span class="news-inline__tag">#${esc(t)}</span>`).join('')}</div>`
    : '';

  return `
    <article class="news-inline__card">
      <div class="news-inline__title">${title}</div>
      ${date ? `<div class="news-inline__date">${date}</div>` : ''}
      ${media}
      ${text ? `<div class="news-inline__text">${text}</div>` : ''}
      ${tagHtml}
    </article>
  `;
}

export function renderNewsInlineSkeleton(container) {
  if (!container) return;

  container.innerHTML = `
    <div class="news-inline__head">
      <div class="news-inline__links">
        <a href="https://t.me/vitrina_razbita" target="_blank" rel="noopener noreferrer">Telegram –∫–∞–Ω–∞–ª</a>
        <span class="news-inline__dot">¬∑</span>
        <a href="./news.html" target="_blank" rel="noopener noreferrer">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–æ–≤–æ—Å—Ç–µ–π</a>
      </div>
      <div id="news-inline-status" class="news-inline__status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div id="news-inline-list" class="news-inline__list"></div>
  `;
}

export async function loadAndRenderNewsInline(container) {
  if (!container) return;

  renderNewsInlineSkeleton(container);

  const status = container.querySelector('#news-inline-status');
  const list = container.querySelector('#news-inline-list');
  if (!list) return;

  try {
    const r = await fetch('./news/news.json', { cache: 'no-cache' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);

    const j = await r.json();
    const items = Array.isArray(j?.items) ? j.items : [];

    if (!items.length) {
      if (status) status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
      return;
    }

    if (status) status.style.display = 'none';
    list.innerHTML = items.map(renderCard).join('');
  } catch {
    if (status) {
      status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
      status.classList.add('news-inline__status--error');
    }
  }
}

//=================================================
// FILE: /scripts/ui/notify.js
// scripts/ui/notify.js
// –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
class NotificationSystem {
  constructor() {
    this.container = null;
    this.queue = [];
    this.isShowing = false;
    this.currentToast = null;

    this.U = window.Utils;
    this.on = (el, ev, fn, opts) => this.U.dom.on(el, ev, fn, opts);
    this.raf = (fn) => this.U.dom.raf(fn);

    this.init();
  }
  
  init() {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    this.container = document.createElement('div');
    this.container.id = 'toast-container';
    this.container.style.cssText = `
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      pointer-events: none;
    `;
    document.body.appendChild(this.container);
  }
  
  show(message, type = 'info', duration = 3000) {
    const toast = {
      message,
      type,
      duration,
      id: Date.now() + Math.random()
    };
    this.queue.push(toast);
    this.processQueue();
  }
  
  processQueue() {
    if (this.isShowing || this.queue.length === 0) return;
    this.isShowing = true;
    const toast = this.queue.shift();
    this.displayToast(toast);
  }
  
  displayToast(toast) {
    const toastEl = document.createElement('div');
    toastEl.className = `toast toast-${toast.type}`;
    const emoji = this.getEmoji(toast.type);
    toastEl.innerHTML = `
      <div class="toast-content">
        <span class="toast-emoji">${emoji}</span>
        <span class="toast-message">${this.escapeHtml(toast.message)}</span>
      </div>
    `;
    this.container.appendChild(toastEl);
    this.currentToast = toastEl;
    
    this.raf(() => {
      toastEl.classList.add('show');
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
    setTimeout(() => {
      this.hideToast(toastEl);
    }, toast.duration);
  }
  
  hideToast(toastEl) {
    if (!toastEl) return;
    toastEl.classList.remove('show');
    setTimeout(() => {
      if (toastEl.parentNode) {
        toastEl.parentNode.removeChild(toastEl);
      }
      this.isShowing = false;
      this.currentToast = null;
      this.processQueue();
    }, 300);
  }
  
  getEmoji(type) {
    const emojis = {
      info: '‚ÑπÔ∏è',
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      offline: 'üì¥'
    };
    return emojis[type] || '‚ÑπÔ∏è';
  }
  
  escapeHtml(text) {
    const fn = window.Utils?.escapeHtml;
    const s = String(text || '');
    if (typeof fn === 'function') return fn(s);
    // fallback –±–µ–∑ DOM-–∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞–Ω–∏—è
    return s.replace(/[<>&'"]/g, (m) => ({
      '<': '&lt;', '>': '&gt;', '&': '&amp;', "'": '&#39;', '"': '&quot;'
    }[m]));
  }
  
  // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
  info(message, duration) {
    this.show(message, 'info', duration || 2000);
  }
  
  success(message, duration) {
    this.show(message, 'success', duration || 2500);
  }
  
  error(message, duration) {
    this.show(message, 'error', duration || 4000);
  }
  
  warning(message, duration) {
    this.show(message, 'warning', duration || 3000);
  }
  
  offline(message, duration) {
    this.show(message, 'offline', duration || 3000);
  }
  
  clear() {
    this.queue = [];
    if (this.currentToast) {
      this.hideToast(this.currentToast);
    }
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.NotificationSystem = new NotificationSystem();
console.log('‚úÖ Notification system initialized');

//=================================================
// FILE: /scripts/ui/offline-indicators.js
// scripts/ui/offline-indicators.js
import { attachCloudMenu } from './cloud-menu.js';

const ICON_CSS = `
  .offline-ico-slot{display:inline-flex;align-items:center;margin-right:6px}
  .offline-ico{cursor:pointer;user-select:none;font-size:14px;line-height:1}
  .offline-ico.gray{opacity:.4}
  .offline-ico.lock{width:1em}
  .offline-ico.cloud{width:1em}
`;

const st = {
  attached: false,
  mo: null,
  unsubs: []
};

function injectCss() {
  const U = window.Utils;
  if (U?.dom?.createStyleOnce) {
    U.dom.createStyleOnce('offline-ico-css', ICON_CSS);
    return;
  }

  if (document.getElementById('offline-ico-css')) return;
  const s = document.createElement('style');
  s.id = 'offline-ico-css';
  s.textContent = ICON_CSS;
  document.head.appendChild(s);
}

function findUidForRow(row) {
  const rowUid = String(row?.dataset?.uid || '').trim();
  if (rowUid) return rowUid;

  const id = String(row?.id || '');
  const m = id.match(/^fav_(.+)_(.+)$/);
  if (m && m[2]) return String(m[2]).trim() || null;

  const star = row?.querySelector?.('.like-star[data-uid]');
  const starUid = String(star?.dataset?.uid || '').trim();
  if (starUid) return starUid;

  return null;
}

function ensureSlot(row) {
  let slot = row.querySelector(':scope > .offline-ico-slot');
  if (slot) return slot;

  slot = document.createElement('span');
  slot.className = 'offline-ico-slot';

  const num = row.querySelector('.tnum');
  if (num && num.parentNode === row) row.insertBefore(slot, num);
  else row.insertBefore(slot, row.firstChild);

  return slot;
}

function renderIndicator(row, state, uid) {
  const U = window.Utils;
  const on = U?.dom?.on ? U.dom.on.bind(U.dom) : (el, ev, fn, opts) => {
    if (!el) return () => {};
    el.addEventListener(ev, fn, opts);
    return () => el.removeEventListener(ev, fn, opts);
  };

  const slot = ensureSlot(row);
  slot.innerHTML = '';

  const isUnknown = !!state?.unknown;
  const mgr = window.OfflineUI?.offlineManager;

  if (!isUnknown && state.pinned) {
    const el = document.createElement('span');
    el.className = 'offline-ico lock';
    el.textContent = 'üîí';
    el.title = '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –æ—Ñ–ª–∞–π–Ω';
    el.dataset.uid = uid;
    el.dataset.active = 'true';

    on(el, 'click', async (e) => {
      e.stopPropagation();
      try { if (mgr) await mgr.unpin(uid); } catch {}
      refreshRow(row);
    });

    slot.appendChild(el);
    return;
  }

  if (!isUnknown && state.cloud && state.cachedComplete) {
    const el = document.createElement('span');
    el.className = 'offline-ico cloud';
    el.textContent = '‚òÅ';
    el.title = '–î–æ—Å—Ç—É–ø–Ω–æ –æ—Ñ–ª–∞–π–Ω –ø–æ –æ–±–ª–∞–∫—É';
    el.dataset.uid = uid;

    on(el, 'click', (e) => {
      e.stopPropagation();
      attachCloudMenu({
        root: el,
        onAddLock: async () => { if (mgr) await mgr.pin(uid); refreshRow(row); },
        onRemoveCache: async () => { if (mgr) await mgr.cloudMenu(uid, 'remove-cache'); refreshRow(row); }
      });
    });

    slot.appendChild(el);
    return;
  }

  const el = document.createElement('span');
  el.className = 'offline-ico lock gray';
  el.textContent = 'üîí';
  el.dataset.uid = uid || '';
  el.dataset.active = 'false';

  if (isUnknown) {
    el.title = 'OFFLINE: UID –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤';
    el.style.pointerEvents = 'none';
    el.style.opacity = '0.25';
    slot.appendChild(el);
    return;
  }

  el.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –æ—Ñ–ª–∞–π–Ω';
  on(el, 'click', async (e) => {
    e.stopPropagation();
    try {
      if (mgr) {
        await mgr.pin(uid);
        window.NotificationSystem?.info('–¢—Ä–µ–∫ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ñ–ª–∞–π–Ω. –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ‚Ä¶', 3500);
      }
    } catch {
      window.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å –æ—Ñ–ª–∞–π–Ω');
    }
    refreshRow(row);
  });

  slot.appendChild(el);
}

async function refreshRow(row) {
  const uid = findUidForRow(row);
  const mgr = window.OfflineUI?.offlineManager;
  if (!mgr) return;

  if (!uid) {
    renderIndicator(row, { pinned: false, cloud: false, cachedComplete: false, unknown: true }, '');
    return;
  }

  try {
    const ind = await mgr.getIndicators(uid);
    renderIndicator(row, ind, uid);
  } catch (e) {
    console.warn('Error getting indicators:', e);
  }
}

let __refreshAllTimer = null;

function refreshAll() {
  if (__refreshAllTimer) return;

  __refreshAllTimer = setTimeout(() => {
    __refreshAllTimer = null;
    document.querySelectorAll('#track-list .track').forEach((row) => refreshRow(row));
  }, 50);
}

function bindLiveUpdatesOnce() {
  const mgr = window.OfflineUI?.offlineManager;
  if (!mgr) return;

  try {
    const off = mgr.on('progress', (ev) => {
      const uid = String(ev?.uid || '').trim();
      if (!uid) return;
      document.querySelectorAll(`#track-list .track[data-uid="${CSS.escape(uid)}"]`).forEach((row) => refreshRow(row));
    });
    if (typeof off === 'function') st.unsubs.push(off);
  } catch {}

  try {
    const pc = window.playerCore;
    if (pc?.onFavoritesChanged) {
      const off = pc.onFavoritesChanged(() => refreshAll());
      if (typeof off === 'function') st.unsubs.push(off);
    }
  } catch {}
}

function attachMutationObserverOnce() {
  if (st.mo) return;

  const root = document.getElementById('track-list') || document.body;

  st.mo = new MutationObserver((muts) => {
    for (const m of muts) {
      if (m.type === 'childList' && ((m.addedNodes && m.addedNodes.length) || (m.removedNodes && m.removedNodes.length))) {
        refreshAll();
        break;
      }
    }
  });

  st.mo.observe(root, { childList: true, subtree: true });
}

export function attachOfflineIndicators() {
  if (st.attached) {
    refreshAll();
    return;
  }
  st.attached = true;

  injectCss();
  refreshAll();
  attachMutationObserverOnce();
  bindLiveUpdatesOnce();
}

//=================================================
// FILE: /scripts/ui/offline-modal.js
// scripts/ui/offline-modal.js
// OFFLINE modal (–¢–ó_–ù–¨–Æ) ‚Äî —Å–µ–∫—Ü–∏–∏ A‚ÄìI + 100% OFFLINE + updates/re-cache + breakdown.
// –í–∞–∂–Ω–æ: –º–æ–¥–∞–ª–∫–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (no stop/play/seek/volume).

import { getNetPolicy, setNetPolicy } from '../offline/net-policy.js';
import { formatBytes, getNetworkStatusSafe } from './ui-utils.js';

const LS_LIMIT_MODE = 'offline:cacheLimitMode:v1'; // 'auto'|'manual'
const LS_LIMIT_MB = 'offline:cacheLimitMB:v1';

const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
const toInt = (v, d = 0) => {
  const n = parseInt(String(v ?? ''), 10);
  return Number.isFinite(n) ? n : d;
};
const q = (v) => (String(v || '').toLowerCase() === 'lo' ? 'lo' : 'hi');

const fmtListen = (sec) => {
  const s = Math.max(0, Number(sec) || 0);
  const h = (s / 3600) | 0;
  const m = ((s % 3600) / 60) | 0;
  return h > 0 ? `${h}—á ${m}–º` : `${m}–º`;
};

const readLimit = () => {
  try {
    const mode = localStorage.getItem(LS_LIMIT_MODE) === 'manual' ? 'manual' : 'auto';
    const mb = clamp(Number(localStorage.getItem(LS_LIMIT_MB) || 500) || 500, 50, 5000);
    return { mode, mb };
  } catch {
    return { mode: 'auto', mb: 500 };
  }
};

const writeLimit = (mode, mb) => {
  const m = mode === 'manual' ? 'manual' : 'auto';
  const v = clamp(Number(mb) || 500, 50, 5000);
  try {
    localStorage.setItem(LS_LIMIT_MODE, m);
    localStorage.setItem(LS_LIMIT_MB, String(v));
  } catch {}
  return { mode: m, mb: v };
};

const swAsk = async (type, payload, timeoutMs = 1200) => {
  try {
    if (!('serviceWorker' in navigator)) return null;
    const reg = await navigator.serviceWorker.getRegistration();
    if (!reg?.active) return null;

    return await new Promise((resolve) => {
      const ch = new MessageChannel();
      const t = setTimeout(() => resolve(null), timeoutMs);
      ch.port1.onmessage = (ev) => { clearTimeout(t); resolve(ev.data || null); };
      reg.active.postMessage({ type, payload }, [ch.port2]);
    });
  } catch {
    return null;
  }
};

const swGetCacheSize = async () => {
  const r = await swAsk('GET_CACHE_SIZE', null, 1200);
  return { ok: !!r, size: Number(r?.size || 0) || 0, entries: Number(r?.entries || 0) || 0, approx: !!r?.approx };
};

const swWarmOfflineShell = async (urls) => {
  const r = await swAsk('WARM_OFFLINE_SHELL', { urls: Array.isArray(urls) ? urls : [] }, 5000);
  return r || { ok: false };
};

// ===== preload all tracks into TrackRegistry (used by scripts/app.js and 100% offline) =====
async function fetchAlbumConfigByKey(albumKey) {
  const key = String(albumKey || '').trim();
  if (!key) return null;

  const idx = Array.isArray(window.albumsIndex) ? window.albumsIndex : [];
  const meta = idx.find(x => x && x.key === key) || null;
  if (!meta?.base) return null;

  const cacheKey = `offline:albumConfigCache:v1:${key}`;
  try {
    const raw = sessionStorage.getItem(cacheKey);
    if (raw) {
      const j = JSON.parse(raw);
      if (j && typeof j === 'object') return j;
    }
  } catch {}

  const base = String(meta.base || '');
  const url = base.endsWith('/') ? `${base}config.json` : `${base}/config.json`;

  try {
    const r = await fetch(url, { cache: 'no-cache' });
    if (!r.ok) return null;
    const cfg = await r.json();
    try { sessionStorage.setItem(cacheKey, JSON.stringify(cfg)); } catch {}
    return cfg;
  } catch {
    return null;
  }
}

export async function preloadAllAlbumsTrackIndex() {
  const idx = Array.isArray(window.albumsIndex) ? window.albumsIndex : [];
  const reg = window.TrackRegistry;
  if (!idx.length || !reg?.registerTrack) return false;

  let loaded = 0;

  for (const a of idx) {
    const key = String(a?.key || '').trim();
    if (!key || key.startsWith('__')) continue;

    // eslint-disable-next-line no-await-in-loop
    const cfg = await fetchAlbumConfigByKey(key);
    const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : [];
    if (!tracks.length) continue;

    const base = String(a.base || '');
    const baseUrl = base.endsWith('/') ? base : `${base}/`;
    const join = (rel) => { try { return new URL(String(rel || ''), baseUrl).toString(); } catch { return null; } };

    for (const t of tracks) {
      const uid = String(t?.uid || '').trim();
      if (!uid) continue;

      reg.registerTrack({
        uid,
        title: t.title || '',
        audio: t.audio ? join(t.audio) : null,
        audio_low: t.audio_low ? join(t.audio_low) : null,
        size: (typeof t.size === 'number') ? t.size : null,
        size_low: (typeof t.size_low === 'number') ? t.size_low : null,
        lyrics: t.lyrics ? join(t.lyrics) : (t.lrc ? join(t.lrc) : null),
        fulltext: t.fulltext ? join(t.fulltext) : null,
        sourceAlbum: key
      });
    }

    loaded++;
  }

  return loaded > 0;
}

// ===== modal state =====
let modalEl = null;
let unsubProgress = null;
let bound = false;

const qs = (sel) => (modalEl ? modalEl.querySelector(sel) : null);
const txt = (sel, v) => {
  const el = qs(sel);
  if (!el) return;
  const s = String(v ?? '');
  if (el.textContent !== s) el.textContent = s;
};
const chk = (sel, v) => {
  const el = qs(sel);
  if (el) el.checked = !!v;
};
const dis = (sel, v) => {
  const el = qs(sel);
  if (el) el.disabled = !!v;
};

const getNeedsCounts = (mgr) => {
  const a = mgr?.getNeedsAggregates?.();
  return { u: Number(a?.needsUpdate || 0) || 0, r: Number(a?.needsReCache || 0) || 0 };
};

async function collectState(mgr) {
  const net = getNetworkStatusSafe();

  const [cq, breakdown, cacheSizeBytes, swSize, g] = await Promise.all([
    mgr.getCacheQuality?.().catch(() => 'hi'),
    mgr.getCacheBreakdown?.().catch(() => null),
    mgr.getCacheSizeBytes?.().catch(() => 0),
    swGetCacheSize(),
    mgr.getGlobalStatistics?.().catch(() => ({})),
  ]);

  const isOff = !!mgr.isOfflineMode?.();
  const cloud = mgr.getCloudSettings?.() || { n: 5, d: 31 };
  const policy = getNetPolicy();
  const limit = readLimit();
  const qst = mgr.getQueueStatus?.() || { downloadingKey: null, queued: 0, paused: false };

  try { await mgr.refreshNeedsAggregates?.({ force: false }); } catch {}
  const needs = getNeedsCounts(mgr);

  const totalSec = Number((typeof g?.totalSeconds === 'number' ? g.totalSeconds : g?.totalListenSec) || 0) || 0;

  const albums = (Array.isArray(window.albumsIndex) ? window.albumsIndex : [])
    .filter(a => a && a.key && !String(a.key).startsWith('__'))
    .map(a => ({ key: String(a.key), title: String(a.title || a.key) }));

  return {
    net,
    isOff,
    cq: q(cq),
    cloud,
    policy,
    limit,
    breakdown,
    cacheSizeBytes: Number(cacheSizeBytes || 0) || 0,
    swSize: swSize || { size: 0, approx: false },
    qst,
    needsUpdateCount: needs.u,
    needsReCacheCount: needs.r,
    albums,
    statsTotalLabel: fmtListen(totalSec),
  };
}

function updateFields(s) {
  if (!modalEl || !s) return;

  txt('#om-net-label', `${s.net.online ? 'online' : 'offline'} (${s.net.kind || 'unknown'})`);
  txt('#om-cq-label', s.cq);

  chk('#om-offline-mode', s.isOff);

  const cqSel = qs('#om-cq');
  if (cqSel && cqSel.value !== s.cq) cqSel.value = s.cq;

  const nEl = qs('#om-cloud-n');
  const dEl = qs('#om-cloud-d');
  if (nEl) nEl.value = String(Number(s.cloud?.n || 5));
  if (dEl) dEl.value = String(Number(s.cloud?.d || 31));

  chk('#om-pol-wifiOnly', !!s.policy.wifiOnly);
  chk('#om-pol-allowMobile', !!s.policy.allowMobile);
  chk('#om-pol-confirmOnMobile', !!s.policy.confirmOnMobile);
  chk('#om-pol-saveDataBlock', !!s.policy.saveDataBlock);

  const lm = qs('#om-limit-mode');
  const lmb = qs('#om-limit-mb');
  if (lm && lm.value !== s.limit.mode) lm.value = s.limit.mode;
  if (lmb) lmb.value = String(s.limit.mb);
  dis('#om-limit-mb', s.limit.mode !== 'manual');

  txt('#om-e-audio-total', formatBytes(s.cacheSizeBytes));
  txt('#om-e-sw-total', formatBytes(s.swSize.size || 0));

  if (s.breakdown) {
    txt('#om-e-pinned', formatBytes(s.breakdown.pinnedBytes));
    txt('#om-e-cloud', formatBytes(s.breakdown.cloudBytes));
    txt('#om-e-tw', formatBytes(s.breakdown.transientWindowBytes));
    txt('#om-e-te', formatBytes(s.breakdown.transientExtraBytes));
    txt('#om-e-tu', formatBytes(s.breakdown.transientUnknownBytes));
  }

  txt('#om-f-downloading', String(s.qst.downloadingKey || '‚Äî'));
  txt('#om-f-queued', String(Number(s.qst.queued || 0)));
  const qBtn = qs('#om-queue-toggle');
  if (qBtn) qBtn.textContent = s.qst.paused ? '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å' : '–ü–∞—É–∑–∞';

  txt('#om-g-needsUpdate', String(s.needsUpdateCount));
  txt('#om-g-needsReCache', String(s.needsReCacheCount));

  txt('#om-stats-total', s.statsTotalLabel || '‚Äî');

  const modeSel = qs('#om-full-mode');
  const albBox = qs('#om-albums-box');
  if (modeSel && albBox) albBox.style.display = (String(modeSel.value || 'favorites') === 'albums') ? '' : 'none';
}

function bindHandlers(mgr) {
  if (!modalEl || bound) return;
  bound = true;

  const ns = window.NotificationSystem;
  const ok = (m) => ns?.success?.(m);
  const info = (m, t) => ns?.info?.(m, t);
  const warn = (m) => ns?.warning?.(m);
  const err = (m) => ns?.error?.(m);

  const on = (sel, ev, fn) => { const el = qs(sel); if (el) el.addEventListener(ev, fn); };

  // –î–µ–ª–µ–≥–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–∫–æ–≤ (–º–µ–Ω—å—à–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
  modalEl.addEventListener('click', async (e) => {
    const id = e?.target?.id;
    if (!id) return;

    if (id === 'om-cq-save') {
      await mgr.setCacheQuality?.(String(qs('#om-cq')?.value || 'hi'));
      ok('CQ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      return;
    }

    if (id === 'om-cloud-save') {
      const n = clamp(toInt(qs('#om-cloud-n')?.value, 5), 1, 50);
      const d = clamp(toInt(qs('#om-cloud-d')?.value, 31), 1, 365);
      mgr.setCloudSettings?.({ n, d });
      ok('Cloud –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      return;
    }

    if (id === 'om-pol-save') {
      setNetPolicy({
        wifiOnly: !!qs('#om-pol-wifiOnly')?.checked,
        allowMobile: !!qs('#om-pol-allowMobile')?.checked,
        confirmOnMobile: !!qs('#om-pol-confirmOnMobile')?.checked,
        saveDataBlock: !!qs('#om-pol-saveDataBlock')?.checked,
      });
      ok('Network policy —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
      return;
    }

    if (id === 'om-limit-save') {
      writeLimit(String(qs('#om-limit-mode')?.value || 'auto'), Number(qs('#om-limit-mb')?.value || 500));
      ok('–õ–∏–º–∏—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      return;
    }

    if (id === 'om-queue-toggle') {
      const st = mgr.getQueueStatus?.() || { paused: false };
      if (st.paused) mgr.resumeQueue?.();
      else mgr.pauseQueue?.();
      return;
    }

    if (id === 'om-upd-all') {
      const r = await mgr.enqueueUpdateAll?.();
      if (r?.ok) info(`Updates: –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ${r.count} –∑–∞–¥–∞—á`);
      else err('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å updates');
      try { await mgr.refreshNeedsAggregates?.({ force: true }); } catch {}
      return;
    }

    if (id === 'om-recache-all') {
      const r = await mgr.enqueueReCacheAllByCQ?.({ userInitiated: true });
      if (r?.ok) info(`Re-cache: –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ${r.count} –∑–∞–¥–∞—á`);
      else err('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å re-cache');
      try { await mgr.refreshNeedsAggregates?.({ force: true }); } catch {}
      return;
    }

    if (id === 'om-clear-all') {
      if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à –∞—É–¥–∏–æ?')) return;
      if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –µ—â—ë —Ä–∞–∑: —É–¥–∞–ª–∏—Ç—å –∫—ç—à –ø–æ–ª–Ω–æ—Å—Ç—å—é?')) return;
      await mgr.clearAllCache?.();
      ok('–ö—ç—à –æ—á–∏—â–µ–Ω');
      return;
    }

    if (id === 'om-full-est') {
      txt('#om-full-out', '–û—Ü–µ–Ω–∫–∞: ...');
      await preloadAllAlbumsTrackIndex();
      const est = await mgr.computeSizeEstimate?.(getSelection());
      if (!est?.ok) return void txt('#om-full-out', `–û—Ü–µ–Ω–∫–∞: –æ—à–∏–±–∫–∞ (${String(est?.reason || 'unknown')})`);
      txt('#om-full-out', `–û—Ü–µ–Ω–∫–∞: ${Number(est.totalMB || 0).toFixed(1)} MB ¬∑ —Ç—Ä–µ–∫–æ–≤: ${est.count || 0} ¬∑ CQ=${est.cq}`);
      return;
    }

    if (id === 'om-full-start') {
      const net = getNetworkStatusSafe();
      if (!net.online) return void warn('–ù–µ—Ç —Å–µ—Ç–∏');
      if (String(net.kind || '').toLowerCase() === 'unknown' && !confirm('–¢–∏–ø —Å–µ—Ç–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;

      await preloadAllAlbumsTrackIndex();

      const est = await mgr.computeSizeEstimate?.(getSelection());
      if (!est?.ok) return void err('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å –Ω–∞–±–æ—Ä');
      if (!Array.isArray(est.uids) || est.uids.length === 0) return void info('–ù–∞–±–æ—Ä –ø—É—Å—Ç');

      const guarantee = await mgr.canGuaranteeStorageForMB?.(est.totalMB);
      if (!guarantee?.ok) return void err('–ù–µ–ª—å–∑—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. 100% OFFLINE –Ω–µ –∑–∞–ø—É—â–µ–Ω.');

      const urls = new Set([
        './','./index.html','./news.html','./manifest.json','./albums.json','./news/news.json',
        './styles/main.css','./scripts/core/bootstrap.js','./scripts/core/utils.js','./scripts/core/config.js',
        './scripts/app.js','./src/PlayerCore.js','./img/logo.png','./img/star.png','./img/star2.png',
        './icons/icon-192.png','./icons/icon-512.png','./icons/apple-touch-icon.png',
        './albums/gallery/00/index.json','./albums/gallery/01/index.json','./albums/gallery/02/index.json',
        './albums/gallery/03/index.json','./albums/gallery/news/index.json',
      ]);

      try {
        for (const uid of est.uids) {
          const meta = window.TrackRegistry?.getTrackByUid?.(uid) || null;
          const l = String(meta?.lyrics || '').trim();
          const f = String(meta?.fulltext || '').trim();
          if (l) urls.add(l);
          if (f) urls.add(f);
        }
      } catch {}

      const warm = await swWarmOfflineShell(Array.from(urls));
      if (!warm.ok) warn('Shell/–∞—Å—Å–µ—Ç—ã: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≥—Ä–µ—Ç—å SW');

      const r = await mgr.startFullOffline?.(est.uids);
      if (r?.ok) info(`100% OFFLINE: –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ${r.total} —Ç—Ä–µ–∫–æ–≤`, 3500);
      else err(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å 100% OFFLINE: ${String(r?.reason || '')}`);
    }
  });

  // change handlers (—Ç–æ—á–µ—á–Ω–æ)
  on('#om-offline-mode', 'change', (e) => mgr.setOfflineMode?.(!!e?.target?.checked));

  on('#om-limit-mode', 'change', () => {
    dis('#om-limit-mb', String(qs('#om-limit-mode')?.value || 'auto') !== 'manual');
  });

  on('#om-full-mode', 'change', () => {
    const box = qs('#om-albums-box');
    if (box) box.style.display = (String(qs('#om-full-mode')?.value || 'favorites') === 'albums') ? '' : 'none';
  });
}

function getSelection() {
  const v = String(qs('#om-full-mode')?.value || 'favorites');
  if (v === 'albums') {
    const keys = Array.from(modalEl?.querySelectorAll('.om-alb:checked') || [])
      .map(x => String(x.dataset.k || '').trim())
      .filter(Boolean);
    return { mode: 'albums', albumKeys: keys };
  }
  return { mode: 'favorites' };
}

export async function openOfflineModal() {
  const mgr = window.OfflineUI?.offlineManager;
  if (!mgr) return void window.NotificationSystem?.error('OfflineManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  if (!window.Modals?.open) return void window.NotificationSystem?.error('Modals helper –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');

  closeOfflineModal();

  const state = await collectState(mgr);

  modalEl = window.Modals.open({
    title: 'OFFLINE',
    maxWidth: 560,
    bodyHtml: window.Modals?.offlineBody ? window.Modals.offlineBody(state) : '<div class="om__note">offlineBody template missing</div>',
    onClose: () => closeOfflineModal()
  });

  bound = false;
  bindHandlers(mgr);
  updateFields(state);

  const schedule = window.Utils?.debounceFrame
    ? window.Utils.debounceFrame(async () => { try { updateFields(await collectState(mgr)); } catch {} })
    : (async () => { try { updateFields(await collectState(mgr)); } catch {} });

  unsubProgress = mgr.on?.('progress', () => { schedule(); }) || null;
  schedule();
}

export function closeOfflineModal() {
  try { unsubProgress?.(); } catch {}
  unsubProgress = null;
  bound = false;

  if (modalEl) {
    try { modalEl.remove(); } catch {}
    modalEl = null;
  }
}

//=================================================
// FILE: /scripts/ui/sleep.js
// scripts/ui/sleep.js
// –¢–∞–π–º–µ—Ä —Å–Ω–∞: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º—É–∑—ã–∫–∏ –ø–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—é (—á–µ—Ä–µ–∑ pause –≤ PlayerCore).
// –†–µ–∂–∏–º—ã:
// - —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è: 15/30/60 –º–∏–Ω—É—Ç
// - –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —á–∞—Å—É: HH:MM (–Ω–∞–ø—Ä–∏–º–µ—Ä, 01:30)
// UI: –∫–Ω–æ–ø–∫–∞ –≤ –ø–∞–Ω–µ–ª–∏ –ø–ª–µ–µ—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–µ–Ω—é.
// –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã: –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å stop/play/seek/volume ‚Äî —Ç–æ–ª—å–∫–æ playerCore.setSleepTimer/clearSleepTimer.

(function SleepTimerModule() {
  'use strict';

  const w = window;
  const U = w.Utils;

  // –ï–¥–∏–Ω—ã–π DOM helpers —Å–ª–æ–π
  const $ = (id) => U.dom.byId(id);
  const on = (el, ev, fn, opts) => U.dom.on(el, ev, fn, opts);

  const LS_KEY = 'sleepTimerTarget'; // back-compat: —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–º –ø—Ä–æ–µ–∫—Ç–æ–º (epoch ms)

  const PRESETS_MIN = [15, 30, 60];

  let menuEl = null;
  let tickId = null;
  let coreBound = false;

  function lsGetTarget() {
    const v = U.lsGet(LS_KEY, '0');
    const n = parseInt(String(v ?? ''), 10);
    return Number.isFinite(n) ? n : 0;
  }

  function lsSetTarget(ts) {
    U.lsSet(LS_KEY, String(ts));
  }

  function lsClearTarget() {
    try { localStorage.removeItem(LS_KEY); } catch {}
  }

  function clampInt(v, min, max, def) {
    const n = parseInt(String(v ?? ''), 10);
    const x = Number.isFinite(n) ? n : def;
    return Math.max(min, Math.min(max, x));
  }

  function formatHHMM(ts) {
    const d = new Date(ts);
    return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
  }

  function formatRemainingCompact(targetTs) {
    const ms = targetTs - Date.now();
    if (ms <= 0) return '0–º';
    const totalMin = Math.ceil(ms / 60000);
    if (totalMin < 60) return `${totalMin}–º`;
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    return m ? `${h}—á ${m}–º` : `${h}—á`;
  }

  function computeTargetFromMinutes(minutes) {
    const m = clampInt(minutes, 1, 24 * 60, 15);
    return Date.now() + m * 60 * 1000;
  }

  function computeTargetToClock(h, m) {
    const hh = clampInt(h, 0, 23, 0);
    const mm = clampInt(m, 0, 59, 0);

    const now = new Date();
    const target = new Date(now);
    target.setHours(hh, mm, 0, 0);
    if (target.getTime() <= now.getTime()) target.setDate(target.getDate() + 1);
    return target.getTime();
  }

  function getTargetTs() {
    // –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã: playerCore, fallback ‚Äî localStorage (—á—Ç–æ–±—ã –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å reload)
    const pc = w.playerCore;
    const fromCore = pc?.getSleepTimerTarget?.();
    if (Number.isFinite(fromCore) && fromCore > 0) return fromCore;
    return lsGetTarget();
  }

  function applyTargetTs(targetTs) {
    const pc = w.playerCore;
    if (!pc) return false;

    const ts = Number(targetTs) || 0;
    const ms = ts - Date.now();
    if (ms <= 0) return false;

    pc.setSleepTimer?.(ms);
    lsSetTarget(ts);
    startTicking();
    updateBadge();
    return true;
  }

  function clearTimer() {
    w.playerCore?.clearSleepTimer?.();
    lsClearTarget();
    stopTicking();
    updateBadge();
  }

  function restoreTimer() {
    const saved = lsGetTarget();
    if (!saved) return;

    const remaining = saved - Date.now();
    if (remaining > 0) {
      w.playerCore?.setSleepTimer?.(remaining);
      startTicking();
      updateBadge();
      return;
    }

    lsClearTarget();
    updateBadge();
  }

  function updateBadge() {
    const badge = $('sleep-timer-badge');
    if (!badge) return;

    const targetTs = getTargetTs();
    if (!targetTs || targetTs <= Date.now()) {
      badge.style.display = 'none';
      badge.textContent = '';
      return;
    }

    const min = Math.ceil((targetTs - Date.now()) / 60000);
    if (min <= 0) {
      badge.style.display = 'none';
      badge.textContent = '';
      return;
    }

    badge.textContent = String(min);
    badge.style.display = '';
  }

  function startTicking() {
    stopTicking();
    updateBadge();

    tickId = setInterval(() => {
      updateBadge();
      const t = getTargetTs();
      if (t && t <= Date.now()) {
        // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø–æ—Å–ª–µ —Å–Ω–∞ –≤–∫–ª–∞–¥–∫–∏
        clearTimer();
      }
    }, 10000);
  }

  function stopTicking() {
    if (!tickId) return;
    clearInterval(tickId);
    tickId = null;
  }

  function bindCoreOnce() {
    if (coreBound) return;
    const pc = w.playerCore;
    if (!pc?.on) return;

    coreBound = true;
    pc.on({
      onSleepTriggered: () => {
        // PlayerCore —Å–∞–º –¥–µ–ª–∞–µ—Ç pause() ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å —Ç—Ä–µ–±—É–µ–º–∞—è ‚Äú–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º—É–∑—ã–∫–∏‚Äù.
        w.NotificationSystem?.info?.('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª');
        clearTimer();
      }
    });
  }

  // --------------------------
  // Menu UI
  // --------------------------
  function openMenu(anchor) {
    if (menuEl || !anchor) return;

    const targetTs = getTargetTs();
    const active = targetTs && targetTs > Date.now();

    const el = document.createElement('div');
    el.className = 'sleep-menu';

    const rect = anchor.getBoundingClientRect();
    el.style.position = 'fixed';
    el.style.right = `${Math.max(8, window.innerWidth - rect.right)}px`;
    el.style.bottom = `${Math.max(8, window.innerHeight - rect.top)}px`;

    const head = active
      ? `
        <div class="sleep-menu-item active" data-act="noop">
          ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω: ${formatRemainingCompact(targetTs)} (–¥–æ ${formatHHMM(targetTs)})
        </div>
      `
      : '';

    const off = `<div class="sleep-menu-item" data-act="off">–í—ã–∫–ª—é—á–∏—Ç—å</div>`;
    const sep = `<div style="height: 1px; background: rgba(255,255,255,0.1); margin: 6px 0;"></div>`;

    const presets = PRESETS_MIN
      .map(m => `<div class="sleep-menu-item" data-act="min" data-min="${m}">${m}</div>`)
      .join('');

    const toTime = `<div class="sleep-menu-item" data-act="totime">–ö –≤—Ä–µ–º–µ–Ω–∏‚Ä¶</div>`;

    el.innerHTML = `${head}${off}${sep}${presets}${sep}${toTime}`;

    on(el, 'click', (e) => {
      const item = e.target?.closest?.('.sleep-menu-item');
      if (!item || !el.contains(item)) return;
      e.stopPropagation();

      const act = String(item.dataset.act || '');

      if (act === 'off') {
        clearTimer();
        closeMenu();
        w.NotificationSystem?.info?.('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω');
        return;
      }

      if (act === 'min') {
        const m = clampInt(item.dataset.min, 1, 24 * 60, 15);
        const ts = computeTargetFromMinutes(m);
        applyTargetTs(ts);
        closeMenu();
        w.NotificationSystem?.success?.(`‚è∞ –¢–∞–π–º–µ—Ä: ${m} –º–∏–Ω`);
        return;
      }

      if (act === 'totime') {
        closeMenu();
        openTimeDialog();
      }
    });

    // close outside
    setTimeout(() => document.addEventListener('click', onDocClickClose), 0);
    document.addEventListener('keydown', onEscOnce, { once: true });

    document.body.appendChild(el);
    menuEl = el;
  }

  function closeMenu() {
    if (!menuEl) return;
    try { menuEl.remove(); } catch {}
    menuEl = null;
    document.removeEventListener('click', onDocClickClose);
  }

  function onDocClickClose(e) {
    if (menuEl && !menuEl.contains(e.target)) closeMenu();
  }

  function onEscOnce(e) {
    if (e.key === 'Escape') closeMenu();
    else document.addEventListener('keydown', onEscOnce, { once: true });
  }

  function toggleMenu(anchor) {
    if (menuEl) closeMenu();
    else openMenu(anchor);
  }

  // --------------------------
  // Time dialog (HH:MM)
  // --------------------------
  function openTimeDialog() {
    const wrap = document.createElement('div');
    wrap.className = 'sleep-time-modal-backdrop';
    wrap.innerHTML = `
      <div class="sleep-time-modal" role="dialog" aria-modal="true" aria-label="–¢–∞–π–º–µ—Ä —Å–Ω–∞ –∫ –≤—Ä–µ–º–µ–Ω–∏">
        <div class="sleep-time-title">–¢–∞–π–º–µ—Ä —Å–Ω–∞ –∫ –≤—Ä–µ–º–µ–Ω–∏</div>
        <div class="sleep-time-row">
          <input id="sleep-time-hh" inputmode="numeric" maxlength="2" placeholder="HH" class="sleep-time-input">
          <span class="sleep-time-sep">:</span>
          <input id="sleep-time-mm" inputmode="numeric" maxlength="2" placeholder="MM" class="sleep-time-input">
        </div>
        <div class="sleep-time-actions">
          <button type="button" class="sleep-time-btn" data-act="cancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="sleep-time-btn primary" data-act="ok">–û–∫</button>
        </div>
      </div>
    `;

    const hhEl = wrap.querySelector('#sleep-time-hh');
    const mmEl = wrap.querySelector('#sleep-time-mm');

    // Prefill: +30 –º–∏–Ω—É—Ç
    const pre = new Date(Date.now() + 30 * 60000);
    if (hhEl) hhEl.value = String(pre.getHours()).padStart(2, '0');
    if (mmEl) mmEl.value = String(pre.getMinutes()).padStart(2, '0');

    const close = () => {
      document.removeEventListener('keydown', onKey);
      try { wrap.remove(); } catch {}
    };

    const ok = () => {
      const hh = clampInt(hhEl?.value, 0, 23, 0);
      const mm = clampInt(mmEl?.value, 0, 59, 0);
      const ts = computeTargetToClock(hh, mm);

      if (applyTargetTs(ts)) {
        w.NotificationSystem?.success?.(`‚è∞ –¢–∞–π–º–µ—Ä –¥–æ ${formatHHMM(ts)}`);
      }
      close();
    };

    const onKey = (e) => {
      if (e.key === 'Escape') { e.preventDefault(); close(); }
      if (e.key === 'Enter') { e.preventDefault(); ok(); }
    };

    on(wrap, 'click', (e) => {
      if (e.target === wrap) return close();

      const btn = e.target?.closest?.('button[data-act]');
      if (!btn) return;

      const act = String(btn.dataset.act || '');
      if (act === 'cancel') close();
      if (act === 'ok') ok();
    });

    document.addEventListener('keydown', onKey);
    document.body.appendChild(wrap);
    setTimeout(() => hhEl?.focus?.(), 0);
  }

  // --------------------------
  // Public API
  // --------------------------
  function init() {
    const btn = $('sleep-timer-btn');
    if (!btn) {
      setTimeout(init, 100);
      return;
    }

    on(btn, 'click', (e) => toggleMenu(e.currentTarget));

    bindCoreOnce();
    restoreTimer();
    updateBadge();

    console.log('‚úÖ Sleep timer initialized');
  }

  w.SleepTimer = {
    // back-compat: —Å—Ç–∞—Ä—ã–π API –ø—Ä–∏–Ω–∏–º–∞–ª minutes
    setSleepTimer(minutes) {
      const ts = computeTargetFromMinutes(minutes);
      applyTargetTs(ts);
    },
    clearSleepTimer: clearTimer,
    updateBadge,
    show() {
      const btn = $('sleep-timer-btn');
      if (!btn) return;
      toggleMenu(btn);
    }
  };

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();

//=================================================
// FILE: /scripts/ui/sysinfo.js
// scripts/ui/sysinfo.js
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–∏—Å—Ç–µ–º–µ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

(function() {
  'use strict';

  const U = window.Utils;
  const $ = (id) => U.dom.byId(id);
  const on = (el, ev, fn, opts) => U.dom.on(el, ev, fn, opts);
  const formatBytes = (n) => U.formatBytes(n);

  class SystemInfoManager {
    constructor() {
      this.modal = null;
      this.init();
    }

    init() {
      // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è
      const button = $('sysinfo-btn');
      if (button) {
        button.style.display = '';
        on(button, 'click', () => this.show());
      }

      // –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ Ctrl+I
      on(document, 'keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
          e.preventDefault();
          this.show();
        }
      });
    }

    show() {
      if (!window.Modals?.open) return;

      if (this.modal) {
        try { this.modal.remove(); } catch {}
        this.modal = null;
      }

      const info = this.collectSystemInfo();
      const esc = window.Utils?.escapeHtml
        ? (s) => window.Utils.escapeHtml(String(s || ''))
        : (s) => String(s || '');

      this.modal = window.Modals.open({
        title: '–û —Å–∏—Å—Ç–µ–º–µ',
        maxWidth: 500,
        bodyHtml: `
          <div style="font-size: 14px; line-height: 1.6;">
            <h3 style="color: #8ab8fd; margin-top: 0;">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
            <div><strong>–í–µ—Ä—Å–∏—è:</strong> ${esc(info.app.version)}</div>
            <div><strong>–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏:</strong> ${esc(info.app.buildDate)}</div>
            <div><strong>PWA:</strong> ${info.app.isPWA ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</div>
            <div id="sw-version-placeholder"><strong>SW –≤–µ—Ä—Å–∏—è:</strong> ...</div>

            <h3 style="color: #8ab8fd; margin-top: 20px;">–ë—Ä–∞—É–∑–µ—Ä</h3>
            <div><strong>User Agent:</strong> ${esc(info.browser.userAgent)}</div>
            <div><strong>–Ø–∑—ã–∫:</strong> ${esc(info.browser.language)}</div>
            <div><strong>Online:</strong> ${info.browser.online ? '‚úÖ' : '‚ùå'}</div>

            <h3 style="color: #8ab8fd; margin-top: 20px;">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h3>
            <div><strong>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:</strong> ${esc(info.device.resolution)}</div>
            <div><strong>DPR:</strong> ${esc(info.device.dpr)}</div>
            <div><strong>Touch:</strong> ${info.device.touch ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Platform:</strong> ${esc(info.device.platform)}</div>

            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü–ª–µ–µ—Ä</h3>
            <div><strong>–Ø–¥—Ä–æ:</strong> ${esc(info.player.core)}</div>
            <div><strong>–í–µ—Ä—Å–∏—è Howler:</strong> ${esc(info.player.howlerVersion)}</div>
            <div><strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Web Audio:</strong> ${info.player.webAudio ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTML5:</strong> ${info.player.html5 ? '‚úÖ' : '‚ùå'}</div>

            <h3 style="color: #8ab8fd; margin-top: 20px;">–•—Ä–∞–Ω–∏–ª–∏—â–µ</h3>
            <div><strong>LocalStorage:</strong> ${info.storage.localStorage ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>IndexedDB:</strong> ${info.storage.indexedDB ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Cache API:</strong> ${info.storage.cacheAPI ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Service Worker:</strong> ${info.storage.serviceWorker ? '‚úÖ' : '‚ùå'}</div>

            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü–∞–º—è—Ç—å</h3>
            <div><strong>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:</strong> ${esc(info.memory.used)}</div>
            <div><strong>–õ–∏–º–∏—Ç:</strong> ${esc(info.memory.limit)}</div>

            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
            <div><strong>–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏:</strong> ${esc(info.performance.loadTime)}</div>
            <div><strong>DOM –∑–∞–≥—Ä—É–∂–µ–Ω:</strong> ${esc(info.performance.domContentLoaded)}</div>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #394866; text-align: center; font-size: 12px; color: #999;">
              –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ ¬© 2025
            </div>
          </div>
        `,
        onClose: () => { this.modal = null; }
      });

      // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏ SW
      this.getSWVersion().then((ver) => {
        const placeholder = this.modal?.querySelector?.('#sw-version-placeholder');
        if (placeholder) {
          placeholder.innerHTML = `<strong>SW –≤–µ—Ä—Å–∏—è:</strong> ${esc(ver)}`;
        }
      });
    }

    collectSystemInfo() {
      const APP_CONFIG = window.APP_CONFIG || {};
      
      return {
        app: {
          version: APP_CONFIG.APP_VERSION || window.VERSION || 'unknown',
          buildDate: APP_CONFIG.BUILD_DATE || window.BUILD_DATE || 'unknown',
          isPWA: window.matchMedia('(display-mode: standalone)').matches
        },
        browser: {
          userAgent: navigator.userAgent,
          language: navigator.language,
          online: navigator.onLine
        },
        device: {
          resolution: `${window.screen.width}√ó${window.screen.height}`,
          dpr: window.devicePixelRatio || 1,
          touch: 'ontouchstart' in window,
          platform: navigator.platform
        },
        player: {
          core: window.playerCore ? 'PlayerCore (Howler.js)' : '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω',
          howlerVersion: window.Howler ? Howler.version : 'N/A',
          webAudio: window.Howler ? Howler.usingWebAudio : false,
          html5: window.Howler ? !Howler.usingWebAudio : false
        },
        storage: {
          localStorage: this.checkLocalStorage(),
          indexedDB: 'indexedDB' in window,
          cacheAPI: 'caches' in window,
          serviceWorker: 'serviceWorker' in navigator
        },
        memory: this.getMemoryInfo(),
        performance: this.getPerformanceInfo()
      };
    }

    checkLocalStorage() {
      try {
        localStorage.setItem('test', '1');
        localStorage.removeItem('test');
        return true;
      } catch (e) {
        return false;
      }
    }

    getMemoryInfo() {
      if (performance.memory) {
        return {
          used: formatBytes(performance.memory.usedJSHeapSize),
          limit: formatBytes(performance.memory.jsHeapSizeLimit)
        };
      }
      return {
        used: 'N/A',
        limit: 'N/A'
      };
    }

    getPerformanceInfo() {
      const perf = performance.timing;
      const loadTime = perf.loadEventEnd - perf.navigationStart;
      const domTime = perf.domContentLoadedEventEnd - perf.navigationStart;

      return {
        loadTime: loadTime > 0 ? `${loadTime}ms` : 'N/A',
        domContentLoaded: domTime > 0 ? `${domTime}ms` : 'N/A'
      };
    }
    async getSWVersion() {
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        if (!registration || !registration.active) return 'N/A';

        return new Promise((resolve) => {
          const messageChannel = new MessageChannel();
          
          messageChannel.port1.onmessage = (event) => {
            resolve(event.data.version || 'N/A');
          };

          registration.active.postMessage(
            { type: 'GET_SW_VERSION' },
            [messageChannel.port2]
          );

          setTimeout(() => resolve('N/A'), 1000);
        });
      } catch {
        return 'N/A';
      }
    }

    hide() {
      if (this.modal) {
        this.modal.classList.remove('active');
        setTimeout(() => {
          if (this.modal && this.modal.parentNode) {
            this.modal.parentNode.removeChild(this.modal);
          }
          this.modal = null;
        }, 300);
      }
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.SystemInfoManager = new SystemInfoManager();
    });
  } else {
    window.SystemInfoManager = new SystemInfoManager();
  }

  console.log('‚úÖ System info manager initialized');
})();

//=================================================
// FILE: /scripts/ui/ui-utils.js
// scripts/ui/ui-utils.js
// –û–±—â–∏–µ UI-—É—Ç–∏–ª–∏—Ç—ã (–±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ playback)
// –í–ê–ñ–ù–û: –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º core utils. –ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ —Ç–æ–Ω–∫–∏–π —Ñ–∞—Å–∞–¥ (back-compat –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –º–æ–¥—É–ª–µ–π).

function _escFallback(s) {
  const v = String(s ?? '');
  // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π escape –±–µ–∑ DOM-–∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞–Ω–∏—è (fallback, –µ—Å–ª–∏ Utils –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω)
  return v.replace(/[<>&'"]/g, (m) => ({
    '<': '&lt;', '>': '&gt;', '&': '&amp;', "'": '&#39;', '"': '&quot;'
  }[m]));
}

export function esc(s) {
  const fn = window.Utils?.escapeHtml;
  return (typeof fn === 'function') ? fn(String(s ?? '')) : _escFallback(s);
}

export function formatBytes(n) {
  const fn = window.Utils?.formatBytes;
  if (typeof fn === 'function') return fn(n);
  // fallback (–æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π)
  const b = Number(n) || 0;
  if (b < 1024) return `${Math.floor(b)} B`;
  if (b < 1024 * 1024) return `${(b / 1024).toFixed(1)} KB`;
  if (b < 1024 * 1024 * 1024) return `${(b / (1024 * 1024)).toFixed(1)} MB`;
  return `${(b / (1024 * 1024 * 1024)).toFixed(2)} GB`;
}

export function getNetworkStatusSafe() {
  const fn = window.Utils?.getNetworkStatusSafe;
  if (typeof fn === 'function') return fn();
  return { online: navigator.onLine !== false, kind: 'unknown', saveData: false };
}

// ‚úÖ Non-ESM –¥–æ—Å—Ç—É–ø (sysinfo.js / sw-manager.js / –ø—Ä–æ—á–∏–µ IIFE)
try {
  window.UIUtils = window.UIUtils || {};
  window.UIUtils.esc = esc;
  window.UIUtils.formatBytes = formatBytes;
  window.UIUtils.getNetworkStatusSafe = getNetworkStatusSafe;
} catch {}

//=================================================
// FILE: /scripts/utils/sw-manager.js
// scripts/utils/sw-manager.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Service Worker –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

class ServiceWorkerManager {
  constructor() {
    this.registration = null;
    this.isSupported = 'serviceWorker' in navigator;
  }

  async init() {
    if (!this.isSupported) {
      console.warn('Service Worker not supported');
      return false;
    }

    try {
      this.registration = await navigator.serviceWorker.register('./service-worker.js', {
        scope: './'
      });

      console.log('‚úÖ Service Worker registered:', this.registration.scope);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      this.checkForUpdates();

      // –°–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      this.registration.addEventListener('updatefound', () => {
        this.handleUpdateFound();
      });

      // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–∫–∞–∂–¥—ã–π —á–∞—Å)
      setInterval(() => {
        this.checkForUpdates();
      }, 60 * 60 * 1000);

      return true;
    } catch (error) {
      console.error('Service Worker registration failed:', error);
      return false;
    }
  }

  checkForUpdates() {
    if (this.registration) {
      this.registration.update();
    }
  }

  handleUpdateFound() {
    const newWorker = this.registration.installing;
    
    newWorker.addEventListener('statechange', () => {
      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
        // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
        this.showUpdateNotification();
      }
    });
  }

  handleVersionMessage({ swVer, appVer } = {}) {
    // ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è update UI –∏–∑ AppModule (–∏ e2e).
    // –ù–∏–∫–∞–∫–∏—Ö confirm() ‚Äî —Ç–æ–ª—å–∫–æ –µ–¥–∏–Ω—ã–π UI (toast + –∫–Ω–æ–ø–∫–∞).
    const s = String(swVer || '').trim();
    const a = String(appVer || '').trim();
    if (!s) return;
    if (a && s === a) return;

    this.availableVersion = s;
    this.showUpdateNotification();
  }

  showUpdateNotification() {
    const ver = String(this.availableVersion || '').trim();
    const msg = ver
      ? `–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (${ver}).`
      : '–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.';

    window.NotificationSystem?.info(msg, 10000);

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    this.showUpdateButton();
  }

  showUpdateButton() {
    let updateBtn = document.getElementById('update-app-btn');
    
    if (!updateBtn) {
      updateBtn = document.createElement('button');
      updateBtn.id = 'update-app-btn';
      updateBtn.textContent = '–û–ë–ù–û–í–ò–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï';
      updateBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: #4daaff;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      
      updateBtn.addEventListener('click', () => {
        this.applyUpdate();
      });
      
      document.body.appendChild(updateBtn);
    }
    
    updateBtn.style.display = 'block';
  }

  async applyUpdate() {
    if (!this.registration || !this.registration.waiting) {
      return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–µ–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ reload –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
    try {
      if (window.PlayerState && typeof window.PlayerState.save === 'function') {
        window.PlayerState.save({ forReload: true });
      }
    } catch (e) {
      console.warn('PlayerState.save before SW update failed:', e);
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ SW –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è
    this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ SW
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    }, { once: true });
  }

  async clearCache(cacheType) {
    if (!this.registration || !this.registration.active) {
      return;
    }

    this.registration.active.postMessage({
      type: 'CLEAR_CACHE',
      payload: { cacheType }
    });

    window.NotificationSystem?.success('–ö—ç—à –æ—á–∏—â–µ–Ω');
  }

  async cacheAudioFiles(urls) {
    if (!this.registration || !this.registration.active) {
      return;
    }

    this.registration.active.postMessage({
      type: 'CACHE_AUDIO',
      payload: { urls }
    });
  }

  async getCacheSize() {
    if (!this.registration || !this.registration.active) {
      return 0;
    }

    return new Promise((resolve) => {
      const messageChannel = new MessageChannel();
      
      messageChannel.port1.onmessage = (event) => {
        resolve(event.data.size || 0);
      };

      this.registration.active.postMessage(
        { type: 'GET_CACHE_SIZE' },
        [messageChannel.port2]
      );
    });
  }

  formatCacheSize(bytes) {
    // ‚úÖ –µ–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞, –±–µ–∑ –¥—É–±–ª—è
    if (window.Utils?.formatBytes) return window.Utils.formatBytes(bytes);
    if (window.UIUtils?.formatBytes) return window.UIUtils.formatBytes(bytes);

    // fallback
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.ServiceWorkerManager = new ServiceWorkerManager();

// –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.ServiceWorkerManager.init();
  });
} else {
  window.ServiceWorkerManager.init();
}

// export default —É–¥–∞–ª—ë–Ω: —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ browser script —á–µ—Ä–µ–∑ window.ServiceWorkerManager


//=================================================
// FILE: /albums/gallery/news/news-01-baner.html
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ</title>
  <style>
    :root{
      --bg-0: #0b0e15;     /* –±–∞–∑–æ–≤—ã–π —Ñ–æ–Ω */
      --bg-1: #0f1422;     /* –ø–∞–Ω–µ–ª—å/–∫–∞—Ä—Ç–∞ */
      --bg-2: #0a0d17;     /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ–Ω */
      --text: #e8ecf6;     /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --muted: #a9b3c7;    /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π */
      --accent-1: #4aa3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã */
      --accent-2: #7be3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã 2 */
      --shadow: 0 12px 28px rgba(0,0,0,0.45), 0 3px 10px rgba(0,0,0,0.35);
      --radius: 16px;
      --radius-inner: 12px;
    }
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(120% 120% at 10% 10%, #111827 0%, #0b0e15 45%, #070a12 100%);
      color: var(--text);
      font: 500 16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    .wrap{
      position:relative;
      height:100%;
      width:100%;
      display:grid;
      place-items:center;
      padding:10px;
      box-sizing:border-box;
    }
    /* –í–Ω–µ—à–Ω—è—è ¬´–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è —Ä–∞–º–∫–∞¬ª */
    .frame{
      position:relative;
      width:100%;
      height:100%;
      max-width:900px;
      max-height:900px;
      border-radius: var(--radius);
      padding:1px; /* —Ç–æ–ª—â–∏–Ω–∞ —Ä–∞–º–∫–∏ */
      background: linear-gradient(135deg, rgba(74,163,255,0.85), rgba(123,227,255,0.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card{
      position:relative;
      width:100%;
      height:100%;
      border-radius: calc(var(--radius) - 1px);
      background:
        radial-gradient(140% 120% at 80% 0%, rgba(27,41,72,0.55), transparent 60%),
        radial-gradient(120% 140% at 0% 100%, rgba(18,30,58,0.6), transparent 55%),
        var(--bg-1);
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:16px;
      box-sizing:border-box;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .badge{
      align-self:flex-start;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(2px);
    }
    .title{
      font-weight:700;
      font-size: clamp(18px, 3vw, 24px);
      line-height:1.25;
      margin:0 4px;
      color: var(--text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.25);
    }
    .subtitle{
      margin: -6px 4px 2px;
      color: var(--muted);
      font-size: 14px;
    }

    /* –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø–ª–µ–µ—Ä–∞ */
    .embed{
      position:relative;
      margin-top: 4px;
      width:100%;
      flex: 1 1 auto;
      aspect-ratio: 1 / 1; /* —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç */
      border-radius: var(--radius-inner);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.8), rgba(6,8,15,0.92)),
        var(--bg-2);
      border:1px solid rgba(255,255,255,0.07);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 24px rgba(0,0,0,0.45);
    }
    /* ‚úÖ –í–º–µ—Å—Ç–æ iframe: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –≤—Å—é –æ–±–ª–∞—Å—Ç—å (–±–µ–∑ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—à–∏–±–æ–∫) */
    .embed-link{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: var(--text);
      text-decoration:none;
      font-weight:800;
      font-size: clamp(16px, 3vw, 22px);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.65), rgba(6,8,15,0.9)),
        var(--bg-2);
    }
    .embed-link:hover{
      filter: brightness(1.05);
    }
    .embed-link:active{
      filter: brightness(0.95);
    }

    /* –ù–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top: 4px;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      opacity: .9;
    }
    .cta{
      padding:8px 12px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      text-decoration:none;
      font-weight:600;
      transition: transform .12s ease, background .2s ease;
    }
    .cta:hover{ transform: translateY(-1px); }
    .cta:active{ transform: translateY(0); }

    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö –≤—ã—Å–æ—Ç–∞—Ö —Å–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
    @media (max-height: 420px){
      .card{ padding:12px; gap:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <section class="card" role="region" aria-label="–ù–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–Ω–Ω–µ—Ä ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏">
        <div class="badge">–ù–æ–≤–æ—Å—Ç–∏</div>
        <h1 class="title">¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª ‚Äî —É–∂–µ –Ω–∞ –Ø–Ω–¥–µ–∫—Å&nbsp;–ú—É–∑—ã–∫–µ</h1>
        <p class="subtitle">–°–ª—É—à–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º –≥—Ä—É–ø–ø—ã ¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª</p>

        <div class="embed" role="group" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ">
          <a class="embed-link"
             href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link"
             target="_blank"
             rel="noopener">
            –û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ
          </a>
        </div>

        <div class="footer">
          <div class="hint">–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏—Ç–µ ¬´–ø–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤ –ø–ª–µ–µ—Ä–µ, —á—Ç–æ–±—ã —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –¥—Ä—É–∑—å—è–º</div>
          <a class="cta" href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º</a>
        </div>
      </section>
    </div>
  </div>
</body>
</html>

//=================================================
// FILE: /generate-context.js
/* eslint-disable no-console */
"use strict";

/**
 * generate-context.js
 *
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä .meta/project-full.txt –∏ .meta/project-adaptive.txt
 * –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã):
 * 1) –í –Ω–∞—á–∞–ª–µ ‚Äî –±–ª–æ–∫ ¬´–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô¬ª, –∑–∞—Ç–µ–º –º–µ—Ç–∞‚Äë–±–ª–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º/URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–æ–º–µ—Ç–∫–æ–π –ø—Ä–æ GitHub.
 * 2) –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ‚Äî –ü–û–õ–ù–û–ï –¥–µ—Ä–µ–≤–æ –í–°–ï–• —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è assets/), –Ω–æ –±–µ–∑ .git/** –∏ .meta/**.
 *    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤.
 * 3) –ü–æ—Å–ª–µ –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º (critical ‚Üí high ‚Üí medium ‚Üí low),
 *    –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤—ã–≤–æ–¥–∏—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º. –ó–¥–µ—Å—å assets/** –∏—Å–∫–ª—é—á–∞–µ–º (–ø–æ –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é), .meta/** —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º.
 * 4) –ù–ï–¢ –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª.
 * 5) Adaptive-—Ä–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—â–∏–π –æ–±—ä—ë–º —Å—Ç—Ä–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º --max-lines (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20000).
 *
 * –ó–∞–ø—É—Å–∫:
 *   node generate-context.js --mode=both --max-lines=20000
 *   node generate-context.js --mode=full
 *   node generate-context.js --mode=adaptive --out-dir=.meta
 *
 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
 *   --mode=both|full|adaptive
 *   --max-lines=–ß–ò–°–õ–û           // —Ç–æ–ª—å–∫–æ –¥–ª—è adaptive
 *   --out-dir=–ü–£–¢–¨              // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é .meta
 *   --root=–ü–£–¢–¨                 // –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞)
 */

const fs = require("fs");
const path = require("path");

// -------------------- CLI --------------------
const argv = Object.fromEntries(
  process.argv.slice(2).map(a => {
    const [k, ...r] = a.replace(/^--/, "").split("=");
    return [k, r.join("=") === "" ? true : r.join("=")];
  })
);

const ROOT     = path.resolve(argv.root || __dirname);
const META_DIR = path.resolve(argv["out-dir"] || path.join(ROOT, ".meta"));
const MODE     = (argv.mode || "both").toLowerCase(); // full | adaptive | both
const MAX_LINES = Number(argv["max-lines"] || 20000);

// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ .meta
if (!fs.existsSync(META_DIR)) fs.mkdirSync(META_DIR, { recursive: true });

const FULL_FILE    = path.join(META_DIR, "project-full.txt");
const ADAPTIVE_FILE= path.join(META_DIR, "project-adaptive.txt");

// –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ self-—Ñ–∞–π–ª–∞–º (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è)
const SELF_FULL_REL  = toUnix(path.relative(ROOT, FULL_FILE));
const SELF_ADAPT_REL = toUnix(path.relative(ROOT, ADAPTIVE_FILE));

// -------------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ --------------------

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ç–æ—Ä—ã—Ö –≤–∫–ª—é—á–∞–µ–º –≤ —Å–µ–∫—Ü–∏—é ¬´–§–ê–ô–õ–´¬ª
const TEXT_EXTS = new Set([
  ".html",".htm",".css",".js",".mjs",".cjs",".ts",".tsx",
  ".json",".webmanifest",".md",".txt",".yml",".yaml"
]);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –°–ï–ö–¶–ò–ò ¬´–§–ê–ô–õ–´¬ª (—Ç–æ–ª—å–∫–æ –∫ –ª–∏—Å—Ç–∏–Ω–≥—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ù–ï –∫ –¥–µ—Ä–µ–≤—É):
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –∏—Å–∫–ª—é—á–∞–µ–º .meta/** –∏ assets/** (–Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ –∫–æ–Ω—Ç–µ–Ω—Ç),
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏.
 */
const EXCLUDE_FILES_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  "assets/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û –¥–ª—è –°–¢–†–£–ö–¢–£–†–´ –î–ï–†–ï–í–ê:
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã, –≤–∫–ª—é—á–∞—è assets/**.
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ .git/**, .meta/** –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ (node_modules –∏ —Ç.–ø.),
 *   –ø–ª—é—Å –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤.
 */
const EXCLUDE_TREE_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
const PRIORITY = {
  critical: [
    /^index\.html?$/i,
    /^service-worker\.js$/i,
    /^manifest\.json$/i,
    /^albums\.json$/i,
    /^custom\.json$/i,
    /^news\.html?$/i,
    /^generate-index\.(js|mjs|cjs)$/i,
    /^albums\/gallery\/[^/]+\/index\.json$/i,
    /^\.github\/workflows\/.*\.ya?ml$/i
  ],
  high: [
    /^AudioController\.(js|mjs|cjs|ts)$/i,
    /^GlobalState\.(js|mjs|cjs|ts)$/i,
    /^scripts\/.*\.(mjs|js|ts)$/i,
    /^performance\/.*\.(js|ts)$/i,
    /^.*\.(ya?ml)$/i
  ],
  medium: [
    /^.*\.(js|mjs|cjs|ts|tsx|json|html?|css)$/i
  ],
};

// -------------------- –£—Ç–∏–ª–∏—Ç—ã --------------------
function toUnix(p) {
  return String(p).replace(/\\/g, "/");
}
function globToRegExp(pat) {
  const esc = pat
    .replace(/[.+^${}()|[\]\\]/g, "\\$")
    .replace(/\*\*/g, "___GLOBSTAR___")
    .replace(/\*/g, "[^/]*")
    .replace(/___GLOBSTAR___/g, ".*");
  return new RegExp("^" + esc + "$");
}
function isTextFile(rel) {
  return TEXT_EXTS.has(path.extname(rel).toLowerCase());
}
function readText(rel) {
  try { return fs.readFileSync(path.join(ROOT, rel), "utf8"); }
  catch (e) { return `// read error: ${e.message}`; }
}
function countLines(s) {
  return (s.match(/\n/g) || []).length + (s.length ? 1 : 0);
}

// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
function isExcludedForFiles(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_FILES_PATTERNS.some(re => re.test(u));
}
// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –¥–µ—Ä–µ–≤–∞
function isExcludedForTree(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_TREE_PATTERNS.some(re => re.test(u));
}

// -------------------- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ --------------------
function listAllEntries(includeFiles = true, forTree = false) {
  const res = [];
  const stack = [ROOT];

  while (stack.length) {
    const dir = stack.pop();
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { continue; }

    for (const e of entries) {
      const full = path.join(dir, e.name);
      const rel = toUnix(path.relative(ROOT, full)) || ".";

      // –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –¥–ª—è –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–≤–æ–∏, –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî —Å–≤–æ–∏
      const excluded = forTree ? isExcludedForTree(rel) : isExcludedForFiles(rel);
      if (excluded) continue;

      if (e.isDirectory()) {
        res.push({ rel, full, dir: true });
        stack.push(full);
      } else if (e.isFile() && includeFiles) {
        res.push({ rel, full, dir: false });
      }
    }
  }

  // –ü–∞–ø–∫–∏ —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º —Ñ–∞–π–ª—ã; –≤–Ω—É—Ç—Ä–∏ ‚Äî –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  res.sort((a, b) => (a.dir !== b.dir ? (a.dir ? -1 : 1) : a.rel.localeCompare(b.rel)));
  return res;
}

function listTextFilesForContent() {
  return listAllEntries(true, /*forTree*/ false)
    .filter(e => !e.dir && isTextFile(e.rel))
    .map(e => e.rel);
}

// -------------------- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π --------------------
function readRepoMeta() {
  let url = "";
  try {
    const cfg = path.join(ROOT, ".git", "config");
    if (fs.existsSync(cfg)) {
      const raw = fs.readFileSync(cfg, "utf8");
      const m = raw.match(/url\s*=\s*(.+)\n/);
      if (m) url = m[1].trim();
    }
  } catch {}
  return {
    name: path.basename(ROOT),
    url: url || "(URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω; —É–∫–∞–∂–∏—Ç–µ –≤ .git/config)",
    madeWith: "–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).",
  };
}

// -------------------- –ë–ª–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ --------------------
function rulesBlock() {
  return [
    "–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):",
    "- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.",
    "- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.",
    "- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).",
    "- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:",
    "  ```ts",
    "  export function x() {}",
    "  ```",
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).",
    "- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.",
    "- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.",
    "- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.",
    "- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.",
    "- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].",
    "- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. ",
    "- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.",
    "- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).",
    "- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.",
    "- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤—ã–∑–≤–∞—Ç—å STOP —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–Ω—è—Ç –≤ favorites view, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞ –∏ –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ä–æ–≥–æ —Å–ª–µ–¥–∞, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–µ–º —á—Ç–æ-—Ç–æ –≤ –∫–æ–¥–µ",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏–ª–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –∫–æ–¥–µ, –Ω–æ –ø—Ä–∏—ç—Ç–æ–º –ø–æ–ª–Ω–æ—Å—Ç—å–± –±—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ –ª–æ–≥–∏–∫—É, –ª–æ–≥–∏—Å—Ç–∏–∫—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–µ–º–∏—Ç—å—Å—è –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —É–ø—Ä–æ—â–µ–Ω–∏—é –∫–æ–¥–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    ""
  ].join("\n");
}

function metaBlock() {
  const m = readRepoMeta();

  const favoritesPrinciplesBlock = [
    "## –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞",
    "–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ –≤ –ò–ó–ë–†–ê–ù–ù–û–ï:",
    "–õ–∞–π–∫/–∞–Ω–ª–∞–π–∫ (‚≠ê) = –∏–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ ‚≠ê —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö (—Ä–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º, ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª, –¥—Ä—É–≥–∏–µ —Å–ø–∏—Å–∫–∏).",
    "",
    "–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–∑ –æ–∫–Ω–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª",
    "–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äì —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.",
    "",
    "–ü–æ–¥—Ä–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã",
    "‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã):",
    "- –ü–æ—Å—Ç–∞–≤–∏–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π.",
    "- –°–Ω—è–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª (–¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º, ¬´–±–µ–∑ —Å–ª–µ–¥–∞¬ª).",
    "",
    "‚≠ê –≤ –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:",
    "- –°–Ω—è–ª–∏ ‚≠ê —Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–µ—Ä–æ–π (inactive), ‚≠ê —Å–Ω–∏–º–∞–µ—Ç—Å—è –∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª, –∏ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.",
    "- –°–Ω—è—Ç–∏–µ ‚≠ê –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ, –∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –µ—ë –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (‚Äú–±—É—Ñ–µ—Ä‚Äù).",
    "",
    "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π (—Å–µ—Ä–æ–π) —Å—Ç—Ä–æ–∫–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª:",
    "- –ö–ª–∏–∫ –ø–æ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–µ –ø–æ –∑–≤–µ–∑–¥–µ) ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:",
    "  - –í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, ‚≠ê —Å—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–µ–∑–¥–µ.",
    "  - –£–¥–∞–ª–∏—Ç—å ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê –ø—Ä–∏ —ç—Ç–æ–º —Å–Ω—è—Ç–∞.",
    "- –ö–ª–∏–∫ –ø–æ ‚≠ê –Ω–∞ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –º–æ–¥–∞–ª–∫–∏, —Å—Ç—Ä–æ–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å ‚≠ê.",
    "- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É (–∏–ª–∏ ‚Äú–±–µ–∑ —Å–ª–µ–¥–∞‚Äù —á–µ—Ä–µ–∑ –∞–Ω–ª–∞–π–∫ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ).",
    "",
    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:",
    "- –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚≠ê –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ –≤—Å–µ—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è—Ö –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫.",
    "- –í –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª: —Å–Ω—è—Ç–∏–µ ‚≠ê –Ω–∞ –ª—é–±–æ–π —Å—Ç—Ä–æ–∫–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.",
    "- –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É.",
    "",
    "–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:",
    "- –õ—é–±—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç—Ä–µ–∫–∞ –≤ inactive, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞.",
    "- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–µ—Å–Ω–∏ –ù–ï –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç ‚Äú–≤ —Ñ–æ–Ω–µ‚Äù.",
    "",
    "–û—Å–æ–±–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞:",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è inactive –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫.",
    "- –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî –ø–ª–µ–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º —Å—Ç–æ–ø, –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.",
    "",
    "–†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º –≤—Å–µ–≥–¥–∞ —Ä–µ—à–∞–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ:",
    "- –ï—Å–ª–∏ —Å–Ω—è—Ç—å ‚≠ê —Å —Ç—Ä–µ–∫–∞ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚Äî –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–ª—Å—è —Ç–∞–º –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è (—Å–µ—Ä–∞—è) —Å—Ç—Ä–æ–∫–∞.",
    "",
    "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ:",
    "- –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ ‚≠ê –Ω–∞ —Ç—Ä–µ–∫–µ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π.",
    "",
    "–ò—Ç–æ–≥–∏",
    "- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî —à–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–æ–π.",
    "- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚≠ê –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö.",
    "- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π: –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–¥–Ω–æ–º—É –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.",
    "- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.",
    "- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.",
    " =========================================================================== ",
    "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F (–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)",
    "–ö–Ω–æ–ø–∫–∞ F –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º Favorites Only –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞).",
    "–û–Ω–∞ –Ω–µ —Å—Ç–∞–≤–∏—Ç/–Ω–µ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê —É —Ç—Ä–µ–∫–æ–≤, –∞ —Ç–æ–ª—å–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç, –ø–æ –∫–∞–∫–∏–º —Ç—Ä–µ–∫–∞–º –º–æ–∂–Ω–æ —Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Next / Prev / –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏ –∫–∞–∫–∏–µ —Ç—Ä–µ–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ Shuffle.",
    "–ï–¥–∏–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø (–ø–æ–ª–Ω—ã–π –ø–ª–µ–µ—Ä –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä)",
    "–ü–æ–ª–Ω—ã–π –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ playing-–ø–ª–µ–π–ª–∏—Å—Ç–æ–º.",
    "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö: –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ playing, –∞ –Ω–µ –∫ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å–ø–∏—Å–∫—É.",
    "–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–¥–æ—Å—Ç—É–ø–Ω—ã–º —Ç—Ä–µ–∫–æ–º‚Äù",
    "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ ‚Äî —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤:",
    "Next / Prev",
    "–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —Ç—Ä–µ–∫–∞",
    "Shuffle-–ø–æ—Ä—è–¥–∫–µ (–µ—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω)",
    "–ü—Ä–∞–≤–∏–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:",
    "F = OFF: –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±—ã—á–Ω—ã–π –Ω–∞–±–æ—Ä playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞, –Ω–æ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å–º. ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –Ω–∏–∂–µ).",
    "F = ON: –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (‚≠ê) —Ç—Ä–µ–∫–∏ playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞.",
    "–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –æ–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º",
    "–ò–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ ‚≠ê –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ (–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ª–∞–π–∫–æ–≤).",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –≤ –∞–ª—å–±–æ–º–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ ‚≠ê —Ç—Ä–µ–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.",
    "–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä —Å—É–∂–∞–µ—Ç—Å—è –¥–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è OFF, –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞–ª—å–±–æ–º–∞, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ ‚≠ê –Ω–µ—Ç: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = ‚≠ê, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ —ç—Ç–æ–º—É shuffle-–ø–æ—Ä—è–¥–∫—É.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = –≤—Å–µ —Ç—Ä–µ–∫–∏, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–∞–±–æ—Ä—É, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –ò–ó–ë–†–ê–ù–ù–û–ï (–ø–ª–µ–π–ª–∏—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ)",
    "–í ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã active –∏ inactive:",
    "active: —Ç—Ä–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º (‚≠ê –µ—Å—Ç—å) ‚Äî —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏",
    "inactive: ‚≠ê —Å–Ω—è—Ç–∞, —Å—Ç—Ä–æ–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏",
    "–ë–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–≤–∞–∂–Ω–æ): inactive –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –≤ Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∏ shuffle-–ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø—Ä–∏ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ F.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –Ω–µ—Ç active (–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –Ω–µ—á–µ–≥–æ –∏–≥—Ä–∞—Ç—å): –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = active (–ø–æ —Ñ–∞–∫—Ç—É –æ–Ω –∏ —Ç–∞–∫ —Ç–∞–∫–æ–π), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ active.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è = active (inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ active.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –Ω–µ—Ç active: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active (–ø–æ—Ç–æ–º—É —á—Ç–æ inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)",
    "–ù–∞–∂–∞—Ç–∏–µ F –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–∞–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (‚≠ê –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –∏ –Ω–µ —Å–Ω–∏–º–∞–µ—Ç—Å—è).",
    "–ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ (–Ω–µ—Ç ‚≠ê –≤ –∞–ª—å–±–æ–º–µ / –Ω–µ—Ç active –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ): –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∏ F –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è (–æ—Å—Ç–∞—ë—Ç—Å—è OFF).",
    "inactive –≤ –ò–ó–ë–†–ê–ù–ù–û–ú ‚Äî —ç—Ç–æ UI-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è, –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∏ –≤ –∫–∞–∫–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –Ω–∏ –≤ Next/Prev, –Ω–∏ –≤ Shuffle.",
    ""
  ].join("\n");

  return [
    `–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.name}`,
    `–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.url}`,
    "# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.",
    favoritesPrinciplesBlock,
    m.madeWith,
    ""
  ].join("\n");
}

// -------------------- –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê (–¥–µ—Ä–µ–≤–æ) --------------------
function buildFullTree() {
  const lines = [];
  lines.push(path.basename(ROOT) + "/");

  function walk(dir, prefix = "") {
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { return; }

    const visible = entries
      .filter(e => !isExcludedForTree(toUnix(path.relative(ROOT, path.join(dir, e.name)))))
      .sort((a, b) => (a.isDirectory() !== b.isDirectory() ? (a.isDirectory() ? -1 : 1) : a.name.localeCompare(b.name)));

    visible.forEach((e, i) => {
      const isLast = i === visible.length - 1;
      const branch = isLast ? "‚îî‚îÄ‚îÄ " : "‚îú‚îÄ‚îÄ ";
      lines.push(prefix + branch + e.name + (e.isDirectory() ? "/" : ""));
      if (e.isDirectory()) {
        walk(path.join(dir, e.name), prefix + (isLast ? "    " : "‚îÇ   "));
      }
    });
  }

  walk(ROOT);
  return lines.join("\n") + "\n\n";
}

// -------------------- –°–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª --------------------
function getPriority(rel) {
  const u = toUnix(rel);
  for (const [lvl, rules] of Object.entries(PRIORITY)) {
    if (rules.some(re => re.test(u))) return lvl;
  }
  return "low";
}

function groupFilesByPriority() {
  const all = listTextFilesForContent(); // —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω—ã assets/.meta –∏ –ø—Ä–æ—á–∏–µ –ø–æ EXCLUDE_FILES_PATTERNS
  return {
    critical: all.filter(f => getPriority(f) === "critical"),
    high:     all.filter(f => getPriority(f) === "high"),
    medium:   all.filter(f => getPriority(f) === "medium"),
    low:      all.filter(f => getPriority(f) === "low"),
  };
}

function fileBlock(rel) {
  return [
    "//=================================================",
    `// FILE: /${toUnix(rel)}`,
    readText(rel),
    ""
  ].join("\n");
}

// -------------------- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞ --------------------
function headerBlock() {
  const now = new Date().toISOString().replace("T"," ").slice(0,19) + " UTC";
  return [
    rulesBlock(),
    metaBlock(),
    "–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:",
    buildFullTree(),
    `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${now}`,
    ""
  ].join("\n");
}

// -------------------- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã --------------------
function generateFull() {
  let out = headerBlock();

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium", "low"];
  for (const lvl of order) {
    for (const f of groups[lvl]) {
      out += fileBlock(f);
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

function generateAdaptive() {
  let out = headerBlock();
  let cur = countLines(out);
  const max = MAX_LINES;

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium"]; // low –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ adaptive —á–∞—â–µ –≤—Å–µ–≥–æ

  for (const lvl of order) {
    for (const f of groups[lvl]) {
      const block = fileBlock(f);
      const L = countLines(block);
      if (cur + L > max) {
        out += "\n// ... (truncate)\n";
        return out;
      }
      out += block; cur += L;
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

// -------------------- MAIN --------------------
function main() {
  if (MODE === "full" || MODE === "both") {
    fs.writeFileSync(FULL_FILE, generateFull(), "utf8");
    console.log(`‚úÖ ${FULL_FILE}`);
  }
  if (MODE === "adaptive" || MODE === "both") {
    fs.writeFileSync(ADAPTIVE_FILE, generateAdaptive(), "utf8");
    console.log(`‚úÖ ${ADAPTIVE_FILE}`);
  }
}

try { main(); } catch (e) { console.error("‚ùå", e); process.exit(1); }

//=================================================
// FILE: /news/news.json
{
  "items": [
    {
      "id": "2025-11-01-release",
      "title": "–ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ ‚Äî –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "date": "2025-11-01",
      "text": "–î–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
      "image": "img/logo.png",
      "tags": ["—Ä–µ–ª–∏–∑", "–∞–ª—å–±–æ–º"]
    },
    {
      "id": "2025-10-20-video",
      "title": "–ö–ª–∏–ø –Ω–∞ —Ç—Ä–µ–∫ ¬´–û—Ç—Ä–∞–∂–µ–Ω–∏–µ¬ª",
      "date": "2025-10-20",
      "embedUrl": "https://www.youtube.com/embed/dQw4w9WgXcQ",
      "tags": ["–∫–ª–∏–ø", "–≤–∏–¥–µ–æ"]
    },
    {
      "id": "2025-10-05-tour",
      "title": "–¢—É—Ä: –∑–∏–º–Ω–∏–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã",
      "date": "2025-10-05",
      "text": "–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü—Å–µ—Ç—è—Ö.",
      "tags": ["–∫–æ–Ω—Ü–µ—Ä—Ç—ã"]
    }
  ]
}

//=================================================
// FILE: /src/player-core/media-session.js
// src/player-core/media-session.js
// MediaSession: handlers —Å—Ç–∞–≤–∏–º –æ–¥–∏–Ω —Ä–∞–∑, metadata/position –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ –º–µ—Ä–µ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏.

export function ensureMediaSession(handlers) {
  if (!('mediaSession' in navigator)) return null;

  const ms = navigator.mediaSession;

  // guard: —Å—Ç–∞–≤–∏–º handlers 1 —Ä–∞–∑
  if (!ms.__vitrinaHandlersBound) {
    ms.__vitrinaHandlersBound = true;

    const h = handlers || {};

    const safe = (fn) => () => { try { fn && fn(); } catch {} };

    ms.setActionHandler('play', safe(h.onPlay));
    ms.setActionHandler('pause', safe(h.onPause));
    ms.setActionHandler('stop', safe(h.onStop));
    ms.setActionHandler('previoustrack', safe(h.onPrev));
    ms.setActionHandler('nexttrack', safe(h.onNext));

    ms.setActionHandler('seekbackward', (details) => {
      const off = Number(details?.seekOffset || 10);
      try { h.onSeekBy && h.onSeekBy(-off); } catch {}
    });

    ms.setActionHandler('seekforward', (details) => {
      const off = Number(details?.seekOffset || 10);
      try { h.onSeekBy && h.onSeekBy(off); } catch {}
    });

    ms.setActionHandler('seekto', (details) => {
      const t = Number(details?.seekTime);
      if (!Number.isFinite(t)) return;
      try { h.onSeekTo && h.onSeekTo(t); } catch {}
    });
  }

  const buildArtwork = (artworkUrl) => {
    const src = String(artworkUrl || '').trim();
    if (!src) return [];
    return [
      { src, sizes: '96x96', type: 'image/png' },
      { src, sizes: '128x128', type: 'image/png' },
      { src, sizes: '192x192', type: 'image/png' },
      { src, sizes: '256x256', type: 'image/png' },
      { src, sizes: '384x384', type: 'image/png' },
      { src, sizes: '512x512', type: 'image/png' },
    ];
  };

  function updateMetadata({ title, artist, album, artworkUrl, playing } = {}) {
    try {
      ms.metadata = new MediaMetadata({
        title: String(title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
        artist: String(artist || ''),
        album: String(album || ''),
        artwork: buildArtwork(artworkUrl),
      });
    } catch {}

    try { ms.playbackState = playing ? 'playing' : 'paused'; } catch {}
  }

  function updatePositionState() {
    try {
      if (typeof ms.setPositionState !== 'function') return;
      const st = handlers?.getPositionState ? handlers.getPositionState() : null;
      if (!st) return;

      ms.setPositionState({
        duration: Number(st.duration || 0) || 0,
        playbackRate: Number(st.playbackRate || 1.0) || 1.0,
        position: Number(st.position || 0) || 0,
      });
    } catch {}
  }

  return { updateMetadata, updatePositionState };
}

//=================================================
// FILE: /src/player-core/stats-tracker.js
// src/player-core/stats-tracker.js
// –ï–¥–∏–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
// - —Å–µ–∫—É–Ω–¥—ã: lastSecondReported (—É—Å—Ç–æ–π—á–∏–≤–æ, –±–µ–∑ "Math.floor(pos) > Math.floor(lastPos)" —Ä–∞–∑–±—Ä–æ—Å–∞)
// - full listen: duration –≤–∞–ª–∏–¥–Ω–∞ –∏ (pos/dur > 0.9) –Ω–∞ –º–æ–º–µ–Ω—Ç ended
// - –Ω–∏–∫–∞–∫–∏—Ö stop/play/seek –≤–Ω—É—Ç—Ä–∏

function safeUid(v) {
  const s = String(v || '').trim();
  return s ? s : null;
}

export function createListenStatsTracker({ getUid, getPos, getDur, record } = {}) {
  const state = {
    lastSecondReported: -1,
    activeUid: null,
  };

  function resetForUid(uid) {
    state.activeUid = uid;
    state.lastSecondReported = -1;
  }

  function onTick() {
    const uid = safeUid(getUid && getUid());
    if (!uid) return;

    if (uid !== state.activeUid) resetForUid(uid);

    const pos = Number(getPos && getPos()) || 0;
    const sec = Math.floor(pos);

    if (!Number.isFinite(sec) || sec < 0) return;
    if (sec <= state.lastSecondReported) return;

    state.lastSecondReported = sec;

    try {
      record && record(uid, { deltaSec: 1, isFullListen: false });
    } catch {}
  }

  function onPauseOrStop() {
    // —Å–µ–π—á–∞—Å —Å–µ–∫—É–Ω–¥—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ onTick; –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–∞—ë–º –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å lastSecond –º–µ–∂–¥—É —Ç—Ä–µ–∫–∞–º–∏
    const uid = safeUid(getUid && getUid());
    if (!uid) return;
    if (uid !== state.activeUid) resetForUid(uid);
  }

  function onEnded() {
    const uid = safeUid(getUid && getUid());
    if (!uid) return;

    if (uid !== state.activeUid) resetForUid(uid);

    const dur = Number(getDur && getDur()) || 0;
    const pos = Number(getPos && getPos()) || 0;

    const durationValid = Number.isFinite(dur) && dur > 0;
    const progress = durationValid ? (pos / dur) : 0;

    const isFullListen = !!(durationValid && progress > 0.9);

    try {
      record && record(uid, { deltaSec: 0, isFullListen });
    } catch {}
  }

  return { onTick, onPauseOrStop, onEnded };
}

//=================================================
// FILE: /src/PlayerCore.js
// src/PlayerCore.js
import { ensureMediaSession } from './player-core/media-session.js';
import { createListenStatsTracker } from './player-core/stats-tracker.js';

(function () {
  'use strict';

  const W = window;
  const U = W.Utils;

  const clamp = U?.clamp || ((n, a, b) => Math.max(a, Math.min(b, n)));
  const isIOS = U?.isIOS || (() => /iPad|iPhone|iPod/.test(navigator.userAgent) && !W.MSStream);

  const normQ = (v) => (String(v || '').toLowerCase().trim() === 'lo' ? 'lo' : 'hi');
  const safeStr = (v) => {
    const s = String(v ?? '').trim();
    return s ? s : null;
  };

  class PlayerCore {
    constructor() {
      this.playlist = [];
      this.originalPlaylist = [];
      this.currentIndex = -1;

      // ‚úÖ Guard against races: old Howl events must not affect new playback
      // (fixes rare double-play / wrong end/next cascades)
      this._loadToken = 0;
      this.originalPlaylist = [];
      this.currentIndex = -1;

      this.sound = null;
      this.isReady = false;

      this.repeatMode = false;
      this.shuffleMode = false;

      this.shuffleHistory = [];
      this.historyMax = 200;

      this.tickInterval = null;
      this.tickRate = 100;

      this.callbacks = {
        onTrackChange: [],
        onPlay: [],
        onPause: [],
        onStop: [],
        onEnd: [],
        onTick: [],
        onError: [],
        onSleepTriggered: [],
      };

      this.metadata = { artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞', album: '', cover: '' };

      this.sleepTimerTarget = 0;
      this.sleepTimerId = null;

      this.qualityStorageKey = 'qualityMode:v1';
      this.qualityMode = this._readQualityMode();

      this.sourceKey = 'audio';

      // =========================
      // Favorites (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
      // Storage:
      // - likedTrackUids:v1 => { [albumKey]: string[] }  (–¥–ª—è favoritesOnly –≤ –∞–ª—å–±–æ–º–∞—Ö, back-compat e2e)
      // - favoritesAlbumRefsByUid:v1 => [{ a: albumKey, uid: string }]
      // Business rules:
      // - toggle in album (fromAlbum=true): unlike => remove ref "–±–µ–∑ —Å–ª–µ–¥–∞"
      // - toggle in favorites view (fromAlbum=false): unlike => inactive (ref stays)
      // - In favorites playlist playing: unlike current active => next; if last active => STOP (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π STOP –æ—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ)
      this._fav = {
        likedKey: 'likedTrackUids:v1',
        refsKey: 'favoritesAlbumRefsByUid:v1',
      };

      // Favorites internal emitter (–∑–∞–º–µ–Ω–∞ DOM CustomEvent 'favorites:changed')
      this._favEmitter = {
        subs: new Set(),
        emit: (payload) => {
          for (const fn of this._favEmitter.subs) {
            try { fn(payload); } catch {}
          }
        }
      };

      // Refs index cache: uid -> Set(albumKey)
      this._favRefsIndex = { built: false, map: new Map() };

      this._offlineNoCacheToastShown = false;
      this._hasAnyOfflineCacheComplete = null;

      // iOS unlock (single source of truth)
      this._ios = {
        armed: false,
        unlocked: false,
        unsubs: [],
      };

      this._mediaSession = ensureMediaSession({
        onPlay: () => this.play(),
        onPause: () => this.pause(),
        onStop: () => this.stop(),
        onPrev: () => this.prev(),
        onNext: () => this.next(),
        onSeekTo: (t) => this.seek(t),
        onSeekBy: (delta) => {
          const pos = this.getPosition();
          const dur = this.getDuration();
          this.seek(clamp(pos + delta, 0, dur || 0));
        },
        getPositionState: () => ({
          duration: this.getDuration(),
          position: this.getPosition(),
          playbackRate: 1.0,
        }),
      });

      this._stats = createListenStatsTracker({
        getUid: () => safeStr(this.getCurrentTrack()?.uid),
        getPos: () => this.getPosition(),
        getDur: () => this.getDuration(),
        record: (uid, payload) => {
          const om = W.OfflineUI?.offlineManager;
          if (om?.recordListenStats) om.recordListenStats(uid, payload);
        },
      });
    }

    initialize() {
      this.isReady = true;
      this._armIOSUnlock();
    }

    // =========================
    // iOS unlock (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)
    // =========================
    _armIOSUnlock() {
      if (this._ios.armed || !isIOS()) return;
      this._ios.armed = true;

      const handler = () => { this._ensureAudioUnlocked(); };

      // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ –ø–æ iOS: touchend/click + pointerdown
      const add = (t, ev) => {
        t.addEventListener(ev, handler, { passive: true });
        this._ios.unsubs.push(() => { try { t.removeEventListener(ev, handler, { passive: true }); } catch {} });
      };

      add(document, 'touchend');
      add(document, 'touchstart');
      add(document, 'click');
      add(window, 'pointerdown');
      add(window, 'pageshow'); // –≤–æ–∑–≤—Ä–∞—Ç –∏–∑ BFCache
      add(document, 'visibilitychange'); // –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∏–∑ —Ñ–æ–Ω–∞
    }

    async _ensureAudioUnlocked() {
      if (this._ios.unlocked || !isIOS()) return true;

      // –õ—É—á—à–µ–µ —á—Ç–æ –º–æ–∂–Ω–æ: –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç Howler
      try {
        const ctx = W.Howler?.ctx;
        if (ctx && ctx.state === 'suspended') await ctx.resume();
        this._ios.unlocked = true;

        // –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ unlock –º–æ–∂–Ω–æ —Å–Ω—è—Ç—å —á–∞—Å—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–µ–π (—ç–∫–æ–Ω–æ–º–∏—è)
        if (this._ios.unsubs.length) {
          const unsubs = this._ios.unsubs.slice();
          this._ios.unsubs.length = 0;
          for (const off of unsubs) { try { off(); } catch {} }
        }

        return true;
      } catch {
        return false;
      }
    }

    // =========================
    // Playlist
    // =========================
    setPlaylist(tracks, startIndex = 0, metadata = {}, options = {}) {
      const wasPlaying = this.isPlaying();
      const prev = this.getCurrentTrack();
      const prevUid = safeStr(prev?.uid);
      const prevPos = this.getPosition();

      const {
        preserveOriginalPlaylist = false,
        preserveShuffleMode = false,
        resetHistory = true,

        // ‚úÖ –í–ê–ñ–ù–û: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é PlayerCore —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞,
        // —á—Ç–æ–±—ã –Ω–µ —Ä–≤–∞—Ç—å playback (favoritesOnly/shuffle/like/unlike –∏ —Ç.–ø.).
        // –ù–æ –ø—Ä–∏ –ø—Ä—è–º–æ–º –≤—ã–±–æ—Ä–µ —Ç—Ä–µ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω—É–∂–Ω–æ –í–°–ï–ì–î–ê —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å —Å 0:00.
        preservePosition = true,
      } = options || {};

      this._hasAnyOfflineCacheComplete = null;

      this.playlist = (Array.isArray(tracks) ? tracks : []).map((t) => {
        const uid = safeStr(t?.uid);
        const sources = (t && typeof t === 'object' && t.sources && typeof t.sources === 'object') ? t.sources : null;

        const src = this._selectSrc({
          legacySrc: t?.src,
          sources,
          sourceKey: this.sourceKey,
          qualityMode: this.qualityMode,
        });

        return {
          src: safeStr(src),
          sources,
          title: t?.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
          artist: t?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          album: t?.album || '',
          cover: t?.cover || '',
          lyrics: t?.lyrics || null,
          fulltext: t?.fulltext || null,
          uid,
          hasLyrics: (typeof t?.hasLyrics === 'boolean') ? t.hasLyrics : null,
          sourceAlbum: t?.sourceAlbum || null,
        };
      });

      if (!preserveOriginalPlaylist) this.originalPlaylist = this.playlist.slice();
      this.metadata = { ...this.metadata, ...(metadata || {}) };
      if (resetHistory) this.shuffleHistory = [];

      if (this.shuffleMode && !preserveShuffleMode) this.shufflePlaylist();

      let nextIndex = -1;
      if (prevUid) nextIndex = this.playlist.findIndex(t => safeStr(t?.uid) === prevUid);

      if (nextIndex < 0) {
        const len = this.playlist.length;
        nextIndex = len ? clamp(startIndex, 0, len - 1) : -1;
      }

      this.currentIndex = nextIndex;

      if (wasPlaying && this.currentIndex >= 0) {
        this.load(this.currentIndex, {
          autoPlay: true,
          resumePosition: preservePosition ? prevPos : null
        });
      }
      else {
        const cur = this.getCurrentTrack();
        if (cur) {
          this.trigger('onTrackChange', cur, this.currentIndex);
          this._updateMedia(cur);
        }
      }
    }

    getPlaylistSnapshot() { return this.playlist.slice(); }

    // =========================
    // Playback resolving
    // =========================
    async _resolvePlaybackUrlForTrack(track) {
      try {
        const om = W.OfflineUI?.offlineManager;
        if (!om?.resolveForPlayback) {
          return { url: safeStr(track?.src), effectiveQuality: this.getQualityMode(), isLocal: false, reason: 'noOfflineManager' };
        }

        const pq = this.getQualityMode();
        const r = await om.resolveForPlayback(track, pq);
        return {
          url: safeStr(r?.url),
          effectiveQuality: normQ(r?.effectiveQuality || pq),
          isLocal: !!r?.isLocal,
          reason: String(r?.reason || ''),
        };
      } catch {
        return { url: safeStr(track?.src), effectiveQuality: this.getQualityMode(), isLocal: false, reason: 'resolverError' };
      }
    }

    async _getHasAnyOfflineCompleteCached() {
      if (this._hasAnyOfflineCacheComplete === true) return true;
      if (this._hasAnyOfflineCacheComplete === false) return false;

      try {
        const om = W.OfflineUI?.offlineManager;
        if (!om?.hasAnyComplete) return (this._hasAnyOfflineCacheComplete = false);

        const uids = this.playlist.map(t => safeStr(t?.uid)).filter(Boolean);
        const yes = await om.hasAnyComplete(uids);
        this._hasAnyOfflineCacheComplete = !!yes;
        return !!yes;
      } catch {
        this._hasAnyOfflineCacheComplete = false;
        return false;
      }
    }

    async _findNextPlayableIndex(direction) {
      const len = this.playlist.length;
      if (!len) return -1;

      const dir = (direction === 'backward') ? -1 : 1;
      const base = this.currentIndex >= 0 ? this.currentIndex : 0;

      for (let step = 1; step <= len; step++) {
        const idx = (base + dir * step + len) % len;
        const t = this.playlist[idx];
        if (!t) continue;

        // eslint-disable-next-line no-await-in-loop
        const r = await this._resolvePlaybackUrlForTrack(t);
        if (r.url) return idx;
      }
      return -1;
    }

    _isNetworkOnline() {
      try {
        if (W.NetworkManager?.getStatus) return !!W.NetworkManager.getStatus().online;
      } catch {}
      return navigator.onLine !== false;
    }

    async _skipUnavailableAndPlay(direction) {
      const idx = await this._findNextPlayableIndex(direction === 'backward' ? 'backward' : 'forward');
      if (idx >= 0) {
        this.currentIndex = idx;
        await this.play(idx);
        return true;
      }

      if (!this._offlineNoCacheToastShown) {
        this._offlineNoCacheToastShown = true;
        W.NotificationSystem?.warning?.('–ù–µ—Ç —Å–µ—Ç–∏ –∏ –Ω–µ—Ç –æ—Ñ–ª–∞–π–Ω-–∫—ç—à–∞');
      }
      return false;
    }

    // =========================
    // Public controls
    // =========================
    async play(index = null, options = {}) {
      await this._ensureAudioUnlocked();

      if (index !== null && Number.isFinite(index) && index >= 0 && index < this.playlist.length) {
        await this.load(index, options);
      }

      this._pushHistoryForCurrent();
      if (!this.sound) return;

      try {
        this.sound.play();
      } catch {
        // iOS –∏–Ω–æ–≥–¥–∞ –∫–∏–¥–∞–µ—Ç sync-–æ—à–∏–±–∫—É ‚Äî –ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑ –ø–æ—Å–ª–µ unlock
        await this._ensureAudioUnlocked();
        try { this.sound?.play(); } catch {}
      }

      this._updateMedia(this.getCurrentTrack());
    }

    pause() {
      if (!this.sound) return;
      this.sound.pause();
      this.stopTick();
      this._stats.onPauseOrStop();
      this.trigger('onPause', this.getCurrentTrack(), this.currentIndex);
      this._updateMedia(this.getCurrentTrack());
    }

    stop() {
      // –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –Ω–∞—Å—Ç–æ—è—â–∏–π STOP: –ø–æ –∫–Ω–æ–ø–∫–µ —Å—Ç–æ–ø (–∏–ª–∏ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ).
      if (this.sound) {
        try { this.sound.stop(); } catch {}
        try { this.sound.unload(); } catch {}
        this.sound = null;
      }
      this.stopTick();
      this._stats.onPauseOrStop();
      this.trigger('onStop', this.getCurrentTrack(), this.currentIndex);
      this._updateMedia(this.getCurrentTrack());
    }

    _silentUnloadCurrentSound() {
      // –í–ê–ñ–ù–û: —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç—Ä–µ–∫–∞/–∫–∞—á–µ—Å—Ç–≤–∞.
      // –û–Ω –ù–ï –¥–æ–ª–∂–µ–Ω —Å—á–∏—Ç–∞—Ç—å—Å—è "STOP" —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è UX-–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
      // –ü–æ—ç—Ç–æ–º—É:
      // - –Ω–µ —ç–º–∏—Ç–∏–º onStop
      // - –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π stop()
      // - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–∫ –∏ –≤—ã–≥—Ä—É–∂–∞–µ–º Howl –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–∏—Ö–æ
      if (this.sound) {
        try { this.sound.pause(); } catch {}
        try { this.sound.unload(); } catch {}
        this.sound = null;
      }
      this.stopTick();
      this._stats.onPauseOrStop();
    }

    async load(index, options = {}) {
      if (!Number.isFinite(index) || index < 0 || index >= this.playlist.length) return;

      const { autoPlay = false, resumePosition = null } = options || {};
      let html5 = (typeof options.html5 === 'boolean') ? options.html5 : true;

      // ‚úÖ Increment token BEFORE unloading/creating, so any late events from previous Howl are ignored.
      const token = ++this._loadToken;

      this._silentUnloadCurrentSound();

      this.currentIndex = index;
      const track = this.playlist[index];
      if (!track) return;

      const resolved = await this._resolvePlaybackUrlForTrack(track);
      if (resolved.isLocal) html5 = false;

      if (!resolved.url) {
        const netOnline = this._isNetworkOnline();
        if (!netOnline) {
          const dir = (options && options.direction === 'backward') ? 'backward' : 'forward';
          await this._skipUnavailableAndPlay(dir);
          return;
        }

        const hasAny = await this._getHasAnyOfflineCompleteCached();
        if (!hasAny) {
          if (!this._offlineNoCacheToastShown) {
            this._offlineNoCacheToastShown = true;
            W.NotificationSystem?.warning?.('–ù–µ—Ç —Å–µ—Ç–∏ –∏ –Ω–µ—Ç –æ—Ñ–ª–∞–π–Ω-–∫—ç—à–∞');
          }
          return;
        }

        const fallbackIdx = await this._findNextPlayableIndex('forward');
        if (fallbackIdx >= 0 && fallbackIdx !== index) {
          this.currentIndex = fallbackIdx;
          this.play(fallbackIdx);
        }
        return;
      }

      this.playlist[index].src = resolved.url;

      await this._ensureAudioUnlocked();

      const initialVolume = this.getVolume() / 100;

      this.sound = new Howl({
        src: [resolved.url],
        html5,
        preload: true,
        volume: initialVolume,

        onplay: () => {
          if (token !== this._loadToken) return;
          this.startTick();
          this.trigger('onPlay', track, index);
          this._updateMedia(this.getCurrentTrack());
        },

        onpause: () => {
          if (token !== this._loadToken) return;
          this.stopTick();
          this._stats.onPauseOrStop();
          this.trigger('onPause', track, index);
          this._updateMedia(this.getCurrentTrack());
        },

        onend: () => {
          if (token !== this._loadToken) return;
          this.stopTick();
          this._stats.onEnded();
          this.trigger('onEnd', track, index);
          this._updateMedia(this.getCurrentTrack());
          this.handleTrackEnd();
        },

        onload: () => {
          if (token !== this._loadToken) return;

          if (typeof resumePosition === 'number' && Number.isFinite(resumePosition) && resumePosition > 0) {
            try { this.seek(resumePosition); } catch {}
          }

          // ‚úÖ CRITICAL: do NOT call this.play() here (it can re-enter load/play pipeline).
          // Only start current Howl instance.
          if (autoPlay) {
            try { this.sound?.play?.(); } catch {}
          }

          this._updateMedia(this.getCurrentTrack());
        },

        onloaderror: (id, error) => {
          if (token !== this._loadToken) return;
          this.trigger('onError', { type: 'load', error, track, index });
        },

        onplayerror: (id, error) => {
          if (token !== this._loadToken) return;
          this.trigger('onError', { type: 'play', error, track, index });
        },
      });

      this.trigger('onTrackChange', track, index);
      this._updateMedia(track);
    }

    handleTrackEnd() {
      if (this.repeatMode) return void this.play(this.currentIndex);
      this.next();
    }

    next() {
      const len = this.playlist.length;
      if (!len) return;
      this._pushHistoryForCurrent();
      const cur = this.currentIndex >= 0 ? this.currentIndex : 0;
      this.play((cur + 1) % len, { direction: 'forward' });
    }

    prev() {
      const len = this.playlist.length;
      if (!len) return;

      if (this.getPosition() > 3) return void this.seek(0);

      const histIdx = this._popHistoryPrevIndex();
      if (Number.isFinite(histIdx) && histIdx >= 0) return void this.play(histIdx, { direction: 'backward' });

      const cur = this.currentIndex >= 0 ? this.currentIndex : 0;
      this.play((cur - 1 + len) % len, { direction: 'backward' });
    }

    // =========================
    // Seek / Position
    // =========================
    seek(seconds) {
      if (!this.sound) return;
      const t = Number(seconds);
      if (Number.isFinite(t)) this.sound.seek(t);
    }

    getPosition() { return this.sound ? (Number(this.sound.seek() || 0) || 0) : 0; }
    getDuration() { return this.sound ? (Number(this.sound.duration() || 0) || 0) : 0; }

    // =========================
    // Volume / Mute
    // =========================
    setVolume(percent) {
      const p = clamp(Number(percent) || 0, 0, 100);
      const v = p / 100;

      if (this.sound) { try { this.sound.volume(v); } catch {} }
      try { Howler.volume(v); } catch {}
      try { localStorage.setItem('playerVolume', String(Math.round(p))); } catch {}
    }

    getVolume() {
      const n = Number.parseInt(String(localStorage.getItem('playerVolume') ?? ''), 10);
      return Number.isFinite(n) ? clamp(n, 0, 100) : 100;
    }

    setMuted(muted) {
      try { Howler.mute(!!muted); } catch {}
      try { this.sound?.mute?.(!!muted); } catch {}
    }

    // =========================
    // Repeat / Shuffle
    // =========================
    toggleRepeat() { this.repeatMode = !this.repeatMode; }
    isRepeat() { return this.repeatMode; }

    setShuffleMode(enabled) {
      const next = !!enabled;
      if (this.shuffleMode === next) return;
      this.shuffleMode = next;
      this.playlist = next ? (this.shufflePlaylist(), this.playlist) : this.originalPlaylist.slice();
    }

    toggleShuffle() { this.setShuffleMode(!this.shuffleMode); }
    isShuffle() { return this.shuffleMode; }

    shufflePlaylist() {
      const currentTrack = this.getCurrentTrack();
      const curUid = safeStr(currentTrack?.uid);

      this.shuffleHistory = [];

      const shuffled = this.playlist.slice();
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      this.playlist = shuffled;

      if (!currentTrack) return;

      if (curUid) {
        const byUid = this.playlist.findIndex(t => safeStr(t?.uid) === curUid);
        if (byUid >= 0) this.currentIndex = byUid;
      } else {
        const src = safeStr(currentTrack?.src);
        const bySrc = src ? this.playlist.findIndex(t => safeStr(t?.src) === src) : -1;
        if (bySrc >= 0) this.currentIndex = bySrc;
      }
    }

    // =========================
    // PQ Hi/Lo
    // =========================
    _readQualityMode() {
      try { return normQ(localStorage.getItem(this.qualityStorageKey)); } catch { return 'hi'; }
    }

    _writeQualityMode(mode) {
      const m = normQ(mode);
      try { localStorage.setItem(this.qualityStorageKey, m); } catch {}
      return m;
    }

    getQualityMode() { return normQ(this.qualityMode); }
    setQualityMode(mode) { return (this.qualityMode = this._writeQualityMode(mode)); }

    _selectSrc({ legacySrc, sources, sourceKey, qualityMode }) {
      const key = String(sourceKey || 'audio');
      const q = normQ(qualityMode);

      const srcLegacy = safeStr(legacySrc);
      const srcHi = safeStr(sources?.[key]?.hi);
      const srcLo = safeStr(sources?.[key]?.lo);

      return (q === 'lo') ? (srcLo || srcHi || srcLegacy) : (srcHi || srcLo || srcLegacy);
    }

    canToggleQualityForCurrentTrack() {
      const track = this.getCurrentTrack();
      if (!track) return false;
      const key = this.sourceKey || 'audio';
      return !!safeStr(track?.sources?.[key]?.lo);
    }

    switchQuality(mode) {
      const nextMode = this.setQualityMode(mode);

      const track = this.getCurrentTrack();
      if (!track) return { ok: true, mode: nextMode, changed: false };

      // UI –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π PQ, –Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å lo
      if (!this.canToggleQualityForCurrentTrack()) {
        return { ok: true, mode: nextMode, changed: false, disabled: true };
      }

      const desiredSrc = this._selectSrc({
        legacySrc: track.src,
        sources: track.sources,
        sourceKey: this.sourceKey,
        qualityMode: nextMode,
      });

      if (!desiredSrc || desiredSrc === track.src) return { ok: true, mode: nextMode, changed: false };

      const wasPlaying = this.isPlaying();
      const pos = this.getPosition();
      const idx = this.currentIndex;

      // –í–ê–ñ–ù–û: –æ–±–Ω–æ–≤–ª—è–µ–º src —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ uid –≤ playlist/originalPlaylist,
      // –Ω–æ –Ω–µ —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ "–ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–æ–π –ø–ª–µ–π–ª–∏—Å—Ç–∞".
      const uid = safeStr(track.uid);
      if (uid) {
        const pi = this.playlist.findIndex(t => safeStr(t?.uid) === uid);
        if (pi >= 0) this.playlist[pi].src = desiredSrc;

        const oi = this.originalPlaylist.findIndex(t => safeStr(t?.uid) === uid);
        if (oi >= 0) this.originalPlaylist[oi].src = desiredSrc;
      } else if (this.playlist[idx]) {
        this.playlist[idx].src = desiredSrc;
      }

      // –¢–ò–•–ê–Ø –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞: –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º stop(), –Ω–µ —ç–º–∏—Ç–∏–º onStop.
      this._silentUnloadCurrentSound();

      // –ü–æ—Å–ª–µ load: seek(pos), –∏ –µ—Å–ª–∏ wasPlaying=true ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, –∏–Ω–∞—á–µ –æ—Å—Ç–∞—ë–º—Å—è paused.
      this.load(idx, { autoPlay: wasPlaying, resumePosition: pos });

      return { ok: true, mode: nextMode, changed: true };
    }

    setQuality(quality) {
      const q = String(quality || '').toLowerCase();
      if (q === 'low' || q === 'lo') this.switchQuality('lo');
      else if (q === 'high' || q === 'hi') this.switchQuality('hi');
    }
    // =========================
    // Favorites API (PlayerCore)
    // =========================
    onFavoritesChanged(cb) {
      if (typeof cb !== 'function') return () => {};
      this._favEmitter?.subs?.add(cb);
      return () => { try { this._favEmitter?.subs?.delete(cb); } catch {} };
    }
    _favReadLikedMap() {
      try {
        const raw = localStorage.getItem(this._fav.likedKey);
        const j = raw ? JSON.parse(raw) : {};
        return (j && typeof j === 'object') ? j : {};
      } catch {
        return {};
      }
    }

    _favWriteLikedMap(map) {
      try {
        localStorage.setItem(this._fav.likedKey, JSON.stringify(map && typeof map === 'object' ? map : {}));
        return true;
      } catch {
        return false;
      }
    }

    _favEnsureRefsIndex() {
      if (this._favRefsIndex?.built) return;

      const refs = this._favReadRefs();
      const m = new Map();

      for (const r of refs) {
        const a = safeStr(r?.a);
        const u = safeStr(r?.uid);
        if (!a || !u) continue;
        if (!m.has(u)) m.set(u, new Set());
        m.get(u).add(a);
      }

      this._favRefsIndex = { built: true, map: m };
    }

    _favInvalidateRefsIndex() {
      if (!this._favRefsIndex) this._favRefsIndex = { built: false, map: new Map() };
      this._favRefsIndex.built = false;
      this._favRefsIndex.map = new Map();
    }

    _favReadRefs() {
      try {
        const raw = localStorage.getItem(this._fav.refsKey);
        const j = raw ? JSON.parse(raw) : [];
        return Array.isArray(j) ? j : [];
      } catch {
        return [];
      }
    }

    _favWriteRefs(arr) {
      try {
        localStorage.setItem(this._fav.refsKey, JSON.stringify(Array.isArray(arr) ? arr : []));
        this._favInvalidateRefsIndex();
        return true;
      } catch {
        return false;
      }
    }

    _favAddRefIfMissing(albumKey, uid) {
      const a = safeStr(albumKey);
      const u = safeStr(uid);
      if (!a || !u) return false;

      const refs = this._favReadRefs();
      const exists = refs.some(r => r && String(r.a || '').trim() === a && String(r.uid || '').trim() === u);
      if (exists) return false;

      refs.push({ a, uid: u });
      this._favWriteRefs(refs);
      return true;
    }

    _favRemoveRef(albumKey, uid) {
      const a = safeStr(albumKey);
      const u = safeStr(uid);
      if (!a || !u) return false;

      const refs = this._favReadRefs();
      const next = refs.filter(r => !(r && String(r.a || '').trim() === a && String(r.uid || '').trim() === u));
      if (next.length === refs.length) return false;

      this._favWriteRefs(next);
      return true;
    }

    getLikedUidsForAlbum(albumKey) {
      const a = safeStr(albumKey);
      if (!a) return [];
      const map = this._favReadLikedMap();
      const arr = Array.isArray(map[a]) ? map[a] : [];
      return Array.from(new Set(arr.map(x => String(x || '').trim()).filter(Boolean)));
    }

    isFavorite(uid) {
      const u = safeStr(uid);
      if (!u) return false;

      const map = this._favReadLikedMap();
      for (const k of Object.keys(map)) {
        const arr = Array.isArray(map[k]) ? map[k] : [];
        if (arr.includes(u)) return true;
      }
      return false;
    }

    /**
     * toggleFavorite(uid, opts?)
     * opts:
     * - fromAlbum: boolean (true = –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ —Ä–æ–¥–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞/–º–∏–Ω–∏; false = –∏–∑ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ)
     * - albumKey: string | null  (–Ø–í–ù–û–ï —É–∫–∞–∑–∞–Ω–∏–µ —Ä–æ–¥–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞ –¥–ª—è uid; –≥–ª–∞–≤–Ω—ã–π —Ñ–∏–∫—Å)
     *
     * –ü—Ä–∞–≤–∏–ª–∞:
     * - fromAlbum=true: unlike => ref —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é (–±–µ–∑ —Å–ª–µ–¥–∞)
     * - fromAlbum=false: unlike => ref –æ—Å—Ç–∞—ë—Ç—Å—è (inactive), —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É
     */
    toggleFavorite(uid, opts = true) {
      const u = safeStr(uid);
      if (!u) return { ok: false, reason: 'noUid' };

      const fromAlbum = (typeof opts === 'boolean') ? opts : !!opts?.fromAlbum;
      const explicitAlbumKey = (typeof opts === 'object' && opts) ? safeStr(opts.albumKey) : null;

      const map = this._favReadLikedMap();

      const findAlbumContainingUid = () => {
        for (const a of Object.keys(map)) {
          const arr = Array.isArray(map[a]) ? map[a] : [];
          if (arr.includes(u)) return a;
        }
        return null;
      };

      // ‚úÖ –ï—Å–ª–∏ UI –ø–µ—Ä–µ–¥–∞–ª albumKey ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.
      // –ò–Ω–∞—á–µ: –¥–ª—è fromAlbum=true –æ–±—è–∑–∞–Ω—ã –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å albumKey, —á—Ç–æ–±—ã refs —Ä–∞–±–æ—Ç–∞–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ.
      const guessAlbumKeyFromContext = () => {
        try {
          const a1 = W.AlbumsManager?.getCurrentAlbum?.();
          if (a1 && !String(a1).startsWith('__')) return safeStr(a1);
        } catch {}

        try {
          const cur = this.getCurrentTrack?.();
          const a2 = safeStr(cur?.sourceAlbum);
          if (a2 && !String(a2).startsWith('__')) return a2;
        } catch {}

        try {
          const a3 = W.AlbumsManager?.getPlayingAlbum?.();
          if (a3 && !String(a3).startsWith('__')) return safeStr(a3);
        } catch {}

        return null;
      };

      const albumKey =
        explicitAlbumKey ||
        findAlbumContainingUid() ||
        (fromAlbum ? guessAlbumKeyFromContext() : null) ||
        null;

      const prevLiked = (albumKey && !String(albumKey).startsWith('__'))
        ? this.getLikedUidsForAlbum(albumKey).includes(u)
        : this.isFavorite(u);

      const nextLiked = !prevLiked;

      // liked map update (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å albumKey –∏ –æ–Ω –Ω–µ special)
      if (albumKey && !String(albumKey).startsWith('__')) {
        const prevArr = Array.isArray(map[albumKey]) ? map[albumKey] : [];
        const arr = Array.from(new Set(prevArr.map(x => String(x || '').trim()).filter(Boolean)));

        let nextArr = arr.slice();
        if (nextLiked && !nextArr.includes(u)) nextArr.push(u);
        if (!nextLiked && nextArr.includes(u)) nextArr = nextArr.filter(x => x !== u);

        if (nextArr.length === 0) delete map[albumKey];
        else map[albumKey] = nextArr;

        this._favWriteLikedMap(map);
      }

      // refs rules
      if (nextLiked) {
        if (albumKey) this._favAddRefIfMissing(albumKey, u);
      } else {
        if (fromAlbum) {
          // "–±–µ–∑ —Å–ª–µ–¥–∞": —É–¥–∞–ª–∏—Ç—å ref –ø–æ–ª–Ω–æ—Å—Ç—å—é
          if (albumKey) this._favRemoveRef(albumKey, u);
        } else {
          // favorites view: ref –æ—Å—Ç–∞—ë—Ç—Å—è (inactive)
        }
      }

      // notify subscribers (–±–µ–∑ DOM events)
      try {
        this._favEmitter.emit({ albumKey: albumKey || '', uid: u, liked: nextLiked, fromAlbum: !!fromAlbum });
      } catch {}

      // —Å–ø–µ—Ü-–ø—Ä–∞–≤–∏–ª–æ STOP/next —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ –ª–∞–π–∫–∞ –≤ favorites view
      if (!nextLiked && !fromAlbum) {
        this._handleFavoritesPlaylistUnlikeCurrent(u);
      }

      return { ok: true, uid: u, albumKey, liked: nextLiked };
    }

    getFavoritesState() {
      const refs = this._favReadRefs();

      // –ø–æ—Ä—è–¥–æ–∫ –∞–ª—å–±–æ–º–æ–≤ –∫–∞–∫ –≤ –∏–∫–æ–Ω–∫–∞—Ö
      const order = Array.isArray(W.ICON_ALBUMS_ORDER) ? W.ICON_ALBUMS_ORDER.map(x => String(x?.key || '')).filter(Boolean) : [];
      const orderMap = new Map(order.map((k, i) => [k, i]));

      const sorted = refs.slice().filter(r => r && safeStr(r.uid) && safeStr(r.a))
        .sort((r1, r2) => {
          const a1 = String(r1.a || '').trim();
          const a2 = String(r2.a || '').trim();
          const o1 = orderMap.has(a1) ? orderMap.get(a1) : 999;
          const o2 = orderMap.has(a2) ? orderMap.get(a2) : 999;
          if (o1 !== o2) return o1 - o2;
          return String(r1.uid || '').localeCompare(String(r2.uid || ''));
        });

      const map = this._favReadLikedMap();

      const isActive = (a, uid) => {
        const arr = Array.isArray(map[a]) ? map[a] : [];
        return arr.includes(uid);
      };

      const active = [];
      const inactive = [];

      for (const r of sorted) {
        const a = String(r.a || '').trim();
        const u = String(r.uid || '').trim();
        if (!a || !u) continue;

        // Track –æ–±—ä–µ–∫—Ç (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π), UI –¥–æ—Å—Ç—Ä–æ–∏—Ç –ø–æ–ª—è —á–µ—Ä–µ–∑ fetch config.json –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
        const t = { uid: u, sourceAlbum: a };

        if (isActive(a, u)) active.push(t);
        else inactive.push(t);
      }

      return { active, inactive };
    }

    removeInactivePermanently(uid) {
      const u = safeStr(uid);
      if (!u) return { ok: false, reason: 'noUid' };

      this._favEnsureRefsIndex();

      const set = this._favRefsIndex.map.get(u);
      if (!set || set.size === 0) {
        // –Ω–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å
        try { this._favEmitter.emit({ uid: u, liked: false, removed: true }); } catch {}
        return { ok: true, removed: 0 };
      }

      const refs = this._favReadRefs();

      // —Ç–æ—á–µ—á–Ω–æ —É–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–∞—Ä—ã (a, uid) –¥–ª—è —ç—Ç–æ–≥–æ uid
      const next = refs.filter(r => {
        const ru = String(r?.uid || '').trim();
        if (ru !== u) return true;
        const ra = String(r?.a || '').trim();
        return !set.has(ra);
      });

      const removed = refs.length - next.length;
      this._favWriteRefs(next);

      try {
        this._favEmitter.emit({ uid: u, liked: false, removed: true });
      } catch {}

      return { ok: true, removed };
    }

    restoreInactive(uid) {
      // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ = –ø—Ä–æ—Å—Ç–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å ‚≠ê (–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å)
      // albumKey –±–µ—Ä—ë–º –∫–∞–∫: –µ—Å–ª–∏ —Ç—Ä–µ–∫ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è –≤ __favorites__, –∏—Å–ø–æ–ª—å–∑—É–µ–º sourceAlbum, –∏–Ω–∞—á–µ –∏—â–µ–º ref
      const u = safeStr(uid);
      if (!u) return { ok: false, reason: 'noUid' };

      const refs = this._favReadRefs();
      const ref = refs.find(r => String(r?.uid || '').trim() === u) || null;
      const a = safeStr(ref?.a);

      if (a && !String(a).startsWith('__')) {
        const map = this._favReadLikedMap();
        const arr = Array.isArray(map[a]) ? map[a] : [];
        if (!arr.includes(u)) {
          map[a] = Array.from(new Set(arr.concat([u])));
          this._favWriteLikedMap(map);
        }
      }

      // ref –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π
      if (a) this._favAddRefIfMissing(a, u);

      try {
        this._favEmitter.emit({ albumKey: a || '', uid: u, liked: true });
      } catch {}

      return { ok: true };
    }

    showInactiveFavoriteModal(params = {}) {
      const u = safeStr(params?.uid);
      const title = String(params?.title || '–¢—Ä–µ–∫');
      if (!u) return;

      const esc = W.Utils?.escapeHtml ? (s) => W.Utils.escapeHtml(String(s || '')) : (s) => String(s || '');

      if (!W.Modals?.open) return;

      const modal = W.Modals.open({
        title: '–¢—Ä–µ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω',
        maxWidth: 420,
        bodyHtml: `
          <div style="color:#9db7dd; line-height:1.45; margin-bottom:14px;">
            <div style="margin-bottom:8px;"><strong>–¢—Ä–µ–∫:</strong> ${esc(title)}</div>
            <div style="opacity:.9;">–í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å —Ç—Ä–µ–∫ –≤ ‚≠ê –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª.</div>
          </div>
          ${W.Modals?.actionRow ? W.Modals.actionRow([
            { act: 'add', text: '–î–æ–±–∞–≤–∏—Ç—å –≤ ‚≠ê', className: 'online', style: 'min-width:160px;' },
            { act: 'remove', text: '–£–¥–∞–ª–∏—Ç—å', className: '', style: 'min-width:160px;' }
          ]) : ''}
        `
      });

      modal.querySelector('[data-act="add"]')?.addEventListener('click', () => {
        try { modal.remove(); } catch {}
        this.restoreInactive(u);
      });

      modal.querySelector('[data-act="remove"]')?.addEventListener('click', () => {
        try { modal.remove(); } catch {}
        if (W.Modals?.confirm) {
          W.Modals.confirm({
            title: '–£–¥–∞–ª–∏—Ç—å –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª?',
            textHtml: `
              <div style="margin-bottom:8px;"><strong>–¢—Ä–µ–∫:</strong> ${esc(title)}</div>
              <div style="opacity:.9;">–¢—Ä–µ–∫ –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê —É–∂–µ —Å–Ω—è—Ç–∞.</div>
            `,
            confirmText: '–£–¥–∞–ª–∏—Ç—å',
            cancelText: '–û—Ç–º–µ–Ω–∞',
            onConfirm: () => {
              this.removeInactivePermanently(u);
              try { params?.onDeleted?.(); } catch {}
            }
          });
        } else {
          // fallback: –±–µ–∑ confirm helper –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º
          this.removeInactivePermanently(u);
          try { params?.onDeleted?.(); } catch {}
        }
      });
    }

    _handleFavoritesPlaylistUnlikeCurrent(unlikedUid) {
      try {
        const playingAlbum = W.AlbumsManager?.getPlayingAlbum?.();
        if (playingAlbum !== W.SPECIAL_FAVORITES_KEY) return;

        const cur = this.getCurrentTrack();
        const curUid = safeStr(cur?.uid);
        if (!curUid || curUid !== safeStr(unlikedUid)) return;

        // –°—Ç—Ä–æ–∏–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–µ—Ä–µ–∑ refs+map (–±–µ–∑ favoritesRefsModel)
        const state = this.getFavoritesState();
        const active = Array.isArray(state?.active) ? state.active : [];

        if (active.length === 0) {
          // –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π STOP –æ—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
          this.stop?.();
          return;
        }

        // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π: —á–µ—Ä–µ–∑ AlbumsManager.ensureFavoritesPlayback (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞)
        // –ó–¥–µ—Å—å –º—ã –Ω–µ –∑–Ω–∞–µ–º –∏–Ω–¥–µ–∫—Å –≤ UI-–º–æ–¥–µ–ª–∏, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å–∏–º UI –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å –∏ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π.
        try { W.FavoritesUI?.playFirstActiveFavorite?.(); } catch {}
      } catch (e) {
        console.warn('_handleFavoritesPlaylistUnlikeCurrent failed:', e);
      }
    }

    // =========================
    // State getters
    // =========================
    getCurrentTrack() {
      return (this.currentIndex < 0 || this.currentIndex >= this.playlist.length) ? null : (this.playlist[this.currentIndex] || null);
    }

    getIndex() { return this.currentIndex; }

    getNextIndex() {
      const len = this.playlist.length;
      if (!len || this.currentIndex < 0) return -1;
      return (this.currentIndex + 1) % len;
    }

    isPlaying() { return !!(this.sound?.playing && this.sound.playing()); }

    // =========================
    // Events
    // =========================
    on(events) {
      for (const k of Object.keys(events || {})) {
        if (this.callbacks[k]) this.callbacks[k].push(events[k]);
      }
    }

    trigger(event, ...args) {
      const arr = this.callbacks[event];
      if (!arr) return;
      for (const fn of arr) { try { fn(...args); } catch {} }
    }

    // =========================
    // Tick
    // =========================
    startTick() {
      this.stopTick();
      this.tickInterval = setInterval(() => {
        this.trigger('onTick', this.getPosition(), this.getDuration());
        this._stats.onTick();
      }, this.tickRate);
    }

    stopTick() {
      if (!this.tickInterval) return;
      clearInterval(this.tickInterval);
      this.tickInterval = null;
    }

    // =========================
    // Sleep timer
    // =========================
    setSleepTimer(ms) {
      const delay = Number(ms) || 0;
      if (delay <= 0) return void this.clearSleepTimer();

      this.sleepTimerTarget = Date.now() + delay;
      if (this.sleepTimerId) clearTimeout(this.sleepTimerId);

      this.sleepTimerId = setTimeout(() => {
        this.sleepTimerId = null;
        const target = this.sleepTimerTarget;
        this.sleepTimerTarget = 0;
        this.trigger('onSleepTriggered', { targetAt: target });
        if (this.isPlaying()) { try { this.pause(); } catch {} }
      }, delay);
    }

    clearSleepTimer() {
      if (this.sleepTimerId) clearTimeout(this.sleepTimerId);
      this.sleepTimerId = null;
      this.sleepTimerTarget = 0;
    }

    getSleepTimerTarget() { return this.sleepTimerTarget || 0; }

    // =========================
    // MediaSession
    // =========================
    _updateMedia(track) {
      if (!this._mediaSession) return;
      this._mediaSession.updateMetadata({
        title: track?.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
        artist: track?.artist || this.metadata.artist,
        album: track?.album || this.metadata.album,
        artworkUrl: track?.cover || this.metadata.cover || 'icons/icon-512.png',
        playing: this.isPlaying(),
      });
      this._mediaSession.updatePositionState();
    }

    // =========================
    // Shuffle history
    // =========================
    _pushHistoryForCurrent() {
      try {
        const uid = safeStr(this.getCurrentTrack()?.uid);
        if (!uid) return;

        const last = this.shuffleHistory.length ? this.shuffleHistory[this.shuffleHistory.length - 1] : null;
        if (last?.uid === uid) return;

        this.shuffleHistory.push({ uid });
        if (this.shuffleHistory.length > this.historyMax) this.shuffleHistory.splice(0, this.shuffleHistory.length - this.historyMax);
      } catch {}
    }

    _popHistoryPrevIndex() {
      try {
        if (!this.shuffleMode || !this.shuffleHistory?.length) return -1;
        this.shuffleHistory.pop();
        const uid = safeStr(this.shuffleHistory.length ? this.shuffleHistory[this.shuffleHistory.length - 1]?.uid : null);
        if (!uid) return -1;
        const idx = this.playlist.findIndex(t => safeStr(t?.uid) === uid);
        return idx >= 0 ? idx : -1;
      } catch {
        return -1;
      }
    }

    // =========================
    // Helpers for PlaybackPolicy
    // =========================
    appendToPlaylistTail(tracks) {
      const list = Array.isArray(tracks) ? tracks : [];
      if (!list.length) return;

      const existingUid = new Set(this.playlist.map(t => safeStr(t?.uid)).filter(Boolean));
      const toAdd = [];

      for (const t of list) {
        const uid = safeStr(t?.uid);
        if (!uid || existingUid.has(uid)) continue;
        existingUid.add(uid);

        toAdd.push({
          src: safeStr(t?.src),
          sources: t?.sources || null,
          title: t?.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
          artist: t?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          album: t?.album || '',
          cover: t?.cover || '',
          lyrics: t?.lyrics || null,
          fulltext: t?.fulltext || null,
          uid,
          sourceAlbum: t?.sourceAlbum || null,
        });
      }

      if (toAdd.length) this.playlist = this.playlist.concat(toAdd);
    }

    removeFromPlaylistTailIfNotPlayed(params = {}) {
      const uid = safeStr(params?.uid);
      if (!uid) return false;

      const curUid = safeStr(this.getCurrentTrack()?.uid);
      if (curUid === uid) return false;

      const played = Array.isArray(this.shuffleHistory) ? this.shuffleHistory.some(h => safeStr(h?.uid) === uid) : false;
      if (played) return false;

      const beforeLen = this.playlist.length;
      this.playlist = this.playlist.filter(t => safeStr(t?.uid) !== uid);
      if (this.currentIndex >= this.playlist.length) this.currentIndex = this.playlist.length - 1;
      return this.playlist.length !== beforeLen;
    }

    // =========================
    // Backend rebuild (pulse)
    // =========================
    rebuildCurrentSound(options = {}) {
      try {
        const track = this.getCurrentTrack();
        if (!track) return false;

        const targetHtml5 = !options.preferWebAudio;
        const wasPlaying = this.isPlaying();
        const pos = this.getPosition();
        const idx = this.currentIndex;

        const curHtml5 = !!(this.sound && this.sound._html5);
        if (this.sound && curHtml5 === targetHtml5) return true;

        this._silentUnloadCurrentSound();
        this.load(idx, { autoPlay: wasPlaying, resumePosition: pos, html5: targetHtml5 });
        return true;
      } catch {
        return false;
      }
    }

    getAudioElement() {
      try { return this.sound?._sounds?.[0]?._node || null; } catch { return null; }
    }

    destroy() {
      this.stop();
      this.playlist = [];
      this.originalPlaylist = [];
      this.currentIndex = -1;
      for (const off of this._ios.unsubs) { try { off(); } catch {} }
      this._ios.unsubs.length = 0;
      this.callbacks = {
        onTrackChange: [],
        onPlay: [],
        onPause: [],
        onStop: [],
        onEnd: [],
        onTick: [],
        onError: [],
        onSleepTriggered: [],
      };
    }
  }

  W.playerCore = new PlayerCore();

  // init without duplicate Howler-wait (bootstrap already waits)
  const init = () => { try { W.playerCore.initialize(); } catch {} };

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();

//=================================================
// FILE: /styles/main.css
:root{--primary-bg:#181818;--primary-color:#e80100;--secondary-color:#4daaff;--text-color:#f2f2f2;--modal-bg:#252d39;--border-color:#394866;--btn-size:44px;--btn-radius:8px;--bg-0:#0f1218;--c-blue:#8ab8fd;--c-w:#fff;--c-e:#eee;--shadow-1:0 4px 24px rgba(0,0,0,.3);--shadow-2:0 8px 32px rgba(0,0,0,.4);--grad-blue:linear-gradient(90deg,#4daaff,#357ac9);--om-bd:rgba(255,255,255,.10);--om-sub:#9db7dd}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:rgba(0,0,0,0)}
html,body{height:100%;background:var(--primary-bg);color:var(--text-color);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;display:flex;flex-direction:column}
body{min-height:100vh;min-width:100vw;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;padding-top:env(safe-area-inset-top);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.hidden{display:none!important}

/* Promocode */
#promocode-block{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--primary-bg);z-index:100}
.promo-inner{display:flex;flex-direction:column;align-items:center;background:rgba(15,18,24,.98);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.5);padding:36px 26px 32px;min-width:280px;max-width:90vw}
.promo-cover{width:256px;height:256px;max-width:70vw;max-height:70vw;object-fit:cover;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,.7);margin-bottom:19px;display:block;background:var(--primary-bg)}
.promo-inner h2{margin-bottom:16px;color:var(--secondary-color);font-size:20px}
#promo-inp{padding:12px 16px;border-radius:8px;border:1px solid var(--border-color);background:rgba(255,255,255,.1);color:var(--text-color);margin:10px 0;width:100%;max-width:280px;font-size:16px;outline:0;transition:border-color .3s}
#promo-inp:focus{border-color:var(--secondary-color)}
#promo-inp.error{border-color:var(--primary-color);animation:shake .3s}
@keyframes shake{0%,to{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
#promo-btn{padding:12px 32px;background:var(--primary-color);color:var(--c-w);border:0;border-radius:8px;cursor:pointer;font-weight:800;font-size:16px;transition:opacity .2s,transform .1s;margin-top:8px}
#promo-btn:hover:not(:disabled){opacity:.9;transform:translateY(-1px)}
#promo-btn:active{transform:translateY(0)}
#promo-btn:disabled{opacity:.5;cursor:not-allowed}
#promo-error{color:#ff6b6b;margin-top:12px;font-size:14px;min-height:20px}

/* Layout */
#main-block{max-width:420px;margin:0 auto;flex:1 0 auto;display:flex;flex-direction:column;align-items:center;width:100%;padding:0 10px;padding-bottom:env(safe-area-inset-bottom)}
header{width:100%;text-align:center;margin:0 auto}

/* Album title */
.active-album-title{width:100%;max-width:400px;margin:18px auto 6px;text-align:center;color:#eaf2ff;font-weight:900;letter-spacing:.01em;line-height:1.15;text-shadow:0 1px 0 rgba(0,0,0,.35);font-size:clamp(18px,4.6vw,24px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.active-album-title.fav{color:#ffd166;letter-spacing:.06em}
.active-album-title.news{color:var(--c-blue);letter-spacing:.02em}

/* Album icons */
.album-icons{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;align-items:center;justify-items:center;margin:12px auto 0;max-width:400px;width:100%;padding:4px 8px;overflow:hidden}
.album-icons::-webkit-scrollbar{display:none}
.album-icon[data-album="__favorites__"]{grid-row:2;grid-column:2}
.album-icon[data-album="__reliz__"]{grid-row:2;grid-column:3}
.album-icon[data-album="odnazhdy-v-skazke"],.album-icon[data-album="golos-dushi"],.album-icon[data-album="mezhdu-zlom-i-dobrom"],.album-icon[data-album="krevetochka"]{grid-row:1}
.album-icon{width:clamp(62px,16vw,82px);height:clamp(62px,16vw,82px);border-radius:10px;overflow:hidden;border:1px solid var(--border-color);cursor:pointer;filter:grayscale(70%) brightness(.88);opacity:.72;transition:transform .15s,filter .15s,opacity .15s,box-shadow .15s,width .15s ease,height .15s ease;touch-action:manipulation;-webkit-touch-callout:none}
.album-icon img{width:100%;height:100%;object-fit:cover;display:block}
.album-icon.active{filter:none;opacity:1;box-shadow:0 2px 10px rgba(0,0,0,.35);width:clamp(68px,17vw,88px);height:clamp(68px,17vw,88px)}
.album-icon:hover{transform:translateY(-2px);opacity:.9}
.album-icon:active{transform:translateY(0) scale(.95)}

/* Common tap/click targets */
.track,.like-star,.player-control-btn,.sleep-timer-btn,.offline-btn,.lyrics-toggle-btn,.animation-btn,.pulse-btn,.karaoke-btn,.player-download-btn,button,a,input,select,textarea,[role="button"]{touch-action:manipulation;-webkit-touch-callout:none}

/* Cover / gallery */
#cover-wrap{width:100%;max-width:400px;margin:14px auto 0;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;position:relative}
.cover-gallery-arrow{position:absolute;top:50%;transform:translateY(-50%);z-index:2;border:0;cursor:pointer;background:0 0;padding:0;width:44px;height:44px;display:flex;align-items:center;justify-content:center;transition:opacity .2s;visibility:hidden;pointer-events:none}
.cover-gallery-arrow:hover{opacity:.8}
.cover-gallery-arrow:active{transform:translateY(-50%) scale(.9)}
#cover-gallery-arrow-left{left:7px}
#cover-gallery-arrow-right{right:7px}
#cover-wrap.gallery-nav-ready .cover-gallery-arrow{visibility:visible;pointer-events:auto}
#cover-slot{width:100%;height:100%;border-radius:12px;overflow:hidden;background:var(--primary-bg);box-shadow:var(--shadow-1);position:relative}
#cover-slot iframe,#cover-slot img{width:100%;height:100%;display:block;border:0;background:0 0}
#cover-slot img{object-fit:contain}

/* Socials */
.socials-under-cover{margin:14px auto 0;width:100%;max-width:398px;text-align:center;font-size:1.03em;display:flex;flex-wrap:wrap;justify-content:center;gap:12px}
.socials-under-cover a{color:var(--secondary-color);text-decoration:none;transition:color .2s;padding:4px 8px}
.socials-under-cover a:hover{color:var(--text-color);text-decoration:underline}

/* Player */
.lyrics-player-block{max-width:370px;width:100%;margin:20px auto 0;background:linear-gradient(180deg,rgba(30,34,45,.95),rgba(15,18,24,.98));border-radius:14px;overflow:hidden;box-shadow:var(--shadow-2);position:relative}

/* Lyrics window */
#lyrics-window{position:relative;overflow:hidden;border-radius:12px 12px 0 0;background:var(--bg-0);transition:height .2s ease,opacity .2s ease}
#lyrics-window.lyrics-normal{height:8.7em}
#lyrics-window.lyrics-expanded{height:15.6em}
#lyrics-window.lyrics-hidden{height:0!important;opacity:0!important;pointer-events:none!important;margin:0!important}
.lyrics-scroll{position:relative;z-index:1;display:flex;flex-direction:column;justify-content:center;height:100%;overflow:hidden;padding:0}
.lyrics-scroll::-webkit-scrollbar{display:none}
.lyrics-window-line{text-align:center;padding:6px 16px;color:var(--c-e);font-size:15px;opacity:.57;transition:color .25s,opacity .25s,font-size .25s,font-weight .25s,background .25s;user-select:none;line-height:1.35}
.lyrics-window-line.active{color:var(--primary-color);font-size:1.19em;font-weight:800;opacity:1;background:rgba(0,0,0,.07);text-shadow:0 1px 7px rgba(115,22,22,.27)}
.lyrics-placeholder{text-align:center;padding:40px 16px;color:#5a6989;font-size:14px;opacity:.6;user-select:none}
.lyrics-spinner{width:40px;height:40px;margin:40px auto;border:4px solid rgba(77,170,255,.2);border-top-color:var(--secondary-color);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Countdown */
.lyrics-countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:4em;font-weight:900;color:rgba(77,170,255,.35);z-index:0;pointer-events:none;user-select:none;text-shadow:0 2px 12px rgba(77,170,255,.2);animation:countdownPulse 1s ease-in-out infinite}
.lyrics-countdown.fade-out{animation:countdownFadeOut 1s ease-out forwards}
@keyframes countdownPulse{0%,to{transform:scale(1);opacity:.35}50%{transform:scale(1.05);opacity:.45}}
@keyframes countdownFadeOut{from{opacity:.35;transform:scale(1)}to{opacity:0;transform:scale(.9)}}

/* Animated bg */
.lyrics-animated-bg{position:absolute;inset:0;opacity:0;pointer-events:none;z-index:0;transition:opacity .5s;background:linear-gradient(45deg,rgba(232,1,0,.15),rgba(77,170,255,.15),rgba(232,1,0,.15));background-size:400% 400%;animation:none}
.lyrics-animated-bg.active{opacity:1;animation:lyricsGradient 10s ease infinite}
@keyframes lyricsGradient{0%{background-position:0 50%}50%{background-position:100% 50%}to{background-position:0 50%}}

/* Progress */
.player-progress-wrapper{padding:16px 20px 12px;background:rgba(15,18,24,.6)}
.player-progress-bar{position:relative;height:6px;background:rgba(255,255,255,.08);border-radius:3px;cursor:pointer;overflow:visible}
.player-progress-fill{position:relative;height:100%;background:var(--grad-blue);border-radius:3px;width:0%;transition:width .1s linear}
.player-progress-handle{position:absolute;right:-7px;top:50%;transform:translateY(-50%);width:14px;height:14px;background:var(--c-w);border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.4);opacity:0;transition:opacity .2s,transform .1s}
.player-progress-bar:hover .player-progress-handle{opacity:1}
.player-progress-handle:hover{transform:translateY(-50%) scale(1.2)}

/* Controls */
.player-controls{padding:14px 18px 16px;background:rgba(25,28,36,.8)}
.player-controls-row{display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:12px}
.player-controls-row:last-child{margin-bottom:0}
.time-in-controls{color:var(--c-blue);font-size:13px;min-width:42px;text-align:center;font-variant-numeric:tabular-nums;font-weight:500}
.player-control-btn,.sleep-timer-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:var(--c-blue);cursor:pointer;padding:10px;border-radius:50%;transition:.25s;display:flex;align-items:center;justify-content:center;width:var(--btn-size);height:var(--btn-size);outline:0}
.player-control-btn:hover,.sleep-timer-btn:hover{background:rgba(77,170,255,.15);border-color:rgba(77,170,255,.3);transform:scale(1.05)}
.player-control-btn:active,.sleep-timer-btn:active{transform:scale(.95)}
.player-control-btn.main{background:var(--primary-color);border-color:var(--primary-color);color:var(--c-w);width:52px;height:52px}
.player-control-btn.main:hover{background:#c60000}
.player-control-btn svg{width:20px;height:20px}
.player-control-btn.main svg{width:24px;height:24px}
.player-control-btn.active,.player-control-btn.repeat-active,.sleep-timer-btn.active{background:rgba(77,170,255,.2);border-color:var(--secondary-color);color:var(--secondary-color);box-shadow:0 0 12px rgba(77,170,255,.3)}

/* Favorites */
#favorites-btn{position:relative}
#favorites-btn-icon{width:18px;height:18px;transition:transform .2s}
#favorites-btn.favorites-active{background:rgba(77,170,255,.2);border-color:var(--secondary-color)}
#favorites-btn.favorites-active #favorites-btn-icon{transform:scale(1.2)}

/* PQ */
#pq-btn{position:relative}
#pq-btn .pq-btn-label{font-weight:900;font-size:14px;letter-spacing:.02em}
#pq-btn.pq-hi{background:rgba(39,179,76,.16);border-color:rgba(39,179,76,.35);color:#b8ffd0}
#pq-btn.pq-lo{background:rgba(255,152,0,.16);border-color:rgba(255,152,0,.35);color:#ffe0b2}
#pq-btn.disabled{background:rgba(30,30,30,.6)!important;border-color:rgba(255,255,255,.06)!important;color:rgba(255,255,255,.25)!important;box-shadow:none!important;cursor:not-allowed!important;opacity:.6}

/* Sleep menu */
.sleep-timer-btn{position:relative}
.sleep-timer-badge{position:absolute;top:-4px;right:-4px;background:var(--primary-color);color:var(--c-w);font-size:10px;font-weight:800;border-radius:10px;padding:2px 6px;min-width:18px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.4)}
.sleep-menu{position:absolute;bottom:100%;right:0;margin-bottom:8px;background:var(--modal-bg);border:1px solid var(--border-color);border-radius:10px;padding:8px;box-shadow:0 4px 20px rgba(0,0,0,.5);min-width:180px;z-index:100}
.sleep-menu-item{padding:10px 14px;cursor:pointer;border-radius:6px;transition:background .2s;color:var(--text-color);font-size:14px}
.sleep-menu-item:hover{background:rgba(77,170,255,.15)}
.sleep-menu-item.active{background:rgba(77,170,255,.2);color:var(--secondary-color)}

/* Sleep timer: time dialog (HH:MM) */
.sleep-time-modal-backdrop{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;padding:14px}
.sleep-time-modal{width:min(360px,100%);background:var(--modal-bg);border:1px solid var(--border-color);border-radius:14px;padding:14px;box-shadow:0 8px 40px rgba(0,0,0,.6)}
.sleep-time-title{color:var(--secondary-color);font-weight:900;margin:0 0 12px;text-align:center}
.sleep-time-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:12px}
.sleep-time-input{width:72px;text-align:center;padding:10px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text-color);outline:none}
.sleep-time-sep{opacity:.75}
.sleep-time-actions{display:flex;justify-content:flex-end;gap:8px}
.sleep-time-btn{padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text-color);cursor:pointer;font-weight:800}
.sleep-time-btn.primary{background:rgba(77,170,255,.25);border-color:rgba(77,170,255,.35);color:var(--secondary-color)}

/* Volume */
.volume-control-wrapper{position:relative;padding:16px 20px 12px;background:rgba(15,18,24,.5);border-top:1px solid rgba(255,255,255,.05)}
.volume-track{position:relative;height:6px;background:rgba(255,255,255,.08);border-radius:3px}
.volume-fill{position:absolute;inset:0 auto auto 0;height:6px;background:var(--grad-blue);width:0%;border-radius:3px;pointer-events:none;transition:width .08s linear}
.volume-handle{position:absolute;top:50%;left:0;transform:translate(-50%,-50%);width:14px;height:14px;background:var(--c-w);border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.35);pointer-events:none;z-index:3;transition:left .05s linear}
.volume-slider{position:absolute;left:20px;right:20px;top:50%;transform:translateY(-50%);height:28px;background:0 0;outline:0;-webkit-appearance:none;cursor:pointer;z-index:4;margin:0}
.volume-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:0 0;border-radius:50%;cursor:pointer;box-shadow:none}
.volume-slider::-moz-range-thumb{width:14px;height:14px;background:0 0;border-radius:50%;cursor:pointer;border:0;box-shadow:none}

/* Extra buttons */
.player-buttons-wrapper{background:rgba(15,18,24,.5);padding:12px 16px;border-top:1px solid rgba(255,255,255,.05);display:flex;gap:8px;flex-wrap:wrap}
.player-extra-buttons-row{display:flex;flex:1;gap:8px;justify-content:space-between;width:100%}
.lyrics-toggle-btn,.animation-btn,.pulse-btn,.karaoke-btn,.player-download-btn{width:var(--btn-size);min-width:var(--btn-size);max-width:var(--btn-size);height:var(--btn-size);min-height:var(--btn-size);max-height:var(--btn-size);padding:0;border-radius:var(--btn-radius);font-weight:800;font-size:18px;cursor:pointer;transition:transform .1s,background .2s,border-color .2s,box-shadow .2s,color .2s;text-align:center;text-decoration:none;display:flex;align-items:center;justify-content:center;flex-shrink:0;user-select:none}
.lyrics-toggle-btn,.karaoke-btn{background:rgba(77,170,255,.12);border:1px solid rgba(77,170,255,.25);color:var(--secondary-color)}
.lyrics-toggle-btn:hover,.karaoke-btn:hover{background:rgba(77,170,255,.2);transform:translateY(-1px)}
.lyrics-toggle-btn:active,.karaoke-btn:active{transform:translateY(0)}
.lyrics-toggle-btn-visual{display:inline-block;line-height:1;transition:font-size .2s,color .2s,transform .1s;pointer-events:none}
.lyrics-toggle-btn.lyrics-normal .lyrics-toggle-btn-visual{color:var(--secondary-color);font-size:28px}
.lyrics-toggle-btn.lyrics-expanded .lyrics-toggle-btn-visual{color:var(--secondary-color);font-size:18px}
.lyrics-toggle-btn.lyrics-hidden{background:rgba(232,1,0,.12);border-color:rgba(232,1,0,.25)}
.lyrics-toggle-btn.lyrics-hidden .lyrics-toggle-btn-visual{color:var(--primary-color);font-size:28px}
.lyrics-toggle-btn.lyrics-hidden:hover{background:rgba(232,1,0,.2);border-color:rgba(232,1,0,.35)}
.animation-btn{background:linear-gradient(135deg,#4a1a7a,#2a0a4a);border:1px solid rgba(138,43,226,.3);color:#c8a2ff}
.animation-btn.active{background:linear-gradient(135deg,#5a2a8a,#3a1a5a);box-shadow:0 0 12px rgba(138,43,226,.4)}
.animation-btn:hover{background:linear-gradient(135deg,#5a2a8a,#3a1a5a);transform:translateY(-1px)}
.pulse-btn{background:linear-gradient(135deg,#2a2a2a,#1a1a1a);border:1px solid rgba(255,255,255,.1);color:var(--c-w);font-size:20px}
.pulse-btn.active{background:linear-gradient(135deg,#4a1a1a,#2a0a0a);border-color:rgba(232,1,0,.3);color:var(--primary-color);box-shadow:0 0 12px rgba(232,1,0,.3)}
.pulse-btn:hover{background:linear-gradient(135deg,#3a3a3a,#2a2a2a);transform:translateY(-1px)}
.player-download-btn{background:linear-gradient(135deg,#1a4a7a,#0a2a4a);border:1px solid rgba(77,170,255,.3);color:var(--secondary-color)}
.player-download-btn:hover{background:linear-gradient(135deg,#2a5a8a,#1a3a5a);transform:translateY(-1px);box-shadow:0 4px 12px rgba(77,170,255,.2)}
.lyrics-toggle-btn.disabled,.animation-btn.disabled,.karaoke-btn.disabled{background:rgba(30,30,30,.6)!important;border-color:rgba(255,255,255,.06)!important;color:rgba(255,255,255,.2)!important;box-shadow:none!important;cursor:not-allowed!important;opacity:.5;pointer-events:none;filter:grayscale(100%)}
.lyrics-toggle-btn.disabled .lyrics-toggle-btn-visual{color:rgba(255,255,255,.2)!important}
@media (hover:hover){.lyrics-toggle-btn.disabled:hover,.animation-btn.disabled:hover,.karaoke-btn.disabled:hover{transform:none!important}}

/* Track list */
.track-list{margin:0 auto;max-width:370px;width:100%;font-size:1.05em;color:var(--c-e);background:0 0;padding:0}

/* Favorites empty */
.fav-empty{padding:20px;text-align:center;color:#8ab8fd}
.fav-empty h3{margin:0 0 10px}
.fav-empty p{margin:0;opacity:.9}

/* News inline (album __reliz__) */
.news-inline__head{padding:14px 10px;text-align:center;color:#8ab8fd}
.news-inline__links{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:12px}
.news-inline__links a{color:#4daaff;text-decoration:underline}
.news-inline__dot{opacity:.6}
.news-inline__status{opacity:.85}
.news-inline__status--error{color:#ff6b6b}
.news-inline__list{display:grid;gap:12px;padding:0 0 10px}

.news-inline__card{background:#131a26;border:1px solid #23324a;border-radius:12px;padding:12px;box-shadow:0 4px 16px rgba(0,0,0,.25)}
.news-inline__title{font-weight:900;font-size:16px;color:#eaf2ff}
.news-inline__date{color:#9db7dd;font-size:13px;margin-top:6px}
.news-inline__text{margin-top:8px;line-height:1.45;color:#eaf2ff}

.news-inline__media{margin:10px 0}
.news-inline__media iframe,.news-inline__media img,.news-inline__media video{width:100%;border:0;border-radius:10px;min-height:220px;background:#0b0e15}
.news-inline__media img{min-height:auto}
.news-inline__tags{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.news-inline__tag{font-size:12px;color:#4daaff;background:rgba(77,170,255,.12);border:1px solid rgba(77,170,255,.25);padding:4px 8px;border-radius:999px}
.track{display:flex;align-items:center;padding:9px 10px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:background .13s,transform .1s;background:0 0;-webkit-user-select:none;user-select:none}
.track:hover{background:rgba(255,255,255,.05)}
.track.current{background:#232b38;border-left:3px solid var(--secondary-color)}
.track:active{transform:scale(.98);background:rgba(255,255,255,.08)!important}
.track.inactive{opacity:.45;filter:grayscale(.6)}

/* FavoritesOnly: UI-only —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ ‚≠ê (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ playback) */
.track-list.favonly-filtered .track[data-hidden-by-favonly="1"]{display:none!important}
.track.is-favorite{background:rgba(77,170,255,.06)}
.tnum{min-width:30px;color:var(--c-blue);font-weight:500}
.track-title{margin-left:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.like-star{margin-left:auto;width:20px;height:20px;cursor:pointer;opacity:.97;transition:transform .2s,filter .13s,opacity .13s;pointer-events:auto!important;position:relative;z-index:10}
.like-star:hover{filter:brightness(1.13);opacity:1;transform:scale(1.15)}
.like-star:active{transform:scale(.9)}
.like-star.animating{animation:starPulse .3s}
@keyframes starPulse{0%,to{transform:scale(1)}50%{transform:scale(1.4)}}

/* Mini header / Next up */
.mini-now{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;background:#232b38;margin-bottom:8px;box-shadow:0 2px 8px rgba(0,0,0,.2);transition:none!important}
.mini-now .tnum{color:var(--c-blue);min-width:28px;font-weight:500}
.mini-now .track-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:15px}
.next-up{display:none;margin:8px 4px 0;font-size:.98em;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,.03);border-radius:8px;transition:none!important}
.next-up .label{color:var(--c-blue);opacity:.9;font-size:13px}
.next-up .title{color:var(--primary-color);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;flex:1;font-size:14px}

/* Logo bottom */
.logo-bottom{max-width:112px;width:23vw;min-width:66px;height:auto;display:block;margin:0 auto 15px!important;cursor:pointer;transition:transform .05s ease-out!important;will-change:transform;transform:translateZ(0);transform-origin:center}
.logo-bottom:hover{opacity:.9}

/* Bottom controls */
.bottom-controls-center{display:flex;flex-direction:column;align-items:center;justify-content:center;margin:32px auto 0;gap:10px;width:100%;max-width:300px;padding-bottom:env(safe-area-inset-bottom)}
#install-pwa-btn{color:var(--c-w);background:var(--secondary-color);border:0;border-radius:8px;font-size:1.07em;font-weight:900;letter-spacing:.02em;margin:8px 0;padding:12px 18px;cursor:pointer;width:100%;box-shadow:0 4px 14px rgba(0,0,0,.3);transition:background .2s,transform .1s,box-shadow .2s}
#install-pwa-btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.4);background:#3275c2}
#install-pwa-btn:active{transform:translateY(0)}
.feedback-link,.support-link,.hotkeys-btn{color:var(--secondary-color)!important;text-decoration:underline!important;font-weight:800;text-transform:uppercase;letter-spacing:.03em;cursor:pointer;transition:color .18s;font-size:1em;display:block;text-align:center;width:100%;margin:6px 0;background:0 0;border:0;padding:8px}
.feedback-link:hover,.support-link:hover,.hotkeys-btn:hover{color:var(--c-w)!important}
.offline-btn{min-width:110px;height:40px;font-size:1.05em;font-weight:900;border:0;border-radius:10px;cursor:pointer;letter-spacing:.07em;box-shadow:0 2px 8px rgba(6,0,0,.2);transition:background .2s,color .14s,transform .1s,box-shadow .2s;display:block;margin:10px auto 0}
.offline-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(6,0,0,.3)}
.offline-btn:active{transform:translateY(0)}
.offline-btn.online{background:var(--primary-color);color:var(--c-w)}
.offline-btn.offline{background:#27b34c;color:var(--c-w)}
.track .offline-indicator{margin-right:8px;font-size:18px}
.offline-indicator.pinned{color:#ffd166}
.offline-indicator.cloud{color:var(--c-blue);opacity:.8}
.offline-indicator.gray{color:#555}
#offline-btn.alert::after{content:"!";color:var(--primary-color);font-weight:900;margin-left:6px}

/* Toasts */
#toast-container{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:10000;pointer-events:none;display:flex;flex-direction:column;gap:10px;align-items:center}
.toast{background:#2a2a2a;border-radius:12px;padding:15px 20px;box-shadow:0 4px 20px rgba(0,0,0,.3);opacity:0;transform:translateY(20px);transition:.3s ease;max-width:90vw;word-wrap:break-word;pointer-events:auto}
.toast.show{opacity:1;transform:translateY(0)}
.toast-content{display:flex;align-items:center;gap:10px}
.toast-emoji{width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px}
.toast-message{flex:1;font-size:14px;line-height:1.4}
.toast-info{border-left:4px solid var(--secondary-color)}
.toast-success{border-left:4px solid #27b34c}
.toast-error{border-left:4px solid var(--primary-color)}
.toast-warning{border-left:4px solid #ff9800}
.toast-offline{border-left:4px solid #666}

/* Modals */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);z-index:9999;animation:fadeIn .3s}
.modal-bg.active{display:flex}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-feedback{background:var(--modal-bg);border-radius:14px;padding:28px 24px;min-width:240px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 8px 40px rgba(0,0,0,.6);position:relative;animation:slideUp .3s}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-feedback h2{margin:0 0 18px;color:var(--secondary-color);font-size:22px}
.bigclose{background:0 0;border:0;position:absolute;top:14px;right:14px;cursor:pointer;color:var(--c-e);border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;transition:transform .2s,background .2s}
.bigclose:hover{transform:scale(1.1);background:rgba(255,255,255,.1)}
.bigclose:active{transform:scale(.95)}
.bigclose svg{width:22px;height:22px}
.lyrics-modal .lyrics-fulltext::-webkit-scrollbar{width:8px}
.lyrics-modal .lyrics-fulltext::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:4px}
.lyrics-modal .lyrics-fulltext::-webkit-scrollbar-thumb{background:rgba(77,170,255,.3);border-radius:4px}
.modal-action-btn{background:rgba(77,170,255,.15);border:1px solid rgba(77,170,255,.3);color:var(--secondary-color);padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:900;font-size:14px;transition:.2s}
.modal-action-btn:hover{background:rgba(77,170,255,.25);transform:translateY(-1px);box-shadow:0 4px 12px rgba(77,170,255,.2)}
.modal-action-btn:active{transform:translateY(0)}

/* Offline modal helpers (no inline styles) */
.om-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.om-head__left{font-weight:900;color:var(--c-blue)}
.om-head__title{color:var(--c-blue)}
.om-head__value{color:var(--c-blue)}
.om-head__right{font-size:12px;color:var(--om-sub)}
.om-stack{display:flex;flex-direction:column;gap:12px}
.om-card{padding:12px;border:1px solid var(--om-bd);border-radius:12px}
.om-card__title{font-weight:900;color:var(--c-blue);margin-bottom:8px}
.om-row{display:flex;gap:10px;align-items:center;cursor:pointer}
.om-row--tight{margin:6px 0}
.om-check{accent-color:var(--secondary-color)}
.om-note,.om-text,.om-kv{font-size:12px;color:var(--om-sub);line-height:1.5;margin-top:6px}
.om-text{margin:0 0 20px}
.om-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.om-input,.om-select{border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text-color);outline:0}
.om-input{padding:10px 8px}
.om-select{padding:10px 12px}
.om-field{display:flex;gap:8px;align-items:center}
.om-field__lbl{opacity:.85}
.om-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:16px}
.om-actions--left{justify-content:flex-start;margin-top:8px}
.om-albums{margin-top:10px;max-height:140px;overflow:auto;border:1px solid var(--om-bd);border-radius:10px;padding:8px}
.om-btn-primary{background:var(--secondary-color)!important;color:var(--c-w)!important}
.om-btn-danger{background:var(--primary-color)!important;color:var(--c-w)!important}
.om-btn-success{background:#27b34c!important;color:var(--c-w)!important}

/* Sleep overlay */
.sleep-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:10000;animation:fadeIn .5s}
.sleep-overlay.active{display:flex}
.sleep-content{text-align:center;padding:40px;max-width:400px}
.sleep-icon{font-size:64px;margin-bottom:20px;opacity:.5}
.sleep-title{font-size:24px;margin-bottom:10px;color:var(--text-color)}
.sleep-message{color:rgba(255,255,255,.6);margin-bottom:30px}
.sleep-buttons{display:flex;gap:10px;justify-content:center}
.sleep-btn{padding:12px 24px;border-radius:8px;border:0;cursor:pointer;font-weight:900;transition:opacity .2s}
.sleep-btn-primary{background:var(--primary-color);color:var(--c-w)}
.sleep-btn-secondary{background:rgba(255,255,255,.1);color:var(--text-color)}
.sleep-btn:hover{opacity:.8}

/* Hotkeys modal */
.hotkeys-modal{max-width:600px;max-height:80vh;overflow-y:auto}
.hotkeys-section{margin-bottom:24px}
.hotkeys-section h3{color:var(--c-blue);font-size:16px;margin-bottom:12px}
.hotkey-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;margin-bottom:6px;background:rgba(255,255,255,.05);border-radius:6px}
.hotkey-combo{font-family:"SF Mono",Monaco,"Courier New",monospace;background:rgba(77,170,255,.15);padding:4px 10px;border-radius:4px;color:var(--secondary-color);font-weight:900;font-size:13px}
.hotkey-desc{color:#cfe3ff;font-size:14px;margin-left:16px;flex:1;text-align:right}

/* iOS install prompt */
.ios-install-prompt{position:fixed;bottom:0;left:0;right:0;background:#1a1a1a;border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;transform:translateY(100%);transition:transform .3s ease;z-index:10000;box-shadow:0 -4px 20px rgba(0,0,0,.3)}
.ios-install-prompt.show{transform:translateY(0)}
.ios-prompt-content{max-width:400px;margin:0 auto;text-align:center}
.ios-prompt-icon{width:60px;height:60px;margin:0 auto 15px;display:block}
.ios-prompt-close{position:absolute;top:10px;right:10px;background:0 0;border:0;color:#666;font-size:28px;cursor:pointer;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center}
.ios-prompt-button{background:var(--primary-color);color:var(--c-w);border:0;padding:12px 30px;border-radius:25px;font-weight:900;margin-top:20px;cursor:pointer;transition:opacity .2s}
.ios-prompt-button:hover{opacity:.9}

/* Jump-to-playing */
.jump-to-playing{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);width:44px;height:44px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.45);color:var(--c-w);display:none;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.jump-to-playing:active{transform:translateX(-50%) scale(.98)}
.jump-to-playing button{all:unset;width:100%;height:100%;cursor:pointer;display:grid;place-items:center;line-height:1;user-select:none}

/* Platform */
body.ios .volume-control-wrapper,body.ios #mute-btn{display:none!important}

/* Responsive */
@media (max-width:600px){
  .hotkeys-btn{display:none!important}
  .player-controls-row{gap:8px}
  .player-control-btn,.sleep-timer-btn{width:40px;height:40px;padding:8px}
  .player-control-btn.main{width:48px;height:48px}
  .player-control-btn svg{width:18px;height:18px}
  .player-control-btn.main svg{width:22px;height:22px}
  .time-in-controls{font-size:12px;min-width:38px}
  .player-extra-buttons-row{flex-wrap:wrap;gap:6px}
  .lyrics-toggle-btn,.animation-btn,.pulse-btn,.karaoke-btn,.player-download-btn{width:calc(33.333% - 4px);min-width:unset;max-width:unset}
  .lyrics-window-line{font-size:14px;padding:7px 12px}
  .lyrics-window-line.active{font-size:16px}
}
@media (max-width:380px){
  .promo-cover{width:200px;height:200px}
  .album-icon{width:54px;height:54px}
  .album-icon.active{width:60px;height:60px}
}
@media (display-mode:standalone){.bottom-controls-center{padding-bottom:calc(env(safe-area-inset-bottom) + 10px)}}
@media (prefers-color-scheme:dark){body{background:#0d0d0d}}

/* Accessibility */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}
button:focus-visible,a:focus-visible,input:focus-visible{outline:2px solid var(--secondary-color);outline-offset:2px}

/* Optional utility */
@keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:fadeInUp .4s ease-out}

