–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.
- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).
- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  ```ts
  export function x() {}
  ```
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.
- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.
- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.
- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].
- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. 
- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.
- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤—ã–∑–≤–∞—Ç—å STOP —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–Ω—è—Ç –≤ favorites view, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞ –∏ –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ä–æ–≥–æ —Å–ª–µ–¥–∞, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–µ–º —á—Ç–æ-—Ç–æ –≤ –∫–æ–¥–µ
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏–ª–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –∫–æ–¥–µ, –Ω–æ –ø—Ä–∏—ç—Ç–æ–º –ø–æ–ª–Ω–æ—Å—Ç—å–± –±—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ –ª–æ–≥–∏–∫—É, –ª–æ–≥–∏—Å—Ç–∏–∫—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–µ–º–∏—Ç—å—Å—è –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —É–ø—Ä–æ—â–µ–Ω–∏—é –∫–æ–¥–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: vi3na1bita-music
–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: https://github.com/apel-s-in/vi3na1bita-music
# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.
## –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞
–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ –≤ –ò–ó–ë–†–ê–ù–ù–û–ï:
–õ–∞–π–∫/–∞–Ω–ª–∞–π–∫ (‚≠ê) = –∏–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞.
–°–æ—Å—Ç–æ—è–Ω–∏–µ ‚≠ê —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö (—Ä–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º, ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª, –¥—Ä—É–≥–∏–µ —Å–ø–∏—Å–∫–∏).

–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–∑ –æ–∫–Ω–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª
–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äì —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.

–ü–æ–¥—Ä–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã):
- –ü–æ—Å—Ç–∞–≤–∏–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π.
- –°–Ω—è–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª (–¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º, ¬´–±–µ–∑ —Å–ª–µ–¥–∞¬ª).

‚≠ê –≤ –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:
- –°–Ω—è–ª–∏ ‚≠ê —Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–µ—Ä–æ–π (inactive), ‚≠ê —Å–Ω–∏–º–∞–µ—Ç—Å—è –∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª, –∏ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.
- –°–Ω—è—Ç–∏–µ ‚≠ê –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ, –∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –µ—ë –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (‚Äú–±—É—Ñ–µ—Ä‚Äù).

–ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π (—Å–µ—Ä–æ–π) —Å—Ç—Ä–æ–∫–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª:
- –ö–ª–∏–∫ –ø–æ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–µ –ø–æ –∑–≤–µ–∑–¥–µ) ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:
  - –í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, ‚≠ê —Å—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–µ–∑–¥–µ.
  - –£–¥–∞–ª–∏—Ç—å ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê –ø—Ä–∏ —ç—Ç–æ–º —Å–Ω—è—Ç–∞.
- –ö–ª–∏–∫ –ø–æ ‚≠ê –Ω–∞ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –º–æ–¥–∞–ª–∫–∏, —Å—Ç—Ä–æ–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å ‚≠ê.
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É (–∏–ª–∏ ‚Äú–±–µ–∑ —Å–ª–µ–¥–∞‚Äù —á–µ—Ä–µ–∑ –∞–Ω–ª–∞–π–∫ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ).

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
- –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚≠ê –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ –≤—Å–µ—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è—Ö –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫.
- –í –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª: —Å–Ω—è—Ç–∏–µ ‚≠ê –Ω–∞ –ª—é–±–æ–π —Å—Ç—Ä–æ–∫–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.
- –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É.

–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:
- –õ—é–±—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç—Ä–µ–∫–∞ –≤ inactive, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞.
- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–µ—Å–Ω–∏ –ù–ï –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç ‚Äú–≤ —Ñ–æ–Ω–µ‚Äù.

–û—Å–æ–±–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞:
- –ï—Å–ª–∏ —Ç—Ä–µ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è inactive –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫.
- –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî –ø–ª–µ–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º —Å—Ç–æ–ø, –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

–†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º –≤—Å–µ–≥–¥–∞ —Ä–µ—à–∞–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ:
- –ï—Å–ª–∏ —Å–Ω—è—Ç—å ‚≠ê —Å —Ç—Ä–µ–∫–∞ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚Äî –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–ª—Å—è —Ç–∞–º –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è (—Å–µ—Ä–∞—è) —Å—Ç—Ä–æ–∫–∞.

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ:
- –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ ‚≠ê –Ω–∞ —Ç—Ä–µ–∫–µ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π.

–ò—Ç–æ–≥–∏
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî —à–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–æ–π.
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚≠ê –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö.
- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π: –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–¥–Ω–æ–º—É –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.
- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.
- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.
 =========================================================================== 
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F (–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)
–ö–Ω–æ–ø–∫–∞ F –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º Favorites Only –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞).
–û–Ω–∞ –Ω–µ —Å—Ç–∞–≤–∏—Ç/–Ω–µ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê —É —Ç—Ä–µ–∫–æ–≤, –∞ —Ç–æ–ª—å–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç, –ø–æ –∫–∞–∫–∏–º —Ç—Ä–µ–∫–∞–º –º–æ–∂–Ω–æ —Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Next / Prev / –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏ –∫–∞–∫–∏–µ —Ç—Ä–µ–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ Shuffle.
–ï–¥–∏–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø (–ø–æ–ª–Ω—ã–π –ø–ª–µ–µ—Ä –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä)
–ü–æ–ª–Ω—ã–π –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ playing-–ø–ª–µ–π–ª–∏—Å—Ç–æ–º.
–ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö: –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ playing, –∞ –Ω–µ –∫ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å–ø–∏—Å–∫—É.
–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–¥–æ—Å—Ç—É–ø–Ω—ã–º —Ç—Ä–µ–∫–æ–º‚Äù
–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ ‚Äî —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤:
Next / Prev
–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —Ç—Ä–µ–∫–∞
Shuffle-–ø–æ—Ä—è–¥–∫–µ (–µ—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω)
–ü—Ä–∞–≤–∏–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:
F = OFF: –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±—ã—á–Ω—ã–π –Ω–∞–±–æ—Ä playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞, –Ω–æ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å–º. ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –Ω–∏–∂–µ).
F = ON: –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (‚≠ê) —Ç—Ä–µ–∫–∏ playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞.
–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –æ–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º
–ò–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ ‚≠ê –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ (–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ª–∞–π–∫–æ–≤).
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –≤ –∞–ª—å–±–æ–º–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ ‚≠ê —Ç—Ä–µ–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä —Å—É–∂–∞–µ—Ç—Å—è –¥–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è OFF, –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞–ª—å–±–æ–º–∞, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ ‚≠ê –Ω–µ—Ç: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = ‚≠ê, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ —ç—Ç–æ–º—É shuffle-–ø–æ—Ä—è–¥–∫—É.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = –≤—Å–µ —Ç—Ä–µ–∫–∏, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–∞–±–æ—Ä—É, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –ò–ó–ë–†–ê–ù–ù–û–ï (–ø–ª–µ–π–ª–∏—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ)
–í ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã active –∏ inactive:
active: —Ç—Ä–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º (‚≠ê –µ—Å—Ç—å) ‚Äî —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
inactive: ‚≠ê —Å–Ω—è—Ç–∞, —Å—Ç—Ä–æ–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
–ë–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–≤–∞–∂–Ω–æ): inactive –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –≤ Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∏ shuffle-–ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø—Ä–∏ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ F.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –Ω–µ—Ç active (–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –Ω–µ—á–µ–≥–æ –∏–≥—Ä–∞—Ç—å): –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = active (–ø–æ —Ñ–∞–∫—Ç—É –æ–Ω –∏ —Ç–∞–∫ —Ç–∞–∫–æ–π), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ active.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è = active (inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ active.
–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F
OFF ‚Üí ON
–ï—Å–ª–∏ –Ω–µ—Ç active: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.
–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
ON ‚Üí OFF
–ö–Ω–æ–ø–∫–∞ OFF, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active (–ø–æ—Ç–æ–º—É —á—Ç–æ inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.
–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
–ù–∞–∂–∞—Ç–∏–µ F –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–∞–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (‚≠ê –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –∏ –Ω–µ —Å–Ω–∏–º–∞–µ—Ç—Å—è).
–ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ (–Ω–µ—Ç ‚≠ê –≤ –∞–ª—å–±–æ–º–µ / –Ω–µ—Ç active –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ): –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∏ F –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è (–æ—Å—Ç–∞—ë—Ç—Å—è OFF).
inactive –≤ –ò–ó–ë–†–ê–ù–ù–û–ú ‚Äî —ç—Ç–æ UI-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è, –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∏ –≤ –∫–∞–∫–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –Ω–∏ –≤ Next/Prev, –Ω–∏ –≤ Shuffle.

–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).

–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:
vi3na1bita-music/
‚îú‚îÄ‚îÄ .git/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ applypatch-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fsmonitor-watchman.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-update.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-applypatch.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-merge-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-push.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-rebase.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-receive.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prepare-commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ push-to-checkout.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sendemail-validate.sample
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update.sample
‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exclude
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HEAD
‚îÇ   ‚îú‚îÄ‚îÄ objects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pack/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-ec16bd675fff13769b58d5f769566eaa03b0c4ab.idx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-ec16bd675fff13769b58d5f769566eaa03b0c4ab.pack
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ pack-ec16bd675fff13769b58d5f769566eaa03b0c4ab.rev
‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tags/
‚îÇ   ‚îú‚îÄ‚îÄ config
‚îÇ   ‚îú‚îÄ‚îÄ config.worktree
‚îÇ   ‚îú‚îÄ‚îÄ description
‚îÇ   ‚îú‚îÄ‚îÄ FETCH_HEAD
‚îÇ   ‚îú‚îÄ‚îÄ HEAD
‚îÇ   ‚îî‚îÄ‚îÄ index
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ e2e.yml
‚îÇ       ‚îú‚îÄ‚îÄ generate-context.yml
‚îÇ       ‚îî‚îÄ‚îÄ validate.yml
‚îú‚îÄ‚îÄ .meta/
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ albums/
‚îÇ   ‚îú‚îÄ‚îÄ gallery/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ news/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ thumbs/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ news-cover-02-thumb.jpg
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ news-cover-02-thumb.webp
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-01-baner.html
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.avif
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.png
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ news-cover-02.webp
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ icons/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ apple-touch-icon.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-16.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-32.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-192.png
‚îÇ   ‚îî‚îÄ‚îÄ icon-512.png
‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îú‚îÄ‚îÄ desktop/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@2x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@3x.png
‚îÇ   ‚îú‚îÄ‚îÄ icon_album/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.png
‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@2x.jpg
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ bg.png
‚îÇ   ‚îú‚îÄ‚îÄ logo.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-01.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-02.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-03.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-04.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-21.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-22.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-23.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-24.png
‚îÇ   ‚îú‚îÄ‚îÄ star.png
‚îÇ   ‚îî‚îÄ‚îÄ star2.png
‚îú‚îÄ‚îÄ news/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ news.json
‚îú‚îÄ‚îÄ performance/
‚îÇ   ‚îî‚îÄ‚îÄ rum.js
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player-ui/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lyrics.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ albums.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background-audio.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background-events.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ navigation.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ network-manager.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-ui-bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-cache-bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-policy.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player-ui.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track-registry.js
‚îÇ   ‚îú‚îÄ‚îÄ ci/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lint-sw.mjs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate-content.mjs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validate-manifest.mjs
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.spec.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player.spec.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ offline/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache-db.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ net-policy.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-manager.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ playback-cache.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track-resolver.js
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache-progress-overlay.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cloud-menu.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-const.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-data.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites-view.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lyrics-modal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modal-templates.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notify.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-indicators.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offline-modal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sleep.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ statistics-modal.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sysinfo.js
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sw-manager.js
‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ player-core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ media-session.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stats-tracker.js
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ PlayerCore.js
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îú‚îÄ‚îÄ main.css
‚îÇ   ‚îî‚îÄ‚îÄ modals.css
‚îú‚îÄ‚îÄ albums.json
‚îú‚îÄ‚îÄ custom.json
‚îú‚îÄ‚îÄ generate-context.js
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ news.html
‚îî‚îÄ‚îÄ service-worker.js


–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: 2026-01-06 13:47:44 UTC
//=================================================
// FILE: /.github/workflows/e2e.yml
name: E2E smoke

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npx -y playwright@1.48.2 install --with-deps

      - name: Start static server
        run: |
          npx -y http-server -p 4173 -c-1 . &
          echo $! > server.pid
          sleep 2

      - name: Run smoke tests
        env:
          BASE_URL: http://127.0.0.1:4173
        run: npx -y @playwright/test@1.48.2 scripts/e2e

      - name: Stop server
        if: always()
        run: kill $(cat server.pid) || true

//=================================================
// FILE: /.github/workflows/generate-context.yml
name: Generate .meta context

on:
  push:
    branches: [ main, master ]
    # –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤–æ—Ä–∫—Ñ–ª–æ—É –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤, –º–µ–Ω—è—é—â–∏—Ö —Ç–æ–ª—å–∫–æ .meta
    paths-ignore:
      - '.meta/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate .meta
        run: |
          node generate-context.js --mode=both --max-lines=20000
          ls -la .meta || true

      - name: Commit .meta
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: generate .meta context"
          branch: ${{ github.ref_name }}
          file_pattern: ".meta/**"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

//=================================================
// FILE: /.github/workflows/validate.yml
name: Validate manifest and SW

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run manifest validator
        run: node scripts/ci/validate-manifest.mjs

      - name: Run SW linter
        run: node scripts/ci/lint-sw.mjs

      - name: Validate albums and galleries
        run: node scripts/ci/validate-content.mjs

  remote-validate:
    name: Remote content validate (informational)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Remote validate (warnings only)
        run: node scripts/ci/validate-content.mjs

//=================================================
// FILE: /albums.json
{
  "albums": [
    {
      "key": "mezhdu-zlom-i-dobrom",
      "title": "–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "base": "https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/"
    },
    {
      "key": "golos-dushi",
      "title": "–ì–æ–ª–æ—Å –î—É—à–∏",
      "base": "https://apel-s-in.github.io/vi3na1bita-golos-dushi/"
    },
    {
      "key": "odnazhdy-v-skazke",
      "title": "–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ",
      "base": "https://apel-s-in.github.io/vi3na1bita-odnazhdy-v-skazke/"
    },
    {
      "key": "krevetochka",
      "title": "–ö–†–ï–í–ï„ÉÑTOCHKA",
      "base": "https://apel-s-in.github.io/krevetochka/"
    }
  ]
}

//=================================================
// FILE: /albums/gallery/00/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-01.webp",
        "full": "albums/gallery/00/00-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-02.webp",
        "full": "albums/gallery/00/00-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/01/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-01.webp",
        "full": "albums/gallery/01/01-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-02.webp",
        "full": "albums/gallery/01/01-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-03.webp",
        "full": "albums/gallery/01/01-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-04.webp",
        "full": "albums/gallery/01/01-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/02/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-01.webp",
        "full": "albums/gallery/02/02-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-02.webp",
        "full": "albums/gallery/02/02-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-03.webp",
        "full": "albums/gallery/02/02-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-04.webp",
        "full": "albums/gallery/02/02-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/03/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-01.webp",
        "full": "albums/gallery/03/03-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-02.webp",
        "full": "albums/gallery/03/03-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-03.webp",
        "full": "albums/gallery/03/03-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-04.webp",
        "full": "albums/gallery/03/03-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/news/index.json
{
  "items": [
    { "type": "html", "src": "albums/gallery/news/news-01-baner.html" },
    {
      "formats": {
        "webp": "albums/gallery/news/news-cover-02.webp",
        "full": "albums/gallery/news/news-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /custom.json
{
  "rumEndpoint": "",
  "sw": {
    "mediaMaxCacheMB": 150,
    "nonRangeMaxStoreMB": 25,
    "nonRangeMaxStoreMBSlow": 10,
    "allowUnknownSize": false,
    "revalidateDays": 7
  },
  "items": [
    {
      "type": "ym",
      "title": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
      "subtitle": "–Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∞",
      "url": "https://music.yandex.ru/artist/24739002?utm_source=web&utm_medium=copy_link",
      "cover": ""
    },
    {
      "type": "tgPost",
      "title": "–°–≤–µ–∂–∏–π –ø–æ—Å—Ç –≤ Telegram",
      "url": "https://t.me/vitrina_razbita/28",
      "height": 480
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 3,
      "hash": "b8300406c5f33725de",
      "containerId": "vk_playlist_165137_3"
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 2,
      "hash": "d70fba309dc0bea296",
      "containerId": "vk_playlist_165137_2"
    }
  ]
}

//=================================================
// FILE: /index.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  
  <!-- iOS & PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  
  <!-- Favicons -->
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">
  
  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">
  
  <!-- Styles -->
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/modals.css">
  
  <!-- –ö–†–ò–¢–ò–ß–ù–û: Howler.js –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ü–ï–†–í–´–ú -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>
  
  <!-- Core -->
  <script src="./scripts/core/bootstrap.js"></script>
  <script src="./scripts/core/utils.js"></script>
  <script src="./scripts/core/config.js" type="module"></script>
  
  <!-- Player Core (–Ω–æ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞) -->
  <script src="./src/PlayerCore.js" type="module"></script>
  
  <!-- UI Modules -->
  <script src="./scripts/ui/notify.js" defer></script>
  <script src="./scripts/ui/favorites-const.js" defer></script>
  <script src="./scripts/ui/favorites-data.js" defer></script>
  <script src="./scripts/ui/favorites.js" defer></script>
  <script src="./scripts/ui/favorites-view.js" defer></script>
  <script src="./scripts/ui/sleep.js" defer></script>
  <script src="./scripts/ui/lyrics-modal.js" defer></script>

  <!-- Shared modal templates (IIFE -> window.Modals) -->
  <script src="./scripts/ui/modal-templates.js" defer></script>

  <script src="./scripts/ui/sysinfo.js" defer></script>
  
  <!-- App Modules -->
  <script src="./scripts/app/background-audio.js" defer></script>
  <script src="./scripts/app/background-events.js" type="module"></script>

  <!-- Network (needed for PQ rules + future network policy) -->
  <script src="./scripts/app/network-manager.js" defer></script>

  <script src="./scripts/app/playback-policy.js" defer></script>
  <script src="./scripts/app/player-ui/lyrics.js" defer></script>
  <script src="./scripts/app/player-ui.js" defer></script>
  <script src="./scripts/app/gallery.js" type="module"></script>
  <script src="./scripts/app/albums.js" type="module"></script>
  <script src="./scripts/app/navigation.js" type="module"></script>
  
  <!-- Main App -->
  <script src="./scripts/app.js" type="module"></script>

  <!-- OFFLINE platform bootstrap: —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ scripts/app.js -->
  
  <!-- Performance Monitoring -->
  <script src="./performance/rum.js" defer></script>
</head>
<body>
  <!-- Promocode Screen -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons" aria-label="–ê–ª—å–±–æ–º—ã"></div>
      
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" 
                title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" 
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div id="cover-slot" aria-label="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞"></div>
        
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" 
                title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" 
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <!-- –ú–∏–Ω–∏-–ø–ª–µ–µ—Ä (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –¥—Ä—É–≥–æ–≥–æ –∞–ª—å–±–æ–º–∞) -->
    <div id="now-playing" style="width:100%; max-width:395px; margin:8px auto 0 auto;"></div>
    
    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">

      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>
      
      <button id="install-pwa-btn" style="display: none;">
        –£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
      </button>
      
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;">
        –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò
      </button>
      
      <button id="sysinfo-btn" style="display:none;">
        –û –°–ò–°–¢–ï–ú–ï
      </button>
      
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      
      <a class="support-link" id="support-link" href="#" target="_blank">
        –ü–û–î–î–ï–†–ñ–ê–¢–¨
      </a>
      
      <button class="offline-btn" id="offline-btn">OFFLINE</button>
    </div>
  </div>

  <!-- Modals Container -->
  <div id="modals-container"></div>

  <!-- Inline Scripts -->
  <script>
    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    
    const VERSION = String(window.APP_CONFIG?.APP_VERSION || '8.0.4');
    const BUILD_DATE = String(window.APP_CONFIG?.BUILD_DATE || '2025-12-07');
    
    // –§–ª–∞–≥–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    window.autoNextDisabled = false;
    window.sleepTimerTarget = null;
    window.sleepTimerInterval = null;
    
    // ========== –ü–†–û–í–ï–†–ö–ê –ü–†–û–ú–û–ö–û–î–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
    
    window.addEventListener('load', () => {
      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iOS
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.body.classList.add('ios');
      }
      
      // ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –∏–∑ window.APP_CONFIG.PROMOCODE
      // –ü–æ–≤–µ–¥–µ–Ω–∏–µ:
      // - –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫/–ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏: –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –ø—Ä–æ–º–æ–∫–æ–¥–∞
      // - –µ—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –≤—Ö–æ–¥ —Å—Ä–∞–∑—É
      const PROMO = String(window.APP_CONFIG?.PROMOCODE || '').trim();

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –µ—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
      const savedPromo = localStorage.getItem('promocode');
      if (PROMO && savedPromo === PROMO) {
        unlockAppDirectly();
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
      const promoInput = document.getElementById('promo-inp');
      const promoBtn = document.getElementById('promo-btn');
      const promoError = document.getElementById('promo-error');

      const checkPromo = () => {
        const value = promoInput.value.trim();
        if (PROMO && value === PROMO) {
          localStorage.setItem('promocode', value);
          unlockAppDirectly();
        } else {
          promoError.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';
          promoInput.classList.add('error');
          setTimeout(() => {
            promoError.textContent = '';
            promoInput.classList.remove('error');
          }, 2000);
        }
      };
      
      promoBtn?.addEventListener('click', checkPromo);
      promoInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') checkPromo();
      });
      
      // iOS: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–æ —É—Å—Ç–∞–Ω–æ–≤–∫—É
      detectIOSAndShowInstallGuide();
      
      // Chrome: –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ Memory Saver —É–¥–∞–ª–µ–Ω–∞ –ø–æ –¥–∏–∑–∞–π–Ω—É
    });
    
    async function unlockAppDirectly() {
      const promocodeBlock = document.getElementById('promocode-block');
      const mainBlock = document.getElementById('main-block');

      if (promocodeBlock) promocodeBlock.classList.add('hidden');
      if (mainBlock) mainBlock.classList.remove('hidden');

      // OFFLINE –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ window.app.initialize()
      // (scripts/app.js), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–æ–∫ –∏ –¥—É–±–ª–µ–π.

      // ‚úÖ 2) –ñ–¥—ë–º window.app –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑
      const waitForApp = setInterval(() => {
        if (window.app && typeof window.app.initialize === 'function') {
          clearInterval(waitForApp);
          window.app.initialize();
        }
      }, 100);
    }
    
    // ========== iOS INSTALL GUIDE ==========
    
    function detectIOSAndShowInstallGuide() {
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
      
      if (!isIOS || isStandalone) return;
      
      setTimeout(() => {
        if (localStorage.getItem('iosInstallDismissed') === '1') return;
        
        const el = document.createElement('div');
        el.className = 'ios-install-prompt';
        el.innerHTML = `
          <button class="ios-prompt-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="dismissIOSPrompt()">√ó</button>
          <div class="ios-prompt-content">
            <img class="ios-prompt-icon" src="icons/apple-touch-icon.png" alt="–ò–∫–æ–Ω–∫–∞">
            <div style="font-weight:800; font-size:18px; margin-bottom:8px;">
              –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            </div>
            <div style="opacity:.85; margin-bottom:14px;">
              –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</strong> ‚ÜóÔ∏è<br>
              –∏ –≤—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª¬ª</strong>
            </div>
            <button class="ios-prompt-button" onclick="dismissIOSPrompt()">–ü–æ–Ω—è—Ç–Ω–æ</button>
          </div>
        `;
        document.body.appendChild(el);
        
        requestAnimationFrame(() => el.classList.add('show'));
      }, 3000);
    }
    
    function dismissIOSPrompt() {
      const el = document.querySelector('.ios-install-prompt');
      if (el) {
        el.classList.remove('show');
        localStorage.setItem('iosInstallDismissed', '1');
        setTimeout(() => el.remove(), 350);
      }
    }
    
    // ========== –£–¢–ò–õ–ò–¢–´ ==========
    // ‚úÖ –£—Ç–∏–ª–∏—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ scripts/core/utils.js (window.Utils.*)
    // Back-compat: –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤ legacy-–∫–æ–¥–µ –µ—â—ë –≤—ã–∑—ã–≤–∞—é—Ç—Å—è window.formatTime/escapeHtml.
    window.formatTime = window.Utils?.formatTime;
    window.escapeHtml = window.Utils?.escapeHtml;

    // ========== –≠–ö–°–ü–û–†–¢ –ì–õ–û–ë–ê–õ–¨–ù–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• ==========
    
    window.VERSION = VERSION;
    window.BUILD_DATE = BUILD_DATE;
    
    console.log(`üéµ –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ v${VERSION} (${BUILD_DATE})`);
  </script>
</body>
</html>


//=================================================
// FILE: /manifest.json
{
  "name": "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "short_name": "Vi3na1bita",
  "description": "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#181818",
  "theme_color": "#181818",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "categories": ["music", "entertainment"],
  "screenshots": []
}

//=================================================
// FILE: /news.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0e15;
      --panel: #131a26;
      --text: #eaf2ff;
      --muted: #9db7dd;
      --accent: #4daaff;
      --danger: #E80100;
      --border: #23324a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 14px;
      background: var(--bg); color: var(--text);
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
    }
    .container { max-width: 760px; margin: 0 auto; }
    h1 { margin: 6px 0 16px; font-size: 22px; }
    .news-list { display: grid; gap: 14px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .date { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .media { margin: 10px 0; }
    .media iframe, .media img, .media video {
      width: 100%; border: 0; border-radius: 8px; min-height: 220px; background: #0b0e15;
    }
    .card p { margin: 8px 0; line-height: 1.45; }
    .tags { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 12px; color: var(--accent); background: rgba(77,170,255,.12); border: 1px solid rgba(77,170,255,.25); padding: 4px 8px; border-radius: 999px; }
    .error { color: var(--danger); background: rgba(232,1,0,.1); border: 1px solid rgba(232,1,0,.2); padding: 10px; border-radius: 8px; }
    .loading { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ù–æ–≤–æ—Å—Ç–∏</h1>
    <div id="status" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="news" class="news-list"></div>
  </div>

  <script>
    async function loadNews() {
      const status = document.getElementById('status');
      const listEl = document.getElementById('news');
      try {
        const r = await fetch('./news/news.json', { cache: 'no-cache' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const items = Array.isArray(j.items) ? j.items : [];
        status.style.display = 'none';
        if (!items.length) {
          status.style.display = '';
          status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
          return;
        }
        listEl.innerHTML = items.map(renderCard).join('');
      } catch (e) {
        status.className = 'error';
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
      }
    }
    function esc(s) { return String(s || '').replace(/[<>&'"]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&#39;','"':'&quot;'}[m])); }
    function renderCard(it) {
      const title = esc(it.title || '–ù–æ–≤–æ—Å—Ç—å');
      const date = esc(it.date || '');
      const text = esc(it.text || '');
      const tags = Array.isArray(it.tags) ? it.tags : [];
      let media = '';
      if (it.embedUrl) {
        media = `<div class="media"><iframe loading="lazy" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`;
      } else if (it.image) {
        media = `<div class="media"><img loading="lazy" src="${esc(it.image)}" alt=""></div>`;
      } else if (it.video) {
        media = `<div class="media"><video controls preload="metadata" src="${esc(it.video)}"></video></div>`;
      }
      return `<article class="card">
        <h2>${title}</h2>
        ${date ? `<div class="date">${date}</div>` : ''}
        ${media}
        ${text ? `<p>${text}</p>` : ''}
        ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join('')}</div>` : ''}
      </article>`;
    }
    loadNews();
  </script>
</body>
</html>

//=================================================
// FILE: /service-worker.js
// service-worker.js
// –ï–¥–∏–Ω—ã–π Service Worker –¥–ª—è PWA "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"

const SW_VERSION = '8.1.0';

// –û—Å–Ω–æ–≤–Ω—ã–µ –∫—ç—à–∏ (–æ–∂–∏–¥–∞—é—Ç—Å—è lint-sw.mjs)
const CORE_CACHE = `vitrina-core-v${SW_VERSION}`;
const RUNTIME_CACHE = `vitrina-runtime-v${SW_VERSION}`;
const MEDIA_CACHE = `vitrina-media-v${SW_VERSION}`;
const OFFLINE_CACHE = `vitrina-offline-v${SW_VERSION}`;
const META_CACHE = `vitrina-meta-v${SW_VERSION}`;

// –ö–æ–Ω—Ñ–∏–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ–∂–∏–¥–∞–µ—Ç—Å—è lint-sw.mjs)
const DEFAULT_SW_CONFIG = {
  mediaMaxCacheMB: 150,
  nonRangeMaxStoreMB: 25,
  nonRangeMaxStoreMBSlow: 10,
  allowUnknownSize: false,
  revalidateDays: 7
};

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤ ¬´—è–¥—Ä–∞¬ª
const STATIC_ASSETS = [
  './',
  './index.html',
  './news.html',
  './manifest.json',
  './styles/main.css',
  './img/logo.png',
  './img/star.png',
  './img/star2.png',
  './icons/favicon-32.png',
  './icons/favicon-16.png',
  './icons/apple-touch-icon.png',

  // –°–∫—Ä–∏–ø—Ç—ã —è–¥—Ä–∞ –∏ UI
  './scripts/core/bootstrap.js',
  './scripts/core/config.js',
  './scripts/app/gallery.js',
  './scripts/ui/notify.js',
  './scripts/ui/favorites-const.js',
  './scripts/ui/favorites-data.js',
  './scripts/ui/favorites.js',
  './scripts/ui/favorites-view.js',
  './scripts/ui/sleep.js',
  './scripts/ui/lyrics-modal.js',
  './scripts/ui/sysinfo.js',
  './scripts/app/background-audio.js',
  './scripts/app/background-events.js',
  './scripts/app/player-ui.js',
  './scripts/app/albums.js',
  './scripts/app/navigation.js',
  './scripts/app.js',
  './src/PlayerCore.js',

  // Howler.js (CDN)
  // –í–ê–ñ–ù–û: –Ω–µ precache –Ω–∞ install, —á—Ç–æ–±—ã –Ω–µ —Ä–æ–Ω—è—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É SW –∏–∑-–∑–∞ opaque/CORS/CDN-–æ—à–∏–±–æ–∫.
  // CDN –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ —Å–µ—Ç–∏; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–∫—ç—à–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ runtime-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é.
];

// ‚úÖ –¢–æ—á–Ω—ã–π static-match: –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç–∏ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ URL –≤–Ω—É—Ç—Ä–∏ scope –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å—Ç—Ä–æ–≥–æ.
// –≠—Ç–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –ª–æ–∂–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏–∑-–∑–∞ endsWith –∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ –ø—Ä–∏ querystring/hash.
const normalizeUrlForMatch = (href) => {
  try {
    const u = new URL(href);
    u.hash = '';
    u.search = '';
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º "/" –∫–∞–∫ "/index.html" –¥–ª—è cache-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    if (u.pathname.endsWith('/')) u.pathname += 'index.html';
    return u.href;
  } catch {
    return String(href || '');
  }
};

const STATIC_URLS = (() => {
  const scope = (self.registration && self.registration.scope) ? self.registration.scope : self.location.origin + '/';
  const set = new Set();

  for (const asset of STATIC_ASSETS) {
    // –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ (http(s) –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –Ω–æ —É —Ç–µ–±—è –∏—Ö –Ω–µ—Ç)
    try {
      const abs = new URL(asset, scope).href;
      set.add(normalizeUrlForMatch(abs));
    } catch {}
  }

  return set;
})();

// ========== INSTALL ==========
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CORE_CACHE)
      .then((cache) => cache.addAll(STATIC_ASSETS))
      .then(() => self.skipWaiting())
  );
});

// ========== ACTIVATE ==========
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((names) =>
      Promise.all(
        names.map((name) => {
          if (
            name !== CORE_CACHE &&
            name !== RUNTIME_CACHE &&
            name !== MEDIA_CACHE &&
            name !== OFFLINE_CACHE &&
            name !== META_CACHE
          ) {
            return caches.delete(name);
          }
          return undefined;
        })
      )
    ).then(() => self.clients.claim())
  );
});

// ========== FETCH ==========
self.addEventListener('fetch', (event) => {
  const { request } = event;

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ-GET –∑–∞–ø—Ä–æ—Å—ã
  if (request.method !== 'GET') {
    return;
  }

  const url = new URL(request.url);

  // –ê—É–¥–∏–æ-—Ñ–∞–π–ª—ã ‚Äî –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∫—ç—à–∞, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥)
  if (/\.(mp3|ogg|m4a|flac)$/i.test(url.pathname)) {
    event.respondWith(fetch(request));
    return;
  }

  // –°—Ç–∞—Ç–∏–∫–∞: cache-first –∏–∑ CORE/RUNTIME (—Ç–æ—á–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
  const isStatic = STATIC_URLS.has(normalizeUrlForMatch(url.href));

  if (isStatic) {
    event.respondWith(
      caches.match(request).then((cached) => {
        if (cached) return cached;
        return fetch(request).then((resp) => {
          return caches.open(RUNTIME_CACHE).then((cache) => {
            cache.put(request, resp.clone());
            return resp;
          });
        });
      })
    );
    return;
  }

  // –û—Å—Ç–∞–ª—å–Ω–æ–µ: network-first —Å fallback –≤ RUNTIME_CACHE
  event.respondWith(
    fetch(request)
      .then((resp) => {
        const copy = resp.clone();
        caches.open(RUNTIME_CACHE).then((cache) => cache.put(request, copy));
        return resp;
      })
      .catch(() => caches.match(request))
  );
});

// ========== MESSAGE API (–¥–ª—è sysinfo.js –∏ ServiceWorkerManager) ==========
self.addEventListener('message', (event) => {
  const { data, ports } = event;
  if (!data || typeof data !== 'object') return;

  const type = data.type;

  // –û—Ç–≤–µ—Ç –≤–µ—Ä—Å–∏–∏ SW –¥–ª—è sysinfo.js
  if (type === 'GET_SW_VERSION') {
    const port = ports && ports[0];
    if (port) {
      port.postMessage({ version: SW_VERSION });
    }
    return;
  }

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
  if (type === 'SKIP_WAITING') {
    self.skipWaiting();
    return;
  }

  // –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ API ServiceWorkerManager ‚Äî —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å
  if (type === 'CLEAR_CACHE') {
    const cacheType = data.payload && data.payload.cacheType;
    let targetNames = [CORE_CACHE, RUNTIME_CACHE, MEDIA_CACHE, OFFLINE_CACHE, META_CACHE];

    if (cacheType === 'media') {
      targetNames = [MEDIA_CACHE];
    } else if (cacheType === 'offline') {
      targetNames = [OFFLINE_CACHE];
    }

    event.waitUntil(
      caches.keys().then((names) =>
        Promise.all(
          names.map((name) => {
            if (targetNames.includes(name)) {
              return caches.delete(name);
            }
            return undefined;
          })
        )
      )
    );
    return;
  }

  if (type === 'CACHE_AUDIO') {
    // –í —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Ç–æ–ª—å–∫–æ –Ω–µ –ø–∞–¥–∞–µ–º.
    // –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ.
    return;
  }

  if (type === 'GET_CACHE_SIZE') {
    const port = ports && ports[0];
    if (!port) return;

    // ‚úÖ –û–±–ª–µ–≥—á—ë–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç:
    // - –ù–ï —á–∏—Ç–∞–µ–º body (arrayBuffer), —á—Ç–æ–±—ã –Ω–µ —Ñ—Ä–∏–∑–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
    // - –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –∏ —Å—É–º–º–∞—Ä–Ω—ã–π Content-Length (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω).
    event.waitUntil(
      (async () => {
        let totalBytes = 0;
        let totalEntries = 0;

        try {
          const names = await caches.keys();
          for (const name of names) {
            const cache = await caches.open(name);
            const reqs = await cache.keys();
            totalEntries += reqs.length;

            for (const req of reqs) {
              const resp = await cache.match(req);
              if (!resp) continue;

              const len = resp.headers.get('content-length');
              if (len) {
                const n = Number(len);
                if (Number.isFinite(n) && n > 0) totalBytes += n;
              }
            }
          }
        } catch (e) {
          // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        }

        port.postMessage({
          size: totalBytes,
          entries: totalEntries,
          approx: true
        });
      })()
    );
    return;
  }
});

//=================================================
// FILE: /performance/rum.js
;(function(){
  // –ù–µ–±–æ–ª–µ–∑–Ω–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞: —á—Ç–æ–±—ã <script src="./performance/rum.js"> –Ω–µ –¥–∞–≤–∞–ª 404
  // –∏ –Ω–µ –ª–æ–º–∞–ª –º–µ—Ç—Ä–∏–∫–∏. –ï—Å–ª–∏ –≤ custom.json –ø–æ—è–≤–∏—Ç—Å—è endpoint ‚Äî –≤–∞—à –∫–æ–¥ –≤ index.html
  // –≤—ã–∑–æ–≤–µ—Ç initRUM(...) –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏.
  if (typeof window.initRUM !== 'function') {
    window.initRUM = function initRUM() { /* no-op */ };
  }
})();

//=================================================
// FILE: /scripts/app.js
import './ui/statistics-modal.js';
// scripts/app.js
// –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

// import { APP_CONFIG } from './core/config.js';
// –í–ê–ñ–ù–û: config.js —É–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –≤ index.html –∫–∞–∫ type="module" –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç window.APP_CONFIG.
// –ß—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å—Å—è –∏–∑-–∑–∞ –ø—É—Ç–µ–π/–∫—ç—à–∞/SW –Ω–∞ GitHub Pages ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π window.APP_CONFIG.

(function AppModule() {
  'use strict';

  const w = window;

  class Application {
    constructor() {
      this.initialized = false;
      this.serviceWorkerRegistered = false;
    }

    async initialize() {
      if (this.initialized) return;
      this.initialized = true;

      console.log(`üéµ Initializing app v${w.VERSION}`);

      try {
        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ –∞–ª—å–±–æ–º–æ–≤
        await this.loadAlbumsIndex();

        // ‚úÖ OFFLINE: –°—Ç—Ä–æ–≥–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // 1. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Offline Manager (Bootstrap)
        try {
          const offlineBoot = await import('./app/offline-ui-bootstrap.js');
          if (offlineBoot && typeof offlineBoot.attachOfflineUI === 'function') {
            offlineBoot.attachOfflineUI();
          }
        } catch (e) {
          console.error('‚ùå Critical: Offline Bootstrap failed:', e);
        }

        // 2. –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–∞–µ–º UI –∏ –ª–æ–≥–∏–∫—É –∫—ç—à–∞
        // –î–µ–ª–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É, —á—Ç–æ–±—ã IndexedDB —É—Å–ø–µ–ª–∞ –æ—Ç–∫—Ä—ã—Ç—å—Å—è
        await new Promise(r => setTimeout(r, 50));

        try {
          const [indicatorsMod, overlayMod, pcBoot] = await Promise.all([
            import('./ui/offline-indicators.js'),
            import('./ui/cache-progress-overlay.js'),
            import('./app/playback-cache-bootstrap.js')
          ]);

          // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–∑–∞–º–∫–∏/–æ–±–ª–∞–∫–∞)
          if (indicatorsMod && typeof indicatorsMod.attachOfflineIndicators === 'function') {
            indicatorsMod.attachOfflineIndicators();
          }
          
          // –û–≤–µ—Ä–ª–µ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
          if (overlayMod && typeof overlayMod.attachCacheProgressOverlay === 'function') {
            overlayMod.attachCacheProgressOverlay();
          }

          // –õ–æ–≥–∏–∫–∞ Playback Cache (PREV/CUR/NEXT)
          if (pcBoot && typeof pcBoot.attachPlaybackCache === 'function') {
            pcBoot.attachPlaybackCache();
          }
          
          console.log('‚úÖ Offline subsystems attached');
        } catch (e) {
          console.warn('‚ö†Ô∏è Offline UI subsystems partial failure:', e);
        }

        // ‚úÖ OFFLINE: –∞–≤—Ç–æ–ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ TrackRegistry –≤—Å–µ–º–∏ —Ç—Ä–µ–∫–∞–º–∏ (1 —Ä–∞–∑)
        // –ù—É–∂–Ω–æ, —á—Ç–æ–±—ã pinned/cloud/offline-all —Ä–∞–±–æ—Ç–∞–ª–∏ —Å—Ä–∞–∑—É, –¥–∞–∂–µ –±–µ–∑ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –∞–ª—å–±–æ–º–æ–≤.
        try {
          const key = 'offline:preloadAllTracksOnce:v1';
          const done = localStorage.getItem(key) === '1';

          if (!done) {
            const mod = await import('./ui/offline-modal.js');
            if (mod && typeof mod.preloadAllAlbumsTrackIndex === 'function') {
              // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º UI –ø–æ–ª–Ω–æ—Å—Ç—å—é: –Ω–æ –¥–æ–∂–¥—ë–º—Å—è, —á—Ç–æ–±—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –º–æ–≥–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–æ.
              await mod.preloadAllAlbumsTrackIndex();
              localStorage.setItem(key, '1');
            }
          }
        } catch (e) {
          console.warn('OFFLINE preloadAllAlbumsTrackIndex failed:', e);
        }

        // 2. –û–∂–∏–¥–∞–µ–º, —á—Ç–æ PlayerCore —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è (src/PlayerCore.js –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º)
        // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        await this.initializeFavorites();

        // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∞–ª–µ—Ä–µ–∏
        await this.initializeGallery();

        // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∞–ª—å–±–æ–º–æ–≤
        await this.initializeAlbums();

        // 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –ø–ª–µ–µ—Ä–∞
        await this.initializePlayerUI();

        // 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
        this.initializeModules();

        // 7. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–ª–µ–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π PlayerState)
        if (w.PlayerState && typeof w.PlayerState.apply === 'function') {
          await w.PlayerState.apply();
        }

        // 8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
        this.setupHotkeys();

        // 9. –û–±—Ä–∞–±–æ—Ç–∫–∞ PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        this.setupPWAInstall();

        // 10. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker (update flow)
        this.setupServiceWorkerMessaging();

        console.log('‚úÖ Application initialized successfully');

      } catch (error) {
        console.error('‚ùå Failed to initialize app:', error);
        w.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
      }
    }

    async loadAlbumsIndex() {
      // –ò–Ω–¥–µ–∫—Å –∞–ª—å–±–æ–º–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ scripts/core/bootstrap.js –∏–∑ ./albums.json
      // –∏ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ window.albumsIndex. –ó–¥–µ—Å—å –¥–æ–∂–∏–¥–∞–µ–º—Å—è, —á—Ç–æ–±—ã –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å —Ä–∞–Ω—å—à–µ bootstrap.
      const maxWaitMs = 2000;
      const stepMs = 50;
      let waited = 0;

      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å ‚Äî –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if (Array.isArray(w.albumsIndex) && w.albumsIndex.length > 0) {
        console.log(`‚úÖ Albums index already loaded: ${w.albumsIndex.length} albums`);
        return;
      }

      // –ü–æ–¥–æ–∂–¥—ë–º, –ø–æ–∫–∞ bootstrap –ø–æ–¥–Ω–∏–º–µ—Ç albumsIndex
      while ((!Array.isArray(w.albumsIndex) || w.albumsIndex.length === 0) && waited < maxWaitMs) {
        await new Promise(r => setTimeout(r, stepMs));
        waited += stepMs;
      }

      if (Array.isArray(w.albumsIndex) && w.albumsIndex.length > 0) {
        console.log(`‚úÖ Albums index loaded after bootstrap wait: ${w.albumsIndex.length} albums`);
        return;
      }

      console.warn(
        '‚ö†Ô∏è albumsIndex is empty in Application.loadAlbumsIndex() –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è. ' +
        '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É ./albums.json –≤ scripts/core/bootstrap.js'
      );
      w.albumsIndex = w.albumsIndex || [];
    }

    async _waitForReady(checkFn, maxMs = 2000) {
      // ‚úÖ –ï–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ–∂–∏–¥–∞–Ω–∏—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º Utils.waitFor –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ,
      // –∏–Ω–∞—á–µ –¥–µ–ª–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π fallback.
      const waitFor = w.Utils?.waitFor;
      if (typeof waitFor === 'function') {
        return waitFor(checkFn, maxMs, 50);
      }

      const started = Date.now();
      while (!checkFn() && (Date.now() - started) < maxMs) {
        // eslint-disable-next-line no-await-in-loop
        await new Promise(r => setTimeout(r, 50));
      }
      return checkFn();
    }

    async initializeFavorites() {
      const ok = await this._waitForReady(() =>
        !!(w.FavoritesManager && typeof w.FavoritesManager.initialize === 'function')
      );

      if (ok) {
        w.FavoritesManager.initialize();
        console.log('‚úÖ Favorites initialized');
      } else {
        console.warn('‚ö†Ô∏è FavoritesManager not ready');
      }
    }

    async initializeGallery() {
      const ok = await this._waitForReady(() =>
        !!(w.GalleryManager && typeof w.GalleryManager.initialize === 'function')
      );

      if (ok) {
        w.GalleryManager.initialize();
        console.log('‚úÖ Gallery initialized');
      } else {
        console.warn('‚ö†Ô∏è GalleryManager not ready');
      }
    }

    async initializeAlbums() {
      const ok = await this._waitForReady(() =>
        !!(w.AlbumsManager && typeof w.AlbumsManager.initialize === 'function')
      );

      if (ok) {
        w.AlbumsManager.initialize();
        console.log('‚úÖ Albums initialized');
      } else {
        console.warn('‚ö†Ô∏è AlbumsManager not ready');
      }
    }

    async initializePlayerUI() {
      const ok = await this._waitForReady(() =>
        !!(w.PlayerUI && typeof w.PlayerUI.initialize === 'function')
      );

      if (ok) {
        w.PlayerUI.initialize();
        console.log('‚úÖ PlayerUI initialized');
      } else {
        console.warn('‚ö†Ô∏è PlayerUI not ready');
      }
    }

    // initializePlayerUI / initializeGallery –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä—è–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –≤—ã–ø–æ–ª–Ω—è–µ–º —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π _waitForReady, –±–µ–∑ –¥—É–±–ª–µ–π.

    initializeModules() {
      // –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –º–æ–¥—É–ª–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ —Å–∞–º–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞.
      // –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ no-op –≤—ã–∑–æ–≤—ã –Ω–∞ —Å–ª—É—á–∞–π –ø–æ—è–≤–ª–µ–Ω–∏—è initialize() –≤ –±—É–¥—É—â–µ–º.
      const maybeInit = (obj, name) => {
        try {
          if (obj && typeof obj.initialize === 'function') {
            obj.initialize();
            console.log(`‚úÖ ${name} initialized`);
          }
        } catch (e) {
          console.warn(`${name}.initialize failed:`, e);
        }
      };

      maybeInit(w.SleepTimer, 'SleepTimer');
      maybeInit(w.LyricsModal, 'LyricsModal');
      maybeInit(w.SystemInfoManager, 'SystemInfoManager');
      // StatisticsModal does not need init, exposes .show()
      maybeInit(w.BackgroundAudioManager, 'BackgroundAudioManager');
    }

    setupServiceWorkerMessaging() {
      // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π update flow —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç SW.
      // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è:
      // - –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è,
      // - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏/—Ç—Ä–µ–∫–∞ –ø–µ—Ä–µ–¥ reload,
      // - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ PlayerState –ø–æ—Å–ª–µ reload.
      if (!('serviceWorker' in navigator)) return;

      // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
      if (this.__swMsgBound) return;
      this.__swMsgBound = true;

      const handle = async (event) => {
        const msg = event?.data || {};
        if (!msg || typeof msg !== 'object') return;

        // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–µ—Ä—Å–∏–∏ SW (–º–æ–∂–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å SW –∏–ª–∏ —Ç–µ—Å—Ç)
        if (msg.type === 'SW_VERSION') {
          const swVer = String(msg.version || '').trim();
          const appVer = String(w.VERSION || '').trim();
          if (!swVer) return;
          if (appVer && swVer === appVer) return;

          // ‚úÖ –ï–î–ò–ù–´–ô –∏—Å—Ç–æ—á–Ω–∏–∫ UI-–ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî ServiceWorkerManager.
          // –ó–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ (–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º e2e-—Å–∏–º—É–ª—è—Ü–∏—é).
          try {
            if (w.ServiceWorkerManager && typeof w.ServiceWorkerManager.handleVersionMessage === 'function') {
              w.ServiceWorkerManager.handleVersionMessage({ swVer, appVer });
            }
          } catch (e) {
            console.warn('ServiceWorkerManager.handleVersionMessage failed:', e);
          }
        }
      };

      // –†–µ–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç SW
      navigator.serviceWorker.addEventListener('message', handle);

      // ‚úÖ –î–ª—è e2e (–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ fallback): –ø–æ–∑–≤–æ–ª—è–µ–º —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ window.dispatchEvent(...)
      // –ù–∏–∫–∞–∫–∏—Ö –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –±–µ–∑ confirm().
      window.addEventListener('message', handle);
    }

    setupHotkeys() {
      document.addEventListener('keydown', (e) => {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –≤ input/textarea
        if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;

        const key = e.key.toLowerCase();

        switch (key) {
          case 'k':
          case ' ':
            e.preventDefault();
            w.PlayerUI?.togglePlayPause?.();
            break;

          case 'n':
            e.preventDefault();
            w.playerCore?.next();
            break;

          case 'p':
            e.preventDefault();
            w.playerCore?.prev();
            break;

          case 'x':
            e.preventDefault();
            w.playerCore?.stop();
            break;

          case 'm':
            e.preventDefault();
            document.getElementById('mute-btn')?.click();
            break;

          case 'r':
            e.preventDefault();
            document.getElementById('repeat-btn')?.click();
            break;

          case 'u':
            e.preventDefault();
            document.getElementById('shuffle-btn')?.click();
            break;

          case 'a':
            e.preventDefault();
            document.getElementById('animation-btn')?.click();
            break;

          case 'b':
            e.preventDefault();
            document.getElementById('pulse-btn')?.click();
            break;

          case 'f':
            e.preventDefault();
            document.getElementById('favorites-btn')?.click();
            break;

          case 't':
            e.preventDefault();
            w.SleepTimer?.show?.();
            break;

          case 'y':
            e.preventDefault();
            document.getElementById('lyrics-toggle-btn')?.click();
            break;

          case 'arrowleft':
            e.preventDefault();
            w.playerCore?.seek(Math.max(0, w.playerCore.getPosition() - 5));
            break;

          case 'arrowright':
            e.preventDefault();
            w.playerCore?.seek(Math.min(w.playerCore.getDuration(), w.playerCore.getPosition() + 5));
            break;

          case 'arrowup':
            e.preventDefault();
            const currentVol = w.playerCore?.getVolume() || 100;
            w.playerCore?.setVolume(Math.min(100, currentVol + 5));
            break;

          case 'arrowdown':
            e.preventDefault();
            const vol = w.playerCore?.getVolume() || 100;
            w.playerCore?.setVolume(Math.max(0, vol - 5));
            break;
        }
      });

      console.log('‚úÖ Hotkeys enabled');
    }

    setupPWAInstall() {
      let deferredPrompt = null;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;

        const btn = document.getElementById('install-pwa-btn');
        if (btn) {
          btn.style.display = 'block';
          btn.onclick = async () => {
            if (!deferredPrompt) return;

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
              w.NotificationSystem?.success('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
            }

            deferredPrompt = null;
            btn.style.display = 'none';
          };
        }
      });

      window.addEventListener('appinstalled', () => {
        w.NotificationSystem?.success('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
        const btn = document.getElementById('install-pwa-btn');
        if (btn) btn.style.display = 'none';
      });
    }
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
  w.app = new Application();

  // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ initialize() –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ index.html (unlockAppDirectly),
  // —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–æ–∫ –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –∏ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π.
  // –ó–¥–µ—Å—å —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º initialize() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

})(); // end of AppModule IIFE

// ========== PlayerState (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–ª–µ–µ—Ä–∞) ==========
(function PlayerStateModule() {
  'use strict';

  const STORAGE_KEY_V2 = 'playerStateV2';
  const SESSION_RESUME_KEY_V2 = 'resumeAfterReloadV2';

  function save(options = {}) {
    try {
      if (!window.playerCore) return;

      const track = window.playerCore.getCurrentTrack();
      const index = window.playerCore.getIndex();
      const position = window.playerCore.getPosition();
      const volume = window.playerCore.getVolume();
      const wasPlaying = window.playerCore.isPlaying();

      const playingAlbum = window.AlbumsManager?.getPlayingAlbum?.() || null;
      const currentAlbum = window.AlbumsManager?.getCurrentAlbum?.() || null;

      // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      const lyricsViewMode = localStorage.getItem('lyricsViewMode') || 'normal';
      const animationEnabled = localStorage.getItem('lyricsAnimationEnabled') === '1';

      const trackUid = String(track?.uid || '').trim() || null;
      const sourceAlbum = String(track?.sourceAlbum || '').trim() || null;

      const state = {
        album: playingAlbum,
        currentAlbum: currentAlbum, // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–π –∞–ª—å–±–æ–º

        // ‚úÖ –ù–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: uid
        trackUid,
        sourceAlbum,

        // legacy fallback (–µ—Å–ª–∏ uid –Ω–µ—Ç)
        trackIndex: typeof index === 'number' ? index : 0,

        position: Math.floor(position || 0),
        volume: typeof volume === 'number' ? volume : 100,
        wasPlaying: !!wasPlaying,
        // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        lyricsViewMode: lyricsViewMode,
        animationEnabled: animationEnabled,
        // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –º–∏–Ω–∏-–ø–ª–µ–µ—Ä–∞
        isMiniMode: !!(playingAlbum && currentAlbum && playingAlbum !== currentAlbum)
      };

      localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(state));

      if (options.forReload) {
        // –ö—Ä–∞—Ç–∫–æ–∂–∏–≤—É—â–∏–π —Å—Ç–µ–π—Ç –¥–ª—è SW‚Äë–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ–¥–Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)
        sessionStorage.setItem(SESSION_RESUME_KEY_V2, '1');
      }

      // –ù–µ —Ç—Ä–æ–≥–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–Ω–∏–º–æ–∫.
    } catch (e) {
      console.warn('PlayerState.save failed:', e);
    }
  }

  async function apply() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_V2);
      if (!raw) return;

      const state = JSON.parse(raw);
      if (!state || typeof state !== 'object') return;

      const albumKey = state.album;
      const currentAlbum = state.currentAlbum || albumKey; // ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–π –∞–ª—å–±–æ–º
      const trackUid = String(state.trackUid || '').trim();
      const sourceAlbum = String(state.sourceAlbum || '').trim();
      const trackIndex = Number.isFinite(state.trackIndex) ? state.trackIndex : 0;
      const position = Number.isFinite(state.position) ? state.position : 0;
      const volume = Number.isFinite(state.volume) ? state.volume : 100;
      const wasPlaying = !!state.wasPlaying;

      // ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      if (state.lyricsViewMode) {
        localStorage.setItem('lyricsViewMode', state.lyricsViewMode);
      }
      if (typeof state.animationEnabled === 'boolean') {
        localStorage.setItem('lyricsAnimationEnabled', state.animationEnabled ? '1' : '0');
      }

      if (!albumKey || !window.AlbumsManager || !window.playerCore) return;

      // 1. ‚úÖ –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –ü–†–û–°–ú–ê–¢–†–ò–í–ê–ï–ú–´–ô –∞–ª—å–±–æ–º (–¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ UI)
      if (currentAlbum && currentAlbum !== albumKey) {
        await window.AlbumsManager.loadAlbum(currentAlbum);
      }

      // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –ø–ª–µ–π–ª–∏—Å—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –∫–ª–∏–∫–µ –ø–æ —Ç—Ä–µ–∫—É
      if (albumKey === window.SPECIAL_FAVORITES_KEY) {
        // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        // ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ uid: –Ω–∞–π–¥—ë–º –∏–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏ –≤ favoritesRefsModel
        let idxToPlay = trackIndex;

        if (trackUid) {
          const model = Array.isArray(window.favoritesRefsModel) ? window.favoritesRefsModel : [];
          const found = model.findIndex(it =>
            it &&
            String(it.__uid || '').trim() === trackUid &&
            (!sourceAlbum || String(it.__a || '').trim() === sourceAlbum)
          );
          if (found >= 0) idxToPlay = found;
        }

        await window.AlbumsManager.ensureFavoritesPlayback(idxToPlay);
      } else {
        // –û–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º
        const albumData = window.AlbumsManager.getAlbumData(albumKey);
        const albumInfo = (window.albumsIndex || []).find(a => a.key === albumKey);
        if (!albumData || !albumInfo) return;

        const base = albumInfo.base || '';
        const coverUrl = (() => {
          try {
            return window.AlbumsManager?.albumCoverUrlCache?.get?.(albumKey) || 'img/logo.png';
          } catch {
            return 'img/logo.png';
          }
        })();

        const tracksForCore = albumData.tracks
          .filter(t => !!t && (!!t.fileHi || !!t.file || !!t.fileLo))
          .map((t) => ({
            src: t.fileHi || t.file || t.fileLo,
            sources: t.sources || null,

            title: t.title,
            artist: albumData.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
            album: albumKey,
            cover: coverUrl,
            lyrics: t.lyrics || null,
            fulltext: t.fulltext || null,
            uid: (typeof t.uid === 'string' && t.uid.trim()) ? t.uid.trim() : null,
            hasLyrics: (typeof t.hasLyrics === 'boolean') ? t.hasLyrics : null
          }));

        if (tracksForCore.length > 0) {
          // ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ uid (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ ‚Äî trackIndex
          let startIndex = trackIndex;

          if (trackUid) {
            const found = tracksForCore.findIndex(t => String(t?.uid || '').trim() === trackUid);
            if (found >= 0) startIndex = found;
          }

          window.playerCore.setPlaylist(tracksForCore, startIndex, {
            artist: albumData.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
            album: albumData.title || albumInfo.title || '',
            cover: 'img/logo.png'
          });
          window.AlbumsManager.setPlayingAlbum(albumKey);
          window.playerCore.play(startIndex);
        }
      }

      // 3. –ì—Ä–æ–º–∫–æ—Å—Ç—å –∏ –ø–æ–∑–∏—Ü–∏—è
      window.playerCore.setVolume(volume);
      if (position > 0) {
        try { window.playerCore.seek(position); } catch {}
      }

      // 4. –ï—Å–ª–∏ –¥–æ —ç—Ç–æ–≥–æ –∏–≥—Ä–∞–ª–æ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ
      if (!wasPlaying && window.playerCore.isPlaying()) {
        window.playerCore.pause();
      }

      // –ü—Ä–∞–≤–∏–ª–æ ¬´–Ω–∏—á—Ç–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç¬ª —Å–æ–±–ª—é–¥–µ–Ω–æ: –º—ã –ª–∏–±–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä–∞—Ç—å,
      // –ª–∏–±–æ –º—è–≥–∫–æ —Å—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ —ç—Ç–æ–≥–æ –±—ã–ª–∞ –ø–∞—É–∑–∞.
    } catch (e) {
      console.warn('PlayerState.apply failed:', e);
    } finally {
      try {
        // –ü–æ—Å–ª–µ —É–¥–∞—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Ñ–ª–∞–≥ SW‚Äë—Ä–µ—é–º–∞
        sessionStorage.removeItem(SESSION_RESUME_KEY_V2);
      } catch {}
    }
  }

  window.PlayerState = {
    save,
    apply
  };
})();

//=================================================
// FILE: /scripts/app/albums.js
// scripts/app/albums.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞–º–∏ –Ω–∞ –Ω–æ–≤–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ PlayerCore

// import { APP_CONFIG } from '../core/config.js';
// –í–ê–ñ–ù–û: config.js –ø—É–±–ª–∏–∫—É–µ—Ç window.APP_CONFIG. –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –Ω–∞ GitHub Pages/SW.
const APP_CONFIG = window.APP_CONFIG;

import { registerTrack } from './track-registry.js';

class AlbumsManager {
  constructor() {
    this.currentAlbum = null;
    this.playingAlbum = null;
    this.albumsData = new Map();
    this.isLoading = false;

    // ‚úÖ –ö—ç—à URL –æ–±–ª–æ–∂–∫–∏ –∞–ª—å–±–æ–º–∞ (–ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏)
    this.albumCoverUrlCache = new Map();
    
    // ‚úÖ –§–ª–∞–≥ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥–∞–ª–µ—Ä–µ–∏ (toggle –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∫–ª–∏–∫–µ)
    this.isGalleryVisible = true;
  }

  async initialize() {
    const maxWaitMs = 2000;
    const stepMs = 50;
    let waited = 0;

    while ((!window.albumsIndex || window.albumsIndex.length === 0) && waited < maxWaitMs) {
      await new Promise(r => setTimeout(r, stepMs));
      waited += stepMs;
    }

    if (!Array.isArray(window.albumsIndex) || window.albumsIndex.length === 0) {
      console.error('‚ùå No albums found (albumsIndex is empty after wait)');
      return;
    }

    console.log(`‚úÖ Albums available: ${window.albumsIndex.length}`);

    this.renderAlbumIcons();
    
    const lastAlbum = localStorage.getItem('currentAlbum');

    // ‚úÖ –ï—Å–ª–∏ –∞–ª—å–±–æ–º –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫/–æ—á–∏—Å—Ç–∫–∞) ‚Äî –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π "–æ–±—ã—á–Ω—ã–π" –∞–ª—å–±–æ–º
    // –∏–∑ ICON_ALBUMS_ORDER, —á—Ç–æ–±—ã –ø–æ—Ä—è–¥–æ–∫ –±—ã–ª —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π.
    let albumToLoad = lastAlbum;

    if (!albumToLoad) {
      const ordered = (APP_CONFIG?.ICON_ALBUMS_ORDER || []).map(x => x.key).filter(Boolean);
      const firstRegular = ordered.find(k => k && !String(k).startsWith('__') && window.albumsIndex.some(a => a.key === k));
      albumToLoad = firstRegular || (window.albumsIndex[0]?.key || null);
    }

    if (!this.__favoritesAlbumSyncBound) {
      this.__favoritesAlbumSyncBound = true;

      // ‚úÖ Realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–≤—ë–∑–¥ –≤ –†–û–î–ù–´–• –∞–ª—å–±–æ–º–∞—Ö (–∏ –≤ –ª—é–±–æ–º —Ç–µ–∫—É—â–µ–º DOM —Ç—Ä–µ–∫–ª–∏—Å—Ç–∞)
      window.addEventListener('favorites:changed', (ev) => {
        const d = ev?.detail || {};
        const a = String(d.albumKey || '').trim();
        const uid = String(d.uid || '').trim();
        const liked = !!d.liked;

        if (!a || !uid) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∑–≤—ë–∑–¥—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–≤–ø–∞–ª album+uid
        const selector = `.like-star[data-album="${CSS.escape(a)}"][data-uid="${CSS.escape(uid)}"]`;
        document.querySelectorAll(selector).forEach((img) => {
          try {
            img.src = liked ? 'img/star.png' : 'img/star2.png';
          } catch {}
        });
      });
    }

    if (albumToLoad) {
      await this.loadAlbum(albumToLoad);
    }
  }

  renderAlbumIcons() {
    const container = document.getElementById('album-icons');
    if (!container) return;

    container.innerHTML = '';

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    APP_CONFIG.ICON_ALBUMS_ORDER.forEach(({ key, title, icon }) => {
      if (!key.startsWith('__')) {
        const exists = window.albumsIndex.some(a => a.key === key);
        if (!exists) return;
      }

      const iconEl = document.createElement('div');
      iconEl.className = 'album-icon';
      iconEl.dataset.album = key;
      iconEl.dataset.akey = key;
      iconEl.title = title;

      const baseIcon = icon || 'img/logo.png';
      const path1x = isMobile
        ? baseIcon.replace(/icon_album\/(.+)\.png$/i, 'icon_album/mobile/$1@1x.jpg')
        : baseIcon.replace(/\.png$/i, '@1x.png');
      const path2x = isMobile
        ? path1x.replace(/@1x\.jpg$/i, '@2x.jpg')
        : path1x.replace(/@1x\.png$/i, '@2x.png');

      iconEl.innerHTML = `<img src="${path1x}" srcset="${path2x} 2x" alt="${title}" draggable="false" loading="lazy" width="60" height="60">`;

      // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      iconEl.addEventListener('click', () => this.handleAlbumIconClick(key));
      
      container.appendChild(iconEl);
    });
  }

  /**
   * ‚úÖ –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –£–ñ–ï –∞–∫—Ç–∏–≤–Ω—ã–π –∞–ª—å–±–æ–º ‚Äî toggle –≥–∞–ª–µ—Ä–µ–∏
   */
  async handleAlbumIconClick(albumKey) {
    console.log(`üéØ Album icon clicked: ${albumKey}, current: ${this.currentAlbum}`);
    
    // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ –ø–æ —Ç–µ–∫—É—â–µ–º—É –∞–ª—å–±–æ–º—É ‚Äî toggle –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥–∞–ª–µ—Ä–µ–∏
    if (this.currentAlbum === albumKey && !albumKey.startsWith('__')) {
      this.toggleGalleryVisibility();
      return;
    }
    
    // –ò–Ω–∞—á–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º
    await this.loadAlbum(albumKey);
  }

  /**
   * ‚úÖ Toggle –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥–∞–ª–µ—Ä–µ–∏
   */
  toggleGalleryVisibility() {
    this.isGalleryVisible = !this.isGalleryVisible;
    
    const coverWrap = document.getElementById('cover-wrap');
    if (coverWrap) {
      coverWrap.style.display = this.isGalleryVisible ? '' : 'none';
    }
    
    window.NotificationSystem?.info(
      this.isGalleryVisible ? 'üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –ø–æ–∫–∞–∑–∞–Ω–∞' : 'üö´ –ì–∞–ª–µ—Ä–µ—è —Å–∫—Ä—ã—Ç–∞'
    );
  }

  async loadAlbum(albumKey) {
    if (this.isLoading) {
      console.warn('‚ö†Ô∏è Album loading already in progress');
      return;
    }
    
    this.isLoading = true;

    try {
      // ‚úÖ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≥–∞–ª–µ—Ä–µ–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑–∞–Ω–∞)
      this.isGalleryVisible = true;

      this.clearUI();

      if (albumKey === '__favorites__') {
        await this.loadFavoritesAlbum();
      } else if (albumKey === '__reliz__') {
        await this.loadNewsAlbum();
      } else {
        await this.loadRegularAlbum(albumKey);
      }

      this.currentAlbum = albumKey;
      this.updateActiveIcon(albumKey);
      localStorage.setItem('currentAlbum', albumKey);
      
      console.log(`‚úÖ currentAlbum set to: ${albumKey}`);

      // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      const trackList = document.getElementById('track-list');

      if (trackList) {
        trackList.classList.remove('filtered');
      }

      if (window.PlayerUI && typeof window.PlayerUI.switchAlbumInstantly === 'function') {
        window.PlayerUI.switchAlbumInstantly(albumKey);
      }

      if (window.PlayerState && typeof window.PlayerState.save === 'function') {
        window.PlayerState.save();
      }

      console.log(`‚úÖ Album loaded: ${albumKey}`);

    } catch (error) {
      console.error('‚ùå Failed to load album:', error);
      window.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–∞');
    } finally {
      this.isLoading = false;
    }
  }

  async loadRegularAlbum(albumKey) {
    const albumInfo = window.albumsIndex.find(a => a.key === albumKey);
    if (!albumInfo) {
      throw new Error(`Album ${albumKey} not found`);
    }

    let albumData = this.albumsData.get(albumKey);

    if (!albumData) {
      const base = albumInfo.base.endsWith('/') ? albumInfo.base : `${albumInfo.base}/`;
      const response = await fetch(`${base}config.json`, { cache: 'no-cache' });
      
      if (!response.ok) {
        throw new Error(`Failed to load config.json for ${albumKey}: HTTP ${response.status}`);
      }

      const raw = await response.json();
      const data = raw || {};

      const tracks = Array.isArray(data.tracks) ? data.tracks : [];
      const normTracks = tracks.map((t, idx) => {
        const fileHi = t.audio ? new URL(t.audio, base).toString() : null;
        const fileLo = t.audio_low ? new URL(t.audio_low, base).toString() : null;

        // ‚úÖ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL –ª–∏—Ä–∏–∫–∏: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ .lrc –∏ .json
        let lyrics = null;
        if (t.lyrics) {
          lyrics = new URL(t.lyrics, base).toString();
        } else if (t.lrc) {
          // ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—è lrc –Ω–∞–ø—Ä—è–º—É—é
          lyrics = new URL(t.lrc, base).toString();
        }

        const fulltext = t.fulltext ? new URL(t.fulltext, base).toString() : null;

        const uid = (typeof t.uid === 'string' && t.uid.trim()) ? t.uid.trim() : null;

        // num –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è UI-–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const num = idx + 1;

        const sizeHiMB = typeof t.size === 'number' ? t.size : null;
        const sizeLoMB = typeof t.size_low === 'number' ? t.size_low : null;

        // ‚úÖ –§–ª–∞–≥ hasLyrics –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–±–µ–∑ HEAD-–∑–∞–ø—Ä–æ—Å–æ–≤)
        // –ï—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º, –∏–Ω–∞—á–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –Ω–∞–ª–∏—á–∏—é URL
        let hasLyrics = null;
        if (typeof t.hasLyrics === 'boolean') {
          hasLyrics = t.hasLyrics;
        } else {
          hasLyrics = !!(lyrics || t.lyrics || t.lrc);
        }

        // ‚úÖ sources –¥–ª—è PlayerCore (–∫–∞—á–µ—Å—Ç–≤–æ Hi/Lo)
        const sources = (fileHi || fileLo) ? {
          audio: {
            hi: fileHi,
            lo: fileLo
          }
        } : null;

        return {
          num,
          title: t.title || `–¢—Ä–µ–∫ ${idx + 1}`,

          // ‚úÖ Back-compat: file –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ "–æ—Å–Ω–æ–≤–Ω–æ–π" (Hi) –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —á–∞—Å—Ç–µ–π –∫–æ–¥–∞
          file: fileHi,

          // ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
          fileHi,
          fileLo,
          sizeHi: sizeHiMB,
          sizeLo: sizeLoMB,
          sources,

          lyrics,
          fulltext,
          uid,
          hasLyrics // ‚úÖ –ù–æ–≤–æ–µ –ø–æ–ª–µ
        };
      });

      // ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç—Ä–µ–∫–∏ –≤ TrackRegistry (uid -> urls/sizes) –¥–ª—è OFFLINE/Updater/PlaybackCache
      try {
        for (const t of normTracks) {
          if (!t || !t.uid) continue;
          registerTrack({
            uid: t.uid,
            title: t.title,
            audio: t.fileHi || t.file || null,
            audio_low: t.fileLo || null,
            size: t.sizeHi || null,
            size_low: t.sizeLo || null,
            lyrics: t.lyrics || null,
            fulltext: t.fulltext || null,
            sourceAlbum: albumKey
          });
        }
      } catch {}

      const coverPath = data.cover || 'cover.jpg';

      const socialLinks = Array.isArray(data.social_links) 
        ? data.social_links 
        : (Array.isArray(data.socials) 
            ? data.socials.map(s => ({ label: s.title, url: s.url }))
            : []);

      albumData = {
        title: data.albumName || albumInfo.title,
        artist: data.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        cover: coverPath,
        social_links: socialLinks,
        tracks: normTracks
      };

      this.albumsData.set(albumKey, albumData);
    }
    // ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ GalleryManager
    await this.loadGallery(albumKey);

    // ‚úÖ –û–±–ª–æ–∂–∫–∞ –¥–ª—è PlayerCore/MediaSession: –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏ (–∏–ª–∏ logo)
    try {
      const coverUrl = await window.GalleryManager?.getFirstCoverUrl?.(albumKey);
      this.albumCoverUrlCache.set(albumKey, coverUrl || 'img/logo.png');
    } catch {
      this.albumCoverUrlCache.set(albumKey, 'img/logo.png');
    }

    // ‚úÖ Fallback: –µ—Å–ª–∏ –≥–∞–ª–µ—Ä–µ—è –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å/–ø—É—Å—Ç–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º logo.png,
    // –Ω–µ —Ç—Ä–æ–≥–∞—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (–±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø–ª–µ–µ—Ä–∞ —Å–æ–±–ª—é–¥–∞–µ–º).
    try {
      const count = window.GalleryManager?.getItemsCount?.() || 0;
      if (count <= 0) {
        const slot = document.getElementById('cover-slot');
        if (slot) {
          slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
        }
      }
    } catch {}

    this.renderAlbumTitle(albumData.title || albumInfo.title);
    
    // ‚úÖ cover.jpg –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º: –∏—Å—Ç–æ—á–Ω–∏–∫ –æ–±–ª–æ–∂–µ–∫ ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è.
    
    this.renderSocials(albumData.social_links);
    this.renderTrackList(albumData.tracks, albumInfo);

    if (window.PlayerUI) {
      window.PlayerUI.updateMiniHeader?.();
      window.PlayerUI.updateNextUpLabel?.();
    }

    // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∏–¥–∏–º–∞)
    const coverWrap = document.getElementById('cover-wrap');
    if (coverWrap) coverWrap.style.display = '';
  }

  async loadGallery(albumKey) {
    if (window.GalleryManager) {
      await window.GalleryManager.loadGallery(albumKey);
    }
  }

  async loadFavoritesAlbum() {
    this.renderAlbumTitle('‚≠ê‚≠ê‚≠ê –ò–ó–ë–†–ê–ù–ù–û–ï ‚≠ê‚≠ê‚≠ê', 'fav');

    const coverWrap = document.getElementById('cover-wrap');
    if (coverWrap) coverWrap.style.display = 'none';

    if (window.buildFavoritesRefsModel) {
      await window.buildFavoritesRefsModel();
    }

    const model = Array.isArray(window.favoritesRefsModel) ? window.favoritesRefsModel : [];
    const container = document.getElementById('track-list');
    if (!container) return;

    if (model.length === 0) {
      container.innerHTML = `
        <div style="padding: 20px; text-align: center; color: #8ab8fd;">
          <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏</h3>
          <p>–û—Ç–º–µ—Ç—å—Ç–µ —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π ‚≠ê</p>
        </div>
      `;
      return;
    }

    // ‚úÖ –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π: –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫.
    // –ò –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ favorites:changed –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏.
    if (!this.__favoritesDelegationBound) {
      this.__favoritesDelegationBound = true;

      container.addEventListener('click', async (e) => {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª
        if (this.currentAlbum !== window.SPECIAL_FAVORITES_KEY) return;

        const target = e.target;
        const row = target?.closest?.('.track');
        if (!row || !container.contains(row)) return;

        const idx = Number.parseInt(String(row.dataset.index || ''), 10);
        if (!Number.isFinite(idx) || idx < 0) return;

        const m = Array.isArray(window.favoritesRefsModel) ? window.favoritesRefsModel : [];
        const item = m[idx];
        if (!item) return;

        // –ö–ª–∏–∫ –ø–æ –∑–≤–µ–∑–¥–µ
        if (target && target.classList && target.classList.contains('like-star')) {
          e.preventDefault();
          e.stopPropagation();

          const uid = String(item.__uid || '').trim();
          const albumKey = String(item.__a || '').trim();
          if (!uid || !albumKey) return;

          if (window.FavoritesManager && typeof window.FavoritesManager.toggleLike === 'function') {
            window.FavoritesManager.toggleLike(
              albumKey,
              uid,
              !item.__active,
              { source: 'favorites' }
            );
          }
          return;
        }

        // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ
        if (item.__active && item.audio) {
          await this.ensureFavoritesPlayback(idx);
          return;
        }

        // –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: –º–æ–¥–∞–ª–∫–∞ "–≤–µ—Ä–Ω—É—Ç—å/—É–¥–∞–ª–∏—Ç—å"
        if (window.FavoritesData && typeof window.FavoritesData.showFavoritesInactiveModal === 'function') {
          window.FavoritesData.showFavoritesInactiveModal({
            albumKey: item.__a,
            uid: item.__uid,
            title: item.title || '–¢—Ä–µ–∫',
            onDeleted: async () => {
              // ‚úÖ –¢–µ–ø–µ—Ä—å —Å—Ç—Ä–æ–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è realtime —á–µ—Ä–µ–∑ favorites:refsChanged (–±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ reload —Å–ø–∏—Å–∫–∞).
              window.PlayerUI?.updateAvailableTracksForPlayback?.();
            }
          });
          return;
        }

        window.NotificationSystem?.warning('–¢—Ä–µ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
      });

      // ‚úÖ Realtime —Ç–æ—á–µ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ DOM —Å—Ç—Ä–æ–∫–∏ (–∏ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª)
      window.addEventListener('favorites:changed', (ev) => {
        if (this.currentAlbum !== window.SPECIAL_FAVORITES_KEY) return;

        const d = ev?.detail || {};
        const albumKey = String(d.albumKey || '').trim();
        const uid = String(d.uid || '').trim();
        const liked = !!d.liked;

        if (!albumKey || !uid) return;

        const id = `fav_${albumKey}_${uid}`;
        const row = document.getElementById(id);
        if (!row) return;

        // –û–±–Ω–æ–≤–∏–º –º–æ–¥–µ–ª—å (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ) ‚Äî —á—Ç–æ–±—ã item.__active —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª UI
        try {
          window.FavoritesData?.updateFavoritesRefsModelActiveFlag?.(albumKey, uid, liked);
        } catch {}

        // UI: active/inactive
        row.classList.toggle('inactive', !liked);

        // UI: –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–≤–µ–∑–¥—ã
        const star = row.querySelector('.like-star');
        if (star) {
          star.src = liked ? 'img/star.png' : 'img/star2.png';
        }

        // –ü–ª–µ–µ—Ä/–æ—á–µ—Ä–µ–¥—å –Ω–µ —Ç—Ä–æ–≥–∞–µ–º (–±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —Å–æ–±–ª—é–¥–∞–µ–º)
      });

      // ‚úÖ Realtime: refsChanged ‚Äî —Ç–æ—á–µ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞
      window.addEventListener('favorites:refsChanged', (ev) => {
        if (this.currentAlbum !== window.SPECIAL_FAVORITES_KEY) return;

        const d = ev?.detail || {};
        const albumKey = String(d.albumKey || '').trim();
        const uid = String(d.uid || '').trim();
        const action = String(d.action || '').trim();

        if (!albumKey || !uid) return;

        if (action === 'refRemoved') {
          const id = `fav_${albumKey}_${uid}`;
          const row = document.getElementById(id);
          if (row) row.remove();

          // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–ª –ø—É—Å—Ç—ã–º ‚Äî –ø–æ–∫–∞–∂–µ–º empty state (–±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ loadFavoritesAlbum)
          try {
            const left = container.querySelectorAll('.track').length;
            if (left === 0) {
              container.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #8ab8fd;">
                  <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏</h3>
                  <p>–û—Ç–º–µ—Ç—å—Ç–µ —Ç—Ä–µ–∫–∏ –∑–≤—ë–∑–¥–æ—á–∫–æ–π ‚≠ê</p>
                </div>
              `;
            }
          } catch {}
        }
      });
    }

    // ‚úÖ –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π (–±—ã—Å—Ç—Ä–µ–µ –∏ –∫–æ—Ä–æ—á–µ)
    const esc = (s) => (window.Utils?.escapeHtml ? window.Utils.escapeHtml(String(s || '')) : String(s || ''));
    container.innerHTML = model.map((item, index) => {
      const displayNum = String(index + 1).padStart(2, '0');
      const isActive = !!item.__active;
      const albumTitle = item.__album || '–ê–ª—å–±–æ–º';
      const trackTitle = item.title || '–¢—Ä–µ–∫';
      const a = String(item.__a || '');
      const u = String(item.__uid || '');
      return `
        <div class="track${isActive ? '' : ' inactive'}"
             id="fav_${esc(a)}_${esc(u)}"
             data-index="${index}"
             data-album="${esc(a)}"
             data-uid="${esc(u)}">
          <div class="tnum">${displayNum}.</div>
          <div class="track-title" title="${esc(trackTitle)} - ${esc(albumTitle)}">
            <span class="fav-track-name">${esc(trackTitle)}</span>
            <span class="fav-album-name"> ‚Äî ${esc(albumTitle)}</span>
          </div>
          <img src="${isActive ? 'img/star.png' : 'img/star2.png'}"
               class="like-star"
               alt="–∑–≤–µ–∑–¥–∞"
               data-album="${esc(a)}"
               data-uid="${esc(u)}">
        </div>
      `;
    }).join('');
  }
  // cleanupUnavailableFavorites —É–¥–∞–ª—ë–Ω –ø–æ –¥–∏–∑–∞–π–Ω—É:
  // —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ "–ò–ó–ë–†–ê–ù–ù–û–ï" –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.

  async ensureFavoritesPlayback(index) {
    const model = Array.isArray(window.favoritesRefsModel) ? window.favoritesRefsModel : [];

    if (!model.length) {
      window.NotificationSystem?.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');
      return;
    }

    // ‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ‚Äî —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å –∞—É–¥–∏–æ
    const activeItems = model.filter(item => item && item.__active && item.audio);

    if (!activeItems.length) {
      window.NotificationSystem?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');
      return;
    }

    // –ò–Ω–¥–µ–∫—Å –∫–ª–∏–∫–∞ –≤ UI (model index) –Ω–∞–¥–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ –∏–Ω–¥–µ–∫—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    const clicked = model[index];
    let startIndex = 0;

    if (clicked && clicked.__active && clicked.audio) {
      const uid = String(clicked.__uid || '').trim();
      const idxInActive = activeItems.findIndex(it => String(it.__uid || '').trim() === uid && String(it.__a || '').trim() === String(clicked.__a || '').trim());
      startIndex = idxInActive >= 0 ? idxInActive : 0;
    } else {
      startIndex = 0;
    }

    const tracks = activeItems.map(item => ({
      src: item.audio,
      title: item.title,
      artist: item.__artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      album: window.SPECIAL_FAVORITES_KEY || '__favorites__',
      cover: item.__cover || 'img/logo.png',
      lyrics: item.lyrics || null,
      fulltext: item.fulltext || null,
      uid: (typeof item.__uid === 'string' && item.__uid.trim()) ? item.__uid.trim() : null,

      // ‚úÖ –í–ê–ñ–ù–û: –∏—Å—Ö–æ–¥–Ω—ã–π –∞–ª—å–±–æ–º —Ç—Ä–µ–∫–∞ (–¥–ª—è –ª–∞–π–∫–∞/–º–∏–Ω–∏-–∑–≤–µ–∑–¥—ã)
      sourceAlbum: item.__a
    }));

    if (!tracks.length) {
      window.NotificationSystem?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');
      return;
    }

    if (window.playerCore) {
      // –í—Å–µ–≥–¥–∞ —Å—Ç–∞–≤–∏–º –ø–ª–µ–π–ª–∏—Å—Ç "–∞–∫—Ç–∏–≤–Ω—ã—Ö" (–∏–Ω–∞—á–µ next/prev –±—É–¥—É—Ç –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ)
      window.playerCore.setPlaylist(tracks, startIndex, {
        artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
        cover: 'img/logo.png'
      });

      window.playerCore.play(startIndex);

      this.setPlayingAlbum(window.SPECIAL_FAVORITES_KEY || '__favorites__');

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ UI: –ø–æ–¥—Å–≤–µ—Ç–∏–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É (–≤ model), –∞ –Ω–µ –∏–Ω–¥–µ–∫—Å –ø–ª–µ–π–ª–∏—Å—Ç–∞.
      // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–∞–∂–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –æ–Ω –Ω–∞–∂–∞–ª.
      this.highlightCurrentTrack(index);
      window.PlayerUI?.ensurePlayerBlock(index, { userInitiated: true });

      // ‚úÖ –í–ê–ñ–ù–û: –æ–±–Ω–æ–≤–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã ‚Äî —Ç–µ–ø–µ—Ä—å –ø–ª–µ–π–ª–∏—Å—Ç —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å null.
      if (window.PlayerUI && typeof window.PlayerUI.updateAvailableTracksForPlayback === 'function') {
        window.PlayerUI.updateAvailableTracksForPlayback();
      }
    }
  }

  async loadNewsAlbum() {
    this.renderAlbumTitle('üì∞ –ù–û–í–û–°–¢–ò üì∞', 'news');

    // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –¥–ª—è __reliz__
    await this.loadGallery('__reliz__');

    const coverWrap = document.getElementById('cover-wrap');
    if (coverWrap) coverWrap.style.display = '';

    const container = document.getElementById('track-list');
    if (!container) return;

    container.innerHTML = `
      <div style="padding: 14px 10px; text-align: center; color: #8ab8fd;">
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom: 12px;">
          <a href="https://t.me/vitrina_razbita" target="_blank"
             style="color: #4daaff; text-decoration: underline;">
            Telegram –∫–∞–Ω–∞–ª
          </a>
          <span style="opacity:.6;">¬∑</span>
          <a href="./news.html" target="_blank"
             style="color: #4daaff; text-decoration: underline;">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
          </a>
        </div>
        <div id="news-inline-status" style="opacity:.85;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div id="news-inline-list" style="display:grid; gap:12px; padding: 0 0 10px 0;"></div>
    `;

    try {
      const r = await fetch('./news/news.json', { cache: 'no-cache' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const j = await r.json();
      const items = Array.isArray(j?.items) ? j.items : [];

      const status = document.getElementById('news-inline-status');
      const list = document.getElementById('news-inline-list');

      if (!list) return;

      if (!items.length) {
        if (status) status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
        return;
      }

      if (status) status.style.display = 'none';

      const esc = (s) => String(s || '').replace(/[<>&'"]/g, m => ({
        '<': '&lt;', '>': '&gt;', '&': '&amp;', "'": '&#39;', '"': '&quot;'
      }[m]));

      const renderCard = (it) => {
        const title = esc(it.title || '–ù–æ–≤–æ—Å—Ç—å');
        const date = esc(it.date || '');
        const text = esc(it.text || '');
        const tags = Array.isArray(it.tags) ? it.tags : [];

        let media = '';
        if (it.embedUrl) {
          media = `<div style="margin: 10px 0;">
            <iframe loading="lazy"
              style="width:100%; border:0; border-radius:10px; min-height:220px; background:#0b0e15;"
              src="${esc(it.embedUrl)}"
              allowfullscreen></iframe>
          </div>`;
        } else if (it.image) {
          media = `<div style="margin: 10px 0;">
            <img loading="lazy"
              style="width:100%; border:0; border-radius:10px; background:#0b0e15;"
              src="${esc(it.image)}" alt="">
          </div>`;
        } else if (it.video) {
          media = `<div style="margin: 10px 0;">
            <video controls preload="metadata"
              style="width:100%; border:0; border-radius:10px; min-height:220px; background:#0b0e15;"
              src="${esc(it.video)}"></video>
          </div>`;
        }

        const tagHtml = tags.length
          ? `<div style="margin-top: 8px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center;">
              ${tags.map(t => `<span style="font-size:12px; color:#4daaff; background: rgba(77,170,255,.12); border: 1px solid rgba(77,170,255,.25); padding:4px 8px; border-radius:999px;">#${esc(t)}</span>`).join('')}
            </div>`
          : '';

        return `<article style="
          background: #131a26;
          border: 1px solid #23324a;
          border-radius: 12px;
          padding: 12px;
          box-shadow: 0 4px 16px rgba(0,0,0,.25);
        ">
          <div style="font-weight: 900; font-size: 16px; color:#eaf2ff;">${title}</div>
          ${date ? `<div style="color:#9db7dd; font-size: 13px; margin-top: 6px;">${date}</div>` : ''}
          ${media}
          ${text ? `<div style="margin-top: 8px; line-height: 1.45; color:#eaf2ff;">${text}</div>` : ''}
          ${tagHtml}
        </article>`;
      };

      list.innerHTML = items.map(renderCard).join('');
    } catch (e) {
      const status = document.getElementById('news-inline-status');
      if (status) {
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
        status.style.color = '#ff6b6b';
      }
    }
  }

  renderAlbumTitle(title, modifier = '') {
    const titleEl = document.getElementById('active-album-title');
    if (titleEl) {
      titleEl.textContent = title;
      titleEl.className = 'active-album-title';
      if (modifier) titleEl.classList.add(modifier);
    }
  }

  // renderCover —É–¥–∞–ª—ë–Ω: –∏—Å—Ç–æ—á–Ω–∏–∫ –æ–±–ª–æ–∂–µ–∫ ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è (GalleryManager).

  renderSocials(links) {
    const container = document.getElementById('social-links');
    if (!container) return;

    container.innerHTML = '';
    
    const normalized = Array.isArray(links) 
      ? links.map(link => ({
          label: link.label || link.title || '–°—Å—ã–ª–∫–∞',
          url: link.url
        }))
      : [];

    if (normalized.length === 0) return;

    normalized.forEach(link => {
      const a = document.createElement('a');
      a.href = link.url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = link.label;
      container.appendChild(a);
    });
  }

  renderTrackList(tracks, albumInfo) {
    const container = document.getElementById('track-list');
    if (!container) return;

    container.innerHTML = '';

    tracks.forEach((track, index) => {
      const trackEl = this.createTrackElement(track, albumInfo.key, index);
      container.appendChild(trackEl);
    });
  }

  createTrackElement(track, albumKey, index) {
    const trackEl = document.createElement('div');
    trackEl.className = 'track';
    trackEl.id = `trk${index}`;
    trackEl.dataset.index = index;
    trackEl.dataset.album = albumKey;

    // ‚úÖ –í–∞–∂–Ω–æ –¥–ª—è OFFLINE –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: uid –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Å—Ç—Ä–æ–∫–µ, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –∑–≤–µ–∑–¥–µ.
    if (track && typeof track.uid === 'string' && track.uid.trim()) {
      trackEl.dataset.uid = track.uid.trim();
    } else {
      trackEl.dataset.uid = '';
    }

    // ‚úÖ –ò–Ω–¥–µ–∫—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ playlist (–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ file).
    // –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞, –µ—Å–ª–∏ –≤ –∞–ª—å–±–æ–º–µ –ø–æ—è–≤—è—Ç—Å—è —Ç—Ä–µ–∫–∏ –±–µ–∑ audio/file.
    const albumDataForIndex = this.albumsData.get(albumKey);
    if (albumDataForIndex && Array.isArray(albumDataForIndex.tracks)) {
      const playable = albumDataForIndex.tracks.filter(t => !!t && !!t.file);
      const idxInPlayable = playable.findIndex(t => t && t.uid && track.uid && String(t.uid) === String(track.uid));
      if (idxInPlayable >= 0) {
        trackEl.dataset.playIndex = String(idxInPlayable);
      } else {
        // fallback: –µ—Å–ª–∏ uid –Ω–µ—Ç/–Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º UI index (–ª—É—á—à–µ —á–µ–º –Ω–∏—á–µ–≥–æ)
        trackEl.dataset.playIndex = String(index);
      }
    } else {
      trackEl.dataset.playIndex = String(index);
    }

    const isFavorite = window.FavoritesManager
      ? window.FavoritesManager.isFavorite(albumKey, track.uid)
      : false;

    const numText = `${String(track.num || (index + 1)).padStart(2, '0')}.`;

    trackEl.innerHTML = `
      <div class="tnum">${numText}</div>
      <div class="track-title">${track.title}</div>
      <img src="${isFavorite ? 'img/star.png' : 'img/star2.png'}" 
           class="like-star" 
           alt="–∑–≤–µ–∑–¥–∞"
           data-album="${albumKey}" 
           data-uid="${track.uid || ''}">
    `;

    trackEl.addEventListener('click', (e) => {
      if (e.target.classList.contains('like-star')) return;

      const albumData = this.albumsData.get(albumKey);
      if (!albumData || !window.playerCore) {
        this.highlightCurrentTrack(index);
        window.NotificationSystem?.error('–ê–ª—å–±–æ–º –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é');
        return;
      }

      const snapshot = window.playerCore.getPlaylistSnapshot?.() || [];
      const needsNewPlaylist =
        snapshot.length !== albumData.tracks.length ||
        snapshot.some((t, i) => {
          const ad = albumData.tracks[i];
          return !ad || !ad.file || t.src !== ad.file;
        });

      const playIndex = (() => {
        const raw = trackEl.dataset.playIndex;
        const n = Number.parseInt(String(raw || ''), 10);
        return Number.isFinite(n) && n >= 0 ? n : index;
      })();

      if (needsNewPlaylist) {
        const coverUrl = this.albumCoverUrlCache.get(albumKey) || 'img/logo.png';

        const tracksForCore = albumData.tracks
          .filter(t => !!t && (!!t.fileHi || !!t.file || !!t.fileLo))
          .map((t) => ({
            // legacy fallback: –µ—Å–ª–∏ sources –Ω–µ—Ç, src –≤–æ–∑—å–º—ë–º –∏–∑ Hi (–∏–ª–∏ –∏–∑ file)
            src: t.fileHi || t.file || t.fileLo,
            sources: t.sources || null,

            title: t.title,
            artist: albumData.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
            album: albumKey,
            cover: coverUrl,
            lyrics: t.lyrics || null,
            fulltext: t.fulltext || null,
            uid: (typeof t.uid === 'string' && t.uid.trim()) ? t.uid.trim() : null,
            hasLyrics: t.hasLyrics // ‚úÖ –ü–µ—Ä–µ–¥–∞—ë–º —Ñ–ª–∞–≥ –≤ PlayerCore
          }));

        if (tracksForCore.length > 0) {
          window.playerCore.setPlaylist(tracksForCore, playIndex, {
            artist: albumData.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
            album: albumData.title || albumInfo?.title || '',
            cover: coverUrl,
          });
        }
      }

      this.highlightCurrentTrack(index);

      window.playerCore.play(playIndex);
      this.setPlayingAlbum(albumKey);

      // ensurePlayerBlock –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ UI (—á—Ç–æ–±—ã –≤—Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫ –ø–æ–¥ –Ω–µ—ë)
      window.PlayerUI?.ensurePlayerBlock(index, { userInitiated: true });
    });

    const star = trackEl.querySelector('.like-star');
    star?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();

      const trackUid = String(star.dataset.uid || '').trim();
      if (!trackUid) {
        window.NotificationSystem?.warning('UID —Ç—Ä–µ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ config.json');
        return;
      }

      if (!window.FavoritesManager || typeof window.FavoritesManager.toggleLike !== 'function') {
        window.NotificationSystem?.error('FavoritesManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        return;
      }

      const nextLiked = !window.FavoritesManager.isFavorite(albumKey, trackUid);

      // ‚úÖ 1) –ú–ì–ù–û–í–ï–ù–ù–´–ô UI (optimistic): —á—Ç–æ–±—ã –∑–≤–µ–∑–¥–∞ –∂–µ–ª—Ç–µ–ª–∞ —Å—Ä–∞–∑—É
      star.src = nextLiked ? 'img/star.png' : 'img/star2.png';
      star.classList.add('animating');
      setTimeout(() => star.classList.remove('animating'), 320);

      // ‚úÖ 2) –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (storage + —Å–æ–±—ã—Ç–∏—è)
      window.FavoritesManager.toggleLike(
        albumKey,
        trackUid,
        nextLiked,
        { source: 'album' }
      );
    });

    return trackEl;
  }

  highlightCurrentTrack(index) {
    document.querySelectorAll('.track.current').forEach(el => el.classList.remove('current'));
    
    // ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
    if (typeof index !== 'number' || index < 0 || !Number.isFinite(index)) {
      return;
    }
    
    const trackEl = document.querySelector(`.track[data-index="${index}"]`);
    if (trackEl) trackEl.classList.add('current');
  }

  updateActiveIcon(albumKey) {
    document.querySelectorAll('.album-icon').forEach(icon => {
      icon.classList.toggle('active', icon.dataset.album === albumKey);
    });
  }

  clearUI() {
    const trackList = document.getElementById('track-list');
    const socials = document.getElementById('social-links');

    if (trackList) trackList.innerHTML = '';
    if (socials) socials.innerHTML = '';
    
    if (window.GalleryManager) {
      window.GalleryManager.clear();
    }
  }

  getCurrentAlbum() {
    return this.currentAlbum;
  }

  getPlayingAlbum() {
    return this.playingAlbum;
  }

  setPlayingAlbum(albumKey) {
    this.playingAlbum = albumKey || null;
  }

  getAlbumData(albumKey) {
    return this.albumsData.get(albumKey);
  }

  getAlbumConfigByKey(albumKey) {
    return this.albumsData.get(albumKey);
  }
  getTrackUid(albumKey, trackUid) {
    // ‚úÖ Back-compat: —Ç–µ–ø–µ—Ä—å uid –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ config.json (—Å—Ç—Ä–æ–∫–∞).
    // albumKey –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤—ã–∑–æ–≤–æ–≤, –Ω–æ —Å–∞–º uid –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º.
    const uid = String(trackUid || '').trim();
    return uid || null;
  }
}

window.AlbumsManager = new AlbumsManager();

export default AlbumsManager;

//=================================================
// FILE: /scripts/app/background-audio.js
// scripts/app/background-audio.js
// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
class BackgroundAudioManager {
  constructor() {
    this.isSupported = 'mediaSession' in navigator;
    this.audioContext = null;
    this.init();
  }
  
  init() {
    if (!this.isSupported) {
      console.warn('Media Session API not supported');
      return;
    }
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ mediaSession (action handlers) –¥–µ–ª–∞–µ—Ç —Ç–æ–ª—å–∫–æ PlayerCore.updateMediaSession.
    // –ó–¥–µ—Å—å –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –ø–ª–µ–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ/–ø–æ–∑–∏—Ü–∏—é.
    this.attachPlayerEvents();
    console.log('‚úÖ Background audio initialized');
    
    // iOS —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞
    this.setupIOSBackgroundAudio();
  }
  
  attachPlayerEvents() {
    if (!window.playerCore) {
      setTimeout(() => this.attachPlayerEvents(), 500);
      return;
    }
    
    // –ó–¥–µ—Å—å ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏—è (setPositionState). –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ action handlers ‚Äî –≤ src/PlayerCore.js.
    window.playerCore.on({
      onTick: (position, duration) => {
        this.updatePositionState({ position, duration });
      }
    });
  }
  
  updatePositionState(data) {
    if (!this.isSupported) return;
    
    try {
      if ('setPositionState' in navigator.mediaSession) {
        navigator.mediaSession.setPositionState({
          duration: data.duration || 0,
          playbackRate: 1.0,
          position: data.position || 0
        });
      }
    } catch (error) {
      console.error('Failed to update position state:', error);
    }
  }
  
  setupIOSBackgroundAudio() {
    // –î–ª—è iOS –≤ Standalone —Ä–µ–∂–∏–º–µ
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  
    if (!isIOS) return;
  
    console.log('üì± iOS detected - enabling background audio support');
  
    // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      console.log('‚úÖ AudioContext created for iOS background audio');
    
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      const unlockAudio = () => {
        if (this.audioContext.state === 'suspended') {
          this.audioContext.resume().then(() => {
            console.log('üîä iOS Audio Context resumed');
          });
        }
        document.removeEventListener('touchstart', unlockAudio);
        document.removeEventListener('touchend', unlockAudio);
      };
    
      document.addEventListener('touchstart', unlockAudio);
      document.addEventListener('touchend', unlockAudio);
    
    } catch (error) {
      console.warn('Failed to create AudioContext:', error);
    }
  
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && this.audioContext) {
        console.log('üì± iOS page visible - checking audio state');
        try {
          if (this.audioContext.state === 'suspended') {
            this.audioContext.resume().catch(e => console.warn('Resume failed:', e));
          }
        
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ Howler
          if (window.Howler && window.Howler.ctx && window.Howler.ctx.state === 'suspended') {
            window.Howler.ctx.resume().catch(e => console.warn('Howler resume failed:', e));
          }
        
          // –ï—Å–ª–∏ –ø–ª–µ–µ—Ä –¥–æ–ª–∂–µ–Ω –∏–≥—Ä–∞—Ç—å - –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º
          if (window.playerCore && window.playerCore.isPlaying && window.playerCore.isPlaying()) {
            const currentTrack = window.playerCore.getCurrentTrack();
            if (currentTrack) {
              console.log('üì± Resuming playback:', currentTrack.title);
            }
          }
        } catch (error) {
          console.error('Failed to resume after iOS background:', error);
        }
      }
    });
  
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è webkitendfullscreen (—Å—Ç–∞—Ä—ã–µ iOS)
    document.addEventListener('webkitendfullscreen', () => {
      console.log('üì± iOS webkitendfullscreen event');
      if (this.audioContext && this.audioContext.state === 'suspended') {
        this.audioContext.resume();
      }
    });
  }
  
  getAudioContext() {
    return this.audioContext;
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.BackgroundAudioManager = new BackgroundAudioManager();
  });
} else {
  window.BackgroundAudioManager = new BackgroundAudioManager();
}

//=================================================
// FILE: /scripts/app/background-events.js
// scripts/app/background-events.js
// ESM. –°–æ–±—ã—Ç–∏—è —Å–µ—Ç–∏/–≤–∏–¥–∏–º–æ—Å—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è UI.
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: import { onAppEvent } from './background-events.js';

const subs = new Map();
// —Ç–∏–ø—ã: 'net:online' | 'net:offline' | 'app:visible' | 'app:hidden'
function emit(type, payload) {
  (subs.get(type) || []).forEach(fn => { try { fn(payload); } catch {} });
}

export function onAppEvent(type, cb) {
  const arr = subs.get(type) || [];
  arr.push(cb);
  subs.set(type, arr);
  return () => {
    const a = subs.get(type) || [];
    subs.set(type, a.filter(f => f !== cb));
  };
}

// network
window.addEventListener('online', () => emit('net:online'));
window.addEventListener('offline', () => emit('net:offline'));

// visibility
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') emit('app:visible');
  else emit('app:hidden');
});

// —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
export const BackgroundEvents = { on: onAppEvent };

//=================================================
// FILE: /scripts/app/gallery.js
// scripts/app/gallery.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–µ–π –æ–±–ª–æ–∂–µ–∫

class GalleryManager {
  constructor() {
    this.items = [];
    this.currentIndex = 0;
    this.autoplayInterval = null;
    this.isAutoplayEnabled = false;
    this.transitionLock = false;
    
    this.prefetchedUrls = new Set();
    this.imageLoader = null;
    
    this.ALBUM_GALLERY_MAP = {
      'krevetochka': '00',
      'mezhdu-zlom-i-dobrom': '01',
      'golos-dushi': '02',
      'odnazhdy-v-skazke': '03',
      '__reliz__': 'news'
    };
    
    this.ALLOWED_IDS = new Set(['00', '01', '02', '03', 'news']);
    this.GALLERY_BASE = './albums/gallery/';
  }

  initialize() {
    this.setupNavigation();
    this.setupSwipeGestures();
    this.setupVisibilityHandler();
    console.log('‚úÖ GalleryManager initialized');
  }

  getCentralId(albumKey) {
    if (!albumKey || albumKey === '__favorites__') return null;
    const id = this.ALBUM_GALLERY_MAP[albumKey];
    return (id && this.ALLOWED_IDS.has(id)) ? id : null;
  }

  async loadGallery(albumKey) {
    const id = this.getCentralId(albumKey);
    
    if (!id) {
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
      return;
    }

    // ‚úÖ –ö—ç—à–∏—Ä—É–µ–º 404 –¥–ª—è –≥–∞–ª–µ—Ä–µ–π —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    const gallery404Key = `gallery_404_cache:v1`;
    let gallery404Cache = {};
    try {
      const raw = sessionStorage.getItem(gallery404Key);
      gallery404Cache = raw ? JSON.parse(raw) : {};
    } catch {}

    if (gallery404Cache[id]) {
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
      return;
    }

    try {
      const baseDir = `${this.GALLERY_BASE}${id}/`;
      const response = await fetch(`${baseDir}index.json`, { cache: 'force-cache' });
      
      if (!response.ok) {
        // ‚úÖ –ö—ç—à–∏—Ä—É–µ–º 404
        if (response.status === 404) {
          gallery404Cache[id] = Date.now();
          try { sessionStorage.setItem(gallery404Key, JSON.stringify(gallery404Cache)); } catch {}
        }
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      const rawItems = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);

      this.items = rawItems
        .map(item => this.normalizeItem(item, baseDir))
        .filter(Boolean);

      this.currentIndex = 0;
      
      if (this.items.length > 0) {
        this.renderItem(0);
        this.updateNavigationState();
        this.startAutoplay();
      }

      console.log(`‚úÖ Gallery loaded: ${this.items.length} items`);
    } catch (error) {
      // ‚úÖ –¢–∏—Ö–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏ (–Ω–µ –∑–∞—Å–æ—Ä—è–µ–º –∫–æ–Ω—Å–æ–ª—å)
      this.items = [];
      this.currentIndex = 0;
      this.updateNavigationState();
      
      // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º logo.png –∫–∞–∫ fallback
      const slot = document.getElementById('cover-slot');
      if (slot) {
        slot.innerHTML = `<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">`;
      }
    }
  }

  normalizeItem(raw, baseDir) {
    if (!raw) return null;

    const toAbs = (p) => {
      if (!p) return null;
      const s = String(p).replace(/^\.?\//, '');
      if (/^https?:\/\//i.test(s)) return s;
      if (/^(albums|img|icons|assets)\//i.test(s)) return `./${s}`;
      return baseDir + s;
    };

    if (typeof raw === 'string') {
      const isHtml = /\.html(\?|#|$)/i.test(raw);
      return {
        type: isHtml ? 'html' : 'img',
        src: toAbs(raw),
        formats: null
      };
    }

    const type = String(raw.type || '').toLowerCase() === 'html' ? 'html' : 'img';

    if (type === 'html') {
      return {
        type: 'html',
        src: toAbs(raw.src || ''),
        formats: null
      };
    }

    const formats = {
      webp: toAbs(raw.formats?.webp || null),
      full: toAbs(raw.formats?.full || raw.src || null),
      thumb: toAbs(raw.formats?.thumb || null)
    };

    return {
      type: 'img',
      src: formats.full || toAbs(raw.src || ''),
      formats
    };
  }

  renderItem(index) {
    if (this.transitionLock) return;
    if (!this.items.length) return;

    this.transitionLock = true;
    this.currentIndex = (index + this.items.length) % this.items.length;

    const item = this.items[this.currentIndex];
    const slot = document.getElementById('cover-slot');
    
    if (!slot || !item) {
      this.transitionLock = false;
      return;
    }

    if (this.imageLoader) {
      this.imageLoader.onload = null;
      this.imageLoader.onerror = null;
      this.imageLoader = null;
    }

    if (item.type === 'html') {
      this.renderHtml(slot, item.src);
    } else {
      this.renderImage(slot, item);
    }

    setTimeout(() => {
      this.prefetchNext();
      this.transitionLock = false;
    }, 200);
  }

  renderHtml(slot, src) {
    const iframe = document.createElement('iframe');
    
    // ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ html-–±–∞–Ω–Ω–µ—Ä—ã (albums/gallery/...) –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ.
    // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞) –Ω—É–∂–µ–Ω allow-same-origin.
    // ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º security-–æ—à–∏–±–∫–∏ –æ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –±–∞–Ω–Ω–µ—Ä–∞:
    // –Ω–µ –¥–∞—ë–º outer-iframe same-origin.
    iframe.setAttribute('sandbox', 'allow-scripts allow-popups allow-forms');
    iframe.setAttribute('referrerpolicy', 'no-referrer');
    iframe.loading = 'lazy';
    iframe.src = src;

    this.clearSlot(slot);
    slot.appendChild(iframe);
  }

  renderImage(slot, item) {
    const img = new Image();
    this.imageLoader = img;

    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';

    const src = item.formats?.webp || item.formats?.full || item.src;

    img.onload = () => {
      if (this.imageLoader !== img) return;

      const picture = document.createElement('picture');

      if (item.formats?.webp) {
        const source = document.createElement('source');
        source.type = 'image/webp';
        source.srcset = item.formats.webp;
        picture.appendChild(source);
      }

      const displayImg = document.createElement('img');
      displayImg.src = src;
      displayImg.alt = '–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞';
      displayImg.decoding = 'async';
      displayImg.referrerPolicy = 'no-referrer';
      displayImg.style.cssText = 'opacity: 0; transition: opacity .15s ease-out';

      picture.appendChild(displayImg);

      this.clearSlot(slot);
      slot.appendChild(picture);

      requestAnimationFrame(() => {
        displayImg.style.opacity = '1';
      });
    };

    img.onerror = () => console.warn('Failed to load image:', src);
    img.src = src;
  }

  clearSlot(slot) {
    while (slot.firstChild) {
      if (slot.firstChild.tagName === 'IFRAME') {
        slot.firstChild.src = 'about:blank';
      }
      slot.removeChild(slot.firstChild);
    }
  }

  prefetchNext() {
    if (this.items.length < 2) return;

    const nextIndex = (this.currentIndex + 1) % this.items.length;
    const item = this.items[nextIndex];

    if (!item || item.type !== 'img') return;

    const webp = item.formats?.webp || null;

    if (this.prefetchedUrls.size > 20) this.prefetchedUrls.clear();

    if (webp && !this.prefetchedUrls.has(webp)) {
      const img = new Image();
      img.src = webp;
      this.prefetchedUrls.add(webp);
    }
  }

  setupNavigation() {
    const leftBtn = document.getElementById('cover-gallery-arrow-left');
    const rightBtn = document.getElementById('cover-gallery-arrow-right');

    leftBtn?.addEventListener('click', () => {
      if (!this.items.length) return;
      this.renderItem(this.currentIndex - 1);
      this.restartAutoplay();
    });

    rightBtn?.addEventListener('click', () => {
      if (!this.items.length) return;
      this.renderItem(this.currentIndex + 1);
      this.restartAutoplay();
    });
  }

  setupSwipeGestures() {
    const wrap = document.getElementById('cover-wrap');
    if (!wrap) return;

    let startX = null;

    wrap.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
    }, { passive: true });

    wrap.addEventListener('touchend', (e) => {
      if (startX === null) return;

      const dx = e.changedTouches[0].clientX - startX;

      if (Math.abs(dx) > 50) {
        if (dx > 0) {
          this.renderItem(this.currentIndex - 1);
        } else {
          this.renderItem(this.currentIndex + 1);
        }
        this.restartAutoplay();
      }

      startX = null;
    }, { passive: true });
  }

  setupVisibilityHandler() {
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // ‚úÖ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≥–∞–ª–µ—Ä–µ—é (–ø–ª–µ–µ—Ä –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
        this.stopAutoplay();
      } else {
        // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –∫—Ä—É—Ç–∏—Ç—å
        if (this.items.length > 1) {
          this.startAutoplay();
        }
      }
    });
  }

  updateNavigationState() {
    const wrap = document.getElementById('cover-wrap');
    if (!wrap) return;

    if (this.items.length > 1) {
      wrap.classList.add('gallery-nav-ready');
    } else {
      wrap.classList.remove('gallery-nav-ready');
    }
  }

  startAutoplay() {
    if (this.items.length <= 1) return;
    if (this.autoplayInterval) return;

    this.autoplayInterval = setInterval(() => {
      this.renderItem(this.currentIndex + 1);
    }, 5000);

    this.isAutoplayEnabled = true;
  }

  stopAutoplay() {
    if (this.autoplayInterval) {
      clearInterval(this.autoplayInterval);
      this.autoplayInterval = null;
    }
    this.isAutoplayEnabled = false;
  }

  restartAutoplay() {
    this.stopAutoplay();
    this.startAutoplay();
  }

  clear() {
    this.stopAutoplay();
    this.items = [];
    this.currentIndex = 0;
    this.prefetchedUrls.clear();
    
    if (this.imageLoader) {
      this.imageLoader.onload = null;
      this.imageLoader.onerror = null;
      this.imageLoader = null;
    }

    const slot = document.getElementById('cover-slot');
    if (slot) this.clearSlot(slot);

    this.updateNavigationState();
  }

  getItemsCount() {
    return this.items.length;
  }

  getCurrentIndex() {
    return this.currentIndex;
  }

  /**
   * ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –ø–µ—Ä–≤–æ–π –æ–±–ª–æ–∂–∫–∏ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏ –¥–ª—è albumKey
   * (webp –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ), –ª–∏–±–æ img/logo.png.
   * –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
   */
  async getFirstCoverUrl(albumKey) {
    const id = this.getCentralId(albumKey);
    if (!id) return 'img/logo.png';

    const baseDir = `${this.GALLERY_BASE}${id}/`;

    try {
      const response = await fetch(`${baseDir}index.json`, { cache: 'force-cache' });
      if (!response.ok) return 'img/logo.png';

      const data = await response.json();
      const rawItems = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
      const first = rawItems && rawItems.length ? rawItems[0] : null;
      if (!first) return 'img/logo.png';

      const norm = this.normalizeItem(first, baseDir);
      if (!norm || norm.type !== 'img') return 'img/logo.png';

      return norm.formats?.webp || norm.formats?.full || norm.src || 'img/logo.png';
    } catch {
      return 'img/logo.png';
    }
  }
}

window.GalleryManager = new GalleryManager();

export default GalleryManager;

//=================================================
// FILE: /scripts/app/navigation.js
// scripts/app/navigation.js
// –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

class NavigationManager {
  constructor() {
    this.activeModal = null;
  }

  initialize() {
    this.setupEventListeners();
    console.log('‚úÖ NavigationManager initialized');
  }

  setupEventListeners() {
    const feedbackLink = document.getElementById('feedback-link');
    feedbackLink?.addEventListener('click', () => this.showFeedbackModal());

    const supportLink = document.getElementById('support-link');
    if (supportLink) {
      supportLink.href = window.APP_CONFIG?.SUPPORT_URL || 'https://example.com/support';
    }

    const hotkeysBtn = document.getElementById('hotkeys-btn');
    hotkeysBtn?.addEventListener('click', () => this.showHotkeysModal());
  }

  showFeedbackModal() {
    this.closeModal();

    if (!window.Modals?.open) return;

    this.activeModal = window.Modals.open({
      title: '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å',
      maxWidth: 420,
      bodyHtml: `
        <p style="margin-bottom:20px; color:#8ab8fd; text-align:center;">
          –ï—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –Ω–∞—à–ª–∏ –æ—à–∏–±–∫—É?<br>–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º!
        </p>
        <div style="display:flex; flex-direction:column; gap:15px; max-width:300px; margin:0 auto;">
          <a href="https://t.me/vitrina_razbita" target="_blank"
             style="background:#0088cc; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            Telegram
          </a>
          <a href="mailto:${window.APP_CONFIG?.SUPPORT_EMAIL || 'support@vitrina-razbita.ru'}" target="_blank"
             style="background:#4daaff; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            Email
          </a>
          <a href="${window.APP_CONFIG?.GITHUB_URL || 'https://github.com/apel-s-in/vi3na1bita-music'}" target="_blank"
             style="background:#333; color:#fff; padding:15px; border-radius:8px; text-decoration:none; text-align:center;">
            GitHub
          </a>
        </div>
      `
    });
  }

  showHotkeysModal() {
    this.closeModal();

    if (!window.Modals?.open) return;

    this.activeModal = window.Modals.open({
      title: '–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏',
      maxWidth: 520,
      bodyHtml: `
        <div class="hotkeys-section">
          <h3 style="color:#8ab8fd; margin-bottom:12px;">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
          <div class="hotkey-item"><span class="hotkey-combo">K / –ü—Ä–æ–±–µ–ª</span><span class="hotkey-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">X</span><span class="hotkey-desc">–°—Ç–æ–ø</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">N / P</span><span class="hotkey-desc">–°–ª–µ–¥—É—é—â–∏–π/–ü—Ä–µ–¥—ã–¥—É—â–∏–π</span></div>
        </div>
        <div class="hotkeys-section">
          <h3 style="color:#8ab8fd; margin-bottom:12px;">–†–µ–∂–∏–º—ã</h3>
          <div class="hotkey-item"><span class="hotkey-combo">R</span><span class="hotkey-desc">–ü–æ–≤—Ç–æ—Ä</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">U</span><span class="hotkey-desc">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">F</span><span class="hotkey-desc">–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ</span></div>
          <div class="hotkey-item"><span class="hotkey-combo">T</span><span class="hotkey-desc">–¢–∞–π–º–µ—Ä —Å–Ω–∞</span></div>
        </div>
      `
    });
  }

  closeModal() {
    if (!this.activeModal) return;
    try { this.activeModal.remove(); } catch {}
    this.activeModal = null;
  }
}

window.NavigationManager = new NavigationManager();

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    try { window.NavigationManager.initialize(); } catch (e) { console.warn('NavigationManager init failed:', e); }
  });
} else {
  try { window.NavigationManager.initialize(); } catch (e) { console.warn('NavigationManager init failed:', e); }
}

export default NavigationManager;

//=================================================
// FILE: /scripts/app/network-manager.js
// scripts/app/network-manager.js
(function () {
  function safeGetConnection() {
    return navigator.connection || navigator.mozConnection || navigator.webkitConnection || null;
  }

  function normalizeType(connection) {
    // Network Information API:
    // - effectiveType: 'slow-2g'|'2g'|'3g'|'4g'
    // - type: 'wifi'|'cellular'|...
    if (!connection) return { kind: 'unknown', raw: null };

    const type = connection.type;
    const effectiveType = connection.effectiveType;

    if (type === 'wifi') return { kind: 'wifi', raw: { type, effectiveType } };
    if (type === 'cellular') return { kind: 'cellular', raw: { type, effectiveType } };

    // iOS Safari —á–∞—â–µ –≤—Å–µ–≥–æ –Ω–µ –¥–∞—ë—Ç connection ‚Äî –±—É–¥–µ—Ç unknown
    // –ù–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö Android/Chromium type –º–æ–∂–µ—Ç –±—ã—Ç—å undefined, –Ω–æ effectiveType –µ—Å—Ç—å
    if (effectiveType) {
      // —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ "cellular-ish" (–ø–æ—Ç–æ–º—É —á—Ç–æ effectiveType –æ–±—ã—á–Ω–æ –¥–∞—ë—Ç —Ä–∞–¥–∏–æ-–æ—Ü–µ–Ω–∫—É)
      return { kind: 'cellular', raw: { type, effectiveType } };
    }

    return { kind: 'unknown', raw: { type, effectiveType } };
  }

  function getStatus() {
    const online = navigator.onLine !== false; // –µ—Å–ª–∏ undefined ‚Äî —Å—á–∏—Ç–∞–µ–º online (iOS quirks)
    const conn = safeGetConnection();
    const net = normalizeType(conn);
    return {
      online,
      kind: net.kind, // 'wifi'|'cellular'|'unknown'
      raw: net.raw,
      saveData: !!(conn && conn.saveData),
    };
  }

  const listeners = new Set();

  function emit() {
    const st = getStatus();
    listeners.forEach((fn) => {
      try { fn(st); } catch (_) {}
    });
  }

  function subscribe(fn) {
    listeners.add(fn);
    // instant fire
    try { fn(getStatus()); } catch (_) {}
    return () => listeners.delete(fn);
  }

  window.addEventListener('online', emit);
  window.addEventListener('offline', emit);

  const conn = safeGetConnection();
  if (conn && typeof conn.addEventListener === 'function') {
    conn.addEventListener('change', emit);
  } else if (conn && ('onchange' in conn)) {
    conn.onchange = emit;
  }

  window.NetworkManager = {
    getStatus,
    subscribe,
  };
})();

//=================================================
// FILE: /scripts/app/offline-ui-bootstrap.js
// scripts/app/offline-ui-bootstrap.js
// –ï–¥–∏–Ω–∞—è offline-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ (ESM).
// –ü–æ –¢–ó_–ù—å—é: –∫–Ω–æ–ø–∫–∞ OFFLINE –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É, toggle —É–±—Ä–∞–Ω.
// –ù–ï —Ç—Ä–æ–≥–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç I1).

import { OfflineManager } from '../offline/offline-manager.js';
import { openOfflineModal } from '../ui/offline-modal.js';

// ‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî window.OfflineUI.
if (!window.OfflineUI || typeof window.OfflineUI !== 'object') {
  window.OfflineUI = { offlineManager: null };
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
export const OfflineUI = window.OfflineUI;

const ALERT_KEY = 'offline:alert:v1';

function readAlert() {
  try {
    const raw = localStorage.getItem(ALERT_KEY);
    const j = raw ? JSON.parse(raw) : null;
    return !!j?.on;
  } catch {
    return false;
  }
}

function setOfflineBtnUI() {
  const btn = document.getElementById('offline-btn');
  if (!btn) return;

  const mgr = window.OfflineUI?.offlineManager;
  const isOffline = !!mgr?.isOfflineMode?.();

  // –ü–æ –¢–ó: –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–µ–∫—Å—Ç–æ–º ONLINE/OFFLINE.
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç OFFLINE, –∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏.
  btn.textContent = 'OFFLINE';

  // –ö–ª–∞—Å—Å—ã –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—é ‚Äú—Ä–µ–∂–∏–º–∞‚Äù (–Ω–µ —Ç–µ–∫—Å—Ç)
  btn.classList.toggle('offline', isOffline);
  btn.classList.toggle('online', !isOffline);

  // Badge "!" –ø–æ —Å–∏–≥–Ω–∞–ª—É alert
  btn.classList.toggle('alert', readAlert());
}

export function attachOfflineUI() {
  // –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –Ω–µ –¥–µ–ª–∞–µ–º –∑–∞–Ω–æ–≤–æ
  if (window.OfflineUI && window.OfflineUI.offlineManager) {
    // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º UI –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ DOM –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞–ª—Å—è
    setOfflineBtnUI();
    return;
  }

  // –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä
  const mgr = new OfflineManager();
  mgr.initialize();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç (–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)
  if (!window.OfflineUI) window.OfflineUI = {};
  window.OfflineUI.offlineManager = mgr;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞
  OfflineUI.offlineManager = mgr;

  const btn = document.getElementById('offline-btn');
  if (btn && !btn.__offlineBound) {
    btn.__offlineBound = true;

    btn.addEventListener('click', async () => {
      // –í—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É (–ø–æ –¢–ó)
      try {
        await openOfflineModal();
      } catch (e) {
        window.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å OFFLINE –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
      } finally {
        setOfflineBtnUI();
      }
    });
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–æ–±—ã—Ç–∏—è–º
  window.addEventListener('offline:uiChanged', () => setOfflineBtnUI());

  // –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI
  setOfflineBtnUI();
}

//=================================================
// FILE: /scripts/app/playback-cache-bootstrap.js
// scripts/app/playback-cache-bootstrap.js
// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Playback Cache –æ–∫–Ω–∞ PREV/CUR/NEXT —Å PlayerCore.
// –ë–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–æ–∫ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å.

import { PlaybackCacheManager } from '../offline/playback-cache.js';
import { OfflineUI } from './offline-ui-bootstrap.js';
import { getTrackByUid } from './track-registry.js';

function getPQ() {
  try {
    const q = String(localStorage.getItem('qualityMode:v1') || 'hi').toLowerCase();
    return (q === 'lo') ? 'lo' : 'hi';
  } catch { return 'hi'; }
}

export function attachPlaybackCache() {
  const pc = window.playerCore;
  if (!pc) return;

  let lastIndex = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
  let lastLen = 0;
  let direction = 'forward';

  const getPlaylistCtx = () => {
    const list = (typeof pc.getPlaylistSnapshot === 'function') ? (pc.getPlaylistSnapshot() || []) : [];
    const cur = pc.getCurrentTrack?.() || null;
    const curUid = cur?.uid ? String(cur.uid) : null;
    lastLen = Array.isArray(list) ? list.length : 0;
    return {
      list,
      curUid,
      favoritesInactive: new Set(), // v1.0: –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π; –ø–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º —Ä–µ–∞–ª—å–Ω—ã–π inactive –∏–∑ __favorites__
      direction
    };
  };

  const queue = OfflineUI.offlineManager.queue;
  const pcm = new PlaybackCacheManager({
    queue,
    getPlaylistCtx
  });

  const trackProvider = (uid) => getTrackByUid(uid);

  async function planWindow() {
    const pq = getPQ();
    try { await pcm.ensureWindowFullyCached(pq, trackProvider); } catch {}
  }

  function updateDirectionByIndex(newIndex) {
    const len = lastLen || ((pc.getPlaylistSnapshot?.() || []).length);
    if (!len || newIndex < 0 || lastIndex < 0) {
      direction = 'forward';
      lastIndex = newIndex;
      return;
    }

    const prev = (lastIndex - 1 + len) % len;
    const next = (lastIndex + 1) % len;

    if (newIndex === prev) {
      direction = 'backward';
      lastIndex = newIndex;
      return;
    }

    if (newIndex === next) {
      direction = 'forward';
      lastIndex = newIndex;
      return;
    }

    // ‚Äú—Ä—É—á–Ω–æ–π –≤—ã–±–æ—Ä —Ç—Ä–µ–∫–∞‚Äù / jump => –ø–æ –¢–ó 7.8 direction = forward
    direction = 'forward';
    lastIndex = newIndex;
  }

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è PlayerCore
  if (typeof pc.on === 'function') {
    pc.on({
      onTrackChange: () => {
        const idx = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
        updateDirectionByIndex(idx);
        planWindow();
      }
    });
  }

  // –§–æ–ª–ª–±–µ–∫ –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–∏–ª–µ—Ç–∞—é—Ç)
  const btnNext = document.getElementById('next-btn');
  const btnPrev = document.getElementById('prev-btn');
  btnNext?.addEventListener('click', () => { direction = 'forward'; setTimeout(planWindow, 0); });
  btnPrev?.addEventListener('click', () => { direction = 'backward'; setTimeout(planWindow, 0); });

  // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–∞ —Ç–µ–∫—É—â–µ–º —Ç—Ä–µ–∫–µ)
  setTimeout(() => {
    lastIndex = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
    planWindow();
  }, 0);
}

//=================================================
// FILE: /scripts/app/playback-policy.js
// scripts/app/playback-policy.js
// –ï–¥–∏–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏/—Ä–µ–∂–∏–º–æ–≤ (favoritesOnly + shuffle) –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–µ–µ—Ä–∞.

(function PlaybackPolicyModule() {
  'use strict';

  const w = window;

  function isSpecialAlbumKey(key) {
    return !!key && String(key).startsWith('__');
  }

  function getPlayingAlbumKey() {
    return w.AlbumsManager?.getPlayingAlbum?.() || null;
  }

  function getLikedUidsForPlayingAlbum() {
    const playingAlbum = getPlayingAlbumKey();
    if (!playingAlbum) return [];
    if (playingAlbum === w.SPECIAL_FAVORITES_KEY) return [];
    if (isSpecialAlbumKey(playingAlbum)) return [];

    const uids = w.FavoritesManager?.getLikedUidsForAlbum?.(playingAlbum) || [];
    return Array.isArray(uids) ? uids.map(x => String(x || '').trim()).filter(Boolean) : [];
  }

  function getOriginalPlaylistSnapshot() {
    const pc = w.playerCore;
    const original = pc?.originalPlaylist || [];
    return Array.isArray(original) ? original.slice() : [];
  }

  function getCurrentSnapshot() {
    const pc = w.playerCore;
    const snap = pc?.getPlaylistSnapshot?.() || [];
    return Array.isArray(snap) ? snap.slice() : [];
  }

  function buildFavoritesOnlyPlaylistFromOriginal(original, likedUids) {
    if (!Array.isArray(original) || original.length === 0) return [];
    if (!Array.isArray(likedUids) || likedUids.length === 0) return [];

    const set = new Set(likedUids);
    return original.filter(t => {
      const uid = String(t?.uid || '').trim();
      return uid && set.has(uid);
    });
  }

  function findTrackIndexByUid(list, uid) {
    const u = String(uid || '').trim();
    if (!Array.isArray(list) || !u) return -1;
    return list.findIndex(t => String(t?.uid || '').trim() === u);
  }

  function setFavoritesOnlyModeUI(enabled) {
    // UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∫–Ω–æ–ø–∫–∞ –≤ –ø–ª–µ–µ—Ä–µ)
    const btn = document.getElementById('favorites-btn');
    const icon = document.getElementById('favorites-btn-icon');
    if (!btn || !icon) return;

    btn.classList.toggle('favorites-active', !!enabled);
    icon.src = enabled ? 'img/star.png' : 'img/star2.png';

    try {
      localStorage.setItem('favoritesOnlyMode', enabled ? '1' : '0');
    } catch {}
  }

  function ensureAvailableIndicesForPlayback() {
    // –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É window.availableFavoriteIndices –∫–∞–∫ ‚Äú–º—è–≥–∫–∏–π‚Äù fallback,
    // –Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º —Ç–µ–ø–µ—Ä—å ‚Äî –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ —á–µ—Ä–µ–∑ setPlaylist.
    try {
      if (w.PlayerUI && typeof w.PlayerUI.updateAvailableTracksForPlayback === 'function') {
        w.PlayerUI.updateAvailableTracksForPlayback();
      }
    } catch {}
  }

  /**
   * –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –æ—á–µ—Ä–µ–¥–∏ –∫ —Ç–µ–∫—É—â–µ–º—É playingAlbum (–ù–ï –∫ currentAlbum).
   * opts:
   * - reason: 'toggle' | 'favoritesChanged' | 'init'
   * - changed: { albumKey, uid, liked }
   */
  function apply(opts = {}) {
    const pc = w.playerCore;
    if (!pc) return;

    const playingAlbum = getPlayingAlbumKey();
    if (!playingAlbum) return;

    // –í __favorites__ –ø–ª–µ–π–ª–∏—Å—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ AlbumsManager.ensureFavoritesPlayback.
    if (playingAlbum === w.SPECIAL_FAVORITES_KEY) {
      ensureAvailableIndicesForPlayback();
      return;
    }

    // –î–ª—è —Å–ø–µ—Ü-—Ä–∞–∑–¥–µ–ª–æ–≤ (–Ω–æ–≤–æ—Å—Ç–∏) –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É.
    if (isSpecialAlbumKey(playingAlbum)) {
      ensureAvailableIndicesForPlayback();
      return;
    }

    const favoritesOnlyEnabled = (localStorage.getItem('favoritesOnlyMode') === '1');

    if (!favoritesOnlyEnabled) {
      // –†–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º.
      ensureAvailableIndicesForPlayback();
      return;
    }

    const likedUids = getLikedUidsForPlayingAlbum();

    // ‚úÖ 6.5: –µ—Å–ª–∏ –ª–∞–π–∫–æ–≤ 0 ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç
    if (likedUids.length === 0) {
      setFavoritesOnlyModeUI(false);
      w.NotificationSystem?.info('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
      ensureAvailableIndicesForPlayback();
      return;
    }

    const original = getOriginalPlaylistSnapshot();
    const current = getCurrentSnapshot();

    const currentTrack = pc.getCurrentTrack?.();
    const currentUid = String(currentTrack?.uid || '').trim() || null;

    const targetFavoritesPlaylist = buildFavoritesOnlyPlaylistFromOriginal(original, likedUids);

    if (targetFavoritesPlaylist.length === 0) {
      // –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ, –µ—Å–ª–∏ uid –Ω–µ —Å–æ–≤–ø–∞–ª–∏ —Å originalPlaylist
      setFavoritesOnlyModeUI(false);
      w.NotificationSystem?.info('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
      ensureAvailableIndicesForPlayback();
      return;
    }

    const isShuffle = !!pc.isShuffle?.();

    // ‚úÖ –ï—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω, –∏ –ø—Ä–∏—à—ë–ª –ª–∞–π–∫ –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏
    // (6.2) –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ reshuffle.
    if (isShuffle && opts?.reason === 'favoritesChanged') {
      const d = opts?.changed || {};
      const changedAlbum = String(d.albumKey || '').trim();
      const changedUid = String(d.uid || '').trim();
      const liked = !!d.liked;

      // ‚úÖ Like: –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ö–≤–æ—Å—Ç
      if (liked && changedAlbum === playingAlbum && changedUid) {
        const inCurrent = current.some(t => String(t?.uid || '').trim() === changedUid);
        if (!inCurrent) {
          const add = targetFavoritesPlaylist.find(t => String(t?.uid || '').trim() === changedUid) || null;
          if (add) {
            pc.appendToPlaylistTail?.([add]);
            ensureAvailableIndicesForPlayback();
            return;
          }
        }
      }

      // ‚úÖ Unlike –ù–ï —Ç–µ–∫—É—â–µ–≥–æ: —É–±—Ä–∞—Ç—å –∏–∑ —Ö–≤–æ—Å—Ç–∞ –æ—á–µ—Ä–µ–¥–∏, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –ø—Ä–æ–∏–≥—Ä–∞–Ω (—É–º–Ω—ã–π —Ä–µ–∂–∏–º)
      if (!liked && changedAlbum === playingAlbum && changedUid) {
        const repeat = !!pc.isRepeat?.();
        if (!repeat) {
          const removed = pc.removeFromPlaylistTailIfNotPlayed?.({ uid: changedUid });
          if (removed) {
            ensureAvailableIndicesForPlayback();
            return;
          }
        }
      }
    }

    // –ï—Å–ª–∏ –º—ã —É–∂–µ –≤ favorites-only –ø–ª–µ–π–ª–∏—Å—Ç–µ (–ø–æ —Å–æ—Å—Ç–∞–≤—É) ‚Äî –ø—Ä–æ–≤–µ—Ä–∏–º –Ω–∞ ‚Äúunlike current‚Äù
    // –∏ –ø—Ä–∏–º–µ–Ω–∏–º 6.1: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–æ—Å—Ç—É–ø–Ω–æ–º—É.
    // ‚úÖ 6.3: –µ—Å–ª–∏ repeat –≤–∫–ª—é—á—ë–Ω ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–≤—Ç–æ—Ä—è—Ç—å.
    const repeat = !!pc.isRepeat?.();

    if (!repeat && opts?.reason === 'favoritesChanged' && currentUid) {
      const d = opts?.changed || {};
 const changedAlbum = String(d.albumKey || '').trim();
      const changedUid = String(d.uid || '').trim();
      const liked = !!d.liked;

      if (!liked && changedAlbum === playingAlbum && changedUid) {
        const stillLiked = likedUids.includes(changedUid);
        if (!stillLiked) {
          // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–ª–∞–π–∫–∞–ª–∏ ‚Äî next().
          if (changedUid === currentUid) {
            // –ü–µ—Ä–µ–¥ next() —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞—à –ø–ª–µ–π–ª–∏—Å—Ç –∞–∫—Ç—É–∞–ª–µ–Ω –∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –∏—Å–∫–ª—é—á—ë–Ω.
            // –ú—ã –ù–ï —Å—Ç–æ–ø–∞–µ–º ‚Äî –ø—Ä–æ—Å—Ç–æ ‚Äú–ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è‚Äù.
            const filtered = targetFavoritesPlaylist.filter(t => String(t?.uid || '').trim() !== changedUid);
            if (filtered.length === 0) {
              setFavoritesOnlyModeUI(false);
              w.NotificationSystem?.info('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
              ensureAvailableIndicesForPlayback();
              return;
            }

            // –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç –±–µ–∑ —Ç–µ–∫—É—â–µ–≥–æ, —Å–æ—Ö—Ä–∞–Ω—è—è shuffleMode (–µ—Å–ª–∏ –æ–Ω –±—ã–ª) –∏ originalPlaylist.
            pc.setPlaylist(filtered, 0, {}, {
              preserveOriginalPlaylist: true,
              preserveShuffleMode: true,
              resetHistory: false
            });

            // next() –≤ —Ä–∞–º–∫–∞—Ö –Ω–æ–≤–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞.
            pc.next();
            ensureAvailableIndicesForPlayback();
            return;
          }
        }
      }
    }

    // –ë–∞–∑–æ–≤—ã–π —Å–ª—É—á–∞–π: –ø—Ä–∏–≤–µ—Å—Ç–∏ —Ç–µ–∫—É—â–∏–π –ø–ª–µ–π–ª–∏—Å—Ç –∫ favorites-only (–∏–∑ original).
    // –°—Ç–∞—Ä—Ç: –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –µ—Å—Ç—å –≤ target ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –Ω–µ–≥–æ, –∏–Ω–∞—á–µ —Å 0.
    let startIndex = 0;
    if (currentUid) {
      const idx = findTrackIndexByUid(targetFavoritesPlaylist, currentUid);
      startIndex = idx >= 0 ? idx : 0;
    }

    pc.setPlaylist(targetFavoritesPlaylist, startIndex, {}, {
      preserveOriginalPlaylist: true,
      preserveShuffleMode: true,
      resetHistory: false
    });

    // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º play() –∑–¥–µ—Å—å: setPlaylist —É–∂–µ ‚Äú–º—è–≥–∫–æ‚Äù —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.
    ensureAvailableIndicesForPlayback();
  }

  w.PlaybackPolicy = {
    apply
  };
})();

//=================================================
// FILE: /scripts/app/player-ui.js
/**
 * Player UI - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –ø–ª–µ–µ—Ä–∞
 * –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–ó_–ù–¨–Æ v1.0
 * –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è v3.0
 */
(function PlayerUIModule() {
  'use strict';

  const w = window;

  // ==================== –£–¢–ò–õ–ò–¢–´ ====================

  const pc = () => w.playerCore;
  const $ = (sel, ctx = document) => ctx?.querySelector(sel);
  const $$ = (sel, ctx = document) => ctx?.querySelectorAll(sel) || [];
  const esc = (s) => w.Utils?.escapeHtml?.(s) ?? String(s || '');

  const formatTime = (sec) => {
    if (!sec || !isFinite(sec) || sec < 0) return '0:00';
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
  };

  // ==================== –°–û–°–¢–û–Ø–ù–ò–ï ====================

  const state = {
    initialized: false,
    isDragging: false,
    currentAlbumKey: null,
    playingAlbumKey: null,
    inMiniMode: false,
    savedMiniState: null
  };

  // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================

  function initialize() {
    if (state.initialized) return;
    state.initialized = true;

    waitForPlayer(() => {
      setupPlayerEvents();
      restoreUIState();
      console.log('‚úÖ PlayerUI initialized');
    });
  }

  function waitForPlayer(callback) {
    if (pc()) {
      callback();
    } else {
      const check = setInterval(() => {
        if (pc()) {
          clearInterval(check);
          callback();
        }
      }, 100);
      setTimeout(() => clearInterval(check), 10000);
    }
  }

  // ==================== –ë–õ–û–ö –ü–õ–ï–ï–†–ê ====================

  function ensurePlayerBlock(insertAfterIndex = 0, opts = {}) {
    const trackList = $('#track-list');
    if (!trackList) return null;

    let block = $('#lyricsplayerblock');

    if (!block) {
      block = createPlayerBlock();
      bindControlEvents(block);
    }

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    const tracks = trackList.querySelectorAll('.track');
    const targetTrack = tracks[insertAfterIndex] || tracks[0];

    if (targetTrack && targetTrack.nextSibling !== block) {
      targetTrack.after(block);
    } else if (!targetTrack && !block.parentElement) {
      trackList.appendChild(block);
    }

    syncPlayerUI();

    // –õ–∏—Ä–∏–∫–∞
    if (w.LyricsController) {
      w.LyricsController.restoreSettingsIntoDom();
      const track = pc()?.getCurrentTrack();
      if (track) w.LyricsController.onTrackChange(track);
    }

    return block;
  }

  function createPlayerBlock() {
    const block = document.createElement('div');
    block.id = 'lyricsplayerblock';
    block.className = 'lyrics-player-block';
    block.innerHTML = PLAYER_TEMPLATE;
    return block;
  }

  // ==================== HTML –®–ê–ë–õ–û–ù ====================

  const PLAYER_TEMPLATE = `
    <div class="lyrics-animated-bg"></div>
    
    <div id="lyrics-window" class="lyrics-normal">
      <div class="lyrics-scroll">
        <div id="lyrics"></div>
      </div>
    </div>
    
    <div class="player-progress-wrapper">
      <div id="player-progress-bar" class="player-progress-bar">
        <div id="player-progress-fill" class="player-progress-fill"></div>
        <div class="player-progress-handle"></div>
      </div>
    </div>
    
    <div class="player-controls">
      <div class="player-controls-row">
        <span class="time-in-controls" id="time-current">0:00</span>
        <button class="player-control-btn" id="prev-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        <button class="player-control-btn main" id="play-pause-btn" title="Play/Pause">
          <svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <button class="player-control-btn" id="next-btn" title="–°–ª–µ–¥—É—é—â–∏–π">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
        </button>
        <span class="time-in-controls" id="time-duration">0:00</span>
      </div>
      
      <div class="player-controls-row">
        <button class="player-control-btn" id="shuffle-btn" title="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
        </button>
        <button class="player-control-btn" id="repeat-btn" title="–ü–æ–≤—Ç–æ—Ä">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
        </button>
        <button class="player-control-btn" id="favorites-btn" title="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ">
          <img id="favorites-btn-icon" src="img/star2.png" alt="F" style="width:18px;height:18px;">
        </button>
        <button class="player-control-btn" id="pq-btn" title="–ö–∞—á–µ—Å—Ç–≤–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è">
          <span class="pq-btn-label">Hi</span>
        </button>
        <button class="player-control-btn" id="mute-btn" title="–ó–≤—É–∫">
          <svg id="mute-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0014 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        </button>
        <button class="sleep-timer-btn" id="sleep-timer-btn" title="–¢–∞–π–º–µ—Ä —Å–Ω–∞">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
          <span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none;"></span>
        </button>
      </div>
    </div>
    
    <div class="volume-control-wrapper" id="volume-wrapper">
      <div class="volume-track">
        <div class="volume-fill" id="volume-fill"></div>
        <div class="volume-handle" id="volume-handle"></div>
      </div>
      <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100">
    </div>
    
    <div class="player-buttons-wrapper">
      <div class="player-extra-buttons-row">
        <button class="lyrics-toggle-btn" id="lyrics-toggle-btn" title="–†–µ–∂–∏–º —Ç–µ–∫—Å—Ç–∞">
          <span class="lyrics-toggle-btn-visual">T</span>
        </button>
        <button class="animation-btn" id="animation-btn" title="–ê–Ω–∏–º–∞—Ü–∏—è">A</button>
        <button class="pulse-btn" id="pulse-btn" title="–ü—É–ª—å—Å–∞—Ü–∏—è">‚ù§Ô∏è</button>
        <button class="karaoke-btn" id="lyrics-text-btn" title="–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç">üìù</button>
        <a class="player-download-btn" id="download-btn" title="–°–∫–∞—á–∞—Ç—å" download>üíæ</a>
      </div>
    </div>
  `;

  // ==================== –ü–†–ò–í–Ø–ó–ö–ê –°–û–ë–´–¢–ò–ô ====================

  function bindControlEvents(block) {
    if (!block) return;

    // Play/Pause
    $('#play-pause-btn', block)?.addEventListener('click', togglePlayPause);

    // Prev/Next
    $('#prev-btn', block)?.addEventListener('click', () => pc()?.prev());
    $('#next-btn', block)?.addEventListener('click', () => pc()?.next());

    // Shuffle
    $('#shuffle-btn', block)?.addEventListener('click', () => {
      if (!pc()) return;
      pc().toggleShuffle();
      updateShuffleUI(block);
    });

    // Repeat
    $('#repeat-btn', block)?.addEventListener('click', () => {
      if (!pc()) return;
      pc().toggleRepeat();
      updateRepeatUI(block);
    });

    // Favorites Only (F)
    $('#favorites-btn', block)?.addEventListener('click', toggleFavoritesOnlyMode);

    // PQ (Hi/Lo) ‚Äî –¢–ó 4.1-4.3
    $('#pq-btn', block)?.addEventListener('click', togglePlaybackQuality);

    // Mute
    $('#mute-btn', block)?.addEventListener('click', toggleMute);

    // Sleep Timer
    $('#sleep-timer-btn', block)?.addEventListener('click', () => w.SleepTimer?.show?.());

    // Lyrics Toggle
    $('#lyrics-toggle-btn', block)?.addEventListener('click', () => {
      w.LyricsController?.toggleLyricsView?.();
    });

    // Animation
    $('#animation-btn', block)?.addEventListener('click', () => {
      w.LyricsController?.toggleAnimation?.();
    });

    // Pulse
    $('#pulse-btn', block)?.addEventListener('click', togglePulse);

    // Full Lyrics
    $('#lyrics-text-btn', block)?.addEventListener('click', () => {
      w.LyricsModal?.show?.();
    });

    // Progress bar
    bindProgressEvents(block);

    // Volume
    bindVolumeEvents(block);
  }

  // ==================== –ü–†–û–ì–†–ï–°–°-–ë–ê–† ====================

  function bindProgressEvents(block) {
    const bar = $('#player-progress-bar', block);
    if (!bar) return;

    const seek = (e) => {
      const rect = bar.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      const pct = Math.max(0, Math.min(1, x / rect.width));
      const dur = pc()?.getDuration() || 0;
      if (dur > 0) pc()?.seek(pct * dur);
    };

    const onMove = (e) => {
      if (!state.isDragging) return;
      e.preventDefault();
      seek(e);
    };

    const onEnd = () => {
      if (!state.isDragging) return;
      state.isDragging = false;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onEnd);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onEnd);
    };

    const onStart = (e) => {
      state.isDragging = true;
      seek(e);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onEnd);
      document.addEventListener('touchmove', onMove, { passive: false });
      document.addEventListener('touchend', onEnd);
    };

    bar.addEventListener('mousedown', onStart);
    bar.addEventListener('touchstart', onStart, { passive: true });
  }

  // ==================== –ì–†–û–ú–ö–û–°–¢–¨ ====================

  function bindVolumeEvents(block) {
    const slider = $('#volume-slider', block);
    if (!slider) return;

    const update = (val) => {
      const v = Number(val);
      pc()?.setVolume(v);
      updateVolumeUI(v);
      try { localStorage.setItem('playerVolume', String(Math.round(v))); } catch {}
    };

    slider.addEventListener('input', (e) => update(e.target.value));

    // –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const saved = localStorage.getItem('playerVolume');
    const vol = saved !== null ? Number(saved) : 100;
    slider.value = vol;
    updateVolumeUI(vol);
  }

  function updateVolumeUI(vol) {
    const fill = $('#volume-fill');
    const handle = $('#volume-handle');
    const slider = $('#volume-slider');

    const pct = Math.max(0, Math.min(100, vol));

    if (fill) fill.style.width = `${pct}%`;
    if (handle) handle.style.left = `${pct}%`;
    if (slider) slider.value = pct;

    // –ò–∫–æ–Ω–∫–∞ mute
    const icon = $('#mute-icon');
    if (icon) {
      icon.innerHTML = pct === 0
        ? '<path d="M16.5 12A4.5 4.5 0 0014 7.97v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51A8.8 8.8 0 0021 12c0-4.28-3-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06a8.9 8.9 0 003.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>'
        : '<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3A4.5 4.5 0 0014 7.97v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>';
    }
  }

  function toggleMute() {
    if (!pc()) return;
    const vol = pc().getVolume();
    const newVol = vol > 0 ? 0 : (Number(localStorage.getItem('playerVolume')) || 100);
    pc().setVolume(newVol);
    updateVolumeUI(newVol);
  }

  // ==================== PLAY/PAUSE ====================

  function togglePlayPause() {
    if (!pc()) return;
    pc().isPlaying() ? pc().pause() : pc().play();
  }

  function updatePlayPauseIcon(isPlaying) {
    const icon = $('#play-pause-icon');
    if (!icon) return;

    icon.innerHTML = isPlaying
      ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
      : '<path d="M8 5v14l11-7z"/>';
  }

  // ==================== SHUFFLE / REPEAT ====================

  function updateShuffleUI(block) {
    const btn = $('#shuffle-btn', block || document);
    if (!btn || !pc()) return;
    btn.classList.toggle('active', pc().isShuffle());
  }

  function updateRepeatUI(block) {
    const btn = $('#repeat-btn', block || document);
    if (!btn || !pc()) return;
    btn.classList.toggle('active', pc().isRepeat());
    btn.classList.toggle('repeat-active', pc().isRepeat());
  }

  // ==================== PQ (Hi/Lo) ‚Äî –¢–ó 4 ====================

  function togglePlaybackQuality() {
    if (!pc()) return;

    const btn = $('#pq-btn');
    if (btn?.classList.contains('disabled')) {
      w.NotificationSystem?.info('–ù–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞');
      return;
    }

    // –¢–ó 7.5.1: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏
    const online = navigator.onLine !== false;
    if (!online) {
      w.NotificationSystem?.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ç–∏');
      return;
    }

    const current = pc().getQualityMode();
    const next = current === 'hi' ? 'lo' : 'hi';

    const result = pc().switchQuality(next);

    if (result?.ok) {
      updatePQButtonUI();
      w.NotificationSystem?.success(`–ö–∞—á–µ—Å—Ç–≤–æ: ${next.toUpperCase()}`);
    }
  }

  function updatePQButtonUI() {
    const btn = $('#pq-btn');
    const label = btn?.querySelector('.pq-btn-label');
    if (!btn || !label) return;

    const pq = pc()?.getQualityMode() || 'hi';
    const canToggle = pc()?.canToggleQualityForCurrentTrack?.() ?? false;
    const online = navigator.onLine !== false;

    label.textContent = pq.toUpperCase();

    btn.classList.remove('pq-hi', 'pq-lo', 'disabled');
    btn.classList.add(`pq-${pq}`);

    // –¢–ó 4.1: disabled –µ—Å–ª–∏ –Ω–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –∏–ª–∏ –Ω–µ—Ç —Å–µ—Ç–∏
    if (!canToggle || !online) {
      btn.classList.add('disabled');
    }
  }

  // ==================== FAVORITES ONLY (F) ‚Äî –¢–ó 6 ====================

  function toggleFavoritesOnlyMode() {
    const btn = $('#favorites-btn');
    const icon = $('#favorites-btn-icon');
    if (!btn || !icon) return;

    const isActive = btn.classList.contains('favorites-active');
    const playingAlbum = w.AlbumsManager?.getPlayingAlbum?.();

    if (!isActive) {
      // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
      if (playingAlbum === w.SPECIAL_FAVORITES_KEY) {
        btn.classList.add('favorites-active');
        icon.src = 'img/star.png';
      } else {
        const liked = w.FavoritesManager?.getLikedUidsForAlbum?.(playingAlbum) || [];
        if (liked.length === 0) {
          w.NotificationSystem?.info('–û—Ç–º–µ—Ç—å—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫ ‚≠ê');
          return;
        }
        btn.classList.add('favorites-active');
        icon.src = 'img/star.png';
      }
      try { localStorage.setItem('favoritesOnlyMode', '1'); } catch {}
    } else {
      // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
      btn.classList.remove('favorites-active');
      icon.src = 'img/star2.png';
      try { localStorage.setItem('favoritesOnlyMode', '0'); } catch {}
    }

    w.PlaybackPolicy?.apply?.({ reason: 'toggle' });
  }

  // ==================== PULSE ====================

  function togglePulse() {
    const logo = $('#logo-bottom');
    const btn = $('#pulse-btn');
    if (!logo) return;

    const isActive = logo.classList.toggle('pulsing');
    btn?.classList.toggle('active', isActive);

    try { localStorage.setItem('logoPulseEnabled', isActive ? '1' : '0'); } catch {}
  }

  // ==================== –ü–†–û–ì–†–ï–°–° ====================

  function updateProgress(pos, dur) {
    if (state.isDragging) return;

    const pct = dur > 0 ? (pos / dur) * 100 : 0;

    const fill = $('#player-progress-fill');
    if (fill) fill.style.width = `${pct}%`;

    const timeCur = $('#time-current');
    const timeDur = $('#time-duration');
    if (timeCur) timeCur.textContent = formatTime(pos);
    if (timeDur) timeDur.textContent = formatTime(dur);
  }

  // ==================== TRACK INFO ====================

  function updateTrackDisplay(track) {
    if (!track) return;

    // Download link
    const dlBtn = $('#download-btn');
    if (dlBtn && track.src) {
      dlBtn.href = track.src;
      dlBtn.download = `${track.artist || 'track'} - ${track.title || 'audio'}.mp3`;
    }
  }

  function updateDownloadLink() {
    const track = pc()?.getCurrentTrack();
    const dlBtn = $('#download-btn');
    if (!dlBtn) return;

    if (track?.src) {
      dlBtn.href = track.src;
      dlBtn.download = `${track.artist || 'track'} - ${track.title || 'audio'}.mp3`;
      dlBtn.style.pointerEvents = '';
      dlBtn.style.opacity = '';
    } else {
      dlBtn.href = '#';
      dlBtn.style.pointerEvents = 'none';
      dlBtn.style.opacity = '0.4';
    }
  }

  // ==================== –ú–ò–ù–ò-–ü–õ–ï–ï–† ====================

  function createMiniNow() {
    const container = $('#now-playing');
    if (!container) return null;

    let mini = $('#mini-now');
    if (mini) return mini;

    container.innerHTML = `
      <div class="mini-now" id="mini-now">
        <span class="tnum" id="mini-now-num">‚Äî</span>
        <span class="track-title" id="mini-now-title">‚Äî</span>
        <img src="img/star2.png" class="like-star" id="mini-now-star" alt="‚≠ê">
      </div>
      <div class="next-up" id="next-up" style="display:none;">
        <span class="label">–î–∞–ª–µ–µ:</span>
        <span class="title" id="next-up-title">‚Äî</span>
      </div>
    `;

    // –°–æ–±—ã—Ç–∏—è –º–∏–Ω–∏-–ø–ª–µ–µ—Ä–∞
    $('#mini-now', container)?.addEventListener('click', (e) => {
      if (e.target.classList.contains('like-star')) return;
      jumpToPlayingAlbum();
    });

    $('#mini-now-star', container)?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleLikePlaying();
    });

    return $('#mini-now', container);
  }

  function updateMiniHeader() {
    const track = pc()?.getCurrentTrack();
    const idx = pc()?.getIndex() ?? 0;

    const num = $('#mini-now-num');
    const title = $('#mini-now-title');
    const star = $('#mini-now-star');

    if (num) num.textContent = String((idx ?? 0) + 1).padStart(2, '0') + '.';
    if (title) title.textContent = track?.title || '‚Äî';

    // –ó–≤–µ–∑–¥–∞
    if (star && track) {
      const albumKey = track.sourceAlbum || track.album || '';
      const uid = track.uid || '';
      const isFav = w.FavoritesManager?.isFavorite?.(albumKey, uid) ?? false;
      star.src = isFav ? 'img/star.png' : 'img/star2.png';
      star.dataset.album = albumKey;
      star.dataset.uid = uid;
    }
  }

  function updateNextUpLabel() {
    const nextUp = $('#next-up');
    const nextTitle = $('#next-up-title');
    if (!nextUp) return;

    const playlist = pc()?.getPlaylistSnapshot() || [];
    const idx = pc()?.getIndex() ?? -1;

    if (playlist.length > 1 && idx >= 0 && idx < playlist.length - 1) {
      const next = playlist[idx + 1];
      if (nextTitle) nextTitle.textContent = `${next?.artist || ''} ‚Äî ${next?.title || ''}`;
      nextUp.style.display = 'flex';
    } else {
      nextUp.style.display = 'none';
    }
  }

  function jumpToPlayingAlbum() {
    const playingAlbum = w.AlbumsManager?.getPlayingAlbum?.();
    if (playingAlbum && w.AlbumsManager?.loadAlbum) {
      w.AlbumsManager.loadAlbum(playingAlbum);
    }
  }

  function toggleLikePlaying() {
    const track = pc()?.getCurrentTrack();
    if (!track) return;

    const albumKey = track.sourceAlbum || track.album || '';
    const uid = track.uid || '';

    if (!albumKey || !uid) {
      w.NotificationSystem?.warning('UID —Ç—Ä–µ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    const wasLiked = w.FavoritesManager?.isFavorite?.(albumKey, uid) ?? false;
    w.FavoritesManager?.toggleLike?.(albumKey, uid, !wasLiked, { source: 'mini' });

    // UI –∑–≤–µ–∑–¥—ã
    const star = $('#mini-now-star');
    if (star) star.src = !wasLiked ? 'img/star.png' : 'img/star2.png';
  }

  // ==================== –†–ï–ñ–ò–ú–´: –ü–û–õ–ù–´–ô / –ú–ò–ù–ò ====================

  function switchAlbumInstantly(newAlbumKey) {
    state.currentAlbumKey = newAlbumKey;
    state.playingAlbumKey = w.AlbumsManager?.getPlayingAlbum?.() || null;

    const needsMini = state.playingAlbumKey &&
                     state.currentAlbumKey &&
                     state.playingAlbumKey !== state.currentAlbumKey &&
                     !String(state.currentAlbumKey).startsWith('__');

    if (needsMini) {
      switchToMiniMode();
    } else {
      switchToFullMode();
    }
  }

  function switchToMiniMode() {
    if (state.inMiniMode) return;
    state.inMiniMode = true;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ª–∏—Ä–∏–∫–∏
    if (w.LyricsController) {
      state.savedMiniState = w.LyricsController.getMiniSaveState();
      w.LyricsController.applyMiniMode();
    }

    // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫
    const block = $('#lyricsplayerblock');
    if (block) block.style.display = 'none';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏-–ø–ª–µ–µ—Ä
    createMiniNow();
    updateMiniHeader();
    updateNextUpLabel();

    const container = $('#now-playing');
    if (container) container.style.display = '';
  }

  function switchToFullMode() {
    if (!state.inMiniMode) return;
    state.inMiniMode = false;

    // –°–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏-–ø–ª–µ–µ—Ä
    const container = $('#now-playing');
    if (container) container.style.display = 'none';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫
    const block = $('#lyricsplayerblock');
    if (block) block.style.display = '';

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏—Ä–∏–∫—É
    if (w.LyricsController && state.savedMiniState) {
      w.LyricsController.restoreFromMiniMode(state.savedMiniState);
      state.savedMiniState = null;
    }

    syncPlayerUI();
  }

  // ==================== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø UI ====================

  function syncPlayerUI() {
    const block = $('#lyricsplayerblock');
    if (!block || !pc()) return;

    updatePlayPauseIcon(pc().isPlaying());
    updateProgress(pc().getPosition(), pc().getDuration());
    updateVolumeUI(pc().getVolume());
    updateShuffleUI(block);
    updateRepeatUI(block);
    updatePQButtonUI();
    updateDownloadLink();

    // Favorites Only
    const favEnabled = localStorage.getItem('favoritesOnlyMode') === '1';
    $('#favorites-btn', block)?.classList.toggle('favorites-active', favEnabled);
    const favIcon = $('#favorites-btn-icon', block);
    if (favIcon) favIcon.src = favEnabled ? 'img/star.png' : 'img/star2.png';
  }

  function restoreUIState() {
    // –ì—Ä–æ–º–∫–æ—Å—Ç—å
    const savedVol = localStorage.getItem('playerVolume');
    if (savedVol !== null && pc()) {
      pc().setVolume(Number(savedVol));
    }

    // –ü—É–ª—å—Å–∞—Ü–∏—è
    if (localStorage.getItem('logoPulseEnabled') === '1') {
      $('#logo-bottom')?.classList.add('pulsing');
      $('#pulse-btn')?.classList.add('active');
    }
  }

  // ==================== –ü–û–î–ü–ò–°–ö–ê –ù–ê –°–û–ë–´–¢–ò–Ø –ü–õ–ï–ï–†–ê ====================

  function setupPlayerEvents() {
    if (!pc()) return;

    pc().on({
      onPlay: () => {
        updatePlayPauseIcon(true);
        if (state.inMiniMode) updateMiniHeader();
      },

      onPause: () => {
        updatePlayPauseIcon(false);
      },

      onStop: () => {
        updatePlayPauseIcon(false);
        updateProgress(0, 0);
      },

      onTrackChange: (track, index) => {
        updateTrackDisplay(track);
        updatePQButtonUI();
        updateDownloadLink();

        // –õ–∏—Ä–∏–∫–∞
        if (w.LyricsController && !state.inMiniMode) {
          w.LyricsController.onTrackChange(track);
        }

        // –ú–∏–Ω–∏-—Ä–µ–∂–∏–º
        if (state.inMiniMode) {
          updateMiniHeader();
          updateNextUpLabel();
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ —Å–ø–∏—Å–∫–µ
        w.AlbumsManager?.highlightCurrentTrack?.(index);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        w.PlayerState?.save?.();
      },

      onTick: (pos, dur) => {
        updateProgress(pos, dur);

        // –õ–∏—Ä–∏–∫–∞
        if (w.LyricsController && !state.inMiniMode) {
          w.LyricsController.onTick(pos, { inMiniMode: state.inMiniMode });
        }
      },

      onEnd: () => {},

      onError: (err) => {
        console.error('PlayerCore error:', err);
      }
    });
  }

  // ==================== –ü–£–ë–õ–ò–ß–ù–´–ô API ====================

  w.PlayerUI = {
    initialize,
    ensurePlayerBlock,
    switchAlbumInstantly,
    syncPlayerUI,
    updateMiniHeader,
    updateNextUpLabel,
    updateProgress,
    updatePlayPauseIcon,
    updateVolumeUI,
    updatePQButtonUI,
    updateAvailableTracksForPlayback: () => {
      w.PlaybackPolicy?.apply?.({ reason: 'favoritesChanged' });
    },
    togglePlayPause,
    state,

    // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    currentLyrics: [],
    currentLyricsLines: []
  };

  // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å LyricsController
  Object.defineProperty(w.PlayerUI, 'currentLyrics', {
    get: () => w.LyricsController?.getCurrentLyrics?.() || []
  });

  Object.defineProperty(w.PlayerUI, 'currentLyricsLines', {
    get: () => w.LyricsController?.getCurrentLyricsLines?.() || []
  });

})();

//=================================================
// FILE: /scripts/app/player-ui/lyrics.js
// scripts/app/player-ui/lyrics.js
// LyricsController ‚Äî –µ–¥–∏–Ω—ã–π –º–æ–¥—É–ª—å –ª–∏—Ä–∏–∫–∏ –¥–ª—è PlayerUI.
// –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã: –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (no stop/play/seek), —Ç–æ–ª—å–∫–æ UI –∏ fetch/cache.

(function LyricsControllerModule() {
  'use strict';

  const w = window;

  const LYRICS_404_CACHE_KEY = 'lyrics_404_cache:v1';
  const LYRICS_MIN_INTERVAL = 250;

  let currentLyrics = [];
  let hasTimedLyricsForCurrentTrack = false;

  // view state —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage, –Ω–æ –º–æ–¥—É–ª—å –¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è,
  // —á—Ç–æ–±—ã PlayerUI –º–æ–≥ –±—ã—Å—Ç—Ä–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å.
  let lyricsViewMode = 'normal'; // 'normal' | 'hidden' | 'expanded'
  let animationEnabled = false;

  // throttling
  let lyricsLastIdx = -1;
  let lyricsLastTs = 0;

  // prefetch cache
  let prefetchedLyrics = null;
  let prefetchedLyricsUrl = null;

  function escapeHtml(s) {
    return w.Utils?.escapeHtml ? w.Utils.escapeHtml(String(s || '')) : String(s || '');
  }

  function readLyricsViewMode() {
    const saved = localStorage.getItem('lyricsViewMode');
    if (saved && (saved === 'normal' || saved === 'hidden' || saved === 'expanded')) return saved;
    return 'normal';
  }

  function readAnimationEnabled() {
    return localStorage.getItem('lyricsAnimationEnabled') === '1';
  }

  function writeLyricsViewMode(mode) {
    const m = (mode === 'hidden' || mode === 'expanded') ? mode : 'normal';
    try { localStorage.setItem('lyricsViewMode', m); } catch {}
    return m;
  }

  function writeAnimationEnabled(on) {
    try { localStorage.setItem('lyricsAnimationEnabled', on ? '1' : '0'); } catch {}
    return !!on;
  }

  function getLyrics404Cache() {
    try {
      const raw = sessionStorage.getItem(LYRICS_404_CACHE_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch {
      return {};
    }
  }

  function setLyrics404Cache(url) {
    try {
      const cache = getLyrics404Cache();
      cache[url] = Date.now();

      // –æ–≥—Ä–∞–Ω–∏—á–∏–º —Ä–∞–∑–º–µ—Ä
      const keys = Object.keys(cache);
      if (keys.length > 100) {
        const oldest = keys.sort((a, b) => cache[a] - cache[b]).slice(0, 50);
        oldest.forEach(k => delete cache[k]);
      }

      sessionStorage.setItem(LYRICS_404_CACHE_KEY, JSON.stringify(cache));
    } catch {}
  }

  function isLyrics404Cached(url) {
    const cache = getLyrics404Cache();
    return !!cache[url];
  }

  function isLyricsKnownMissingFast(lyricsUrl) {
    const url = String(lyricsUrl || '').trim();
    if (!url) return true;

    if (isLyrics404Cached(url)) return true;

    // sessionStorage marker
    try {
      const cacheKey = `lyrics_cache_${url}`;
      const cached = sessionStorage.getItem(cacheKey);
      if (!cached) return false;
      const parsed = JSON.parse(cached);
      return (parsed === null || parsed === '__NO_LYRICS__');
    } catch {
      return false;
    }
  }

  function checkTrackHasLyrics(track) {
    if (!track) return false;
    if (track.hasLyrics === false) return false;
    if (track.hasLyrics === true) return true;
    return !!track.lyrics;
  }

  function detectLyricsFormat(url, content) {
    if (url) {
      const lower = String(url).toLowerCase();
      if (lower.endsWith('.lrc')) return 'lrc';
      if (lower.endsWith('.json')) return 'json';
      if (lower.endsWith('.txt')) return 'lrc';
    }

    const trimmed = String(content || '').trim();
    if (!trimmed) return 'unknown';

    // JSON: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å [ –∏–ª–∏ {
    if (trimmed[0] === '[' || trimmed[0] === '{') {
      try {
        JSON.parse(trimmed);
        return 'json';
      } catch {}
    }

    // LRC: –µ—Å—Ç—å —Ç–∞–π–º–∫–æ–¥—ã [mm:ss...]
    if (/$$\d{1,2}:\d{2}([.:]\d{1,3})?$$/.test(trimmed)) return 'lrc';

    return 'unknown';
  }

  function parseLyricsInto(source, targetArray) {
    targetArray.length = 0;

    if (Array.isArray(source)) {
      for (const item of source) {
        if (!item) continue;
        const time = Number(item.time);
        if (!Number.isFinite(time)) continue;
        const text = String(item.line || item.text || '').trim();
        if (!text) continue;
        targetArray.push({ time, text });
      }
      targetArray.sort((a, b) => a.time - b.time);
      return;
    }

    const text = String(source || '');
    const lines = text.split('\n');

    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed) continue;

      // –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ [ar:], [ti:], etc.
      if (/^$$[a-z]{2}:(.*)$$$/i.test(trimmed)) continue;

      // [mm:ss.xx]text  OR [mm:ss]text
      const m = trimmed.match(/^$$(\d{1,2}):(\d{2})(?:[.:](\d{1,3}))?$$(.*)$/);
      if (!m) continue;

      const mm = parseInt(m[1], 10);
      const ss = parseInt(m[2], 10);
      const fracRaw = m[3];
      const tail = String(m[4] || '').trim();

      if (!Number.isFinite(mm) || !Number.isFinite(ss)) continue;
      if (!tail) continue;

      let t = mm * 60 + ss;
      if (fracRaw) {
        const fracNum = parseInt(fracRaw, 10);
        if (Number.isFinite(fracNum)) {
          t += (fracRaw.length === 3) ? (fracNum / 1000) : (fracNum / 100);
        }
      }

      targetArray.push({ time: t, text: tail });
    }

    targetArray.sort((a, b) => a.time - b.time);
  }

  function parseLyrics(source) {
    const out = [];
    parseLyricsInto(source, out);
    currentLyrics = out;
  }

  function setLyricsAvailability(enabled) {
    const playerBlock = document.getElementById('lyricsplayerblock');
    if (!playerBlock) return;

    const lyricsWindow = playerBlock.querySelector('#lyrics-window');
    const lyricsBtn = playerBlock.querySelector('#lyrics-toggle-btn');
    const animBtn = playerBlock.querySelector('#animation-btn');
    const karaokeBtn = playerBlock.querySelector('#lyrics-text-btn');
    const bg = playerBlock.querySelector('.lyrics-animated-bg');
    const container = document.getElementById('lyrics');

    if (lyricsWindow) lyricsWindow.style.display = enabled ? '' : 'none';

    if (lyricsBtn) {
      lyricsBtn.classList.toggle('disabled', !enabled);
      lyricsBtn.setAttribute('aria-disabled', enabled ? 'false' : 'true');
      lyricsBtn.setAttribute('tabindex', enabled ? '0' : '-1');
      lyricsBtn.style.pointerEvents = enabled ? '' : 'none';
    }

    if (animBtn) {
      animBtn.classList.toggle('disabled', !enabled);
      animBtn.setAttribute('aria-disabled', enabled ? 'false' : 'true');
      animBtn.setAttribute('tabindex', enabled ? '0' : '-1');
      animBtn.style.pointerEvents = enabled ? '' : 'none';
    }

    if (karaokeBtn) {
      const track = w.playerCore?.getCurrentTrack?.();
      const hasFulltext = !!(track && track.fulltext);
      const hasTimedLyrics = enabled && hasTimedLyricsForCurrentTrack && currentLyrics.length > 0;
      const karaokeEnabled = hasFulltext || hasTimedLyrics;

      karaokeBtn.classList.toggle('disabled', !karaokeEnabled);
      karaokeBtn.style.pointerEvents = karaokeEnabled ? '' : 'none';
      karaokeBtn.style.opacity = karaokeEnabled ? '' : '0.4';
    }

    if (!enabled) {
      animationEnabled = false;
      if (bg) bg.classList.remove('active');
      if (animBtn) animBtn.classList.remove('active');

      lyricsViewMode = 'hidden';
      if (container) container.innerHTML = '';
    } else {
      lyricsViewMode = readLyricsViewMode();
      animationEnabled = readAnimationEnabled();

      if (animBtn) animBtn.classList.toggle('active', animationEnabled);
      if (bg) bg.classList.toggle('active', animationEnabled && lyricsViewMode !== 'hidden');
    }

    renderLyricsViewMode();
  }

  function renderLyricsViewMode() {
    const playerBlock = document.getElementById('lyricsplayerblock');
    if (!playerBlock) return;

    const lyricsWindow = playerBlock.querySelector('#lyrics-window');
    const btn = playerBlock.querySelector('#lyrics-toggle-btn');
    if (!lyricsWindow || !btn) return;

    lyricsWindow.classList.remove('lyrics-normal', 'lyrics-hidden', 'lyrics-expanded');
    btn.classList.remove('lyrics-normal', 'lyrics-hidden', 'lyrics-expanded');

    const cls = `lyrics-${lyricsViewMode}`;
    lyricsWindow.classList.add(cls);
    btn.classList.add(cls);

    const bg = playerBlock.querySelector('.lyrics-animated-bg');
    const animBtn = playerBlock.querySelector('#animation-btn');

    if (lyricsViewMode === 'hidden') {
      bg?.classList.remove('active');
      animBtn?.classList.remove('active');
    } else if (animationEnabled) {
      bg?.classList.add('active');
      animBtn?.classList.add('active');
    }
  }

  function renderLyrics(position) {
    const container = document.getElementById('lyrics');
    if (!container) return;

    if (!Array.isArray(currentLyrics) || currentLyrics.length === 0) {
      container.innerHTML = '<div class="lyrics-placeholder">–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
      return;
    }

    const firstLineTime = currentLyrics[0]?.time || 0;
    const COUNTDOWN_THRESHOLD = 5;

    const windowSize = (lyricsViewMode === 'expanded') ? 9 : 5;
    const centerLine = Math.floor(windowSize / 2);

    if (position < firstLineTime && firstLineTime > COUNTDOWN_THRESHOLD) {
      const remaining = firstLineTime - position;
      const secondsLeft = Math.ceil(remaining);

      if (remaining < 1) {
        container.innerHTML = `
          <div class="lyrics-countdown fade-out" style="opacity: ${remaining.toFixed(2)};">
            ${secondsLeft}
          </div>
        `;
        return;
      }

      container.innerHTML = `<div class="lyrics-countdown">${secondsLeft}</div>`;
      return;
    }

    let activeIdx = -1;
    for (let i = 0; i < currentLyrics.length; i++) {
      if (position >= currentLyrics[i].time) activeIdx = i;
      else break;
    }

    const start = Math.max(0, activeIdx - centerLine);
    const padTop = Math.max(0, centerLine - activeIdx);

    const rows = [];

    for (let p = 0; p < padTop; p++) rows.push('<div class="lyrics-window-line"></div>');

    for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
      const cls = (i === activeIdx) ? 'lyrics-window-line active' : 'lyrics-window-line';
      const text = currentLyrics[i]?.text || '';
      rows.push(`<div class="${cls}">${escapeHtml(text)}</div>`);
    }

    while (rows.length < windowSize) rows.push('<div class="lyrics-window-line"></div>');

    container.innerHTML = rows.join('');
  }

  function renderLyricsEnhanced(position, opts = {}) {
    const isHidden = (lyricsViewMode === 'hidden');
    if (isHidden) return;
    if (!!opts.inMiniMode) return;
    if (!Array.isArray(currentLyrics) || currentLyrics.length === 0) return;

    let activeIdx = -1;
    for (let i = 0; i < currentLyrics.length; i++) {
      if (position >= currentLyrics[i].time) activeIdx = i;
      else break;
    }

    const now = Date.now();
    if (activeIdx === lyricsLastIdx && (now - lyricsLastTs) < LYRICS_MIN_INTERVAL) return;

    lyricsLastIdx = activeIdx;
    lyricsLastTs = now;

    renderLyrics(position);
  }

  async function prefetchNextTrackLyrics() {
    prefetchedLyrics = null;
    prefetchedLyricsUrl = null;

    const pc = w.playerCore;
    if (!pc) return;

    const nextIndex = pc.getNextIndex?.();
    if (!Number.isFinite(nextIndex) || nextIndex < 0) return;

    const playlist = pc.getPlaylistSnapshot?.() || [];
    const nextTrack = playlist[nextIndex];
    if (!nextTrack || !nextTrack.lyrics) return;

    const lyricsUrl = String(nextTrack.lyrics || '').trim();
    if (!lyricsUrl) return;

    if (isLyrics404Cached(lyricsUrl)) return;

    const cacheKey = `lyrics_cache_${lyricsUrl}`;
    const cached = sessionStorage.getItem(cacheKey);

    if (cached) {
      try {
        const parsed = JSON.parse(cached);
        if (parsed && parsed !== '__NO_LYRICS__') {
          const temp = [];
          parseLyricsInto(parsed, temp);
          if (temp.length > 0) {
            prefetchedLyrics = temp;
            prefetchedLyricsUrl = lyricsUrl;
          }
        }
      } catch {}
      return;
    }

    try {
      const response = await fetch(lyricsUrl, {
        cache: 'force-cache',
        headers: { Accept: 'application/json, text/plain, */*' }
      });

      if (!response.ok) {
        if (response.status === 404) setLyrics404Cache(lyricsUrl);
        return;
      }

      const bodyText = await response.text();
      const format = detectLyricsFormat(lyricsUrl, bodyText);

      let dataToCache = bodyText;
      const tempLyrics = [];

      if (format === 'json') {
        try {
          const asJson = JSON.parse(bodyText);
          if (Array.isArray(asJson)) {
            dataToCache = asJson;
            parseLyricsInto(asJson, tempLyrics);
          }
        } catch {}
      } else {
        parseLyricsInto(bodyText, tempLyrics);
      }

      try { sessionStorage.setItem(cacheKey, JSON.stringify(dataToCache)); } catch {}

      if (tempLyrics.length > 0) {
        prefetchedLyrics = tempLyrics;
        prefetchedLyricsUrl = lyricsUrl;
      }
    } catch {}
  }

  async function loadLyrics(lyricsUrl) {
    currentLyrics = [];
    lyricsLastIdx = -1;

    hasTimedLyricsForCurrentTrack = false;

    const container = document.getElementById('lyrics');
    if (!container) return;

    if (!lyricsUrl) {
      const track = w.playerCore?.getCurrentTrack?.();
      if (!checkTrackHasLyrics(track)) {
        setLyricsAvailability(false);
        return;
      }
    }

    const url = String(lyricsUrl || '').trim();
    if (!url) {
      setLyricsAvailability(false);
      return;
    }

    if (isLyrics404Cached(url)) {
      setLyricsAvailability(false);
      return;
    }

    // prefetched
    if (prefetchedLyricsUrl === url && prefetchedLyrics !== null) {
      currentLyrics = prefetchedLyrics;
      prefetchedLyrics = null;
      prefetchedLyricsUrl = null;

      if (currentLyrics.length > 0) {
        hasTimedLyricsForCurrentTrack = true;
        setLyricsAvailability(true);
        renderLyricsViewMode();
      } else {
        setLyricsAvailability(false);
      }

      prefetchNextTrackLyrics();
      return;
    }

    // sessionStorage cache
    const cacheKey = `lyrics_cache_${url}`;
    const cached = sessionStorage.getItem(cacheKey);

    if (cached) {
      try {
        const parsed = JSON.parse(cached);

        if (parsed === null || parsed === '__NO_LYRICS__') {
          setLyricsAvailability(false);
          prefetchNextTrackLyrics();
          return;
        }

        parseLyrics(parsed);

        if (!Array.isArray(currentLyrics) || currentLyrics.length === 0) {
          setLyricsAvailability(false);
          prefetchNextTrackLyrics();
          return;
        }

        hasTimedLyricsForCurrentTrack = true;
        setLyricsAvailability(true);
        renderLyricsViewMode();
        prefetchNextTrackLyrics();
        return;
      } catch {
        try { sessionStorage.removeItem(cacheKey); } catch {}
      }
    }

    container.innerHTML = '<div class="lyrics-spinner"></div>';

    try {
      const response = await fetch(url, {
        cache: 'force-cache',
        headers: { Accept: 'application/json, text/plain, */*' }
      });

      if (!response.ok) {
        if (response.status === 404) setLyrics404Cache(url);
        setLyricsAvailability(false);
        prefetchNextTrackLyrics();
        return;
      }

      const contentType = response.headers.get('content-type') || '';
      const bodyText = await response.text();
      const format = detectLyricsFormat(url, bodyText);

      if (format === 'json' || contentType.includes('application/json')) {
        try {
          const asJson = JSON.parse(bodyText);
          if (!Array.isArray(asJson)) {
            try { sessionStorage.setItem(cacheKey, JSON.stringify('__NO_LYRICS__')); } catch {}
            setLyricsAvailability(false);
            prefetchNextTrackLyrics();
            return;
          }

          try { sessionStorage.setItem(cacheKey, JSON.stringify(asJson)); } catch {}
          parseLyrics(asJson);
        } catch {
          try { sessionStorage.setItem(cacheKey, JSON.stringify('__NO_LYRICS__')); } catch {}
          setLyricsAvailability(false);
          prefetchNextTrackLyrics();
          return;
        }
      } else {
        try { sessionStorage.setItem(cacheKey, JSON.stringify(bodyText)); } catch {}
        parseLyrics(bodyText);
      }

      if (!currentLyrics.length) {
        setLyricsAvailability(false);
        prefetchNextTrackLyrics();
        return;
      }

      hasTimedLyricsForCurrentTrack = true;
      setLyricsAvailability(true);
      renderLyricsViewMode();
      prefetchNextTrackLyrics();
    } catch {
      setLyricsAvailability(false);
      prefetchNextTrackLyrics();
    }
  }

  function onTrackChange(track) {
    // –¥–æ fetch: –±—ã—Å—Ç—Ä–æ –≤—ã—Å—Ç–∞–≤–ª—è–µ–º availability (—á—Ç–æ–±—ã –Ω–µ –º–∏–≥–∞–ª–æ)
    try {
      const has = checkTrackHasLyrics(track);
      const knownMissing = (!track?.lyrics) ? true : isLyricsKnownMissingFast(track.lyrics);

      if (!has || knownMissing) {
        hasTimedLyricsForCurrentTrack = false;
        setLyricsAvailability(false);
        return;
      }
    } catch {
      // –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–ø–∞–ª–æ ‚Äî –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º, –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å
    }

    loadLyrics(track?.lyrics).then(() => {
      if (hasTimedLyricsForCurrentTrack && lyricsViewMode !== 'hidden') {
        renderLyrics(0);
      }
    });
  }

  function toggleLyricsView() {
    const modes = ['normal', 'hidden', 'expanded'];
    const currentIndex = modes.indexOf(lyricsViewMode);
    const nextIndex = (currentIndex === -1 ? 0 : (currentIndex + 1) % modes.length);
    lyricsViewMode = writeLyricsViewMode(modes[nextIndex]);

    renderLyricsViewMode();

    const msgMap = {
      normal: 'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏',
      hidden: 'üö´ –õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞',
      expanded: 'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏'
    };
    const msg = msgMap[lyricsViewMode];
    if (msg && w.NotificationSystem?.info) w.NotificationSystem.info(msg);
  }

  function toggleAnimation() {
    if (lyricsViewMode === 'hidden') {
      w.NotificationSystem?.info('–õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      return;
    }

    animationEnabled = writeAnimationEnabled(!animationEnabled);

    const playerBlock = document.getElementById('lyricsplayerblock');
    const bg = playerBlock?.querySelector('.lyrics-animated-bg');
    const btn = document.getElementById('animation-btn');

    if (bg) bg.classList.toggle('active', animationEnabled);
    if (btn) btn.classList.toggle('active', animationEnabled);

    w.NotificationSystem?.info(animationEnabled ? '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏: –í–ö–õ' : '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏: –í–´–ö–õ');
  }

  function applyMiniMode() {
    // mini-mode –ø–æ –¥–∏–∑–∞–π–Ω—É —Å–∫—Ä—ã–≤–∞–µ—Ç lyrics UI –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é
    const playerBlock = document.getElementById('lyricsplayerblock');
    if (!playerBlock) return;

    const lyricsWindow = playerBlock.querySelector('#lyrics-window');
    if (lyricsWindow) {
      lyricsWindow.style.transition = 'none';
      lyricsWindow.style.display = 'none';
      setTimeout(() => {
        if (lyricsWindow) lyricsWindow.style.transition = '';
      }, 50);
    }

    const lyricsToggle = playerBlock.querySelector('.lyrics-toggle-btn');
    if (lyricsToggle) lyricsToggle.style.display = 'none';

    animationEnabled = false;
    const bg = playerBlock.querySelector('.lyrics-animated-bg');
    bg?.classList.remove('active');
    const animBtn = document.getElementById('animation-btn');
    if (animBtn) animBtn.classList.remove('active');
  }

  function restoreFromMiniMode(saved) {
    const playerBlock = document.getElementById('lyricsplayerblock');
    if (!playerBlock) return;

    const lyricsWindow = playerBlock.querySelector('#lyrics-window');
    if (lyricsWindow) {
      lyricsWindow.style.transition = 'none';
      lyricsWindow.style.display = '';
      setTimeout(() => {
        if (lyricsWindow) lyricsWindow.style.transition = '';
      }, 50);
    }

    const lyricsToggle = playerBlock.querySelector('.lyrics-toggle-btn');
    if (lyricsToggle) lyricsToggle.style.display = '';

    // –ï—Å–ª–∏ —É —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ –Ω–µ—Ç —Ç–∞–π–º–∫–æ–¥-–ª–∏—Ä–∏–∫–∏ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º hidden –∏ disabled
    if (!hasTimedLyricsForCurrentTrack) {
      lyricsViewMode = writeLyricsViewMode('hidden');
      animationEnabled = writeAnimationEnabled(false);
      setLyricsAvailability(false);
      return;
    }

    if (saved && saved.viewMode && (saved.viewMode === 'normal' || saved.viewMode === 'hidden' || saved.viewMode === 'expanded')) {
      lyricsViewMode = writeLyricsViewMode(saved.viewMode);
    } else {
      lyricsViewMode = readLyricsViewMode();
    }

    if (saved && typeof saved.animationEnabled === 'boolean') {
      animationEnabled = writeAnimationEnabled(saved.animationEnabled);
    } else {
      animationEnabled = readAnimationEnabled();
    }

    renderLyricsViewMode();
  }

  function restoreSettingsIntoDom() {
    lyricsViewMode = readLyricsViewMode();
    animationEnabled = readAnimationEnabled();
    renderLyricsViewMode();
  }

  function getState() {
    return {
      lyricsViewMode,
      animationEnabled,
      hasTimedLyricsForCurrentTrack
    };
  }

  function getMiniSaveState() {
    // —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∏ —É—Ö–æ–¥–µ –≤ mini-mode
    return {
      viewMode: (lyricsViewMode !== 'hidden') ? lyricsViewMode : 'normal',
      animationEnabled: !!animationEnabled
    };
  }

  w.LyricsController = {
    // state + getters
    getState,
    getCurrentLyrics() { return currentLyrics; },
    getCurrentLyricsLines() {
      return Array.isArray(currentLyrics)
        ? currentLyrics.map(l => ({ line: l.text }))
        : [];
    },

    // lifecycle
    restoreSettingsIntoDom,
    onTrackChange,
    onTick: renderLyricsEnhanced,

    // ui actions
    toggleLyricsView,
    toggleAnimation,

    // mini-mode helpers
    getMiniSaveState,
    applyMiniMode,
    restoreFromMiniMode,

    // util exposed for PlayerUI pre-check
    checkTrackHasLyrics,
    isLyricsKnownMissingFast,
  };
})();

//=================================================
// FILE: /scripts/app/track-registry.js
// scripts/app/track-registry.js
// –ì–ª–æ–±–∞–ª—å–Ω–æ-–ª—ë–≥–∫–∏–π —Ä–µ–µ—Å—Ç—Ä —Ç—Ä–µ–∫–æ–≤ –ø–æ uid, –±–µ–∑ –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.

const REG = new Map();
// shape: { uid, title, urlHi, urlLo, sizeHi, sizeLo, lyrics, fulltext, sourceAlbum? }

export function registerTrack(meta) {
  if (!meta || !meta.uid) return;
  const rec = {
    uid: meta.uid,
    title: meta.title || '',
    urlHi: meta.audio || meta.urlHi || null,
    urlLo: meta.audio_low || meta.urlLo || null,
    sizeHi: Number(meta.size || meta.sizeHi || 0),
    sizeLo: Number(meta.size_low || meta.sizeLo || 0),
    lyrics: meta.lyrics || null,
    fulltext: meta.fulltext || null,
    sourceAlbum: meta.sourceAlbum || null,
  };
  REG.set(rec.uid, rec);
}

export function getTrackByUid(uid) {
  return REG.get(uid) || null;
}

export function getAllUids() {
  return Array.from(REG.keys());
}

// –î–ª—è –æ—Ç–ª–∞–¥–∫–∏/–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
export const TrackRegistry = { registerTrack, getTrackByUid, getAllUids };

//=================================================
// FILE: /scripts/ci/lint-sw.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('service-worker.js');
if (!fs.existsSync(file)) {
  console.error('service-worker.js not found');
  process.exit(1);
}
const src = fs.readFileSync(file, 'utf8');

const errors = [];
const warns = [];

if (!/const\s+SW_VERSION\s*=\s*['"`]\d+\.\d+\.\d+['"`]/.test(src)) {
  errors.push('SW_VERSION is missing or has wrong format (x.y.z)');
}

const listeners = (name) => (src.match(new RegExp(`addEventListener\\(['"]${name}['"]`, 'g')) || []).length;
['install','activate','fetch'].forEach(ev => {
  const n = listeners(ev);
  if (n === 0) errors.push(`No ${ev} event listener`);
  if (n > 1) warns.push(`Multiple (${n}) ${ev} listeners`);
});

const consts = ['CORE_CACHE','RUNTIME_CACHE','MEDIA_CACHE','OFFLINE_CACHE','META_CACHE'];
consts.forEach(cn => {
  const n = (src.match(new RegExp(`\\bconst\\s+${cn}\\b`, 'g')) || []).length;
  if (n === 0) errors.push(`Missing const ${cn}`);
  if (n > 1) warns.push(`Duplicate const ${cn} (${n} times)`);
});

// –î–æ–ø.–ø—Ä–æ–≤–µ—Ä–∫–∏: DEFAULT_SW_CONFIG —á–∏—Å–ª–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã –∏ revalidateDays —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ
const cfgMatch = src.match(/const\s+DEFAULT_SW_CONFIG\s*=\s*\{([\s\S]*?)\};/);
if (cfgMatch) {
  const body = cfgMatch[1];
  const num = (key) => {
    const m = body.match(new RegExp(`${key}\\s*:\\s*([0-9]+(?:\\.[0-9]+)?)`));
    return m ? Number(m[1]) : null;
  };
  const revalidateDays = num('revalidateDays');
  if (!(Number.isInteger(revalidateDays) && revalidateDays > 0)) {
    errors.push('DEFAULT_SW_CONFIG.revalidateDays must be positive integer');
  }
  ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(k => {
    const v = num(k);
    if (!(typeof v === 'number' && v > 0)) errors.push(`DEFAULT_SW_CONFIG.${k} must be positive number`);
  });
}

if (warns.length) {
  console.warn('SW linter warnings:\n - ' + warns.join('\n - '));
}
if (errors.length) {
  console.error('SW linter errors:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Service Worker lint OK');


//=================================================
// FILE: /scripts/ci/validate-content.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const fail = (msg) => { console.error(msg); process.exit(2); };
const warn = (msg) => { console.warn(msg); };

// 1) albums.json –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
const albumsFile = path.resolve('albums.json');
if (!fs.existsSync(albumsFile)) fail('albums.json not found');
let albums;
try {
  const raw = fs.readFileSync(albumsFile, 'utf8');
  const j = JSON.parse(raw);
  if (!j || !Array.isArray(j.albums)) fail('albums.json: "albums" must be an array');
  albums = j.albums;
} catch (e) {
  fail('albums.json is not valid JSON: ' + e.message);
}
albums.forEach((a, i) => {
  if (!a.key || !a.title || !a.base) fail(`albums.json: album[${i}] must contain key/title/base`);
  if (typeof a.key !== 'string' || typeof a.title !== 'string' || typeof a.base !== 'string') {
    fail(`albums.json: album[${i}] key/title/base must be strings`);
  }
  if (!/^https?:\/\//i.test(a.base)) {
    fail(`albums.json: album[${i}].base must be absolute http(s) url`);
  }
  if (!/\/$/.test(a.base)) {
    warn(`albums.json: album[${i}].base should end with "/" (got: ${a.base})`);
  }
});

// 1.5) –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π –∞–ª—å–±–æ–º–æ–≤
{
  const keys = albums.map(a => a.key);
  const uniq = new Set(keys);
  if (uniq.size !== keys.length) {
    const dup = keys.filter((k, idx) => keys.indexOf(k) !== idx);
    fail(`albums.json: duplicate album keys: ${Array.from(new Set(dup)).join(', ')}`);
  }
}

// 2) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –≥–∞–ª–µ—Ä–µ–π –∏ index.json –Ω–∞–ª–∏—á–∏—è/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
const galleryRoot = path.resolve('albums/gallery');
const required = ['00','01','02','03','news'];
required.forEach(id => {
  const dir = path.join(galleryRoot, id);
  const idx = path.join(dir, 'index.json');
  if (!fs.existsSync(dir)) fail(`albums/gallery/${id} directory missing`);
  if (!fs.existsSync(idx)) fail(`albums/gallery/${id}/index.json missing`);
  try {
    const raw = fs.readFileSync(idx, 'utf8');
    const j = JSON.parse(raw);
    const items = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
    if (!Array.isArray(items)) fail(`albums/gallery/${id}/index.json: items must be array`);
    if (items.length === 0) warn(`albums/gallery/${id}/index.json: items is empty`);
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ)
    items.forEach((it, k) => {
      const check = (p) => {
        if (!p || /^https?:\/\//i.test(p)) return;
        const rel = p.replace(/^\.\//, '');
        const fp = path.resolve(rel);
        if (!fs.existsSync(fp)) warn(`Missing file referenced from gallery ${id} item[${k}]: ${p}`);
      };
      if (typeof it === 'string') check(it);
      else if (it && typeof it === 'object') {
        if (it.src) check(it.src);
        if (it.formats) Object.values(it.formats).forEach(check);
      }
    });
  } catch (e) {
    fail(`albums/gallery/${id}/index.json invalid JSON: ${e.message}`);
  }
});

// 3) custom.json sw –∫–æ–Ω—Ñ–∏–≥: revalidateDays —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
const customFile = path.resolve('custom.json');
if (fs.existsSync(customFile)) {
  try {
    const raw = fs.readFileSync(customFile, 'utf8');
    const j = JSON.parse(raw);
    if (j && j.sw) {
      const d = j.sw.revalidateDays;
      if (!(Number.isInteger(d) && d > 0)) {
        fail('custom.json.sw.revalidateDays must be positive integer');
      }
      ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(key => {
        const v = j.sw[key];
        if (!(typeof v === 'number' && v > 0)) fail(`custom.json.sw.${key} must be positive number`);
      });
      if (typeof j.sw.allowUnknownSize !== 'boolean') {
        fail('custom.json.sw.allowUnknownSize must be boolean');
      }
    }
  } catch (e) {
    fail('custom.json invalid JSON: ' + e.message);
  }
}
// 4) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å uid –≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö config.json (–ù–ï —Ñ–µ–π–ª–∏–º –±–∏–ª–¥ –∏–∑-–∑–∞ —Å–µ—Ç–∏)
{
  // Node 20: fetch –¥–æ—Å—Ç—É–ø–µ–Ω. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –µ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º.
  const hasFetch = typeof fetch === 'function';
  if (!hasFetch) {
    warn('fetch() is not available in this Node runtime; skip remote config.json uid checks');
  } else {
    for (const a of albums) {
      const base = a.base.endsWith('/') ? a.base : `${a.base}/`;
      const url = `${base}config.json`;

      try {
        const r = await fetch(url, { cache: 'no-cache' });
        if (!r.ok) {
          warn(`remote config.json not reachable for "${a.key}": HTTP ${r.status} (${url})`);
          continue;
        }

        const cfg = await r.json();
        const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : null;
        if (!tracks) {
          warn(`remote config.json "${a.key}": tracks must be array (${url})`);
          continue;
        }

        const seen = new Set();
        const dups = new Set();
        let missing = 0;

        for (const t of tracks) {
          const uid = String(t?.uid || '').trim();
          if (!uid) {
            missing++;
            continue;
          }
          if (seen.has(uid)) dups.add(uid);
          seen.add(uid);
        }

        if (missing > 0) {
          warn(`remote config.json "${a.key}": ${missing} track(s) have empty uid (${url})`);
        }
        if (dups.size > 0) {
          warn(`remote config.json "${a.key}": duplicate uid(s): ${Array.from(dups).join(', ')} (${url})`);
        }
      } catch (e) {
        warn(`remote config.json check failed for "${a.key}": ${e?.message || e} (${url})`);
      }
    }
  }
}

console.log('Content validation OK');

//=================================================
// FILE: /scripts/ci/validate-manifest.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('manifest.json');
if (!fs.existsSync(file)) {
  console.error('manifest.json not found');
  process.exit(1);
}
const raw = fs.readFileSync(file, 'utf8');
let json;
try {
  json = JSON.parse(raw);
} catch (e) {
  console.error('manifest.json is not valid JSON:', e.message);
  process.exit(1);
}
const errors = [];
function req(key) { if (!(key in json)) errors.push(`Missing key: ${key}`); }

req('name');
req('short_name');
req('start_url');
req('icons');

if (json.icons && !Array.isArray(json.icons)) {
  errors.push('icons must be an array');
}
if (Array.isArray(json.icons) && json.icons.length === 0) {
  errors.push('icons must contain at least one icon');
}
if (!json.display) errors.push('Missing key: display');
if (!json.theme_color) errors.push('Missing key: theme_color');
if (!json.background_color) errors.push('Missing key: background_color');

if (errors.length) {
  console.error('Manifest validation failed:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Manifest validation OK');

//=================================================
// FILE: /scripts/core/bootstrap.js
// scripts/core/bootstrap.js
// ‚≠ê –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –≤—Å–µ —ç–∫—Å–ø–æ—Ä—Ç—ã, async/await –æ–±—ë—Ä–Ω—É—Ç –≤ IIFE

(function() {
  'use strict';

  class AppBootstrap {
    constructor() {
      this.requiredFeatures = [
        'localStorage',
        'fetch',
        'Promise',
        'addEventListener'
      ];
    }

    async init() {
      console.log('üöÄ Bootstrapping application...');

      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      if (!this.checkCompatibility()) {
        console.error('‚ùå Browser compatibility check failed');
        return;
      }

      // 1.5. –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ Howler.js
      const howlerReady = await this.waitForHowler();
      if (!howlerReady) {
        console.error('‚ùå Howler.js loading timeout');
        return;
      }

      // 2. –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
      this.detectIOS();
      this.detectStandalone();

      // 3. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
      this.preventDefaultBehaviors();

      // 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      this.setupErrorHandling();

      // 5. ‚≠ê –ö–†–ò–¢–ò–ß–ù–û: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ albums.json
      await this.loadAlbumsIndex();

      console.log('‚úÖ Bootstrap complete');
    }

    async loadAlbumsIndex() {
      try {
        console.log('üìÄ Loading albums index...');
        
        const response = await fetch('./albums.json', { 
          cache: 'no-cache',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (!data || !Array.isArray(data.albums)) {
          throw new Error('Invalid albums.json format');
        }

        // ‚≠ê –ü—É–±–ª–∏–∫—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        window.albumsIndex = data.albums;

        console.log(`‚úÖ Albums index loaded: ${data.albums.length} albums`);
      } catch (error) {
        console.error('‚ùå Failed to load albums.json:', error);
        window.albumsIndex = [];
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤');
        }
      }
    }

    checkCompatibility() {
      const missing = [];

      if (!this.checkLocalStorage()) {
        missing.push('LocalStorage');
      }

      if (typeof fetch === 'undefined') {
        missing.push('Fetch API');
      }

      if (typeof Promise === 'undefined') {
        missing.push('Promises');
      }

      if (!document.addEventListener) {
        missing.push('Event Listeners');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ Web Audio API (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
      if (typeof AudioContext === 'undefined' && typeof webkitAudioContext === 'undefined') {
        console.warn('‚ö†Ô∏è Web Audio API not supported - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ MediaSession API (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)
      if (!('mediaSession' in navigator)) {
        console.warn('‚ö†Ô∏è Media Session API not supported - —Ñ–æ–Ω–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ');
      }

      // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Howler.js –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏
      // –£–±–∏—Ä–∞–µ–º –∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

      if (missing.length > 0) {
        this.showCompatibilityError(missing);
        return false;
      }

      return true;
    }
    async waitForHowler() {
      // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ Howler.js –º–∞–∫—Å–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥
      const maxAttempts = 50;
      let attempts = 0;

      while (typeof Howl === 'undefined' && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }

      if (typeof Howl === 'undefined') {
        console.error('‚ùå Howler.js failed to load');
        if (window.NotificationSystem) {
          window.NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ-–±–∏–±–ª–∏–æ—Ç–µ–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        }
        return false;
      }

      console.log('‚úÖ Howler.js loaded successfully');
      return true;
    }
    checkLocalStorage() {
      try {
        localStorage.setItem('__test', '1');
        localStorage.removeItem('__test');
        return true;
      } catch (e) {
        return false;
      }
    }

    showCompatibilityError(missing) {
      const errorHtml = `
        <div style="
          position: fixed;
          inset: 0;
          background: #181818;
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: center;
          font-family: sans-serif;
          padding: 20px;
          text-align: center;
          z-index: 99999;
        ">
          <div>
            <h1 style="color: #E80100; margin-bottom: 20px;">‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h1>
            <p style="margin-bottom: 15px;">–î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É—é—Ç—Å—è:</p>
            <ul style="list-style: none; padding: 0; margin-bottom: 20px;">
              ${missing.map(f => `<li style="margin: 5px 0;">‚ùå ${f}</li>`).join('')}
            </ul>
            <p style="color: #999;">–û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.</p>
          </div>
        </div>
      `;

      document.body.innerHTML = errorHtml;
    }

    detectIOS() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      if (isIOS) {
        document.body.classList.add('ios');
        console.log('üì± iOS detected');
      }
      return isIOS;
    }

    detectStandalone() {
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                          window.navigator.standalone === true;
      
      if (isStandalone) {
        document.body.classList.add('standalone');
        console.log('üì≤ PWA mode detected');
      }
      
      return isStandalone;
    }

    preventDefaultBehaviors() {
      document.body.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });

      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      document.addEventListener('contextmenu', (e) => {
        if (e.target.tagName === 'IMG' || e.target.closest('#cover-slot')) {
          e.preventDefault();
        }
      });
    }

    setupErrorHandling() {
      window.addEventListener('error', (e) => {
        console.error('üí• Global error:', e.error || e.message);
      });

      window.addEventListener('unhandledrejection', (e) => {
        console.error('üí• Unhandled promise rejection:', e.reason);
      });
    }
  }

  // ‚≠ê –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
      const bootstrap = new AppBootstrap();
      await bootstrap.init();
    });
  } else {
    const bootstrap = new AppBootstrap();
    bootstrap.init();
  }
})();

//=================================================
// FILE: /scripts/core/config.js
// scripts/core/config.js
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
export const APP_CONFIG = {
  // –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  APP_VERSION: '8.0.4',
  BUILD_DATE: '2025-11-08',
  // ‚úÖ –ü–†–û–ú–û–ö–û–î –î–õ–Ø –í–•–û–î–ê
  PROMOCODE: 'VITRINA2025',
  // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –∞–ª—å–±–æ–º–æ–≤
  ICON_ALBUMS_ORDER: [
    { key: '__favorites__', title: '‚≠ê‚≠ê‚≠ê–ò–ó–ë–†–ê–ù–ù–û–ï‚≠ê‚≠ê‚≠ê', icon: 'img/icon_album/icon-album-00.png' },
    { key: 'odnazhdy-v-skazke', title: '–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ', icon: 'img/icon_album/icon-album-03.png' },
    { key: 'golos-dushi', title: '–ì–æ–ª–æ—Å –î—É—à–∏', icon: 'img/icon_album/icon-album-02.png' },
    { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º', icon: 'img/icon_album/icon-album-01.png' },
    { key: 'krevetochka', title: '–ö–†–ï–í–ï—ÜTOCHKA', icon: 'img/icon_album/icon-album+00.png' },
    { key: '__reliz__', title: '–ù–û–í–û–°–¢–ò', icon: 'img/icon_album/icon-album-news.png' }
  ],
  // –ö–ª—é—á–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤
  SPECIAL_FAVORITES_KEY: '__favorites__',
  SPECIAL_RELIZ_KEY: '__reliz__',
  // –°—Å—ã–ª–∫–∏
  SUPPORT_URL: 'https://example.com/support',
  SUPPORT_EMAIL: 'support@vitrina-razbita.ru',
  GITHUB_URL: 'https://github.com/apel-s-in/vi3na1bita-music',
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–µ—Ä–∞
  PLAYER_SETTINGS: {
    defaultVolume: 1.0,
    crossfade: false,
    preload: true
  },
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  CACHE_VERSION: 'v1.0.0',
  CACHE_AUDIO: false, // –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –ª–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã
  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  ANALYTICS_ENABLED: false,
  ANALYTICS_ID: null,
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
  CENTRAL_GALLERY_BASE: './albums/gallery/',
  // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞–ª—å–±–æ–º–æ–≤
  PUBLISHED_ALBUM_KEYS: new Set(['odnazhdy-v-skazke', 'golos-dushi', 'mezhdu-zlom-i-dobrom', 'krevetochka'])
};

// –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
if (typeof window !== 'undefined') {
  window.APP_CONFIG = APP_CONFIG;
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  window.SPECIAL_FAVORITES_KEY = APP_CONFIG.SPECIAL_FAVORITES_KEY;
  window.SPECIAL_RELIZ_KEY = APP_CONFIG.SPECIAL_RELIZ_KEY;
  window.ICON_ALBUMS_ORDER = APP_CONFIG.ICON_ALBUMS_ORDER;
  window.CENTRAL_GALLERY_BASE = APP_CONFIG.CENTRAL_GALLERY_BASE;
}

//=================================================
// FILE: /scripts/core/utils.js
// scripts/core/utils.js ‚Äî –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
(function() {
  'use strict';
  
  const Utils = {
    $(id) {
      return document.getElementById(id);
    },
    
    $q(sel) {
      return document.querySelector(sel);
    },
    
    $qa(sel) {
      return document.querySelectorAll(sel);
    },
    
    escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    },
    
    formatTime(s) {
      if (isNaN(s) || s < 0) return '--:--';
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60);
      return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    },
    
    async waitFor(fn, maxMs = 2000, step = 50) {
      let t = 0;
      while (!fn() && t < maxMs) {
        await new Promise(r => setTimeout(r, step));
        t += step;
      }
      return fn();
    },
    
    createModal(html, onClose) {
      const bg = document.createElement('div');
      bg.className = 'modal-bg active';
      bg.innerHTML = html;

      const close = () => {
        bg.remove();
        if (onClose) onClose();
      };

      bg.addEventListener('click', (e) => {
        if (e.target === bg) close();
      });

      const closeBtn = bg.querySelector('.bigclose');
      if (closeBtn) {
        closeBtn.addEventListener('click', close);
      }

      // ‚úÖ –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–æ–¥–∞–ª–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ fallback –≤ body.
      const host = document.getElementById('modals-container') || document.body;
      host.appendChild(bg);

      return bg;
    },
    
    isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    },
    
    isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    },
    
    isStandalone() {
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    }
  };

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
  window.Utils = Utils;
  
  console.log('‚úÖ Utils loaded');
})();

//=================================================
// FILE: /scripts/e2e/favorites.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import { loginByPromo, likeFirstTrack, openFavorites, playFirstTrack } from './utils.js';

test('favorites UI builds and plays from favorites list', async ({ page }) => {
  await loginByPromo(page);

  await likeFirstTrack(page);
  await openFavorites(page);
  const favCount = await page.locator('#track-list .track').count();
  expect(favCount).toBeGreaterThan(0);

  // –ö–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
});

test('toggle star in favorites updates row state and localStorage (uid-based)', async ({ page }) => {
  await loginByPromo(page);

  // –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –æ—Ç–º–µ—Ç–∏–º —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // –í–æ–π—Ç–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const favRow = page.locator('#track-list .track').first();
  const favId = await favRow.getAttribute('id'); // —Ñ–æ—Ä–º–∞—Ç fav_{albumKey}_{uid}
  expect(favId).toMatch(/^fav_/);

  // –°–Ω–∏–º–µ–º –∑–≤–µ–∑–¥—É ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–µ—Ç .inactive –∏ uid –ø—Ä–æ–ø–∞–¥—ë—Ç –∏–∑ likedTrackUids:v1
  await favRow.locator('.like-star').click();
  await expect(favRow).toHaveClass(/inactive/);

  // –ü—Ä–æ–≤–µ—Ä–∏–º localStorage: likedTrackUids:v1 –±–æ–ª—å—à–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç–æ—Ç uid –≤ –º–∞—Å—Å–∏–≤–µ —Å—Ç—Ä–æ–∫
  const { albumKey, uid, present } = await page.evaluate((id) => {
    const m = String(id || '').match(/^fav_(.+)_(.+)$/);
    const a = m ? m[1] : '';
    const u = m ? m[2] : '';
    const raw = localStorage.getItem('likedTrackUids:v1');
    const map = raw ? JSON.parse(raw) : {};
    const arr = Array.isArray(map[a]) ? map[a] : [];
    return { albumKey: a, uid: u, present: arr.includes(u) };
  }, favId);

  expect(albumKey).toBeTruthy();
  expect(uid).toBeTruthy();
  expect(present).toBeFalsy();
});

test('favorites view: add to favorites, play and verify mini-mode when browsing other album', async ({ page }) => {
  await loginByPromo(page);

  await likeFirstTrack(page);
  await openFavorites(page);

  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  const otherIcon = page
    .locator('.album-icon')
    .filter({ hasNot: page.locator('[data-akey="__favorites__"]') })
    .nth(1);
  await otherIcon.click();

  await expect(page.locator('#mini-now')).toBeVisible();
});

// –î–æ–ø. —Ç–µ—Å—Ç: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (PlayerState.applyState)
test('reload restores state via PlayerState.applyState', async ({ page }) => {
  await loginByPromo(page);
  await playFirstTrack(page);

  // ‚úÖ –°–∏–¥–∏—Ä—É–µ–º state —Ç–æ–ª—å–∫–æ V2/uid
  await page.evaluate(() => {
    const pc = window.playerCore;
    const track = pc?.getCurrentTrack?.() || null;
    const albumKey = window.AlbumsManager?.getPlayingAlbum?.() || null;

    const st = {
      album: albumKey,
      currentAlbum: window.AlbumsManager?.getCurrentAlbum?.() || albumKey,
      trackUid: String(track?.uid || '').trim() || null,
      sourceAlbum: String(track?.sourceAlbum || '').trim() || null,
      trackIndex: typeof pc?.getIndex === 'function' ? (pc.getIndex() || 0) : 0,
      position: Math.floor(pc?.getPosition?.() || 5),
      volume: typeof pc?.getVolume === 'function' ? (pc.getVolume() ?? 100) : 100,
      wasPlaying: true
    };

    localStorage.setItem('playerStateV2', JSON.stringify(st));
  });

  await page.reload({ waitUntil: 'load' });
  await loginByPromo(page);

  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getPosition?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç setSinkId: —Å–∫–∏–ø, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
test('optional audio output setSinkId (skip when unsupported)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  const supported = await page.evaluate(() => {
    const dest = (window.Howler && window.Howler.ctx && window.Howler.ctx.destination) ? window.Howler.ctx.destination : null;
    return !!(dest && typeof dest.setSinkId === 'function' && navigator.mediaDevices);
  });
  // –ù–∏—á–µ–≥–æ –Ω–µ –∞—Å—Å–µ—Ä—Ç–∏–º: —Ç–µ—Å—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π.
});

test('sysinfo modal shows after GET_SW_INFO', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –ñ–¥—ë–º –∏–Ω–∏ SW
  await page.waitForTimeout(800);
  const sysbtn = page.locator('#sysinfo-btn');
  await expect(sysbtn).toBeVisible({ timeout: 5000 });
  await sysbtn.click();

  const modal = page.locator('.modal-bg .modal-feedback').filter({ hasText: '–û —Å–∏—Å—Ç–µ–º–µ' });
  await expect(modal).toBeVisible({ timeout: 5000 });
  await expect(modal).toContainText(/SW –≤–µ—Ä—Å–∏—è:/);
});

// –ù–æ–≤—ã–π —Ç–µ—Å—Ç: –±—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏ Prev/Next —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ ‚Äî –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç legacy <audio>
test('quick prev/next uses PlayerCore only (no legacy audio starts)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  await page.evaluate(async () => {
    await new Promise(r => setTimeout(r, 50));
    window.PlayerControls && window.PlayerControls.previousTrack && window.PlayerControls.previousTrack();
    window.PlayerControls && window.PlayerControls.nextTrack && window.PlayerControls.nextTrack();
  });

  const res = await page.evaluate(() => ({
    hasPc: !!window.playerCore,
    hasAudioEl: !!document.getElementById('audio')
  }));
  expect(res.hasPc).toBeTruthy();
  expect(res.hasAudioEl).toBeFalsy();
});

test('SW update flow persists state and restores after reload', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');
  await page.waitForTimeout(200);
  await page.evaluate(() => {
    if (window.playerCore && typeof window.playerCore.play === 'function') {
      window.playerCore.play(0);
      try { window.playerCore.seek(7); } catch {}
    }
  });

  await page.evaluate(() => {
    window.confirm = () => true;
    const evt = new MessageEvent('message', { data: { type: 'SW_VERSION', version: '9.9.9' } });
    try { window.dispatchEvent(evt); } catch {}
  });

  const hasResume = await page.evaluate(() => !!sessionStorage.getItem('resumeAfterReloadV2'));
  expect(hasResume).toBeTruthy();

  await page.reload({ waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getPosition?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

// –ù–û–í–´–ô –¢–ï–°–¢: —Å–Ω—è–ª –∑–≤–µ–∑–¥—É —É —Ç–µ–∫—É—â–µ–≥–æ –≤ —Ä–µ–∂–∏–º–µ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ ‚Üí next() –∏ UI –æ–±–Ω–æ–≤–∏–ª—Å—è
test('favorites playing: removing star of current track triggers next and updates UI', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –û—Ç–º–µ—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π –≤ –∞–ª—å–±–æ–º–µ
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // –û—Ç–∫—Ä–æ–µ–º ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª –∏ –∑–∞–ø—É—Å—Ç–∏–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Ç—Ä–µ–∫–∞
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const favFirst = page.locator('#track-list .track').first();
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // –°–Ω–∏–º–µ–º –∑–≤–µ–∑–¥—É –Ω–∞ —ç—Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ
  const beforeIdx = await page.evaluate(() => (window.playerCore?.getIndex?.() ?? window.playingTrack ?? 0));
  await favFirst.locator('.like-star').click();

  // –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
  await page.waitForTimeout(300);
  const afterIdx = await page.evaluate(() => (window.playerCore?.getIndex?.() ?? window.playingTrack ?? 0));
  expect(afterIdx).not.toBe(beforeIdx);

  // –°—Ç—Ä–æ–∫–∞ —Å—Ç–∞–ª–∞ inactive, –∞ –∫–ª–∞—Å—Å .current –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –¥—Ä—É–≥–æ–π —ç–ª–µ–º–µ–Ω—Ç
  await expect(favFirst).toHaveClass(/inactive/);
  const currentCount = await page.locator('#track-list .track.current').count();
  expect(currentCount).toBe(1);

  // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –º–∏–Ω–∏-—Ä–µ–∂–∏–º –≤–æ–∑–º–æ–∂–µ–Ω ‚Äî ¬´–î–∞–ª–µ–µ¬ª/–º–∏–Ω–∏-—à–∞–ø–∫–∞ –æ–±–Ω–æ–≤—è—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ (–Ω–µ —Å—Ç—Ä–æ–≥–æ –∞—Å—Å–µ—Ä—Ç–∏–º –≤–∏–¥–∏–º–æ—Å—Ç—å)
  await page.evaluate(() => {
    window.PlayerUI && window.PlayerUI.updateNextUpLabel && window.PlayerUI.updateNextUpLabel();
    window.PlayerUI && window.PlayerUI.updateMiniHeader && window.PlayerUI.updateMiniHeader();
  });
});

test('mini-player star toggles favorite in __favorites__ and syncs with list (uid-based)', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });

  // –í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // 1. –û—Ç–º–µ—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã–π –≤ –∞–ª—å–±–æ–º–Ω–æ–º —Å–ø–∏—Å–∫–µ
  const firstAlbumRow = page.locator('#track-list .track').first();
  await firstAlbumRow.hover();
  await firstAlbumRow.locator('.like-star').click();

  // 2. –ü–µ—Ä–µ–π–¥—ë–º –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª –∏ –∑–∞–ø—É—Å—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const favFirst = page.locator('#track-list .track').first();
  const favId = await favFirst.getAttribute('id'); // fav_{albumKey}_{uid}
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // 3. –ü–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏–ª—Å—è mini-—Ä–µ–∂–∏–º
  const otherIcon = page
    .locator('.album-icon')
    .filter({ hasNot: page.locator('[data-akey="__favorites__"]') })
    .nth(1);
  await otherIcon.click();

  // –ú–∏–Ω–∏-–ø–ª–µ–µ—Ä –≤–∏–¥–∏–º
  const miniStar = page.locator('#mini-now-star');
  await expect(page.locator('#mini-now')).toBeVisible({ timeout: 5000 });
  await expect(miniStar).toBeVisible();

  // 4. –ù–∞–∂–º—ë–º –∑–≤–µ–∑–¥—É –≤ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä–µ (toggleLikePlaying)
  await miniStar.click();
  await page.waitForTimeout(200);

  // 5. –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ favorites-—Å–ø–∏—Å–∫–µ –∏ likedTrackUids:v1 —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å
  await page.click('.album-icon[data-akey="__favorites__"]');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const favRowAfter = page.locator(`#${favId}`);
  const starAfter = favRowAfter.locator('.like-star');

  const { albumKey, uid, present } = await page.evaluate((favRowId) => {
    const m = String(favRowId || '').match(/^fav_(.+)_(.+)$/);
    const a = m ? m[1] : '';
    const u = m ? m[2] : '';
    const raw = localStorage.getItem('likedTrackUids:v1');
    const map = raw ? JSON.parse(raw) : {};
    const arr = Array.isArray(map[a]) ? map[a] : [];
    return { albumKey: a, uid: u, present: arr.includes(u) };
  }, favId);

  expect(albumKey).toBeTruthy();
  expect(uid).toBeTruthy();

  await expect(starAfter).toBeVisible();
  if (present) {
    await expect(favRowAfter).not.toHaveClass(/inactive/);
  } else {
    await expect(favRowAfter).toHaveClass(/inactive/);
  }
});

//=================================================
// FILE: /scripts/e2e/player.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import {
  loginByPromo,
  likeFirstTrack,
  openFavorites,
  playFirstTrack,
  seedPlayerStateV2FromCurrent
} from './utils.js';

test('play track, toggle favorites-only and sleep timer UI', async ({ page }) => {
  await loginByPromo(page);
  await expect(page.locator('#main-block')).toBeVisible();

  // –î–æ–∂–¥–∞—Ç—å—Å—è —Å–ø–∏—Å–∫–∞ –∞–ª—å–±–æ–º–æ–≤ –∏ –∫–ª–∏–∫ –ø–æ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ —Ç—Ä–µ–∫–ª–∏—Å—Ç–∞
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  const firstTrack = page.locator('#track-list .track').first();
  await firstTrack.click();

  // –ü–æ—è–≤–∏–ª—Å—è –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞ –∏ –∫–Ω–æ–ø–∫–∞ Play/Pause –µ—Å—Ç—å
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
  await expect(page.locator('#play-pause-icon')).toBeVisible();

  // –í–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä "—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ" (–∫–Ω–æ–ø–∫–∞ –≤ –ø–ª–µ–µ—Ä–µ)
  await page.click('#favorites-btn');
  const favBtn = page.locator('#favorites-btn');
  await expect(favBtn).toHaveClass(/favorites-active/);

  // –¢–∞–π–º–µ—Ä —Å–Ω–∞: –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –∏ –≤—ã–±—Ä–∞—Ç—å "15 –º–∏–Ω—É—Ç", –∑–∞—Ç–µ–º –≤—ã–∫–ª—é—á–∏—Ç—å
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("15 –º–∏–Ω—É—Ç")');
  // –ë–µ–π–¥–∂ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è
  await expect(page.locator('#sleep-timer-badge')).toBeVisible();
  // –í—ã–∫–ª—é—á–∏–º
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("–í—ã–∫–ª—é—á–∏—Ç—å")');
  await expect(page.locator('#sleep-timer-badge')).toBeHidden();
});

test('favorites view: add to favorites, play and verify mini-mode when browsing other album', async ({ page }) => {
  await loginByPromo(page);

  await likeFirstTrack(page);
  await openFavorites(page);
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Ç–æ—Ä–æ–π –∑–Ω–∞—á–æ–∫, –Ω–µ Favorites –∏ –Ω–µ News)
  const otherIcon = page
    .locator('.album-icon')
    .filter({ hasNot: page.locator('[data-akey="__favorites__"]') })
    .nth(1);
  await otherIcon.click();

  await expect(page.locator('#mini-now')).toBeVisible();
});

// –î–æ–ø. —Ç–µ—Å—Ç: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (PlayerState.applyState)
test('reload restores state via PlayerState.applyState', async ({ page }) => {
  await loginByPromo(page);
  await playFirstTrack(page);

  // –°–æ—Ö—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Ä—É—á–Ω—É—é (—ç–º—É–ª–∏—Ä—É–µ–º PlayerState.save), –Ω–æ —É–∂–µ –≤ V2/uid-—Ñ–æ—Ä–º–∞—Ç–µ
  await seedPlayerStateV2FromCurrent(page, { position: 5, wasPlaying: true });

  await page.reload({ waitUntil: 'load' });
  await loginByPromo(page);

  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getPosition?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç setSinkId: —Å–∫–∏–ø, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
test('optional audio output setSinkId (skip when unsupported)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  const supported = await page.evaluate(() => {
    const dest = (window.Howler && window.Howler.ctx && window.Howler.ctx.destination) ? window.Howler.ctx.destination : null;
    return !!(dest && typeof dest.setSinkId === 'function' && navigator.mediaDevices);
  });
  // –ù–∏—á–µ–≥–æ –Ω–µ –∞—Å—Å–µ—Ä—Ç–∏–º: —Ç–µ—Å—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π. –ü—Ä–æ—Å—Ç–æ –Ω–µ –ø–∞–¥–∞–µ–º.
});

test('sysinfo modal shows after GET_SW_INFO', async ({ page }) => {
  const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –ñ–¥—ë–º –∏–Ω–∏ SW
  await page.waitForTimeout(800);
  // –ö–Ω–æ–ø–∫–∞ ¬´–û –°–ò–°–¢–ï–ú–ï¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ desktop
  const sysbtn = page.locator('#sysinfo-btn');
  await expect(sysbtn).toBeVisible({ timeout: 5000 });
  await sysbtn.click();

  // –ü–æ—è–≤–ª—è–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–∞
  const modal = page.locator('.modal-bg .modal-feedback').filter({ hasText: '–û —Å–∏—Å—Ç–µ–º–µ' });
  await expect(modal).toBeVisible({ timeout: 5000 });

  // –í –º–æ–¥–∞–ª–∫–µ –µ—Å—Ç—å –≤–µ—Ä—Å–∏—è SW
  await expect(modal).toContainText(/SW –≤–µ—Ä—Å–∏—è:/);
});

// –ù–æ–≤—ã–π —Ç–µ—Å—Ç: –±—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏ Prev/Next —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ ‚Äî –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç legacy <audio>
test('quick prev/next uses PlayerCore only (no legacy audio starts)', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');

  // –ë—ã—Å—Ç—Ä–æ –≤—ã–∑–æ–≤–µ–º prev/next —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–π API
  await page.evaluate(async () => {
    // –í–æ–∑–º–æ–∂–Ω–∞ –ª–µ–Ω—Ç–∏–≤–∫–∞ –∞–¥–∞–ø—Ç–µ—Ä–∞ ‚Äî –ø–æ–¥–æ–∂–¥—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ
    await new Promise(r => setTimeout(r, 50));
    window.PlayerControls && window.PlayerControls.previousTrack && window.PlayerControls.previousTrack();
    window.PlayerControls && window.PlayerControls.nextTrack && window.PlayerControls.nextTrack();
  });

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º: PlayerCore –µ—Å—Ç—å, legacy <audio> –Ω–µ —Å–æ–∑–¥–∞–Ω
  const res = await page.evaluate(() => ({
    hasPc: !!window.playerCore,
    hasAudioEl: !!document.getElementById('audio')
  }));
  expect(res.hasPc).toBeTruthy();
  expect(res.hasAudioEl).toBeFalsy();
});

// –ù–æ–≤—ã–π —Ç–µ—Å—Ç: –∏–º–∏—Ç–∏—Ä—É–µ–º SW_VERSION ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è state, –ø–æ—Å–ª–µ reload –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
test('SW update flow persists state and restores after reload', async ({ page }) => {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
  await page.click('#track-list .track >> nth=0');
  // –ù–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥—ë–º –∏ —É—Å—Ç–∞–Ω–æ–≤–∏–º –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ PlayerCore (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
  await page.waitForTimeout(200);
  await page.evaluate(() => {
    if (window.playerCore && typeof window.playerCore.play === 'function') {
      window.playerCore.play(0);
      try { window.playerCore.seek(7); } catch {}
    }
  });

  // ‚úÖ –ï–î–ò–ù–´–ô —Å–ø–æ—Å–æ–± —Å–∏–º—É–ª—è—Ü–∏–∏ SW-message: window.dispatchEvent
  await page.evaluate(() => {
    window.confirm = () => true;
    const evt = new MessageEvent('message', { data: { type: 'SW_VERSION', version: '9.9.9' } });
    try { window.dispatchEvent(evt); } catch {}
  });

  // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Å—Ç–µ–π—Ç –¥–ª—è —Ä–µ—é–º–∞ –∑–∞–ø–∏—Å–∞–Ω (V2)
  const hasResume = await page.evaluate(() => !!sessionStorage.getItem('resumeAfterReloadV2'));
  expect(hasResume).toBeTruthy();

  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Å–Ω–æ–≤–∞ –ø—Ä–æ–π–¥—ë–º –ø—Ä–æ–º–æ
  await page.reload({ waitUntil: 'load' });
  await page.fill('#promo-inp', 'VITRINA2025');
  await page.click('#promo-btn');

  // –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏—è –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å ¬´—Å –Ω—É–ª—è¬ª
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getPosition?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

test('favoritesOnly: unliking current track switches to next (no stop)', async ({ page }) => {
  await loginByPromo(page);

  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // –õ–∞–π–∫–Ω–µ–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∏ –∑–∞–ø—É—Å—Ç–∏–º –µ–≥–æ
  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // –í–∫–ª—é—á–∏–º favoritesOnly
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  const before = await page.evaluate(() => ({
    playing: !!window.playerCore?.isPlaying?.(),
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  // –°–Ω–∏–º–µ–º –ª–∞–π–∫ —Å —Ç–µ–∫—É—â–µ–≥–æ (—á–µ—Ä–µ–∑ –º–∏–Ω–∏/–∑–≤–µ–∑–¥—É —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—â–µ: –∫–ª–∏–∫ –ø–æ –∑–≤–µ–∑–¥–µ –≤ —Å—Ç—Ä–æ–∫–µ)
  await firstRow.locator('.like-star').click();

  // –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–π (–∏–ª–∏ —Ö–æ—Ç—è –±—ã –∏–∑–º–µ–Ω–∏—Ç—å—Å—è uid/index), –ø—Ä–∏ —ç—Ç–æ–º –ù–ï stop.
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => ({
    playing: !!window.playerCore?.isPlaying?.(),
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  expect(after.playing).toBeTruthy();
  expect(after.uid).not.toBe(before.uid);
});

test('repeat has priority: favoritesOnly + repeat + unliking current keeps repeating', async ({ page }) => {
  await loginByPromo(page);

  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // repeat ON
  await page.click('#repeat-btn');
  await expect(page.locator('#repeat-btn')).toHaveClass(/active/);

  const before = await page.evaluate(() => ({
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || ''),
    repeat: !!window.playerCore?.isRepeat?.()
  }));
  expect(before.repeat).toBeTruthy();

  // –°–Ω–∏–º–µ–º –ª–∞–π–∫ —Å —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
  await firstRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  // –ü–æ –ø—Ä–∞–≤–∏–ª—É: repeat –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –Ω–∞ —Ç–æ–º –∂–µ —Ç—Ä–µ–∫–µ
  const after = await page.evaluate(() => ({
    idx: window.playerCore?.getIndex?.() ?? -1,
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  expect(after.uid).toBe(before.uid);
});

test('favoritesOnly + shuffle: liking another track adds it to tail of queue', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const rows = page.locator('#track-list .track');
  const firstRow = rows.nth(0);
  const secondRow = rows.nth(1);

  // –õ–∞–π–∫–Ω–µ–º 1-–π —Ç—Ä–µ–∫ –∏ –∑–∞–ø—É—Å—Ç–∏–º
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // shuffle ON
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  // –ó–∞–ø–æ–º–Ω–∏–º –¥–ª–∏–Ω—É –ø–ª–µ–π–ª–∏—Å—Ç–∞
  const beforeLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  // –õ–∞–π–∫–Ω–µ–º –≤—Ç–æ—Ä–æ–π —Ç—Ä–µ–∫ (–¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏)
  await secondRow.hover();
  await secondRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => {
    const snap = window.playerCore?.getPlaylistSnapshot?.() || [];
    const tail = snap.length ? snap[snap.length - 1] : null;
    return {
      len: snap.length,
      tailUid: String(tail?.uid || '').trim(),
      likedUids: window.FavoritesManager?.getLikedUidsForAlbum?.(window.AlbumsManager?.getPlayingAlbum?.() || '') || []
    };
  });

  expect(after.len).toBeGreaterThanOrEqual(beforeLen);
  expect(after.likedUids.includes(after.tailUid)).toBeTruthy();
});

test('shuffle history: next-next-prev returns to previously played track', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  // –ó–∞–ø—É—Å—Ç–∏–º –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫
  await page.click('#track-list .track >> nth=0');

  // –í–∫–ª—é—á–∏–º shuffle
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  const first = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#next-btn');
  await page.waitForTimeout(200);
  const second = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#next-btn');
  await page.waitForTimeout(200);
  const third = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#prev-btn');
  await page.waitForTimeout(200);
  const back = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  expect(first).toBeTruthy();
  expect(second).toBeTruthy();
  expect(third).toBeTruthy();
  expect(back).toBe(second);
});

test('favoritesOnly + shuffle: unliking NOT current removes it from tail if not played yet', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForSelector('#track-list .track', { timeout: 10000 });

  const rows = page.locator('#track-list .track');
  const firstRow = rows.nth(0);
  const secondRow = rows.nth(1);

  // –õ–∞–π–∫–∞–µ–º 1 –∏ 2 —Ç—Ä–µ–∫
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await secondRow.hover();
  await secondRow.locator('.like-star').click();

  // –ó–∞–ø—É—Å–∫–∞–µ–º 1-–π
  await firstRow.click();

  // favoritesOnly ON
  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  // shuffle ON
  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  // –¢–µ–ø–µ—Ä—å –ø–ª–µ–π–ª–∏—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 2 —Ç—Ä–µ–∫–∞ (–∏–ª–∏ –±–æ–ª—å—à–µ, –µ—Å–ª–∏ already), —Ñ–∏–∫—Å–∏—Ä—É–µ–º –¥–ª–∏–Ω—É
  const beforeLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  // –°–Ω–∏–º–∞–µ–º –ª–∞–π–∫ —Å–æ 2-–≥–æ —Ç—Ä–µ–∫–∞ (–ù–ï —Ç–µ–∫—É—â–µ–≥–æ)
  await secondRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const afterLen = await page.evaluate(() => (window.playerCore?.getPlaylistSnapshot?.() || []).length);

  expect(afterLen).toBeLessThanOrEqual(beforeLen);
});

//=================================================
// FILE: /scripts/e2e/utils.js
// @ts-check
/**
 * scripts/e2e/utils.js
 * –û–±—â–∏–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è Playwright e2e, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤ spec-—Ñ–∞–π–ª–∞—Ö.
 */

export const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';

export async function loginByPromo(page, promo = 'VITRINA2025') {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', promo);
  await page.click('#promo-btn');
  await page.waitForSelector('#main-block:not(.hidden)', { timeout: 10000 });
}

export async function waitTracks(page) {
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
}

export async function likeFirstTrack(page) {
  await waitTracks(page);
  const first = page.locator('#track-list .track').first();
  await first.hover();
  await first.locator('.like-star').click();
}

export async function openFavorites(page) {
  await page.click('.album-icon[data-akey="__favorites__"]');
  await waitTracks(page);
}

export async function playFirstTrack(page) {
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
}

/**
 * –ó–∞–ø–∏—Å–∞—Ç—å PlayerState –≤ localStorage –≤ uid-—Ñ–æ—Ä–º–∞—Ç–µ (V2).
 * –ë–µ—Ä—ë–º playingAlbum –∏–∑ AlbumsManager, –∞ uid/sourceAlbum –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞.
 */
export async function seedPlayerStateV2FromCurrent(page, opts = {}) {
  const position = typeof opts.position === 'number' ? opts.position : 5;
  const wasPlaying = typeof opts.wasPlaying === 'boolean' ? opts.wasPlaying : true;

  await page.evaluate(({ position, wasPlaying }) => {
    const pc = window.playerCore;
    const track = pc?.getCurrentTrack?.() || null;

    const albumKey = window.AlbumsManager?.getPlayingAlbum?.() || null;

    const st = {
      album: albumKey,
      currentAlbum: window.AlbumsManager?.getCurrentAlbum?.() || albumKey,
      trackUid: String(track?.uid || '').trim() || null,
      sourceAlbum: String(track?.sourceAlbum || '').trim() || null,
      trackIndex: typeof pc?.getIndex === 'function' ? (pc.getIndex() || 0) : 0,
      position: Math.floor(position),
      volume: typeof pc?.getVolume === 'function' ? (pc.getVolume() ?? 100) : 100,
      wasPlaying: !!wasPlaying
    };

    localStorage.setItem('playerStateV2', JSON.stringify(st));
  }, { position, wasPlaying });
}

//=================================================
// FILE: /scripts/offline/cache-db.js
// scripts/offline/cache-db.js
// IndexedDB —Å–ª–æ–π (CQ bytes) ‚Äî MVP.
// –ù—É–∂–µ–Ω –¥–ª—è cache-progress-overlay.js (bytesByQuality).
// –ù–ï —Ö—Ä–∞–Ω–∏—Ç blobs "–ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É" –≤ —ç—Ç–æ–º –∫–æ–º–º–∏—Ç–µ ‚Äî —Ç–æ–ª—å–∫–æ bytes (—Å—á—ë—Ç—á–∏–∫–∏).

const DB_NAME = 'vitrina-offline-db';
const DB_VERSION = 1;

const STORE_META = 'meta'; // key -> value
const STORE_BYTES = 'bytes'; // uid -> { hi:number, lo:number }

// ‚úÖ –†–µ–∞–ª—å–Ω–æ–µ –æ—Ñ–ª–∞–π–Ω-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∞—É–¥–∏–æ (Blob) –ø–æ –∫–ª—é—á—É `${uid}:${quality}`
const STORE_BLOBS = 'blobs';
const STORE_STATS_GLOBAL = 'stats_global'; // uid -> { seconds, fullListens, lastListenAt }

const META_CQ_KEY = 'cacheQuality';

let dbPromise = null;

function openDb() {
  if (dbPromise) return dbPromise;

  dbPromise = new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);

    req.onupgradeneeded = () => {
      const db = req.result;

      if (!db.objectStoreNames.contains(STORE_META)) {
        db.createObjectStore(STORE_META);
      }
      if (!db.objectStoreNames.contains(STORE_BYTES)) {
        db.createObjectStore(STORE_BYTES);
      }
      if (!db.objectStoreNames.contains(STORE_BLOBS)) {
        db.createObjectStore(STORE_BLOBS);
      }
      if (!db.objectStoreNames.contains(STORE_STATS_GLOBAL)) {
        db.createObjectStore(STORE_STATS_GLOBAL);
      }
    };

    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error || new Error('IndexedDB open failed'));
  });

  return dbPromise;
}

function txp(db, store, mode, fn) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, mode);
    const st = tx.objectStore(store);

    let res;
    try { res = fn(st); } catch (e) { reject(e); return; }

    tx.oncomplete = () => resolve(res);
    tx.onerror = () => reject(tx.error || new Error('IndexedDB tx failed'));
    tx.onabort = () => reject(tx.error || new Error('IndexedDB tx aborted'));
  });
}

export async function ensureDbReady() {
  await openDb();
}

export async function getCacheQuality() {
  try {
    const db = await openDb();
    const v = await txp(db, STORE_META, 'readonly', (st) => {
      return new Promise((resolve, reject) => {
        const r = st.get(META_CQ_KEY);
        r.onsuccess = () => resolve(r.result);
        r.onerror = () => reject(r.error);
      });
    });

    const s = String(v || '').toLowerCase();
    return (s === 'lo') ? 'lo' : 'hi';
  } catch {
    return 'hi';
  }
}

export async function setCacheQuality(v) {
  const cq = (String(v || '').toLowerCase() === 'lo') ? 'lo' : 'hi';
  try {
    const db = await openDb();
    await txp(db, STORE_META, 'readwrite', (st) => {
      st.put(cq, META_CQ_KEY);
    });
  } catch {}
  return cq;
}

// ===== Cloud state (N/D + TTL) =====
// meta key format: cloud:{uid} ->
// {
//   cloudFullListenCount:number,
//   lastFullListenAt:number,
//   cloudAddedAt:number,
//   cloudExpiresAt:number,
//   cloud:boolean
// }
function cloudKey(uid) {
  const u = String(uid || '').trim();
  return u ? `cloud:${u}` : '';
}

export async function getCloudStats(uid) {
  const key = cloudKey(uid);
  if (!key) {
    return {
      cloudFullListenCount: 0,
      lastFullListenAt: 0,
      cloudAddedAt: 0,
      cloudExpiresAt: 0,
      cloud: false
    };
  }

  try {
    const db = await openDb();
    const v = await txp(db, STORE_META, 'readonly', (st) => {
      return new Promise((resolve, reject) => {
        const r = st.get(key);
        r.onsuccess = () => resolve(r.result || null);
        r.onerror = () => reject(r.error);
      });
    });

    const c = Number(v?.cloudFullListenCount || 0);
    const last = Number(v?.lastFullListenAt || 0);
    const added = Number(v?.cloudAddedAt || 0);
    const exp = Number(v?.cloudExpiresAt || 0);
    const cloud = v?.cloud === true;

    return {
      cloudFullListenCount: (Number.isFinite(c) && c > 0) ? Math.floor(c) : 0,
      lastFullListenAt: (Number.isFinite(last) && last > 0) ? Math.floor(last) : 0,
      cloudAddedAt: (Number.isFinite(added) && added > 0) ? Math.floor(added) : 0,
      cloudExpiresAt: (Number.isFinite(exp) && exp > 0) ? Math.floor(exp) : 0,
      cloud
    };
  } catch {
    return {
      cloudFullListenCount: 0,
      lastFullListenAt: 0,
      cloudAddedAt: 0,
      cloudExpiresAt: 0,
      cloud: false
    };
  }
}

export async function setCloudStats(uid, stats) {
  const key = cloudKey(uid);
  if (!key) return false;

  const c = Number(stats?.cloudFullListenCount || 0);
  const last = Number(stats?.lastFullListenAt || 0);
  const added = Number(stats?.cloudAddedAt || 0);
  const exp = Number(stats?.cloudExpiresAt || 0);
  const cloud = stats?.cloud === true;

  const payload = {
    cloudFullListenCount: (Number.isFinite(c) && c > 0) ? Math.floor(c) : 0,
    lastFullListenAt: (Number.isFinite(last) && last > 0) ? Math.floor(last) : 0,
    cloudAddedAt: (Number.isFinite(added) && added > 0) ? Math.floor(added) : 0,
    cloudExpiresAt: (Number.isFinite(exp) && exp > 0) ? Math.floor(exp) : 0,
    cloud
  };

  try {
    const db = await openDb();
    await txp(db, STORE_META, 'readwrite', (st) => {
      st.put(payload, key);
    });
    return true;
  } catch {
    return false;
  }
}

export async function clearCloudStats(uid) {
  const key = cloudKey(uid);
  if (!key) return false;

  try {
    const db = await openDb();
    await txp(db, STORE_META, 'readwrite', (st) => {
      st.delete(key);
    });
    return true;
  } catch {
    return false;
  }
}

// meta key format: cloudCandidate:{uid} -> boolean
function cloudCandidateKey(uid) {
  const u = String(uid || '').trim();
  return u ? `cloudCandidate:${u}` : '';
}

export async function getCloudCandidate(uid) {
  const key = cloudCandidateKey(uid);
  if (!key) return false;

  try {
    const db = await openDb();
    const v = await txp(db, STORE_META, 'readonly', (st) => {
      return new Promise((resolve, reject) => {
        const r = st.get(key);
        r.onsuccess = () => resolve(r.result);
        r.onerror = () => reject(r.error);
      });
    });
    return v === true;
  } catch {
    return false;
  }
}

export async function setCloudCandidate(uid, flag) {
  const key = cloudCandidateKey(uid);
  if (!key) return false;

  try {
    const db = await openDb();
    await txp(db, STORE_META, 'readwrite', (st) => {
      st.put(!!flag, key);
    });
    return true;
  } catch {
    return false;
  }
}

export async function clearCloudCandidate(uid) {
  const key = cloudCandidateKey(uid);
  if (!key) return false;

  try {
    const db = await openDb();
    await txp(db, STORE_META, 'readwrite', (st) => {
      st.delete(key);
    });
    return true;
  } catch {
    return false;
  }
}

export async function bytesByQuality(uid) {
  const u = String(uid || '').trim();
  if (!u) return { hi: 0, lo: 0 };

  const MB = 1024 * 1024;

  const normalize = (v) => {
    const n = Number(v || 0);
    if (!Number.isFinite(n) || n <= 0) return 0;

    // ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è legacy: –µ—Å–ª–∏ —Ä–∞–Ω—å—à–µ —Å—é–¥–∞ –ø–∏—Å–∞–ª–∏ "MB" (–Ω–∞–ø—Ä–∏–º–µ—Ä 8.5),
    // —Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç < 1MB. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º MB ‚Üí bytes.
    if (n > 0 && n < MB) {
      return Math.floor(n * MB);
    }

    return Math.floor(n);
  };

  try {
    const db = await openDb();
    const row = await txp(db, STORE_BYTES, 'readonly', (st) => {
      return new Promise((resolve, reject) => {
        const r = st.get(u);
        r.onsuccess = () => resolve(r.result || null);
        r.onerror = () => reject(r.error);
      });
    });

    const hi = normalize(row?.hi);
    const lo = normalize(row?.lo);

    // ‚úÖ –ï—Å–ª–∏ –±—ã–ª–∞ –º–∏–≥—Ä–∞—Ü–∏—è MB‚Üíbytes ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ–º —Ä—è–¥, —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å.
    if (row && ((hi && hi !== row.hi) || (lo && lo !== row.lo))) {
      try {
        const db2 = await openDb();
        await txp(db2, STORE_BYTES, 'readwrite', (st) => {
          st.put({ hi, lo }, u);
        });
      } catch {}
    }

    return { hi, lo };
  } catch {
    return { hi: 0, lo: 0 };
  }
}

export async function setBytes(uid, quality, bytes) {
  const u = String(uid || '').trim();
  if (!u) return;

  const q = (String(quality || '').toLowerCase() === 'lo') ? 'lo' : 'hi';
  const b = Number(bytes);
  const safe = (Number.isFinite(b) && b > 0) ? Math.floor(b) : 0;

  try {
    const db = await openDb();
    await txp(db, STORE_BYTES, 'readwrite', (st) => {
      return new Promise((resolve, reject) => {
        const getReq = st.get(u);

        getReq.onsuccess = () => {
          try {
            const cur = getReq.result || { hi: 0, lo: 0 };
            const next = { hi: Number(cur.hi || 0), lo: Number(cur.lo || 0) };
            next[q] = safe;
            const putReq = st.put(next, u);
            putReq.onsuccess = () => resolve(true);
            putReq.onerror = () => reject(putReq.error);
          } catch (e) {
            reject(e);
          }
        };

        getReq.onerror = () => reject(getReq.error);
      });
    });
  } catch {}
}

export async function totalCachedBytes() {
  try {
    const db = await openDb();
    const sum = await txp(db, STORE_BYTES, 'readonly', (st) => {
      return new Promise((resolve, reject) => {
        let total = 0;
        const req = st.openCursor();

        req.onsuccess = () => {
          const cursor = req.result;
          if (!cursor) {
            resolve(total);
            return;
          }
          const v = cursor.value || {};
          const hi = Number(v.hi || 0);
          const lo = Number(v.lo || 0);
          if (Number.isFinite(hi) && hi > 0) total += hi;
          if (Number.isFinite(lo) && lo > 0) total += lo;
          cursor.continue();
        };

        req.onerror = () => reject(req.error);
      });
    });

    return Number.isFinite(sum) && sum > 0 ? Math.floor(sum) : 0;
  } catch {
    return 0;
  }
}

export async function deleteTrackCache(uid) {
  const u = String(uid || '').trim();
  if (!u) return;

  try {
    const db = await openDb();
    await txp(db, STORE_BYTES, 'readwrite', (st) => {
      st.delete(u);
    });
  } catch {}

  // ‚úÖ –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º blobs (–µ—Å–ª–∏ –µ—Å—Ç—å)
  try {
    const db = await openDb();
    await txp(db, STORE_BLOBS, 'readwrite', (st) => {
      st.delete(`${u}:hi`);
      st.delete(`${u}:lo`);
    });
  } catch {}
}

export async function clearAllStores({ keepCacheQuality = true } = {}) {
  // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ bytes + blobs + cloud meta.
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é cacheQuality —Å–æ—Ö—Ä–∞–Ω—è–µ–º (—á—Ç–æ–±—ã CQ –Ω–µ ‚Äú—Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è‚Äù –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ).
  try {
    const db = await openDb();

    // 1) bytes ‚Äî clear
    await txp(db, STORE_BYTES, 'readwrite', (st) => {
      st.clear();
    });

    // 2) blobs ‚Äî clear
    await txp(db, STORE_BLOBS, 'readwrite', (st) => {
      st.clear();
    });

    // 3) meta ‚Äî —É–¥–∞–ª—è–µ–º cloud:* –∏ cloudCandidate:* (–∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ cacheQuality)
    await txp(db, STORE_META, 'readwrite', (st) => {
      return new Promise((resolve, reject) => {
        const req = st.openCursor();
        req.onsuccess = () => {
          const cursor = req.result;
          if (!cursor) {
            resolve(true);
            return;
          }
          const k = String(cursor.key || '');
          const isCloud = k.startsWith('cloud:') || k.startsWith('cloudCandidate:');
          const isCQ = k === 'cacheQuality';
          if (isCloud || (!keepCacheQuality && isCQ)) {
            try { cursor.delete(); } catch {}
          }
          cursor.continue();
        };
        req.onerror = () => reject(req.error);
      });
    });

    return true;
  } catch {
    return false;
  }
}

export async function getAudioBlob(uid, quality) {
  const u = String(uid || '').trim();
  if (!u) return null;

  const q = (String(quality || '').toLowerCase() === 'lo') ? 'lo' : 'hi';
  const key = `${u}:${q}`;

  try {
    const db = await openDb();
    const blob = await txp(db, STORE_BLOBS, 'readonly', (st) => {
      return new Promise((resolve, reject) => {
        const r = st.get(key);
        r.onsuccess = () => resolve(r.result || null);
        r.onerror = () => reject(r.error);
      });
    });
    return blob || null;
  } catch {
    return null;
  }
}

export async function setAudioBlob(uid, quality, blob) {
  const u = String(uid || '').trim();
  if (!u) return false;

  const q = (String(quality || '').toLowerCase() === 'lo') ? 'lo' : 'hi';
  const key = `${u}:${q}`;

  if (!(blob instanceof Blob)) return false;

  try {
    const db = await openDb();
    await txp(db, STORE_BLOBS, 'readwrite', (st) => {
      st.put(blob, key);
    });
    return true;
  } catch {
    return false;
  }
}

// ===== Global Stats (Permanent) =====
export async function updateGlobalStats(uid, deltaSeconds, addFullListen = 0) {
  const u = String(uid || '').trim();
  if (!u) return;
  const now = Date.now();

  try {
    const db = await openDb();
    await txp(db, STORE_STATS_GLOBAL, 'readwrite', (st) => {
      const getReq = st.get(u);
      getReq.onsuccess = () => {
        const cur = getReq.result || { seconds: 0, fullListens: 0, lastListenAt: 0 };
        const next = {
          seconds: (cur.seconds || 0) + deltaSeconds,
          fullListens: (cur.fullListens || 0) + addFullListen,
          lastListenAt: now
        };
        st.put(next, u);
      };
    });
  } catch {}
}

export async function getGlobalStatsAndTotal() {
  try {
    const db = await openDb();
    let totalSeconds = 0;
    const tracks = [];

    await txp(db, STORE_STATS_GLOBAL, 'readonly', (st) => {
      return new Promise((resolve, reject) => {
        const req = st.openCursor();
        req.onsuccess = () => {
          const cursor = req.result;
          if (!cursor) {
            resolve();
            return;
          }
          const val = cursor.value;
          const uid = cursor.key;
          totalSeconds += (val.seconds || 0);
          if (val.fullListens > 0 || val.seconds > 0) {
            tracks.push({ uid, ...val });
          }
          cursor.continue();
        };
        req.onerror = () => reject(req.error);
      });
    });
    return { totalSeconds, tracks };
  } catch {
    return { totalSeconds: 0, tracks: [] };
  }
}

// ===== Eviction Helpers =====
// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö UID, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å bytes (–∫—ç—à), –∫—Ä–æ–º–µ pinned
export async function getEvictionCandidates(pinnedSet) {
  try {
    const db = await openDb();
    const candidates = []; // { uid, lastListenAt }
    
    // 1. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö, —É –∫–æ–≥–æ –µ—Å—Ç—å –±–∞–π—Ç—ã
    await txp(db, STORE_BYTES, 'readonly', (st) => {
      return new Promise((resolve) => {
        const req = st.openCursor();
        req.onsuccess = () => {
          const cursor = req.result;
          if (!cursor) { resolve(); return; }
          const uid = String(cursor.key);
          // –ï—Å–ª–∏ –Ω–µ pinned - –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
          if (!pinnedSet.has(uid)) {
             candidates.push(uid);
          }
          cursor.continue();
        };
      });
    });

    // 2. –û–±–æ–≥–∞—â–∞–µ–º –¥–∞—Ç–æ–π –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è (Global Stats) –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ LRU
    const enriched = [];
    for (const uid of candidates) {
      // –≠—Ç–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–æ, –Ω–æ –¥–ª—è —ç–≤–∏–∫—Ü–∏–∏ –ø—Ä–∏–µ–º–ª–µ–º–æ
      const g = await getGlobalStats(uid); // helper below
      enriched.push({ uid, ts: g?.lastListenAt || 0 });
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å—Ç–∞—Ä—ã–µ (–º–∞–ª–µ–Ω—å–∫–∏–π ts) –≤ –Ω–∞—á–∞–ª–µ
    enriched.sort((a, b) => a.ts - b.ts);
    return enriched.map(x => x.uid);
  } catch {
    return [];
  }
}

async function getGlobalStats(uid) {
  try {
    const db = await openDb();
    const v = await txp(db, STORE_STATS_GLOBAL, 'readonly', (st) => {
      return new Promise((resolve) => {
        const r = st.get(uid);
        r.onsuccess = () => resolve(r.result);
        r.onerror = () => resolve(null);
      });
    });
    return v;
  } catch { return null; }
}

export async function deleteAudioBlob(uid, quality) {
  const u = String(uid || '').trim();
  if (!u) return;

  const qRaw = String(quality || '').toLowerCase().trim();
  const keys = (qRaw === 'hi' || qRaw === 'lo')
    ? [`${u}:${qRaw}`]
    : [`${u}:hi`, `${u}:lo`];

  try {
    const db = await openDb();
    await txp(db, STORE_BLOBS, 'readwrite', (st) => {
      keys.forEach(k => st.delete(k));
    });
  } catch {}
}

//=================================================
// FILE: /scripts/offline/net-policy.js
// scripts/offline/net-policy.js
// –ï–¥–∏–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ —Å–µ—Ç–∏ –¥–ª—è OFFLINE (–¢–ó_–ù–¨–Æ).
// –•—Ä–∞–Ω–∏–ª–∏—â–µ: localStorage['offline:netPolicy:v1']
// –ó–Ω–∞—á–µ–Ω–∏—è: 'wifi' | 'cellular' | 'unknown' | 'ask'
//
// –í–∞–∂–Ω–æ:
// - Unknown —Å–µ—Ç—å: confirm –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–∏ –¥–ª—è –∞–≤—Ç–æ-–∑–∞–¥–∞—á, –µ—Å–ª–∏ —Ç–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ).
// - OfflineManager –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –º–æ–¥—É–ª—å, —á—Ç–æ–±—ã —Ä–µ—à–∞—Ç—å: –º–æ–∂–Ω–æ –ª–∏ –∫–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å.

export const NETPOLICY_KEY = 'offline:netPolicy:v1';

export function getNetPolicy() {
  const v = String(localStorage.getItem(NETPOLICY_KEY) || 'ask').toLowerCase().trim();
  if (v === 'wifi') return 'wifi';
  if (v === 'cellular') return 'cellular';
  if (v === 'unknown') return 'unknown';
  return 'ask';
}

export function setNetPolicy(v) {
  const s = String(v || '').toLowerCase().trim();
  const next =
    (s === 'wifi' || s === 'cellular' || s === 'unknown' || s === 'ask') ? s : 'ask';
  try { localStorage.setItem(NETPOLICY_KEY, next); } catch {}
  return next;
}

export function isAllowedByNetPolicy(policy, networkStatus) {
  const p = String(policy || 'ask');
  const kind = String(networkStatus?.kind || 'unknown');

  if (p === 'wifi') return kind === 'wifi';
  if (p === 'cellular') return kind === 'wifi' || kind === 'cellular';
  if (p === 'unknown') return true;
  // ask ‚Äî —Ä–µ—à–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–µ (confirm/skip)
  return true;
}

/**
 * shouldConfirmByPolicy
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –µ—Å–ª–∏ –ø–æ —Ç–µ–∫—É—â–µ–π –ø–æ–ª–∏—Ç–∏–∫–µ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å confirm –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π.
 *
 * –¢–ó:
 * - Unknown —Å–µ—Ç—å: confirm –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
 * - Ask: –≤—Å–µ–≥–¥–∞ confirm.
 *
 * opts:
 * - isMass: boolean (–º–∞—Å—Å–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: ‚Äú—Å–∫–∞—á–∞—Ç—å –≤—Å—ë‚Äù, 100% offline, updates, –∏ —Ç.–ø.)
 * - isAuto: boolean (–∞–≤—Ç–æ-–∑–∞–¥–∞—á–∞ –æ—á–µ—Ä–µ–¥–∏, playback cache)
 */
export function shouldConfirmByPolicy(policy, networkStatus, opts = {}) {
  const p = String(policy || 'ask');
  const kind = String(networkStatus?.kind || 'unknown');
  const isMass = !!opts?.isMass;

  if (p === 'ask') return true;

  // Unknown —Å–µ—Ç—å: confirm –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  if (kind === 'unknown' && isMass) return true;

  return false;
}

//=================================================
// FILE: /scripts/offline/offline-manager.js
// scripts/offline/offline-manager.js
// OfflineManager (ESM) ‚Äî –µ–¥–∏–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä CQ/pinned/cloud/queue.
// –í–∞–∂–Ω–æ: –ù–ï —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º (–Ω–µ –¥–µ–ª–∞–µ—Ç stop/play/seek).
// –¶–µ–ª—å: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á–∏—Å—Ç–æ, –±–µ–∑ –¥—É–±–ª–µ–π –∏ ‚Äú—É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–ª–µ–¥–æ–≤‚Äù, –∏ –±–ª–∏–∂–µ –∫ –¢–ó_–ù–¨–Æ.

import {
  bytesByQuality,
  deleteTrackCache,
  getCacheQuality,
  setCacheQuality,
  ensureDbReady,
  getAudioBlob,
  setAudioBlob,
  setBytes,
  getCloudStats,
  setCloudStats,
  clearCloudStats,
  getCloudCandidate,
  setCloudCandidate,
  clearCloudCandidate,
  totalCachedBytes,
  clearAllStores,
  updateGlobalStats,
  getGlobalStatsAndTotal,
  getEvictionCandidates
} from './cache-db.js';

import { resolvePlaybackSource } from './track-resolver.js';
import { getTrackByUid } from '../app/track-registry.js';
import { getNetPolicy, isAllowedByNetPolicy, shouldConfirmByPolicy } from './net-policy.js';

const LS = {
  OFFLINE_MODE: 'offlineMode:v1',
  CQ: 'offline:cacheQuality:v1',
  PINNED: 'pinnedUids:v1',
  CLOUD_N: 'offline:cloudN:v1',
  CLOUD_D: 'offline:cloudD:v1',
  ALERT: 'offline:alert:v1',
};

const MB = 1024 * 1024;

function normUid(v) {
  const s = String(v || '').trim();
  return s ? s : null;
}

function normQ(v) {
  return String(v || '').toLowerCase() === 'lo' ? 'lo' : 'hi';
}

function readJson(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    const j = JSON.parse(raw);
    return (j === null || j === undefined) ? fallback : j;
  } catch {
    return fallback;
  }
}

function writeJson(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
}

function getNetworkStatusSafe() {
  try {
    if (window.NetworkManager && typeof window.NetworkManager.getStatus === 'function') {
      return window.NetworkManager.getStatus();
    }
  } catch {}
  return { online: navigator.onLine !== false, kind: 'unknown', raw: null, saveData: false };
}

function readCloudN() {
  const raw = Number(localStorage.getItem(LS.CLOUD_N) || 5);
  const n = Number.isFinite(raw) ? Math.floor(raw) : 5;
  return Math.max(1, Math.min(50, n));
}

function readCloudD() {
  const raw = Number(localStorage.getItem(LS.CLOUD_D) || 31);
  const d = Number.isFinite(raw) ? Math.floor(raw) : 31;
  return Math.max(1, Math.min(365, d));
}

function setAlert(on, reason) {
  try {
    localStorage.setItem(LS.ALERT, JSON.stringify({
      on: !!on,
      ts: Date.now(),
      reason: String(reason || '')
    }));
  } catch {}
  try { window.dispatchEvent(new CustomEvent('offline:uiChanged')); } catch {}
}

class Emitter {
  constructor() { this._m = new Map(); }
  on(type, cb) {
    const arr = this._m.get(type) || [];
    arr.push(cb);
    this._m.set(type, arr);
    return () => this._m.set(type, (this._m.get(type) || []).filter(fn => fn !== cb));
  }
  emit(type, payload) {
    (this._m.get(type) || []).forEach(fn => { try { fn(payload); } catch {} });
  }
}

class SimpleQueue {
  // 1 active audio download at a time.
  constructor({ onProgress } = {}) {
    this._items = [];
    this._running = false;
    this._runningKey = null;
    this._onProgress = (typeof onProgress === 'function') ? onProgress : null;
  }

  size() { return this._items.length; }

  hasTask(key) {
    const k = String(key || '').trim();
    if (!k) return false;
    if (this._runningKey && this._runningKey === k) return true;
    return this._items.some(t => String(t?.key || '').trim() === k);
  }

  add(task) {
    if (!task || typeof task.run !== 'function') return;

    const pr = Number(task.priority || 0);
    const item = { ...task, priority: Number.isFinite(pr) ? pr : 0, __ts: Date.now() };

    // higher priority first, FIFO within same priority
    const idx = this._items.findIndex(t => Number(t?.priority || 0) < item.priority);
    if (idx === -1) this._items.push(item);
    else this._items.splice(idx, 0, item);

    this._tick();
  }

  async _tick() {
    if (this._running) return;
    const task = this._items.shift();
    if (!task) return;

    this._running = true;
    this._runningKey = String(task.key || '') || null;

    try {
      this._onProgress?.({ uid: task.uid || null, phase: 'start', key: task.key || '' });
      await task.run();
      this._onProgress?.({ uid: task.uid || null, phase: 'done', key: task.key || '' });
    } catch (e) {
      this._onProgress?.({ uid: task.uid || null, phase: 'error', key: task.key || '', error: String(e?.message || e) });
    } finally {
      this._running = false;
      this._runningKey = null;
      this._tick();
    }
  }
}

export class OfflineManager {
  constructor() {
    this._em = new Emitter();

    this.mass = {
      active: false,
      total: 0,
      done: 0,
      error: 0,
      skipped: 0,
      startedAt: 0
    };

    this.queue = new SimpleQueue({
      onProgress: (ev) => this._em.emit('progress', ev)
    });
  }

  async initialize() {
    try { await ensureDbReady(); } catch {}
  }

  on(type, cb) { return this._em.on(type, cb); }

  // =========================
  // Offline mode
  // =========================
  isOfflineMode() {
    try { return localStorage.getItem(LS.OFFLINE_MODE) === '1'; } catch { return false; }
  }

  setOfflineMode(enabled) {
    try { localStorage.setItem(LS.OFFLINE_MODE, enabled ? '1' : '0'); } catch {}
    // UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ offline-ui-bootstrap —Å–ª—É—à–∞—è offline:uiChanged.
    try { window.dispatchEvent(new CustomEvent('offline:uiChanged')); } catch {}
  }

  // =========================
  // Cache Quality (CQ)
  // =========================
  async getCacheQuality() {
    // –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: localStorage CQ, fallback –Ω–∞ IndexedDB meta CQ.
    try {
      const cq = String(localStorage.getItem(LS.CQ) || '').toLowerCase();
      if (cq === 'hi' || cq === 'lo') return cq;
    } catch {}
    return getCacheQuality();
  }

  async setCacheQuality(cq) {
    const v = normQ(cq);
    try { localStorage.setItem(LS.CQ, v); } catch {}
    try { await setCacheQuality(v); } catch {}
    this._em.emit('progress', { uid: null, phase: 'cqChanged', cq: v });
    setAlert(true, '–ò–∑–º–µ–Ω–µ–Ω–æ Cache Quality (CQ). –í–æ–∑–º–æ–∂–µ–Ω re-cache.');
    return v;
  }

  // =========================
  // Cloud settings
  // =========================
  getCloudSettings() {
    return { n: readCloudN(), d: readCloudD() };
  }

  setCloudSettings(next = {}) {
    const nRaw = Number(next?.n);
    const dRaw = Number(next?.d);

    const n = Number.isFinite(nRaw) ? Math.floor(nRaw) : readCloudN();
    const d = Number.isFinite(dRaw) ? Math.floor(dRaw) : readCloudD();

    const safeN = Math.max(1, Math.min(50, n));
    const safeD = Math.max(1, Math.min(365, d));

    try { localStorage.setItem(LS.CLOUD_N, String(safeN)); } catch {}
    try { localStorage.setItem(LS.CLOUD_D, String(safeD)); } catch {}

    this._em.emit('progress', { uid: null, phase: 'cloudSettingsChanged', n: safeN, d: safeD });
    return { n: safeN, d: safeD };
  }

  // =========================
  // Pinned
  // =========================
  _getPinnedSet() {
    const arr = readJson(LS.PINNED, []);
    const uids = Array.isArray(arr) ? arr.map(x => String(x || '').trim()).filter(Boolean) : [];
    return new Set(uids);
  }

  _setPinnedSet(set) {
    writeJson(LS.PINNED, Array.from(set));
  }

  getPinnedUids() {
    return Array.from(this._getPinnedSet());
  }

  async pin(uid) {
    const u = normUid(uid);
    if (!u) return false;

    const set = this._getPinnedSet();
    if (!set.has(u)) {
      set.add(u);
      this._setPinnedSet(set);
    }

    // pinned=true –æ—Ç–º–µ–Ω—è–µ—Ç cloudCandidate
    try { await setCloudCandidate(u, false); } catch {}

    // –¢–ó 8.1: —Å—Ç–∞–≤–∏–º –∑–∞–¥–∞—á—É —Å–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫ –¥–æ 100% –≤ CQ
    this.enqueuePinnedDownload(u, { userInitiated: true });

    this._em.emit('progress', { uid: u, phase: 'pinned' });
    return true;
  }

  async unpin(uid) {
    const u = normUid(uid);
    if (!u) return false;

    const set = this._getPinnedSet();
    if (set.has(u)) {
      set.delete(u);
      this._setPinnedSet(set);
    }

    // –¢–ó 8.3: —Å–Ω—è—Ç–∏–µ pinned ‚Üí cloudCandidate —Å—Ä–∞–∑—É
    try { await setCloudCandidate(u, true); } catch {}

    window.NotificationSystem?.info('–û—Ñ–ª–∞–π–Ω-–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–Ω—è—Ç–æ. –¢—Ä–µ–∫ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å Cloud ‚òÅ', 3500);

    // –î–æ–∫–∞—á–∫–∞ –≤ CQ (cloudCandidate)
    const cq = await this.getCacheQuality();
    this.enqueueAudioDownload({
      uid: u,
      quality: cq,
      key: `cloudCandidate:${cq}:${u}`,
      priority: 15,
      userInitiated: false,
      isMass: false,
      kind: 'cloudCandidate'
    });

    this._em.emit('progress', { uid: u, phase: 'unpinned' });
    return true;
  }

  enqueuePinnedDownload(uid, opts = {}) {
    const u = normUid(uid);
    if (!u) return;

    const userInitiated = !!opts?.userInitiated;
    this.getCacheQuality().then((cq) => {
      this.enqueueAudioDownload({
        uid: u,
        quality: cq,
        key: `pinned:${cq}:${u}`,
        priority: 25, // P2
        userInitiated,
        isMass: false,
        kind: 'pinned'
      });
    }).catch(() => {});
  }

  enqueuePinnedDownloadAll() {
    const list = this.getPinnedUids();
    list.forEach((uid) => this.enqueuePinnedDownload(uid, { userInitiated: true }));
    this._em.emit('progress', { uid: null, phase: 'pinnedQueueEnqueued', count: list.length });
  }

  // =========================
  // Track cache state helpers
  // =========================
  async isTrackComplete(uid, quality) {
    const u = normUid(uid);
    if (!u) return false;

    const q = normQ(quality);
    const meta = getTrackByUid(u);
    if (!meta) return false;

    const needMb = (q === 'hi')
      ? Number(meta.sizeHi || meta.size || 0)
      : Number(meta.sizeLo || meta.size_low || 0);

    if (!(Number.isFinite(needMb) && needMb > 0)) return false;
    const needBytes = Math.floor(needMb * MB);

    const have = await bytesByQuality(u);
    const got = (q === 'hi') ? Number(have.hi || 0) : Number(have.lo || 0);
    if (!(Number.isFinite(got) && got > 0)) return false;

    // –¥–æ–ø—É—Å–∫ 92% (–∫–∞–∫ —É —Ç–µ–±—è –∏ –∫–∞–∫ –≤ resolver)
    return got >= Math.floor(needBytes * 0.92);
  }

  async hasAnyComplete(uids) {
    const list = Array.isArray(uids) ? uids : [];
    if (!list.length) return false;

    const cq = await this.getCacheQuality();
    const alt = cq === 'hi' ? 'lo' : 'hi';

    for (const uid of list) {
      // eslint-disable-next-line no-await-in-loop
      if (await this.isTrackComplete(uid, cq)) return true;
    }
    for (const uid of list) {
      // eslint-disable-next-line no-await-in-loop
      if (await this.isTrackComplete(uid, alt)) return true;
    }
    return false;
  }

  async getCacheSizeBytes() {
    return totalCachedBytes();
  }

  async clearAllCache() {
    // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞: bytes + blobs + cloud meta.
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.
    try {
      const ok = await clearAllStores({ keepCacheQuality: true });
      this._setPinnedSet(new Set());
      this._em.emit('progress', { uid: null, phase: 'allCacheCleared' });
      setAlert(false, '');
      return !!ok;
    } catch {
      return false;
    }
  }

  // =========================
  // Queue API (–µ–¥–∏–Ω–∞—è –æ—á–µ—Ä–µ–¥—å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)
  // =========================
  enqueueAudioDownload(params = {}) {
    const u = normUid(params?.uid);
    if (!u) return { ok: false, reason: 'noUid' };

    const q = normQ(params?.quality);
    const kind = String(params?.kind || '').trim() || 'generic';
    const userInitiated = !!params?.userInitiated;
    const isMass = !!params?.isMass;

    const pr = Number(params?.priority || 0);
    const priority = Number.isFinite(pr) ? pr : 0;

    const key = String(params?.key || '').trim() || `${kind}:${q}:${u}`;
    const onResult = (typeof params?.onResult === 'function') ? params.onResult : null;

    if (this.queue.hasTask(key)) return { ok: true, enqueued: false, dedup: true, key };

    this.queue.add({
      key,
      uid: u,
      priority,
      run: async () => {
        const r = await this.cacheTrackAudio(u, q, { userInitiated, isMass });
        try { onResult && onResult(r); } catch {}
      }
    });

    return { ok: true, enqueued: true, key };
  }

  // =========================
  // 100% OFFLINE (backend)
  // =========================
  async startFullOffline(uids) {
    const uniq = Array.from(new Set((Array.isArray(uids) ? uids : [])
      .map(x => String(x || '').trim())
      .filter(Boolean)));

    if (!uniq.length) return { ok: false, reason: 'empty' };

    // –ü–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º: –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å eviction best-effort
    await this.checkEviction();

    this.mass = {
      active: true,
      total: uniq.length,
      done: 0,
      error: 0,
      skipped: 0,
      startedAt: Date.now()
    };

    this._em.emit('progress', { uid: null, phase: 'offlineAllStart', total: uniq.length });

    const cq = await this.getCacheQuality();

    uniq.forEach((uid) => {
      const u = String(uid || '').trim();
      const taskKey = `offlineAll:${cq}:${u}`;

      this.enqueueAudioDownload({
        uid: u,
        quality: cq,
        key: taskKey,
        priority: 10, // P3-ish
        userInitiated: false,
        isMass: true,
        kind: 'offlineAll',
        onResult: (r) => {
          if (r && r.ok) this.mass.done++;
          else if (String(r?.reason || '').includes('Skipped')) this.mass.skipped++;
          else this.mass.error++;

          if (this.mass.done + this.mass.error + this.mass.skipped >= this.mass.total) {
            this.mass.active = false;
            this._em.emit('progress', { uid: null, phase: 'offlineAllDone', ...this.mass });
            window.NotificationSystem?.success('–ó–∞–≥—Ä—É–∑–∫–∞ 100% OFFLINE –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
          }
        }
      });
    });

    return { ok: true, total: uniq.length };
  }

  getMassStatus() { return { ...this.mass }; }

  // =========================
  // Cloud: eligibility + indicators + actions
  // =========================
  async isCloudEligible(uid) {
    const u = normUid(uid);
    if (!u) return false;

    // pinned –∏—Å–∫–ª—é—á–∞–µ—Ç cloud
    if (this._getPinnedSet().has(u)) return false;

    const { n } = this.getCloudSettings();
    const now = Date.now();

    const st = await getCloudStats(u);
    const candidate = await getCloudCandidate(u);

    const count = Number(st?.cloudFullListenCount || 0);
    const cloudByAuto = Number.isFinite(count) && count >= n;

    if (st?.cloud === true) {
      const exp = Number(st?.cloudExpiresAt || 0);
      return Number.isFinite(exp) && exp > 0 && exp >= now;
    }

    // cloud=false, –Ω–æ eligible –∫–∞–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç/–∞–≤—Ç–æ ‚Äî –≤–∫–ª—é—á–∏—Ç—Å—è –ø–æ—Å–ª–µ 100% CQ
    return !!(candidate || cloudByAuto);
  }

  async getIndicators(uid) {
    const u = normUid(uid);
    if (!u) return { pinned: false, cloud: false, cachedComplete: false };

    const pinned = this._getPinnedSet().has(u);
    const cq = await this.getCacheQuality();
    const cachedComplete = await this.isTrackComplete(u, cq);
    const eligible = await this.isCloudEligible(u);

    // –¢–ó 10.1/9.3: ‚òÅ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ cloud eligible –∏ 100% –≤ CQ.
    const cloud = (!pinned) && (!!cachedComplete) && (!!eligible);

    return { pinned, cloud, cachedComplete };
  }

  async cloudMenu(uid, action) {
    const u = normUid(uid);
    const act = String(action || '').trim();
    if (!u || !act) return false;

    if (act === 'add-lock') {
      await this.pin(u);
      return true;
    }

    if (act === 'remove-cache') {
      // –¢–ó 9.5: —É–¥–∞–ª–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é cloud-–∫–æ–ø–∏—é + —Å–±—Ä–æ—Å–∏—Ç—å cloud-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –ù–ï —Ç—Ä–æ–≥–∞—Ç—å global stats.
      await deleteTrackCache(u);
      try { await clearCloudStats(u); } catch {}
      try { await clearCloudCandidate(u); } catch {}
      this._em.emit('progress', { uid: u, phase: 'cacheRemoved' });
      return true;
    }

    return false;
  }

  async _maybeActivateCloudAfterCqComplete(uid) {
    const u = normUid(uid);
    if (!u) return false;

    if (this._getPinnedSet().has(u)) return false;

    const cq = await this.getCacheQuality();
    const complete = await this.isTrackComplete(u, cq);
    if (!complete) return false;

    const { n, d } = this.getCloudSettings();
    const ttlMs = d * 24 * 60 * 60 * 1000;
    const now = Date.now();

    const st = await getCloudStats(u);
    if (st?.cloud === true) return true;

    const candidate = await getCloudCandidate(u);
    const count = Number(st?.cloudFullListenCount || 0);
    const cloudByAuto = Number.isFinite(count) && count >= n;

    if (!candidate && !cloudByAuto) return false;

    await setCloudStats(u, {
      cloudFullListenCount: (Number.isFinite(count) && count > 0) ? Math.floor(count) : 0,
      lastFullListenAt: Number(st?.lastFullListenAt || 0) > 0 ? Math.floor(st.lastFullListenAt) : 0,
      cloudAddedAt: now,
      cloudExpiresAt: now + ttlMs,
      cloud: true
    });

    try { await clearCloudCandidate(u); } catch {}

    this._em.emit('progress', { uid: u, phase: 'cloudActivated' });
    return true;
  }

  // =========================
  // Stats entrypoint (called from PlayerCore)
  // =========================
  async recordListenStats(uid, ctx = {}) {
    const u = normUid(uid);
    if (!u) return;

    const deltaSec = Number(ctx?.deltaSec || 0);
    const isFullListen = !!ctx?.isFullListen;

    // Global stats never reset (–¢–ó 1.4 / 7.11.2)
    if (deltaSec > 0 || isFullListen) {
      await updateGlobalStats(u, deltaSec, isFullListen ? 1 : 0);
    }

    // Cloud stats only on full listen (–¢–ó 9.2 / 7.11.1)
    if (isFullListen) {
      await this._updateCloudStatsOnFullListen(u);
    }
  }

  async _updateCloudStatsOnFullListen(uid) {
    const u = normUid(uid);
    if (!u) return;

    const now = Date.now();
    const { n, d } = this.getCloudSettings();
    const ttlMs = d * 24 * 60 * 60 * 1000;

    const prev = await getCloudStats(u);

    const prevCount = Number(prev?.cloudFullListenCount || 0);
    const nextCount = (Number.isFinite(prevCount) && prevCount > 0) ? (prevCount + 1) : 1;

    // Auto cloud if count >= N
    const becameCloud = nextCount >= n;
    const nextCloud = becameCloud ? true : (prev?.cloud === true);

    // TTL –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ cloud=true (–ø–æ –¢–ó repeat/full listen –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç)
    const cloudExpiresAt = nextCloud ? (now + ttlMs) : 0;
    const cloudAddedAt = nextCloud
      ? (Number(prev?.cloudAddedAt || 0) > 0 ? Number(prev.cloudAddedAt) : now)
      : 0;

    await setCloudStats(u, {
      cloudFullListenCount: nextCount,
      lastFullListenAt: now,
      cloudAddedAt,
      cloudExpiresAt,
      cloud: nextCloud
    });

    this._em.emit('progress', { uid: u, phase: 'cloudStats', cloud: nextCloud });
  }

  async getGlobalStatistics() {
    return getGlobalStatsAndTotal();
  }

  // =========================
  // Eviction (best-effort)
  // =========================
  async checkEviction(limitMB = 500) {
    const total = await this.getCacheSizeBytes();
    const limitBytes = Math.floor(Number(limitMB || 0) * MB);
    if (!(limitBytes > 0) || total <= limitBytes) return;

    const pinnedSet = this._getPinnedSet();
    const candidates = await getEvictionCandidates(pinnedSet); // LRU

    let freed = 0;

    for (const uid of candidates) {
      if ((total - freed) <= limitBytes) break;

      // eslint-disable-next-line no-await-in-loop
      const sizes = await bytesByQuality(uid);
      const trackBytes = (Number(sizes.hi || 0) + Number(sizes.lo || 0)) || 0;

      // eslint-disable-next-line no-await-in-loop
      await deleteTrackCache(uid);

      // eslint-disable-next-line no-await-in-loop
      await clearCloudStats(uid);

      freed += trackBytes;
    }

    if (freed > 0) {
      window.NotificationSystem?.info('–ö—ç—à –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω. –£–¥–∞–ª–µ–Ω—ã —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Ç—Ä–µ–∫–∏.');
      this._em.emit('progress', { uid: null, phase: 'eviction', freed });
    }
  }

  // =========================
  // Download implementation (blob)
  // =========================
  async cacheTrackAudio(uid, quality, options = {}) {
    const u = normUid(uid);
    if (!u) return { ok: false, reason: 'noUid' };

    const q = normQ(quality);

    const meta = getTrackByUid(u);
    if (!meta) return { ok: false, reason: 'noTrackMeta' };

    // Resolve network URL via TrackResolver (even if offline mode ON, downloading is network action)
    let url = null;
    try {
      const r = await resolvePlaybackSource({
        track: meta,
        pq: q,
        cq: q,
        offlineMode: false,
        network: { online: true, kind: 'unknown', raw: null, saveData: false }
      });
      url = r?.url || null;
    } catch {
      url = null;
    }

    if (!url) return { ok: false, reason: 'noUrlResolved' };

    const st = getNetworkStatusSafe();
    if (st.online === false) return { ok: false, reason: 'offline:network' };

    const policy = getNetPolicy();
    const userInitiated = !!options?.userInitiated;
    const isAuto = !userInitiated;
    const isMass = !!options?.isMass;

    // Hard block if policy not allow
    if (policy !== 'ask' && !isAllowedByNetPolicy(policy, st)) {
      return { ok: false, reason: `netPolicyBlocked:${policy}:${st.kind || 'unknown'}` };
    }

    // Confirm rules
    if (policy === 'ask' && shouldConfirmByPolicy(policy, st, { isMass, isAuto })) {
      if (isAuto) {
        setAlert(true, '–ï—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (Network Policy = ask)');
        return { ok: false, reason: 'netPolicyAsk:autoTaskSkipped' };
      }
      const ok = window.confirm('–¢–∏–ø —Å–µ—Ç–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
      if (!ok) return { ok: false, reason: 'netPolicyAsk:userDenied' };
    }

    this._em.emit('progress', { uid: u, phase: 'downloadStart', quality: q });

    try {
      const r = await fetch(url, { cache: 'no-cache' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);

      const blob = await r.blob();
      if (!(blob instanceof Blob)) throw new Error('Not a blob');

      const wrote = await setAudioBlob(u, q, blob);
      if (!wrote) throw new Error('IndexedDB write failed');

      const bytes = (typeof blob.size === 'number' && Number.isFinite(blob.size) && blob.size > 0)
        ? Math.floor(blob.size)
        : 0;

      await setBytes(u, q, bytes);

      this._em.emit('progress', { uid: u, phase: 'downloadDone', quality: q, bytes });

      // Cloud activation only after CQ complete
      try {
        const cq = await this.getCacheQuality();
        if (q === cq) await this._maybeActivateCloudAfterCqComplete(u);
      } catch {}

      // Eviction best-effort after write (to keep within quota)
      try { await this.checkEviction(); } catch {}

      return { ok: true, cached: true, reason: 'downloaded', bytes };
    } catch (e) {
      this._em.emit('progress', { uid: u, phase: 'downloadError', quality: q, error: String(e?.message || e) });
      return { ok: false, reason: 'downloadError' };
    }
  }

  // =========================
  // Playback resolver bridge for PlayerCore
  // =========================
  async resolveForPlayback(track, pq) {
    const cq = await this.getCacheQuality();
    const offlineMode = this.isOfflineMode();
    const network = getNetworkStatusSafe();

    const r = await resolvePlaybackSource({
      track,
      pq: normQ(pq),
      cq,
      offlineMode,
      network
    });

    return {
      url: r?.url || null,
      pq: normQ(pq),
      cq,
      effectiveQuality: r?.effectiveQuality || normQ(pq),
      isLocal: !!r?.isLocal,
      localQuality: r?.localQuality || null,
      reason: r?.reason || ''
    };
  }
}

//=================================================
// FILE: /scripts/offline/playback-cache.js
// scripts/offline/playback-cache.js
// PlaybackCacheManager (ESM) ‚Äî MVP.
// –í —ç—Ç–æ–º –∫–æ–º–º–∏—Ç–µ –æ–Ω –Ω–µ —Å–∫–∞—á–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ, –∞ —Ç–æ–ª—å–∫–æ "–ø–ª–∞–Ω–∏—Ä—É–µ—Ç" –æ–∫–Ω–æ –∏ —ç–º–∏—Ç–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ queue.
// –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã scripts/app/playback-cache-bootstrap.js —Ä–∞–±–æ—Ç–∞–ª –∏ –Ω–µ –ø–∞–¥–∞–ª.

function normPq(pq) {
  const q = String(pq || '').toLowerCase();
  return (q === 'lo') ? 'lo' : 'hi';
}

function uidOfTrack(t) {
  const uid = String(t?.uid || '').trim();
  return uid || null;
}

export class PlaybackCacheManager {
  constructor({ queue, getPlaylistCtx } = {}) {
    this.queue = queue;
    this.getPlaylistCtx = getPlaylistCtx;
  }

  async ensureWindowFullyCached(pq, trackProvider) {
    const ctx = (typeof this.getPlaylistCtx === 'function') ? this.getPlaylistCtx() : null;
    const list = Array.isArray(ctx?.list) ? ctx.list : [];
    if (list.length === 0) return;

    const curUid = ctx?.curUid ? String(ctx.curUid) : null;
    const curIdx = curUid ? list.findIndex(t => uidOfTrack(t) === curUid) : -1;
    if (curIdx < 0) return;

    const q = normPq(pq);
    const dir = String(ctx?.direction || 'forward') === 'backward' ? 'backward' : 'forward';

    const prevIdx = (curIdx - 1 + list.length) % list.length;
    const nextIdx = (curIdx + 1) % list.length;

    const prevUid = uidOfTrack(list[prevIdx]);
    const nextUid = uidOfTrack(list[nextIdx]);

    const om = window.OfflineUI?.offlineManager;
    if (!om || typeof om.enqueueAudioDownload !== 'function') return;

    const enqueue = (uid, priority) => {
      if (!uid) return;

      const meta = (typeof trackProvider === 'function') ? trackProvider(uid) : null;
      if (!meta) return;

      om.enqueueAudioDownload({
        uid,
        quality: q, // ‚úÖ PlaybackCache –∫–∞—á–∞–µ—Ç –≤ PQ (–¢–ó 7.4/7.7)
        key: `pc:${q}:${uid}`,
        priority,
        userInitiated: false,
        isMass: false,
        kind: 'playbackCache'
      });
    };

    // ‚úÖ –¢–ó 7.7: CUR, –ø–æ—Ç–æ–º –æ–¥–∏–Ω —Å–æ—Å–µ–¥ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
    enqueue(curUid, 30);
    enqueue(dir === 'backward' ? prevUid : nextUid, 20);
  }
}

//=================================================
// FILE: /scripts/offline/track-resolver.js
// scripts/offline/track-resolver.js
// TrackResolver (ESM) ‚Äî –≤—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ PQ‚ÜîCQ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.
// –í–∞–∂–Ω–æ: –≤ —ç—Ç–æ–º –∫–æ–º–º–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π URL (blob/objectURL) –µ—â—ë –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω,
// –ø–æ—ç—Ç–æ–º—É "local" –ø–æ–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç "–ª–æ–∫–∞–ª—å–Ω–æ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç", –Ω–æ url –≤–µ—Ä–Ω—ë–º network URL,
// –ª–∏–±–æ null –µ—Å–ª–∏ —Å–µ—Ç–∏ –Ω–µ—Ç –∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ URL –Ω–µ—Ç.

import { bytesByQuality, getAudioBlob } from './cache-db.js';
import { getTrackByUid } from '../app/track-registry.js';

function normQ(v) {
  return String(v || '').toLowerCase() === 'lo' ? 'lo' : 'hi';
}

function getNetworkStatus() {
  try {
    if (window.NetworkManager && typeof window.NetworkManager.getStatus === 'function') {
      return window.NetworkManager.getStatus();
    }
  } catch {}
  return { online: navigator.onLine !== false, kind: 'unknown', raw: null, saveData: false };
}
const objectUrlCache = new Map(); // key -> { url, ts }
const OBJECT_URL_TTL_MS = 30 * 60 * 1000;

function getCachedObjectUrl(key) {
  const rec = objectUrlCache.get(key);
  if (!rec) return null;
  if ((Date.now() - rec.ts) > OBJECT_URL_TTL_MS) {
    try { URL.revokeObjectURL(rec.url); } catch {}
    objectUrlCache.delete(key);
    return null;
  }
  return rec.url;
}

function setCachedObjectUrl(key, url) {
  objectUrlCache.set(key, { url, ts: Date.now() });
  return url;
}

async function hasCachedEnough(uid, q) {
  const u = String(uid || '').trim();
  if (!u) return false;

  const MB = 1024 * 1024;

  const meta = getTrackByUid(u);
  const needMb = q === 'hi'
    ? Number(meta?.sizeHi || meta?.size || 0)
    : Number(meta?.sizeLo || meta?.size_low || 0);

  if (!(Number.isFinite(needMb) && needMb > 0)) return false;

  const needBytes = Math.floor(needMb * MB);

  const b = await bytesByQuality(u);
  const haveBytes = q === 'hi' ? Number(b.hi || 0) : Number(b.lo || 0);

  if (!(Number.isFinite(haveBytes) && haveBytes > 0)) return false;

  // ‚úÖ –î–æ–ø—É—Å–∫ 92% (–∫–∞–∫ –≤ –¢–ó): —Å—á–∏—Ç–∞–µ–º complete, –µ—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ä–∞–∑–º–µ—Ä—É.
  return haveBytes >= Math.floor(needBytes * 0.92);
}

/**
 * resolvePlaybackSource
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
 * - url: string|null
 * - effectiveQuality: 'hi'|'lo' (–∫–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∞–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º)
 * - isLocal: boolean (–º–æ–∂–µ–º –ª–∏ –∏–≥—Ä–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å)
 * - localQuality: 'hi'|'lo'|null (–∫–∞–∫–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–µ–Ω)
 * - reason: string (debug)
 */
export async function resolvePlaybackSource(params) {
  const track = params?.track || null;
  const pq = normQ(params?.pq);
  const cq = normQ(params?.cq);
  const offlineMode = !!params?.offlineMode;
  const st = params?.network || getNetworkStatus();

  const uid = String(track?.uid || '').trim() || null;

  // network urls from track meta (support both new and legacy shapes)
  const sources = track?.sources || null;

  const urlHi =
    String(sources?.audio?.hi || '').trim() ||
    String(track?.audio || track?.src || '').trim() ||
    null;

  const urlLo =
    String(sources?.audio?.lo || '').trim() ||
    String(track?.audio_low || '').trim() ||
    null;

  const pickNetworkUrl = (q) => {
    if (q === 'lo') return urlLo || urlHi || null;
    return urlHi || urlLo || null;
  };

  // –õ–æ–∫–∞–ª—å–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (MVP –ø–æ bytes):
  const localHi = uid ? await hasCachedEnough(uid, 'hi') : false;
  const localLo = uid ? await hasCachedEnough(uid, 'lo') : false;

  const localQuality = localHi ? 'hi' : (localLo ? 'lo' : null);

  // PQ‚ÜîCQ –ø—Ä–∞–≤–∏–ª–æ:
  // –µ—Å–ª–∏ CQ –≤—ã—à–µ PQ –∏ –ª–æ–∫–∞–ª—å–Ω–æ –µ—Å—Ç—å hi ‚Äî –≤—ã–±–∏—Ä–∞–µ–º hi (effectiveQuality='hi')
  // –∏–Ω–∞—á–µ –≤—ã–±–∏—Ä–∞–µ–º PQ (—Å fallback –ø–æ url –Ω–∞–ª–∏—á–∏—é)
  const effectiveQuality = (() => {
    if (pq === 'lo' && cq === 'hi' && localHi) return 'hi';
    return pq;
  })();

  // –ï—Å–ª–∏ —Å–µ—Ç–∏ –Ω–µ—Ç:
  // - –µ—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π URL -> –º–æ–∂–µ–º –∏–≥—Ä–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ (–ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
  // - –∏–Ω–∞—á–µ url=null (–Ω—É–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–µ–∫)
  if (!st?.online) {
    // ‚úÖ –°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π blob –≤ effectiveQuality,
    // –∑–∞—Ç–µ–º fallback –Ω–∞ –¥—Ä—É–≥–æ–π —É—Ä–æ–≤–µ–Ω—å (–µ—Å–ª–∏ –µ—Å—Ç—å).
    if (uid) {
      const want = effectiveQuality;
      const alt = want === 'hi' ? 'lo' : 'hi';

      const tryLocal = async (q) => {
        const key = `${uid}:${q}`;
        const cached = getCachedObjectUrl(key);
        if (cached) return cached;

        const blob = await getAudioBlob(uid, q);
        if (!blob) return null;

        const url = URL.createObjectURL(blob);
        return setCachedObjectUrl(key, url);
      };

      const localUrl = await tryLocal(want) || await tryLocal(alt);

      if (localUrl) {
        return {
          url: localUrl,
          effectiveQuality: want,
          isLocal: true,
          localQuality,
          reason: 'localBlob'
        };
      }
    }

    return {
      url: null,
      effectiveQuality,
      isLocal: false,
      localQuality,
      reason: offlineMode ? 'offlineMode:noNetwork:noLocalBlob' : 'noNetwork:noLocalBlob'
    };
  }

  // ‚úÖ –°–µ—Ç—å –µ—Å—Ç—å:
  // –¢–ó 11.2.A: –µ—Å–ª–∏ OFFLINE mode –≤—ã–∫–ª—é—á–µ–Ω ‚Äî Playback Cache —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äú–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å–µ—Ç—å‚Äù.
  // –ü–æ—ç—Ç–æ–º—É –ø—Ä–∏ offlineMode=false –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ blob, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å.
  // –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–µ—Ç–∏ (—Å–º. –≤—ã—à–µ) local blob —Ä–∞–∑—Ä–µ—à—ë–Ω –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.
  if (offlineMode) {
    // –ü–æ –¢–ó 6/7: –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ ‚â• PQ –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ —Å–µ—Ç—å—é (–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è GitHub).
    if (uid) {
      const want = effectiveQuality;

      const tryLocal = async (q) => {
        const key = `${uid}:${q}`;
        const cached = getCachedObjectUrl(key);
        if (cached) return cached;

        const blob = await getAudioBlob(uid, q);
        if (!blob) return null;

        const objUrl = URL.createObjectURL(blob);
        return setCachedObjectUrl(key, objUrl);
      };

      // 1) –ø—Ä–æ–±—É–µ–º –∂–µ–ª–∞–µ–º–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (effectiveQuality)
      const localUrl = await tryLocal(want);

      // 2) PQ=Lo: –µ—Å–ª–∏ Lo –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –µ—Å—Ç—å Hi ‚Äî –º–æ–∂–µ–º —É–ª—É—á—à–∏—Ç—å (–¢–ó 6.2)
      const localUrl2 = (!localUrl && want === 'lo') ? await tryLocal('hi') : null;

      const chosenLocal = localUrl || localUrl2;

      if (chosenLocal) {
        return {
          url: chosenLocal,
          effectiveQuality: want,
          isLocal: true,
          localQuality,
          reason: 'localBlob'
        };
      }
    }
  }

  // OFFLINE mode OFF (–∏–ª–∏ OFFLINE ON, –Ω–æ –ª–æ–∫–∞–ª–∏ –Ω–µ—Ç) ‚Äî –∏–≥—Ä–∞–µ–º –ø–æ —Å–µ—Ç–∏ –≤ effectiveQuality
  const url = pickNetworkUrl(effectiveQuality);

  return {
    url: url || null,
    effectiveQuality,
    isLocal: false,
    localQuality,
    reason: 'network'
  };
}

export const TrackResolver = { resolvePlaybackSource };

//=================================================
// FILE: /scripts/ui/cache-progress-overlay.js
// scripts/ui/cache-progress-overlay.js
// AC12: –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —Å–ª–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫—ç—à–∞ (CQ) –ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞.
// –ù–µ —Ç—Ä–æ–≥–∞–µ–º PlayerCore –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å/seek. –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã I1/I2 —Å–æ–±–ª—é–¥–µ–Ω—ã.

import { bytesByQuality } from '../offline/cache-db.js';
// OfflineUI –±–µ—Ä–µ–º –∏–∑ window
import { getTrackByUid } from '../app/track-registry.js';

const CSS_TEXT = `
  #player-progress-bar { position: relative; }
  #player-cache-fill {
    position: absolute;
    inset: 0;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
    border-radius: 3px;
    pointer-events: none;
    z-index: 0; /* –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º fill */
  }
  #player-progress-fill { position: relative; z-index: 1; } /* –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π —Å–≤–µ—Ä—Ö—É */
`;

function injectCssOnce() {
  if (document.getElementById('cache-progress-css')) return;
  const s = document.createElement('style');
  s.id = 'cache-progress-css';
  s.textContent = CSS_TEXT;
  document.head.appendChild(s);
}

function ensureOverlay() {
  const bar = document.getElementById('player-progress-bar');
  if (!bar) return null;
  let ov = document.getElementById('player-cache-fill');
  if (!ov) {
    ov = document.createElement('div');
    ov.id = 'player-cache-fill';
    bar.prepend(ov); // –∫–ª–∞–¥—ë–º –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω–æ–π fill
  }
  return ov;
}

async function computePercentForCurrent() {
  const pc = window.playerCore;
  if (!pc || typeof pc.getCurrentTrack !== 'function') return 0;

  const track = pc.getCurrentTrack();
  if (!track) return 0;

  const uid = String(track.uid || '').trim();
  if (!uid) return 0;

  const mgr = window.OfflineUI?.offlineManager;
  if (!mgr) return 0;

  const cq = await mgr.getCacheQuality();
  const meta = getTrackByUid(uid) || {};

  const needMb = cq === 'hi'
    ? Number(meta.sizeHi || meta.size || 0)
    : Number(meta.sizeLo || meta.size_low || 0);

  if (!(Number.isFinite(needMb) && needMb > 0)) return 0;

  const needBytes = Math.floor(needMb * 1024 * 1024);

  const { hi, lo } = await bytesByQuality(uid);
  const haveBytes = cq === 'hi' ? Number(hi || 0) : Number(lo || 0);

  if (!(Number.isFinite(haveBytes) && haveBytes > 0)) return 0;

  const pct = Math.max(0, Math.min(100, (haveBytes / needBytes) * 100));
  return pct;
}

async function updateOverlay() {
  const ov = ensureOverlay();
  if (!ov) return;
  try {
    const pct = await computePercentForCurrent();
    ov.style.width = `${pct.toFixed(2)}%`;
  } catch {}
}

export function attachCacheProgressOverlay() {
  injectCssOnce();
  ensureOverlay();
  updateOverlay();

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∫—ç—à-–∑–∞–≥—Ä—É–∑–æ–∫ (–±—ã—Å—Ç—Ä–æ –∏ –¥—ë—à–µ–≤–æ)
  const mgr = window.OfflineUI?.offlineManager;
  if (mgr) {
    mgr.on('progress', () => {
      updateOverlay();
    });
  }

  // –õ—ë–≥–∫–∏–π –ø–æ–ª–ª–∏–Ω–≥, —á—Ç–æ–±—ã –ø–æ–π–º–∞—Ç—å —Å–º–µ–Ω—ã —Ç—Ä–µ–∫–∞/–∫–∞—á–µ—Å—Ç–≤–∞, –µ—Å–ª–∏ UI –Ω–µ –ø–æ–≤–µ—Å–∏–ª —Å–æ–±—ã—Ç–∏–µ
  setInterval(updateOverlay, 1000);
}

//=================================================
// FILE: /scripts/ui/cloud-menu.js
// scripts/ui/cloud-menu.js
// –ú–µ–Ω—é –¥–ª—è ‚òÅ (–¢–ó: "–î–æ–±–∞–≤–∏—Ç—å üîí" / "–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞")

export function attachCloudMenu({ root, onAddLock, onRemoveCache } = {}) {
  const el = root;
  if (!el) return;

  const mgr = window.OfflineUI?.offlineManager;
  const openModal = window.Modals?.open;
  const actionRow = window.Modals?.actionRow;

  if (typeof openModal !== 'function') return;

  const modal = openModal({
    title: 'Cloud ‚òÅ',
    maxWidth: 420,
    bodyHtml: `
      <div style="color:#9db7dd; line-height:1.45; margin-bottom:14px;">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–ª–∞—á–Ω—ã–º –∫—ç—à–µ–º —Ç—Ä–µ–∫–∞.
      </div>
      ${typeof actionRow === 'function' ? actionRow([
        { act: 'add', text: '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–æ—á–µ–∫ üîí', className: 'online', style: 'min-width:170px;' },
        { act: 'remove', text: '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞', className: '', style: 'min-width:170px;' }
      ]) : ''}
    `
  });

  modal.querySelector('[data-act="add"]')?.addEventListener('click', async () => {
    try {
      if (typeof onAddLock === 'function') await onAddLock();
      window.NotificationSystem?.success('–¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ pinned üîí');
    } catch {
      window.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ pinned');
    } finally {
      try { modal.remove(); } catch {}
    }
  });

  modal.querySelector('[data-act="remove"]')?.addEventListener('click', async () => {
    try { modal.remove(); } catch {}

    if (window.Modals?.confirm) {
      window.Modals.confirm({
        title: '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫—ç—à–∞?',
        textHtml: 'Cloud‚Äë—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–∞.',
        confirmText: '–£–¥–∞–ª–∏—Ç—å',
        cancelText: '–û—Ç–º–µ–Ω–∞',
        danger: true,
        onConfirm: async () => {
          try {
            if (typeof onRemoveCache === 'function') {
              await onRemoveCache();
            } else {
              const uid = String(el.dataset?.uid || '').trim();
              if (uid && mgr) await mgr.cloudMenu(uid, 'remove-cache');
            }
            window.NotificationSystem?.success('–¢—Ä–µ–∫ —É–¥–∞–ª—ë–Ω –∏–∑ cloud');
          } catch {
            window.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑ cloud');
          }
        }
      });
    }
  });
}

//=================================================
// FILE: /scripts/ui/favorites-const.js
// scripts/ui/favorites-const.js
// –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∫–ª—é—á–µ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª.
// –í–∞–∂–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –ø—Ä–æ–∫–∏–Ω–µ–º –≤ window, —á—Ç–æ–±—ã –∏—Ö –≤–∏–¥–µ–ª inline-–∫–æ–¥ index.html.

const SPECIAL_FAVORITES_KEY = '__favorites__';
const SPECIAL_RELIZ_KEY = '__reliz__';

// likedTracks:v2 –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª—é—á –ª–∞–π–∫–æ–≤: likedTrackUids:v1 (uid-based).

// –ö–ª—é—á —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å—Å—ã–ª–æ–∫ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª (refs)
const FAVORITES_REFS_KEY = 'favoritesAlbumRefs:v1';

// Back-compat –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ inline-–∫–æ–¥–∞:
Object.assign(window, {
  SPECIAL_FAVORITES_KEY,
  SPECIAL_RELIZ_KEY,
  FAVORITES_REFS_KEY,
});

//=================================================
// FILE: /scripts/ui/favorites-data.js
// scripts/ui/favorites-data.js
// Data-—Ö–µ–ª–ø–µ—Ä—ã ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª + –º–æ–¥–µ–ª—å refs –ø–æ UID + –º–∏–≥—Ä–∞—Ü–∏—è legacy refs.

(function FavoritesDataModule() {
  const w = window;

  const LEGACY_REFS_KEY = w.FAVORITES_REFS_KEY || 'favoritesAlbumRefs:v1';
  const REFS_UID_KEY = 'favoritesAlbumRefsByUid:v1';

  const COVER_TTL_MS = 12 * 60 * 60 * 1000;
  const albumCoverCache = Object.create(null);

  const absJoin = typeof w.absJoin === 'function'
    ? w.absJoin
    : ((b, r) => new URL(String(r || ''), String(b || '') + '/').toString());

  function getLikedUidMap() {
    if (w.FavoritesManager && typeof w.FavoritesManager.getLikedUidMap === 'function') {
      return w.FavoritesManager.getLikedUidMap();
    }
    try {
      const raw = localStorage.getItem('likedTrackUids:v1');
      const obj = raw ? JSON.parse(raw) : {};
      return obj && typeof obj === 'object' ? obj : {};
    } catch {
      return {};
    }
  }

  function getLikedUidsForAlbum(albumKey) {
    try {
      const map = getLikedUidMap();
      const arr = (map && typeof map === 'object') ? map[albumKey] : [];
      if (!Array.isArray(arr)) return [];
      return Array.from(new Set(arr.map(x => String(x || '').trim()).filter(Boolean)));
    } catch {
      return [];
    }
  }

  function readFavoritesRefsByUid() {
    try {
      const raw = localStorage.getItem(REFS_UID_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  function writeFavoritesRefsByUid(arr) {
    try {
      localStorage.setItem(REFS_UID_KEY, JSON.stringify(Array.isArray(arr) ? arr : []));
    } catch {}
  }

  async function migrateLegacyRefsIfNeeded() {
    try {
      const already = localStorage.getItem(REFS_UID_KEY);
      if (already) return;
    } catch {}

    let legacyRaw = null;
    try { legacyRaw = localStorage.getItem(LEGACY_REFS_KEY); } catch {}
    if (!legacyRaw) {
      writeFavoritesRefsByUid([]);
      return;
    }

    let legacy = null;
    try { legacy = JSON.parse(legacyRaw); } catch { legacy = []; }
    if (!Array.isArray(legacy) || legacy.length === 0) {
      writeFavoritesRefsByUid([]);
      return;
    }

    const albumsIndex = Array.isArray(w.albumsIndex) ? w.albumsIndex : [];
    if (!albumsIndex.length) {
      writeFavoritesRefsByUid([]);
      return;
    }

    const out = [];
    const seen = new Set();

    for (const ref of legacy) {
      const a = String(ref?.a || '').trim();
      const t = parseInt(ref?.t, 10);
      if (!a || !Number.isFinite(t)) continue;

      const meta = albumsIndex.find(x => x && x.key === a);
      if (!meta || !meta.base) continue;

      let cfg = null;
      try {
        const r = await fetch(absJoin(meta.base, 'config.json'), { cache: 'no-cache' });
        if (!r.ok) continue;
        cfg = await r.json();
      } catch {
        continue;
      }

      const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : [];
      const tr = tracks[t] || null;
      const uid = String(tr?.uid || '').trim();
      if (!uid) continue;

      const k = `${a}:${uid}`;
      if (seen.has(k)) continue;
      seen.add(k);
      out.push({ a, uid });
    }

    writeFavoritesRefsByUid(out);
  }

  function addFavoritesRefIfMissing(albumKey, uid) {
    if (w.FavoritesManager && typeof w.FavoritesManager.addRef === 'function') {
      return w.FavoritesManager.addRef(albumKey, uid);
    }
    const a = String(albumKey || '').trim();
    const u = String(uid || '').trim();
    if (!a || !u) return false;
    const refs = readFavoritesRefsByUid();
    const exists = refs.some(r => r && r.a === a && String(r.uid || '').trim() === u);
    if (exists) return false;
    refs.push({ a, uid: u });
    writeFavoritesRefsByUid(refs);
    return true;
  }

  function removeFavoritesRef(albumKey, uid) {
    if (w.FavoritesManager && typeof w.FavoritesManager.removeRef === 'function') {
      return w.FavoritesManager.removeRef(albumKey, uid);
    }
    const a = String(albumKey || '').trim();
    const u = String(uid || '').trim();
    if (!a || !u) return false;
    const refs = readFavoritesRefsByUid();
    const next = refs.filter(r => !(r && r.a === a && String(r.uid || '').trim() === u));
    writeFavoritesRefsByUid(next);
    if (Array.isArray(w.favoritesRefsModel)) {
      w.favoritesRefsModel = w.favoritesRefsModel.filter(it => !(it && it.__a === a && it.__uid === u));
    }
    return next.length !== refs.length;
  }

  function getSortedFavoritesRefsByUid() {
    const refs = readFavoritesRefsByUid().slice();
    const order = (w.ICON_ALBUMS_ORDER || []).map(x => x.key)
      .filter(k => k !== w.SPECIAL_FAVORITES_KEY && k !== w.SPECIAL_RELIZ_KEY);
    const orderMap = new Map(order.map((k, i) => [k, i]));

    refs.sort((r1, r2) => {
      const o1 = orderMap.has(r1.a) ? orderMap.get(r1.a) : 999;
      const o2 = orderMap.has(r2.a) ? orderMap.get(r2.a) : 999;
      if (o1 !== o2) return o1 - o2;
      return String(r1.uid || '').localeCompare(String(r2.uid || ''));
    });

    return refs;
  }

  async function getAlbumConfigByKey(albumKey) {
    if (!albumKey) return null;
    const albumConfigCache = w.albumConfigCache || {};
    if (albumConfigCache[albumKey]?.config) return albumConfigCache[albumKey].config;

    const albumsIndex = Array.isArray(w.albumsIndex) ? w.albumsIndex : [];
    const meta = albumsIndex.find(a => a && a.key === albumKey) || null;
    if (!meta) return null;

    try {
      const r = await fetch(absJoin(meta.base, 'config.json'), { cache: 'no-cache' });
      if (!r.ok) return null;
      const data = await r.json();

      (data.tracks || []).forEach(t => {
        if (t.audio) t.audio = absJoin(meta.base, t.audio);
        if (t.lyrics) t.lyrics = absJoin(meta.base, t.lyrics);
        if (t.fulltext) t.fulltext = absJoin(meta.base, t.fulltext);
      });

      albumConfigCache[albumKey] = { base: meta.base, config: data };
      w.albumConfigCache = albumConfigCache;
      return data;
    } catch {
      return null;
    }
  }

  async function getAlbumCoverUrl(albumKey) {
    const now = Date.now();

    try {
      const sKey = `favCoverCache:v1:${albumKey}`;
      const raw = sessionStorage.getItem(sKey);
      if (raw) {
        const obj = JSON.parse(raw);
        if (obj && obj.url && obj.ts && (now - obj.ts) < COVER_TTL_MS) {
          albumCoverCache[albumKey] = { url: obj.url, ts: obj.ts };
          return obj.url;
        }
      }
    } catch {}

    const cache = albumCoverCache[albumKey];
    if (cache && (now - cache.ts) < COVER_TTL_MS) return cache.url;

    try {
      const url = await w.GalleryManager?.getFirstCoverUrl?.(albumKey);
      const safe = (url && typeof url === 'string') ? url : 'img/logo.png';
      albumCoverCache[albumKey] = { url: safe, ts: now };
      try { sessionStorage.setItem(`favCoverCache:v1:${albumKey}`, JSON.stringify({ url: safe, ts: now })); } catch {}
      return safe;
    } catch {}

    albumCoverCache[albumKey] = { url: 'img/logo.png', ts: now };
    return 'img/logo.png';
  }

  async function buildFavoritesRefsModel() {
    await migrateLegacyRefsIfNeeded();
    const refs = getSortedFavoritesRefsByUid();
    const out = [];

    for (const ref of refs) {
      const a = String(ref?.a || '').trim();
      const uid = String(ref?.uid || '').trim();
      if (!a || !uid) continue;

      let cfg = null;
      try { cfg = await getAlbumConfigByKey(a); } catch {}

      const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : [];
      const tr = tracks.find(t => String(t?.uid || '').trim() === uid) || null;

      const cover = await getAlbumCoverUrl(a);
      const isActive = getLikedUidsForAlbum(a).includes(uid);

      out.push({
        title: tr?.title || '–¢—Ä–µ–∫',
        uid,
        audio: (isActive && tr?.audio) ? tr.audio : null,
        lyrics: (isActive && tr?.lyrics) ? tr.lyrics : null,
        fulltext: (isActive && tr?.fulltext) ? (tr.fulltext || null) : null,
        __a: a,
        __uid: uid,
        __artist: cfg?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        __album: cfg?.albumName || '–ê–ª—å–±–æ–º',
        __active: isActive,
        __cover: cover
      });
    }

    w.favoritesRefsModel = out;
    return out;
  }

  function updateFavoritesRefsModelActiveFlag(albumKey, uid, isActive) {
    const a = String(albumKey || '').trim();
    const u = String(uid || '').trim();
    const model = w.favoritesRefsModel;
    if (!a || !u || !Array.isArray(model)) return;

    const item = model.find(x => x && x.__a === a && x.__uid === u);
    if (!item) return;

    item.__active = !!isActive;
    if (!item.__active) {
      item.audio = null;
      item.lyrics = null;
      item.fulltext = null;
    }
  }

  async function showFavoritesInactiveModal(params) {
    const albumKey = String(params?.albumKey || '').trim();
    const uid = String(params?.uid || '').trim();
    const title = String(params?.title || '–¢—Ä–µ–∫');

    if (!albumKey || !uid) return;

    const openModal = window.Modals?.open;
    const actionRow = window.Modals?.actionRow;
    const esc = w.Utils?.escapeHtml || ((s) => String(s || ''));

    if (typeof openModal !== 'function') return;

    const modal = openModal({
      title: '–¢—Ä–µ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω',
      maxWidth: 420,
      bodyHtml: `
        <div style="color:#9db7dd; line-height:1.45; margin-bottom:14px;">
          <div style="margin-bottom:8px;"><strong>–¢—Ä–µ–∫:</strong> ${esc(title)}</div>
          <div style="opacity:.9;">–í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å —Ç—Ä–µ–∫ –≤ ‚≠ê –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª.</div>
        </div>
        ${typeof actionRow === 'function' ? actionRow([
          { act: 'add', text: '–î–æ–±–∞–≤–∏—Ç—å –≤ ‚≠ê', className: 'online', style: 'min-width:160px;' },
          { act: 'remove', text: '–£–¥–∞–ª–∏—Ç—å', className: '', style: 'min-width:160px;' }
        ]) : ''}
      `
    });

    modal.querySelector('[data-act="add"]')?.addEventListener('click', () => {
      w.FavoritesManager?.toggleLike?.(albumKey, uid, true);
      try { modal.remove(); } catch {}
    });

    modal.querySelector('[data-act="remove"]')?.addEventListener('click', () => {
      try { modal.remove(); } catch {}
      showFavoritesDeleteConfirm({ albumKey, uid, title, onDeleted: params?.onDeleted });
    });
  }

  async function showFavoritesDeleteConfirm(params) {
    const albumKey = String(params?.albumKey || '').trim();
    const uid = String(params?.uid || '').trim();
    const title = String(params?.title || '–¢—Ä–µ–∫');
    if (!albumKey || !uid) return;

    const esc = w.Utils?.escapeHtml || ((s) => String(s || ''));

    if (window.Modals?.confirm) {
      window.Modals.confirm({
        title: '–£–¥–∞–ª–∏—Ç—å –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª?',
        textHtml: `
          <div style="margin-bottom:8px;"><strong>–¢—Ä–µ–∫:</strong> ${esc(title)}</div>
          <div style="opacity:.9;">–¢—Ä–µ–∫ –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê —É–∂–µ —Å–Ω—è—Ç–∞.</div>
        `,
        confirmText: '–£–¥–∞–ª–∏—Ç—å',
        cancelText: '–û—Ç–º–µ–Ω–∞',
        danger: false,
        onConfirm: () => {
          const ok = w.FavoritesManager?.removeRef
            ? w.FavoritesManager.removeRef(albumKey, uid, { source: 'favoritesModal' })
            : removeFavoritesRef(albumKey, uid);

          if (ok) {
            w.NotificationSystem?.success('–£–¥–∞–ª–µ–Ω–æ –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª');
            try { params?.onDeleted?.(); } catch {}
          } else {
            w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
          }
        }
      });
      return;
    }

    // Fallback –µ—Å–ª–∏ Modals.confirm –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    const openModal = window.Modals?.open;
    const actionRow = window.Modals?.actionRow;

    if (typeof openModal !== 'function') return;

    const modal = openModal({
      title: '–£–¥–∞–ª–∏—Ç—å –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª?',
      maxWidth: 420,
      bodyHtml: `
        <div style="color:#9db7dd; line-height:1.45; margin-bottom:14px;">
          <div style="margin-bottom:8px;"><strong>–¢—Ä–µ–∫:</strong> ${esc(title)}</div>
          <div style="opacity:.9;">–¢—Ä–µ–∫ –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê —É–∂–µ —Å–Ω—è—Ç–∞.</div>
        </div>
        ${typeof actionRow === 'function' ? actionRow([
          { act: 'cancel', text: '–û—Ç–º–µ–Ω–∞', className: '', style: 'min-width:130px;' },
          { act: 'delete', text: '–£–¥–∞–ª–∏—Ç—å', className: 'online', style: 'min-width:130px;' }
        ]) : ''}
      `
    });

    modal.querySelector('[data-act="cancel"]')?.addEventListener('click', () => {
      try { modal.remove(); } catch {}
    });

    modal.querySelector('[data-act="delete"]')?.addEventListener('click', () => {
      const ok = w.FavoritesManager?.removeRef
        ? w.FavoritesManager.removeRef(albumKey, uid, { source: 'favoritesModal' })
        : removeFavoritesRef(albumKey, uid);

      try { modal.remove(); } catch {}

      if (ok) {
        w.NotificationSystem?.success('–£–¥–∞–ª–µ–Ω–æ –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª');
        try { params?.onDeleted?.(); } catch {}
      } else {
        w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
      }
    });
  }

  window.addEventListener('favorites:changed', (e) => {
    const d = e?.detail || {};
    const a = String(d.albumKey || '').trim();
    const uid = String(d.uid || '').trim();
    const liked = !!d.liked;
    if (!a || !uid) return;

    try {
      updateFavoritesRefsModelActiveFlag(a, uid, liked);
    } catch {}
  });

  w.FavoritesData = {
    readFavoritesRefsByUid,
    writeFavoritesRefsByUid,
    addFavoritesRefIfMissing,
    removeFavoritesRef,
    getSortedFavoritesRefsByUid,
    buildFavoritesRefsModel,
    updateFavoritesRefsModelActiveFlag,
    getAlbumConfigByKey,
    getAlbumCoverUrl,
    showFavoritesInactiveModal,
    showFavoritesDeleteConfirm
  };

  w.buildFavoritesRefsModel = buildFavoritesRefsModel;
  w.updateFavoritesRefsModelActiveFlag = updateFavoritesRefsModelActiveFlag;
})();

//=================================================
// FILE: /scripts/ui/favorites-view.js
// scripts/ui/favorites-view.js
// –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"

(function FavoritesViewModule() {
  'use strict';

  const w = window;

  async function openFavoritesView() {
    // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –≤ AlbumsManager
    if (w.AlbumsManager) {
      await w.AlbumsManager.loadAlbum('__favorites__');
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç
  w.openFavoritesView = openFavoritesView;

  console.log('‚úÖ Favorites view module loaded');
})();

//=================================================
// FILE: /scripts/ui/favorites.js
// scripts/ui/favorites.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–º–∏ —Ç—Ä–µ–∫–∞–º–∏ –ø–æ UID (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã).
// Storage: likedTrackUids:v1 => { [albumKey]: string[] }
// Refs: favoritesAlbumRefsByUid:v1 => [{ a: albumKey, uid: string }]
class FavoritesManager {
  constructor() {
    this.storageKey = 'likedTrackUids:v1';
    this.refsKey = 'favoritesAlbumRefsByUid:v1';
  }

  async initialize() {
    try {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è likedTrackUids:v1
      const raw = localStorage.getItem(this.storageKey);
      if (!raw) {
        localStorage.setItem(this.storageKey, JSON.stringify({}));
      } else {
        const j = JSON.parse(raw);
        if (!j || typeof j !== 'object') {
          localStorage.setItem(this.storageKey, JSON.stringify({}));
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è favoritesAlbumRefsByUid:v1
      const rawRefs = localStorage.getItem(this.refsKey);
      if (!rawRefs) {
        localStorage.setItem(this.refsKey, JSON.stringify([]));
      } else {
        const j = JSON.parse(rawRefs);
        if (!Array.isArray(j)) {
          localStorage.setItem(this.refsKey, JSON.stringify([]));
        }
      }

      console.log('‚úÖ FavoritesManager initialized (uid-based)');
    } catch (e) {
      console.warn('FavoritesManager.initialize failed:', e);
    }
  }

  _emitChange(payload) {
    // ‚úÖ Realtime sync: –≤—Å–µ –º–µ—Å—Ç–∞ UI —Å–ª—É—à–∞—é—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç –∑–≤—ë–∑–¥—ã/—Å–ø–∏—Å–∫–∏/–æ—á–µ—Ä–µ–¥—å.
    try {
      window.dispatchEvent(new CustomEvent('favorites:changed', { detail: payload }));
    } catch {}
  }

  _emitRefsChange(payload) {
    // ‚úÖ Realtime sync –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è refs (—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª, –∏ —Ç.–ø.)
    try {
      window.dispatchEvent(new CustomEvent('favorites:refsChanged', { detail: payload }));
    } catch {}
  }

  getLikedUidMap() {
    try {
      const raw = localStorage.getItem(this.storageKey);
      const map = raw ? JSON.parse(raw) : {};
      return (map && typeof map === 'object') ? map : {};
    } catch {
      return {};
    }
  }

  getLikedUidsForAlbum(albumKey) {
    try {
      const key = String(albumKey || '').trim();
      if (!key) return [];
      const map = this.getLikedUidMap();
      const arr = (map && typeof map === 'object') ? map[key] : [];
      if (!Array.isArray(arr)) return [];
      return Array.from(new Set(arr.map(x => String(x || '').trim()).filter(Boolean)));
    } catch {
      return [];
    }
  }

  isFavorite(albumKey, trackUid) {
    const a = String(albumKey || '').trim();
    const uid = String(trackUid || '').trim();
    if (!a || !uid) return false;
    return this.getLikedUidsForAlbum(a).includes(uid);
  }

  /**
   * source:
   * - 'album'      => ‚≠ê OFF —É–¥–∞–ª—è–µ—Ç ref –ø–æ–ª–Ω–æ—Å—Ç—å—é ("–±–µ–∑ —Å–ª–µ–¥–∞")
   * - 'favorites'  => ‚≠ê OFF –æ—Å—Ç–∞–≤–ª—è–µ—Ç ref (—Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–µ—Ç inactive)
   * - 'mini'       => –∫–∞–∫ 'album' (—ç—Ç–æ –Ω–µ —Å–ø–∏—Å–æ–∫ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª)
   */
  toggleLike(albumKey, trackUid, makeLiked = null, options = {}) {
    const a = String(albumKey || '').trim();
    const uid = String(trackUid || '').trim();
    if (!a || !uid) return false;

    const source = String(options?.source || 'album');

    const map = this.getLikedUidMap();
    const prevArr = Array.isArray(map[a]) ? map[a] : [];
    const arr = Array.from(new Set(prevArr.map(x => String(x || '').trim()).filter(Boolean)));

    const has = arr.includes(uid);
    const shouldLike = (makeLiked !== null) ? !!makeLiked : !has;

    let next = arr.slice();
    if (shouldLike && !has) next.push(uid);
    if (!shouldLike && has) next = next.filter(x => x !== uid);

    if (next.length === 0) {
      delete map[a];
    } else {
      map[a] = Array.from(new Set(next));
    }

    try {
      localStorage.setItem(this.storageKey, JSON.stringify(map));
    } catch {
      return false;
    }

    // ‚úÖ refs-–ª–æ–≥–∏–∫–∞ –ø–æ –¢–ó
    if (shouldLike) {
      // ‚≠ê ON: –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º ref (–µ—Å–ª–∏ –Ω–µ—Ç)
      this.addRef(a, uid);
    } else {
      // ‚≠ê OFF:
      // - –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª ‚Äî ref –ù–ï —É–¥–∞–ª—è–µ–º (–±—É—Ñ–µ—Ä–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è)
      // - –∏–Ω–∞—á–µ (—Ä–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º/–º–∏–Ω–∏) ‚Äî —É–¥–∞–ª—è–µ–º ref –ø–æ–ª–Ω–æ—Å—Ç—å—é
      if (source !== 'favorites') {
        // removeRef —Å–∞–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç favorites:refsChanged (–æ–¥–∏–Ω —Ä–∞–∑)
        this.removeRef(a, uid, { source });
      }
    }

    // Realtime —Å–æ–±—ã—Ç–∏–µ (–¥–æ–±–∞–≤–ª—è–µ–º source)
    this._emitChange({ albumKey: a, uid, liked: shouldLike, source });

    // ‚úÖ –°–ø–µ—Ü-–ø—Ä–∞–≤–∏–ª–æ: –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç __favorites__ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ–ª–∞–ª —Ç—Ä–µ–∫ inactive,
    // —Ç–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π, –∞ –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç ‚Äî stop (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º–∏).
    // –í–∞–∂–Ω–æ: —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è source==='favorites' (—Ç.–µ. –¥–µ–π—Å—Ç–≤–∏–µ –∏–º–µ–Ω–Ω–æ –≤ —Å–ø–∏—Å–∫–µ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª).
    if (!shouldLike && source === 'favorites') {
      this._handlePlayingFavoritesAfterUnlike({ sourceAlbumKey: a, uid });
    }

    return true;
  }

  _handlePlayingFavoritesAfterUnlike({ sourceAlbumKey, uid }) {
    try {
      const playingAlbum = window.AlbumsManager?.getPlayingAlbum?.();
      if (playingAlbum !== window.SPECIAL_FAVORITES_KEY) return;

      const pc = window.playerCore;
      if (!pc) return;

      const cur = pc.getCurrentTrack?.();
      if (!cur) return;

      const curUid = String(cur.uid || '').trim();
      const curSrcAlbum = String(cur.sourceAlbum || '').trim();

      // –†–µ–∞–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–Ω—è–ª–∏ –ª–∞–π–∫ –∏–º–µ–Ω–Ω–æ —É —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ (–≤ __favorites__)
      if (!curUid || curUid !== String(uid || '').trim()) return;
      if (curSrcAlbum && curSrcAlbum !== String(sourceAlbumKey || '').trim()) return;

      // –°–æ–±–µ—Ä—ë–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ favoritesRefsModel
      const model = Array.isArray(window.favoritesRefsModel) ? window.favoritesRefsModel : [];
      const activeItems = model.filter(it => it && it.__active && it.audio);

      if (activeItems.length === 0) {
        // ‚úÖ –ü—Ä–∞–≤–∏–ª–æ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª: –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî –ø–ª–µ–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ STOP.
        // –≠—Ç–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –æ–±—â–µ–≥–æ ‚Äú–Ω–∏—á—Ç–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç‚Äù, –æ–ø–∏—Å–∞–Ω–Ω–æ–µ –≤ –¢–ó ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª.
        pc.stop?.();
        return;
      }

      // –ù–∞–π–¥—ë–º —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π (–ø—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π)
      // –ù–µ —Å—Ç–æ–ø–∞–µ–º. –ï—Å–ª–∏ –ø–ª–µ–µ—Ä —É–∂–µ –∏–≥—Ä–∞–µ—Ç ‚Äî –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç (setPlaylist –Ω–µ —Å—Ç–æ–ø–∞–µ—Ç).
      // AlbumsManager.ensureFavoritesPlayback —Å–∞–º —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–ª–µ–π–ª–∏—Å—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –¥–µ–ª–∞–µ—Ç play().
      const idxInModel = model.findIndex(it =>
        it &&
        String(it.__uid || '').trim() === curUid &&
        String(it.__a || '').trim() === String(sourceAlbumKey || '').trim()
      );

      const nextIndexInModel = (() => {
        // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –≤ model –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–≥–æ, –∏–Ω–∞—á–µ —Å –Ω–∞—á–∞–ª–∞
        const start = Math.max(0, idxInModel + 1);
        for (let i = start; i < model.length; i++) {
          const it = model[i];
          if (it && it.__active && it.audio) return i;
        }
        for (let i = 0; i < model.length; i++) {
          const it = model[i];
          if (it && it.__active && it.audio) return i;
        }
        return -1;
      })();

      if (nextIndexInModel >= 0) {
        window.AlbumsManager?.ensureFavoritesPlayback?.(nextIndexInModel);
      } else {
        // –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ ‚Äú—Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π‚Äù –Ω–µ –Ω–∞–π–¥–µ–Ω, –∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç ‚Äî STOP.
        pc.stop?.();
      }
    } catch (e) {
      console.warn('_handlePlayingFavoritesAfterUnlike failed:', e);
    }
  }

  addRef(albumKey, uid) {
    const a = String(albumKey || '').trim();
    const u = String(uid || '').trim();
    if (!a || !u) return false;

    const refs = this.readRefs();
    const exists = refs.some(r => r && r.a === a && String(r.uid || '').trim() === u);
    if (exists) return false;

    refs.push({ a, uid: u });
    this.writeRefs(refs);
    return true;
  }

  removeRef(albumKey, uid, options = {}) {
    const a = String(albumKey || '').trim();
    const u = String(uid || '').trim();
    if (!a || !u) return false;

    const source = String(options?.source || 'unknown');

    const refs = this.readRefs();
    const next = refs.filter(r => !(r && r.a === a && String(r.uid || '').trim() === u));
    this.writeRefs(next);

    const removed = next.length !== refs.length;
    if (removed) {
      this._emitRefsChange({ action: 'refRemoved', albumKey: a, uid: u, source });
    }

    return removed;
  }

  readRefs() {
    try {
      const raw = localStorage.getItem(this.refsKey);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  writeRefs(arr) {
    try {
      localStorage.setItem(this.refsKey, JSON.stringify(Array.isArray(arr) ? arr : []));
    } catch {}
  }
}
// ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä (–∫—Ä–∏—Ç–∏—á–Ω–æ: –µ–≥–æ –∂–¥—ë—Ç scripts/app.js)
window.FavoritesManager = new FavoritesManager();

//=================================================
// FILE: /scripts/ui/lyrics-modal.js
// scripts/ui/lyrics-modal.js
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –ø–µ—Å–Ω–∏

(function LyricsModalModule() {
  'use strict';

  const w = window;

  function showFullLyricsModal() {
    const track = w.playerCore?.getCurrentTrack();
    if (!track) {
      w.NotificationSystem?.warning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞');
      return;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
    const fulltext = track.fulltext;
    
    if (fulltext) {
      loadFulltextAndShow(fulltext, track);
    } else {
      showLyricsFromTimeline(track);
    }
  }

  async function loadFulltextAndShow(url, track) {
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to load fulltext');
      
      const text = await response.text();
      showModal(track, text);
      
    } catch (error) {
      console.error('Failed to load fulltext:', error);
      w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏');
    }
  }

  function showLyricsFromTimeline(track) {
    // –°–æ–±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ —Ç–∞–π–º–ª–∞–π–Ω–∞ –ª–∏—Ä–∏–∫–∏, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑ PlayerUI
    if (!w.PlayerUI) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –±—ç–∫–æ–º–ø–∞—Ç-API currentLyricsLines, –µ—Å–ª–∏ –µ—Å—Ç—å,
    // –∏–Ω–∞—á–µ –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å —Å—ã—Ä—ã–µ currentLyrics –∏ –≤—ã—Ç–∞—â–∏—Ç—å text.
    const rawLines = Array.isArray(w.PlayerUI.currentLyricsLines)
      ? w.PlayerUI.currentLyricsLines
      : (Array.isArray(w.PlayerUI.currentLyrics) ? w.PlayerUI.currentLyrics : []);

    if (!rawLines.length) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    const lines = rawLines
      .map(item => (typeof item.line === 'string' ? item.line : (item.text || '')))
      .filter(Boolean);

    if (!lines.length) {
      w.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      return;
    }

    const text = lines.join('\n');
    showModal(track, text);
  }

  function showModal(track, text) {
    const esc = w.Utils?.escapeHtml
      ? (s) => w.Utils.escapeHtml(String(s || ''))
      : (s) => String(s || '');

    const html = `
      <div class="modal-feedback lyrics-modal" style="max-width: 520px; max-height: 80vh;">
        <button class="bigclose" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <svg viewBox="0 0 48 48">
            <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          </svg>
        </button>

        <h2 style="margin-bottom: 8px;">${esc(track.title)}</h2>
        <div style="color: #8ab8fd; margin-bottom: 20px; font-size: 14px;">
          ${esc(track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞')} ¬∑ ${esc(track.album || '')}
        </div>

        <div class="lyrics-fulltext" style="
          max-height: 50vh;
          overflow-y: auto;
          padding: 16px;
          background: rgba(0,0,0,0.2);
          border-radius: 10px;
          line-height: 1.8;
          white-space: pre-wrap;
          font-size: 15px;
          scrollbar-width: thin;
          scrollbar-color: rgba(77,170,255,0.3) transparent;
        ">
          ${esc(text)}
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
          <button class="modal-action-btn" id="copy-lyrics-btn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="modal-action-btn" id="share-lyrics-btn">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
      </div>
    `;

    const modal = (w.Utils && typeof w.Utils.createModal === 'function')
      ? w.Utils.createModal(html)
      : null;

    if (!modal) return;

    modal.querySelector('#copy-lyrics-btn')?.addEventListener('click', () => copyLyrics(text, modal));
    modal.querySelector('#share-lyrics-btn')?.addEventListener('click', () => shareLyrics(track, text));
  }

  async function copyLyrics(text, modal) {
    try {
      await navigator.clipboard.writeText(text);
      w.NotificationSystem?.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
      modal.remove();
    } catch (error) {
      // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        w.NotificationSystem?.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
        modal.remove();
      } catch (e) {
        w.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      }
      
      document.body.removeChild(textarea);
    }
  }

  async function shareLyrics(track, text) {
    const shareData = {
      title: track.title,
      text: `${track.title} - ${track.artist}\n\n${text}`
    };

    if (navigator.share) {
      try {
        await navigator.share(shareData);
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Share failed:', error);
        }
      }
    } else {
      w.NotificationSystem?.info('–§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
    }
  }

  // escapeHtml: –∏—Å–ø–æ–ª—å–∑—É–µ–º window.Utils.escapeHtml (–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)

  // –ü—É–±–ª–∏—á–Ω—ã–π API
  w.LyricsModal = {
    show: showFullLyricsModal
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  // (Lyrics Modal –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞)

})();

//=================================================
// FILE: /scripts/ui/modal-templates.js
// scripts/ui/modal-templates.js
// –ï–¥–∏–Ω—ã–π —à–∞–±–ª–æ–Ω –º–æ–¥–∞–ª–æ–∫ (–∫—Ä–æ–º–µ Lyrics)
// API: window.Modals.open(), .confirm(), .actionRow()

(function ModalsModule() {
  'use strict';

  const esc = (s) => {
    const d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  };

  function getContainer() {
    return document.getElementById('modals-container') || document.body;
  }

  /**
   * –°–æ–∑–¥–∞—Ç—å –º–æ–¥–∞–ª–∫—É
   * @param {Object} opts
   * @param {string} opts.title - –∑–∞–≥–æ–ª–æ–≤–æ–∫
   * @param {string} opts.bodyHtml - HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
   * @param {number} opts.maxWidth - –º–∞–∫—Å. —à–∏—Ä–∏–Ω–∞ (px)
   * @param {Function} opts.onClose - callback –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
   * @returns {HTMLElement} —ç–ª–µ–º–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏
   */
  function open(opts = {}) {
    const {
      title = '',
      bodyHtml = '',
      maxWidth = 480,
      onClose = null
    } = opts;

    const bg = document.createElement('div');
    bg.className = 'modal-bg active';

    bg.innerHTML = `
      <div class="modal-feedback" style="max-width: ${maxWidth}px;">
        <button class="bigclose" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <svg viewBox="0 0 48 48">
            <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          </svg>
        </button>
        ${title ? `<h2 style="margin-top:0; color:#4daaff;">${esc(title)}</h2>` : ''}
        <div class="modal-body">${bodyHtml}</div>
      </div>
    `;

    const close = () => {
      try { bg.remove(); } catch {}
      if (typeof onClose === 'function') onClose();
    };

    bg.addEventListener('click', (e) => {
      if (e.target === bg) close();
    });

    const closeBtn = bg.querySelector('.bigclose');
    if (closeBtn) closeBtn.addEventListener('click', close);

    getContainer().appendChild(bg);
    return bg;
  }

  /**
   * –ú–æ–¥–∞–ª–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   * @param {Object} opts
   * @param {string} opts.title
   * @param {string} opts.textHtml
   * @param {string} opts.confirmText
   * @param {string} opts.cancelText
   * @param {boolean} opts.danger - –∫—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   * @param {Function} opts.onConfirm
   * @param {Function} opts.onCancel
   */
  function confirm(opts = {}) {
    const {
      title = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ',
      textHtml = '',
      confirmText = '–î–∞',
      cancelText = '–û—Ç–º–µ–Ω–∞',
      danger = false,
      onConfirm = null,
      onCancel = null
    } = opts;

    const btnStyle = danger
      ? 'background:#E80100; color:#fff;'
      : 'background:#4daaff; color:#fff;';

    const modal = open({
      title,
      maxWidth: 400,
      bodyHtml: `
        <div style="color:#9db7dd; line-height:1.5; margin-bottom:20px;">
          ${textHtml}
        </div>
        <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
          <button class="offline-btn" data-act="cancel" style="min-width:120px;">${esc(cancelText)}</button>
          <button class="offline-btn" data-act="confirm" style="min-width:120px; ${btnStyle}">${esc(confirmText)}</button>
        </div>
      `,
      onClose: onCancel
    });

    modal.querySelector('[data-act="cancel"]')?.addEventListener('click', () => {
      try { modal.remove(); } catch {}
      if (typeof onCancel === 'function') onCancel();
    });

    modal.querySelector('[data-act="confirm"]')?.addEventListener('click', () => {
      try { modal.remove(); } catch {}
      if (typeof onConfirm === 'function') onConfirm();
    });

    return modal;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ç—Ä–æ–∫–∏ –∫–Ω–æ–ø–æ–∫
   * @param {Array} buttons - [{ act, text, className, style }]
   * @returns {string} HTML
   */
  function actionRow(buttons = []) {
    if (!Array.isArray(buttons) || !buttons.length) return '';

    const btns = buttons.map(b => {
      const act = esc(b.act || '');
      const text = esc(b.text || '–ö–Ω–æ–ø–∫–∞');
      const cls = b.className || '';
      const style = b.style || '';
      return `<button class="offline-btn ${cls}" data-act="${act}" style="${style}">${text}</button>`;
    }).join('');

    return `<div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:16px;">${btns}</div>`;
  }

  // –ü—É–±–ª–∏—á–Ω—ã–π API
  window.Modals = {
    open,
    confirm,
    actionRow
  };

  console.log('‚úÖ Modals helper loaded');
})();

//=================================================
// FILE: /scripts/ui/notify.js
// scripts/ui/notify.js
// –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
class NotificationSystem {
  constructor() {
    this.container = null;
    this.queue = [];
    this.isShowing = false;
    this.currentToast = null;
    this.init();
  }
  
  init() {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    this.container = document.createElement('div');
    this.container.id = 'toast-container';
    this.container.style.cssText = `
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      pointer-events: none;
    `;
    document.body.appendChild(this.container);
  }
  
  show(message, type = 'info', duration = 3000) {
    const toast = {
      message,
      type,
      duration,
      id: Date.now() + Math.random()
    };
    this.queue.push(toast);
    this.processQueue();
  }
  
  processQueue() {
    if (this.isShowing || this.queue.length === 0) return;
    this.isShowing = true;
    const toast = this.queue.shift();
    this.displayToast(toast);
  }
  
  displayToast(toast) {
    const toastEl = document.createElement('div');
    toastEl.className = `toast toast-${toast.type}`;
    const emoji = this.getEmoji(toast.type);
    toastEl.innerHTML = `
      <div class="toast-content">
        <span class="toast-emoji">${emoji}</span>
        <span class="toast-message">${this.escapeHtml(toast.message)}</span>
      </div>
    `;
    this.container.appendChild(toastEl);
    this.currentToast = toastEl;
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    requestAnimationFrame(() => {
      toastEl.classList.add('show');
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
    setTimeout(() => {
      this.hideToast(toastEl);
    }, toast.duration);
  }
  
  hideToast(toastEl) {
    if (!toastEl) return;
    toastEl.classList.remove('show');
    setTimeout(() => {
      if (toastEl.parentNode) {
        toastEl.parentNode.removeChild(toastEl);
      }
      this.isShowing = false;
      this.currentToast = null;
      this.processQueue();
    }, 300);
  }
  
  getEmoji(type) {
    const emojis = {
      info: '‚ÑπÔ∏è',
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      offline: 'üì¥'
    };
    return emojis[type] || '‚ÑπÔ∏è';
  }
  
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã
  info(message, duration) {
    this.show(message, 'info', duration || 2000);
  }
  
  success(message, duration) {
    this.show(message, 'success', duration || 2500);
  }
  
  error(message, duration) {
    this.show(message, 'error', duration || 4000);
  }
  
  warning(message, duration) {
    this.show(message, 'warning', duration || 3000);
  }
  
  offline(message, duration) {
    this.show(message, 'offline', duration || 3000);
  }
  
  clear() {
    this.queue = [];
    if (this.currentToast) {
      this.hideToast(this.currentToast);
    }
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.NotificationSystem = new NotificationSystem();
console.log('‚úÖ Notification system initialized');

//=================================================
// FILE: /scripts/ui/offline-indicators.js
// scripts/ui/offline-indicators.js
import { attachCloudMenu } from './cloud-menu.js';

const ICON_CSS = `
  .offline-ico-slot{display:inline-flex;align-items:center;margin-right:6px}
  .offline-ico{cursor:pointer;user-select:none;font-size:14px;line-height:1}
  .offline-ico.gray{opacity:.4}
  .offline-ico.lock{width:1em}
  .offline-ico.cloud{width:1em}
`;
function injectCss() {
  if (document.getElementById('offline-ico-css')) return;
  const s = document.createElement('style');
  s.id = 'offline-ico-css';
  s.textContent = ICON_CSS;
  document.head.appendChild(s);
}

function findUidForRow(row) {
  // 0) –°–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî data-uid –Ω–∞ —Å—Ç—Ä–æ–∫–µ (—Å—Ç–∞–≤–∏–º –≤ scripts/app/albums.js –∏ –≤ favorites render)
  const rowUid = String(row?.dataset?.uid || '').trim();
  if (rowUid) return rowUid;

  // 1) __favorites__: id="fav_{albumKey}_{uid}"
  const id = String(row?.id || '');
  const m = id.match(/^fav_(.+)_(.+)$/);
  if (m && m[2]) return String(m[2]).trim() || null;

  // 2) Fallback: —É –∑–≤–µ–∑–¥—ã –µ—Å—Ç—å data-uid
  const star = row?.querySelector?.('.like-star[data-uid]');
  const starUid = String(star?.dataset?.uid || '').trim();
  if (starUid) return starUid;

  return null;
}

function ensureSlot(row) {
  let slot = row.querySelector(':scope > .offline-ico-slot');
  if (slot) return slot;

  slot = document.createElement('span');
  slot.className = 'offline-ico-slot';

  // –ü–æ–ø—Ä–æ–±—É–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ ‚Äú–Ω–æ–º–µ—Ä–æ–º‚Äù; –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –≤ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏
  const num = row.querySelector('.tnum');
  if (num && num.parentNode === row) {
    row.insertBefore(slot, num);
  } else {
    row.insertBefore(slot, row.firstChild);
  }
  return slot;
}

function renderIndicator(row, state, uid) {
  const slot = ensureSlot(row);
  slot.innerHTML = '';

  const isUnknown = !!state?.unknown;

  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: pinned üîí ‚Üí ‚òÅ (cloud&&100%) ‚Üí —Å–µ—Ä—ã–π üîí
  // –ü–æ–ª—É—á–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ
  const mgr = window.OfflineUI?.offlineManager;

  if (!isUnknown && state.pinned) {
    const el = document.createElement('span');
    el.className = 'offline-ico lock';
    el.textContent = 'üîí';
    el.title = '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –æ—Ñ–ª–∞–π–Ω';
    el.dataset.uid = uid;
    el.dataset.active = 'true';
    el.addEventListener('click', async (e) => {
      e.stopPropagation();
      try { if (mgr) await mgr.unpin(uid); } catch {}
      refreshRow(row);
    });
    slot.appendChild(el);
    return;
  }

  if (!isUnknown && state.cloud && state.cachedComplete) {
    const el = document.createElement('span');
    el.className = 'offline-ico cloud';
    el.textContent = '‚òÅ';
    el.title = '–î–æ—Å—Ç—É–ø–Ω–æ –æ—Ñ–ª–∞–π–Ω –ø–æ –æ–±–ª–∞–∫—É';
    el.dataset.uid = uid;

    el.addEventListener('click', (e) => {
      e.stopPropagation();
      attachCloudMenu({
        root: el,
        onAddLock: async () => { if (mgr) await mgr.pin(uid); refreshRow(row); },
        onRemoveCache: async () => { if (mgr) await mgr.cloudMenu(uid, 'remove-cache'); refreshRow(row); }
      });
    });

    slot.appendChild(el);
    return;
  }

  // —Å–µ—Ä—ã–π üîí (–µ—Å–ª–∏ unknown ‚Äî –Ω–µ –∫–ª–∏–∫–∞–µ—Ç—Å—è)
  const el = document.createElement('span');
  el.className = 'offline-ico lock gray';
  el.textContent = 'üîí';
  el.dataset.uid = uid || '';
  el.dataset.active = 'false';

  if (isUnknown) {
    el.title = 'OFFLINE: UID –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤';
    el.style.pointerEvents = 'none';
    el.style.opacity = '0.25';
    slot.appendChild(el);
    return;
  }

  el.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å –æ—Ñ–ª–∞–π–Ω';
  el.addEventListener('click', async (e) => {
    e.stopPropagation();
    try {
      if (mgr) {
        await mgr.pin(uid);
        // ‚úÖ –¢–ó 20: UX —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ä—Ç–µ
        window.NotificationSystem?.info('–¢—Ä–µ–∫ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ñ–ª–∞–π–Ω. –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ‚Ä¶', 3500);
      }
    } catch {
      window.NotificationSystem?.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å –æ—Ñ–ª–∞–π–Ω');
    }
    refreshRow(row);
  });

  slot.appendChild(el);
}

async function refreshRow(row) {
  const uid = findUidForRow(row);

  // ‚úÖ –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ window
  const mgr = window.OfflineUI?.offlineManager;

  // ‚úÖ –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ OfflineManager –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äî –≤—ã—Ö–æ–¥–∏–º.
  if (!mgr) {
    return; 
  }

  // ‚úÖ –î–∞–∂–µ –µ—Å–ª–∏ uid –ø–æ–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ä—ã–π üîí –∫–∞–∫ ‚Äú–Ω–µ –≥–æ—Ç–æ–≤–æ‚Äù.
  if (!uid) {
    renderIndicator(row, { pinned: false, cloud: false, cachedComplete: false, unknown: true }, '');
    return;
  }

  try {
    const ind = await mgr.getIndicators(uid);
    renderIndicator(row, ind, uid);
  } catch (e) {
    console.warn('Error getting indicators:', e);
  }
}

let __refreshAllTimer = null;

function refreshAll() {
  // ‚úÖ Debounce: –Ω–∞ –ø–∞—á–∫—É DOM-–º—É—Ç–∞—Ü–∏–π/—Å–æ–±—ã—Ç–∏–π –¥–µ–ª–∞–µ–º –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥
  if (__refreshAllTimer) return;

  __refreshAllTimer = setTimeout(() => {
    __refreshAllTimer = null;
    const list = document.querySelectorAll('#track-list .track');
    list.forEach((row) => refreshRow(row));
  }, 50);
}

function bindLiveUpdates() {
  const mgr = window.OfflineUI?.offlineManager;
  if (!mgr) return;

  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∑–∞–≥—Ä—É–∑–æ–∫/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
  mgr.on('progress', (ev) => {
    const uid = String(ev?.uid || '').trim();
    if (!uid) return;

    // ‚úÖ –¢–æ—á–µ—á–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ —Å —ç—Ç–∏–º uid:
    // - –≤ __favorites__ uid —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ data-uid –Ω–∞ —Å—Ç—Ä–æ–∫–µ
    // - –≤ –æ–±—ã—á–Ω—ã—Ö –∞–ª—å–±–æ–º–∞—Ö uid —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ –Ω–∞ —Å—Ç—Ä–æ–∫–µ (scripts/app/albums.js)
    const rows = document.querySelectorAll(`#track-list .track[data-uid="${CSS.escape(uid)}"]`);
    rows.forEach((row) => refreshRow(row));
  });

  // –ü—Ä–∏ –ª—é–±—ã—Ö —Ç–æ—á–µ—á–Ω—ã—Ö –∞–ø–¥–µ–π—Ç–∞—Ö —Å–ø–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, favorites:changed) ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ—Ñ—Ä–µ—à
  window.addEventListener('favorites:changed', () => refreshAll());
  window.addEventListener('favorites:refsChanged', () => refreshAll());
}

export function attachOfflineIndicators() {
  injectCss();
  // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –ø—Ä–æ—Ö–æ–¥
  refreshAll();

  // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º —Å–ø–∏—Å–∫–æ–≤
  const root = document.getElementById('track-list') || document.body;
  const mo = new MutationObserver((muts) => {
    let need = false;
    for (const m of muts) {
      if (m.addedNodes && m.addedNodes.length) need = true;
      if (m.type === 'childList') need = true;
    }
    if (need) refreshAll();
  });
  mo.observe(root, { childList: true, subtree: true });

  bindLiveUpdates();
}

//=================================================
// FILE: /scripts/ui/offline-modal.js
// scripts/ui/offline-modal.js
// OFFLINE Modal (A‚ÄìD) ‚Äî MVP –ø–æ –¢–ó_–ù—å—é.

import { getNetPolicy, setNetPolicy, shouldConfirmByPolicy } from '../offline/net-policy.js';
import { getAllUids, registerTrack } from '../app/track-registry.js';

const ALERT_KEY = 'offline:alert:v1';

function readJson(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    const j = JSON.parse(raw);
    return (j === null || j === undefined) ? fallback : j;
  } catch {
    return fallback;
  }
}

function writeJson(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
}

function getNetworkStatus() {
  try {
    if (window.NetworkManager && typeof window.NetworkManager.getStatus === 'function') {
      return window.NetworkManager.getStatus();
    }
  } catch {}
  return { online: navigator.onLine !== false, kind: 'unknown', raw: null, saveData: false };
}

// ‚úÖ Remote preload: –∑–∞–≥—Ä—É–∑–∏—Ç—å config.json –≤—Å–µ—Ö –∞–ª—å–±–æ–º–æ–≤
export async function preloadAllAlbumsTrackIndex() {
  const albums = Array.isArray(window.albumsIndex) ? window.albumsIndex : [];
  if (!albums.length) {
    return { ok: false, reason: 'noAlbumsIndex', totalAlbums: 0, totalTracks: 0, uids: [] };
  }

  const uids = new Set();
  let totalTracks = 0;
  let okAlbums = 0;
  let failAlbums = 0;

  for (const a of albums) {
    const baseRaw = String(a?.base || '').trim();
    if (!baseRaw) { failAlbums += 1; continue; }

    const base = baseRaw.endsWith('/') ? baseRaw : `${baseRaw}/`;
    const url = `${base}config.json`;

    try {
      const r = await fetch(url, { cache: 'no-cache' });
      if (!r.ok) { failAlbums += 1; continue; }

      const cfg = await r.json();
      const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : [];
      okAlbums += 1;

      for (const t of tracks) {
        const uid = String(t?.uid || '').trim();
        if (!uid) continue;

        totalTracks += 1;
        uids.add(uid);

        const audio = t?.audio ? new URL(String(t.audio), base).toString() : null;
        const audio_low = t?.audio_low ? new URL(String(t.audio_low), base).toString() : null;

        registerTrack({
          uid,
          title: t?.title || '',
          audio,
          audio_low,
          size: (typeof t?.size === 'number') ? t.size : null,
          size_low: (typeof t?.size_low === 'number') ? t.size_low : null,
          lyrics: t?.lyrics ? new URL(String(t.lyrics), base).toString() : null,
          fulltext: t?.fulltext ? new URL(String(t.fulltext), base).toString() : null,
          sourceAlbum: String(a?.key || '').trim() || null
        });
      }
    } catch {
      failAlbums += 1;
    }
  }

  return {
    ok: okAlbums > 0,
    totalAlbums: albums.length,
    okAlbums,
    failAlbums,
    totalTracks,
    uids: Array.from(uids)
  };
}

function setAlert(flag, reason) {
  const next = !!flag;
  const payload = { on: next, ts: Date.now(), reason: String(reason || '') };
  writeJson(ALERT_KEY, payload);
  return payload;
}

function getAlert() {
  const a = readJson(ALERT_KEY, { on: false, ts: 0, reason: '' });
  return {
    on: !!a?.on,
    ts: Number(a?.ts || 0),
    reason: String(a?.reason || '')
  };
}

function fmtNet(st) {
  if (!st) return '‚Äî';
  const online = st.online ? 'online' : 'offline';
  const kind = st.kind || 'unknown';
  return `${online}, ${kind}`;
}

function ensureModal(html) {
  if (window.Utils && typeof window.Utils.createModal === 'function') {
    return window.Utils.createModal(html);
  }
  return null;
}

async function renderModal() {
  const om = window.OfflineUI?.offlineManager;
  if (!om) return null;

  const isOffline = om.isOfflineMode();
  const cq = await om.getCacheQuality();
  const st = getNetworkStatus();
  const policy = getNetPolicy();
  const alert = getAlert();

  const html = `
    <div class="modal-feedback" style="max-width: 520px;">
      <button class="bigclose" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48">
          <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
        </svg>
      </button>

      <div style="font-size: 1.1em; font-weight: 900; color: #eaf2ff; margin-bottom: 10px;">
        OFFLINE
      </div>

      <div style="color:#9db7dd; line-height:1.45; margin-bottom: 14px;">
        <div><strong>–°–µ—Ç—å:</strong> ${fmtNet(st)}</div>
        <div><strong>–†–µ–∂–∏–º:</strong> <span id="offline-modal-mode">${isOffline ? 'OFFLINE' : 'ONLINE'}</span></div>
        ${alert.on ? `<div style="margin-top:8px; color:#ff9800;"><strong>!</strong> ${alert.reason || '–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ'}</div>` : ''}
      </div>

      <div style="border-top:1px solid rgba(255,255,255,0.08); padding-top: 12px; margin-top: 8px;">
        <div style="font-weight: 900; color:#eaf2ff; margin-bottom: 8px;">A) Offline Mode</div>
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button class="offline-btn ${isOffline ? 'offline' : 'online'}" id="offline-modal-toggle" style="min-width: 220px;">
            ${isOffline ? '–í—ã–∫–ª—é—á–∏—Ç—å OFFLINE' : '–í–∫–ª—é—á–∏—Ç—å OFFLINE'}
          </button>
        </div>
      </div>

      <div style="border-top:1px solid rgba(255,255,255,0.08); padding-top: 12px; margin-top: 12px;">
        <div style="font-weight: 900; color:#eaf2ff; margin-bottom: 8px;">B) Cache Quality (CQ)</div>
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button class="offline-btn ${cq === 'hi' ? 'offline' : 'online'}" id="offline-modal-cq-hi" style="min-width: 160px;">CQ: Hi</button>
          <button class="offline-btn ${cq === 'lo' ? 'offline' : 'online'}" id="offline-modal-cq-lo" style="min-width: 160px;">CQ: Lo</button>
        </div>
      </div>

      <div style="border-top:1px solid rgba(255,255,255,0.08); padding-top: 12px; margin-top: 12px;">
        <div style="font-weight: 900; color:#eaf2ff; margin-bottom: 8px;">C) Cloud settings</div>
        <div style="display:grid; gap:10px; margin-bottom: 12px;">
          <label style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <span style="color:#cfe3ff;">N (–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π)</span>
            <input id="offline-cloud-n" type="number" min="1" max="50" style="width:110px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.2); color:#eaf2ff;">
          </label>
          <label style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <span style="color:#cfe3ff;">D (TTL –¥–Ω–µ–π)</span>
            <input id="offline-cloud-d" type="number" min="1" max="365" style="width:110px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.2); color:#eaf2ff;">
          </label>
          <div style="display:flex; gap:10px; justify-content:center;">
            <button class="offline-btn online" id="offline-cloud-save" style="min-width: 220px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å N/D</button>
          </div>
        </div>

        <div style="font-weight: 900; color:#eaf2ff; margin: 6px 0 8px;">Pinned / Cache</div>
        <div style="color:#9db7dd; line-height:1.45; margin-bottom: 10px;">
          <div><strong>–ö—ç—à:</strong> <span id="offline-cache-size">...</span></div>
          <div><strong>Pinned:</strong> <span id="offline-pinned-count">...</span></div>
        </div>

        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button class="offline-btn online" id="offline-modal-download-pinned" style="min-width: 220px;">–°–∫–∞—á–∞—Ç—å –≤—Å—ë pinned üîí</button>
          <button class="offline-btn online" id="offline-modal-offline-all" style="min-width: 220px;">100% OFFLINE (–≤—Å—ë)</button>
          <button class="offline-btn" id="offline-modal-clear-cache" style="min-width: 220px;">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
          <button class="offline-btn" id="offline-modal-clear-alert" style="min-width: 220px;">–°–±—Ä–æ—Å–∏—Ç—å "!"</button>
        </div>
        <div id="offline-mass-status" style="margin-top:10px; font-size:12px; color:#9db7dd;"></div>
      </div>

      <div style="border-top:1px solid rgba(255,255,255,0.08); padding-top: 12px; margin-top: 12px;">
        <div style="font-weight: 900; color:#eaf2ff; margin-bottom: 8px;">D) Network Policy</div>
        <div style="display:grid; gap:8px;">
          <label style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <span style="color:#cfe3ff;">–¢–æ–ª—å–∫–æ Wi‚ÄëFi</span>
            <input type="radio" name="offline-netpolicy" value="wifi" ${policy === 'wifi' ? 'checked' : ''}>
          </label>
          <label style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <span style="color:#cfe3ff;">–ú–æ–±–∏–ª—å–Ω–∞—è —Å–µ—Ç—å</span>
            <input type="radio" name="offline-netpolicy" value="cellular" ${policy === 'cellular' ? 'checked' : ''}>
          </label>
          <label style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <span style="color:#cfe3ff;">Unknown: —Ä–∞–∑—Ä–µ—à–∏—Ç—å</span>
            <input type="radio" name="offline-netpolicy" value="unknown" ${policy === 'unknown' ? 'checked' : ''}>
          </label>
          <label style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
            <span style="color:#cfe3ff;">–í—Å–µ–≥–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å</span>
            <input type="radio" name="offline-netpolicy" value="ask" ${policy === 'ask' ? 'checked' : ''}>
          </label>
        </div>
      </div>
    </div>
  `;

  return ensureModal(html);
}

function bindModalHandlers(modal) {
  const om = window.OfflineUI?.offlineManager;
  if (!modal || !om) return;

  const fmtBytes = (b) => {
    const n = Number(b || 0);
    if (!Number.isFinite(n) || n <= 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.min(sizes.length - 1, Math.floor(Math.log(n) / Math.log(k)));
    return `${(n / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`;
  };

  const fillStats = async () => {
    try {
      const bytes = await om.getCacheSizeBytes();
      const pinned = om.getPinnedUids();
      const sizeEl = modal.querySelector('#offline-cache-size');
      const pcEl = modal.querySelector('#offline-pinned-count');
      if (sizeEl) sizeEl.textContent = fmtBytes(bytes);
      if (pcEl) pcEl.textContent = String(pinned.length);

      const ms = om.getMassStatus?.() || null;
      const msEl = modal.querySelector('#offline-mass-status');
      if (msEl && ms && ms.total) {
        msEl.textContent = `100% OFFLINE: ${ms.done}/${ms.total} (–æ—à–∏–±–æ–∫: ${ms.error}) ${ms.active ? '...' : ''}`;
      }

      const { n, d } = om.getCloudSettings();
      const nInp = modal.querySelector('#offline-cloud-n');
      const dInp = modal.querySelector('#offline-cloud-d');
      if (nInp) nInp.value = String(n);
      if (dInp) dInp.value = String(d);
    } catch {}
  };

  const rerender = async () => {
    try { modal.remove(); } catch {}
    const next = await renderModal();
    bindModalHandlers(next);
  };

  fillStats();

  modal.querySelector('#offline-modal-toggle')?.addEventListener('click', async () => {
    const next = !om.isOfflineMode();
    om.setOfflineMode(next);
    if (next) {
      window.NotificationSystem?.offline('OFFLINE —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω');
      setAlert(true, 'OFFLINE –≤–∫–ª—é—á—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CQ.');
    } else {
      window.NotificationSystem?.success('OFFLINE —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω');
      setAlert(false, '');
    }
    try { window.dispatchEvent(new CustomEvent('offline:uiChanged')); } catch {}
    await rerender();
  });

  modal.querySelector('#offline-modal-cq-hi')?.addEventListener('click', async () => {
    await om.setCacheQuality('hi');
    window.NotificationSystem?.success('CQ: Hi');
    await rerender();
  });

  modal.querySelector('#offline-modal-cq-lo')?.addEventListener('click', async () => {
    await om.setCacheQuality('lo');
    window.NotificationSystem?.success('CQ: Lo');
    await rerender();
  });

  modal.querySelector('#offline-modal-download-pinned')?.addEventListener('click', async () => {
    try {
      if (shouldConfirmByPolicy(getNetPolicy(), getNetworkStatus(), { isMass: true })) {
        if (!window.confirm('–°–∫–∞—á–∞—Ç—å –≤—Å–µ pinned –ø–æ —Ç–µ–∫—É—â–µ–π —Å–µ—Ç–∏?')) return;
      }
      om.enqueuePinnedDownloadAll();
      window.NotificationSystem?.success('–û—á–µ—Ä–µ–¥—å pinned –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞');
    } catch {}
    await rerender();
  });

  // ‚úÖ 100% OFFLINE —Å –≤—ã–±–æ—Ä–æ–º
  modal.querySelector('#offline-modal-offline-all')?.addEventListener('click', async () => {
    try { modal.remove(); } catch {}
    
    const preload = await preloadAllAlbumsTrackIndex();
    if (!preload.ok) {
      window.NotificationSystem?.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± –∞–ª—å–±–æ–º–∞—Ö');
      return;
    }

    const albums = window.albumsIndex || [];
    
    const html = `
      <div class="modal-feedback" style="max-width: 400px;">
        <h3 style="color:#eaf2ff; margin-top:0;">100% OFFLINE</h3>
        <p style="color:#9db7dd; font-size:14px;">–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ —Å–∫–∞—á–∞—Ç—å:</p>
        
        <div style="max-height:40vh; overflow-y:auto; margin-bottom:15px; border:1px solid #333; padding:10px; border-radius:8px;">
          <label style="display:flex; gap:10px; padding:8px 0; border-bottom:1px solid #333;">
            <input type="checkbox" id="off-all-check" checked> 
            <strong style="color:#fff;">–í—Å–µ –∞–ª—å–±–æ–º—ã</strong>
          </label>
          ${albums.map(a => `
            <label style="display:flex; gap:10px; padding:8px 0; margin-left:20px;">
              <input type="checkbox" class="off-album-check" value="${a.key}" checked>
              <span style="color:#ccc;">${a.title}</span>
            </label>
          `).join('')}
          <label style="display:flex; gap:10px; padding:8px 0; border-top:1px solid #333; margin-top:5px;">
            <input type="checkbox" id="off-fav-check" checked>
            <span style="color:#ffd166;">–¢–æ–ª—å–∫–æ –ò–ó–ë–†–ê–ù–ù–û–ï</span>
          </label>
        </div>

        <div style="display:flex; gap:10px; justify-content:center;">
          <button class="offline-btn online" id="off-start-btn">–ù–∞—á–∞—Ç—å</button>
          <button class="offline-btn" onclick="this.closest('.modal-bg').remove()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    `;
    
    const selModal = window.Utils.createModal(html);
    const allCheck = selModal.querySelector('#off-all-check');
    const albumChecks = selModal.querySelectorAll('.off-album-check');
    
    allCheck.addEventListener('change', () => {
      albumChecks.forEach(c => c.checked = allCheck.checked);
    });

    selModal.querySelector('#off-start-btn').addEventListener('click', async () => {
      const selectedKeys = Array.from(albumChecks).filter(c => c.checked).map(c => c.value);
      const includeFav = selModal.querySelector('#off-fav-check').checked;
      
      const uidsToDownload = new Set();
      const tr = window.TrackRegistry;
      
      if (tr) {
        preload.uids.forEach(uid => {
          const meta = tr.getTrackByUid(uid);
          if (meta && selectedKeys.includes(meta.sourceAlbum)) {
            uidsToDownload.add(uid);
          }
        });
      }

      if (includeFav && window.FavoritesManager) {
        const favMap = window.FavoritesManager.getLikedUidMap();
        Object.values(favMap).flat().forEach(u => uidsToDownload.add(u));
      }

      const finalList = Array.from(uidsToDownload);
      selModal.remove();

      if (finalList.length === 0) {
        window.NotificationSystem?.warning('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ');
        return;
      }

      if (shouldConfirmByPolicy(getNetPolicy(), getNetworkStatus(), { isMass: true })) {
        if (!window.confirm(`–°–∫–∞—á–∞—Ç—å ${finalList.length} —Ç—Ä–µ–∫–æ–≤?`)) return;
      }

      om.startFullOffline(finalList);
      window.NotificationSystem?.success(`–ó–∞–ø—É—â–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞: ${finalList.length} —Ç—Ä–µ–∫–æ–≤`);
      await rerender();
    });
  });

  modal.querySelector('#offline-modal-clear-cache')?.addEventListener('click', async () => {
    if (!window.confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à?')) return;
    try {
      await om.clearAllCache();
      window.NotificationSystem?.success('–ö—ç—à –æ—á–∏—â–µ–Ω');
    } catch {}
    await rerender();
  });

  modal.querySelector('#offline-cloud-save')?.addEventListener('click', async () => {
    const n = Number(modal.querySelector('#offline-cloud-n')?.value);
    const d = Number(modal.querySelector('#offline-cloud-d')?.value);
    om.setCloudSettings({ n, d });
    window.NotificationSystem?.success('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    await rerender();
  });

  modal.querySelector('#offline-modal-clear-alert')?.addEventListener('click', async () => {
    setAlert(false, '');
    window.NotificationSystem?.success('–û–∫');
    try { window.dispatchEvent(new CustomEvent('offline:uiChanged')); } catch {}
    await rerender();
  });

  modal.querySelectorAll('input[name="offline-netpolicy"]').forEach((inp) => {
    inp.addEventListener('change', () => {
      setNetPolicy(inp.value);
      window.NotificationSystem?.info('–ü–æ–ª–∏—Ç–∏–∫–∞ —Å–µ—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
      try { window.dispatchEvent(new CustomEvent('offline:uiChanged')); } catch {}
    });
  });
}

export async function openOfflineModal() {
  const modal = await renderModal();
  if (modal) bindModalHandlers(modal);
}

export const OfflineModal = { open: openOfflineModal };

//=================================================
// FILE: /scripts/ui/sleep.js
// scripts/ui/sleep.js
// –¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º –æ–±—Ä–∞—Ç–Ω—ã–º –æ—Ç—Å—á—ë—Ç–æ–º

(function SleepTimerModule() {
  'use strict';

  const w = window;
  
  let sleepMenu = null;
  let updateInterval = null;

  const PRESETS = [
    { label: '5 –º–∏–Ω—É—Ç', minutes: 5 },
    { label: '10 –º–∏–Ω—É—Ç', minutes: 10 },
    { label: '15 –º–∏–Ω—É—Ç', minutes: 15 },
    { label: '30 –º–∏–Ω—É—Ç', minutes: 30 },
    { label: '1 —á–∞—Å', minutes: 60 },
    { label: '2 —á–∞—Å–∞', minutes: 120 }
  ];

  function initSleepTimer() {
    const btn = document.getElementById('sleep-timer-btn');
    if (!btn) {
      setTimeout(initSleepTimer, 100);
      return;
    }

    btn.addEventListener('click', toggleSleepMenu);

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ —Ç–∞–π–º–µ—Ä–∞ –æ—Ç PlayerCore
    if (w.playerCore) {
      w.playerCore.on({
        onSleepTriggered: () => {
          w.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª');
          clearSleepTimer();
        }
      });
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    restoreSleepTimer();

    console.log('‚úÖ Sleep timer initialized');
  }

  function toggleSleepMenu(e) {
    if (sleepMenu) {
      closeSleepMenu();
      return;
    }

    openSleepMenu(e.currentTarget);
  }

  function openSleepMenu(anchor) {
    sleepMenu = document.createElement('div');
    sleepMenu.className = 'sleep-menu';

    // ‚úÖ –ü–æ—Ä—Ç–∞–ª –≤ body, —á—Ç–æ–±—ã –º–µ–Ω—é –Ω–µ –æ–±—Ä–µ–∑–∞–ª–æ—Å—å overflow'–∞–º–∏ –ø–ª–µ–µ—Ä–∞
    // –∏ –≤—Å–µ–≥–¥–∞ –ø–æ–º–µ—â–∞–ª–æ—Å—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ.
    const rect = anchor.getBoundingClientRect();
    sleepMenu.style.position = 'fixed';
    sleepMenu.style.right = `${Math.max(8, window.innerWidth - rect.right)}px`;
    sleepMenu.style.bottom = `${Math.max(8, window.innerHeight - rect.top)}px`;

    const items = [];

    // –¢–µ–∫—É—â–∏–π —Ç–∞–π–º–µ—Ä
    const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;
    if (targetTs > 0) {
      items.push(`
        <div class="sleep-menu-item active" data-action="cancel">
          ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω: ${formatRemainingTime(targetTs)}
        </div>
        <div class="sleep-menu-item" data-action="clear">
          üö´ –í—ã–∫–ª—é—á–∏—Ç—å
        </div>
        <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 6px 0;"></div>
      `);
    }

    // –ü—Ä–µ—Å–µ—Ç—ã
    PRESETS.forEach(preset => {
      items.push(`
        <div class="sleep-menu-item" data-minutes="${preset.minutes}">
          ${preset.label}
        </div>
      `);
    });

    sleepMenu.innerHTML = items.join('');
    document.body.appendChild(sleepMenu);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    sleepMenu.querySelectorAll('.sleep-menu-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        handleSleepMenuClick(item);
      });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
    setTimeout(() => {
      document.addEventListener('click', closeSleepMenuOutside);
    }, 10);
  }

  function closeSleepMenu() {
    if (sleepMenu && sleepMenu.parentNode) {
      sleepMenu.parentNode.removeChild(sleepMenu);
    }
    sleepMenu = null;
    document.removeEventListener('click', closeSleepMenuOutside);
  }

  function closeSleepMenuOutside(e) {
    if (sleepMenu && !sleepMenu.contains(e.target)) {
      closeSleepMenu();
    }
  }

  function handleSleepMenuClick(item) {
    const action = item.dataset.action;
    const minutes = parseInt(item.dataset.minutes);

    if (action === 'clear') {
      clearSleepTimer();
      closeSleepMenu();
      w.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω');
      return;
    }

    if (Number.isFinite(minutes) && minutes > 0) {
      setSleepTimer(minutes);
      closeSleepMenu();
      w.NotificationSystem?.success(`‚è∞ –¢–∞–π–º–µ—Ä: ${minutes} –º–∏–Ω`);
    }
  }

  function setSleepTimer(minutes) {
    if (!w.playerCore) return;

    const ms = minutes * 60 * 1000;
    w.playerCore.setSleepTimer(ms);

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    try {
      localStorage.setItem('sleepTimerTarget', String(Date.now() + ms));
    } catch {}

    updateBadge();
    startUpdateInterval();
  }

  function clearSleepTimer() {
    if (w.playerCore) {
      w.playerCore.clearSleepTimer();
    }

    try {
      localStorage.removeItem('sleepTimerTarget');
    } catch {}

    stopUpdateInterval();
    updateBadge();
  }

  function restoreSleepTimer() {
    try {
      const saved = localStorage.getItem('sleepTimerTarget');
      if (!saved) return;

      const targetTs = parseInt(saved);
      const remaining = targetTs - Date.now();

      if (remaining > 0) {
        w.playerCore?.setSleepTimer(remaining);
        updateBadge();
        startUpdateInterval();
        console.log(`‚è∞ Sleep timer restored: ${Math.round(remaining / 60000)} min`);
      } else {
        localStorage.removeItem('sleepTimerTarget');
      }
    } catch {}
  }

  function updateBadge() {
    const badge = document.getElementById('sleep-timer-badge');
    if (!badge) return;

    const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;

    if (targetTs > 0) {
      const remaining = targetTs - Date.now();
      const minutes = Math.ceil(remaining / 60000);
      
      badge.textContent = minutes > 0 ? minutes : '';
      badge.style.display = minutes > 0 ? '' : 'none';
    } else {
      badge.style.display = 'none';
    }
  }

  function startUpdateInterval() {
    stopUpdateInterval();
    
    updateInterval = setInterval(() => {
      updateBadge();
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
      const targetTs = w.playerCore?.getSleepTimerTarget?.() || 0;
      if (targetTs > 0 && targetTs <= Date.now()) {
        clearSleepTimer();
      }
    }, 10000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  }

  function stopUpdateInterval() {
    if (updateInterval) {
      clearInterval(updateInterval);
      updateInterval = null;
    }
  }

  function formatRemainingTime(targetTs) {
    const remaining = targetTs - Date.now();
    const minutes = Math.ceil(remaining / 60000);
    
    if (minutes >= 60) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}—á ${mins}–º` : `${hours}—á`;
    }
    
    return `${minutes}–º`;
  }

  // –ü—É–±–ª–∏—á–Ω—ã–π API
  w.SleepTimer = {
    setSleepTimer,
    clearSleepTimer,
    updateBadge,
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ—Ä—è—á–µ–π –∫–ª–∞–≤–∏—à–µ–π T –∏ –∫–Ω–æ–ø–∫–æ–π –≤ PlayerUI)
    show() {
      const btn = document.getElementById('sleep-timer-btn');
      if (!btn) return;
      // –ï—Å–ª–∏ –º–µ–Ω—é —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ ‚Äì –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç—å/–æ—Ç–∫—Ä—ã—Ç—å –ø–æ toggleSleepMenu
      toggleSleepMenu({ currentTarget: btn });
    }
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSleepTimer);
  } else {
    initSleepTimer();
  }

  console.log('‚úÖ Sleep timer module loaded');
})();

//=================================================
// FILE: /scripts/ui/statistics-modal.js
// scripts/ui/statistics-modal.js
// –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è (–¢–ó 17)

(function() {
  'use strict';

  async function showStatisticsModal() {
    const om = window.OfflineUI?.offlineManager;
    if (!om) {
      window.NotificationSystem?.warning('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (OfflineManager –Ω–µ –≥–æ—Ç–æ–≤)');
      return;
    }

    const data = await om.getGlobalStatistics(); // { totalSeconds, tracks: [] }
    const tracks = data.tracks || [];
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –ø–æ–ª–Ω—ã–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è–º, –∑–∞—Ç–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    tracks.sort((a, b) => {
      if (b.fullListens !== a.fullListens) return b.fullListens - a.fullListens;
      return b.seconds - a.seconds;
    });

    // –§–∏–ª—å—Ç—Ä: >= 3 –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π (–ø–æ –¢–ó)
    const topTracks = tracks.filter(t => t.fullListens >= 3);

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    const totalHours = (data.totalSeconds / 3600).toFixed(1);
    const totalDays = (data.totalSeconds / 86400).toFixed(1);
    
    // –†–µ–Ω–¥–µ—Ä —Å—Ç—Ä–æ–∫
    const rowsHtml = topTracks.map((t, idx) => {
      // –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ —Ä–µ–µ—Å—Ç—Ä–µ
      const meta = window.TrackRegistry?.getTrackByUid(t.uid);
      const title = meta?.title || t.uid;
      const artist = '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞'; // —Ö–∞—Ä–¥–∫–æ–¥ –∏–ª–∏ –∏–∑ meta, –µ—Å–ª–∏ –µ—Å—Ç—å
      const timeStr = formatSeconds(t.seconds);
      
      return `
        <div style="display:flex; align-items:center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
          <div style="width: 24px; color:#8ab8fd; font-weight:bold;">${idx + 1}.</div>
          <div style="flex:1; overflow:hidden;">
            <div style="color:#eaf2ff; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${window.Utils.escapeHtml(title)}</div>
            <div style="font-size:12px; color:#9db7dd;">${timeStr} –≤—Å–µ–≥–æ</div>
          </div>
          <div style="text-align:right;">
            <div style="color:#ffd166; font-weight:bold;">${t.fullListens}</div>
            <div style="font-size:10px; color:#9db7dd;">—Ä–∞–∑</div>
          </div>
        </div>
      `;
    }).join('');

    const bodyHtml = `

        <div style="font-size: 1.2em; font-weight: 900; color: #eaf2ff; margin-bottom: 4px; display:flex; align-items:center; gap:8px;">
          <span>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
        </div>
        <div style="font-size:13px; color:#9db7dd; margin-bottom:20px;">–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è)</div>

        <div style="background: rgba(77,170,255,0.1); border: 1px solid rgba(77,170,255,0.2); border-radius:12px; padding:16px; text-align:center; margin-bottom:20px;">
          <div style="font-size:12px; color:#8ab8fd; text-transform:uppercase; letter-spacing:1px; margin-bottom:4px;">–í—Å–µ–≥–æ —Å–ª—É—à–∞–ª–∏</div>
          <div style="font-size:2em; font-weight:900; color:#fff;">
            ${totalHours} <span style="font-size:0.5em; font-weight:normal; opacity:0.7;">—á–∞—Å–æ–≤</span>
          </div>
          <div style="font-size:12px; color:#9db7dd; margin-top:2px;">(${totalDays} –¥–Ω–µ–π)</div>
        </div>

        <div style="font-weight:900; color:#eaf2ff; margin-bottom:10px; font-size:14px;">–¢–æ–ø —Ç—Ä–µ–∫–æ–≤ (3+ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è)</div>
        
        <div style="max-height: 40vh; overflow-y:auto; padding-right:4px;">
          ${rowsHtml || '<div style="padding:20px; text-align:center; color:#666;">–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>'}
        </div>
    `;

    if (window.Modals?.open) {
      window.Modals.open({
        title: 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
        maxWidth: 480,
        bodyHtml: `
          <div style="font-size:13px; color:#9db7dd; margin-bottom:20px;">–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è)</div>

          <div style="background: rgba(77,170,255,0.1); border: 1px solid rgba(77,170,255,0.2); border-radius:12px; padding:16px; text-align:center; margin-bottom:20px;">
            <div style="font-size:12px; color:#8ab8fd; text-transform:uppercase; letter-spacing:1px; margin-bottom:4px;">–í—Å–µ–≥–æ —Å–ª—É—à–∞–ª–∏</div>
            <div style="font-size:2em; font-weight:900; color:#fff;">
              ${totalHours} <span style="font-size:0.5em; font-weight:normal; opacity:0.7;">—á–∞—Å–æ–≤</span>
            </div>
            <div style="font-size:12px; color:#9db7dd; margin-top:2px;">(${totalDays} –¥–Ω–µ–π)</div>
          </div>

          <div style="font-weight:900; color:#eaf2ff; margin-bottom:10px; font-size:14px;">–¢–æ–ø —Ç—Ä–µ–∫–æ–≤ (3+ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è)</div>

          <div style="max-height: 40vh; overflow-y:auto; padding-right:4px;">
            ${rowsHtml || '<div style="padding:20px; text-align:center; color:#666;">–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>'}
          </div>
        `
      });
      return;
    }

    // fallback
    const html = `
      <div class="modal-feedback" style="max-width: 480px; max-height: 80vh;">
        <button class="bigclose" title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <svg viewBox="0 0 48 48">
            <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          </svg>
        </button>

        <div style="font-size: 1.2em; font-weight: 900; color: #eaf2ff; margin-bottom: 4px; display:flex; align-items:center; gap:8px;">
          <span>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
        </div>
        <div style="font-size:13px; color:#9db7dd; margin-bottom:20px;">–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è)</div>

        <div style="background: rgba(77,170,255,0.1); border: 1px solid rgba(77,170,255,0.2); border-radius:12px; padding:16px; text-align:center; margin-bottom:20px;">
          <div style="font-size:12px; color:#8ab8fd; text-transform:uppercase; letter-spacing:1px; margin-bottom:4px;">–í—Å–µ–≥–æ —Å–ª—É—à–∞–ª–∏</div>
          <div style="font-size:2em; font-weight:900; color:#fff;">
            ${totalHours} <span style="font-size:0.5em; font-weight:normal; opacity:0.7;">—á–∞—Å–æ–≤</span>
          </div>
          <div style="font-size:12px; color:#9db7dd; margin-top:2px;">(${totalDays} –¥–Ω–µ–π)</div>
        </div>

        <div style="font-weight:900; color:#eaf2ff; margin-bottom:10px; font-size:14px;">–¢–æ–ø —Ç—Ä–µ–∫–æ–≤ (3+ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è)</div>

        <div style="max-height: 40vh; overflow-y:auto; padding-right:4px;">
          ${rowsHtml || '<div style="padding:20px; text-align:center; color:#666;">–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</div>'}
        </div>
      </div>
    `;

    window.Utils?.createModal?.(html);
  }

  function formatSeconds(sec) {
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    if (m >= 60) {
      const h = Math.floor(m / 60);
      const remM = m % 60;
      return `${h}—á ${remM}–º`;
    }
    return `${m}–º ${s}—Å`;
  }

  window.StatisticsModal = { show: showStatisticsModal };
})();

//=================================================
// FILE: /scripts/ui/sysinfo.js
// scripts/ui/sysinfo.js
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–∏—Å—Ç–µ–º–µ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

(function() {
  'use strict';

  class SystemInfoManager {
    constructor() {
      this.modal = null;
      this.init();
    }

    init() {
      // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è
      const button = document.getElementById('sysinfo-btn');
      if (button) {
        button.style.display = '';
        button.addEventListener('click', () => this.show());
      }

      // –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ Ctrl+I
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
          e.preventDefault();
          this.show();
        }
      });
    }

    show() {
      if (this.modal) {
        this.modal.classList.add('active');
        return;
      }

      this.createModal();
    }

    createModal() {
      const modalBg = document.createElement('div');
      modalBg.className = 'modal-bg sysinfo-modal';
      
      const info = this.collectSystemInfo();

      modalBg.innerHTML = `
        <div class="modal-feedback" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
          <button class="bigclose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
            <svg width="31" height="31" viewBox="0 0 31 31">
              <line x1="8" y1="8" x2="23" y2="23" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              <line x1="23" y1="8" x2="8" y2="23" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
            </svg>
          </button>
          
          <h2 style="margin-top: 0; color: #4daaff;">–û —Å–∏—Å—Ç–µ–º–µ</h2>
          
          <div style="font-size: 14px; line-height: 1.6;">
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
            <div><strong>–í–µ—Ä—Å–∏—è:</strong> ${info.app.version}</div>
            <div><strong>–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏:</strong> ${info.app.buildDate}</div>
            <div><strong>PWA:</strong> ${info.app.isPWA ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</div>
            <div id="sw-version-placeholder"><strong>SW –≤–µ—Ä—Å–∏—è:</strong> ...</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ë—Ä–∞—É–∑–µ—Ä</h3>
            <div><strong>User Agent:</strong> ${info.browser.userAgent}</div>
            <div><strong>–Ø–∑—ã–∫:</strong> ${info.browser.language}</div>
            <div><strong>Online:</strong> ${info.browser.online ? '‚úÖ' : '‚ùå'}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</h3>
            <div><strong>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:</strong> ${info.device.resolution}</div>
            <div><strong>DPR:</strong> ${info.device.dpr}</div>
            <div><strong>Touch:</strong> ${info.device.touch ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Platform:</strong> ${info.device.platform}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü–ª–µ–µ—Ä</h3>
            <div><strong>–Ø–¥—Ä–æ:</strong> ${info.player.core}</div>
            <div><strong>–í–µ—Ä—Å–∏—è Howler:</strong> ${info.player.howlerVersion}</div>
            <div><strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Web Audio:</strong> ${info.player.webAudio ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTML5:</strong> ${info.player.html5 ? '‚úÖ' : '‚ùå'}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–•—Ä–∞–Ω–∏–ª–∏—â–µ</h3>
            <div><strong>LocalStorage:</strong> ${info.storage.localStorage ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>IndexedDB:</strong> ${info.storage.indexedDB ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Cache API:</strong> ${info.storage.cacheAPI ? '‚úÖ' : '‚ùå'}</div>
            <div><strong>Service Worker:</strong> ${info.storage.serviceWorker ? '‚úÖ' : '‚ùå'}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü–∞–º—è—Ç—å</h3>
            <div><strong>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:</strong> ${info.memory.used}</div>
            <div><strong>–õ–∏–º–∏—Ç:</strong> ${info.memory.limit}</div>
            
            <h3 style="color: #8ab8fd; margin-top: 20px;">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
            <div><strong>–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏:</strong> ${info.performance.loadTime}</div>
            <div><strong>DOM –∑–∞–≥—Ä—É–∂–µ–Ω:</strong> ${info.performance.domContentLoaded}</div>
          </div>
          
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #394866; text-align: center; font-size: 12px; color: #999;">
            –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ ¬© 2025
          </div>
        </div>
      `;

      // –ó–∞–∫—Ä—ã—Ç–∏–µ
      const closeBtn = modalBg.querySelector('.bigclose');
      closeBtn?.addEventListener('click', () => this.hide());

      modalBg.addEventListener('click', (e) => {
        if (e.target === modalBg) {
          this.hide();
        }
      });

      document.getElementById('modals-container')?.appendChild(modalBg);
      // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏ SW
      this.getSWVersion().then(ver => {
        const placeholder = modalBg.querySelector('#sw-version-placeholder');
        if (placeholder) {
          placeholder.innerHTML = `<strong>SW –≤–µ—Ä—Å–∏—è:</strong> ${ver}`;
        }
      });
      this.modal = modalBg;

      requestAnimationFrame(() => {
        modalBg.classList.add('active');
      });
    }

    collectSystemInfo() {
      const APP_CONFIG = window.APP_CONFIG || {};
      
      return {
        app: {
          version: APP_CONFIG.APP_VERSION || window.VERSION || 'unknown',
          buildDate: APP_CONFIG.BUILD_DATE || window.BUILD_DATE || 'unknown',
          isPWA: window.matchMedia('(display-mode: standalone)').matches
        },
        browser: {
          userAgent: navigator.userAgent,
          language: navigator.language,
          online: navigator.onLine
        },
        device: {
          resolution: `${window.screen.width}√ó${window.screen.height}`,
          dpr: window.devicePixelRatio || 1,
          touch: 'ontouchstart' in window,
          platform: navigator.platform
        },
        player: {
          core: window.playerCore ? 'PlayerCore (Howler.js)' : '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω',
          howlerVersion: window.Howler ? Howler.version : 'N/A',
          webAudio: window.Howler ? Howler.usingWebAudio : false,
          html5: window.Howler ? !Howler.usingWebAudio : false
        },
        storage: {
          localStorage: this.checkLocalStorage(),
          indexedDB: 'indexedDB' in window,
          cacheAPI: 'caches' in window,
          serviceWorker: 'serviceWorker' in navigator
        },
        memory: this.getMemoryInfo(),
        performance: this.getPerformanceInfo()
      };
    }

    checkLocalStorage() {
      try {
        localStorage.setItem('test', '1');
        localStorage.removeItem('test');
        return true;
      } catch (e) {
        return false;
      }
    }

    getMemoryInfo() {
      if (performance.memory) {
        return {
          used: this.formatBytes(performance.memory.usedJSHeapSize),
          limit: this.formatBytes(performance.memory.jsHeapSizeLimit)
        };
      }
      return {
        used: 'N/A',
        limit: 'N/A'
      };
    }

    getPerformanceInfo() {
      const perf = performance.timing;
      const loadTime = perf.loadEventEnd - perf.navigationStart;
      const domTime = perf.domContentLoadedEventEnd - perf.navigationStart;

      return {
        loadTime: loadTime > 0 ? `${loadTime}ms` : 'N/A',
        domContentLoaded: domTime > 0 ? `${domTime}ms` : 'N/A'
      };
    }
    async getSWVersion() {
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        if (!registration || !registration.active) return 'N/A';

        return new Promise((resolve) => {
          const messageChannel = new MessageChannel();
          
          messageChannel.port1.onmessage = (event) => {
            resolve(event.data.version || 'N/A');
          };

          registration.active.postMessage(
            { type: 'GET_SW_VERSION' },
            [messageChannel.port2]
          );

          setTimeout(() => resolve('N/A'), 1000);
        });
      } catch {
        return 'N/A';
      }
    }
    formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    hide() {
      if (this.modal) {
        this.modal.classList.remove('active');
        setTimeout(() => {
          if (this.modal && this.modal.parentNode) {
            this.modal.parentNode.removeChild(this.modal);
          }
          this.modal = null;
        }, 300);
      }
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.SystemInfoManager = new SystemInfoManager();
    });
  } else {
    window.SystemInfoManager = new SystemInfoManager();
  }

  console.log('‚úÖ System info manager initialized');
})();

//=================================================
// FILE: /scripts/utils/sw-manager.js
// scripts/utils/sw-manager.js
// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Service Worker –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

class ServiceWorkerManager {
  constructor() {
    this.registration = null;
    this.isSupported = 'serviceWorker' in navigator;
  }

  async init() {
    if (!this.isSupported) {
      console.warn('Service Worker not supported');
      return false;
    }

    try {
      this.registration = await navigator.serviceWorker.register('./service-worker.js', {
        scope: './'
      });

      console.log('‚úÖ Service Worker registered:', this.registration.scope);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      this.checkForUpdates();

      // –°–ª—É—à–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      this.registration.addEventListener('updatefound', () => {
        this.handleUpdateFound();
      });

      // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–∫–∞–∂–¥—ã–π —á–∞—Å)
      setInterval(() => {
        this.checkForUpdates();
      }, 60 * 60 * 1000);

      return true;
    } catch (error) {
      console.error('Service Worker registration failed:', error);
      return false;
    }
  }

  checkForUpdates() {
    if (this.registration) {
      this.registration.update();
    }
  }

  handleUpdateFound() {
    const newWorker = this.registration.installing;
    
    newWorker.addEventListener('statechange', () => {
      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
        // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
        this.showUpdateNotification();
      }
    });
  }

  handleVersionMessage({ swVer, appVer } = {}) {
    // ‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è update UI –∏–∑ AppModule (–∏ e2e).
    // –ù–∏–∫–∞–∫–∏—Ö confirm() ‚Äî —Ç–æ–ª—å–∫–æ –µ–¥–∏–Ω—ã–π UI (toast + –∫–Ω–æ–ø–∫–∞).
    const s = String(swVer || '').trim();
    const a = String(appVer || '').trim();
    if (!s) return;
    if (a && s === a) return;

    this.availableVersion = s;
    this.showUpdateNotification();
  }

  showUpdateNotification() {
    const ver = String(this.availableVersion || '').trim();
    const msg = ver
      ? `–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (${ver}).`
      : '–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.';

    window.NotificationSystem?.info(msg, 10000);

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    this.showUpdateButton();
  }

  showUpdateButton() {
    let updateBtn = document.getElementById('update-app-btn');
    
    if (!updateBtn) {
      updateBtn = document.createElement('button');
      updateBtn.id = 'update-app-btn';
      updateBtn.textContent = '–û–ë–ù–û–í–ò–¢–¨ –ü–†–ò–õ–û–ñ–ï–ù–ò–ï';
      updateBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: #4daaff;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      
      updateBtn.addEventListener('click', () => {
        this.applyUpdate();
      });
      
      document.body.appendChild(updateBtn);
    }
    
    updateBtn.style.display = 'block';
  }

  async applyUpdate() {
    if (!this.registration || !this.registration.waiting) {
      return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–µ–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ reload –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
    try {
      if (window.PlayerState && typeof window.PlayerState.save === 'function') {
        window.PlayerState.save({ forReload: true });
      }
    } catch (e) {
      console.warn('PlayerState.save before SW update failed:', e);
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ SW –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è
    this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ SW
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    }, { once: true });
  }

  async clearCache(cacheType) {
    if (!this.registration || !this.registration.active) {
      return;
    }

    this.registration.active.postMessage({
      type: 'CLEAR_CACHE',
      payload: { cacheType }
    });

    window.NotificationSystem?.success('–ö—ç—à –æ—á–∏—â–µ–Ω');
  }

  async cacheAudioFiles(urls) {
    if (!this.registration || !this.registration.active) {
      return;
    }

    this.registration.active.postMessage({
      type: 'CACHE_AUDIO',
      payload: { urls }
    });
  }

  async getCacheSize() {
    if (!this.registration || !this.registration.active) {
      return 0;
    }

    return new Promise((resolve) => {
      const messageChannel = new MessageChannel();
      
      messageChannel.port1.onmessage = (event) => {
        resolve(event.data.size || 0);
      };

      this.registration.active.postMessage(
        { type: 'GET_CACHE_SIZE' },
        [messageChannel.port2]
      );
    });
  }

  formatCacheSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
  }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.ServiceWorkerManager = new ServiceWorkerManager();

// –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.ServiceWorkerManager.init();
  });
} else {
  window.ServiceWorkerManager.init();
}

// export default —É–¥–∞–ª—ë–Ω: —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ browser script —á–µ—Ä–µ–∑ window.ServiceWorkerManager


//=================================================
// FILE: /albums/gallery/news/news-01-baner.html
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ</title>
  <style>
    :root{
      --bg-0: #0b0e15;     /* –±–∞–∑–æ–≤—ã–π —Ñ–æ–Ω */
      --bg-1: #0f1422;     /* –ø–∞–Ω–µ–ª—å/–∫–∞—Ä—Ç–∞ */
      --bg-2: #0a0d17;     /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ–Ω */
      --text: #e8ecf6;     /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --muted: #a9b3c7;    /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π */
      --accent-1: #4aa3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã */
      --accent-2: #7be3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã 2 */
      --shadow: 0 12px 28px rgba(0,0,0,0.45), 0 3px 10px rgba(0,0,0,0.35);
      --radius: 16px;
      --radius-inner: 12px;
    }
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(120% 120% at 10% 10%, #111827 0%, #0b0e15 45%, #070a12 100%);
      color: var(--text);
      font: 500 16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    .wrap{
      position:relative;
      height:100%;
      width:100%;
      display:grid;
      place-items:center;
      padding:10px;
      box-sizing:border-box;
    }
    /* –í–Ω–µ—à–Ω—è—è ¬´–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è —Ä–∞–º–∫–∞¬ª */
    .frame{
      position:relative;
      width:100%;
      height:100%;
      max-width:900px;
      max-height:900px;
      border-radius: var(--radius);
      padding:1px; /* —Ç–æ–ª—â–∏–Ω–∞ —Ä–∞–º–∫–∏ */
      background: linear-gradient(135deg, rgba(74,163,255,0.85), rgba(123,227,255,0.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card{
      position:relative;
      width:100%;
      height:100%;
      border-radius: calc(var(--radius) - 1px);
      background:
        radial-gradient(140% 120% at 80% 0%, rgba(27,41,72,0.55), transparent 60%),
        radial-gradient(120% 140% at 0% 100%, rgba(18,30,58,0.6), transparent 55%),
        var(--bg-1);
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:16px;
      box-sizing:border-box;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .badge{
      align-self:flex-start;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(2px);
    }
    .title{
      font-weight:700;
      font-size: clamp(18px, 3vw, 24px);
      line-height:1.25;
      margin:0 4px;
      color: var(--text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.25);
    }
    .subtitle{
      margin: -6px 4px 2px;
      color: var(--muted);
      font-size: 14px;
    }

    /* –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø–ª–µ–µ—Ä–∞ */
    .embed{
      position:relative;
      margin-top: 4px;
      width:100%;
      flex: 1 1 auto;
      aspect-ratio: 1 / 1; /* —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç */
      border-radius: var(--radius-inner);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.8), rgba(6,8,15,0.92)),
        var(--bg-2);
      border:1px solid rgba(255,255,255,0.07);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 24px rgba(0,0,0,0.45);
    }
    /* ‚úÖ –í–º–µ—Å—Ç–æ iframe: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –≤—Å—é –æ–±–ª–∞—Å—Ç—å (–±–µ–∑ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—à–∏–±–æ–∫) */
    .embed-link{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: var(--text);
      text-decoration:none;
      font-weight:800;
      font-size: clamp(16px, 3vw, 22px);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.65), rgba(6,8,15,0.9)),
        var(--bg-2);
    }
    .embed-link:hover{
      filter: brightness(1.05);
    }
    .embed-link:active{
      filter: brightness(0.95);
    }

    /* –ù–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top: 4px;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      opacity: .9;
    }
    .cta{
      padding:8px 12px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      text-decoration:none;
      font-weight:600;
      transition: transform .12s ease, background .2s ease;
    }
    .cta:hover{ transform: translateY(-1px); }
    .cta:active{ transform: translateY(0); }

    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö –≤—ã—Å–æ—Ç–∞—Ö —Å–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
    @media (max-height: 420px){
      .card{ padding:12px; gap:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <section class="card" role="region" aria-label="–ù–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–Ω–Ω–µ—Ä ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏">
        <div class="badge">–ù–æ–≤–æ—Å—Ç–∏</div>
        <h1 class="title">¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª ‚Äî —É–∂–µ –Ω–∞ –Ø–Ω–¥–µ–∫—Å&nbsp;–ú—É–∑—ã–∫–µ</h1>
        <p class="subtitle">–°–ª—É—à–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º –≥—Ä—É–ø–ø—ã ¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª</p>

        <div class="embed" role="group" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ">
          <a class="embed-link"
             href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link"
             target="_blank"
             rel="noopener">
            –û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ
          </a>
        </div>

        <div class="footer">
          <div class="hint">–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏—Ç–µ ¬´–ø–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤ –ø–ª–µ–µ—Ä–µ, —á—Ç–æ–±—ã —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –¥—Ä—É–∑—å—è–º</div>
          <a class="cta" href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º</a>
        </div>
      </section>
    </div>
  </div>
</body>
</html>

//=================================================
// FILE: /generate-context.js
/* eslint-disable no-console */
"use strict";

/**
 * generate-context.js
 *
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä .meta/project-full.txt –∏ .meta/project-adaptive.txt
 * –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã):
 * 1) –í –Ω–∞—á–∞–ª–µ ‚Äî –±–ª–æ–∫ ¬´–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô¬ª, –∑–∞—Ç–µ–º –º–µ—Ç–∞‚Äë–±–ª–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º/URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–æ–º–µ—Ç–∫–æ–π –ø—Ä–æ GitHub.
 * 2) –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ‚Äî –ü–û–õ–ù–û–ï –¥–µ—Ä–µ–≤–æ –í–°–ï–• —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è assets/), –Ω–æ –±–µ–∑ .git/** –∏ .meta/**.
 *    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤.
 * 3) –ü–æ—Å–ª–µ –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º (critical ‚Üí high ‚Üí medium ‚Üí low),
 *    –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤—ã–≤–æ–¥–∏—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º. –ó–¥–µ—Å—å assets/** –∏—Å–∫–ª—é—á–∞–µ–º (–ø–æ –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é), .meta/** —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º.
 * 4) –ù–ï–¢ –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª.
 * 5) Adaptive-—Ä–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—â–∏–π –æ–±—ä—ë–º —Å—Ç—Ä–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º --max-lines (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20000).
 *
 * –ó–∞–ø—É—Å–∫:
 *   node generate-context.js --mode=both --max-lines=20000
 *   node generate-context.js --mode=full
 *   node generate-context.js --mode=adaptive --out-dir=.meta
 *
 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
 *   --mode=both|full|adaptive
 *   --max-lines=–ß–ò–°–õ–û           // —Ç–æ–ª—å–∫–æ –¥–ª—è adaptive
 *   --out-dir=–ü–£–¢–¨              // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é .meta
 *   --root=–ü–£–¢–¨                 // –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞)
 */

const fs = require("fs");
const path = require("path");

// -------------------- CLI --------------------
const argv = Object.fromEntries(
  process.argv.slice(2).map(a => {
    const [k, ...r] = a.replace(/^--/, "").split("=");
    return [k, r.join("=") === "" ? true : r.join("=")];
  })
);

const ROOT     = path.resolve(argv.root || __dirname);
const META_DIR = path.resolve(argv["out-dir"] || path.join(ROOT, ".meta"));
const MODE     = (argv.mode || "both").toLowerCase(); // full | adaptive | both
const MAX_LINES = Number(argv["max-lines"] || 20000);

// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ .meta
if (!fs.existsSync(META_DIR)) fs.mkdirSync(META_DIR, { recursive: true });

const FULL_FILE    = path.join(META_DIR, "project-full.txt");
const ADAPTIVE_FILE= path.join(META_DIR, "project-adaptive.txt");

// –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ self-—Ñ–∞–π–ª–∞–º (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è)
const SELF_FULL_REL  = toUnix(path.relative(ROOT, FULL_FILE));
const SELF_ADAPT_REL = toUnix(path.relative(ROOT, ADAPTIVE_FILE));

// -------------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ --------------------

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ç–æ—Ä—ã—Ö –≤–∫–ª—é—á–∞–µ–º –≤ —Å–µ–∫—Ü–∏—é ¬´–§–ê–ô–õ–´¬ª
const TEXT_EXTS = new Set([
  ".html",".htm",".css",".js",".mjs",".cjs",".ts",".tsx",
  ".json",".webmanifest",".md",".txt",".yml",".yaml"
]);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –°–ï–ö–¶–ò–ò ¬´–§–ê–ô–õ–´¬ª (—Ç–æ–ª—å–∫–æ –∫ –ª–∏—Å—Ç–∏–Ω–≥—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ù–ï –∫ –¥–µ—Ä–µ–≤—É):
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –∏—Å–∫–ª—é—á–∞–µ–º .meta/** –∏ assets/** (–Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ –∫–æ–Ω—Ç–µ–Ω—Ç),
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏.
 */
const EXCLUDE_FILES_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  "assets/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û –¥–ª—è –°–¢–†–£–ö–¢–£–†–´ –î–ï–†–ï–í–ê:
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã, –≤–∫–ª—é—á–∞—è assets/**.
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ .git/**, .meta/** –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ (node_modules –∏ —Ç.–ø.),
 *   –ø–ª—é—Å –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤.
 */
const EXCLUDE_TREE_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
const PRIORITY = {
  critical: [
    /^index\.html?$/i,
    /^service-worker\.js$/i,
    /^manifest\.json$/i,
    /^albums\.json$/i,
    /^custom\.json$/i,
    /^news\.html?$/i,
    /^generate-index\.(js|mjs|cjs)$/i,
    /^albums\/gallery\/[^/]+\/index\.json$/i,
    /^\.github\/workflows\/.*\.ya?ml$/i
  ],
  high: [
    /^AudioController\.(js|mjs|cjs|ts)$/i,
    /^GlobalState\.(js|mjs|cjs|ts)$/i,
    /^scripts\/.*\.(mjs|js|ts)$/i,
    /^performance\/.*\.(js|ts)$/i,
    /^.*\.(ya?ml)$/i
  ],
  medium: [
    /^.*\.(js|mjs|cjs|ts|tsx|json|html?|css)$/i
  ],
};

// -------------------- –£—Ç–∏–ª–∏—Ç—ã --------------------
function toUnix(p) {
  return String(p).replace(/\\/g, "/");
}
function globToRegExp(pat) {
  const esc = pat
    .replace(/[.+^${}()|[\]\\]/g, "\\$")
    .replace(/\*\*/g, "___GLOBSTAR___")
    .replace(/\*/g, "[^/]*")
    .replace(/___GLOBSTAR___/g, ".*");
  return new RegExp("^" + esc + "$");
}
function isTextFile(rel) {
  return TEXT_EXTS.has(path.extname(rel).toLowerCase());
}
function readText(rel) {
  try { return fs.readFileSync(path.join(ROOT, rel), "utf8"); }
  catch (e) { return `// read error: ${e.message}`; }
}
function countLines(s) {
  return (s.match(/\n/g) || []).length + (s.length ? 1 : 0);
}

// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
function isExcludedForFiles(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_FILES_PATTERNS.some(re => re.test(u));
}
// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –¥–µ—Ä–µ–≤–∞
function isExcludedForTree(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_TREE_PATTERNS.some(re => re.test(u));
}

// -------------------- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ --------------------
function listAllEntries(includeFiles = true, forTree = false) {
  const res = [];
  const stack = [ROOT];

  while (stack.length) {
    const dir = stack.pop();
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { continue; }

    for (const e of entries) {
      const full = path.join(dir, e.name);
      const rel = toUnix(path.relative(ROOT, full)) || ".";

      // –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –¥–ª—è –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–≤–æ–∏, –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî —Å–≤–æ–∏
      const excluded = forTree ? isExcludedForTree(rel) : isExcludedForFiles(rel);
      if (excluded) continue;

      if (e.isDirectory()) {
        res.push({ rel, full, dir: true });
        stack.push(full);
      } else if (e.isFile() && includeFiles) {
        res.push({ rel, full, dir: false });
      }
    }
  }

  // –ü–∞–ø–∫–∏ —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º —Ñ–∞–π–ª—ã; –≤–Ω—É—Ç—Ä–∏ ‚Äî –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  res.sort((a, b) => (a.dir !== b.dir ? (a.dir ? -1 : 1) : a.rel.localeCompare(b.rel)));
  return res;
}

function listTextFilesForContent() {
  return listAllEntries(true, /*forTree*/ false)
    .filter(e => !e.dir && isTextFile(e.rel))
    .map(e => e.rel);
}

// -------------------- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π --------------------
function readRepoMeta() {
  let url = "";
  try {
    const cfg = path.join(ROOT, ".git", "config");
    if (fs.existsSync(cfg)) {
      const raw = fs.readFileSync(cfg, "utf8");
      const m = raw.match(/url\s*=\s*(.+)\n/);
      if (m) url = m[1].trim();
    }
  } catch {}
  return {
    name: path.basename(ROOT),
    url: url || "(URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω; —É–∫–∞–∂–∏—Ç–µ –≤ .git/config)",
    madeWith: "–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).",
  };
}

// -------------------- –ë–ª–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ --------------------
function rulesBlock() {
  return [
    "–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):",
    "- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.",
    "- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.",
    "- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).",
    "- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:",
    "  ```ts",
    "  export function x() {}",
    "  ```",
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).",
    "- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.",
    "- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.",
    "- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.",
    "- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.",
    "- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].",
    "- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. ",
    "- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.",
    "- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).",
    "- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.",
    "- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤—ã–∑–≤–∞—Ç—å STOP —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–Ω—è—Ç –≤ favorites view, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞ –∏ –Ω–µ –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ä–æ–≥–æ —Å–ª–µ–¥–∞, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–µ–º —á—Ç–æ-—Ç–æ –≤ –∫–æ–¥–µ",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏–ª–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ –∫–æ–¥–µ, –Ω–æ –ø—Ä–∏—ç—Ç–æ–º –ø–æ–ª–Ω–æ—Å—Ç—å–± –±—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ –ª–æ–≥–∏–∫—É, –ª–æ–≥–∏—Å—Ç–∏–∫—É –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–µ–º–∏—Ç—å—Å—è –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —É–ø—Ä–æ—â–µ–Ω–∏—é –∫–æ–¥–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    ""
  ].join("\n");
}

function metaBlock() {
  const m = readRepoMeta();

  const favoritesPrinciplesBlock = [
    "## –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞",
    "–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ –≤ –ò–ó–ë–†–ê–ù–ù–û–ï:",
    "–õ–∞–π–∫/–∞–Ω–ª–∞–π–∫ (‚≠ê) = –∏–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ ‚≠ê —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö (—Ä–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º, ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª, –¥—Ä—É–≥–∏–µ —Å–ø–∏—Å–∫–∏).",
    "",
    "–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –∏–∑ –æ–∫–Ω–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª",
    "–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äì —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –¥–≤—É—Ö—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.",
    "",
    "–ü–æ–¥—Ä–æ–±–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã",
    "‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã):",
    "- –ü–æ—Å—Ç–∞–≤–∏–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π.",
    "- –°–Ω—è–ª–∏ ‚≠ê ‚Äî —Ç—Ä–µ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª (–¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º, ¬´–±–µ–∑ —Å–ª–µ–¥–∞¬ª).",
    "",
    "‚≠ê –≤ –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:",
    "- –°–Ω—è–ª–∏ ‚≠ê —Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–µ—Ä–æ–π (inactive), ‚≠ê —Å–Ω–∏–º–∞–µ—Ç—Å—è –∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª, –∏ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.",
    "- –°–Ω—è—Ç–∏–µ ‚≠ê –ù–ï —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ, –∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –µ—ë –≤ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (‚Äú–±—É—Ñ–µ—Ä‚Äù).",
    "",
    "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π (—Å–µ—Ä–æ–π) —Å—Ç—Ä–æ–∫–∏ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª:",
    "- –ö–ª–∏–∫ –ø–æ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–µ –ø–æ –∑–≤–µ–∑–¥–µ) ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏:",
    "  - –í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π, ‚≠ê —Å—Ä–∞–∑—É –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤–µ–∑–¥–µ.",
    "  - –£–¥–∞–ª–∏—Ç—å ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ. –í —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚≠ê –ø—Ä–∏ —ç—Ç–æ–º —Å–Ω—è—Ç–∞.",
    "- –ö–ª–∏–∫ –ø–æ ‚≠ê –Ω–∞ —Å–µ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –±—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –º–æ–¥–∞–ª–∫–∏, —Å—Ç—Ä–æ–∫–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å ‚≠ê.",
    "- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É (–∏–ª–∏ ‚Äú–±–µ–∑ —Å–ª–µ–¥–∞‚Äù —á–µ—Ä–µ–∑ –∞–Ω–ª–∞–π–∫ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ).",
    "",
    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:",
    "- –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚≠ê –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ –≤—Å–µ—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è—Ö –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫.",
    "- –í –æ–∫–Ω–µ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª: —Å–Ω—è—Ç–∏–µ ‚≠ê –Ω–∞ –ª—é–±–æ–π —Å—Ç—Ä–æ–∫–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.",
    "- –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É.",
    "",
    "–ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª:",
    "- –õ—é–±—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç—Ä–µ–∫–∞ –≤ inactive, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Å–æ—Å—Ç–∞–≤–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞.",
    "- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–µ—Å–Ω–∏ –ù–ï –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç ‚Äú–≤ —Ñ–æ–Ω–µ‚Äù.",
    "",
    "–û—Å–æ–±–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞:",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è inactive –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫.",
    "- –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî –ø–ª–µ–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º —Å—Ç–æ–ø, –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.",
    "",
    "–†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º –≤—Å–µ–≥–¥–∞ —Ä–µ—à–∞–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ:",
    "- –ï—Å–ª–∏ —Å–Ω—è—Ç—å ‚≠ê —Å —Ç—Ä–µ–∫–∞ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ ‚Äî –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–ª—Å—è —Ç–∞–º –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è (—Å–µ—Ä–∞—è) —Å—Ç—Ä–æ–∫–∞.",
    "",
    "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ:",
    "- –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ ‚≠ê –Ω–∞ —Ç—Ä–µ–∫–µ –≤ —Ä–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ, –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π.",
    "",
    "–ò—Ç–æ–≥–∏",
    "- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è ‚Äî —à–∞–≥ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–æ–π.",
    "- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚≠ê –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö.",
    "- –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π: –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–¥–Ω–æ–º—É –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.",
    "- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.",
    "- –†–æ–¥–Ω–æ–π –∞–ª—å–±–æ–º —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∞—Ä–±–∏—Ç—Ä–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª.",
    " =========================================================================== ",
    "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F (–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)",
    "–ö–Ω–æ–ø–∫–∞ F –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º Favorites Only –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞).",
    "–û–Ω–∞ –Ω–µ —Å—Ç–∞–≤–∏—Ç/–Ω–µ —Å–Ω–∏–º–∞–µ—Ç ‚≠ê —É —Ç—Ä–µ–∫–æ–≤, –∞ —Ç–æ–ª—å–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç, –ø–æ –∫–∞–∫–∏–º —Ç—Ä–µ–∫–∞–º –º–æ–∂–Ω–æ —Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Next / Prev / –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏ –∫–∞–∫–∏–µ —Ç—Ä–µ–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ Shuffle.",
    "–ï–¥–∏–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø (–ø–æ–ª–Ω—ã–π –ø–ª–µ–µ—Ä –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä)",
    "–ü–æ–ª–Ω—ã–π –∏ –º–∏–Ω–∏-–ø–ª–µ–µ—Ä —É–ø—Ä–∞–≤–ª—è—é—Ç –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ playing-–ø–ª–µ–π–ª–∏—Å—Ç–æ–º.",
    "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ F –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö: –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ playing, –∞ –Ω–µ –∫ –æ—Ç–∫—Ä—ã—Ç–æ–º—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å–ø–∏—Å–∫—É.",
    "–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–¥–æ—Å—Ç—É–ø–Ω—ã–º —Ç—Ä–µ–∫–æ–º‚Äù",
    "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ ‚Äî —ç—Ç–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤:",
    "Next / Prev",
    "–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é —Ç—Ä–µ–∫–∞",
    "Shuffle-–ø–æ—Ä—è–¥–∫–µ (–µ—Å–ª–∏ shuffle –≤–∫–ª—é—á—ë–Ω)",
    "–ü—Ä–∞–≤–∏–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:",
    "F = OFF: –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±—ã—á–Ω—ã–π –Ω–∞–±–æ—Ä playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞, –Ω–æ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å–º. ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –Ω–∏–∂–µ).",
    "F = ON: –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (‚≠ê) —Ç—Ä–µ–∫–∏ playing-–ø–ª–µ–π–ª–∏—Å—Ç–∞.",
    "–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –æ–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º",
    "–ò–∑–±—Ä–∞–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ ‚≠ê –≤ —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ (–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ª–∞–π–∫–æ–≤).",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –≤ –∞–ª—å–±–æ–º–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ ‚≠ê —Ç—Ä–µ–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.",
    "–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä —Å—É–∂–∞–µ—Ç—Å—è –¥–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è OFF, –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ç—Ä–µ–∫–∏ –∞–ª—å–±–æ–º–∞, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ ‚≠ê –Ω–µ—Ç: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ ‚≠ê –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = ‚≠ê, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ ‚≠ê, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ —ç—Ç–æ–º—É shuffle-–ø–æ—Ä—è–¥–∫—É.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = –≤—Å–µ —Ç—Ä–µ–∫–∏, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–∞–±–æ—Ä—É, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "–ö–æ–Ω—Ç–µ–∫—Å—Ç: playing = –ò–ó–ë–†–ê–ù–ù–û–ï (–ø–ª–µ–π–ª–∏—Å—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ)",
    "–í ‚Äú–ò–ó–ë–†–ê–ù–ù–û–ï‚Äù –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã active –∏ inactive:",
    "active: —Ç—Ä–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º (‚≠ê –µ—Å—Ç—å) ‚Äî —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏",
    "inactive: ‚≠ê —Å–Ω—è—Ç–∞, —Å—Ç—Ä–æ–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏",
    "–ë–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–≤–∞–∂–Ω–æ): inactive –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –≤ Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–µ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∏ shuffle-–ø–æ—Ä—è–¥–æ–∫ ‚Äî –ø—Ä–∏ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ F.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle OFF ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –Ω–µ—Ç active (–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –Ω–µ—á–µ–≥–æ –∏–≥—Ä–∞—Ç—å): –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä = active (–ø–æ —Ñ–∞–∫—Ç—É –æ–Ω –∏ —Ç–∞–∫ —Ç–∞–∫–æ–π), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ active.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è = active (inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ active.",
    "–°–æ—Å—Ç–æ—è–Ω–∏–µ: Shuffle ON ‚Üí –ù–∞–∂–∞—Ç–∏–µ F",
    "OFF ‚Üí ON",
    "–ï—Å–ª–∏ –Ω–µ—Ç active: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è OFF.",
    "–ï—Å–ª–∏ active –µ—Å—Ç—å: –∫–Ω–æ–ø–∫–∞ ON, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active, Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "ON ‚Üí OFF",
    "–ö–Ω–æ–ø–∫–∞ OFF, shuffle-–ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ active (–ø–æ—Ç–æ–º—É —á—Ç–æ inactive –≤—Å—ë —Ä–∞–≤–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω—ã), Next/Prev/–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏–¥—É—Ç –ø–æ –Ω–µ–º—É.",
    "–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)",
    "–ù–∞–∂–∞—Ç–∏–µ F –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–∞–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (‚≠ê –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è –∏ –Ω–µ —Å–Ω–∏–º–∞–µ—Ç—Å—è).",
    "–ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ (–Ω–µ—Ç ‚≠ê –≤ –∞–ª—å–±–æ–º–µ / –Ω–µ—Ç active –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –ø–ª–µ–π–ª–∏—Å—Ç–µ): –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ¬´–æ—Ç–º–µ—Ç—å—Ç–µ ‚≠ê –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫¬ª, –∏ F –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è (–æ—Å—Ç–∞—ë—Ç—Å—è OFF).",
    "inactive –≤ –ò–ó–ë–†–ê–ù–ù–û–ú ‚Äî —ç—Ç–æ UI-—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞/—É–¥–∞–ª–µ–Ω–∏—è, –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∏ –≤ –∫–∞–∫–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –Ω–∏ –≤ Next/Prev, –Ω–∏ –≤ Shuffle.",
    ""
  ].join("\n");

  return [
    `–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.name}`,
    `–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.url}`,
    "# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.",
    favoritesPrinciplesBlock,
    m.madeWith,
    ""
  ].join("\n");
}

// -------------------- –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê (–¥–µ—Ä–µ–≤–æ) --------------------
function buildFullTree() {
  const lines = [];
  lines.push(path.basename(ROOT) + "/");

  function walk(dir, prefix = "") {
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { return; }

    const visible = entries
      .filter(e => !isExcludedForTree(toUnix(path.relative(ROOT, path.join(dir, e.name)))))
      .sort((a, b) => (a.isDirectory() !== b.isDirectory() ? (a.isDirectory() ? -1 : 1) : a.name.localeCompare(b.name)));

    visible.forEach((e, i) => {
      const isLast = i === visible.length - 1;
      const branch = isLast ? "‚îî‚îÄ‚îÄ " : "‚îú‚îÄ‚îÄ ";
      lines.push(prefix + branch + e.name + (e.isDirectory() ? "/" : ""));
      if (e.isDirectory()) {
        walk(path.join(dir, e.name), prefix + (isLast ? "    " : "‚îÇ   "));
      }
    });
  }

  walk(ROOT);
  return lines.join("\n") + "\n\n";
}

// -------------------- –°–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª --------------------
function getPriority(rel) {
  const u = toUnix(rel);
  for (const [lvl, rules] of Object.entries(PRIORITY)) {
    if (rules.some(re => re.test(u))) return lvl;
  }
  return "low";
}

function groupFilesByPriority() {
  const all = listTextFilesForContent(); // —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω—ã assets/.meta –∏ –ø—Ä–æ—á–∏–µ –ø–æ EXCLUDE_FILES_PATTERNS
  return {
    critical: all.filter(f => getPriority(f) === "critical"),
    high:     all.filter(f => getPriority(f) === "high"),
    medium:   all.filter(f => getPriority(f) === "medium"),
    low:      all.filter(f => getPriority(f) === "low"),
  };
}

function fileBlock(rel) {
  return [
    "//=================================================",
    `// FILE: /${toUnix(rel)}`,
    readText(rel),
    ""
  ].join("\n");
}

// -------------------- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞ --------------------
function headerBlock() {
  const now = new Date().toISOString().replace("T"," ").slice(0,19) + " UTC";
  return [
    rulesBlock(),
    metaBlock(),
    "–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:",
    buildFullTree(),
    `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${now}`,
    ""
  ].join("\n");
}

// -------------------- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã --------------------
function generateFull() {
  let out = headerBlock();

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium", "low"];
  for (const lvl of order) {
    for (const f of groups[lvl]) {
      out += fileBlock(f);
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

function generateAdaptive() {
  let out = headerBlock();
  let cur = countLines(out);
  const max = MAX_LINES;

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium"]; // low –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ adaptive —á–∞—â–µ –≤—Å–µ–≥–æ

  for (const lvl of order) {
    for (const f of groups[lvl]) {
      const block = fileBlock(f);
      const L = countLines(block);
      if (cur + L > max) {
        out += "\n// ... (truncate)\n";
        return out;
      }
      out += block; cur += L;
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

// -------------------- MAIN --------------------
function main() {
  if (MODE === "full" || MODE === "both") {
    fs.writeFileSync(FULL_FILE, generateFull(), "utf8");
    console.log(`‚úÖ ${FULL_FILE}`);
  }
  if (MODE === "adaptive" || MODE === "both") {
    fs.writeFileSync(ADAPTIVE_FILE, generateAdaptive(), "utf8");
    console.log(`‚úÖ ${ADAPTIVE_FILE}`);
  }
}

try { main(); } catch (e) { console.error("‚ùå", e); process.exit(1); }

//=================================================
// FILE: /news/news.json
{
  "items": [
    {
      "id": "2025-11-01-release",
      "title": "–ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ ‚Äî –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "date": "2025-11-01",
      "text": "–î–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
      "image": "img/logo.png",
      "tags": ["—Ä–µ–ª–∏–∑", "–∞–ª—å–±–æ–º"]
    },
    {
      "id": "2025-10-20-video",
      "title": "–ö–ª–∏–ø –Ω–∞ —Ç—Ä–µ–∫ ¬´–û—Ç—Ä–∞–∂–µ–Ω–∏–µ¬ª",
      "date": "2025-10-20",
      "embedUrl": "https://www.youtube.com/embed/dQw4w9WgXcQ",
      "tags": ["–∫–ª–∏–ø", "–≤–∏–¥–µ–æ"]
    },
    {
      "id": "2025-10-05-tour",
      "title": "–¢—É—Ä: –∑–∏–º–Ω–∏–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã",
      "date": "2025-10-05",
      "text": "–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü—Å–µ—Ç—è—Ö.",
      "tags": ["–∫–æ–Ω—Ü–µ—Ä—Ç—ã"]
    }
  ]
}

//=================================================
// FILE: /src/player-core/media-session.js
// src/player-core/media-session.js
// MediaSession: handlers —Å—Ç–∞–≤–∏–º –æ–¥–∏–Ω —Ä–∞–∑, metadata/position –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ –º–µ—Ä–µ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏.

export function ensureMediaSession(handlers) {
  if (!('mediaSession' in navigator)) return null;

  const ms = navigator.mediaSession;

  // guard: —Å—Ç–∞–≤–∏–º handlers 1 —Ä–∞–∑
  if (!ms.__vitrinaHandlersBound) {
    ms.__vitrinaHandlersBound = true;

    const h = handlers || {};

    const safe = (fn) => () => { try { fn && fn(); } catch {} };

    ms.setActionHandler('play', safe(h.onPlay));
    ms.setActionHandler('pause', safe(h.onPause));
    ms.setActionHandler('stop', safe(h.onStop));
    ms.setActionHandler('previoustrack', safe(h.onPrev));
    ms.setActionHandler('nexttrack', safe(h.onNext));

    ms.setActionHandler('seekbackward', (details) => {
      const off = Number(details?.seekOffset || 10);
      try { h.onSeekBy && h.onSeekBy(-off); } catch {}
    });

    ms.setActionHandler('seekforward', (details) => {
      const off = Number(details?.seekOffset || 10);
      try { h.onSeekBy && h.onSeekBy(off); } catch {}
    });

    ms.setActionHandler('seekto', (details) => {
      const t = Number(details?.seekTime);
      if (!Number.isFinite(t)) return;
      try { h.onSeekTo && h.onSeekTo(t); } catch {}
    });
  }

  const buildArtwork = (artworkUrl) => {
    const src = String(artworkUrl || '').trim();
    if (!src) return [];
    return [
      { src, sizes: '96x96', type: 'image/png' },
      { src, sizes: '128x128', type: 'image/png' },
      { src, sizes: '192x192', type: 'image/png' },
      { src, sizes: '256x256', type: 'image/png' },
      { src, sizes: '384x384', type: 'image/png' },
      { src, sizes: '512x512', type: 'image/png' },
    ];
  };

  function updateMetadata({ title, artist, album, artworkUrl, playing } = {}) {
    try {
      ms.metadata = new MediaMetadata({
        title: String(title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
        artist: String(artist || ''),
        album: String(album || ''),
        artwork: buildArtwork(artworkUrl),
      });
    } catch {}

    try { ms.playbackState = playing ? 'playing' : 'paused'; } catch {}
  }

  function updatePositionState() {
    try {
      if (typeof ms.setPositionState !== 'function') return;
      const st = handlers?.getPositionState ? handlers.getPositionState() : null;
      if (!st) return;

      ms.setPositionState({
        duration: Number(st.duration || 0) || 0,
        playbackRate: Number(st.playbackRate || 1.0) || 1.0,
        position: Number(st.position || 0) || 0,
      });
    } catch {}
  }

  return { updateMetadata, updatePositionState };
}

//=================================================
// FILE: /src/player-core/stats-tracker.js
// src/player-core/stats-tracker.js
// –ï–¥–∏–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
// - —Å–µ–∫—É–Ω–¥—ã: lastSecondReported (—É—Å—Ç–æ–π—á–∏–≤–æ, –±–µ–∑ "Math.floor(pos) > Math.floor(lastPos)" —Ä–∞–∑–±—Ä–æ—Å–∞)
// - full listen: duration –≤–∞–ª–∏–¥–Ω–∞ –∏ (pos/dur > 0.9) –Ω–∞ –º–æ–º–µ–Ω—Ç ended
// - –Ω–∏–∫–∞–∫–∏—Ö stop/play/seek –≤–Ω—É—Ç—Ä–∏

function safeUid(v) {
  const s = String(v || '').trim();
  return s ? s : null;
}

export function createListenStatsTracker({ getUid, getPos, getDur, record } = {}) {
  const state = {
    lastSecondReported: -1,
    activeUid: null,
  };

  function resetForUid(uid) {
    state.activeUid = uid;
    state.lastSecondReported = -1;
  }

  function onTick() {
    const uid = safeUid(getUid && getUid());
    if (!uid) return;

    if (uid !== state.activeUid) resetForUid(uid);

    const pos = Number(getPos && getPos()) || 0;
    const sec = Math.floor(pos);

    if (!Number.isFinite(sec) || sec < 0) return;
    if (sec <= state.lastSecondReported) return;

    state.lastSecondReported = sec;

    try {
      record && record(uid, { deltaSec: 1, isFullListen: false });
    } catch {}
  }

  function onPauseOrStop() {
    // —Å–µ–π—á–∞—Å —Å–µ–∫—É–Ω–¥—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ onTick; –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–∞—ë–º –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å lastSecond –º–µ–∂–¥—É —Ç—Ä–µ–∫–∞–º–∏
    const uid = safeUid(getUid && getUid());
    if (!uid) return;
    if (uid !== state.activeUid) resetForUid(uid);
  }

  function onEnded() {
    const uid = safeUid(getUid && getUid());
    if (!uid) return;

    if (uid !== state.activeUid) resetForUid(uid);

    const dur = Number(getDur && getDur()) || 0;
    const pos = Number(getPos && getPos()) || 0;

    const durationValid = Number.isFinite(dur) && dur > 0;
    const progress = durationValid ? (pos / dur) : 0;

    const isFullListen = !!(durationValid && progress > 0.9);

    try {
      record && record(uid, { deltaSec: 0, isFullListen });
    } catch {}
  }

  return { onTick, onPauseOrStop, onEnded };
}

//=================================================
// FILE: /src/PlayerCore.js
// src/PlayerCore.js
// –Ø–¥—Ä–æ –ø–ª–µ–µ—Ä–∞ –Ω–∞ –±–∞–∑–µ Howler.js (ESM)
// –¢–ó_–ù–¨–Æ: –Ω–∏–∫–∞–∫–∏—Ö stop()/—Ñ–æ—Ä—Å–∏—Ç—å play()/—Å–±—Ä–∞—Å—ã–≤–∞—Ç—å pos/volume –∏–∑-–∑–∞ –æ—Ñ—Ñ–ª–∞–π–Ω/–∫—ç—à–∞.
// STOP —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ: –∫–Ω–æ–ø–∫–∞ Stop, –∏ —Å–ø–µ—Ü-—Å—Ü–µ–Ω–∞—Ä–∏–π –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (–≤ FavoritesManager), –∏ —Ç.–ø.

import { ensureMediaSession } from './player-core/media-session.js';
import { createListenStatsTracker } from './player-core/stats-tracker.js';

(function PlayerCoreModule() {
  'use strict';

  const W = window;

  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  function normQ(v) {
    return String(v || '').toLowerCase().trim() === 'lo' ? 'lo' : 'hi';
  }

  function safeUid(v) {
    const s = String(v || '').trim();
    return s ? s : null;
  }

  function safeUrl(v) {
    const s = String(v || '').trim();
    return s ? s : null;
  }

  class PlayerCore {
    constructor() {
      this.playlist = [];
      this.originalPlaylist = [];
      this.currentIndex = -1;

      this.sound = null;
      this.isReady = false;

      this.repeatMode = false;
      this.shuffleMode = false;

      this.shuffleHistory = [];
      this.historyMax = 200;

      this.tickInterval = null;
      this.tickRate = 100;

      this.callbacks = {
        onTrackChange: [],
        onPlay: [],
        onPause: [],
        onStop: [],
        onEnd: [],
        onTick: [],
        onError: [],
        onSleepTriggered: [],
      };

      this.metadata = {
        artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: '',
        cover: '',
      };

      this.sleepTimerTarget = 0;
      this.sleepTimerId = null;

      this.qualityStorageKey = 'qualityMode:v1';
      this.qualityMode = this._readQualityMode();

      // v1.0
      this.sourceKey = 'audio';

      this._offlineNoCacheToastShown = false;
      this._hasAnyOfflineCacheComplete = null;

      this._mediaSession = ensureMediaSession({
        onPlay: () => this.play(),
        onPause: () => this.pause(),
        onStop: () => this.stop(),
        onPrev: () => this.prev(),
        onNext: () => this.next(),
        onSeekTo: (t) => this.seek(t),
        onSeekBy: (delta) => {
          const pos = this.getPosition();
          const dur = this.getDuration();
          this.seek(clamp(pos + delta, 0, dur || 0));
        },
        getPositionState: () => ({
          duration: this.getDuration(),
          position: this.getPosition(),
          playbackRate: 1.0,
        }),
      });

      this._stats = createListenStatsTracker({
        getUid: () => safeUid(this.getCurrentTrack()?.uid),
        getPos: () => this.getPosition(),
        getDur: () => this.getDuration(),
        record: (uid, payload) => {
          const om = W.OfflineUI?.offlineManager;
          if (om && typeof om.recordListenStats === 'function') {
            om.recordListenStats(uid, payload);
          }
        },
      });
    }

    initialize() {
      this.isReady = true;
    }

    // =========================
    // Playlist
    // =========================
    setPlaylist(tracks, startIndex = 0, metadata = {}, options = {}) {
      const wasPlaying = this.isPlaying();
      const prev = this.getCurrentTrack();
      const prevUid = safeUid(prev?.uid);
      const prevPos = this.getPosition();

      const {
        preserveOriginalPlaylist = false,
        preserveShuffleMode = false,
        resetHistory = true,
      } = options || {};

      this._hasAnyOfflineCacheComplete = null;

      this.playlist = (Array.isArray(tracks) ? tracks : []).map((t) => {
        const uid = safeUid(t?.uid);

        const sources = (t && typeof t === 'object' && t.sources && typeof t.sources === 'object')
          ? t.sources
          : null;

        const src = this._selectSrc({
          legacySrc: t?.src,
          sources,
          sourceKey: this.sourceKey,
          qualityMode: this.qualityMode,
        });

        return {
          src: safeUrl(src),
          sources,

          title: t?.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
          artist: t?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          album: t?.album || '',
          cover: t?.cover || '',

          lyrics: t?.lyrics || null,
          fulltext: t?.fulltext || null,
          uid,
          hasLyrics: (typeof t?.hasLyrics === 'boolean') ? t.hasLyrics : null,
          sourceAlbum: t?.sourceAlbum || null,
        };
      });

      if (!preserveOriginalPlaylist) {
        this.originalPlaylist = this.playlist.slice();
      }

      this.metadata = { ...this.metadata, ...(metadata || {}) };

      if (resetHistory) this.shuffleHistory = [];

      if (this.shuffleMode && !preserveShuffleMode) {
        this.shufflePlaylist();
      } else if (!this.shuffleMode && !preserveShuffleMode) {
        // no-op
      }

      let nextIndex = -1;
      if (prevUid) nextIndex = this.playlist.findIndex(t => safeUid(t?.uid) === prevUid);

      if (nextIndex < 0) {
        const len = this.playlist.length;
        nextIndex = len ? clamp(startIndex, 0, len - 1) : -1;
      }

      this.currentIndex = nextIndex;

      if (wasPlaying && this.currentIndex >= 0) {
        this.load(this.currentIndex, { autoPlay: true, resumePosition: prevPos });
      } else {
        const cur = this.getCurrentTrack();
        if (cur) {
          this.trigger('onTrackChange', cur, this.currentIndex);
          this._updateMedia(cur);
        }
      }
    }

    getPlaylistSnapshot() {
      return this.playlist.slice();
    }

    // =========================
    // Playback resolving
    // =========================
    async _resolvePlaybackUrlForTrack(track) {
      try {
        const om = W.OfflineUI?.offlineManager;
        if (!om || typeof om.resolveForPlayback !== 'function') {
          return {
            url: safeUrl(track?.src),
            effectiveQuality: this.getQualityMode(),
            isLocal: false,
            reason: 'noOfflineManager'
          };
        }

        const pq = this.getQualityMode();
        const r = await om.resolveForPlayback(track, pq);

        return {
          url: safeUrl(r?.url),
          effectiveQuality: normQ(r?.effectiveQuality || pq),
          isLocal: !!r?.isLocal,
          reason: String(r?.reason || '')
        };
      } catch {
        return {
          url: safeUrl(track?.src),
          effectiveQuality: this.getQualityMode(),
          isLocal: false,
          reason: 'resolverError'
        };
      }
    }

    async _getHasAnyOfflineCompleteCached() {
      if (this._hasAnyOfflineCacheComplete === true) return true;
      if (this._hasAnyOfflineCacheComplete === false) return false;

      try {
        const om = W.OfflineUI?.offlineManager;
        if (!om || typeof om.hasAnyComplete !== 'function') {
          this._hasAnyOfflineCacheComplete = false;
          return false;
        }

        const uids = this.playlist.map(t => safeUid(t?.uid)).filter(Boolean);
        const yes = await om.hasAnyComplete(uids);
        this._hasAnyOfflineCacheComplete = !!yes;
        return !!yes;
      } catch {
        this._hasAnyOfflineCacheComplete = false;
        return false;
      }
    }

    async _findNextPlayableIndex(direction) {
      const len = this.playlist.length;
      if (!len) return -1;

      const dir = (direction === 'backward') ? -1 : 1;
      const base = this.currentIndex >= 0 ? this.currentIndex : 0;

      for (let step = 1; step <= len; step++) {
        const idx = (base + (dir * step) + len) % len;
        const t = this.playlist[idx];
        if (!t) continue;

        // eslint-disable-next-line no-await-in-loop
        const r = await this._resolvePlaybackUrlForTrack(t);
        if (r.url) return idx;
      }

      return -1;
    }

    _isNetworkOnline() {
      try {
        if (W.NetworkManager?.getStatus) return !!W.NetworkManager.getStatus().online;
      } catch {}
      return navigator.onLine !== false;
    }

    async _skipUnavailableAndPlay(direction) {
      const dir = (direction === 'backward') ? 'backward' : 'forward';

      // –ï—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç—Ä–µ–∫ ‚Äî –ø–µ—Ä–µ–ø—Ä—ã–≥–∏–≤–∞–µ–º –Ω–∞ –Ω–µ–≥–æ.
      const idx = await this._findNextPlayableIndex(dir);
      if (idx >= 0) {
        this.currentIndex = idx;
        await this.play(idx);
        return true;
      }

      // –ù–∏—á–µ–≥–æ –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ/–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ: –ø–æ–∫–∞–∂–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–¥–∏–Ω —Ä–∞–∑.
      if (!this._offlineNoCacheToastShown) {
        this._offlineNoCacheToastShown = true;
        W.NotificationSystem?.warning('–ù–µ—Ç —Å–µ—Ç–∏ –∏ –Ω–µ—Ç –æ—Ñ–ª–∞–π–Ω-–∫—ç—à–∞');
      }

      return false;
    }

    // =========================
    // Public controls
    // =========================
    async play(index = null, options = {}) {
      if (index !== null && Number.isFinite(index) && index >= 0 && index < this.playlist.length) {
        await this.load(index, options);
      }

      this._pushHistoryForCurrent();

      if (!this.sound) return;

      this.sound.play();
      this._updateMedia(this.getCurrentTrack());
    }

    pause() {
      if (!this.sound) return;

      this.sound.pause();
      this.stopTick();
      this._stats.onPauseOrStop();

      this.trigger('onPause', this.getCurrentTrack(), this.currentIndex);
      this._updateMedia(this.getCurrentTrack());
    }

    stop() {
      // –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π stop: –ø–æ –∫–Ω–æ–ø–∫–µ Stop –∏–ª–∏ —Å–ø–µ—Ü-—Å–ª—É—á–∞–∏ –∏–∑–≤–Ω–µ.
      if (this.sound) {
        try { this.sound.stop(); } catch {}
        try { this.sound.unload(); } catch {}
        this.sound = null;
      }

      this.stopTick();
      this._stats.onPauseOrStop();

      this.trigger('onStop', this.getCurrentTrack(), this.currentIndex);
      this._updateMedia(this.getCurrentTrack());
    }

    _silentUnloadCurrentSound() {
      // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π unload: –ù–ï trigger onStop (–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç).
      if (this.sound) {
        try { this.sound.stop(); } catch {}
        try { this.sound.unload(); } catch {}
        this.sound = null;
      }
      this.stopTick();
      this._stats.onPauseOrStop();
    }

    async load(index, options = {}) {
      if (!Number.isFinite(index) || index < 0 || index >= this.playlist.length) return;

      const { autoPlay = false, resumePosition = null } = options || {};
      let html5 = (typeof options.html5 === 'boolean') ? options.html5 : true;

      // –ù–µ–ª—å–∑—è stop() => —Ç–∏—Ö–∏–π unload
      this._silentUnloadCurrentSound();

      this.currentIndex = index;
      const track = this.playlist[index];
      if (!track) return;

      const resolved = await this._resolvePlaybackUrlForTrack(track);

      // –¢–ó 16.1: offline playback —á–µ—Ä–µ–∑ WebAudio + blobs/objectURL
      if (resolved.isLocal) html5 = false;

      if (!resolved.url) {
        // ‚úÖ –¢–ó 7.5.2: –µ—Å–ª–∏ —Å–µ—Ç–∏ –Ω–µ—Ç ‚Äî —Ç–∏—Ö–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏.
        // –ù–µ —Å—Ç–æ–ø–∞–µ–º –ø–ª–µ–µ—Ä, –Ω–µ –ª–æ–º–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç, –ø—Ä–æ—Å—Ç–æ –ø—Ä—ã–≥–∞–µ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–æ—Å—Ç—É–ø–Ω–æ–º—É.
        const netOnline = this._isNetworkOnline();

        if (!netOnline) {
          // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –≤—ã–∑–≤–∞–ª–∏ load() –∏–∑ next/auto ‚Äî –±—É–¥–µ—Ç forward –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          const dir = (options && options.direction === 'backward') ? 'backward' : 'forward';
          await this._skipUnavailableAndPlay(dir);
          return;
        }

        // –°–µ—Ç—å –µ—Å—Ç—å, –Ω–æ resolve –Ω–µ –¥–∞–ª URL (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π) ‚Äî —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: fallback –≤–ø–µ—Ä—ë–¥, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ
        const hasAny = await this._getHasAnyOfflineCompleteCached();

        if (!hasAny) {
          if (!this._offlineNoCacheToastShown) {
            this._offlineNoCacheToastShown = true;
            W.NotificationSystem?.warning('–ù–µ—Ç —Å–µ—Ç–∏ –∏ –Ω–µ—Ç –æ—Ñ–ª–∞–π–Ω-–∫—ç—à–∞');
          }
          return;
        }

        const fallbackIdx = await this._findNextPlayableIndex('forward');
        if (fallbackIdx >= 0 && fallbackIdx !== index) {
          this.currentIndex = fallbackIdx;
          this.play(fallbackIdx);
        }
        return;
      }

      // —Ñ–∏–∫—Å–∏—Ä—É–µ–º URL (–º–æ–∂–µ—Ç –±—ã—Ç—å blob)
      this.playlist[index].src = resolved.url;

      const initialVolume = this.getVolume() / 100;

      this.sound = new Howl({
        src: [resolved.url],
        html5,
        preload: true,
        volume: initialVolume,

        onplay: () => {
          this.startTick();
          this.trigger('onPlay', track, index);
          this._updateMedia(this.getCurrentTrack());
        },

        onpause: () => {
          this.stopTick();
          this._stats.onPauseOrStop();
          this.trigger('onPause', track, index);
          this._updateMedia(this.getCurrentTrack());
        },

        onend: () => {
          this.stopTick();
          this._stats.onEnded();

          this.trigger('onEnd', track, index);
          this._updateMedia(this.getCurrentTrack());
          this.handleTrackEnd();
        },

        onload: () => {
          if (typeof resumePosition === 'number' && Number.isFinite(resumePosition) && resumePosition > 0) {
            try { this.seek(resumePosition); } catch {}
          }
          if (autoPlay) {
            try { this.play(); } catch {}
          }
          this._updateMedia(this.getCurrentTrack());
        },

        onloaderror: (id, error) => {
          this.trigger('onError', { type: 'load', error, track, index });
        },

        onplayerror: (id, error) => {
          this.trigger('onError', { type: 'play', error, track, index });
        },
      });

      this.trigger('onTrackChange', track, index);
      this._updateMedia(track);
    }

    handleTrackEnd() {
      if (this.repeatMode) {
        this.play(this.currentIndex);
        return;
      }
      this.next();
    }

    next() {
      const len = this.playlist.length;
      if (!len) return;

      this._pushHistoryForCurrent();

      const cur = this.currentIndex >= 0 ? this.currentIndex : 0;
      const nextIndex = (cur + 1) % len;

      // ‚úÖ –ø–µ—Ä–µ–¥–∞—ë–º direction, —á—Ç–æ–±—ã –ø—Ä–∏ offline skip –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ç—Ä–æ–∏–ª—Å—è –ø–æ–∏—Å–∫
      this.play(nextIndex, { direction: 'forward' });
    }

    prev() {
      const len = this.playlist.length;
      if (!len) return;

      if (this.getPosition() > 3) {
        this.seek(0);
        return;
      }

      const histIdx = this._popHistoryPrevIndex();
      if (Number.isFinite(histIdx) && histIdx >= 0) {
        this.play(histIdx, { direction: 'backward' });
        return;
      }

      const cur = this.currentIndex >= 0 ? this.currentIndex : 0;
      const prevIndex = (cur - 1 + len) % len;

      this.play(prevIndex, { direction: 'backward' });
    }

    // =========================
    // Seek / Position
    // =========================
    seek(seconds) {
      if (!this.sound) return;
      const t = Number(seconds);
      if (!Number.isFinite(t)) return;
      this.sound.seek(t);
    }

    getPosition() {
      if (!this.sound) return 0;
      return Number(this.sound.seek() || 0) || 0;
    }

    getDuration() {
      if (!this.sound) return 0;
      return Number(this.sound.duration() || 0) || 0;
    }

    // =========================
    // Volume / Mute
    // =========================
    setVolume(percent) {
      const p = clamp(Number(percent) || 0, 0, 100);
      const v = p / 100;

      if (this.sound) {
        try { this.sound.volume(v); } catch {}
      }
      try { Howler.volume(v); } catch {}

      try { localStorage.setItem('playerVolume', String(Math.round(p))); } catch {}
    }

    getVolume() {
      const saved = localStorage.getItem('playerVolume');
      const n = Number.parseInt(String(saved ?? ''), 10);
      return Number.isFinite(n) ? clamp(n, 0, 100) : 100;
    }

    setMuted(muted) {
      try { Howler.mute(!!muted); } catch {}
      try { this.sound?.mute?.(!!muted); } catch {}
    }

    // =========================
    // Repeat / Shuffle
    // =========================
    toggleRepeat() {
      this.repeatMode = !this.repeatMode;
    }

    isRepeat() {
      return this.repeatMode;
    }

    setShuffleMode(enabled) {
      const next = !!enabled;
      if (this.shuffleMode === next) return;

      this.shuffleMode = next;

      if (this.shuffleMode) this.shufflePlaylist();
      else this.playlist = this.originalPlaylist.slice();
    }

    toggleShuffle() {
      this.setShuffleMode(!this.shuffleMode);
    }

    isShuffle() {
      return this.shuffleMode;
    }

    shufflePlaylist() {
      const currentTrack = this.getCurrentTrack();
      const curUid = safeUid(currentTrack?.uid);

      this.shuffleHistory = [];

      const shuffled = this.playlist.slice();
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      this.playlist = shuffled;

      if (!currentTrack) return;

      if (curUid) {
        const byUid = this.playlist.findIndex(t => safeUid(t?.uid) === curUid);
        if (byUid >= 0) this.currentIndex = byUid;
      } else {
        const src = safeUrl(currentTrack?.src);
        const bySrc = src ? this.playlist.findIndex(t => safeUrl(t?.src) === src) : -1;
        if (bySrc >= 0) this.currentIndex = bySrc;
      }
    }

    // =========================
    // PQ Hi/Lo (Playback Quality)
    // =========================
    _readQualityMode() {
      try { return normQ(localStorage.getItem(this.qualityStorageKey)); } catch { return 'hi'; }
    }

    _writeQualityMode(mode) {
      const m = normQ(mode);
      try { localStorage.setItem(this.qualityStorageKey, m); } catch {}
      return m;
    }

    getQualityMode() {
      return normQ(this.qualityMode);
    }

    setQualityMode(mode) {
      const m = this._writeQualityMode(mode);
      this.qualityMode = m;
      return m;
    }

    _selectSrc({ legacySrc, sources, sourceKey, qualityMode }) {
      const key = String(sourceKey || 'audio');
      const q = normQ(qualityMode);

      const srcLegacy = safeUrl(legacySrc);
      const srcHi = safeUrl(sources?.[key]?.hi);
      const srcLo = safeUrl(sources?.[key]?.lo);

      return (q === 'lo') ? (srcLo || srcHi || srcLegacy) : (srcHi || srcLo || srcLegacy);
    }

    canToggleQualityForCurrentTrack() {
      const track = this.getCurrentTrack();
      if (!track) return false;
      const key = this.sourceKey || 'audio';
      const lo = safeUrl(track?.sources?.[key]?.lo);
      return !!lo;
    }

    switchQuality(mode) {
      // –¢–ó 4.2: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å pos + wasPlaying, –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –±–µ–∑ stop.
      const nextMode = this.setQualityMode(mode);

      const track = this.getCurrentTrack();
      if (!track) return { ok: true, mode: nextMode, changed: false };

      if (!this.canToggleQualityForCurrentTrack()) {
        return { ok: true, mode: nextMode, changed: false, disabled: true };
      }

      const desiredSrc = this._selectSrc({
        legacySrc: track.src,
        sources: track.sources,
        sourceKey: this.sourceKey,
        qualityMode: nextMode,
      });

      if (!desiredSrc || desiredSrc === track.src) {
        return { ok: true, mode: nextMode, changed: false };
      }

      const wasPlaying = this.isPlaying();
      const pos = this.getPosition();
      const idx = this.currentIndex;

      // –æ–±–Ω–æ–≤–∏–º src –ø–æ uid (–∏ playlist, –∏ originalPlaylist)
      const uid = safeUid(track.uid);
      if (uid) {
        const pi = this.playlist.findIndex(t => safeUid(t?.uid) === uid);
        if (pi >= 0) this.playlist[pi].src = desiredSrc;

        const oi = this.originalPlaylist.findIndex(t => safeUid(t?.uid) === uid);
        if (oi >= 0) this.originalPlaylist[oi].src = desiredSrc;
      } else if (this.playlist[idx]) {
        this.playlist[idx].src = desiredSrc;
      }

      this._silentUnloadCurrentSound();
      this.load(idx, { autoPlay: wasPlaying, resumePosition: pos });

      return { ok: true, mode: nextMode, changed: true };
    }

    // Back-compat
    setQuality(quality) {
      const q = String(quality || '').toLowerCase();
      if (q === 'low' || q === 'lo') this.switchQuality('lo');
      else if (q === 'high' || q === 'hi') this.switchQuality('hi');
    }

    // =========================
    // State getters
    // =========================
    getCurrentTrack() {
      if (this.currentIndex < 0 || this.currentIndex >= this.playlist.length) return null;
      return this.playlist[this.currentIndex] || null;
    }

    getIndex() { return this.currentIndex; }

    getNextIndex() {
      const len = this.playlist.length;
      if (!len || this.currentIndex < 0) return -1;
      return (this.currentIndex + 1) % len;
    }

    isPlaying() {
      return !!(this.sound && this.sound.playing && this.sound.playing());
    }

    // =========================
    // Events
    // =========================
    on(events) {
      Object.keys(events || {}).forEach((event) => {
        if (this.callbacks[event]) this.callbacks[event].push(events[event]);
      });
    }

    trigger(event, ...args) {
      const arr = this.callbacks[event];
      if (!arr) return;
      for (const fn of arr) {
        try { fn(...args); } catch {}
      }
    }

    // =========================
    // Tick: progress + stats
    // =========================
    startTick() {
      this.stopTick();
      this.tickInterval = setInterval(() => {
        const pos = this.getPosition();
        const dur = this.getDuration();
        this.trigger('onTick', pos, dur);
        this._stats.onTick();
      }, this.tickRate);
    }

    stopTick() {
      if (!this.tickInterval) return;
      clearInterval(this.tickInterval);
      this.tickInterval = null;
    }

    // =========================
    // Sleep timer
    // =========================
    setSleepTimer(ms) {
      const delay = Number(ms) || 0;
      if (delay <= 0) {
        this.clearSleepTimer();
        return;
      }

      this.sleepTimerTarget = Date.now() + delay;

      if (this.sleepTimerId) {
        clearTimeout(this.sleepTimerId);
        this.sleepTimerId = null;
      }

      this.sleepTimerId = setTimeout(() => {
        this.sleepTimerId = null;

        const target = this.sleepTimerTarget;
        this.sleepTimerTarget = 0;

        this.trigger('onSleepTriggered', { targetAt: target });

        // –ø—Ä–æ–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞: —Ç–∞–π–º–µ—Ä –¥–µ–ª–∞–µ—Ç pause (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
        if (this.isPlaying()) {
          try { this.pause(); } catch {}
        }
      }, delay);
    }

    clearSleepTimer() {
      if (this.sleepTimerId) {
        clearTimeout(this.sleepTimerId);
        this.sleepTimerId = null;
      }
      this.sleepTimerTarget = 0;
    }

    getSleepTimerTarget() {
      return this.sleepTimerTarget || 0;
    }

    // =========================
    // MediaSession
    // =========================
    _updateMedia(track) {
      if (!this._mediaSession) return;
      this._mediaSession.updateMetadata({
        title: track?.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
        artist: track?.artist || this.metadata.artist,
        album: track?.album || this.metadata.album,
        artworkUrl: track?.cover || this.metadata.cover || 'icons/icon-512.png',
        playing: this.isPlaying(),
      });
      this._mediaSession.updatePositionState();
    }

    // =========================
    // Shuffle history
    // =========================
    _pushHistoryForCurrent() {
      try {
        const t = this.getCurrentTrack();
        const uid = safeUid(t?.uid);
        if (!uid) return;

        const last = this.shuffleHistory.length ? this.shuffleHistory[this.shuffleHistory.length - 1] : null;
        if (last && last.uid === uid) return;

        this.shuffleHistory.push({ uid });

        if (this.shuffleHistory.length > this.historyMax) {
          this.shuffleHistory.splice(0, this.shuffleHistory.length - this.historyMax);
        }
      } catch {}
    }

    _popHistoryPrevIndex() {
      try {
        if (!this.shuffleMode) return -1;
        if (!Array.isArray(this.shuffleHistory) || this.shuffleHistory.length === 0) return -1;

        this.shuffleHistory.pop();
        const prev = this.shuffleHistory.length ? this.shuffleHistory[this.shuffleHistory.length - 1] : null;
        const uid = safeUid(prev?.uid);
        if (!uid) return -1;

        const idx = this.playlist.findIndex(t => safeUid(t?.uid) === uid);
        return idx >= 0 ? idx : -1;
      } catch {
        return -1;
      }
    }

    // =========================
    // Helpers for PlaybackPolicy
    // =========================
    appendToPlaylistTail(tracks) {
      const list = Array.isArray(tracks) ? tracks : [];
      if (!list.length) return;

      const existingUid = new Set(this.playlist.map(t => safeUid(t?.uid)).filter(Boolean));

      const toAdd = [];
      for (const t of list) {
        const uid = safeUid(t?.uid);
        if (!uid || existingUid.has(uid)) continue;
        existingUid.add(uid);

        toAdd.push({
          src: safeUrl(t?.src),
          sources: t?.sources || null,
          title: t?.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
          artist: t?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          album: t?.album || '',
          cover: t?.cover || '',
          lyrics: t?.lyrics || null,
          fulltext: t?.fulltext || null,
          uid,
          sourceAlbum: t?.sourceAlbum || null,
        });
      }

      if (!toAdd.length) return;
      this.playlist = this.playlist.concat(toAdd);
    }

    removeFromPlaylistTailIfNotPlayed(params = {}) {
      const uid = safeUid(params?.uid);
      if (!uid) return false;

      const curUid = safeUid(this.getCurrentTrack()?.uid);
      if (curUid && curUid === uid) return false;

      const played = Array.isArray(this.shuffleHistory)
        ? this.shuffleHistory.some(h => safeUid(h?.uid) === uid)
        : false;

      if (played) return false;

      const beforeLen = this.playlist.length;
      this.playlist = this.playlist.filter(t => safeUid(t?.uid) !== uid);

      if (this.currentIndex >= this.playlist.length) {
        this.currentIndex = this.playlist.length - 1;
      }

      return this.playlist.length !== beforeLen;
    }

    // =========================
    // Backend rebuild (pulse)
    // =========================
    rebuildCurrentSound(options = {}) {
      try {
        const track = this.getCurrentTrack();
        if (!track) return false;

        const preferWebAudio = !!options.preferWebAudio;
        const targetHtml5 = !preferWebAudio;

        const wasPlaying = this.isPlaying();
        const pos = this.getPosition();
        const idx = this.currentIndex;

        const curHtml5 = !!(this.sound && this.sound._html5);
        if (this.sound && curHtml5 === targetHtml5) return true;

        this._silentUnloadCurrentSound();
        this.load(idx, { autoPlay: wasPlaying, resumePosition: pos, html5: targetHtml5 });
        return true;
      } catch {
        return false;
      }
    }

    getAudioElement() {
      try {
        if (this.sound && this.sound._sounds && this.sound._sounds[0]) {
          return this.sound._sounds[0]._node;
        }
      } catch {}
      return null;
    }

    destroy() {
      this.stop();
      this.playlist = [];
      this.originalPlaylist = [];
      this.currentIndex = -1;

      this.callbacks = {
        onTrackChange: [],
        onPlay: [],
        onPause: [],
        onStop: [],
        onEnd: [],
        onTick: [],
        onError: [],
        onSleepTriggered: [],
      };
    }
  }

  W.playerCore = new PlayerCore();

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => W.playerCore.initialize());
  } else {
    W.playerCore.initialize();
  }
})();

//=================================================
// FILE: /styles/main.css
/* ============================================
   JEEMPO PLAYER - MAIN STYLES
   Optimized & Refactored
   ============================================ */

/* === CSS VARIABLES === */
:root {
  /* Colors */
  --bg-primary: #0e0e0e;
  --bg-secondary: #141414;
  --bg-card: #1a1a1a;
  --bg-hover: #252525;
  --bg-active: #2a2a2a;
  
  --text-primary: #fff;
  --text-secondary: #b3b3b3;
  --text-muted: #888;
  --text-dark: #666;
  
  --accent: #1db954;
  --accent-hover: #1ed760;
  --accent-dim: rgba(29,185,84,0.15);
  
  --border-color: #333;
  --border-light: #444;
  
  /* Sizing */
  --header-height: 56px;
  --mini-player-height: 56px;
  --bottom-padding: 80px;
  --border-radius: 8px;
  --border-radius-sm: 6px;
  
  /* Transitions */
  --transition-fast: 0.15s ease;
  --transition-normal: 0.2s ease;
  --transition-slow: 0.3s ease;
  
  /* Shadows */
  --shadow-card: 0 4px 12px rgba(0,0,0,0.4);
  --shadow-button: 0 2px 8px rgba(0,0,0,0.3);
  
  /* Z-index layers */
  --z-header: 100;
  --z-player: 200;
  --z-mini-player: 300;
  --z-modal: 1000;
  --z-toast: 1100;
}

/* === RESET & BASE === */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  overflow-x: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  font-size: 15px;
  line-height: 1.4;
  color: var(--text-primary);
  background: var(--bg-primary);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  -webkit-user-select: none;
}

a {
  color: inherit;
  text-decoration: none;
}

button {
  font: inherit;
  border: none;
  background: transparent;
  cursor: pointer;
  color: inherit;
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--border-light);
}

/* === LAYOUT === */
.main-block {
  max-width: 420px;
  margin: 0 auto;
  padding: 0 16px var(--bottom-padding);
  min-height: 100vh;
}

/* === PROMOCODE SCREEN === */
.promo-screen {
  position: fixed;
  inset: 0;
  background: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: var(--z-modal);
  padding: 20px;
}

.promo-screen.hidden {
  display: none;
}

.promo-container {
  text-align: center;
  width: 100%;
  max-width: 320px;
}

.promo-logo {
  width: 100px;
  margin-bottom: 32px;
  filter: drop-shadow(0 4px 12px rgba(29,185,84,0.3));
}

.promo-container h2 {
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 8px;
}

.promo-container p {
  color: var(--text-secondary);
  margin-bottom: 24px;
  font-size: 14px;
}

#promocode-input {
  width: 100%;
  padding: 14px 16px;
  font-size: 16px;
  text-align: center;
  letter-spacing: 2px;
  text-transform: uppercase;
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  background: var(--bg-secondary);
  color: var(--text-primary);
  transition: border-color var(--transition-fast);
}

#promocode-input:focus {
  outline: none;
  border-color: var(--accent);
}

#promocode-input::placeholder {
  letter-spacing: normal;
  text-transform: none;
  color: var(--text-muted);
}

.promo-error {
  color: #ff4444;
  font-size: 13px;
  margin-top: 12px;
  min-height: 20px;
}

/* === ALBUM HEADER === */
.album-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  margin-bottom: 8px;
  position: sticky;
  top: 0;
  background: var(--bg-primary);
  z-index: var(--z-header);
}

.album-icons {
  display: flex;
  gap: 4px;
}

.album-icon-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background var(--transition-fast);
}

.album-icon-btn:hover {
  background: var(--bg-hover);
}

.album-icon-btn:active {
  background: var(--bg-active);
}

.album-icon-btn svg {
  width: 22px;
  height: 22px;
  fill: var(--text-secondary);
  transition: fill var(--transition-fast);
}

.album-icon-btn:hover svg,
.album-icon-btn.active svg {
  fill: var(--text-primary);
}

/* Shuffle active */
#shuffle-btn.active svg {
  fill: var(--accent);
}

/* Repeat states */
#repeat-btn svg {
  opacity: 0.6;
}

#repeat-btn.active svg {
  fill: var(--accent);
  opacity: 1;
}

#repeat-btn.repeat-one svg {
  fill: #ff9800;
  opacity: 1;
}

/* Offline badge */
#offline-btn {
  position: relative;
}

#offline-btn.alert::after {
  content: '';
  position: absolute;
  top: 8px;
  right: 8px;
  width: 8px;
  height: 8px;
  background: var(--accent);
  border-radius: 50%;
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.7; }
}

/* === COVER & GALLERY === */
.cover-container {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  border-radius: var(--border-radius);
  overflow: hidden;
  margin-bottom: 16px;
  background: var(--bg-card);
}

.album-cover {
  width: 100%;
  height: 100%;
  object-fit: cover;
  cursor: pointer;
  transition: transform var(--transition-slow);
}

.cover-container:hover .album-cover {
  transform: scale(1.02);
}

.gallery-counter {
  position: absolute;
  bottom: 12px;
  right: 12px;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  pointer-events: none;
}

/* === SOCIAL LINKS === */
.social-links {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin: 16px 0;
}

.social-btn {
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border-radius: 50%;
  transition: all var(--transition-fast);
}

.social-btn:hover {
  background: var(--bg-hover);
  transform: scale(1.05);
}

.social-btn:active {
  transform: scale(0.95);
}

.social-btn svg {
  width: 20px;
  height: 20px;
  fill: var(--text-secondary);
  transition: fill var(--transition-fast);
}

.social-btn:hover svg {
  fill: var(--text-primary);
}

/* === TRACK LIST === */
.album-section h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  padding-left: 4px;
}

#track-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.track-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  transition: background var(--transition-fast);
}

.track-item:hover {
  background: var(--bg-hover);
}

.track-item:active {
  background: var(--bg-active);
}

.track-item.playing {
  background: var(--accent-dim);
}

.track-item.playing .track-title {
  color: var(--accent);
}

.track-number {
  width: 24px;
  text-align: center;
  font-size: 14px;
  color: var(--text-muted);
  flex-shrink: 0;
}

.track-item.playing .track-number {
  color: var(--accent);
}

.track-info {
  flex: 1;
  min-width: 0;
}

.track-title {
  font-size: 15px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: color var(--transition-fast);
}

.track-duration {
  font-size: 13px;
  color: var(--text-muted);
  flex-shrink: 0;
}

/* Playing indicator */
.playing-indicator {
  display: none;
  gap: 2px;
  height: 16px;
  align-items: flex-end;
}

.track-item.playing .playing-indicator {
  display: flex;
}

.track-item.playing .track-number-text {
  display: none;
}

.playing-indicator span {
  width: 3px;
  background: var(--accent);
  border-radius: 1px;
  animation: eq-bar 0.8s ease-in-out infinite;
}

.playing-indicator span:nth-child(1) { height: 60%; animation-delay: 0s; }
.playing-indicator span:nth-child(2) { height: 100%; animation-delay: 0.2s; }
.playing-indicator span:nth-child(3) { height: 40%; animation-delay: 0.4s; }

@keyframes eq-bar {
  0%, 100% { transform: scaleY(1); }
  50% { transform: scaleY(0.4); }
}

/* Paused state */
.track-item.playing.paused .playing-indicator span {
  animation-play-state: paused;
}

/* === PLAYER BLOCK === */
.player-block {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 20px 16px;
  margin: 16px 0;
  box-shadow: var(--shadow-card);
}

/* Now playing info */
.now-playing-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.now-playing-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Lyrics section */
.lyrics-section {
  margin-bottom: 16px;
}

.lyrics-toggle-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 10px;
  background: var(--bg-secondary);
  border-radius: var(--border-radius-sm);
  font-size: 13px;
  color: var(--text-secondary);
  transition: all var(--transition-fast);
}

.lyrics-toggle-btn:hover:not(.disabled) {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.lyrics-toggle-btn.active {
  background: var(--accent-dim);
  color: var(--accent);
}

.lyrics-toggle-btn.disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.lyrics-toggle-btn svg {
  width: 16px;
  height: 16px;
  fill: currentColor;
}

/* Lyrics content */
.lyrics-content {
  display: none;
  margin-top: 12px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: var(--border-radius-sm);
  max-height: 200px;
  overflow-y: auto;
}

.lyrics-content.visible {
  display: block;
  animation: fadeIn 0.2s ease;
}

.lyrics-line {
  padding: 6px 8px;
  margin: 2px 0;
  border-radius: 4px;
  font-size: 14px;
  color: var(--text-muted);
  transition: all var(--transition-fast);
  cursor: pointer;
}

.lyrics-line:hover {
  background: var(--bg-hover);
}

.lyrics-line.active {
  color: var(--accent);
  font-weight: 500;
  background: var(--accent-dim);
}

.lyrics-line.past {
  color: var(--text-dark);
}

/* Lyrics placeholder */
.lyrics-placeholder {
  text-align: center;
  color: var(--text-muted);
  padding: 20px;
  font-size: 13px;
}

/* Lyrics spinner */
.lyrics-spinner {
  display: flex;
  justify-content: center;
  padding: 20px;
}

.lyrics-spinner::after {
  content: '';
  width: 24px;
  height: 24px;
  border: 2px solid var(--border-color);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Progress bar */
.progress-container {
  margin-bottom: 16px;
}

.progress-bar {
  height: 4px;
  background: var(--bg-hover);
  border-radius: 2px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.progress-bar:hover {
  height: 6px;
}

.progress-current {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  width: 0%;
  position: relative;
  transition: width 0.1s linear;
}

.progress-current::after {
  content: '';
  position: absolute;
  right: -6px;
  top: 50%;
  transform: translateY(-50%) scale(0);
  width: 12px;
  height: 12px;
  background: var(--text-primary);
  border-radius: 50%;
  transition: transform var(--transition-fast);
  box-shadow: var(--shadow-button);
}

.progress-bar:hover .progress-current::after {
  transform: translateY(-50%) scale(1);
}

.progress-times {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
  font-size: 11px;
  color: var(--text-muted);
  font-variant-numeric: tabular-nums;
}

/* Player controls */
.player-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-bottom: 16px;
}

.player-btn {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all var(--transition-fast);
}

.player-btn:hover {
  background: var(--bg-hover);
  transform: scale(1.05);
}

.player-btn:active {
  transform: scale(0.95);
}

.player-btn svg {
  width: 24px;
  height: 24px;
  fill: var(--text-primary);
}

/* Play button - main */
.player-btn.play-btn {
  width: 56px;
  height: 56px;
  background: var(--accent);
  margin: 0 8px;
}

.player-btn.play-btn:hover {
  background: var(--accent-hover);
  transform: scale(1.08);
}

.player-btn.play-btn svg {
  width: 28px;
  height: 28px;
  fill: #000;
}

/* Disabled state */
.player-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none !important;
}

/* Volume control */
.volume-container {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
}

.volume-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.volume-btn svg {
  width: 20px;
  height: 20px;
  fill: var(--text-secondary);
}

.volume-slider {
  flex: 1;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--bg-hover);
  border-radius: 2px;
  cursor: pointer;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: var(--text-primary);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: var(--shadow-button);
  transition: transform var(--transition-fast);
}

.volume-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  background: var(--text-primary);
  border-radius: 50%;
  border: none;
  cursor: pointer;
}

.volume-slider:hover::-webkit-slider-thumb {
  transform: scale(1.2);
}

/* Player action buttons */
.player-actions {
  display: flex;
  justify-content: center;
  gap: 8px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 16px;
  background: var(--bg-secondary);
  border-radius: 20px;
  font-size: 12px;
  color: var(--text-secondary);
  transition: all var(--transition-fast);
}

.action-btn:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.action-btn:active {
  transform: scale(0.95);
}

.action-btn.active {
  background: var(--accent-dim);
  color: var(--accent);
}

.action-btn svg {
  width: 16px;
  height: 16px;
  fill: currentColor;
}

/* Sleep timer button states */
.sleep-btn.active {
  background: rgba(255,152,0,0.15);
  color: #ff9800;
}

/* Sleep menu */
.sleep-menu {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 8px 0;
  min-width: 140px;
  box-shadow: var(--shadow-card);
  z-index: 10;
  margin-bottom: 8px;
}

.sleep-menu.visible {
  display: block;
  animation: fadeIn 0.15s ease;
}

.sleep-option {
  display: block;
  width: 100%;
  padding: 10px 16px;
  text-align: left;
  font-size: 14px;
  color: var(--text-secondary);
  transition: all var(--transition-fast);
}

.sleep-option:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

.sleep-option.active {
  color: var(--accent);
}

/* === MINI PLAYER === */
.mini-player {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-card);
  border-top: 1px solid var(--border-color);
  padding: 8px 16px;
  z-index: var(--z-mini-player);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}

.mini-player.visible {
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideUp 0.2s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.mini-player-info {
  flex: 1;
  min-width: 0;
}

.mini-now,
.next-up {
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
}

.mini-now {
  color: var(--text-primary);
  font-weight: 500;
}

.next-up {
  color: var(--text-muted);
  font-size: 11px;
}

.mini-play-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--accent);
  border-radius: 50%;
  flex-shrink: 0;
}

.mini-play-btn:active {
  transform: scale(0.95);
}

.mini-play-btn svg {
  width: 20px;
  height: 20px;
  fill: #000;
}

/* Mini progress */
.mini-progress {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--bg-hover);
}

.mini-progress-bar {
  height: 100%;
  background: var(--accent);
  width: 0%;
  transition: width 0.1s linear;
}

/* === BOTTOM SECTION === */
.bottom-section {
  padding: 24px 0;
  text-align: center;
}

/* Logo bottom */
.logo-bottom {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 16px;
}

.logo-bottom img {
  width: 32px;
  height: 32px;
  transition: filter 0.3s ease;
}

/* Pulsing animation for logo */
.logo-bottom.pulsing img {
  animation: logo-pulse 2s ease-in-out infinite;
}

@keyframes logo-pulse {
  0%, 100% {
    filter: drop-shadow(0 0 0 transparent);
  }
  50% {
    filter: drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 16px var(--accent));
  }
}

.logo-bottom span {
  font-size: 18px;
  font-weight: 600;
  background: linear-gradient(135deg, var(--accent), #17a34a);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Bottom icons */
.bottom-icons {
  display: flex;
  justify-content: center;
  gap: 8px;
}

.bottom-icon-btn {
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: var(--bg-card);
  transition: all var(--transition-fast);
}

.bottom-icon-btn:hover {
  background: var(--bg-hover);
}

.bottom-icon-btn:active {
  transform: scale(0.95);
}

.bottom-icon-btn svg {
  width: 20px;
  height: 20px;
  fill: var(--text-secondary);
  transition: fill var(--transition-fast);
}

.bottom-icon-btn:hover svg {
  fill: var(--text-primary);
}

/* Favorites with badge */
#favorites-btn {
  position: relative;
}

#favorites-btn.has-favorites svg {
  fill: #ff4081;
}

#fav-count {
  position: absolute;
  top: 4px;
  right: 4px;
  min-width: 16px;
  height: 16px;
  background: #ff4081;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 600;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
}

#fav-count:empty,
#fav-count.hidden {
  display: none;
}

/* === TOASTS === */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-card);
  color: var(--text-primary);
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  z-index: var(--z-toast);
  opacity: 0;
  transition: all var(--transition-slow);
  box-shadow: var(--shadow-card);
  border: 1px solid var(--border-color);
  max-width: 90%;
  text-align: center;
}

.toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.toast.toast-success {
  border-color: var(--accent);
}

.toast.toast-error {
  border-color: #ff4444;
}

/* === MODALS === */
.modal-bg {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: var(--z-modal);
  align-items: center;
  justify-content: center;
  padding: 20px;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

.modal-bg.visible {
  display: flex;
  animation: fadeIn 0.2s ease;
}

.modal-content {
  background: var(--bg-card);
  border-radius: 12px;
  width: 100%;
  max-width: 360px;
  max-height: 80vh;
  overflow-y: auto;
  animation: modalSlide 0.2s ease;
}

@keyframes modalSlide {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background var(--transition-fast);
}

.modal-close:hover {
  background: var(--bg-hover);
}

.modal-close svg {
  width: 20px;
  height: 20px;
  fill: var(--text-secondary);
}

.modal-body {
  padding: 20px;
}

/* Favorites modal */
#favorites-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.fav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg-secondary);
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  transition: background var(--transition-fast);
}

.fav-item:hover {
  background: var(--bg-hover);
}

.fav-cover {
  width: 48px;
  height: 48px;
  border-radius: 4px;
  object-fit: cover;
}

.fav-info {
  flex: 1;
  min-width: 0;
}

.fav-title {
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.fav-album {
  font-size: 12px;
  color: var(--text-muted);
}

.fav-remove {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all var(--transition-fast);
}

.fav-remove:hover {
  background: rgba(255,68,68,0.2);
}

.fav-remove svg {
  width: 18px;
  height: 18px;
  fill: var(--text-muted);
  transition: fill var(--transition-fast);
}

.fav-remove:hover svg {
  fill: #ff4444;
}

.favorites-empty {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
}

.favorites-empty svg {
  width: 48px;
  height: 48px;
  fill: var(--text-dark);
  margin-bottom: 12px;
}

/* Hotkeys modal */
.hotkeys-grid {
  display: grid;
  gap: 12px;
}

.hotkey-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.hotkey-key {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 32px;
  height: 28px;
  padding: 0 10px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  font-family: monospace;
}

.hotkey-desc {
  color: var(--text-secondary);
  font-size: 14px;
}

/* === ANIMATIONS === */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* === iOS SPECIFIC === */
@supports (-webkit-touch-callout: none) {
  body {
    min-height: -webkit-fill-available;
  }
  
  .mini-player {
    padding-bottom: calc(8px + env(safe-area-inset-bottom, 0));
  }
  
  .main-block {
    padding-bottom: calc(var(--bottom-padding) + env(safe-area-inset-bottom, 0));
  }
}

/* === MEDIA QUERIES === */

/* Small phones */
@media (max-width: 360px) {
  .main-block {
    padding: 0 12px var(--bottom-padding);
  }
  
  .player-block {
    padding: 16px 12px;
  }
  
  .player-btn {
    width: 44px;
    height: 44px;
  }
  
  .player-btn.play-btn {
    width: 52px;
    height: 52px;
  }
  
  .action-btn {
    padding: 8px 12px;
    font-size: 11px;
  }
}

/* Hide hotkeys on mobile */
@media (max-width: 768px) {
  #hotkeys-btn {
    display: none;
  }
}

/* Desktop enhancements */
@media (min-width: 769px) {
  .track-item:hover {
    background: var(--bg-hover);
  }
  
  .progress-bar,
  .volume-slider {
    cursor: pointer;
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

//=================================================
// FILE: /styles/modals.css
/* styles/modals.css - –ø—É—Å—Ç–æ–π, –≤—Å–µ —Å—Ç–∏–ª–∏ –≤ main.css */

