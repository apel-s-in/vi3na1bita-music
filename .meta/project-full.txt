–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.
- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).
- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  ```ts
  export function x() {}
  ```
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.
- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.
- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.
- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].
- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. 
- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.
- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.

–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: vi3na1bita-music
–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: https://github.com/apel-s-in/vi3na1bita-music
# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.
–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).

–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:
vi3na1bita-music/
‚îú‚îÄ‚îÄ .git/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ applypatch-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fsmonitor-watchman.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-update.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-applypatch.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-merge-commit.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-push.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-rebase.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-receive.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prepare-commit-msg.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ push-to-checkout.sample
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sendemail-validate.sample
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update.sample
‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exclude
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HEAD
‚îÇ   ‚îú‚îÄ‚îÄ objects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ info/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pack/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-150af10b948837649a53e7d65d970daf48046a2c.idx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ pack-150af10b948837649a53e7d65d970daf48046a2c.pack
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ pack-150af10b948837649a53e7d65d970daf48046a2c.rev
‚îÇ   ‚îú‚îÄ‚îÄ refs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ heads/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ remotes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ origin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ main
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tags/
‚îÇ   ‚îú‚îÄ‚îÄ config
‚îÇ   ‚îú‚îÄ‚îÄ config.worktree
‚îÇ   ‚îú‚îÄ‚îÄ description
‚îÇ   ‚îú‚îÄ‚îÄ FETCH_HEAD
‚îÇ   ‚îú‚îÄ‚îÄ HEAD
‚îÇ   ‚îî‚îÄ‚îÄ index
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ e2e.yml
‚îÇ       ‚îú‚îÄ‚îÄ generate-context.yml
‚îÇ       ‚îî‚îÄ‚îÄ validate.yml
‚îú‚îÄ‚îÄ .meta/
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ albums/
‚îÇ   ‚îú‚îÄ‚îÄ gallery/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 00-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-01.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-02.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-03.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 03-cover-04.webp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ news/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ thumbs/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ news-cover-02-thumb.jpg
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ news-cover-02-thumb.webp
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-01-baner.html
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.avif
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ news-cover-02.png
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ news-cover-02.webp
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ emoji/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ noto/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ animated/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cross_mark.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ loudspeaker.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ satellite_antenna.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sparkles.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ trophy.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ warning.json
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ white_check_mark.json
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ fallback/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cross_mark.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ loudspeaker.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ satellite_antenna.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sparkles.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ trophy.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ warning.webp
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ white_check_mark.webp
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ static/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ cross_mark.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ loudspeaker.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ satellite_antenna.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ sparkles.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ trophy.png
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ warning.png
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ white_check_mark.png
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ icons/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ apple-touch-icon.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-16.png
‚îÇ   ‚îú‚îÄ‚îÄ favicon-32.png
‚îÇ   ‚îú‚îÄ‚îÄ icon-192.png
‚îÇ   ‚îî‚îÄ‚îÄ icon-512.png
‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îú‚îÄ‚îÄ desktop/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@2x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@3x.png
‚îÇ   ‚îú‚îÄ‚îÄ icon_album/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-00@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-01@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-02@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-03@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@1x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album-news@2x.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-album+00@1x.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-album+00@2x.png
‚îÇ   ‚îú‚îÄ‚îÄ mobile/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo@1x.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo@2x.jpg
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îú‚îÄ‚îÄ bg.png
‚îÇ   ‚îú‚îÄ‚îÄ logo.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-01.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-02.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-03.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-04.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-21.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-22.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-23.png
‚îÇ   ‚îú‚îÄ‚îÄ prize-24.png
‚îÇ   ‚îú‚îÄ‚îÄ star.png
‚îÇ   ‚îî‚îÄ‚îÄ star2.png
‚îú‚îÄ‚îÄ news/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ news.json
‚îú‚îÄ‚îÄ performance/
‚îÇ   ‚îî‚îÄ‚îÄ rum.js
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ albums.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ downloads.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ player-ui.js
‚îÇ   ‚îú‚îÄ‚îÄ ci/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lint-sw.mjs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate-content.mjs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validate-manifest.mjs
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.spec.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ player.spec.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ favorites.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modals.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notify.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sleep.js
‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îî‚îÄ‚îÄ PlayerCore.js
‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îî‚îÄ‚îÄ main.css
‚îú‚îÄ‚îÄ albums.json
‚îú‚îÄ‚îÄ custom.json
‚îú‚îÄ‚îÄ generate-context.js
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ news.html
‚îî‚îÄ‚îÄ service-worker.js


–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: 2025-12-21 00:17:22 UTC
//=================================================
// FILE: /.github/workflows/e2e.yml
name: E2E smoke

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: npx -y playwright@1.48.2 install --with-deps

      - name: Start static server
        run: |
          npx -y http-server -p 4173 -c-1 . &
          echo $! > server.pid
          sleep 2

      - name: Run smoke tests
        env:
          BASE_URL: http://127.0.0.1:4173
        run: npx -y @playwright/test@1.48.2 scripts/e2e

      - name: Stop server
        if: always()
        run: kill $(cat server.pid) || true

//=================================================
// FILE: /.github/workflows/generate-context.yml
name: Generate .meta context

on:
  push:
    branches: [ main, master ]
    # –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤–æ—Ä–∫—Ñ–ª–æ—É –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤, –º–µ–Ω—è—é—â–∏—Ö —Ç–æ–ª—å–∫–æ .meta
    paths-ignore:
      - '.meta/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate .meta
        run: |
          node generate-context.js --mode=both --max-lines=20000
          ls -la .meta || true

      - name: Commit .meta
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: generate .meta context"
          branch: ${{ github.ref_name }}
          file_pattern: ".meta/**"
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

//=================================================
// FILE: /.github/workflows/validate.yml
name: Validate manifest and SW

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run manifest validator
        run: node scripts/ci/validate-manifest.mjs

      - name: Run SW linter
        run: node scripts/ci/lint-sw.mjs

      - name: Validate albums and galleries
        run: node scripts/ci/validate-content.mjs

  remote-validate:
    name: Remote content validate (informational)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Remote validate (warnings only)
        run: node scripts/ci/validate-content.mjs

//=================================================
// FILE: /albums.json
{
  "albums": [
    {
      "key": "mezhdu-zlom-i-dobrom",
      "title": "–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "base": "https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/"
    },
    {
      "key": "golos-dushi",
      "title": "–ì–æ–ª–æ—Å –î—É—à–∏",
      "base": "https://apel-s-in.github.io/vi3na1bita-golos-dushi/"
    },
    {
      "key": "odnazhdy-v-skazke",
      "title": "–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ",
      "base": "https://apel-s-in.github.io/vi3na1bita-odnazhdy-v-skazke/"
    },
    {
      "key": "krevetochka",
      "title": "–ö–†–ï–í–ï„ÉÑTOCHKA",
      "base": "https://apel-s-in.github.io/krevetochka/"
    }
  ]
}

//=================================================
// FILE: /albums/gallery/00/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-01.webp",
        "full": "albums/gallery/00/00-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/00/00-cover-02.webp",
        "full": "albums/gallery/00/00-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/01/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-01.webp",
        "full": "albums/gallery/01/01-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-02.webp",
        "full": "albums/gallery/01/01-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-03.webp",
        "full": "albums/gallery/01/01-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/01/01-cover-04.webp",
        "full": "albums/gallery/01/01-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/02/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-01.webp",
        "full": "albums/gallery/02/02-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-02.webp",
        "full": "albums/gallery/02/02-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-03.webp",
        "full": "albums/gallery/02/02-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/02/02-cover-04.webp",
        "full": "albums/gallery/02/02-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/03/index.json
{
  "items": [
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-01.webp",
        "full": "albums/gallery/03/03-cover-01.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-02.webp",
        "full": "albums/gallery/03/03-cover-02.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-03.webp",
        "full": "albums/gallery/03/03-cover-03.png"
      }
    },
    {
      "formats": {
        "webp": "albums/gallery/03/03-cover-04.webp",
        "full": "albums/gallery/03/03-cover-04.png"
      }
    }
  ]
}

//=================================================
// FILE: /albums/gallery/news/index.json
{
  "items": [
    { "type": "html", "src": "albums/gallery/news/news-01-baner.html" },
    {
      "formats": {
        "webp": "albums/gallery/news/news-cover-02.webp",
        "full": "albums/gallery/news/news-cover-02.png"
      }
    }
  ]
}

//=================================================
// FILE: /custom.json
{
  "rumEndpoint": "",
  "sw": {
    "mediaMaxCacheMB": 150,
    "nonRangeMaxStoreMB": 25,
    "nonRangeMaxStoreMBSlow": 10,
    "allowUnknownSize": false,
    "revalidateDays": 7
  },
  "items": [
    {
      "type": "ym",
      "title": "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
      "subtitle": "–Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–∞",
      "url": "https://music.yandex.ru/artist/24739002?utm_source=web&utm_medium=copy_link",
      "cover": ""
    },
    {
      "type": "tgPost",
      "title": "–°–≤–µ–∂–∏–π –ø–æ—Å—Ç –≤ Telegram",
      "url": "https://t.me/vitrina_razbita/28",
      "height": 480
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 3,
      "hash": "b8300406c5f33725de",
      "containerId": "vk_playlist_165137_3"
    },
    {
      "type": "vkPlaylist",
      "title": "–ê–ª—å–±–æ–º ¬´–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º¬ª (VK)",
      "ownerId": 165137,
      "playlistId": 2,
      "hash": "d70fba309dc0bea296",
      "containerId": "vk_playlist_165137_2"
    }
  ]
}

//=================================================
// FILE: /index.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ ‚Äî –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä">
  
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  
  <!-- Preload critical -->
  <link rel="preload" href="styles/main.css" as="style">
  <link rel="preload" href="img/logo.png" as="image">
  
  <link rel="stylesheet" href="styles/main.css">
  
  <!-- Howler.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js" defer></script>
</head>
<body>
  <!-- Splash -->
  <div id="splash" style="position:fixed;inset:0;background:#0a0a0a;display:flex;align-items:center;justify-content:center;z-index:9999">
    <img src="img/logo.png" alt="Loading" style="width:120px;animation:pulse 1.5s infinite">
  </div>
  <style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}</style>

  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <img src="img/logo.png" alt="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞" class="logo">
      <div class="header-actions">
        <button class="header-btn" id="sleep-timer-btn" title="–¢–∞–π–º–µ—Ä —Å–Ω–∞">
          ‚è∞
          <span id="sleep-timer-badge" style="display:none"></span>
        </button>
        <button class="header-btn" id="sysinfo-btn" title="–û —Å–∏—Å—Ç–µ–º–µ">‚ÑπÔ∏è</button>
        <button class="header-btn" id="install-btn" style="display:none" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">üì≤</button>
      </div>
    </header>

    <!-- Main -->
    <main class="main-content">
      <!-- Album Icons -->
      <section class="album-icons-section">
        <div id="album-icons" class="album-icons"></div>
      </section>

      <!-- Cover Gallery -->
      <section class="cover-section">
        <div id="cover-wrap">
          <div id="cover-slot">
            <img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false">
          </div>
          <button class="gallery-arrow" id="cover-gallery-arrow-left">‚Äπ</button>
          <button class="gallery-arrow" id="cover-gallery-arrow-right">‚Ä∫</button>
        </div>
      </section>

      <!-- Tracks -->
      <section class="tracks-section">
        <div class="album-header">
          <h2 id="album-title"></h2>
          <p id="album-artist"></p>
        </div>
        <div id="track-list"></div>
      </section>
    </main>

    <!-- Lyrics Panel -->
    <div id="lyrics-panel">
      <div id="lyrics-box"></div>
    </div>

    <!-- Player Bar -->
    <footer class="player-bar">
      <div class="player-track-info">
        <div id="track-title">–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</div>
        <div id="track-artist"></div>
      </div>

      <div class="progress-container">
        <span class="time" id="time-current">--:--</span>
        <div id="progress-bar">
          <div id="progress-fill"></div>
        </div>
        <span class="time" id="time-total">--:--</span>
      </div>

      <div class="player-controls">
        <button class="control-btn" id="shuffle-btn" title="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å">üîÄ</button>
        <button class="control-btn" id="prev-btn" title="–ù–∞–∑–∞–¥">‚èÆ</button>
        <button class="control-btn" id="play-pause-btn" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏">‚ñ∂</button>
        <button class="control-btn" id="next-btn" title="–í–ø–µ—Ä—ë–¥">‚è≠</button>
        <button class="control-btn" id="repeat-btn" title="–ü–æ–≤—Ç–æ—Ä">üîÅ</button>
        <button class="control-btn" id="favorite-btn" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">‚òÜ</button>
        <button class="control-btn" id="lyrics-toggle-btn" title="–¢–µ–∫—Å—Ç">üìú</button>
      </div>

      <div class="volume-container">
        <span id="volume-icon">üîä</span>
        <div id="volume-bar">
          <div id="volume-fill"></div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="scripts/core/config.js"></script>
  <script src="scripts/core/utils.js"></script>
  <script src="scripts/core/bootstrap.js"></script>
  <script src="src/PlayerCore.js"></script>
  <script src="scripts/ui/notify.js"></script>
  <script src="scripts/ui/favorites.js"></script>
  <script src="scripts/app/gallery.js"></script>
  <script src="scripts/app/albums.js"></script>
  <script src="scripts/app/player-ui.js"></script>
  <script src="scripts/app/background.js"></script>
  <script src="scripts/app.js"></script>
</body>
</html>

//=================================================
// FILE: /manifest.json
{
  "name": "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞",
  "short_name": "–í–∏—Ç—Ä–∏–Ω–∞",
  "description": "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä",
  "start_url": "./index.html",
  "display": "standalone",
  "orientation": "portrait",
  "theme_color": "#0a0a0a",
  "background_color": "#0a0a0a",
  "lang": "ru",
  "icons": [
    { "src": "icons/icon-72.png", "sizes": "72x72", "type": "image/png" },
    { "src": "icons/icon-96.png", "sizes": "96x96", "type": "image/png" },
    { "src": "icons/icon-128.png", "sizes": "128x128", "type": "image/png" },
    { "src": "icons/icon-144.png", "sizes": "144x144", "type": "image/png" },
    { "src": "icons/icon-152.png", "sizes": "152x152", "type": "image/png" },
    { "src": "icons/icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
    { "src": "icons/icon-384.png", "sizes": "384x384", "type": "image/png" },
    { "src": "icons/icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
  ],
  "categories": ["music", "entertainment"],
  "shortcuts": [
    {
      "name": "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
      "url": "./index.html?album=__favorites__",
      "icons": [{ "src": "icons/icon-96.png", "sizes": "96x96" }]
    }
  ]
}

//=================================================
// FILE: /news.html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0e15;
      --panel: #131a26;
      --text: #eaf2ff;
      --muted: #9db7dd;
      --accent: #4daaff;
      --danger: #E80100;
      --border: #23324a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 14px;
      background: var(--bg); color: var(--text);
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
    }
    .container { max-width: 760px; margin: 0 auto; }
    h1 { margin: 6px 0 16px; font-size: 22px; }
    .news-list { display: grid; gap: 14px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .date { color: var(--muted); font-size: 13px; margin-bottom: 8px; }
    .media { margin: 10px 0; }
    .media iframe, .media img, .media video {
      width: 100%; border: 0; border-radius: 8px; min-height: 220px; background: #0b0e15;
    }
    .card p { margin: 8px 0; line-height: 1.45; }
    .tags { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 12px; color: var(--accent); background: rgba(77,170,255,.12); border: 1px solid rgba(77,170,255,.25); padding: 4px 8px; border-radius: 999px; }
    .error { color: var(--danger); background: rgba(232,1,0,.1); border: 1px solid rgba(232,1,0,.2); padding: 10px; border-radius: 8px; }
    .loading { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ù–æ–≤–æ—Å—Ç–∏</h1>
    <div id="status" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="news" class="news-list"></div>
  </div>

  <script>
    async function loadNews() {
      const status = document.getElementById('status');
      const listEl = document.getElementById('news');
      try {
        const r = await fetch('./news/news.json', { cache: 'no-cache' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const items = Array.isArray(j.items) ? j.items : [];
        status.style.display = 'none';
        if (!items.length) {
          status.style.display = '';
          status.textContent = '–ü–æ–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç';
          return;
        }
        listEl.innerHTML = items.map(renderCard).join('');
      } catch (e) {
        status.className = 'error';
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏';
      }
    }
    function esc(s) { return String(s || '').replace(/[<>&'"]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&#39;','"':'&quot;'}[m])); }
    function renderCard(it) {
      const title = esc(it.title || '–ù–æ–≤–æ—Å—Ç—å');
      const date = esc(it.date || '');
      const text = esc(it.text || '');
      const tags = Array.isArray(it.tags) ? it.tags : [];
      let media = '';
      if (it.embedUrl) {
        media = `<div class="media"><iframe loading="lazy" src="${esc(it.embedUrl)}" allowfullscreen></iframe></div>`;
      } else if (it.image) {
        media = `<div class="media"><img loading="lazy" src="${esc(it.image)}" alt=""></div>`;
      } else if (it.video) {
        media = `<div class="media"><video controls preload="metadata" src="${esc(it.video)}"></video></div>`;
      }
      return `<article class="card">
        <h2>${title}</h2>
        ${date ? `<div class="date">${date}</div>` : ''}
        ${media}
        ${text ? `<p>${text}</p>` : ''}
        ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join('')}</div>` : ''}
      </article>`;
    }
    loadNews();
  </script>
</body>
</html>

//=================================================
// FILE: /service-worker.js
// service-worker.js ‚Äî –ï–¥–∏–Ω—ã–π Service Worker v8.1.0
const SW_VERSION = '8.1.0';
const CACHE_NAME = `vitrina-v${SW_VERSION}`;

const STATIC_ASSETS = [
  './',
  './index.html',
  './manifest.json',
  './styles/main.css',
  './img/logo.png',
  './img/star.png',
  './img/star2.png',
  './icons/favicon-32.png',
  './icons/apple-touch-icon.png',
  './scripts/core/bootstrap.js',
  './scripts/core/config.js',
  './scripts/core/utils.js',
  './scripts/app/background.js',
  './scripts/app/player-ui.js',
  './scripts/app/gallery.js',
  './scripts/app/albums.js',
  './scripts/app/downloads.js',
  './scripts/ui/notify.js',
  './scripts/ui/favorites.js',
  './scripts/ui/sleep.js',
  './scripts/ui/modals.js',
  './scripts/app.js',
  './src/PlayerCore.js'
];

self.addEventListener('install', e => {
  e.waitUntil(
    caches.open(CACHE_NAME)
      .then(c => c.addAll(STATIC_ASSETS))
      .then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys => 
      Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))
    ).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', e => {
  if (e.request.method !== 'GET') return;
  
  const url = new URL(e.request.url);
  
  // –ê—É–¥–∏–æ ‚Äî –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –±–µ–∑ –∫—ç—à–∞
  if (/\.(mp3|ogg|m4a|flac)$/i.test(url.pathname)) {
    e.respondWith(fetch(e.request));
    return;
  }
  
  // –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî cache-first —Å fallback –Ω–∞ —Å–µ—Ç—å
  e.respondWith(
    caches.match(e.request).then(r => {
      if (r) return r;
      
      return fetch(e.request).then(res => {
        if (res.ok && res.type === 'basic') {
          const clone = res.clone();
          caches.open(CACHE_NAME).then(c => c.put(e.request, clone));
        }
        return res;
      });
    })
  );
});

self.addEventListener('message', e => {
  const { type } = e.data || {};
  
  if (type === 'GET_SW_VERSION' && e.ports && e.ports[0]) {
    e.ports[0].postMessage({ version: SW_VERSION });
  } else if (type === 'SKIP_WAITING') {
    self.skipWaiting();
  }
});

//=================================================
// FILE: /performance/rum.js
;(function(){
  // –ù–µ–±–æ–ª–µ–∑–Ω–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞: —á—Ç–æ–±—ã <script src="./performance/rum.js"> –Ω–µ –¥–∞–≤–∞–ª 404
  // –∏ –Ω–µ –ª–æ–º–∞–ª –º–µ—Ç—Ä–∏–∫–∏. –ï—Å–ª–∏ –≤ custom.json –ø–æ—è–≤–∏—Ç—Å—è endpoint ‚Äî –≤–∞—à –∫–æ–¥ –≤ index.html
  // –≤—ã–∑–æ–≤–µ—Ç initRUM(...) –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏.
  if (typeof window.initRUM !== 'function') {
    window.initRUM = function initRUM() { /* no-op */ };
  }
})();

//=================================================
// FILE: /scripts/app.js
// scripts/app.js ‚Äî –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
(function() {
  'use strict';

  const VERSION = window.APP_CONFIG?.APP_VERSION || '8.1.0';

  // ==================== –õ–ï–ù–ò–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–£–õ–ï–ô ====================
  const lazyModules = {
    modals: { loaded: false, path: './scripts/ui/modals.js' },
    sleep: { loaded: false, path: './scripts/ui/sleep.js' }
  };

  async function loadModule(name) {
    const mod = lazyModules[name];
    if (!mod || mod.loaded) return;
    
    try {
      const script = document.createElement('script');
      script.src = mod.path;
      await new Promise((resolve, reject) => {
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
      mod.loaded = true;
      console.log(`‚úÖ Lazy loaded: ${name}`);
    } catch (e) {
      console.error(`‚ùå Failed to load: ${name}`, e);
    }
  }

  // –ü—Ä–æ–∫—Å–∏ –¥–ª—è –ª–µ–Ω–∏–≤—ã—Ö –º–æ–¥—É–ª–µ–π
  window.LyricsModal = {
    show: async () => {
      await loadModule('modals');
      window.Modals?.showLyrics?.();
    }
  };

  window.SleepTimer = window.SleepTimer || {
    show: async () => {
      await loadModule('sleep');
      window.SleepTimer?.show?.();
    }
  };

  // ==================== SERVICE WORKER ====================
  async function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) return;

    try {
      const reg = await navigator.serviceWorker.register('./service-worker.js');
      console.log('‚úÖ SW registered');

      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        newWorker?.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            showUpdateNotification();
          }
        });
      });
    } catch (e) {
      console.error('‚ùå SW registration failed:', e);
    }
  }

  function showUpdateNotification() {
    const notify = window.NotificationSystem;
    if (notify) {
      notify.info('–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 10000);
    }
  }

  // ==================== PWA INSTALL ====================
  let deferredPrompt = null;

  function initPWAInstall() {
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallButton();
    });

    window.addEventListener('appinstalled', () => {
      deferredPrompt = null;
      hideInstallButton();
      window.NotificationSystem?.success?.('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
    });
  }

  function showInstallButton() {
    const btn = document.getElementById('install-btn');
    if (btn) btn.style.display = '';
    btn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('Install prompt outcome:', outcome);
      deferredPrompt = null;
    });
  }

  function hideInstallButton() {
    const btn = document.getElementById('install-btn');
    if (btn) btn.style.display = 'none';
  }

  // ==================== ONLINE/OFFLINE ====================
  function initNetworkStatus() {
    const updateStatus = () => {
      document.body.classList.toggle('offline', !navigator.onLine);
      if (!navigator.onLine) {
        window.NotificationSystem?.warning?.('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
      }
    };

    window.addEventListener('online', () => {
      document.body.classList.remove('offline');
      window.NotificationSystem?.success?.('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    });

    window.addEventListener('offline', updateStatus);
    updateStatus();
  }

  // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
  async function init() {
    console.log(`üéµ –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ v${VERSION}`);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
    window.FavoritesManager?.initialize?.();
    window.GalleryManager?.initialize?.();
    window.AlbumsManager?.initialize?.();

    // Service Worker
    await registerServiceWorker();

    // PWA
    initPWAInstall();
    initNetworkStatus();

    // –ü—Ä–µ–ª–æ–∞–¥ –º–æ–¥–∞–ª–æ–∫ –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
    document.addEventListener('click', () => {
      loadModule('modals');
      loadModule('sleep');
    }, { once: true });

    // –°–∫—Ä—ã—Ç—å —Å–ø–ª—ç—à
    setTimeout(() => {
      const splash = document.getElementById('splash');
      if (splash) {
        splash.style.opacity = '0';
        setTimeout(() => splash.remove(), 300);
      }
    }, 500);

    console.log('‚úÖ App initialized');
  }

  // ==================== –ó–ê–ü–£–°–ö ====================
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
  window.App = {
    version: VERSION,
    loadModule
  };
})();

//=================================================
// FILE: /scripts/app/albums.js
// scripts/app/albums.js ‚Äî –ú–µ–Ω–µ–¥–∂–µ—Ä –∞–ª—å–±–æ–º–æ–≤
(function() {
  'use strict';

  const $ = id => document.getElementById(id);
  const escHtml = s => { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; };

  const state = {
    currentAlbum: null,
    albumConfig: null,
    tracks: []
  };

  // ==================== –†–ï–ù–î–ï–†–ò–ù–ì –ò–ö–û–ù–û–ö –ê–õ–¨–ë–û–ú–û–í ====================
  function renderAlbumIcons() {
    const container = $('album-icons');
    if (!container) return;

    const albums = window.APP_CONFIG?.ICON_ALBUMS_ORDER || [];
    container.innerHTML = albums.map(a => `
      <div class="album-icon-item" data-key="${escHtml(a.key)}" title="${escHtml(a.title)}">
        <img src="${escHtml(a.icon)}" alt="${escHtml(a.title)}" loading="lazy" draggable="false">
        <div class="album-icon-title">${escHtml(a.title)}</div>
      </div>
    `).join('');

    container.addEventListener('click', e => {
      const item = e.target.closest('.album-icon-item');
      if (item?.dataset.key) loadAlbum(item.dataset.key);
    });
  }

  // ==================== –ó–ê–ì–†–£–ó–ö–ê –ê–õ–¨–ë–û–ú–ê ====================
  async function loadAlbum(key) {
    if (!key) return;

    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã
    if (key === '__favorites__') {
      await loadFavoritesAlbum();
      return;
    }

    if (key === '__reliz__') {
      await loadRelizAlbum();
      return;
    }

    // –û–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º
    const meta = (window.albumsIndex || []).find(a => a.key === key);
    if (!meta?.base) {
      window.NotificationSystem?.error?.('–ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    try {
      const base = meta.base.endsWith('/') ? meta.base : `${meta.base}/`;
      const r = await fetch(`${base}config.json`, { cache: 'no-cache' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      
      const cfg = await r.json();
      state.currentAlbum = key;
      state.albumConfig = cfg;
      state.tracks = (cfg.tracks || []).map((t, i) => ({
        ...t,
        index: i,
        albumKey: key,
        audio: t.audio ? new URL(t.audio, base).toString() : null,
        lyrics: t.lyrics ? new URL(t.lyrics, base).toString() : null,
        fulltext: t.fulltext ? new URL(t.fulltext, base).toString() : null,
        cover: cfg.cover ? new URL(cfg.cover, base).toString() : 'img/logo.png',
        artist: t.artist || cfg.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: cfg.albumName || cfg.title || key
      }));

      renderTrackList();
      window.GalleryManager?.loadGallery?.(key);
      updateAlbumHeader(cfg);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π–ª–∏—Å—Ç –≤ –ø–ª–µ–µ—Ä–µ
      window.playerCore?.setPlaylist?.(state.tracks);
      
      console.log(`‚úÖ Album loaded: ${key}, ${state.tracks.length} tracks`);
    } catch (e) {
      console.error('Album load error:', e);
      window.NotificationSystem?.error?.('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–∞');
    }
  }

  // ==================== –ò–ó–ë–†–ê–ù–ù–û–ï ====================
  async function loadFavoritesAlbum() {
    state.currentAlbum = '__favorites__';
    state.albumConfig = { albumName: '‚≠ê –ò–ó–ë–†–ê–ù–ù–û–ï ‚≠ê', artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞' };

    try {
      const model = await window.buildFavoritesRefsModel?.() || [];
      state.tracks = model.filter(t => t.__active).map((t, i) => ({
        ...t,
        index: i,
        albumKey: t.__a,
        cover: t.__cover || 'img/logo.png',
        artist: t.__artist,
        album: t.__album
      }));

      renderFavoritesTrackList();
      window.GalleryManager?.clear?.();
      updateAlbumHeader(state.albumConfig);
      window.playerCore?.setPlaylist?.(state.tracks);
    } catch (e) {
      console.error('Favorites load error:', e);
      state.tracks = [];
      renderFavoritesTrackList();
    }
  }

  // ==================== –†–ï–õ–ò–ó–´/–ù–û–í–û–°–¢–ò ====================
  async function loadRelizAlbum() {
    state.currentAlbum = '__reliz__';
    state.albumConfig = { albumName: '–ù–û–í–û–°–¢–ò', artist: '' };
    state.tracks = [];

    try {
      const r = await fetch('./albums/news/news.json', { cache: 'no-cache' });
      if (r.ok) {
        const data = await r.json();
        renderNewsContent(data);
      } else {
        renderNewsContent({ items: [] });
      }
    } catch {
      renderNewsContent({ items: [] });
    }

    window.GalleryManager?.loadGallery?.('__reliz__');
    updateAlbumHeader(state.albumConfig);
  }

  // ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================
  function renderTrackList() {
    const container = $('track-list');
    if (!container) return;

    if (!state.tracks.length) {
      container.innerHTML = '<div class="empty-message">–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤</div>';
      return;
    }

    container.innerHTML = state.tracks.map((t, i) => {
      const isFav = window.FavoritesManager?.isFavorite?.(t.albumKey, t.uid);
      return `
        <div class="track-item" data-index="${i}" data-uid="${escHtml(t.uid)}">
          <div class="track-num">${i + 1}</div>
          <div class="track-info">
            <div class="track-title">${escHtml(t.title)}</div>
            <div class="track-artist">${escHtml(t.artist)}</div>
          </div>
          <button class="track-fav-btn ${isFav ? 'active' : ''}" data-uid="${escHtml(t.uid)}">${isFav ? '‚≠ê' : '‚òÜ'}</button>
        </div>
      `;
    }).join('');

    bindTrackListEvents(container);
  }

  function renderFavoritesTrackList() {
    const container = $('track-list');
    if (!container) return;

    if (!state.tracks.length) {
      container.innerHTML = '<div class="empty-message">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ.<br>–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–µ–∫–∏, –Ω–∞–∂–∞–≤ ‚òÜ</div>';
      return;
    }

    container.innerHTML = state.tracks.map((t, i) => `
      <div class="track-item" data-index="${i}" data-uid="${escHtml(t.uid)}" data-album="${escHtml(t.albumKey)}" id="fav_${escHtml(t.albumKey)}_${escHtml(t.uid)}">
        <div class="track-num">${i + 1}</div>
        <div class="track-info">
          <div class="track-title">${escHtml(t.title)}</div>
          <div class="track-artist">${escHtml(t.__album || t.artist)}</div>
        </div>
        <button class="track-fav-btn active" data-uid="${escHtml(t.uid)}" data-album="${escHtml(t.albumKey)}">‚≠ê</button>
      </div>
    `).join('');

    bindFavoritesEvents(container);
  }

  function renderNewsContent(data) {
    const container = $('track-list');
    if (!container) return;

    const items = data?.items || [];
    if (!items.length) {
      container.innerHTML = '<div class="empty-message">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π</div>';
      return;
    }

    container.innerHTML = items.map(item => `
      <div class="news-item">
        <div class="news-date">${escHtml(item.date || '')}</div>
        <div class="news-title">${escHtml(item.title || '')}</div>
        <div class="news-text">${escHtml(item.text || '')}</div>
      </div>
    `).join('');
  }

  function updateAlbumHeader(cfg) {
    const title = $('album-title');
    const artist = $('album-artist');
    if (title) title.textContent = cfg?.albumName || cfg?.title || '';
    if (artist) artist.textContent = cfg?.artist || '';
  }

  // ==================== –°–û–ë–´–¢–ò–Ø ====================
  function bindTrackListEvents(container) {
    container.addEventListener('click', e => {
      // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      const favBtn = e.target.closest('.track-fav-btn');
      if (favBtn) {
        e.stopPropagation();
        const uid = favBtn.dataset.uid;
        if (uid && state.currentAlbum) {
          window.FavoritesManager?.toggleLike?.(state.currentAlbum, uid);
          const isFav = window.FavoritesManager?.isFavorite?.(state.currentAlbum, uid);
          favBtn.textContent = isFav ? '‚≠ê' : '‚òÜ';
          favBtn.classList.toggle('active', isFav);
        }
        return;
      }

      // –ö–ª–∏–∫ –ø–æ —Ç—Ä–µ–∫—É
      const item = e.target.closest('.track-item');
      if (item) {
        const idx = parseInt(item.dataset.index);
        if (!isNaN(idx) && state.tracks[idx]) {
          window.playerCore?.playTrack?.(idx);
        }
      }
    });
  }

  function bindFavoritesEvents(container) {
    container.addEventListener('click', e => {
      const favBtn = e.target.closest('.track-fav-btn');
      if (favBtn) {
        e.stopPropagation();
        const uid = favBtn.dataset.uid;
        const albumKey = favBtn.dataset.album;
        const item = favBtn.closest('.track-item');
        const title = item?.querySelector('.track-title')?.textContent || '–¢—Ä–µ–∫';

        window.FavoritesData?.showFavoritesDeleteConfirm?.({
          albumKey, uid, title,
          onDeleted: () => loadFavoritesAlbum()
        });
        return;
      }

      const item = e.target.closest('.track-item');
      if (item) {
        const idx = parseInt(item.dataset.index);
        if (!isNaN(idx) && state.tracks[idx]) {
          window.playerCore?.playTrack?.(idx);
        }
      }
    });
  }

  // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ó–ë–†–ê–ù–ù–û–ì–û ====================
  function onFavoritesChanged(e) {
    if (state.currentAlbum === '__favorites__') {
      loadFavoritesAlbum();
    } else {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Ç–µ–∫—É—â–µ–º —Å–ø–∏—Å–∫–µ
      const { albumKey, uid, liked } = e.detail || {};
      if (albumKey === state.currentAlbum) {
        const btn = document.querySelector(`.track-fav-btn[data-uid="${uid}"]`);
        if (btn) {
          btn.textContent = liked ? '‚≠ê' : '‚òÜ';
          btn.classList.toggle('active', liked);
        }
      }
    }
  }

  // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
  function initialize() {
    renderAlbumIcons();

    window.addEventListener('favorites:changed', onFavoritesChanged);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –∞–ª—å–±–æ–º
    const firstAlbum = window.APP_CONFIG?.ICON_ALBUMS_ORDER?.[0]?.key;
    if (firstAlbum) {
      setTimeout(() => loadAlbum(firstAlbum), 100);
    }

    console.log('‚úÖ AlbumsManager initialized');
  }

  // ==================== –≠–ö–°–ü–û–†–¢ ====================
  window.AlbumsManager = {
    initialize,
    loadAlbum,
    getCurrentAlbum: () => state.currentAlbum,
    getTracks: () => state.tracks,
    getConfig: () => state.albumConfig
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
})();

//=================================================
// FILE: /scripts/app/background.js
// scripts/app/background.js ‚Äî –§–æ–Ω–æ–≤–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
(function() {
  'use strict';

  let silentAudio = null;
  let wakeLock = null;
  let isBackgroundMode = false;

  // ==================== SILENT AUDIO (iOS) ====================
  function initSilentAudio() {
    if (!/iPad|iPhone|iPod/.test(navigator.userAgent)) return;

    silentAudio = document.createElement('audio');
    silentAudio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYNbPH/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYNbPH/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
    silentAudio.loop = true;
    silentAudio.volume = 0.001;
    silentAudio.muted = false;
    silentAudio.playsInline = true;
    silentAudio.setAttribute('playsinline', '');
  }

  function playSilentAudio() {
    if (!silentAudio) return;
    silentAudio.play().catch(() => {});
  }

  function pauseSilentAudio() {
    if (!silentAudio) return;
    silentAudio.pause();
  }

  // ==================== WAKE LOCK ====================
  async function requestWakeLock() {
    if (!('wakeLock' in navigator)) return;

    try {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', () => {
        wakeLock = null;
      });
    } catch (e) {
      console.warn('Wake Lock failed:', e);
    }
  }

  function releaseWakeLock() {
    wakeLock?.release();
    wakeLock = null;
  }

  // ==================== VISIBILITY HANDLING ====================
  function handleVisibilityChange() {
    isBackgroundMode = document.hidden;

    if (document.hidden) {
      // –£—à–ª–∏ –≤ —Ñ–æ–Ω
      if (window.playerCore?.isPlaying?.()) {
        playSilentAudio();
        requestWakeLock();
      }
    } else {
      // –í–µ—Ä–Ω—É–ª–∏—Å—å
      pauseSilentAudio();
      releaseWakeLock();
    }
  }

  // ==================== PLAYER EVENTS ====================
  function subscribeToPlayer() {
    const pc = window.playerCore;
    if (!pc?.on) return;

    pc.on({
      onPlay: () => {
        if (isBackgroundMode) {
          playSilentAudio();
          requestWakeLock();
        }
      },
      onPause: () => {
        pauseSilentAudio();
        releaseWakeLock();
      },
      onStop: () => {
        pauseSilentAudio();
        releaseWakeLock();
      }
    });
  }

  // ==================== AUDIO INTERRUPTION (iOS) ====================
  function handleAudioInterruption() {
    if (!window.Howler) return;

    // iOS audio session interruption
    document.addEventListener('pause', () => {
      // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    }, false);

    document.addEventListener('resume', () => {
      // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∞—É–¥–∏–æ
      if (window.Howler.ctx?.state === 'interrupted') {
        window.Howler.ctx.resume();
      }
    }, false);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
    if (window.Howler.ctx) {
      window.Howler.ctx.addEventListener('statechange', () => {
        if (window.Howler.ctx.state === 'interrupted') {
          // AudioContext –±—ã–ª –ø—Ä–µ—Ä–≤–∞–Ω
          console.log('AudioContext interrupted');
        } else if (window.Howler.ctx.state === 'running') {
          // AudioContext –≤–æ–∑–æ–±–Ω–æ–≤–ª—ë–Ω
          console.log('AudioContext resumed');
        }
      });
    }
  }

  // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
  function initialize() {
    initSilentAudio();
    document.addEventListener('visibilitychange', handleVisibilityChange);

    // –ü–æ–¥–ø–∏—Å–∫–∞ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º
    const trySubscribe = () => {
      if (window.playerCore) {
        subscribeToPlayer();
        handleAudioInterruption();
      } else {
        setTimeout(trySubscribe, 100);
      }
    };
    trySubscribe();

    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', () => {
      releaseWakeLock();
      pauseSilentAudio();
    });

    console.log('‚úÖ BackgroundManager initialized');
  }

  // ==================== –≠–ö–°–ü–û–†–¢ ====================
  window.BackgroundManager = {
    initialize,
    requestWakeLock,
    releaseWakeLock,
    get isBackgroundMode() { return isBackgroundMode; }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
})();

//=================================================
// FILE: /scripts/app/downloads.js
// scripts/app/downloads.js ‚Äî –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–≥—Ä—É–∑–æ–∫
(function() {
  'use strict';

  const $ = id => document.getElementById(id);
  const escHtml = s => { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; };

  const state = {
    queue: [],
    isDownloading: false,
    abortController: null
  };

  // ==================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï –¢–†–ï–ö–ê ====================
  async function downloadTrack(track) {
    if (!track?.audio) {
      window.NotificationSystem?.error?.('–ê—É–¥–∏–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
      return false;
    }

    try {
      window.NotificationSystem?.info?.(`–ó–∞–≥—Ä—É–∑–∫–∞: ${track.title}`);
      
      state.abortController = new AbortController();
      const response = await fetch(track.audio, { 
        signal: state.abortController.signal,
        cache: 'force-cache'
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `${sanitizeFilename(track.title)}.mp3`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      
      window.NotificationSystem?.success?.(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${track.title}`);
      return true;
    } catch (e) {
      if (e.name === 'AbortError') {
        window.NotificationSystem?.warning?.('–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
      } else {
        console.error('Download error:', e);
        window.NotificationSystem?.error?.('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
      }
      return false;
    } finally {
      state.abortController = null;
    }
  }

  function sanitizeFilename(name) {
    return (name || 'track')
      .replace(/[<>:"/\\|?*]/g, '')
      .replace(/\s+/g, '_')
      .substring(0, 100);
  }

  // ==================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï –ê–õ–¨–ë–û–ú–ê (ZIP) ====================
  async function downloadAlbum(albumKey) {
    const tracks = window.AlbumsManager?.getTracks?.() || [];
    const config = window.AlbumsManager?.getConfig?.();
    
    if (!tracks.length) {
      window.NotificationSystem?.warning?.('–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ JSZip
    if (typeof JSZip === 'undefined') {
      // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å
      try {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
      } catch {
        window.NotificationSystem?.error?.('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ö–∏–≤–∞—Ç–æ—Ä');
        return;
      }
    }

    const zip = new JSZip();
    const albumName = sanitizeFilename(config?.albumName || albumKey);
    let successCount = 0;

    window.NotificationSystem?.info?.(`–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞–ª—å–±–æ–º–∞: ${tracks.length} —Ç—Ä–µ–∫–æ–≤...`);

    for (let i = 0; i < tracks.length; i++) {
      const track = tracks[i];
      if (!track?.audio) continue;

      try {
        const response = await fetch(track.audio, { cache: 'force-cache' });
        if (!response.ok) continue;
        
        const blob = await response.blob();
        const filename = `${String(i + 1).padStart(2, '0')}_${sanitizeFilename(track.title)}.mp3`;
        zip.file(filename, blob);
        successCount++;
      } catch (e) {
        console.warn(`Failed to add track: ${track.title}`, e);
      }
    }

    if (successCount === 0) {
      window.NotificationSystem?.error?.('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫–∏');
      return;
    }

    try {
      window.NotificationSystem?.info?.('–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...');
      const content = await zip.generateAsync({ 
        type: 'blob',
        compression: 'DEFLATE',
        compressionOptions: { level: 6 }
      });

      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${albumName}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      
      window.NotificationSystem?.success?.(`–ê–ª—å–±–æ–º –∑–∞–≥—Ä—É–∂–µ–Ω: ${successCount} —Ç—Ä–µ–∫–æ–≤`);
    } catch (e) {
      console.error('ZIP creation error:', e);
      window.NotificationSystem?.error?.('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞');
    }
  }

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // ==================== –û–¢–ú–ï–ù–ê ====================
  function cancelDownload() {
    state.abortController?.abort();
  }

  // ==================== UI ====================
  function showDownloadModal(track) {
    const html = `
      <div class="modal-feedback" style="max-width:400px">
        <button class="bigclose">√ó</button>
        <h2>–°–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫</h2>
        <p style="margin:16px 0"><strong>${escHtml(track?.title || '–¢—Ä–µ–∫')}</strong></p>
        <p style="color:#888;font-size:14px">${escHtml(track?.artist || '')}</p>
        <div style="display:flex;gap:12px;margin-top:24px;justify-content:center">
          <button class="modal-action-btn" id="dl-confirm">–°–∫–∞—á–∞—Ç—å</button>
          <button class="modal-action-btn" style="background:#444" id="dl-cancel">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    `;

    const modal = window.Utils?.createModal?.(html);
    if (!modal) return;

    modal.querySelector('#dl-confirm')?.addEventListener('click', () => {
      modal.remove();
      downloadTrack(track);
    });

    modal.querySelector('#dl-cancel')?.addEventListener('click', () => modal.remove());
  }

  // ==================== –≠–ö–°–ü–û–†–¢ ====================
  window.DownloadsManager = {
    downloadTrack,
    downloadAlbum,
    cancelDownload,
    showDownloadModal
  };
})();

//=================================================
// FILE: /scripts/app/gallery.js
// scripts/app/gallery.js ‚Äî –ì–∞–ª–µ—Ä–µ—è –æ–±–ª–æ–∂–µ–∫
(function() {
  'use strict';

  class GalleryManager {
    constructor() {
      this.items = [];
      this.idx = 0;
      this.interval = null;
      this.lock = false;
      this.prefetched = new Set();
      this.loader = null;
      this.MAP = null;
      this.IDS = new Set(['00', '01', '02', '03', 'news']);
      this.BASE = './albums/gallery/';
    }

    initialize() {
      // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
      this.MAP = window.APP_CONFIG?.GALLERY_MAP || {
        'krevetochka': '00',
        'mezhdu-zlom-i-dobrom': '01',
        'golos-dushi': '02',
        'odnazhdy-v-skazke': '03',
        '__reliz__': 'news'
      };
      this.BASE = window.APP_CONFIG?.GALLERY_BASE || './albums/gallery/';

      const leftArrow = document.getElementById('cover-gallery-arrow-left');
      const rightArrow = document.getElementById('cover-gallery-arrow-right');
      
      if (leftArrow) {
        leftArrow.addEventListener('click', () => {
          if (this.items.length) {
            this.render(this.idx - 1);
            this.restart();
          }
        });
      }
      
      if (rightArrow) {
        rightArrow.addEventListener('click', () => {
          if (this.items.length) {
            this.render(this.idx + 1);
            this.restart();
          }
        });
      }
      
      const wrap = document.getElementById('cover-wrap');
      if (wrap) {
        let sx = null;
        wrap.addEventListener('touchstart', e => {
          sx = e.touches[0].clientX;
        }, { passive: true });
        
        wrap.addEventListener('touchend', e => {
          if (sx !== null) {
            const dx = e.changedTouches[0].clientX - sx;
            if (Math.abs(dx) > 50) {
              this.render(dx > 0 ? this.idx - 1 : this.idx + 1);
              this.restart();
            }
            sx = null;
          }
        }, { passive: true });
      }
      
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          this.stop();
        } else if (this.items.length > 1) {
          this.start();
        }
      });
      
      console.log('‚úÖ GalleryManager initialized');
    }

    getId(key) {
      if (!key || key === '__favorites__') return null;
      const mapped = this.MAP[key];
      return this.IDS.has(mapped) ? mapped : null;
    }

    async loadGallery(key) {
      const id = this.getId(key);
      const slot = document.getElementById('cover-slot');
      
      if (!id) {
        this.items = [];
        this.idx = 0;
        this.updateNav();
        if (slot) {
          slot.innerHTML = '<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">';
        }
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à 404
      let cache404 = {};
      try {
        cache404 = JSON.parse(sessionStorage.getItem('gallery_404') || '{}');
      } catch (e) {}
      
      if (cache404[id]) {
        this.items = [];
        this.idx = 0;
        this.updateNav();
        if (slot) {
          slot.innerHTML = '<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">';
        }
        return;
      }
      
      try {
        const dir = `${this.BASE}${id}/`;
        const r = await fetch(`${dir}index.json`, { cache: 'force-cache' });
        
        if (!r.ok) {
          if (r.status === 404) {
            cache404[id] = 1;
            try {
              sessionStorage.setItem('gallery_404', JSON.stringify(cache404));
            } catch (e) {}
          }
          throw new Error(`HTTP ${r.status}`);
        }
        
        const d = await r.json();
        const raw = Array.isArray(d.items) ? d.items : (Array.isArray(d) ? d : []);
        this.items = raw.map(it => this.norm(it, dir)).filter(Boolean);
        this.idx = 0;
        
        if (this.items.length) {
          this.render(0);
          this.updateNav();
          this.start();
        }
        
        console.log(`‚úÖ Gallery: ${this.items.length} items`);
      } catch (e) {
        console.warn('Gallery load error:', e);
        this.items = [];
        this.idx = 0;
        this.updateNav();
        if (slot) {
          slot.innerHTML = '<img src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false" loading="lazy">';
        }
      }
    }

    norm(raw, base) {
      if (!raw) return null;
      
      const abs = (p) => {
        if (!p) return null;
        const s = String(p).replace(/^\.?\//, '');
        if (/^https?:\/\//i.test(s)) return s;
        if (/^(albums|img|icons|assets)\//i.test(s)) return `./${s}`;
        return base + s;
      };
      
      if (typeof raw === 'string') {
        return {
          type: /\.html(\?|#|$)/i.test(raw) ? 'html' : 'img',
          src: abs(raw),
          formats: null
        };
      }
      
      const type = raw.type?.toLowerCase() === 'html' ? 'html' : 'img';
      
      if (type === 'html') {
        return { type: 'html', src: abs(raw.src || ''), formats: null };
      }
      
      const f = {
        webp: abs(raw.formats?.webp),
        full: abs(raw.formats?.full || raw.src),
        thumb: abs(raw.formats?.thumb)
      };
      
      return {
        type: 'img',
        src: f.full || abs(raw.src),
        formats: f
      };
    }

    render(i) {
      if (this.lock || !this.items.length) return;
      
      this.lock = true;
      this.idx = (i + this.items.length) % this.items.length;
      
      const it = this.items[this.idx];
      const slot = document.getElementById('cover-slot');
      
      if (!slot || !it) {
        this.lock = false;
        return;
      }
      
      if (this.loader) {
        this.loader.onload = null;
        this.loader.onerror = null;
        this.loader = null;
      }
      
      if (it.type === 'html') {
        const iframe = document.createElement('iframe');
        iframe.setAttribute('sandbox', 'allow-scripts allow-popups allow-forms');
        iframe.setAttribute('referrerpolicy', 'no-referrer');
        iframe.loading = 'lazy';
        iframe.src = it.src;
        this.clearSlot(slot);
        slot.appendChild(iframe);
      } else {
        const img = new Image();
        this.loader = img;
        const src = it.formats?.webp || it.formats?.full || it.src;
        
        img.onload = () => {
          if (this.loader !== img) return;
          
          const pic = document.createElement('picture');
          
          if (it.formats?.webp) {
            const s = document.createElement('source');
            s.type = 'image/webp';
            s.srcset = it.formats.webp;
            pic.appendChild(s);
          }
          
          const di = document.createElement('img');
          di.src = src;
          di.alt = '–û–±–ª–æ–∂–∫–∞';
          di.style.cssText = 'opacity:0;transition:opacity .15s';
          pic.appendChild(di);
          
          this.clearSlot(slot);
          slot.appendChild(pic);
          
          requestAnimationFrame(() => {
            di.style.opacity = '1';
          });
        };
        
        img.onerror = () => {
          console.warn('Gallery image error:', src);
        };
        
        img.src = src;
      }
      
      setTimeout(() => {
        this.prefetch();
        this.lock = false;
      }, 200);
    }

    clearSlot(slot) {
      while (slot.firstChild) {
        if (slot.firstChild.tagName === 'IFRAME') {
          slot.firstChild.src = 'about:blank';
        }
        slot.removeChild(slot.firstChild);
      }
    }
    
    prefetch() {
      if (this.items.length < 2) return;
      
      const it = this.items[(this.idx + 1) % this.items.length];
      if (!it || it.type !== 'img') return;
      
      const url = it.formats?.webp;
      if (url && !this.prefetched.has(url)) {
        new Image().src = url;
        this.prefetched.add(url);
        if (this.prefetched.size > 20) {
          this.prefetched.clear();
        }
      }
    }

    updateNav() {
      const wrap = document.getElementById('cover-wrap');
      if (wrap) {
        wrap.classList.toggle('gallery-nav-ready', this.items.length > 1);
      }
    }

    start() {
      if (this.items.length <= 1 || this.interval) return;
      this.interval = setInterval(() => this.render(this.idx + 1), 5000);
    }
    
    stop() {
      if (this.interval) {
        clearInterval(this.interval);
        this.interval = null;
      }
    }
    
    restart() {
      this.stop();
      this.start();
    }
    
    clear() {
      this.stop();
      this.items = [];
      this.idx = 0;
      this.prefetched.clear();
      
      if (this.loader) {
        this.loader.onload = null;
        this.loader.onerror = null;
        this.loader = null;
      }
      
      const slot = document.getElementById('cover-slot');
      if (slot) {
        this.clearSlot(slot);
      }
      
      this.updateNav();
    }
    
    async getFirstCoverUrl(key) {
      const id = this.getId(key);
      if (!id) return 'img/logo.png';
      
      try {
        const r = await fetch(`${this.BASE}${id}/index.json`, { cache: 'force-cache' });
        if (!r.ok) return 'img/logo.png';
        
        const d = await r.json();
        const raw = (Array.isArray(d.items) ? d.items : (Array.isArray(d) ? d : []))[0];
        
        if (!raw) return 'img/logo.png';
        
        const n = this.norm(raw, `${this.BASE}${id}/`);
        return n?.type === 'img' 
          ? (n.formats?.webp || n.formats?.full || n.src || 'img/logo.png') 
          : 'img/logo.png';
      } catch (e) {
        return 'img/logo.png';
      }
    }
  }

  // –°–æ–∑–¥–∞—ë–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
  window.GalleryManager = new GalleryManager();
  
  console.log('‚úÖ GalleryManager class loaded');
})();

//=================================================
// FILE: /scripts/app/player-ui.js
// scripts/app/player-ui.js ‚Äî –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π UI –ø–ª–µ–µ—Ä–∞ + –ø–æ–ª–∏—Ç–∏–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
(function() {
  'use strict';

  // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
  const LYRICS_CACHE_KEY = 'lyrics_cache_v1';
  const LYRICS_CACHE_MAX = 50;
  const SEEK_STEP = 5;
  const VOLUME_STEP = 0.1;

  // ==================== –°–û–°–¢–û–Ø–ù–ò–ï ====================
  const state = {
    currentLyrics: [],
    lyricsVisible: false,
    isSeeking: false,
    seekStartX: 0,
    seekStartProgress: 0,
    progressAnimFrame: null,
    isUserInteracted: false,
    pendingTrack: null,
    cleanupFns: []
  };

  // ==================== –£–¢–ò–õ–ò–¢–´ ====================
  const $ = id => document.getElementById(id);
  const escHtml = s => { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; };
  const fmtTime = s => isNaN(s) || s < 0 ? '--:--' : `${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

  // ==================== –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–û–í ====================
  const LyricsCache = {
    _getAll() {
      try { return JSON.parse(localStorage.getItem(LYRICS_CACHE_KEY)) || {}; } catch { return {}; }
    },
    _setAll(data) {
      try { localStorage.setItem(LYRICS_CACHE_KEY, JSON.stringify(data)); } catch {}
    },
    get(url) {
      const c = this._getAll()[url];
      return c ? { lyrics: c.l, ts: c.t } : null;
    },
    set(url, lyrics) {
      const all = this._getAll();
      const keys = Object.keys(all);
      if (keys.length >= LYRICS_CACHE_MAX) {
        keys.sort((a, b) => (all[a].t || 0) - (all[b].t || 0));
        keys.slice(0, 10).forEach(k => delete all[k]);
      }
      all[url] = { l: lyrics, t: Date.now() };
      this._setAll(all);
    },
    clear() { try { localStorage.removeItem(LYRICS_CACHE_KEY); } catch {} }
  };

  // ==================== –ó–ê–ì–†–£–ó–ö–ê –¢–ï–ö–°–¢–ê ====================
  async function loadLyrics(url) {
    if (!url) return [];
    
    const cached = LyricsCache.get(url);
    if (cached?.lyrics) return cached.lyrics;

    try {
      const r = await fetch(url, { cache: 'force-cache' });
      if (!r.ok) return [];
      const text = await r.text();
      const lines = parseLRC(text);
      if (lines.length) LyricsCache.set(url, lines);
      return lines;
    } catch { return []; }
  }

  function parseLRC(text) {
    const lines = [];
    const regex = /$$(\d{2}):(\d{2})(?:\.(\d{2,3}))?$$(.*)/g;
    let m;
    while ((m = regex.exec(text)) !== null) {
      const min = parseInt(m[1], 10);
      const sec = parseInt(m[2], 10);
      const ms = m[3] ? parseInt(m[3].padEnd(3, '0'), 10) : 0;
      lines.push({ time: min * 60 + sec + ms / 1000, text: m[4].trim() });
    }
    return lines.sort((a, b) => a.time - b.time);
  }

  // ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–ï–ö–°–¢–ê ====================
  function renderLyrics(currentTime) {
    const box = $('lyrics-box');
    if (!box || !state.lyricsVisible || !state.currentLyrics.length) return;

    const lyrics = state.currentLyrics;
    let activeIdx = -1;
    for (let i = lyrics.length - 1; i >= 0; i--) {
      if (lyrics[i].time <= currentTime + 0.3) { activeIdx = i; break; }
    }

    const items = box.querySelectorAll('.lyrics-line');
    items.forEach((el, i) => {
      const isActive = i === activeIdx;
      el.classList.toggle('active', isActive);
      if (isActive && !el.dataset.scrolled) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.dataset.scrolled = '1';
      } else if (!isActive) {
        delete el.dataset.scrolled;
      }
    });
  }

  function displayLyricsInBox() {
    const box = $('lyrics-box');
    if (!box) return;

    if (!state.currentLyrics.length) {
      box.innerHTML = '<div class="lyrics-empty">–¢–µ–∫—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
      return;
    }

    box.innerHTML = state.currentLyrics
      .map((l, i) => `<div class="lyrics-line" data-idx="${i}">${escHtml(l.text) || '‚ô™'}</div>`)
      .join('');
  }

  function toggleLyricsPanel() {
    const panel = $('lyrics-panel');
    const btn = $('lyrics-toggle-btn');
    if (!panel) return;

    state.lyricsVisible = !state.lyricsVisible;
    panel.classList.toggle('visible', state.lyricsVisible);
    btn?.classList.toggle('active', state.lyricsVisible);

    if (state.lyricsVisible) {
      displayLyricsInBox();
      const pos = window.playerCore?.getPosition?.() || 0;
      renderLyrics(pos);
    }
  }

  // ==================== UI –û–ë–ù–û–í–õ–ï–ù–ò–Ø ====================
  function updatePlayButton(isPlaying) {
    const btn = $('play-pause-btn');
    if (btn) btn.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
  }

  function updateProgress(pos, dur) {
    const bar = $('progress-fill');
    const cur = $('time-current');
    const tot = $('time-total');
    
    if (bar && dur > 0 && !state.isSeeking) {
      bar.style.width = `${(pos / dur) * 100}%`;
    }
    if (cur) cur.textContent = fmtTime(pos);
    if (tot) tot.textContent = fmtTime(dur);
  }

  function updateTrackInfo(track) {
    const title = $('track-title');
    const artist = $('track-artist');
    const mini = $('mini-track-title');
    
    if (title) title.textContent = track?.title || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞';
    if (artist) artist.textContent = track?.artist || '';
    if (mini) mini.textContent = track?.title || '';

    // MediaSession
    if ('mediaSession' in navigator && track) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: track.title || '–¢—Ä–µ–∫',
        artist: track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        album: track.album || '',
        artwork: [{ src: track.cover || 'img/logo.png', sizes: '512x512', type: 'image/png' }]
      });
    }
  }

  function updateRepeatButton(mode) {
    const btn = $('repeat-btn');
    if (!btn) return;
    const icons = { none: 'üîÅ', all: 'üîÅ', one: 'üîÇ' };
    btn.textContent = icons[mode] || 'üîÅ';
    btn.classList.toggle('active', mode !== 'none');
  }

  function updateShuffleButton(on) {
    const btn = $('shuffle-btn');
    if (btn) btn.classList.toggle('active', on);
  }

  function updateVolumeUI(vol) {
    const fill = $('volume-fill');
    const icon = $('volume-icon');
    if (fill) fill.style.width = `${vol * 100}%`;
    if (icon) icon.textContent = vol === 0 ? 'üîá' : vol < 0.5 ? 'üîâ' : 'üîä';
  }

  function updateFavoriteButton(isFav) {
    const btn = $('favorite-btn');
    if (btn) {
      btn.textContent = isFav ? '‚≠ê' : '‚òÜ';
      btn.classList.toggle('active', isFav);
    }
  }

  // ==================== –ü–†–û–ì–†–ï–°–°-–ë–ê–† –ò SEEK ====================
  function initSeekHandlers() {
    const bar = $('progress-bar');
    if (!bar) return;

    const getProgress = e => {
      const rect = bar.getBoundingClientRect();
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      return clamp((x - rect.left) / rect.width, 0, 1);
    };

    const startSeek = e => {
      state.isSeeking = true;
      state.seekStartX = e.touches ? e.touches[0].clientX : e.clientX;
      const dur = window.playerCore?.getDuration?.() || 0;
      if (dur > 0) {
        const prog = getProgress(e);
        window.playerCore?.seek?.(prog * dur);
        updateProgress(prog * dur, dur);
      }
    };

    const doSeek = e => {
      if (!state.isSeeking) return;
      const dur = window.playerCore?.getDuration?.() || 0;
      if (dur > 0) {
        const prog = getProgress(e);
        window.playerCore?.seek?.(prog * dur);
        updateProgress(prog * dur, dur);
      }
    };

    const endSeek = () => { state.isSeeking = false; };

    bar.addEventListener('mousedown', startSeek);
    bar.addEventListener('touchstart', startSeek, { passive: true });

    const moveHandler = e => doSeek(e);
    const upHandler = () => endSeek();

    document.addEventListener('mousemove', moveHandler);
    document.addEventListener('touchmove', moveHandler, { passive: true });
    document.addEventListener('mouseup', upHandler);
    document.addEventListener('touchend', upHandler);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è cleanup
    state.cleanupFns.push(() => {
      document.removeEventListener('mousemove', moveHandler);
      document.removeEventListener('touchmove', moveHandler);
      document.removeEventListener('mouseup', upHandler);
      document.removeEventListener('touchend', upHandler);
    });
  }

  // ==================== –ì–†–û–ú–ö–û–°–¢–¨ ====================
  function initVolumeHandlers() {
    const bar = $('volume-bar');
    const icon = $('volume-icon');
    if (!bar) return;

    let dragging = false;

    const setVol = e => {
      const rect = bar.getBoundingClientRect();
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      const vol = clamp((x - rect.left) / rect.width, 0, 1);
      window.playerCore?.setVolume?.(vol);
      updateVolumeUI(vol);
    };

    bar.addEventListener('mousedown', e => { dragging = true; setVol(e); });
    bar.addEventListener('touchstart', e => { dragging = true; setVol(e); }, { passive: true });
    document.addEventListener('mousemove', e => dragging && setVol(e));
    document.addEventListener('touchmove', e => dragging && setVol(e), { passive: true });
    document.addEventListener('mouseup', () => { dragging = false; });
    document.addEventListener('touchend', () => { dragging = false; });

    icon?.addEventListener('click', () => {
      const cur = window.playerCore?.getVolume?.() || 1;
      const newVol = cur > 0 ? 0 : 1;
      window.playerCore?.setVolume?.(newVol);
      updateVolumeUI(newVol);
    });
  }

  // ==================== –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ====================
  function initControlButtons() {
    $('play-pause-btn')?.addEventListener('click', () => window.playerCore?.togglePlay?.());
    $('prev-btn')?.addEventListener('click', () => window.playerCore?.prev?.());
    $('next-btn')?.addEventListener('click', () => window.playerCore?.next?.());
    $('stop-btn')?.addEventListener('click', () => window.playerCore?.stop?.());

    $('repeat-btn')?.addEventListener('click', () => {
      const modes = ['none', 'all', 'one'];
      const cur = window.playerCore?.getRepeatMode?.() || 'none';
      const next = modes[(modes.indexOf(cur) + 1) % modes.length];
      window.playerCore?.setRepeatMode?.(next);
      updateRepeatButton(next);
    });

    $('shuffle-btn')?.addEventListener('click', () => {
      const on = !window.playerCore?.isShuffleOn?.();
      window.playerCore?.setShuffle?.(on);
      updateShuffleButton(on);
    });

    $('favorite-btn')?.addEventListener('click', () => {
      const track = window.playerCore?.getCurrentTrack?.();
      if (!track?.uid || !track?.albumKey) return;
      window.FavoritesManager?.toggleLike?.(track.albumKey, track.uid);
      const isFav = window.FavoritesManager?.isFavorite?.(track.albumKey, track.uid);
      updateFavoriteButton(isFav);
    });

    $('lyrics-toggle-btn')?.addEventListener('click', toggleLyricsPanel);
    $('lyrics-fulltext-btn')?.addEventListener('click', () => window.LyricsModal?.show?.());
  }

  // ==================== –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò ====================
  function initHotkeys() {
    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      const key = e.key.toLowerCase();
      const pc = window.playerCore;

      switch (key) {
        case ' ':
        case 'k':
          e.preventDefault();
          pc?.togglePlay?.();
          break;
        case 'x':
          pc?.stop?.();
          break;
        case 'n':
          pc?.next?.();
          break;
        case 'p':
          pc?.prev?.();
          break;
        case 'r':
          $('repeat-btn')?.click();
          break;
        case 'u':
          $('shuffle-btn')?.click();
          break;
        case 'f':
          $('favorite-btn')?.click();
          break;
        case 't':
          window.SleepTimer?.show?.();
          break;
        case 'arrowleft':
          e.preventDefault();
          pc?.seek?.((pc.getPosition?.() || 0) - SEEK_STEP);
          break;
        case 'arrowright':
          e.preventDefault();
          pc?.seek?.((pc.getPosition?.() || 0) + SEEK_STEP);
          break;
        case 'arrowup':
          e.preventDefault();
          pc?.setVolume?.(clamp((pc.getVolume?.() || 1) + VOLUME_STEP, 0, 1));
          updateVolumeUI(pc.getVolume?.() || 1);
          break;
        case 'arrowdown':
          e.preventDefault();
          pc?.setVolume?.(clamp((pc.getVolume?.() || 1) - VOLUME_STEP, 0, 1));
          updateVolumeUI(pc.getVolume?.() || 1);
          break;
      }
    });
  }

  // ==================== PLAYBACK POLICY (iOS/Safari) ====================
  function initPlaybackPolicy() {
    const markInteracted = () => {
      if (state.isUserInteracted) return;
      state.isUserInteracted = true;
      document.body.classList.add('user-interacted');
      
      // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫
      if (state.pendingTrack) {
        window.playerCore?.play?.(state.pendingTrack);
        state.pendingTrack = null;
      }
    };

    ['click', 'touchstart', 'keydown'].forEach(evt => {
      document.addEventListener(evt, markInteracted, { once: false, passive: true });
    });

    // iOS-specific: —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ AudioContext
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      document.addEventListener('touchstart', () => {
        if (window.Howler?.ctx?.state === 'suspended') {
          window.Howler.ctx.resume();
        }
      }, { once: true });
    }
  }

  function canAutoplay() {
    return state.isUserInteracted;
  }

  function queuePendingTrack(track) {
    state.pendingTrack = track;
  }

  // ==================== –ü–û–î–ü–ò–°–ö–ê –ù–ê –°–û–ë–´–¢–ò–Ø –ü–õ–ï–ï–†–ê ====================
  function subscribeToPlayer() {
    const pc = window.playerCore;
    if (!pc?.on) return;

    pc.on({
      onPlay: () => updatePlayButton(true),
      onPause: () => updatePlayButton(false),
      onStop: () => {
        updatePlayButton(false);
        updateProgress(0, 0);
      },
      onTrackChange: async track => {
        updateTrackInfo(track);
        const isFav = window.FavoritesManager?.isFavorite?.(track?.albumKey, track?.uid);
        updateFavoriteButton(isFav);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç–∞
        state.currentLyrics = track?.lyrics ? await loadLyrics(track.lyrics) : [];
        if (state.lyricsVisible) displayLyricsInBox();
      },
      onProgress: (pos, dur) => {
        updateProgress(pos, dur);
        if (state.lyricsVisible) renderLyrics(pos);
      },
      onVolumeChange: vol => updateVolumeUI(vol),
      onError: err => window.NotificationSystem?.error?.(`–û—à–∏–±–∫–∞: ${err}`),
      onSleepTriggered: () => window.NotificationSystem?.info?.('‚è∞ –¢–∞–π–º–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª')
    });
  }

  // ==================== MEDIASESSION ====================
  function initMediaSession() {
    if (!('mediaSession' in navigator)) return;

    const actions = {
      play: () => window.playerCore?.play?.(),
      pause: () => window.playerCore?.pause?.(),
      previoustrack: () => window.playerCore?.prev?.(),
      nexttrack: () => window.playerCore?.next?.(),
      seekbackward: () => window.playerCore?.seek?.((window.playerCore.getPosition?.() || 0) - 10),
      seekforward: () => window.playerCore?.seek?.((window.playerCore.getPosition?.() || 0) + 10)
    };

    Object.entries(actions).forEach(([action, handler]) => {
      try { navigator.mediaSession.setActionHandler(action, handler); } catch {}
    });
  }

  // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
  function initialize() {
    initSeekHandlers();
    initVolumeHandlers();
    initControlButtons();
    initHotkeys();
    initPlaybackPolicy();
    initMediaSession();

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    try {
      const savedVol = parseFloat(localStorage.getItem('playerVolume'));
      if (!isNaN(savedVol)) {
        window.playerCore?.setVolume?.(savedVol);
        updateVolumeUI(savedVol);
      }
    } catch {}

    // –ü–æ–¥–ø–∏—Å–∫–∞ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º playerCore
    const trySubscribe = () => {
      if (window.playerCore) {
        subscribeToPlayer();
        updateVolumeUI(window.playerCore.getVolume?.() || 1);
        updateRepeatButton(window.playerCore.getRepeatMode?.() || 'none');
        updateShuffleButton(window.playerCore.isShuffleOn?.() || false);
      } else {
        setTimeout(trySubscribe, 100);
      }
    };
    trySubscribe();

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    window.addEventListener('beforeunload', () => {
      try {
        const vol = window.playerCore?.getVolume?.();
        if (typeof vol === 'number') localStorage.setItem('playerVolume', String(vol));
      } catch {}
    });

    console.log('‚úÖ PlayerUI initialized');
  }

  // ==================== CLEANUP ====================
  function destroy() {
    state.cleanupFns.forEach(fn => fn());
    state.cleanupFns = [];
  }

  // ==================== –≠–ö–°–ü–û–†–¢ ====================
  window.PlayerUI = {
    initialize,
    destroy,
    updateTrackInfo,
    updateProgress,
    updatePlayButton,
    updateFavoriteButton,
    toggleLyricsPanel,
    canAutoplay,
    queuePendingTrack,
    get currentLyrics() { return state.currentLyrics; },
    get isUserInteracted() { return state.isUserInteracted; }
  };

  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
})();

//=================================================
// FILE: /scripts/ci/lint-sw.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('service-worker.js');
if (!fs.existsSync(file)) {
  console.error('service-worker.js not found');
  process.exit(1);
}
const src = fs.readFileSync(file, 'utf8');

const errors = [];
const warns = [];

if (!/const\s+SW_VERSION\s*=\s*['"`]\d+\.\d+\.\d+['"`]/.test(src)) {
  errors.push('SW_VERSION is missing or has wrong format (x.y.z)');
}

const listeners = (name) => (src.match(new RegExp(`addEventListener\\(['"]${name}['"]`, 'g')) || []).length;
['install','activate','fetch'].forEach(ev => {
  const n = listeners(ev);
  if (n === 0) errors.push(`No ${ev} event listener`);
  if (n > 1) warns.push(`Multiple (${n}) ${ev} listeners`);
});

const consts = ['CORE_CACHE','RUNTIME_CACHE','MEDIA_CACHE','OFFLINE_CACHE','META_CACHE'];
consts.forEach(cn => {
  const n = (src.match(new RegExp(`\\bconst\\s+${cn}\\b`, 'g')) || []).length;
  if (n === 0) errors.push(`Missing const ${cn}`);
  if (n > 1) warns.push(`Duplicate const ${cn} (${n} times)`);
});

// –î–æ–ø.–ø—Ä–æ–≤–µ—Ä–∫–∏: DEFAULT_SW_CONFIG —á–∏—Å–ª–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã –∏ revalidateDays —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ
const cfgMatch = src.match(/const\s+DEFAULT_SW_CONFIG\s*=\s*\{([\s\S]*?)\};/);
if (cfgMatch) {
  const body = cfgMatch[1];
  const num = (key) => {
    const m = body.match(new RegExp(`${key}\\s*:\\s*([0-9]+(?:\\.[0-9]+)?)`));
    return m ? Number(m[1]) : null;
  };
  const revalidateDays = num('revalidateDays');
  if (!(Number.isInteger(revalidateDays) && revalidateDays > 0)) {
    errors.push('DEFAULT_SW_CONFIG.revalidateDays must be positive integer');
  }
  ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(k => {
    const v = num(k);
    if (!(typeof v === 'number' && v > 0)) errors.push(`DEFAULT_SW_CONFIG.${k} must be positive number`);
  });
}

if (warns.length) {
  console.warn('SW linter warnings:\n - ' + warns.join('\n - '));
}
if (errors.length) {
  console.error('SW linter errors:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Service Worker lint OK');


//=================================================
// FILE: /scripts/ci/validate-content.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const fail = (msg) => { console.error(msg); process.exit(2); };
const warn = (msg) => { console.warn(msg); };

// 1) albums.json –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
const albumsFile = path.resolve('albums.json');
if (!fs.existsSync(albumsFile)) fail('albums.json not found');
let albums;
try {
  const raw = fs.readFileSync(albumsFile, 'utf8');
  const j = JSON.parse(raw);
  if (!j || !Array.isArray(j.albums)) fail('albums.json: "albums" must be an array');
  albums = j.albums;
} catch (e) {
  fail('albums.json is not valid JSON: ' + e.message);
}
albums.forEach((a, i) => {
  if (!a.key || !a.title || !a.base) fail(`albums.json: album[${i}] must contain key/title/base`);
  if (typeof a.key !== 'string' || typeof a.title !== 'string' || typeof a.base !== 'string') {
    fail(`albums.json: album[${i}] key/title/base must be strings`);
  }
  if (!/^https?:\/\//i.test(a.base)) {
    fail(`albums.json: album[${i}].base must be absolute http(s) url`);
  }
  if (!/\/$/.test(a.base)) {
    warn(`albums.json: album[${i}].base should end with "/" (got: ${a.base})`);
  }
});

// 1.5) –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π –∞–ª—å–±–æ–º–æ–≤
{
  const keys = albums.map(a => a.key);
  const uniq = new Set(keys);
  if (uniq.size !== keys.length) {
    const dup = keys.filter((k, idx) => keys.indexOf(k) !== idx);
    fail(`albums.json: duplicate album keys: ${Array.from(new Set(dup)).join(', ')}`);
  }
}

// 2) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –≥–∞–ª–µ—Ä–µ–π –∏ index.json –Ω–∞–ª–∏—á–∏—è/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
const galleryRoot = path.resolve('albums/gallery');
const required = ['00','01','02','03','news'];
required.forEach(id => {
  const dir = path.join(galleryRoot, id);
  const idx = path.join(dir, 'index.json');
  if (!fs.existsSync(dir)) fail(`albums/gallery/${id} directory missing`);
  if (!fs.existsSync(idx)) fail(`albums/gallery/${id}/index.json missing`);
  try {
    const raw = fs.readFileSync(idx, 'utf8');
    const j = JSON.parse(raw);
    const items = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
    if (!Array.isArray(items)) fail(`albums/gallery/${id}/index.json: items must be array`);
    if (items.length === 0) warn(`albums/gallery/${id}/index.json: items is empty`);
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ)
    items.forEach((it, k) => {
      const check = (p) => {
        if (!p || /^https?:\/\//i.test(p)) return;
        const rel = p.replace(/^\.\//, '');
        const fp = path.resolve(rel);
        if (!fs.existsSync(fp)) warn(`Missing file referenced from gallery ${id} item[${k}]: ${p}`);
      };
      if (typeof it === 'string') check(it);
      else if (it && typeof it === 'object') {
        if (it.src) check(it.src);
        if (it.formats) Object.values(it.formats).forEach(check);
      }
    });
  } catch (e) {
    fail(`albums/gallery/${id}/index.json invalid JSON: ${e.message}`);
  }
});

// 3) custom.json sw –∫–æ–Ω—Ñ–∏–≥: revalidateDays —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
const customFile = path.resolve('custom.json');
if (fs.existsSync(customFile)) {
  try {
    const raw = fs.readFileSync(customFile, 'utf8');
    const j = JSON.parse(raw);
    if (j && j.sw) {
      const d = j.sw.revalidateDays;
      if (!(Number.isInteger(d) && d > 0)) {
        fail('custom.json.sw.revalidateDays must be positive integer');
      }
      ['mediaMaxCacheMB','nonRangeMaxStoreMB','nonRangeMaxStoreMBSlow'].forEach(key => {
        const v = j.sw[key];
        if (!(typeof v === 'number' && v > 0)) fail(`custom.json.sw.${key} must be positive number`);
      });
      if (typeof j.sw.allowUnknownSize !== 'boolean') {
        fail('custom.json.sw.allowUnknownSize must be boolean');
      }
    }
  } catch (e) {
    fail('custom.json invalid JSON: ' + e.message);
  }
}
// 4) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å uid –≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö config.json (–ù–ï —Ñ–µ–π–ª–∏–º –±–∏–ª–¥ –∏–∑-–∑–∞ —Å–µ—Ç–∏)
{
  // Node 20: fetch –¥–æ—Å—Ç—É–ø–µ–Ω. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –µ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º.
  const hasFetch = typeof fetch === 'function';
  if (!hasFetch) {
    warn('fetch() is not available in this Node runtime; skip remote config.json uid checks');
  } else {
    for (const a of albums) {
      const base = a.base.endsWith('/') ? a.base : `${a.base}/`;
      const url = `${base}config.json`;

      try {
        const r = await fetch(url, { cache: 'no-cache' });
        if (!r.ok) {
          warn(`remote config.json not reachable for "${a.key}": HTTP ${r.status} (${url})`);
          continue;
        }

        const cfg = await r.json();
        const tracks = Array.isArray(cfg?.tracks) ? cfg.tracks : null;
        if (!tracks) {
          warn(`remote config.json "${a.key}": tracks must be array (${url})`);
          continue;
        }

        const seen = new Set();
        const dups = new Set();
        let missing = 0;

        for (const t of tracks) {
          const uid = String(t?.uid || '').trim();
          if (!uid) {
            missing++;
            continue;
          }
          if (seen.has(uid)) dups.add(uid);
          seen.add(uid);
        }

        if (missing > 0) {
          warn(`remote config.json "${a.key}": ${missing} track(s) have empty uid (${url})`);
        }
        if (dups.size > 0) {
          warn(`remote config.json "${a.key}": duplicate uid(s): ${Array.from(dups).join(', ')} (${url})`);
        }
      } catch (e) {
        warn(`remote config.json check failed for "${a.key}": ${e?.message || e} (${url})`);
      }
    }
  }
}

console.log('Content validation OK');

//=================================================
// FILE: /scripts/ci/validate-manifest.mjs
#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const file = path.resolve('manifest.json');
if (!fs.existsSync(file)) {
  console.error('manifest.json not found');
  process.exit(1);
}
const raw = fs.readFileSync(file, 'utf8');
let json;
try {
  json = JSON.parse(raw);
} catch (e) {
  console.error('manifest.json is not valid JSON:', e.message);
  process.exit(1);
}
const errors = [];
function req(key) { if (!(key in json)) errors.push(`Missing key: ${key}`); }

req('name');
req('short_name');
req('start_url');
req('icons');

if (json.icons && !Array.isArray(json.icons)) {
  errors.push('icons must be an array');
}
if (Array.isArray(json.icons) && json.icons.length === 0) {
  errors.push('icons must contain at least one icon');
}
if (!json.display) errors.push('Missing key: display');
if (!json.theme_color) errors.push('Missing key: theme_color');
if (!json.background_color) errors.push('Missing key: background_color');

if (errors.length) {
  console.error('Manifest validation failed:\n - ' + errors.join('\n - '));
  process.exit(2);
}
console.log('Manifest validation OK');

//=================================================
// FILE: /scripts/core/bootstrap.js
// scripts/core/bootstrap.js ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
(async function() {
  'use strict';
  
  console.log('üöÄ Bootstrapping...');
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  const missing = [];
  try { localStorage.setItem('__t', '1'); localStorage.removeItem('__t'); } catch { missing.push('LocalStorage'); }
  if (typeof fetch === 'undefined') missing.push('Fetch');
  if (typeof Promise === 'undefined') missing.push('Promises');
  
  if (missing.length) {
    document.body.innerHTML = `<div style="position:fixed;inset:0;background:#181818;color:#fff;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px"><div><h1 style="color:#E80100">‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h1><p>–¢—Ä–µ–±—É—é—Ç—Å—è: ${missing.join(', ')}</p></div></div>`;
    return;
  }
  
  // –ñ–¥—ë–º Howler.js
  let tries = 0;
  while (typeof Howl === 'undefined' && tries++ < 50) await new Promise(r => setTimeout(r, 100));
  if (typeof Howl === 'undefined') {
    console.error('‚ùå Howler.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
    return;
  }
  
  // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
  if (/iPad|iPhone|iPod/.test(navigator.userAgent)) document.body.classList.add('ios');
  if (window.matchMedia('(display-mode: standalone)').matches) document.body.classList.add('standalone');
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ albums.json
  try {
    const r = await fetch('./albums.json', { cache: 'no-cache' });
    const d = await r.json();
    window.albumsIndex = d?.albums || [];
    console.log(`‚úÖ Albums: ${window.albumsIndex.length}`);
  } catch (e) {
    console.error('‚ùå albums.json:', e);
    window.albumsIndex = [];
  }
  
  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
  window.addEventListener('error', e => console.error('üí•', e.error || e.message));
  window.addEventListener('unhandledrejection', e => console.error('üí•', e.reason));
  
  console.log('‚úÖ Bootstrap complete');
})();

//=================================================
// FILE: /scripts/core/config.js
// scripts/core/config.js ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
(function() {
  'use strict';
  
  const APP_CONFIG = {
    APP_VERSION: '8.1.0',
    BUILD_DATE: '2025-12-21',
    PROMOCODE: 'VITRINA2025',
    
    ICON_ALBUMS_ORDER: [
      { key: '__favorites__', title: '‚≠ê –ò–ó–ë–†–ê–ù–ù–û–ï ‚≠ê', icon: 'img/icon_album/icon-album-00.png' },
      { key: 'odnazhdy-v-skazke', title: '–û–¥–Ω–∞–∂–¥—ã –≤ –°–∫–∞–∑–∫–µ', icon: 'img/icon_album/icon-album-03.png' },
      { key: 'golos-dushi', title: '–ì–æ–ª–æ—Å –î—É—à–∏', icon: 'img/icon_album/icon-album-02.png' },
      { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º', icon: 'img/icon_album/icon-album-01.png' },
      { key: 'krevetochka', title: '–ö–†–ï–í–ï„ÉÑTOCHKA', icon: 'img/icon_album/icon-album+00.png' },
      { key: '__reliz__', title: '–ù–û–í–û–°–¢–ò', icon: 'img/icon_album/icon-album-news.png' }
    ],
    
    GALLERY_MAP: {
      'krevetochka': '00',
      'mezhdu-zlom-i-dobrom': '01',
      'golos-dushi': '02',
      'odnazhdy-v-skazke': '03',
      '__reliz__': 'news'
    },
    GALLERY_BASE: './albums/gallery/',
    SUPPORT_EMAIL: 'support@vitrina-razbita.ru',
    GITHUB_URL: 'https://github.com/apel-s-in/vi3na1bita-music'
  };

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
  window.APP_CONFIG = APP_CONFIG;
  window.SPECIAL_FAVORITES_KEY = '__favorites__';
  window.SPECIAL_RELIZ_KEY = '__reliz__';
  
  console.log('‚úÖ Config loaded');
})();

//=================================================
// FILE: /scripts/core/utils.js
// scripts/core/utils.js ‚Äî –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
(function() {
  'use strict';
  
  const Utils = {
    $(id) {
      return document.getElementById(id);
    },
    
    $q(sel) {
      return document.querySelector(sel);
    },
    
    $qa(sel) {
      return document.querySelectorAll(sel);
    },
    
    escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    },
    
    formatTime(s) {
      if (isNaN(s) || s < 0) return '--:--';
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60);
      return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    },
    
    async waitFor(fn, maxMs = 2000, step = 50) {
      let t = 0;
      while (!fn() && t < maxMs) {
        await new Promise(r => setTimeout(r, step));
        t += step;
      }
      return fn();
    },
    
    createModal(html, onClose) {
      const bg = document.createElement('div');
      bg.className = 'modal-bg active';
      bg.innerHTML = html;
      const close = () => {
        bg.remove();
        if (onClose) onClose();
      };
      bg.addEventListener('click', e => {
        if (e.target === bg) close();
      });
      const closeBtn = bg.querySelector('.bigclose');
      if (closeBtn) {
        closeBtn.addEventListener('click', close);
      }
      document.body.appendChild(bg);
      return bg;
    },
    
    isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    },
    
    isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    },
    
    isStandalone() {
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    }
  };

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
  window.Utils = Utils;
  
  console.log('‚úÖ Utils loaded');
})();

//=================================================
// FILE: /scripts/e2e/favorites.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import { BASE, loginByPromo, likeFirstTrack, openFavorites, waitTracks } from './utils.js';

test('favorites UI builds and plays', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);

  expect(await page.locator('#track-list .track').count()).toBeGreaterThan(0);
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
});

test('toggle star updates row state and localStorage', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);

  const favRow = page.locator('#track-list .track').first();
  const favId = await favRow.getAttribute('id');
  expect(favId).toMatch(/^fav_/);

  await favRow.locator('.like-star').click();
  await expect(favRow).toHaveClass(/inactive/);

  const { present } = await page.evaluate((id) => {
    const m = String(id || '').match(/^fav_(.+)_(.+)$/);
    if (!m) return { present: false };
    const raw = localStorage.getItem('likedTrackUids:v1');
    const map = raw ? JSON.parse(raw) : {};
    return { present: (map[m[1]] || []).includes(m[2]) };
  }, favId);

  expect(present).toBeFalsy();
});

test('mini-player star toggles favorite in __favorites__', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);

  const favFirst = page.locator('#track-list .track').first();
  const favId = await favFirst.getAttribute('id');
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  const otherIcon = page.locator('.album-icon').filter({ hasNot: page.locator('[data-akey="__favorites__"]') }).nth(1);
  await otherIcon.click();

  await expect(page.locator('#mini-now')).toBeVisible({ timeout: 5000 });
  await page.locator('#mini-now-star').click();
  await page.waitForTimeout(200);

  await page.click('.album-icon[data-akey="__favorites__"]');
  await waitTracks(page);

  const { present } = await page.evaluate((id) => {
    const m = String(id || '').match(/^fav_(.+)_(.+)$/);
    if (!m) return { present: true };
    const raw = localStorage.getItem('likedTrackUids:v1');
    const map = raw ? JSON.parse(raw) : {};
    return { present: (map[m[1]] || []).includes(m[2]) };
  }, favId);

  const favRowAfter = page.locator(`#${favId}`);
  if (present) {
    await expect(favRowAfter).not.toHaveClass(/inactive/);
  } else {
    await expect(favRowAfter).toHaveClass(/inactive/);
  }
});

test('removing star of current track in favorites triggers next', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);

  // Like second track too
  await page.locator('#track-list .track').nth(1).hover();
  await page.locator('#track-list .track').nth(1).locator('.like-star').click();

  await openFavorites(page);
  const favFirst = page.locator('#track-list .track').first();
  await favFirst.click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  const beforeIdx = await page.evaluate(() => window.playerCore?.getIndex?.() ?? 0);
  await favFirst.locator('.like-star').click();
  await page.waitForTimeout(300);

  const afterIdx = await page.evaluate(() => window.playerCore?.getIndex?.() ?? 0);
  expect(afterIdx).not.toBe(beforeIdx);
  await expect(favFirst).toHaveClass(/inactive/);
});

//=================================================
// FILE: /scripts/e2e/player.spec.js
// @ts-check
import { test, expect } from '@playwright/test';
import {
  BASE,
  loginByPromo,
  likeFirstTrack,
  openFavorites,
  playFirstTrack,
  waitTracks,
  seedPlayerStateV2FromCurrent
} from './utils.js';

test('play track, toggle favorites-only and sleep timer UI', async ({ page }) => {
  await loginByPromo(page);
  await expect(page.locator('#main-block')).toBeVisible();
  await waitTracks(page);

  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();
  await expect(page.locator('#play-pause-icon')).toBeVisible();

  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("15 –º–∏–Ω—É—Ç")');
  await expect(page.locator('#sleep-timer-badge')).toBeVisible();
  await page.click('#sleep-timer-btn');
  await page.click('.sleep-menu-item:has-text("–í—ã–∫–ª—é—á–∏—Ç—å")');
  await expect(page.locator('#sleep-timer-badge')).toBeHidden();
});

test('mini-mode when browsing other album', async ({ page }) => {
  await loginByPromo(page);
  await likeFirstTrack(page);
  await openFavorites(page);
  await page.locator('#track-list .track').first().click();
  await expect(page.locator('#lyricsplayerblock')).toBeVisible();

  const otherIcon = page.locator('.album-icon').filter({ hasNot: page.locator('[data-akey="__favorites__"]') }).nth(1);
  await otherIcon.click();
  await expect(page.locator('#mini-now')).toBeVisible();
});

test('reload restores state via PlayerState', async ({ page }) => {
  await loginByPromo(page);
  await playFirstTrack(page);
  await seedPlayerStateV2FromCurrent(page, { position: 5, wasPlaying: true });

  await page.reload({ waitUntil: 'load' });
  await loginByPromo(page);
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });

  const pos = await page.evaluate(() => Math.floor(window.playerCore?.getPosition?.() || 0));
  expect(pos).toBeGreaterThanOrEqual(0);
});

test('quick prev/next uses PlayerCore only', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');

  await page.evaluate(async () => {
    await new Promise(r => setTimeout(r, 50));
    window.playerCore?.prev?.();
    window.playerCore?.next?.();
  });

  const res = await page.evaluate(() => ({
    hasPc: !!window.playerCore,
    hasAudioEl: !!document.getElementById('audio')
  }));
  expect(res.hasPc).toBeTruthy();
  expect(res.hasAudioEl).toBeFalsy();
});

test('sysinfo modal shows SW version', async ({ page }) => {
  await loginByPromo(page);
  await page.waitForTimeout(800);

  const sysbtn = page.locator('#sysinfo-btn');
  await expect(sysbtn).toBeVisible({ timeout: 5000 });
  await sysbtn.click();

  const modal = page.locator('.modal-bg .modal-feedback').filter({ hasText: '–û —Å–∏—Å—Ç–µ–º–µ' });
  await expect(modal).toBeVisible({ timeout: 5000 });
  await expect(modal).toContainText(/SW –≤–µ—Ä—Å–∏—è:/);
});

test('SW update flow persists state', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');
  await page.waitForTimeout(200);

  await page.evaluate(() => {
    window.playerCore?.play?.(0);
    try { window.playerCore?.seek?.(7); } catch {}
  });

  await page.evaluate(() => {
    window.confirm = () => true;
    window.dispatchEvent(new MessageEvent('message', { data: { type: 'SW_VERSION', version: '9.9.9' } }));
  });

  expect(await page.evaluate(() => !!sessionStorage.getItem('resumeAfterReloadV2'))).toBeTruthy();
});

test('favoritesOnly: unliking current triggers next', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);

  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  await page.click('#favorites-btn');
  await expect(page.locator('#favorites-btn')).toHaveClass(/favorites-active/);

  const before = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));
  await firstRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => ({
    playing: !!window.playerCore?.isPlaying?.(),
    uid: String(window.playerCore?.getCurrentTrack?.()?.uid || '')
  }));

  expect(after.playing).toBeTruthy();
  expect(after.uid).not.toBe(before);
});

test('repeat has priority over favoritesOnly', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);

  const firstRow = page.locator('#track-list .track').first();
  await firstRow.hover();
  await firstRow.locator('.like-star').click();
  await firstRow.click();

  await page.click('#favorites-btn');
  await page.click('#repeat-btn');
  await expect(page.locator('#repeat-btn')).toHaveClass(/active/);

  const before = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));
  await firstRow.locator('.like-star').click();
  await page.waitForTimeout(300);

  const after = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));
  expect(after).toBe(before);
});

test('shuffle history: next-next-prev returns to previous', async ({ page }) => {
  await loginByPromo(page);
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');

  await page.click('#shuffle-btn');
  await expect(page.locator('#shuffle-btn')).toHaveClass(/active/);

  await page.click('#next-btn');
  await page.waitForTimeout(200);
  const second = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  await page.click('#next-btn');
  await page.waitForTimeout(200);

  await page.click('#prev-btn');
  await page.waitForTimeout(200);
  const back = await page.evaluate(() => String(window.playerCore?.getCurrentTrack?.()?.uid || ''));

  expect(back).toBe(second);
});

//=================================================
// FILE: /scripts/e2e/utils.js
// @ts-check
/**
 * scripts/e2e/utils.js
 * –û–±—â–∏–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è Playwright e2e, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –≤ spec-—Ñ–∞–π–ª–∞—Ö.
 */

export const BASE = process.env.BASE_URL || 'http://127.0.0.1:4173';

export async function loginByPromo(page, promo = 'VITRINA2025') {
  await page.goto(`${BASE}/index.html`, { waitUntil: 'load' });
  await page.fill('#promo-inp', promo);
  await page.click('#promo-btn');
  await page.waitForSelector('#main-block:not(.hidden)', { timeout: 10000 });
}

export async function waitTracks(page) {
  await page.waitForSelector('#track-list .track', { timeout: 10000 });
}

export async function likeFirstTrack(page) {
  await waitTracks(page);
  const first = page.locator('#track-list .track').first();
  await first.hover();
  await first.locator('.like-star').click();
}

export async function openFavorites(page) {
  await page.click('.album-icon[data-akey="__favorites__"]');
  await waitTracks(page);
}

export async function playFirstTrack(page) {
  await waitTracks(page);
  await page.click('#track-list .track >> nth=0');
  await page.waitForSelector('#lyricsplayerblock', { timeout: 10000 });
}

/**
 * –ó–∞–ø–∏—Å–∞—Ç—å PlayerState –≤ localStorage –≤ uid-—Ñ–æ—Ä–º–∞—Ç–µ (V2).
 * –ë–µ—Ä—ë–º playingAlbum –∏–∑ AlbumsManager, –∞ uid/sourceAlbum –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞.
 */
export async function seedPlayerStateV2FromCurrent(page, opts = {}) {
  const position = typeof opts.position === 'number' ? opts.position : 5;
  const wasPlaying = typeof opts.wasPlaying === 'boolean' ? opts.wasPlaying : true;

  await page.evaluate(({ position, wasPlaying }) => {
    const pc = window.playerCore;
    const track = pc?.getCurrentTrack?.() || null;

    const albumKey = window.AlbumsManager?.getPlayingAlbum?.() || null;

    const st = {
      album: albumKey,
      currentAlbum: window.AlbumsManager?.getCurrentAlbum?.() || albumKey,
      trackUid: String(track?.uid || '').trim() || null,
      sourceAlbum: String(track?.sourceAlbum || '').trim() || null,
      trackIndex: typeof pc?.getIndex === 'function' ? (pc.getIndex() || 0) : 0,
      position: Math.floor(position),
      volume: typeof pc?.getVolume === 'function' ? (pc.getVolume() ?? 100) : 100,
      wasPlaying: !!wasPlaying
    };

    localStorage.setItem('playerStateV2', JSON.stringify(st));
  }, { position, wasPlaying });
}

//=================================================
// FILE: /scripts/ui/favorites.js
// scripts/ui/favorites.js ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–º
(function() {
  'use strict';
  const KEY = 'likedTrackUids:v1';
  const REFS_KEY = 'favoritesAlbumRefsByUid:v1';
  
  const getMap = () => { try { return JSON.parse(localStorage.getItem(KEY)) || {}; } catch { return {}; } };
  const setMap = m => { try { localStorage.setItem(KEY, JSON.stringify(m || {})); } catch {} };
  
  const getLiked = album => { const arr = getMap()[album]; return Array.isArray(arr) ? [...new Set(arr.map(x => String(x||'').trim()).filter(Boolean))] : []; };
  const isFav = (album, uid) => album && uid && getLiked(album).includes(String(uid).trim());
  
  const toggle = (album, uid, liked = null) => {
    const a = String(album||'').trim(), u = String(uid||'').trim();
    if (!a || !u) return false;
    const map = getMap();
    let arr = [...new Set((map[a]||[]).map(x => String(x||'').trim()).filter(Boolean))];
    const has = arr.includes(u), shouldLike = liked !== null ? !!liked : !has;
    if (shouldLike && !has) arr.push(u);
    else if (!shouldLike && has) arr = arr.filter(x => x !== u);
    map[a] = [...new Set(arr)];
    setMap(map);
    try { window.dispatchEvent(new CustomEvent('favorites:changed', { detail: { albumKey: a, uid: u, liked: shouldLike } })); } catch {}
    return true;
  };
  
  // Refs
  const readRefs = () => { try { return JSON.parse(localStorage.getItem(REFS_KEY)) || []; } catch { return []; } };
  const writeRefs = arr => { try { localStorage.setItem(REFS_KEY, JSON.stringify(arr || [])); } catch {} };
  
  const ensureRefs = () => {
    const refs = readRefs(), seen = new Set(refs.map(x => `${x?.a}:${x?.uid}`)), map = getMap();
    let changed = false;
    for (const a of Object.keys(map)) {
      for (const uid of (map[a] || [])) {
        const u = String(uid||'').trim(), k = `${a}:${u}`;
        if (u && !seen.has(k)) { refs.push({ a, uid: u }); seen.add(k); changed = true; }
      }
    }
    if (changed) writeRefs(refs);
    return refs;
  };
  
  const removeRef = (album, uid) => {
    const a = String(album||'').trim(), u = String(uid||'').trim();
    if (!a || !u) return false;
    writeRefs(readRefs().filter(r => !(r?.a === a && String(r?.uid||'').trim() === u)));
    return true;
  };
  
  // Build model
  async function buildModel() {
    ensureRefs();
    const refs = readRefs(), out = [], idx = window.albumsIndex || [];
    for (const ref of refs) {
      const a = String(ref?.a||'').trim(), uid = String(ref?.uid||'').trim();
      if (!a || !uid) continue;
      const meta = idx.find(x => x?.key === a);
      if (!meta?.base) continue;
      let cfg = null;
      try {
        const base = meta.base.endsWith('/') ? meta.base : `${meta.base}/`;
        const r = await fetch(`${base}config.json`, { cache: 'no-cache' });
        if (r.ok) cfg = await r.json();
      } catch {}
      const tracks = cfg?.tracks || [], tr = tracks.find(t => String(t?.uid||'').trim() === uid);
      const isActive = getLiked(a).includes(uid), base = meta.base.endsWith('/') ? meta.base : `${meta.base}/`;
      out.push({
        title: tr?.title || '–¢—Ä–µ–∫', uid,
        audio: isActive && tr?.audio ? new URL(tr.audio, base).toString() : null,
        lyrics: isActive && tr?.lyrics ? new URL(tr.lyrics, base).toString() : null,
        fulltext: isActive && tr?.fulltext ? new URL(tr.fulltext, base).toString() : null,
        __a: a, __uid: uid, __active: isActive,
        __artist: cfg?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        __album: cfg?.albumName || '–ê–ª—å–±–æ–º', __cover: 'img/logo.png'
      });
    }
    window.favoritesRefsModel = out;
    return out;
  }
  
  // Modals
  const esc = s => { const d = document.createElement('div'); d.textContent = String(s||''); return d.innerHTML; };
  
  const createModal = html => {
    const bg = document.createElement('div');
    bg.className = 'modal-bg active';
    bg.innerHTML = html;
    bg.addEventListener('click', e => e.target === bg && bg.remove());
    document.body.appendChild(bg);
    return bg;
  };
  
  const showDelete = ({ albumKey, uid, title, onDeleted }) => {
    if (!albumKey || !uid) return;
    const m = createModal(`<div class="modal-feedback" style="max-width:420px"><button class="bigclose">√ó</button><h3>–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?</h3><p><strong>${esc(title)}</strong></p><div style="display:flex;gap:10px;justify-content:center;margin-top:16px"><button class="offline-btn" data-act="cancel">–û—Ç–º–µ–Ω–∞</button><button class="offline-btn online" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button></div></div>`);
    m.querySelector('.bigclose')?.addEventListener('click', () => m.remove());
    m.querySelector('[data-act="cancel"]')?.addEventListener('click', () => m.remove());
    m.querySelector('[data-act="delete"]')?.addEventListener('click', () => {
      removeRef(albumKey, uid);
      document.getElementById(`fav_${albumKey}_${uid}`)?.remove();
      m.remove();
      window.NotificationSystem?.success('–£–¥–∞–ª–µ–Ω–æ');
      onDeleted?.();
    });
  };
  
  const showInactive = ({ albumKey, uid, title, onDeleted }) => {
    if (!albumKey || !uid) return;
    const m = createModal(`<div class="modal-feedback" style="max-width:420px"><button class="bigclose">√ó</button><h3>–¢—Ä–µ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</h3><p><strong>${esc(title)}</strong></p><div style="display:flex;gap:10px;justify-content:center;margin-top:16px"><button class="offline-btn online" data-act="add">–î–æ–±–∞–≤–∏—Ç—å ‚≠ê</button><button class="offline-btn" data-act="remove">–£–¥–∞–ª–∏—Ç—å</button></div></div>`);
    m.querySelector('.bigclose')?.addEventListener('click', () => m.remove());
    m.querySelector('[data-act="add"]')?.addEventListener('click', () => { toggle(albumKey, uid, true); m.remove(); window.NotificationSystem?.success('–î–æ–±–∞–≤–ª–µ–Ω–æ ‚≠ê'); });
    m.querySelector('[data-act="remove"]')?.addEventListener('click', () => { m.remove(); showDelete({ albumKey, uid, title, onDeleted }); });
  };
  
  const init = () => { try { if (!localStorage.getItem(KEY)) setMap({}); } catch {} console.log('‚úÖ FavoritesManager initialized'); };
  
  window.FavoritesManager = { initialize: init, getLikedUidMap: getMap, getLikedUidsForAlbum: getLiked, isFavorite: isFav, toggleLike: toggle };
  window.FavoritesData = { readFavoritesRefsByUid: readRefs, writeFavoritesRefsByUid: writeRefs, ensureFavoritesRefsWithLikes: ensureRefs, buildFavoritesRefsModel: buildModel, removeFavoritesRef: removeRef, showFavoritesInactiveModal: showInactive, showFavoritesDeleteConfirm: showDelete };
  window.buildFavoritesRefsModel = buildModel;
  window.openFavoritesView = async () => window.AlbumsManager?.loadAlbum('__favorites__');
})();

//=================================================
// FILE: /scripts/ui/modals.js
// scripts/ui/modals.js ‚Äî –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
(function() {
  'use strict';
  const esc = s => window.Utils?.escapeHtml?.(s) || s;
  
  async function getSWVersion() {
    try {
      const reg = await navigator.serviceWorker.getRegistration();
      if (!reg?.active) return 'N/A';
      return new Promise(r => {
        const ch = new MessageChannel();
        ch.port1.onmessage = e => r(e.data.version || 'N/A');
        reg.active.postMessage({ type: 'GET_SW_VERSION' }, [ch.port2]);
        setTimeout(() => r('N/A'), 1000);
      });
    } catch { return 'N/A'; }
  }
  
  async function showLyrics() {
    const track = window.playerCore?.getCurrentTrack();
    if (!track) { window.NotificationSystem?.warning('–ù–µ—Ç —Ç—Ä–µ–∫–∞'); return; }
    let text = '';
    if (track.fulltext) try { const r = await fetch(track.fulltext); if (r.ok) text = await r.text(); } catch {}
    if (!text && window.PlayerUI?.currentLyrics?.length) text = window.PlayerUI.currentLyrics.map(l => l.text || '').filter(Boolean).join('\n');
    if (!text) { window.NotificationSystem?.warning('–¢–µ–∫—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
    const m = window.Utils?.createModal?.(`<div class="modal-feedback" style="max-width:520px;max-height:80vh"><button class="bigclose">√ó</button><h2>${esc(track.title)}</h2><div style="color:#8ab8fd;margin-bottom:20px;font-size:14px">${esc(track.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞')}</div><div style="max-height:50vh;overflow-y:auto;padding:16px;background:rgba(0,0,0,.2);border-radius:10px;line-height:1.8;white-space:pre-wrap">${esc(text)}</div><div style="display:flex;gap:10px;margin-top:20px;justify-content:center"><button class="modal-action-btn" id="copy-lyrics">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div></div>`);
    m?.querySelector('#copy-lyrics')?.addEventListener('click', async () => { try { await navigator.clipboard.writeText(text); window.NotificationSystem?.success('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); m.remove(); } catch { window.NotificationSystem?.error('–û—à–∏–±–∫–∞'); } });
  }
  
  async function showSysinfo() {
    const sw = await getSWVersion();
    const info = { ver: window.APP_CONFIG?.APP_VERSION || window.VERSION || '?', build: window.APP_CONFIG?.BUILD_DATE || '?', pwa: window.matchMedia('(display-mode: standalone)').matches ? '‚úÖ' : '‚ùå', sw, howler: window.Howler?.version || 'N/A', online: navigator.onLine ? '‚úÖ' : '‚ùå' };
    window.Utils?.createModal?.(`<div class="modal-feedback" style="max-width:500px"><button class="bigclose">√ó</button><h2 style="color:#4daaff">–û —Å–∏—Å—Ç–µ–º–µ</h2><div style="font-size:14px;line-height:1.8"><div><b>–í–µ—Ä—Å–∏—è:</b> ${info.ver}</div><div><b>–°–±–æ—Ä–∫–∞:</b> ${info.build}</div><div><b>PWA:</b> ${info.pwa}</div><div><b>SW –≤–µ—Ä—Å–∏—è:</b> ${info.sw}</div><div><b>Howler:</b> ${info.howler}</div><div><b>Online:</b> ${info.online}</div></div><div style="margin-top:20px;text-align:center;font-size:12px;color:#999">¬© 2025</div></div>`);
  }
  
  function showFeedback() {
    const email = window.APP_CONFIG?.SUPPORT_EMAIL || 'support@vitrina-razbita.ru';
    window.Utils?.createModal?.(`<div class="modal-feedback" style="max-width:400px"><button class="bigclose">√ó</button><h2>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h2><div style="display:flex;flex-direction:column;gap:15px;margin-top:20px"><a href="https://t.me/vitrina_razbita" target="_blank" style="background:#0088cc;color:#fff;padding:15px;border-radius:8px;text-align:center;text-decoration:none">Telegram</a><a href="mailto:${email}" style="background:#4daaff;color:#fff;padding:15px;border-radius:8px;text-align:center;text-decoration:none">Email</a></div></div>`);
  }
  
  function showHotkeys() {
    window.Utils?.createModal?.(`<div class="modal-feedback" style="max-width:400px"><button class="bigclose">√ó</button><h2>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h2><div style="margin-top:16px;font-size:14px;line-height:2"><div><b>K/–ü—Ä–æ–±–µ–ª</b> ‚Äî Play/Pause</div><div><b>X</b> ‚Äî –°—Ç–æ–ø</div><div><b>N/P</b> ‚Äî –°–ª–µ–¥./–ü—Ä–µ–¥.</div><div><b>R</b> ‚Äî –ü–æ–≤—Ç–æ—Ä</div><div><b>U</b> ‚Äî Shuffle</div><div><b>F</b> ‚Äî –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</div><div><b>T</b> ‚Äî –¢–∞–π–º–µ—Ä</div><div><b>‚Üê/‚Üí</b> ‚Äî ¬±5 —Å–µ–∫</div><div><b>‚Üë/‚Üì</b> ‚Äî –ì—Ä–æ–º–∫–æ—Å—Ç—å</div></div></div>`);
  }
  
  function init() {
    document.getElementById('sysinfo-btn')?.addEventListener('click', showSysinfo);
    document.getElementById('feedback-link')?.addEventListener('click', showFeedback);
    document.getElementById('hotkeys-btn')?.addEventListener('click', showHotkeys);
    const support = document.getElementById('support-link');
    if (support) support.href = window.APP_CONFIG?.SUPPORT_URL || '#';
  }
  
  document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', init) : init();
  window.LyricsModal = { show: showLyrics };
  window.Modals = { showLyrics, showSysinfo, showFeedback, showHotkeys };
})();

//=================================================
// FILE: /scripts/ui/notify.js
// scripts/ui/notify.js ‚Äî –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
(function() {
  'use strict';

  const CONTAINER_ID = 'notification-container';
  const DEFAULT_DURATION = 4000;
  const MAX_NOTIFICATIONS = 5;

  let container = null;

  function ensureContainer() {
    if (container) return container;
    container = document.getElementById(CONTAINER_ID);
    if (!container) {
      container = document.createElement('div');
      container.id = CONTAINER_ID;
      container.className = 'notification-container';
      document.body.appendChild(container);
    }
    return container;
  }

  function show(message, type = 'info', duration = DEFAULT_DURATION) {
    const cont = ensureContainer();
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
    while (cont.children.length >= MAX_NOTIFICATIONS) {
      cont.firstChild?.remove();
    }

    const el = document.createElement('div');
    el.className = `notification ${type}`;
    el.innerHTML = `
      <div class="notification-content">${escHtml(message)}</div>
      <button class="notification-close">√ó</button>
    `;

    el.querySelector('.notification-close')?.addEventListener('click', () => remove(el));
    cont.appendChild(el);

    if (duration > 0) {
      setTimeout(() => remove(el), duration);
    }

    return el;
  }

  function remove(el) {
    if (!el?.parentNode) return;
    el.style.opacity = '0';
    el.style.transform = 'translateX(100%)';
    setTimeout(() => el.remove(), 300);
  }

  function escHtml(s) {
    const d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  }

  // Shorthand methods
  const success = (msg, dur) => show(msg, 'success', dur);
  const error = (msg, dur) => show(msg, 'error', dur);
  const warning = (msg, dur) => show(msg, 'warning', dur);
  const info = (msg, dur) => show(msg, 'info', dur);

  window.NotificationSystem = { show, success, error, warning, info };
})();

//=================================================
// FILE: /scripts/ui/sleep.js
// scripts/ui/sleep.js ‚Äî –¢–∞–π–º–µ—Ä —Å–Ω–∞
(function() {
  'use strict';
  let menu = null, interval = null;
  const PRESETS = [{ l: '5 –º–∏–Ω', m: 5 }, { l: '10 –º–∏–Ω', m: 10 }, { l: '15 –º–∏–Ω', m: 15 }, { l: '30 –º–∏–Ω', m: 30 }, { l: '1 —á–∞—Å', m: 60 }, { l: '2 —á–∞—Å–∞', m: 120 }];
  
  const fmtRemain = ts => { const m = Math.ceil((ts - Date.now()) / 60000); return m >= 60 ? `${Math.floor(m/60)}—á${m%60 ? ` ${m%60}–º` : ''}` : `${m}–º`; };
  
  const updateBadge = () => {
    const badge = document.getElementById('sleep-timer-badge'), ts = window.playerCore?.getSleepTimerTarget?.() || 0;
    if (!badge) return;
    if (ts > 0) { const m = Math.ceil((ts - Date.now()) / 60000); badge.textContent = m > 0 ? m : ''; badge.style.display = m > 0 ? '' : 'none'; }
    else badge.style.display = 'none';
  };
  
  const startInterval = () => { if (interval) return; interval = setInterval(() => { updateBadge(); const ts = window.playerCore?.getSleepTimerTarget?.() || 0; if (ts > 0 && ts <= Date.now()) clear(); }, 10000); };
  const stopInterval = () => { if (interval) { clearInterval(interval); interval = null; } };
  
  const set = min => {
    if (!window.playerCore) return;
    const ms = min * 60000;
    window.playerCore.setSleepTimer(ms);
    try { localStorage.setItem('sleepTimerTarget', String(Date.now() + ms)); } catch {}
    updateBadge(); startInterval();
  };
  
  const clear = () => {
    window.playerCore?.clearSleepTimer?.();
    try { localStorage.removeItem('sleepTimerTarget'); } catch {}
    stopInterval(); updateBadge();
  };
  
  const closeMenu = () => { if (menu?.parentNode) menu.parentNode.removeChild(menu); menu = null; document.removeEventListener('click', outsideClick); };
  const outsideClick = e => { if (menu && !menu.contains(e.target)) closeMenu(); };
  
  const openMenu = anchor => {
    menu = document.createElement('div');
    menu.className = 'sleep-menu';
    const rect = anchor.getBoundingClientRect();
    menu.style.cssText = `position:fixed;right:${Math.max(8, innerWidth - rect.right)}px;bottom:${Math.max(8, innerHeight - rect.top)}px`;
    
    let html = '';
    const ts = window.playerCore?.getSleepTimerTarget?.() || 0;
    if (ts > 0) html += `<div class="sleep-menu-item active" data-action="cancel">‚úÖ ${fmtRemain(ts)}</div><div class="sleep-menu-item" data-action="clear">üö´ –í—ã–∫–ª—é—á–∏—Ç—å</div><div style="height:1px;background:rgba(255,255,255,0.1);margin:6px 0"></div>`;
    html += PRESETS.map(p => `<div class="sleep-menu-item" data-minutes="${p.m}">${p.l}</div>`).join('');
    menu.innerHTML = html;
    document.body.appendChild(menu);
    
    menu.querySelectorAll('.sleep-menu-item').forEach(it => it.addEventListener('click', e => {
      e.stopPropagation();
      const act = it.dataset.action, min = parseInt(it.dataset.minutes);
      if (act === 'clear') { clear(); closeMenu(); window.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω'); }
      else if (min > 0) { set(min); closeMenu(); window.NotificationSystem?.success(`‚è∞ –¢–∞–π–º–µ—Ä: ${min} –º–∏–Ω`); }
    }));
    setTimeout(() => document.addEventListener('click', outsideClick), 10);
  };
  
  const toggle = e => menu ? closeMenu() : openMenu(e.currentTarget);
  
  const init = () => {
    const btn = document.getElementById('sleep-timer-btn');
    if (!btn) { setTimeout(init, 100); return; }
    btn.addEventListener('click', toggle);
    window.playerCore?.on?.({ onSleepTriggered: () => { window.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª'); clear(); } });
    // Restore
    try {
      const saved = localStorage.getItem('sleepTimerTarget');
      if (saved) { const ts = parseInt(saved), rem = ts - Date.now(); if (rem > 0) { window.playerCore?.setSleepTimer(rem); updateBadge(); startInterval(); } else localStorage.removeItem('sleepTimerTarget'); }
    } catch {}
    console.log('‚úÖ Sleep timer initialized');
  };
  
  window.SleepTimer = { setSleepTimer: set, clearSleepTimer: clear, updateBadge, show: () => { const btn = document.getElementById('sleep-timer-btn'); if (btn) toggle({ currentTarget: btn }); } };
  document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', init) : init();
})();

//=================================================
// FILE: /albums/gallery/news/news-01-baner.html
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="dark">
  <title>–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ</title>
  <style>
    :root{
      --bg-0: #0b0e15;     /* –±–∞–∑–æ–≤—ã–π —Ñ–æ–Ω */
      --bg-1: #0f1422;     /* –ø–∞–Ω–µ–ª—å/–∫–∞—Ä—Ç–∞ */
      --bg-2: #0a0d17;     /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ–Ω */
      --text: #e8ecf6;     /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --muted: #a9b3c7;    /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π */
      --accent-1: #4aa3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã */
      --accent-2: #7be3ff; /* –∞–∫—Ü–µ–Ω—Ç –≥—Ä–∞–Ω–∏—Ü—ã 2 */
      --shadow: 0 12px 28px rgba(0,0,0,0.45), 0 3px 10px rgba(0,0,0,0.35);
      --radius: 16px;
      --radius-inner: 12px;
    }
    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(120% 120% at 10% 10%, #111827 0%, #0b0e15 45%, #070a12 100%);
      color: var(--text);
      font: 500 16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    .wrap{
      position:relative;
      height:100%;
      width:100%;
      display:grid;
      place-items:center;
      padding:10px;
      box-sizing:border-box;
    }
    /* –í–Ω–µ—à–Ω—è—è ¬´–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è —Ä–∞–º–∫–∞¬ª */
    .frame{
      position:relative;
      width:100%;
      height:100%;
      max-width:900px;
      max-height:900px;
      border-radius: var(--radius);
      padding:1px; /* —Ç–æ–ª—â–∏–Ω–∞ —Ä–∞–º–∫–∏ */
      background: linear-gradient(135deg, rgba(74,163,255,0.85), rgba(123,227,255,0.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card{
      position:relative;
      width:100%;
      height:100%;
      border-radius: calc(var(--radius) - 1px);
      background:
        radial-gradient(140% 120% at 80% 0%, rgba(27,41,72,0.55), transparent 60%),
        radial-gradient(120% 140% at 0% 100%, rgba(18,30,58,0.6), transparent 55%),
        var(--bg-1);
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:16px;
      box-sizing:border-box;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .badge{
      align-self:flex-start;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(2px);
    }
    .title{
      font-weight:700;
      font-size: clamp(18px, 3vw, 24px);
      line-height:1.25;
      margin:0 4px;
      color: var(--text);
      text-shadow: 0 1px 0 rgba(0,0,0,0.25);
    }
    .subtitle{
      margin: -6px 4px 2px;
      color: var(--muted);
      font-size: 14px;
    }

    /* –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∑–æ–Ω–∞ –ø–ª–µ–µ—Ä–∞ */
    .embed{
      position:relative;
      margin-top: 4px;
      width:100%;
      flex: 1 1 auto;
      aspect-ratio: 1 / 1; /* —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç */
      border-radius: var(--radius-inner);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.8), rgba(6,8,15,0.92)),
        var(--bg-2);
      border:1px solid rgba(255,255,255,0.07);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 24px rgba(0,0,0,0.45);
    }
    /* ‚úÖ –í–º–µ—Å—Ç–æ iframe: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –≤—Å—é –æ–±–ª–∞—Å—Ç—å (–±–µ–∑ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—à–∏–±–æ–∫) */
    .embed-link{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: var(--text);
      text-decoration:none;
      font-weight:800;
      font-size: clamp(16px, 3vw, 22px);
      background:
        radial-gradient(120% 140% at 50% 50%, rgba(10,13,23,0.65), rgba(6,8,15,0.9)),
        var(--bg-2);
    }
    .embed-link:hover{
      filter: brightness(1.05);
    }
    .embed-link:active{
      filter: brightness(0.95);
    }

    /* –ù–∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top: 4px;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      opacity: .9;
    }
    .cta{
      padding:8px 12px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      color: var(--text);
      text-decoration:none;
      font-weight:600;
      transition: transform .12s ease, background .2s ease;
    }
    .cta:hover{ transform: translateY(-1px); }
    .cta:active{ transform: translateY(0); }

    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö –≤—ã—Å–æ—Ç–∞—Ö —Å–ª–µ–≥–∫–∞ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
    @media (max-height: 420px){
      .card{ padding:12px; gap:10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="frame">
      <section class="card" role="region" aria-label="–ù–æ–≤–æ—Å—Ç–Ω–æ–π –±–∞–Ω–Ω–µ—Ä ‚Äî –ì–æ–ª–æ—Å –î—É—à–∏">
        <div class="badge">–ù–æ–≤–æ—Å—Ç–∏</div>
        <h1 class="title">¬´–ì–æ–ª–æ—Å –î—É—à–∏¬ª ‚Äî —É–∂–µ –Ω–∞ –Ø–Ω–¥–µ–∫—Å&nbsp;–ú—É–∑—ã–∫–µ</h1>
        <p class="subtitle">–°–ª—É—à–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º –≥—Ä—É–ø–ø—ã ¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª</p>

        <div class="embed" role="group" aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ">
          <a class="embed-link"
             href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link"
             target="_blank"
             rel="noopener">
            –û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º –≤ –Ø–Ω–¥–µ–∫—Å –ú—É–∑—ã–∫–µ
          </a>
        </div>

        <div class="footer">
          <div class="hint">–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏—Ç–µ ¬´–ø–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤ –ø–ª–µ–µ—Ä–µ, —á—Ç–æ–±—ã —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –¥—Ä—É–∑—å—è–º</div>
          <a class="cta" href="https://music.yandex.ru/album/38188979?utm_source=web&utm_medium=copy_link" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –∞–ª—å–±–æ–º</a>
        </div>
      </section>
    </div>
  </div>
</body>
</html>

//=================================================
// FILE: /generate-context.js
/* eslint-disable no-console */
"use strict";

/**
 * generate-context.js
 *
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä .meta/project-full.txt –∏ .meta/project-adaptive.txt
 * –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã):
 * 1) –í –Ω–∞—á–∞–ª–µ ‚Äî –±–ª–æ–∫ ¬´–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô¬ª, –∑–∞—Ç–µ–º –º–µ—Ç–∞‚Äë–±–ª–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º/URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–æ–º–µ—Ç–∫–æ–π –ø—Ä–æ GitHub.
 * 2) –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ‚Äî –ü–û–õ–ù–û–ï –¥–µ—Ä–µ–≤–æ –í–°–ï–• —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è assets/), –Ω–æ –±–µ–∑ .git/** –∏ .meta/**.
 *    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤.
 * 3) –ü–æ—Å–ª–µ –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª: —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º (critical ‚Üí high ‚Üí medium ‚Üí low),
 *    –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤—ã–≤–æ–¥–∏—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º. –ó–¥–µ—Å—å assets/** –∏—Å–∫–ª—é—á–∞–µ–º (–ø–æ –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é), .meta/** —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º.
 * 4) –ù–ï–¢ –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª.
 * 5) Adaptive-—Ä–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—â–∏–π –æ–±—ä—ë–º —Å—Ç—Ä–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º --max-lines (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20000).
 *
 * –ó–∞–ø—É—Å–∫:
 *   node generate-context.js --mode=both --max-lines=20000
 *   node generate-context.js --mode=full
 *   node generate-context.js --mode=adaptive --out-dir=.meta
 *
 * –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
 *   --mode=both|full|adaptive
 *   --max-lines=–ß–ò–°–õ–û           // —Ç–æ–ª—å–∫–æ –¥–ª—è adaptive
 *   --out-dir=–ü–£–¢–¨              // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é .meta
 *   --root=–ü–£–¢–¨                 // –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞)
 */

const fs = require("fs");
const path = require("path");

// -------------------- CLI --------------------
const argv = Object.fromEntries(
  process.argv.slice(2).map(a => {
    const [k, ...r] = a.replace(/^--/, "").split("=");
    return [k, r.join("=") === "" ? true : r.join("=")];
  })
);

const ROOT     = path.resolve(argv.root || __dirname);
const META_DIR = path.resolve(argv["out-dir"] || path.join(ROOT, ".meta"));
const MODE     = (argv.mode || "both").toLowerCase(); // full | adaptive | both
const MAX_LINES = Number(argv["max-lines"] || 20000);

// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ .meta
if (!fs.existsSync(META_DIR)) fs.mkdirSync(META_DIR, { recursive: true });

const FULL_FILE    = path.join(META_DIR, "project-full.txt");
const ADAPTIVE_FILE= path.join(META_DIR, "project-adaptive.txt");

// –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∫ self-—Ñ–∞–π–ª–∞–º (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è)
const SELF_FULL_REL  = toUnix(path.relative(ROOT, FULL_FILE));
const SELF_ADAPT_REL = toUnix(path.relative(ROOT, ADAPTIVE_FILE));

// -------------------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ --------------------

// –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ç–æ—Ä—ã—Ö –≤–∫–ª—é—á–∞–µ–º –≤ —Å–µ–∫—Ü–∏—é ¬´–§–ê–ô–õ–´¬ª
const TEXT_EXTS = new Set([
  ".html",".htm",".css",".js",".mjs",".cjs",".ts",".tsx",
  ".json",".webmanifest",".md",".txt",".yml",".yaml"
]);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –°–ï–ö–¶–ò–ò ¬´–§–ê–ô–õ–´¬ª (—Ç–æ–ª—å–∫–æ –∫ –ª–∏—Å—Ç–∏–Ω–≥—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –ù–ï –∫ –¥–µ—Ä–µ–≤—É):
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –∏—Å–∫–ª—é—á–∞–µ–º .meta/** –∏ assets/** (–Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ –∫–æ–Ω—Ç–µ–Ω—Ç),
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏.
 */
const EXCLUDE_FILES_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  "assets/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

/**
 * –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û –¥–ª—è –°–¢–†–£–ö–¢–£–†–´ –î–ï–†–ï–í–ê:
 * - –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ñ–∞–π–ª—ã, –≤–∫–ª—é—á–∞—è assets/**.
 * - –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ .git/**, .meta/** –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ (node_modules –∏ —Ç.–ø.),
 *   –ø–ª—é—Å –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤.
 */
const EXCLUDE_TREE_PATTERNS = [
  "node_modules/**",
  ".git/**",
  ".meta/**",
  ".next/**","dist/**","build/**","out/**","coverage/**",
  ".cache/**",".vscode/**",".idea/**",".husky/**",
  "**/*.log",".DS_Store"
].map(globToRegExp);

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
const PRIORITY = {
  critical: [
    /^index\.html?$/i,
    /^service-worker\.js$/i,
    /^manifest\.json$/i,
    /^albums\.json$/i,
    /^custom\.json$/i,
    /^news\.html?$/i,
    /^generate-index\.(js|mjs|cjs)$/i,
    /^albums\/gallery\/[^/]+\/index\.json$/i,
    /^\.github\/workflows\/.*\.ya?ml$/i
  ],
  high: [
    /^AudioController\.(js|mjs|cjs|ts)$/i,
    /^GlobalState\.(js|mjs|cjs|ts)$/i,
    /^scripts\/.*\.(mjs|js|ts)$/i,
    /^performance\/.*\.(js|ts)$/i,
    /^.*\.(ya?ml)$/i
  ],
  medium: [
    /^.*\.(js|mjs|cjs|ts|tsx|json|html?|css)$/i
  ],
};

// -------------------- –£—Ç–∏–ª–∏—Ç—ã --------------------
function toUnix(p) {
  return String(p).replace(/\\/g, "/");
}
function globToRegExp(pat) {
  const esc = pat
    .replace(/[.+^${}()|[\]\\]/g, "\\$")
    .replace(/\*\*/g, "___GLOBSTAR___")
    .replace(/\*/g, "[^/]*")
    .replace(/___GLOBSTAR___/g, ".*");
  return new RegExp("^" + esc + "$");
}
function isTextFile(rel) {
  return TEXT_EXTS.has(path.extname(rel).toLowerCase());
}
function readText(rel) {
  try { return fs.readFileSync(path.join(ROOT, rel), "utf8"); }
  catch (e) { return `// read error: ${e.message}`; }
}
function countLines(s) {
  return (s.match(/\n/g) || []).length + (s.length ? 1 : 0);
}

// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–§–ê–ô–õ–´¬ª
function isExcludedForFiles(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_FILES_PATTERNS.some(re => re.test(u));
}
// –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –¥–µ—Ä–µ–≤–∞
function isExcludedForTree(rel) {
  const u = toUnix(rel);
  if (!u) return true;
  if (u === SELF_FULL_REL || u === SELF_ADAPT_REL) return true; // –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∞–º–æ–≤–∫–ª—é—á–µ–Ω–∏—è
  return EXCLUDE_TREE_PATTERNS.some(re => re.test(u));
}

// -------------------- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ --------------------
function listAllEntries(includeFiles = true, forTree = false) {
  const res = [];
  const stack = [ROOT];

  while (stack.length) {
    const dir = stack.pop();
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { continue; }

    for (const e of entries) {
      const full = path.join(dir, e.name);
      const rel = toUnix(path.relative(ROOT, full)) || ".";

      // –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –¥–ª—è –¥–µ—Ä–µ–≤–∞ ‚Äî —Å–≤–æ–∏, –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî —Å–≤–æ–∏
      const excluded = forTree ? isExcludedForTree(rel) : isExcludedForFiles(rel);
      if (excluded) continue;

      if (e.isDirectory()) {
        res.push({ rel, full, dir: true });
        stack.push(full);
      } else if (e.isFile() && includeFiles) {
        res.push({ rel, full, dir: false });
      }
    }
  }

  // –ü–∞–ø–∫–∏ —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º —Ñ–∞–π–ª—ã; –≤–Ω—É—Ç—Ä–∏ ‚Äî –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  res.sort((a, b) => (a.dir !== b.dir ? (a.dir ? -1 : 1) : a.rel.localeCompare(b.rel)));
  return res;
}

function listTextFilesForContent() {
  return listAllEntries(true, /*forTree*/ false)
    .filter(e => !e.dir && isTextFile(e.rel))
    .map(e => e.rel);
}

// -------------------- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π --------------------
function readRepoMeta() {
  let url = "";
  try {
    const cfg = path.join(ROOT, ".git", "config");
    if (fs.existsSync(cfg)) {
      const raw = fs.readFileSync(cfg, "utf8");
      const m = raw.match(/url\s*=\s*(.+)\n/);
      if (m) url = m[1].trim();
    }
  } catch {}
  return {
    name: path.basename(ROOT),
    url: url || "(URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω; —É–∫–∞–∂–∏—Ç–µ –≤ .git/config)",
    madeWith: "–ü—Ä–æ–µ–∫—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ https://github.com/ (GitHub Pages + GitHub Actions).",
  };
}

// -------------------- –ë–ª–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ --------------------
function rulesBlock() {
  return [
    "–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):",
    "- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.",
    "- –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π —Å –ø–æ–ª–Ω–æ–≥–æ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.",
    "- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).",
    "- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:",
    "  ```ts",
    "  export function x() {}",
    "  ```",
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).",
    "- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.",
    "- –£—á–∏—Ç—ã–≤–∞–π —á—Ç–æ —è —Ä–∞–±–æ—Ç–∞—é —á–µ—Ä–µ–∑ web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å github.com –∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.",
    "- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.",
    "- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª project-full —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.",
    "- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].",
    "- –ï—Å–ª–∏ –∫–∞–∫–æ–π —Ç–æ —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã, —Ç–æ –ø—Ä–∏—Å—ã–ª–∞–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω—ã–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–æ–µ–º—É –ø—Ä–æ–µ–∫—Ç—É) —Ñ–∞–π–ª –∫–æ—Ç–æ—Ä—ã–π —ç—Ç–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç. ",
    "- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.",
    "- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).",
    "- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.",
    "- –û—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–µ—Ä–≤–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –ü–∞—É–∑–∞, —Å—Ç–æ–ø –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞, –ø—Ä–∏ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∫–∞–∫–∏–µ –±—ã –Ω–µ –±—ã–ª–∏ –ø–ª–µ–µ—Ä –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –Ω–∏—á–µ–≥–æ –¥—Ä—É–≥–æ–≥–æ –µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫, –≤–æ–æ–±—â–µ –Ω–∏–∫–∞–∫–∞—è –¥—Ä—É–≥–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —ç—Ç–æ –±–∞–∑–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è.",
    "- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π —Å–ø–∏—Å–æ–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–æ –≤—Å–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.",
    ""
  ].join("\n");
}

function metaBlock() {
  const m = readRepoMeta();
  return [
    `–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.name}`,
    `–ê–¥—Ä–µ—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: ${m.url}`,
    "# –ü–û–õ–ù–´–ô –ò –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø.",
    m.madeWith,
    ""
  ].join("\n");
}

// -------------------- –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê (–¥–µ—Ä–µ–≤–æ) --------------------
function buildFullTree() {
  const lines = [];
  lines.push(path.basename(ROOT) + "/");

  function walk(dir, prefix = "") {
    let entries = [];
    try { entries = fs.readdirSync(dir, { withFileTypes: true }); } catch { return; }

    const visible = entries
      .filter(e => !isExcludedForTree(toUnix(path.relative(ROOT, path.join(dir, e.name)))))
      .sort((a, b) => (a.isDirectory() !== b.isDirectory() ? (a.isDirectory() ? -1 : 1) : a.name.localeCompare(b.name)));

    visible.forEach((e, i) => {
      const isLast = i === visible.length - 1;
      const branch = isLast ? "‚îî‚îÄ‚îÄ " : "‚îú‚îÄ‚îÄ ";
      lines.push(prefix + branch + e.name + (e.isDirectory() ? "/" : ""));
      if (e.isDirectory()) {
        walk(path.join(dir, e.name), prefix + (isLast ? "    " : "‚îÇ   "));
      }
    });
  }

  walk(ROOT);
  return lines.join("\n") + "\n\n";
}

// -------------------- –°–µ–∫—Ü–∏—è ¬´–§–ê–ô–õ–´¬ª --------------------
function getPriority(rel) {
  const u = toUnix(rel);
  for (const [lvl, rules] of Object.entries(PRIORITY)) {
    if (rules.some(re => re.test(u))) return lvl;
  }
  return "low";
}

function groupFilesByPriority() {
  const all = listTextFilesForContent(); // —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω—ã assets/.meta –∏ –ø—Ä–æ—á–∏–µ –ø–æ EXCLUDE_FILES_PATTERNS
  return {
    critical: all.filter(f => getPriority(f) === "critical"),
    high:     all.filter(f => getPriority(f) === "high"),
    medium:   all.filter(f => getPriority(f) === "medium"),
    low:      all.filter(f => getPriority(f) === "low"),
  };
}

function fileBlock(rel) {
  return [
    "//=================================================",
    `// FILE: /${toUnix(rel)}`,
    readText(rel),
    ""
  ].join("\n");
}

// -------------------- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á—ë—Ç–∞ --------------------
function headerBlock() {
  const now = new Date().toISOString().replace("T"," ").slice(0,19) + " UTC";
  return [
    rulesBlock(),
    metaBlock(),
    "–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:",
    buildFullTree(),
    `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${now}`,
    ""
  ].join("\n");
}

// -------------------- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã --------------------
function generateFull() {
  let out = headerBlock();

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium", "low"];
  for (const lvl of order) {
    for (const f of groups[lvl]) {
      out += fileBlock(f);
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

function generateAdaptive() {
  let out = headerBlock();
  let cur = countLines(out);
  const max = MAX_LINES;

  const groups = groupFilesByPriority();
  const order = ["critical", "high", "medium"]; // low –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ adaptive —á–∞—â–µ –≤—Å–µ–≥–æ

  for (const lvl of order) {
    for (const f of groups[lvl]) {
      const block = fileBlock(f);
      const L = countLines(block);
      if (cur + L > max) {
        out += "\n// ... (truncate)\n";
        return out;
      }
      out += block; cur += L;
    }
  }

  // –ë–ï–ó –±–ª–æ–∫–∞ ¬´–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ª–æ–≥–∏¬ª
  return out;
}

// -------------------- MAIN --------------------
function main() {
  if (MODE === "full" || MODE === "both") {
    fs.writeFileSync(FULL_FILE, generateFull(), "utf8");
    console.log(`‚úÖ ${FULL_FILE}`);
  }
  if (MODE === "adaptive" || MODE === "both") {
    fs.writeFileSync(ADAPTIVE_FILE, generateAdaptive(), "utf8");
    console.log(`‚úÖ ${ADAPTIVE_FILE}`);
  }
}

try { main(); } catch (e) { console.error("‚ùå", e); process.exit(1); }

//=================================================
// FILE: /news/news.json
{
  "items": [
    {
      "id": "2025-11-01-release",
      "title": "–ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ ‚Äî –ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º",
      "date": "2025-11-01",
      "text": "–î–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
      "image": "img/logo.png",
      "tags": ["—Ä–µ–ª–∏–∑", "–∞–ª—å–±–æ–º"]
    },
    {
      "id": "2025-10-20-video",
      "title": "–ö–ª–∏–ø –Ω–∞ —Ç—Ä–µ–∫ ¬´–û—Ç—Ä–∞–∂–µ–Ω–∏–µ¬ª",
      "date": "2025-10-20",
      "embedUrl": "https://www.youtube.com/embed/dQw4w9WgXcQ",
      "tags": ["–∫–ª–∏–ø", "–≤–∏–¥–µ–æ"]
    },
    {
      "id": "2025-10-05-tour",
      "title": "–¢—É—Ä: –∑–∏–º–Ω–∏–µ –∫–æ–Ω—Ü–µ—Ä—Ç—ã",
      "date": "2025-10-05",
      "text": "–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –≤ –Ω–∞—à–∏—Ö —Å–æ—Ü—Å–µ—Ç—è—Ö.",
      "tags": ["–∫–æ–Ω—Ü–µ—Ä—Ç—ã"]
    }
  ]
}

//=================================================
// FILE: /src/PlayerCore.js
// src/PlayerCore.js ‚Äî –Ø–¥—Ä–æ –ø–ª–µ–µ—Ä–∞
(function() {
  'use strict';

  class PlayerCore {
    constructor() {
      this.playlist = [];
      this.currentIndex = -1;
      this.howl = null;
      this.volume = 1;
      this.repeatMode = 'none'; // none, all, one
      this.shuffleOn = false;
      this.shuffleOrder = [];
      this.sleepTimer = null;
      this.sleepTarget = 0;
      this.listeners = {};
      this.progressInterval = null;
    }

    // ==================== –°–û–ë–´–¢–ò–Ø ====================
    on(handlers) {
      Object.entries(handlers).forEach(([k, fn]) => {
        if (typeof fn === 'function') this.listeners[k] = fn;
      });
    }

    emit(event, ...args) {
      this.listeners[event]?.(...args);
    }

    // ==================== –ü–õ–ï–ô–õ–ò–°–¢ ====================
    setPlaylist(tracks) {
      this.playlist = tracks || [];
      this.shuffleOrder = [];
      if (this.shuffleOn) this.generateShuffleOrder();
    }

    generateShuffleOrder() {
      this.shuffleOrder = this.playlist.map((_, i) => i);
      for (let i = this.shuffleOrder.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [this.shuffleOrder[i], this.shuffleOrder[j]] = [this.shuffleOrder[j], this.shuffleOrder[i]];
      }
    }

    getActualIndex(logicalIndex) {
      if (!this.shuffleOn || !this.shuffleOrder.length) return logicalIndex;
      return this.shuffleOrder[logicalIndex] ?? logicalIndex;
    }

    // ==================== –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï ====================
    playTrack(index) {
      if (index < 0 || index >= this.playlist.length) return;

      const actualIdx = this.getActualIndex(index);
      const track = this.playlist[actualIdx];
      if (!track?.audio) {
        this.emit('onError', '–ê—É–¥–∏–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
        return;
      }

      this.stop();
      this.currentIndex = index;

      this.howl = new Howl({
        src: [track.audio],
        html5: true,
        volume: this.volume,
        onplay: () => {
          this.emit('onPlay');
          this.startProgressUpdate();
        },
        onpause: () => this.emit('onPause'),
        onstop: () => this.emit('onStop'),
        onend: () => this.onTrackEnd(),
        onloaderror: (_, err) => this.emit('onError', err),
        onplayerror: (_, err) => {
          this.emit('onError', err);
          // –ü–æ–ø—ã—Ç–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞ iOS
          this.howl?.once('unlock', () => this.howl?.play());
        }
      });

      this.howl.play();
      this.emit('onTrackChange', { ...track, index: actualIdx });
    }

    play(track) {
      if (track) {
        const idx = this.playlist.findIndex(t => t.uid === track.uid);
        if (idx >= 0) this.playTrack(idx);
      } else if (this.howl) {
        this.howl.play();
      } else if (this.playlist.length) {
        this.playTrack(0);
      }
    }

    pause() {
      this.howl?.pause();
    }

    togglePlay() {
      if (!this.howl) {
        if (this.playlist.length) this.playTrack(0);
        return;
      }
      this.howl.playing() ? this.pause() : this.howl.play();
    }

    stop() {
      this.stopProgressUpdate();
      if (this.howl) {
        this.howl.stop();
        this.howl.unload();
        this.howl = null;
      }
      this.emit('onStop');
    }

    // ==================== –ù–ê–í–ò–ì–ê–¶–ò–Ø ====================
    next() {
      if (!this.playlist.length) return;
      let nextIdx = this.currentIndex + 1;
      if (nextIdx >= this.playlist.length) {
        nextIdx = this.repeatMode === 'all' ? 0 : -1;
      }
      if (nextIdx >= 0) this.playTrack(nextIdx);
    }

    prev() {
      if (!this.playlist.length) return;
      // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 3 —Å–µ–∫ ‚Äî –∫ –Ω–∞—á–∞–ª—É —Ç—Ä–µ–∫–∞
      if (this.getPosition() > 3) {
        this.seek(0);
        return;
      }
      let prevIdx = this.currentIndex - 1;
      if (prevIdx < 0) prevIdx = this.repeatMode === 'all' ? this.playlist.length - 1 : 0;
      this.playTrack(prevIdx);
    }

    onTrackEnd() {
      if (this.repeatMode === 'one') {
        this.seek(0);
        this.howl?.play();
      } else {
        this.next();
      }
    }

    // ==================== SEEK & VOLUME ====================
    seek(pos) {
      if (!this.howl) return;
      const dur = this.howl.duration() || 0;
      const clamped = Math.max(0, Math.min(dur, pos));
      this.howl.seek(clamped);
      this.emit('onProgress', clamped, dur);
    }

    getPosition() {
      return this.howl?.seek() || 0;
    }

    getDuration() {
      return this.howl?.duration() || 0;
    }

    setVolume(vol) {
      this.volume = Math.max(0, Math.min(1, vol));
      this.howl?.volume(this.volume);
      this.emit('onVolumeChange', this.volume);
    }

    getVolume() {
      return this.volume;
    }

    // ==================== –†–ï–ñ–ò–ú–´ ====================
    setRepeatMode(mode) {
      this.repeatMode = ['none', 'all', 'one'].includes(mode) ? mode : 'none';
    }

    getRepeatMode() {
      return this.repeatMode;
    }

    setShuffle(on) {
      this.shuffleOn = !!on;
      if (this.shuffleOn) this.generateShuffleOrder();
    }

    isShuffleOn() {
      return this.shuffleOn;
    }

    // ==================== SLEEP TIMER ====================
    setSleepTimer(ms) {
      this.clearSleepTimer();
      if (ms <= 0) return;
      this.sleepTarget = Date.now() + ms;
      this.sleepTimer = setTimeout(() => {
        this.pause();
        this.emit('onSleepTriggered');
        this.sleepTarget = 0;
      }, ms);
    }

    clearSleepTimer() {
      if (this.sleepTimer) {
        clearTimeout(this.sleepTimer);
        this.sleepTimer = null;
      }
      this.sleepTarget = 0;
    }

    getSleepTimerTarget() {
      return this.sleepTarget;
    }

    // ==================== PROGRESS UPDATE ====================
    startProgressUpdate() {
      this.stopProgressUpdate();
      this.progressInterval = setInterval(() => {
        if (this.howl?.playing()) {
          this.emit('onProgress', this.getPosition(), this.getDuration());
        }
      }, 250);
    }

    stopProgressUpdate() {
      if (this.progressInterval) {
        clearInterval(this.progressInterval);
        this.progressInterval = null;
      }
    }

    // ==================== GETTERS ====================
    getCurrentTrack() {
      if (this.currentIndex < 0) return null;
      const actualIdx = this.getActualIndex(this.currentIndex);
      return this.playlist[actualIdx] || null;
    }

    isPlaying() {
      return this.howl?.playing() || false;
    }

    // ==================== DESTROY ====================
    destroy() {
      this.stop();
      this.clearSleepTimer();
      this.playlist = [];
      this.listeners = {};
    }
  }

  // –°–æ–∑–¥–∞—ë–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
  window.playerCore = new PlayerCore();
  window.PlayerCore = PlayerCore;

  console.log('‚úÖ PlayerCore initialized');
})();

//=================================================
// FILE: /styles/main.css
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   –í–ò–¢–†–ò–ù–ê –†–ê–ó–ë–ò–¢–ê ‚Äî PWA Music Player
   –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ v8.0.4
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* === –ü–ï–†–ï–ú–ï–ù–ù–´–ï === */
:root {
  --bg: #181818;
  --bg-card: #1e222d;
  --bg-modal: #252d39;
  --red: #E80100;
  --red-dark: #c60000;
  --blue: #4daaff;
  --blue-dark: #357ac9;
  --green: #27b34c;
  --orange: #ff9800;
  --purple: #8a2be2;
  --text: #f2f2f2;
  --text-muted: #8ab8fd;
  --text-dim: #5a6989;
  --border: #394866;
  --shadow: rgba(0, 0, 0, 0.3);
  --shadow-strong: rgba(0, 0, 0, 0.5);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --transition: 0.2s ease;
}

/* === –°–ë–†–û–° –ò –ë–ê–ó–ê === */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }

body {
  min-height: 100vh;
  min-height: 100dvh;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  display: flex;
  flex-direction: column;
  padding-top: env(safe-area-inset-top);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}

.hidden { display: none !important; }

/* === –ü–†–û–ú–û–ö–û–î === */
#promocode-block {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  z-index: 100;
}

.promo-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: rgba(15, 18, 24, 0.98);
  border-radius: 16px;
  box-shadow: 0 6px 24px var(--shadow-strong);
  padding: 36px 26px 32px;
  min-width: 280px;
  max-width: 90vw;
}

.promo-cover {
  width: 256px;
  height: 256px;
  max-width: 70vw;
  max-height: 70vw;
  object-fit: cover;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.7);
  margin-bottom: 19px;
}

.promo-inner h2 {
  margin-bottom: 16px;
  color: var(--blue);
  font-size: 20px;
}

#promo-inp {
  padding: 12px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.1);
  color: var(--text);
  margin: 10px 0;
  width: 100%;
  max-width: 280px;
  font-size: 16px;
  outline: none;
  transition: border-color var(--transition);
}

#promo-inp:focus { border-color: var(--blue); }
#promo-inp.error { border-color: var(--red); animation: shake 0.3s; }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

#promo-btn {
  padding: 12px 32px;
  background: var(--red);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  transition: opacity var(--transition), transform var(--transition);
  margin-top: 8px;
}

#promo-btn:hover { opacity: 0.9; transform: translateY(-1px); }
#promo-btn:active { transform: translateY(0); }

#promo-error {
  color: #ff6b6b;
  margin-top: 12px;
  font-size: 14px;
  min-height: 20px;
  text-align: center;
}

/* === –û–°–ù–û–í–ù–û–ô –ë–õ–û–ö === */
#main-block {
  max-width: 420px;
  margin: 0 auto;
  flex: 1 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  padding: 0 10px;
  padding-bottom: env(safe-area-inset-bottom);
}

header { width: 100%; text-align: center; }

/* === –ó–ê–ì–û–õ–û–í–û–ö –ê–õ–¨–ë–û–ú–ê === */
.active-album-title {
  width: 100%;
  max-width: 400px;
  margin: 18px auto 6px;
  text-align: center;
  color: #eaf2ff;
  font-weight: 900;
  line-height: 1.15;
  font-size: clamp(18px, 4.6vw, 24px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.active-album-title.fav { color: #ffd166; }
.active-album-title.news { color: var(--text-muted); }

/* === –ò–ö–û–ù–ö–ò –ê–õ–¨–ë–û–ú–û–í === */
.album-icons {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px;
  align-items: center;
  justify-items: center;
  margin: 12px auto 0;
  max-width: 400px;
  width: 100%;
  padding: 4px 8px;
}

.album-icon[data-album="__favorites__"] { grid-row: 2; grid-column: 2; }
.album-icon[data-album="__reliz__"] { grid-row: 2; grid-column: 3; }

.album-icon {
  --size: clamp(62px, 16vw, 82px);
  width: var(--size);
  height: var(--size);
  border-radius: var(--radius-md);
  overflow: hidden;
  border: 1px solid var(--border);
  cursor: pointer;
  filter: grayscale(70%) brightness(0.88);
  opacity: 0.72;
  transition: all 0.15s ease;
}

.album-icon img { width: 100%; height: 100%; object-fit: cover; }

.album-icon.active {
  --size: clamp(68px, 17vw, 88px);
  filter: none;
  opacity: 1;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
}

.album-icon:hover:not(.active) {
  transform: translateY(-2px);
  opacity: 0.9;
}

/* === –û–ë–õ–û–ñ–ö–ê === */
#cover-wrap {
  width: 100%;
  max-width: 400px;
  margin: 14px auto 0;
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.cover-gallery-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 2;
  border: none;
  cursor: pointer;
  background: none;
  padding: 0;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  visibility: hidden;
  pointer-events: none;
  transition: opacity var(--transition);
}

#cover-gallery-arrow-left { left: 7px; }
#cover-gallery-arrow-right { right: 7px; }

#cover-wrap.gallery-nav-ready .cover-gallery-arrow {
  visibility: visible;
  pointer-events: auto;
}

.cover-gallery-arrow:hover { opacity: 0.8; }

#cover-slot {
  width: 100%;
  height: 100%;
  border-radius: 12px;
  overflow: hidden;
  background: var(--bg);
  box-shadow: 0 4px 24px var(--shadow);
}

#cover-slot img,
#cover-slot iframe {
  width: 100%;
  height: 100%;
  display: block;
  border: 0;
}

#cover-slot img { object-fit: contain; }

/* === –°–û–¶–ò–ê–õ–¨–ù–´–ï –°–°–´–õ–ö–ò === */
.socials-under-cover {
  margin: 14px auto 0;
  width: 100%;
  max-width: 398px;
  text-align: center;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
}

.socials-under-cover a {
  color: var(--blue);
  text-decoration: none;
  padding: 4px 8px;
  transition: color var(--transition);
}

.socials-under-cover a:hover {
  color: var(--text);
  text-decoration: underline;
}

/* === –ü–õ–ï–ï–† === */
.lyrics-player-block {
  max-width: 370px;
  width: 100%;
  margin: 20px auto 0;
  background: linear-gradient(180deg, rgba(30, 34, 45, 0.95), rgba(15, 18, 24, 0.98));
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  position: relative;
  z-index: 10;
  isolation: isolate;
}

/* === –û–ö–ù–û –õ–ò–†–ò–ö–ò === */
#lyrics-window {
  position: relative;
  overflow: hidden;
  border-radius: 12px 12px 0 0;
  background: #0f1218;
}

#lyrics-window.lyrics-normal { height: 8.7em; }
#lyrics-window.lyrics-hidden { height: 0 !important; opacity: 0 !important; pointer-events: none !important; }
#lyrics-window.lyrics-expanded { height: 15.6em; }

.lyrics-scroll {
  display: flex;
  flex-direction: column;
  justify-content: center;
  height: 100%;
  overflow: hidden;
  position: relative;
  z-index: 1;
  scrollbar-width: none;
}

.lyrics-scroll::-webkit-scrollbar { display: none; }

.lyrics-window-line {
  text-align: center;
  padding: 6px 16px;
  color: #eee;
  font-size: 15px;
  opacity: 0.57;
  transition: all 0.25s ease;
  user-select: none;
  line-height: 1.35;
}

.lyrics-window-line.active {
  color: var(--red);
  font-size: 1.19em;
  font-weight: bold;
  opacity: 1;
  background: rgba(0, 0, 0, 0.07);
}

.lyrics-placeholder {
  text-align: center;
  padding: 40px 16px;
  color: var(--text-dim);
  font-size: 14px;
  opacity: 0.6;
}

.lyrics-spinner {
  width: 40px;
  height: 40px;
  margin: 40px auto;
  border: 4px solid rgba(77, 170, 255, 0.2);
  border-top-color: var(--blue);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.lyrics-countdown {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 4em;
  font-weight: 900;
  color: rgba(77, 170, 255, 0.35);
  pointer-events: none;
  animation: countdownPulse 1s ease-in-out infinite;
}

@keyframes countdownPulse {
  0%, 100% { transform: scale(1); opacity: 0.35; }
  50% { transform: scale(1.05); opacity: 0.45; }
}

.lyrics-animated-bg {
  position: absolute;
  inset: 0;
  opacity: 0;
  pointer-events: none;
  z-index: 0;
  background: linear-gradient(45deg, rgba(232, 1, 0, 0.15), rgba(77, 170, 255, 0.15), rgba(232, 1, 0, 0.15));
  background-size: 400% 400%;
}

.lyrics-animated-bg.active {
  opacity: 1;
  animation: lyricsGradient 10s ease infinite;
}

@keyframes lyricsGradient {
  0% { background-position: 0 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0 50%; }
}

/* === –ü–†–û–ì–†–ï–°–°-–ë–ê–† === */
.player-progress-wrapper { padding: 16px 20px 12px; }

.player-progress-bar {
  position: relative;
  height: 6px;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 3px;
  cursor: pointer;
}

.player-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--blue), var(--blue-dark));
  border-radius: 3px;
  width: 0;
  transition: width 0.1s linear;
  position: relative;
}

.player-progress-handle {
  position: absolute;
  right: -7px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
  opacity: 0;
  transition: opacity var(--transition);
}

.player-progress-bar:hover .player-progress-handle { opacity: 1; }

.time-row {
  display: flex;
  justify-content: space-between;
  color: var(--text-muted);
  font-size: 12px;
  margin-top: 8px;
  font-variant-numeric: tabular-nums;
}

/* === –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø === */
.player-controls {
  padding: 14px 18px 16px;
  background: rgba(25, 28, 36, 0.8);
}

.player-controls-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.player-controls-row:last-child { margin-bottom: 0; }

.time-in-controls {
  color: var(--text-muted);
  font-size: 13px;
  min-width: 42px;
  text-align: center;
  font-variant-numeric: tabular-nums;
}

.player-control-btn {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text-muted);
  cursor: pointer;
  padding: 10px;
  border-radius: 50%;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
}

.player-control-btn:hover {
  background: rgba(77, 170, 255, 0.15);
  border-color: rgba(77, 170, 255, 0.3);
  transform: scale(1.05);
}

.player-control-btn:active { transform: scale(0.98); }

.player-control-btn.main {
  background: var(--red);
  border-color: var(--red);
  color: #fff;
  width: 52px;
  height: 52px;
}

.player-control-btn.main:hover { background: var(--red-dark); }

.player-control-btn svg { width: 20px; height: 20px; }
.player-control-btn.main svg { width: 24px; height: 24px; }

.player-control-btn.active {
  background: rgba(77, 170, 255, 0.2);
  border-color: var(--blue);
  color: var(--blue);
  box-shadow: 0 0 12px rgba(77, 170, 255, 0.3);
}

/* === FIX: –ó–≤–µ–∑–¥–∞ –≤ –∫–Ω–æ–ø–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ === */
#favorites-btn {
  overflow: hidden;
  position: relative;
}

#favorites-btn img,
#favorites-btn-icon {
  width: 20px;
  height: 20px;
  max-width: 20px;
  max-height: 20px;
  object-fit: contain;
  display: block;
  pointer-events: none;
}

/* === FIX: –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –ø–ª–µ–µ—Ä–µ === */
#favorites-btn.favorites-active {
  background: rgba(255, 215, 0, 0.2);
  border-color: #ffd700;
}

#favorites-btn.favorites-active img,
#favorites-btn.favorites-active #favorites-btn-icon {
  filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.5));
}

/* === –¢–ê–ô–ú–ï–† –°–ù–ê === */
.sleep-timer-btn {
  position: relative;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text-muted);
  cursor: pointer;
  padding: 10px;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sleep-timer-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--red);
  color: #fff;
  font-size: 10px;
  font-weight: bold;
  border-radius: 10px;
  padding: 2px 6px;
  min-width: 18px;
  text-align: center;
}

.sleep-menu {
  position: fixed;
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 8px;
  box-shadow: 0 4px 20px var(--shadow-strong);
  min-width: 180px;
  z-index: 100;
}

.sleep-menu-item {
  padding: 10px 14px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 14px;
  transition: background var(--transition);
}

.sleep-menu-item:hover { background: rgba(77, 170, 255, 0.15); }
.sleep-menu-item.active { background: rgba(77, 170, 255, 0.2); color: var(--blue); }

/* === –ì–†–û–ú–ö–û–°–¢–¨ === */
.volume-control-wrapper {
  position: relative;
  padding: 16px 20px 12px;
  background: rgba(15, 18, 24, 0.5);
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.volume-track {
  position: relative;
  height: 6px;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 3px;
}

.volume-fill {
  position: absolute;
  left: 0;
  top: 0;
  height: 6px;
  background: linear-gradient(90deg, var(--blue), var(--blue-dark));
  width: 0;
  border-radius: 3px;
  pointer-events: none;
}

.volume-handle {
  position: absolute;
  top: 50%;
  left: 0;
  transform: translate(-50%, -50%);
  width: 14px;
  height: 14px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
  pointer-events: none;
  z-index: 3;
}

.volume-slider {
  position: absolute;
  left: 20px;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  height: 28px;
  background: transparent;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
  z-index: 4;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: transparent;
  border-radius: 50%;
  cursor: pointer;
}

.volume-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  background: transparent;
  border: none;
  border-radius: 50%;
  cursor: pointer;
}

/* === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò === */
.player-buttons-wrapper {
  background: rgba(15, 18, 24, 0.5);
  padding: 12px 16px;
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.player-extra-buttons-row {
  display: flex;
  flex: 1;
  gap: 8px;
  justify-content: space-between;
  width: 100%;
}

.lyrics-toggle-btn,
.animation-btn,
.pulse-btn,
.karaoke-btn,
.player-download-btn,
.eco-btn {
  width: 44px;
  min-width: 44px;
  max-width: 44px;
  height: 44px;
  min-height: 44px;
  max-height: 44px;
  padding: 0;
  border-radius: 8px;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.lyrics-toggle-btn {
  background: rgba(77, 170, 255, 0.12);
  border: 1px solid rgba(77, 170, 255, 0.25);
  color: var(--blue);
}

.lyrics-toggle-btn.lyrics-hidden {
  background: rgba(232, 1, 0, 0.12);
  border-color: rgba(232, 1, 0, 0.25);
}

.lyrics-toggle-btn.disabled,
.animation-btn.disabled,
.karaoke-btn.disabled {
  background: rgba(30, 30, 30, 0.6) !important;
  border-color: rgba(255, 255, 255, 0.06) !important;
  color: rgba(255, 255, 255, 0.2) !important;
  cursor: not-allowed !important;
  opacity: 0.5;
  pointer-events: none;
  filter: grayscale(100%);
}

.animation-btn {
  background: linear-gradient(135deg, #4a1a7a, #2a0a4a);
  border: 1px solid rgba(138, 43, 226, 0.3);
  color: #c8a2ff;
}

.animation-btn.active {
  background: linear-gradient(135deg, #5a2a8a, #3a1a5a);
  box-shadow: 0 0 12px rgba(138, 43, 226, 0.4);
}

.pulse-btn {
  background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: #fff;
  font-size: 20px;
}

.pulse-btn.active {
  background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
  border-color: rgba(232, 1, 0, 0.3);
  color: var(--red);
}

.karaoke-btn {
  background: linear-gradient(135deg, #4a1a7a, #2a0a4a);
  border: 1px solid rgba(138, 43, 226, 0.3);
  color: #c8a2ff;
}

.player-download-btn {
  background: linear-gradient(135deg, #1a4a7a, #0a2a4a);
  border: 1px solid rgba(77, 170, 255, 0.3);
  color: var(--blue);
  text-decoration: none;
}

.eco-btn {
  background: linear-gradient(135deg, #1a7a4a, #0a4a2a);
  border: 1px solid rgba(39, 179, 76, 0.3);
  color: var(--green);
}

.eco-btn svg { width: 16px; height: 16px; }

/* === –°–ü–ò–°–û–ö –¢–†–ï–ö–û–í === */
.track-list {
  margin: 0 auto;
  max-width: 370px;
  width: 100%;
  font-size: 1.05em;
  color: #eee;
  position: relative;
  z-index: 1;
}

.track-list.filtered .track:not(.is-favorite) { display: none !important; }

.track {
  display: flex;
  align-items: center;
  padding: 9px 10px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.13s ease;
  position: relative;
  z-index: 1;
  overflow: hidden;
}

.track:hover { background: rgba(255, 255, 255, 0.05); }

.track.current {
  background: #232b38;
  border-left: 3px solid var(--blue);
}

.track.inactive {
  opacity: 0.45;
  filter: grayscale(0.6);
}

.track.is-favorite { background: rgba(77, 170, 255, 0.06); }

.tnum {
  min-width: 30px;
  color: var(--text-muted);
  font-weight: 500;
}

.track-title {
  margin-left: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.like-star {
  margin-left: auto;
  width: 20px;
  height: 20px;
  min-width: 20px;
  max-width: 20px;
  cursor: pointer;
  opacity: 0.97;
  transition: transform var(--transition);
  flex-shrink: 0;
  position: relative;
  z-index: 1;
}

.like-star:hover {
  filter: brightness(1.13);
  transform: scale(1.15);
}

/* === –õ–û–ì–û–¢–ò–ü === */
.logo-bottom {
  max-width: 112px;
  width: 23vw;
  min-width: 66px;
  height: auto;
  display: block;
  margin: 0 auto 15px !important;
  cursor: pointer;
  transition: transform 0.05s ease-out !important;
  will-change: transform;
}

.logo-bottom:hover { transform: scale(1.02); }
.logo-bottom:active { transform: scale(0.98); }

/* === –ù–ò–ñ–ù–ò–ï –ö–ù–û–ü–ö–ò === */
.bottom-controls-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 32px auto 0;
  gap: 10px;
  width: 100%;
  max-width: 300px;
  padding-bottom: env(safe-area-inset-bottom);
}

.filter-favorites-btn {
  display: block;
  margin: 0 auto 15px;
  padding: 12px 20px;
  background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
  color: var(--blue);
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 0.95em;
  font-weight: bold;
  cursor: pointer;
  width: 100%;
  box-shadow: 0 2px 8px var(--shadow);
  transition: all var(--transition);
}

.filter-favorites-btn:hover {
  background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
  border-color: var(--blue);
  transform: translateY(-2px);
}

.filter-favorites-btn.filtered {
  background: linear-gradient(135deg, #4a1a1a, #2a0a0a);
  border-color: var(--red);
  color: #fff;
}

#install-pwa-btn,
#download-album-main {
  color: #fff;
  background: var(--blue);
  border: none;
  border-radius: 8px;
  font-size: 1.07em;
  font-weight: bold;
  margin: 8px 0;
  padding: 12px 18px;
  cursor: pointer;
  width: 100%;
  box-shadow: 0 4px 14px var(--shadow);
  transition: all var(--transition);
}

#install-pwa-btn:hover,
#download-album-main:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--shadow);
}

#download-album-main { background: var(--red); }

.feedback-link,
.support-link,
.hotkeys-btn {
  color: var(--blue) !important;
  text-decoration: underline !important;
  font-weight: 700;
  text-transform: uppercase;
  cursor: pointer;
  font-size: 1em;
  display: block;
  text-align: center;
  width: 100%;
  margin: 6px 0;
  background: none;
  border: none;
  padding: 8px;
  transition: opacity var(--transition);
}

.feedback-link:hover,
.support-link:hover,
.hotkeys-btn:hover { opacity: 0.8; }

.offline-btn {
  min-width: 110px;
  height: 40px;
  font-size: 1.05em;
  font-weight: bold;
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(6, 0, 0, 0.2);
  display: block;
  margin: 10px auto 0;
  transition: all var(--transition);
}

.offline-btn.online { background: var(--red); color: #fff; }
.offline-btn.offline { background: var(--green); color: #fff; }

/* === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (TOASTS) === */
#toast-container {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  pointer-events: none;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  background: #2a2a2a;
  border-radius: 12px;
  padding: 15px 20px;
  box-shadow: 0 4px 20px var(--shadow);
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  max-width: 90vw;
  pointer-events: auto;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast-content {
  display: flex;
  align-items: center;
  gap: 10px;
}

.toast-emoji {
  width: 24px;
  height: 24px;
  font-size: 18px;
  flex-shrink: 0;
}

.toast-message {
  flex: 1;
  font-size: 14px;
  line-height: 1.4;
}

.toast-info { border-left: 4px solid var(--blue); }
.toast-success { border-left: 4px solid var(--green); }
.toast-error { border-left: 4px solid var(--red); }
.toast-warning { border-left: 4px solid var(--orange); }

/* === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê === */
.modal-bg {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

.modal-bg.active { display: flex; }

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-feedback {
  background: var(--bg-modal);
  border-radius: var(--radius-lg);
  padding: 28px 24px;
  min-width: 240px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
  position: relative;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-feedback h2 {
  margin-top: 0;
  margin-bottom: 18px;
  color: var(--blue);
  font-size: 22px;
}

.modal-feedback h3 {
  margin-top: 0;
  margin-bottom: 14px;
  color: var(--text);
  font-size: 18px;
}

.bigclose {
  background: none;
  border: none;
  position: absolute;
  top: 14px;
  right: 14px;
  cursor: pointer;
  color: #eee;
  font-size: 28px;
  line-height: 1;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
}

.bigclose:hover {
  transform: scale(1.1);
  background: rgba(255, 255, 255, 0.1);
}

/* === –ú–ò–ù–ò-–†–ï–ñ–ò–ú === */
.mini-now {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: var(--radius-md);
  background: #232b38;
  margin-bottom: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.mini-now .tnum {
  color: var(--text-muted);
  min-width: 28px;
}

.mini-now .track-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 15px;
}

.next-up {
  display: none;
  margin: 8px 4px 0;
  font-size: 0.98em;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
}

.mini-mode .next-up { display: flex; }

.next-up .label {
  color: var(--text-muted);
  font-size: 13px;
}

.next-up .title {
  color: var(--red);
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  font-size: 14px;
}

/* (hotkeys-grid —É–¥–∞–ª—ë–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è inline –≤ –º–æ–¥–∞–ª–∫–µ) */

/* === –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø === */
.sysinfo-content {
  font-size: 14px;
  line-height: 1.6;
}

.sysinfo-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.sysinfo-row:last-child { border-bottom: none; }

.sysinfo-label { color: var(--text-muted); }
.sysinfo-value { color: var(--text); font-weight: 500; }

/* (feedback-form —É–¥–∞–ª—ë–Ω ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) */

/* === iOS –°–ü–ï–¶–ò–§–ò–ö–ê === */
body.ios .volume-control-wrapper { display: none !important; }
body.ios #mute-btn { display: none !important; }

/* === –ú–ï–î–ò–ê-–ó–ê–ü–†–û–°–´ === */
@media (max-width: 600px) {
  .hotkeys-btn { display: none !important; }
  
  .player-controls-row { gap: 8px; }
  
  .player-control-btn {
    width: 40px;
    height: 40px;
    padding: 8px;
  }
  
  .player-control-btn.main { width: 48px; height: 48px; }
  .player-control-btn svg { width: 18px; height: 18px; }
  
  .player-extra-buttons-row {
    flex-wrap: wrap;
    gap: 6px;
  }
  
  .lyrics-toggle-btn,
  .animation-btn,
  .pulse-btn,
  .karaoke-btn,
  .player-download-btn,
  .eco-btn {
    width: calc(33.333% - 4px);
    min-width: unset;
    max-width: unset;
  }
}

@media (max-width: 380px) {
  .promo-cover { width: 200px; height: 200px; }
  
  .album-icon { --size: 54px; }
  .album-icon.active { --size: 60px; }
  
  .active-album-title { font-size: 16px; }
  
  .lyrics-toggle-btn,
  .animation-btn,
  .pulse-btn,
  .karaoke-btn,
  .player-download-btn,
  .eco-btn {
    width: calc(50% - 4px);
  }
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* === FIX: –ó–≤—ë–∑–¥—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –ø–ª–µ–µ—Ä === */
.track-list .track .like-star {
  pointer-events: auto;
}

.lyrics-player-block * {
  position: relative;
}

.lyrics-player-block .player-controls,
.lyrics-player-block .player-buttons-wrapper,
.lyrics-player-block .volume-control-wrapper {
  z-index: 5;
}

.lyrics-player-block .player-control-btn,
.lyrics-player-block .lyrics-toggle-btn,
.lyrics-player-block .animation-btn,
.lyrics-player-block .pulse-btn,
.lyrics-player-block .karaoke-btn,
.lyrics-player-block .player-download-btn,
.lyrics-player-block .eco-btn,
.lyrics-player-block .sleep-timer-btn {
  position: relative;
  z-index: 10;
}

/* === PRINT === */
@media print {
  body { background: #fff; color: #000; }
  #promocode-block,
  .player-controls,
  .bottom-controls-center,
  .modal-bg { display: none !important; }
}

