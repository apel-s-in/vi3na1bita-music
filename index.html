<!DOCTYPE html>
<html lang="ru">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
<script type="module">
  import { PlayerCore } from './src/PlayerCore.js';

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º PlayerCore –∏ –Ω–∞–≤–µ—à–∏–≤–∞–µ–º ‚Äú–º–æ—Å—Ç‚Äù –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É UI.
  window.playerCore = new PlayerCore();

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–ª–ª–±–µ–∫–∏: PlayerCore –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Ö, UI —Ä–µ–∞–≥–∏—Ä—É–µ—Ç.
  window.__coreOnPlay = () => {
    try { updatePlayPauseIcon(); } catch {}
    try { window.__startCoreTicker && window.__startCoreTicker(); } catch {}
    try { setPlaybackLocks(true); } catch {}
  };
  window.__coreOnPause = () => {
    try { updatePlayPauseIcon(); } catch {}
    try { window.__stopCoreTicker && window.__stopCoreTicker(); } catch {}
    try { setPlaybackLocks(false); } catch {}
  };
  window.__coreOnTrackChange = (track, idx) => {
    try {
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑—É–µ–º –∫—É—Ä—Å–æ—Ä UI
      window.playingTrack = idx;
      window.currentTrack = idx;
      window.playingAlbumKey = window.currentAlbumKey || window.playingAlbumKey || null;

      // –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ—Ä–∏—Å—É–µ–º –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞
      if (!document.getElementById('lyricsplayerblock')) {
        const holder = document.getElementById('now-playing');
        if (holder) {
          holder.innerHTML = '<div class="lyrics-player-block" id="lyricsplayerblock"></div>';
        }
      }
      // –õ–∏—Ä–∏–∫–∞
      if (track && track.lyrics) {
        if (typeof loadLyrics === 'function') loadLyrics(track.lyrics);
      }
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MediaSession –æ—Å—Ç–∞—ë—Ç—Å—è –≤ PlayerCore, –Ω–æ UI –º–æ–∂–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å
      if (typeof updateMiniNowHeader === 'function') updateMiniNowHeader();
      if (typeof updateNextUpLabel === 'function') updateNextUpLabel();
      if (typeof renderLyricsBlock === 'function') renderLyricsBlock();
      if (typeof updatePlayPauseIcon === 'function') updatePlayPauseIcon();

      // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ø—Ä–µ—Ñ–µ—Ç—á —Ç–µ–∫—É—â–µ–≥–æ –∞—É–¥–∏–æ –≤ SW (–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
      try {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller && track?.src) {
          navigator.serviceWorker.controller.postMessage({ type: 'PREFETCH_AUDIO', url: track.src });
        }
      } catch {}
    } catch {}
  };

  // –¢–∏–∫–µ—Ä: –Ω–∞ –æ—Å–Ω–æ–≤–µ seek()/duration() –∏–∑ PlayerCore –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å/–≤—Ä–µ–º—è –∏ –ª–∏—Ä–∏–∫—É
  (function(){
    let __coreTicker = null;
    let __lastUiTs = 0;
    let __lastProgressTs = 0;

    function tick() {
      try {
        const pc = window.playerCore;
        if (!pc || !pc.isPlaying()) return;
        const now = Date.now();

        const dur = pc.getDuration() || 0;
        const pos = pc.getSeek() || 0;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏—Ä–∏–∫–∏ (–±—ã—Å—Ç—Ä–æ, –Ω–æ —Å —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥–æ–º –≤–Ω—É—Ç—Ä–∏ renderLyricsEnhanced)
        try { if (typeof renderLyricsEnhanced === 'function') renderLyricsEnhanced(pos); } catch {}

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥ 1 –ì—Ü –∏–ª–∏ eco-–ø—Ä–æ—Ñ–∏–ª—å)
        if ((now - __lastProgressTs) >= (window.__progressThrottleMs || 1000)) {
          __lastProgressTs = now;
          const fill = document.getElementById('player-progress-fill');
          if (fill && dur > 0) fill.style.width = `${(pos / dur) * 100}%`;
        }

        // –¢–∞–π–º–µ—Ä—ã (—ç–∫–æ —Ç—Ä–æ—Ç—Ç–ª)
        if ((now - __lastUiTs) >= (window.__uiUpdateMinIntervalMs || 1000)) {
          __lastUiTs = now;
          const elapsedEl = document.getElementById('time-elapsed');
          const remainingEl = document.getElementById('time-remaining');
          if (elapsedEl && typeof formatTime === 'function') elapsedEl.textContent = formatTime(pos);
          if (remainingEl && typeof formatTime === 'function') remainingEl.textContent = formatTime(Math.max(0, dur - pos));
        }
      } catch {}
    }

    window.__startCoreTicker = () => {
      if (__coreTicker) return;
      __coreTicker = setInterval(tick, 250);
    };
    window.__stopCoreTicker = () => {
      if (__coreTicker) { clearInterval(__coreTicker); __coreTicker = null; }
    };
  })();

  // –û—Ç–ª–æ–∂–∏–º –Ω–∞–≤–µ—à–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π, –ø–æ–∫–∞ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è
  window.__initPlayerCoreBindings = () => {
    try {
      window.playerCore.on({
        onPlay: () => window.__coreOnPlay && window.__coreOnPlay(),
        onPause: () => window.__coreOnPause && window.__coreOnPause(),
        onTrackChange: (track, idx) => window.__coreOnTrackChange && window.__coreOnTrackChange(track, idx),
        onEnd: () => {}, // –∞–≤—Ç–æ–Ω–µ–∫—Å—Ç ‚Äî –≤–Ω—É—Ç—Ä–∏ PlayerCore
        onSleepTriggered: () => {
          try { hideSleepOverlay(); } catch {}
          try { updateSleepTimerUI(); } catch {}
          try { NotificationSystem.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'); } catch {}
        }
      });
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–æ–≤ —Ç–µ–ø–µ—Ä—å –≤ scripts/player-adapter.js
    } catch {}
  };
</script>
<script type="module" src="./scripts/player-adapter.js"></script>
<script type="module" src="./scripts/energy.js"></script>
<script type="module" src="./scripts/ui/tracks.js"></script>
<script type="module" src="./scripts/ui/mini.js"></script>
<script type="module" src="./scripts/ui/modals.js"></script>
<script type="module" src="./scripts/ui/notify.js"></script>
<script type="module" src="./scripts/ui/sleep.js"></script>
<script type="module" src="./scripts/ui/offline.js"></script>
<script type="module" src="./scripts/ui/gallery.js"></script>
<script type="module" src="./scripts/ui/sysinfo.js"></script>
<script type="module" src="./scripts/ui/bindings.js"></script>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">

  <!-- FAVICONS -->
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="alternate icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="alternate icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <style>
    :root {
      --primary-bg: #181818;
      --primary-color: #E80100;
      --secondary-color: #4daaff;
      --text-color: #f2f2f2;
      --modal-bg: #252d39;
      --border-color: #394866;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      min-height: 100vh;
      background: var(--primary-bg);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; padding: 0; display: flex; flex-direction: column; min-width: 100vw;
      padding-top: env(safe-area-inset-top);
    }

    /* –ü—Ä–æ–º–æ–∫–æ–¥ */
    #promocode-block {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: var(--primary-bg); z-index: 100;
    }
    .promo-inner {
      display: flex; flex-direction: column; align-items: center;
      background: rgba(15,18,24,0.98); border-radius: 16px; box-shadow: 0 6px 24px #0008;
      padding: 36px 26px 32px 26px; min-width: 260px; min-height: 170px;
    }
    .promo-cover {
      width: 256px; height: 256px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 24px #000c;
      margin-bottom: 19px; display: block; background: var(--primary-bg);
    }
    #promo-inp {
      padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.1); color: var(--text-color); margin: 10px 0; width: 100%; font-size: 16px;
    }
    #promo-btn {
      padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px;
      cursor: pointer; font-weight: bold; transition: opacity 0.2s;
    }
    #promo-btn:hover:not(:disabled) { opacity: .8; }
    #promo-btn:disabled { opacity: .5; cursor: not-allowed; }
    #promo-error { color: #ff6b6b; margin-top: 10px; font-size: 14px; }

    .hidden { display: none !important; }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ */
    #main-block { max-width: 420px; margin: 0 auto; flex: 1 0 auto; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0 10px; }
    header { width: 100%; text-align: center; margin: 0 auto; }
    .active-album-title{
      width: 100%;
      max-width: 400px;
      margin: 18px auto 6px auto;
      text-align: center;
      color: #eaf2ff;
      font-weight: 900;
      letter-spacing: .01em;
      line-height: 1.15;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
      font-size: clamp(18px, 4.6vw, 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .active-album-title.fav{ color: #ffd166; letter-spacing: .06em; }
    .active-album-title.news{ color: #8ab8fd; letter-spacing: .02em; }

    /* –û–±–ª–æ–∂–∫–∞/–≥–∞–ª–µ—Ä–µ—è */
    #cover-wrap { width: 100%; max-width: 400px; margin: 14px auto 0 auto; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; position: relative; }
    .cover-gallery-arrow {
      position: absolute; top: 50%; transform: translateY(-50%); z-index: 2; border: none; cursor: pointer; background: none; padding: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;
      visibility: hidden; pointer-events: none; /* –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ */
    }
    .cover-gallery-arrow:hover { opacity: 0.8; }
    #cover-gallery-arrow-left { left: 7px; }
    #cover-gallery-arrow-right { right: 7px; }
    #cover-wrap.gallery-nav-ready .cover-gallery-arrow { visibility: visible; pointer-events: auto; }

    /* –°–ª–æ—Ç –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫—É/–±–∞–Ω–Ω–µ—Ä */
    #cover-slot {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: var(--primary-bg);
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
      position: relative;
    }
    #cover-slot img,
    #cover-slot iframe {
      width: 100%;
      height: 100%;
      display: block;
      border: 0;
      background: transparent;
    }
    #cover-slot img { object-fit: contain; }

    /* –õ–æ–≥–æ */
    .logo-bottom {
      max-width: 112px; width: 23vw; min-width: 66px; height: auto; display: block; margin: 0 auto 15px auto !important;
      cursor: pointer; transition: transform 0.1s ease-out; will-change: transform; transform: translateZ(0); transform-origin: center center; isolation: isolate; z-index: 10; position: relative;
    }
    #logo-bottom { will-change: transform; backface-visibility: hidden; transform: translateZ(0); }

    .socials-under-cover { margin: 14px auto 0 auto; width: 100%; max-width: 398px; text-align: center; font-size: 1.03em; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
    .socials-under-cover a { color: var(--secondary-color); text-decoration: none; transition: color 0.2s; }
    .socials-under-cover a:hover { color: var(--text-color); }

    /* –¢—Ä–µ–∫–∏ */
    .track-list { margin: 0 auto; max-width: 370px; width: 100%; font-size: 1.05em; color: #eee; background: none; padding: 0; }
    .track-list.filtered .track:not(.is-favorite) { display: none !important; }
    .track { display: flex; align-items: center; padding: 7px 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.13s; background: none; }
    .track:hover { background: rgba(255,255,255,0.05); }
    .track.current { background: #232b38; }
    /* –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª (–∑–≤–µ–∑–¥–∞ —Å–Ω—è—Ç–∞) */
    #track-list .track.inactive { opacity: 0.45; filter: grayscale(0.6); }
    /* –ú–∏–Ω–∏‚Äë—Å—Ç—Ä–æ–∫–∞ –ø–æ–¥ –º–∏–Ω–∏‚Äë–ø–ª–µ–µ—Ä (–∫–æ–≥–¥–∞ –ª–∏—Å—Ç–∞–µ–º –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º) */
    .mini-now {
      display:flex; align-items:center; gap:8px;
      padding: 6px 8px; border-radius: 8px;
      background: #232b38; margin-bottom: 6px;
    }
    .mini-now .tnum { color:#8ab8fd; min-width:27px; }
    .mini-now .track-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .tnum { min-width: 27px; color: #8ab8fd; }
    .track-title { margin-left: 7px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .like-star { margin-left: auto; width: 19px; height: 19px; cursor: pointer; opacity: 0.97; border: none; background: none; padding: 0; appearance: none; display: inline-block; transition: transform 0.2s, filter 0.13s, opacity 0.13s; }
    .like-star:hover { filter: brightness(1.13); opacity: 1; transform: scale(1.1); }
    .like-star.animating { animation: starPulse 0.3s; }
    @keyframes starPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

    /* –õ–∏—Ä–∏–∫–∞ + –ü–ª–µ–µ—Ä */
    .lyrics-player-block { width: 100%; margin: 8px 0 3px 0; }
    #lyrics-window { width: 100%; background: rgba(34,34,34,0.98); border-radius: 12px; box-shadow: 0 8px 24px #0007; overflow: hidden; height: 8.5em; position: relative; display: flex; flex-direction: column; align-items: stretch; justify-content: center; margin-bottom: 7px; transition: height 0.2s ease, opacity 0.2s ease, margin 0.2s ease; will-change: height, opacity; }
    #lyrics-window.lyrics-hidden { height: 0 !important; opacity: 0; margin: 0; overflow: hidden; pointer-events: none; }
    #lyrics-window.lyrics-normal { height: 8.7em; }
    #lyrics-window.lyrics-expanded { height: 15.6em; }
    .lyrics-scroll { position: relative; z-index: 1; }
    .lyrics-window-line { opacity: 0.57; font-size: 1.13em; transition: all 0.2s; line-height: 1.7em; text-align: center; min-height: 1.7em; max-width: 97%; margin: 0 auto; color: #eee; white-space: pre-line; user-select: none; word-break: break-word; position: relative; z-index: 1; }
    .lyrics-window-line.active { color: var(--primary-color); font-weight: bold; opacity: 1; text-shadow: 0 1px 7px #73161644; background: rgba(0,0,0,0.07); border-radius: 8px; font-size: 1.19em; }

    .lyrics-animated-bg { position: absolute; inset:0; opacity:0; background: linear-gradient(45deg, rgba(232,1,0,0.15), rgba(77,170,255,0.15), rgba(232,1,0,0.15)); background-size: 400% 400%; animation: none; z-index:0; pointer-events:none; transition: opacity .5s; }
    .lyrics-animated-bg.active { opacity: 1; animation: lyricsGradient 10s ease infinite; }
    @keyframes lyricsGradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    #lyrics-window.animation-active .lyrics-window-line { transition: opacity .3s ease; }
    #lyrics-window.animation-active .lyrics-window-line.active { animation: lyricsGlow 2s ease-in-out infinite; }
    @keyframes lyricsGlow { 0%,50%,100% { opacity:1 } }

    .audio-wrapper { width: 100%; max-width: 395px; margin: 0 auto; }
    #audio { position:absolute; width:1px; height:1px; opacity:0; pointer-events:none; }

    .player-controls { display:flex; flex-direction:column; gap:5px; margin:5px 0; padding:8px 10px; background:rgba(0,0,0,0.3); border-radius:12px; }
    .player-controls-row { display:flex; align-items:center; justify-content:center; gap:12px; }
    .player-control-btn {
      background:none; border:none; color:var(--secondary-color); cursor:pointer; padding:4px; border-radius:50%;
      transition:all .2s; display:flex; align-items:center; justify-content:center;
      width:32px; height:32px; font-weight:bold; font-size:16px; position:relative;
      overflow: hidden;
    }
    .player-controls-row:first-child .player-control-btn { width:48px; height:48px; padding:8px; }
    .player-controls-row:first-child .player-control-btn svg { width:28px; height:28px; }

    .player-control-btn:hover { background: rgba(77,170,255,.2); transform: scale(1.1); }
    .player-control-btn:active { transform: scale(.95); }
    .player-control-btn.active,
    .player-control-btn.repeat-active { color:var(--primary-color); background: rgba(232,1,0,.2); }
    .player-control-btn.favorites-active { background: rgba(255,215,0,.3); }
    .player-control-btn.animation-btn,
    .player-control-btn.bit-btn { font-size:22px; font-weight:bold; }
    .player-control-btn.animation-active,
    .player-control-btn.bit-active { color: var(--primary-color); background: rgba(232,1,0,.2); }

    .player-control-btn svg { width:24px; height:24px; }
    .player-control-btn img { width: 22px; height: 22px; display: block; object-fit: contain; pointer-events: none; }
    .player-control-btn.favorites-active img { filter: drop-shadow(0 0 4px gold); }
    @keyframes pulseFav { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .player-control-btn.favorites-active img { animation: pulseFav 2s infinite; }

    .player-control-btn.main { width:54px; height:54px; }
    .player-control-btn.main svg { width:30px; height:30px; }

    .player-progress-wrapper { width:100%; margin:3px 0 5px 0; position:relative; }
    .player-progress-bar { width:100%; height:6px; background: rgba(255,255,255,.1); border-radius:3px; position:relative; cursor:pointer; overflow:visible; }
    .player-progress-fill { height:100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); width:0%; transition: width .1s linear; border-radius:3px; position:relative; }
    .player-progress-handle { position:absolute; top:50%; transform:translateY(-50%); width:20px; height:20px; background:#fff; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,.3); right:-10px; z-index:2; }

    .time-in-controls { font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size:13px; color:var(--secondary-color); min-width:45px; text-align:center; user-select:none; }

    .volume-control-wrapper { width:100%; margin:5px 0; padding:0; position:relative; }
    .volume-track { position:absolute; top:50%; transform:translateY(-50%); width:100%; height:6px; background:rgba(255,255,255,.2); border-radius:3px; pointer-events:none; }
    .volume-fill { position:absolute; top:50%; transform:translateY(-50%); height:6px; background:var(--secondary-color); border-radius:3px; pointer-events:none; transition: width .1s; }
    .volume-slider { appearance:none; width:100%; height:20px; background:transparent; outline:none; cursor:pointer; position:relative; z-index:2; }
    .volume-slider::-webkit-slider-thumb { appearance:none; width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .volume-slider::-moz-range-thumb { width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:none; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    /* iOS: —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ä–µ–≥—É–ª—è—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ –≤–µ–±–∞ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Å–ª–∞–π–¥–µ—Ä */
    body.ios .volume-control-wrapper { display: none !important; }

    /* Sleep */
    .sleep-timer-btn { background:none; border:none; color:var(--secondary-color); cursor:pointer; padding:8px; border-radius:50%; transition:.2s; display:flex; align-items:center; justify-content:center; width:44px; height:44px; position:relative; }
    .sleep-timer-btn:hover { background: rgba(77,170,255,.2); transform: scale(1.1); }
    .sleep-timer-btn.active { color: var(--primary-color); background: rgba(232,1,0,.2); }
    .sleep-timer-badge { position:absolute; top:-2px; right:-2px; background:var(--primary-color); color:#fff; border-radius:10px; padding:2px 6px; font-size:10px; font-weight:bold; min-width:20px; text-align:center; }
    .sleep-menu { position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background: var(--modal-bg); border-radius:12px; padding:10px; margin-bottom:10px; box-shadow:0 4px 20px rgba(0,0,0,.3); z-index:100; min-width:150px; display:none; }
    .sleep-menu.active { display:block; animation: slideUp .2s; }
    .sleep-menu-item { padding:8px 12px; cursor:pointer; border-radius:6px; transition: background .2s; white-space:nowrap; color:var(--text-color); }
    .sleep-menu-item:hover { background: rgba(255,255,255,.1); }

    .sleep-overlay { position: fixed; inset:0; background: rgba(0,0,0,.95); display:none; align-items:center; justify-content:center; z-index:10000; }
    .sleep-overlay.active { display:flex; animation: fadeIn .5s; }
    .sleep-content { text-align:center; padding:40px; max-width:400px; }
    .sleep-icon { font-size:64px; margin-bottom:20px; opacity:.5; }
    .sleep-title { font-size:24px; margin-bottom:10px; color: var(--text-color); }
    .sleep-message { color: rgba(255,255,255,.6); margin-bottom:30px; }
    .sleep-buttons { display:flex; gap:10px; justify-content:center; }
    .sleep-btn { padding:12px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; transition:opacity .2s; }
    .sleep-btn-primary { background: var(--primary-color); color:#fff; }
    .sleep-btn-secondary { background: rgba(255,255,255,.1); color: var(--text-color); }
    .sleep-btn:hover { opacity:.8; }

    /* –ö–Ω–æ–ø–∫–∞ –ª–∏—Ä–∏–∫–∏ –∏ –ø—Ä–æ—á–∏–µ –Ω–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
    .lyrics-toggle-btn { position:absolute; left:10px; top:50%; transform: translateY(-50%); width:44px; height:44px; background:none; border:none; cursor:pointer; padding:0; display:flex; align-items:center; justify-content:center; font-weight:bold; transition:.2s; user-select:none; z-index:5; }
    .lyrics-toggle-btn-visual { font-size:36px; line-height:1; transition:.2s; pointer-events:none; }
    .lyrics-toggle-btn.lyrics-normal .lyrics-toggle-btn-visual { color: var(--secondary-color); font-size:36px; }
    .lyrics-toggle-btn.lyrics-hidden .lyrics-toggle-btn-visual { color: var(--primary-color); font-size:36px; }
    .lyrics-toggle-btn.lyrics-expanded .lyrics-toggle-btn-visual { color: var(--secondary-color); font-size:20px; }
    .lyrics-toggle-btn:hover .lyrics-toggle-btn-visual { transform: scale(1.1); }

    .player-buttons-wrapper { display:flex; flex-direction:column; align-items:center; gap:9px; margin-top:10px; width:100%; position:relative; }
    .karaoke-btn, .player-download-btn {
      color: var(--secondary-color) !important; background:none; border:none; cursor:pointer; font-size:1em; text-transform:uppercase; font-weight:700; letter-spacing:.02em; text-decoration:underline; transition:.18s; padding:4px 16px; min-width:148px; text-align:center; border-radius:7px; display:block; margin: 0 auto;
    }
    .karaoke-btn:hover, .player-download-btn:hover { color:#fff !important; background:#273050; }
    /* –†—è–¥ –¥–æ–ø. –∫–Ω–æ–ø–æ–∫ (–¢–ï–ö–°–¢, –°–ö–ê–ß–ê–¢–¨, –≠–ö–û) */
    .player-extra-buttons-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      align-items: center;
      width: 100%;
      max-width: 395px;
    }
    /* –£–ª—å—Ç—Ä–∞‚Äë—ç–∫–æ–Ω–æ–º (–º–æ–ª–Ω–∏—è) */
    .eco-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--secondary-color);
      cursor: pointer;
      font-weight: 800;
      letter-spacing: .02em;
      transition: background .18s, color .18s, transform .12s;
      justify-self: end;
      min-height: 36px;
    }
    .eco-btn:hover { color: #fff; background: #2a2f45; transform: translateY(-1px); }
    .eco-btn.eco-active { color: var(--primary-color); background: rgba(232,1,0,.12); border-color: rgba(232,1,0,.25); }
    .eco-btn svg { width: 18px; height: 18px; display: block; }
    .eco-btn .eco-label { font-size: .95em; user-select: none; }

    .bottom-controls-center { display:flex; flex-direction:column; align-items:center; justify-content:center; margin:32px auto 0 auto; gap:8px; width:100%; max-width:280px; padding-bottom: env(safe-area-inset-bottom); }

    .filter-favorites-btn { display:block; margin:0 auto 15px auto; padding:10px 20px; background: linear-gradient(135deg,#2a2a2a,#1a1a1a); color: var(--secondary-color); border:2px solid var(--border-color); border-radius:12px; font-size:.95em; font-weight:bold; cursor:pointer; transition:.3s; text-align:center; min-width:100%; white-space:nowrap; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .filter-favorites-btn:hover { background: linear-gradient(135deg,#3a3a3a,#2a2a2a); border-color: var(--secondary-color); transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .filter-favorites-btn.filtered { background: linear-gradient(135deg,#4a1a1a,#2a0a0a); border-color: var(--primary-color); color:#fff; }

    #install-pwa-btn, #download-album-main {
      color:#fff; background: var(--secondary-color); border:none; border-radius:7px; font-size:1.07em; font-weight:bold; letter-spacing:.02em; margin:15px 0 5px 0; padding:8px 13px; cursor:pointer; width:98%; box-shadow:0 4px 14px #0005; transition: background .2s;
    }
    #download-album-main { background: var(--primary-color); font-size:1.09em; margin-bottom:8px; }
    #install-pwa-btn:hover { background:#3275c2; } #download-album-main:hover { background:#c60000; }

    .feedback-link, .support-link { color: var(--secondary-color) !important; text-decoration: underline !important; font-weight:700; text-transform:uppercase; letter-spacing:.03em; cursor:pointer; transition: color .18s; font-size:1em; display:block; text-align:center; width:100%; margin:0; }
    .feedback-link:hover, .support-link:hover { color:#fff !important; }

    .offline-btn { min-width:102px; height:38px; font-size:1.05em; font-weight:bold; border:none; border-radius:9px; cursor:pointer; letter-spacing:.07em; box-shadow:0 2px 8px #06000032; transition: background .2s, color .14s; display:block; margin:0 auto; }
    .offline-btn.online { background: var(--primary-color); color:#fff; }
    .offline-btn.offline { background:#27b34c; color:#fff; }
    .offline-progress { margin-top:11px; width:100%; height:8px; background:#222; border-radius:6px; overflow:hidden; box-shadow:0 1px 6px #222b; }
    .offline-progress-bar { height:100%; background:#2fed54; transition: width .33s; }
    .offline-desc { text-align:center; font-size:.97em; margin-top:5px; opacity:.85; }

    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; backdrop-filter: blur(4px); z-index: 99; }
    .modal-bg.active { display:flex; animation: fadeIn .3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .modal-feedback { background: var(--modal-bg); border-radius:14px; padding:24px 20px; min-width:215px; max-width:96vw; box-shadow:0 4px 32px #0009; position:relative; animation: slideUp .3s; }
    @keyframes slideUp { from{ transform:translateY(20px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
    .modal-feedback .bigclose { background:none; border:none; position:absolute; top:13px; right:13px; cursor:pointer; color:#eee; border-radius:50%; width:32px; height:32px; transition: transform .2s; }
    .modal-feedback .bigclose:hover { transform: scale(1.1); }
    .modal-feedback .bigclose svg { width:31px; height:31px; }

    .hotkeys-btn { color: var(--secondary-color) !important; text-decoration: underline !important; font-weight:700; text-transform:uppercase; letter-spacing:.03em; cursor:pointer; transition:color .18s; font-size:1em; display:block; text-align:center; width:100%; margin:0; background:none; border:none; padding:8px; }
    .hotkeys-btn:hover { color:#fff !important; }
    @media (max-width: 600px) { .hotkeys-btn { display:none !important; } }
    @media (display-mode: standalone) { .bottom-controls-center { padding-bottom: calc(env(safe-area-inset-bottom) + 10px); } }
    @media (hover:none) { .tooltip { display:none; } }

    /* –¢–æ—Å—Ç—ã */
    .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: #2a2a2a; border-radius: 12px; padding: 15px 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 9999; opacity: 0; transition: all 0.3s ease; max-width: 90%; word-wrap: break-word; pointer-events: none; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast-content { display: flex; align-items: center; gap: 10px; }
    .toast-emoji { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .toast-info { border-left: 4px solid var(--secondary-color); }
    .toast-success { border-left: 4px solid #27b34c; }
    .toast-error { border-left: 4px solid var(--primary-color); }
    .toast-warning { border-left: 4px solid #ff9800; }
    .toast-offline { border-left: 4px solid #666; }

    /* iOS —É—Å—Ç–∞–Ω–æ–≤–∫–∞ */
    .ios-install-prompt { position: fixed; bottom:0; left:0; right:0; background:#1a1a1a; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; transform: translateY(100%); transition: transform 0.3s ease; z-index: 10000; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); }
    .ios-install-prompt.show { transform: translateY(0); }
    .ios-prompt-content { max-width: 400px; margin: 0 auto; text-align: center; }
    .ios-prompt-icon { width: 60px; height: 60px; margin-bottom: 15px; }
    .ios-prompt-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #666; font-size: 28px; cursor: pointer; }
    .ios-prompt-button { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; margin-top: 20px; cursor: pointer; }

    /* –ú–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º –ø–ª–µ–µ—Ä–∞ */
    #now-playing:empty { display: none; }
    .mini-mode .player-buttons-wrapper { display: none !important; }

    /* –†—è–¥ –∏–∫–æ–Ω–æ–∫ –∞–ª—å–±–æ–º–æ–≤ */
    .album-icons { display: flex; gap: 10px; align-items: center; justify-content: center; margin: 12px auto 0 auto; max-width: 400px; overflow-x: auto; padding: 4px 0; }
    .album-icon { width: 60px; height: 60px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); cursor: pointer; filter: grayscale(70%) brightness(.88); opacity: .72; transition: transform .15s, filter .15s, opacity .15s, box-shadow .15s, width .15s ease, height .15s ease; flex: 0 0 auto; }
    .album-icon.active { filter: none; opacity: 1; box-shadow: 0 2px 10px rgba(0,0,0,.35); width: 66px; height: 66px; }
    .album-icon:hover { transform: translateY(-2px); }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ¬´–ù–æ–≤–æ—Å—Ç–∏¬ª */
    #reliz-container { width: 100%; max-width: 400px; margin: 12px auto 0 auto; }
    #reliz-container iframe, #reliz-container .embed-reliz { width: 100%; border: none; }

    /* –°–ª–µ–¥—É—é—â–∞—è –≤ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º–µ */
    .next-up { display: none; margin: 8px 4px 0 4px; font-size: .98em; align-items: center; gap: 6px; }
    .mini-mode .next-up { display: flex; }
    .next-up .label { color: #8ab8fd; opacity: .9; }
    .next-up .title { color: var(--primary-color); font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; flex: 1; }

    /* –ú–æ–¥–∞–ª–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Å–Ω–∏ */
    #lyrics-text-modal { z-index: 110; }
      #lyrics-text-modal .lyrics-modal {
          position: relative;
          /* –®–∏—Ä–∏–Ω–∞ –ø–æ —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–≤ ch) + –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã, —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ */
          width: min( calc(var(--lyrics-modal-ch, 64) * 1ch + 48px), 96vw, 960px );
          max-width: min( calc(var(--lyrics-modal-ch, 64) * 1ch + 48px), 96vw, 960px );
          height: min(92vh, 820px);
          background: var(--modal-bg);
          border: 1px solid rgba(255,255,255,.1);
          border-radius: 16px;
          box-shadow: 0 10px 32px rgba(0,0,0,.6);
          overflow: hidden;
          display: flex;
          flex-direction: column;
          padding: 12px;
        }
    @media (max-width: 600px) {
      #lyrics-text-modal .lyrics-modal { width: 100vw; max-width: 100vw; border-radius: 16px; }
    }
    #lyrics-text-modal .lyrics-animated-bg {
      position: absolute; inset: 0; opacity: .5;
      background: linear-gradient(45deg, rgba(232,1,0,0.15), rgba(77,170,255,0.15), rgba(232,1,0,0.15));
      background-size: 400% 400%;
      animation: lyricsGradient 10s ease infinite;
      pointer-events: none; z-index: 0;
    }
    .lyrics-modal-header { position: relative; z-index: 1; display: flex; align-items: center; gap: 10px; padding: 4px 4px 8px 4px; border-bottom: 1px solid rgba(255,255,255,.08); background: linear-gradient(180deg, rgba(255,255,255,.03), transparent); }
    .lyrics-modal-title { font-size: 1.2rem; font-weight: 800; letter-spacing: .02em; color: #e7f0ff; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .lyrics-modal-close { background: none; border: none; color: #cfe3ff; cursor: pointer; border-radius: 10px; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; transition: transform .15s ease; z-index: 1; }
    .lyrics-modal-close:hover { transform: scale(1.05); }
    .lyrics-modal-close svg { width: 28px; height: 28px; }

    .lyrics-modal-content { position: relative; z-index: 1; flex: 1; display: flex; min-height: 0; padding: 8px 4px 8px 4px; }
    .lyrics-modal-scroll { position: relative; flex: 1; min-height: 0; overflow: auto; border-radius: 10px; border: 1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.25); padding: 10px; }
    .lyrics-modal-pre { margin: 0; color: #eef4ff; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 1rem; line-height: 1.5; white-space: pre; word-break: normal; overflow-wrap: normal; }

    .lyrics-modal-buttons { position: relative; z-index: 1; display: flex; flex-direction: column; gap: 8px; padding: 8px 4px 4px 4px; border-top: 1px solid rgba(255,255,255,.08); background: linear-gradient(0deg, rgba(255,255,255,.03), transparent); }
    .lyrics-modal-btn { padding: 12px 16px; border: none; border-radius: 10px; font-weight: 800; letter-spacing: .02em; cursor: pointer; color: var(--text-color); background: rgba(255,255,255,.12); transition: transform .12s ease, opacity .2s ease; }
    .lyrics-modal-btn.primary { background: none; color: var(--secondary-color); text-decoration: underline; }
    .lyrics-modal-btn:hover { opacity: .9; transform: translateY(-1px); }
    .lyrics-controls-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; align-items: center; }
    .lyrics-square-btn { height: 42px; border-radius: 10px; border: 1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.1); color: #cfe3ff; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: transform .12s ease, opacity .2s ease; }
    .lyrics-square-btn:hover { opacity: .95; transform: translateY(-1px); }
    .lyrics-square-btn svg { width: 22px; height: 22px; }
    .lyrics-modal:fullscreen { width: 100vw !important; max-width: 100vw !important; height: 100dvh !important; border-radius: 0 !important; margin: 0 !important; padding: 12px !important; }
    .lyrics-modal:fullscreen .lyrics-modal-content { flex: 1 1 auto; }

    /* –ö–ª–∏–∫ –ø–æ –ø–æ–¥–ª–æ–∂–∫–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ */
    #lyrics-text-modal.active { display: flex; }
    #lyrics-text-modal { align-items: center; justify-content: center; }
  </style>
  <script src="./performance/rum.js" defer></script>
  <script>
    // RUM init (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ rumEndpoint) + –ø–µ—Ä–µ–¥–∞—á–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏ –∏ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ Service Worker
    (function(){
      async function postConfigToSW(cfg) {
        try {
          const msg = { type: 'CONFIG_UPDATE', config: { sw: (cfg && cfg.sw) ? cfg.sw : {} } };
          const doPost = () => {
            const t = navigator.serviceWorker?.controller || null;
            if (t) t.postMessage(msg);
            else navigator.serviceWorker?.ready?.then(reg => reg.active && reg.active.postMessage(msg)).catch(()=>{});
          };
          doPost();
        } catch {}
      }
      async function initRumIfConfigured() {
        try {
          const r = await fetch('./custom.json', { cache: 'no-store' });
          if (!r.ok) return;
          const cfg = await r.json().catch(()=>null);
          // RUM
          const ep = (cfg && (cfg.rumEndpoint || (cfg.rum && cfg.rum.endpoint))) || '';
          if (typeof initRUM === 'function' && ep) {
            window.__rumEndpoint = ep;
            initRUM({ endpoint: ep, sampleRate: 1.0 });
          }
          // –û—Ç–ø—Ä–∞–≤–∏–º sw-–∫–æ–Ω—Ñ–∏–≥
          await postConfigToSW(cfg);
        } catch {}
      }
      function sendNetStateToSW() {
        try {
          const c = navigator.connection || navigator.webkitConnection || navigator.mozConnection || {};
          const state = {
            saveData: !!c.saveData,
            downlink: typeof c.downlink === 'number' ? c.downlink : null,
            effectiveType: c.effectiveType || null
          };
          const post = () => navigator.serviceWorker.controller && navigator.serviceWorker.controller.postMessage({ type: 'NET_STATE', state });
          if (navigator.serviceWorker && navigator.serviceWorker.controller) post();
          else if (navigator.serviceWorker && navigator.serviceWorker.ready) navigator.serviceWorker.ready.then(()=>post()).catch(()=>{});
        } catch {}
      }
      window.addEventListener('load', () => {
        initRumIfConfigured();
        sendNetStateToSW();
        try {
          const c = navigator.connection;
          if (c && c.addEventListener) c.addEventListener('change', sendNetStateToSW);
        } catch {}
        window.addEventListener('online', sendNetStateToSW);
        window.addEventListener('offline', sendNetStateToSW);
      });
    })();
  </script>
</head>
<body>
  <!-- –ü—Ä–æ–º–æ–∫–æ–¥ -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn" onclick="checkPromo()">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons" aria-label="–ê–ª—å–±–æ–º—ã"></div>
      <select id="album-select" aria-label="–í—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞" style="display:none;"></select>

      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <div id="cover-slot" aria-label="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞"></div>

        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <div id="now-playing" style="width:100%; max-width:395px; margin:8px auto 0 auto;"></div>
    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">
      <button class="filter-favorites-btn" id="filter-favorites-btn" onclick="toggleFavoritesFilter()">–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏</button>
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onclick="handleLogoClick()"/>

      <button id="install-pwa-btn" style="display: none;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï</button>
      <button id="download-album-main">–°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú</button>

<button class="hotkeys-btn" id="hotkeys-btn" style="display:none;">–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</button>
<button class="hotkeys-btn" id="sysinfo-btn" style="display:none;">–û –°–ò–°–¢–ï–ú–ï</button>
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">ONLINE</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∏: –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å -->
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" data-action="close-feedback" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div style="font-size:1.12em;font-weight:700;margin-bottom:10px;">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
      <div style="color:#cfe3ff; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:12px;">
        –†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Telegram: <a href="https://t.me/vitrina_razbita" target="_blank" rel="noopener">@vitrina_razbita</a>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
  <div class="modal-bg" id="download-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <div class="download-modal-title">–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º?</div>
      <div style="margin-bottom:19px;font-size:.98em;" id="download-modal-filename"></div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="downloadCurrentTrack()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="shareCurrentTrack()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openInAppCurrentTrack()">–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="copyLinkCurrentTrack()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openAlbumDownloadModal()">–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å –∞–ª—å–±–æ–º</button>
      <button class="offline-btn" style="width:98%;" onclick="closeDownloadModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div class="modal-bg" id="albumDownloadModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h2 style="text-align: center; margin-bottom: 25px;" id="album-title-modal">–ê–ª—å–±–æ–º</h2>
      <div class="download-options">
        <label class="checkbox-container"><input type="checkbox" id="includeCovers" checked><span class="checkmark"></span>–û–±–ª–æ–∂–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)</label>
        <label class="checkbox-container"><input type="checkbox" id="includeLyrics" checked><span class="checkmark"></span>–¢–µ–∫—Å—Ç—ã –ø–µ—Å–µ–Ω</label>
        <hr style="margin: 15px 0; border-color: #333;">
        <label class="checkbox-container"><input type="checkbox" id="onlyFavorites"><span class="checkmark"></span>–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏</label>
        <label class="checkbox-container"><input type="checkbox" id="fullAlbum" checked><span class="checkmark"></span>–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–ª—å–±–æ–º</label>
      </div>
      <div class="modal-buttons">
        <button onclick="closeAlbumDownloadModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="prepareDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="sizeConfirmModal">
    <div class="modal-feedback" style="max-width: 350px;">
      <h3 style="text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
      <div class="size-info">
        <div style="font-size: 48px; color: #E80100; margin-bottom: 15px;">üì¶</div>
        <p style="font-size: 18px; margin: 10px 0;">–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: <strong id="archiveSize">0 –ú–ë</strong></p>
        <p style="color: #888; font-size: 14px;">–§–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: <span id="fileCount">0</span></p>
      </div>
      <div class="modal-buttons">
        <button onclick="closeSizeConfirmModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="startDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="downloadProgressModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h3 style="text-align: center; margin-bottom: 20px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞</h3>
      <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
      <p id="progressText" style="text-align: center; margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/0</p>
      <div id="errorsList" style="display: none; color: #ff6b6b; font-size: 14px; margin-top: 15px;">
        <p><strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å:</strong></p>
        <ul id="errorsListContent"></ul>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Å–Ω–∏ -->
  <div class="modal-bg" id="lyrics-text-modal">
    <div class="lyrics-modal" role="dialog" aria-modal="true" aria-labelledby="lyrics-modal-title">
      <div class="lyrics-animated-bg"></div>
      <div class="lyrics-modal-header"><div class="lyrics-modal-title" id="lyrics-modal-title">–¢—Ä–µ–∫</div></div>
      <div class="lyrics-modal-content">
        <div class="lyrics-modal-scroll"><pre class="lyrics-modal-pre" id="lyrics-modal-pre"></pre></div>
      </div>
      <div class="lyrics-modal-buttons">
        <button class="lyrics-modal-btn primary bigcopy" type="button" data-action="copy-lyrics">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞</button>
        <div class="lyrics-controls-grid">
          <button class="lyrics-square-btn" type="button" title="–£–º–µ–Ω—å—à–∏—Ç—å" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å" data-action="zoom--">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><rect x="7" y="9" width="5" height="1.8" rx=".9"></rect></svg>
          </button>
          <button class="lyrics-square-btn" id="lyrics-fs-btn" type="button" title="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º" aria-label="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º" data-action="fs-toggle">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 10V3h7v2H5v5H3zm16-5h-5V3h7v7h-2V5zM5 19h5v2H3v-7h2v5zm16-5h2v7h-7v-2h5v-5z"/></svg>
          </button>
          <button class="lyrics-square-btn" type="button" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" data-action="share-lyrics">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M14 9l-4-4v3H5v2h5v3l4-4zM19 13v5H5v-5H3v7h18v-7h-2z"/></svg>
          </button>
          <button class="lyrics-square-btn" type="button" title="–£–≤–µ–ª–∏—á–∏—Ç—å" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å" data-action="zoom++">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><path d="M10.4 7.7h-1.8v1.8H6.8v1.8h1.8v1.8h1.8v-1.8h1.8V9.5h-1.8V7.7z"/></svg>
          </button>
        </div>
        <button class="lyrics-modal-btn" type="button" data-action="close-lyrics-modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à -->
  <div class="modal-bg" id="hotkeys-modal">
    <div class="modal-feedback hotkeys-modal">
      <button class="bigclose" onclick="closeHotkeysModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <h2>üìå –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</h2>
      <div class="hotkeys-section">
        <h3>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
        <div class="hotkey-item"><span class="hotkey-combo">K / –ü—Ä–æ–±–µ–ª</span><span class="hotkey-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">X</span><span class="hotkey-desc">–°—Ç–æ–ø</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">N</span><span class="hotkey-desc">–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">P</span><span class="hotkey-desc">–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">J / L</span><span class="hotkey-desc">–ü–µ—Ä–µ–º–æ—Ç–∫–∞ ‚Üê10—Å–µ–∫ / 10—Å–µ–∫‚Üí</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">+ / -</span><span class="hotkey-desc">–ì—Ä–æ–º–∫–æ—Å—Ç—å ¬±10%</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>üéµ –†–µ–∂–∏–º—ã</h3>
        <div class="hotkey-item"><span class="hotkey-combo">R</span><span class="hotkey-desc">–ü–æ–≤—Ç–æ—Ä</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">U</span><span class="hotkey-desc">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">F</span><span class="hotkey-desc">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">M</span><span class="hotkey-desc">–ë–µ–∑ –∑–≤—É–∫–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">T</span><span class="hotkey-desc">–¢–∞–π–º–µ—Ä —Å–Ω–∞</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>‚ú® –≠—Ñ—Ñ–µ–∫—Ç—ã</h3>
        <div class="hotkey-item"><span class="hotkey-combo">A</span><span class="hotkey-desc">–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">B</span><span class="hotkey-desc">–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">1 / 2 / 3</span><span class="hotkey-desc">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (100%/50%/15%)</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
        <div class="hotkey-item"><span class="hotkey-combo">Y</span><span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ä–∏–∫—É</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">W</span><span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">D</span><span class="hotkey-desc">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">?</span><span class="hotkey-desc">–≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">Esc</span><span class="hotkey-desc">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</span></div>
      </div>
    </div>
  </div>

  <!-- –ü—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥ –æ—Ñ—Ñ–ª–∞–π–Ω –º–æ–¥–∞–ª–∫–∏ -->
  <div class="modal-bg" id="modal-offline"></div>
<script>
  /* ====== –í–µ—Ä—Å–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ====== */
  const VERSION = '8.0.3';
  const BUILD_DATE = '2025-11-08';
  const PROMO_CODE = 'VITRINA2025';

  /* ====== –°–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤: fallback ====== */
  const ALBUMS_FALLBACK = [
    { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º (2025)', base: 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/' },
    { key: 'golos-dushi',          title: '–ì–æ–ª–æ—Å –î—É—à–∏',                base: 'https://apel-s-in.github.io/vi3na1bita-golos-dushi/' },
    { key: 'krevetochka',          title: '–ö–†–ï–í–ï„ÉÑTOCHKA',             base: 'https://apel-s-in.github.io/krevetochka/' }
  ];

  /* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ ====== */
  let albumsIndex = [];
  let currentAlbumKey = null;
  let albumBase = '';
  let config = null;

  /* –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–µ–¥–∏–Ω—ã–π –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∏ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª) */
  let playingAlbumKey = null;
  /* legacy shuffle state removed ‚Äî PlayerCore —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ—á–µ—Ä–µ–¥—å—é */
  // let playingShuffledPlaylist = [];
  // let playingShuffleIndex = 0;
  let playingTrack = -1;

  function isBrowsingOtherAlbum() {
    const lp = document.getElementById('lyricsplayerblock');
    if (!playingAlbumKey || !lp) return false;
    if (viewMode === 'favorites') return playingAlbumKey !== SPECIAL_FAVORITES_KEY;
    if (viewMode === 'reliz') return true;
    return !!(currentAlbumKey && playingAlbumKey !== currentAlbumKey);
  }

  /* ====== –ì–∞–ª–µ—Ä–µ—è ‚Äî –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/gallery.js ====== */
  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–¥—É–ª–µ–º –≥–∞–ª–µ—Ä–µ–∏)
  const CENTRAL_GALLERY_BASE = './albums/gallery/';

  const ALBUM_GALLERY_MAP = {
    'krevetochka': '00',
    'mezhdu-zlom-i-dobrom': '01',
    'golos-dushi': '02',
    '__reliz__': 'news'
  };
  const CENTRAL_ALLOWED_IDS = new Set(['00','01','02','news']);
  const PUBLISHED_ALBUM_KEYS = new Set(['golos-dushi','mezhdu-zlom-i-dobrom','krevetochka']);

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ (—á–∏—Ç–∞–µ—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –º–æ–¥—É–ª–µ–º –≥–∞–ª–µ—Ä–µ–∏)
  let coverGalleryArr = [];
  let coverGalleryIdx = 0;
  let coverAutoplay = null;
  let galleryRotationStarted = false;

  // –£—Ç–∏–ª–∏—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç—è—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  function normalizeBase(b) {
    try {
      const hasScheme = /^[a-z]+:\/\//i.test(String(b));
      const u = new URL(String(b), hasScheme ? undefined : (location.origin + '/'));
      return u.origin + u.pathname.replace(/\/+$/, '');
    } catch {
      const s = String(b || '').replace(/[?#].*$/, '').replace(/\/+$/, '');
      if (/^https?:\/\//i.test(s)) return s;
      return location.origin + '/' + s.replace(/^\/+/, '');
    }
  }
  function absJoin(base, rel) {
    try { return new URL(String(rel || ''), normalizeBase(base) + '/').toString(); }
    catch {
      const norm = normalizeBase(base);
      return norm + '/' + String(rel || '').replace(/^\/+/, '');
    }
  }
  function albumOrderIndexStr(albumKey) {
    try {
      const i = (albumsIndex || []).findIndex(a => a && a.key === albumKey);
      if (i < 0) return null;
      return String(i + 1).padStart(2, '0');
    } catch { return null; }
  }
  function centralIdForAlbumKey(albumKey) {
    if (!albumKey) return null;
    if (albumKey === '__favorites__') return null;
    const id = ALBUM_GALLERY_MAP[albumKey] || null;
    return id && CENTRAL_ALLOWED_IDS.has(id) ? id : null;
  }
  </script>

  <script>
  /* ====== –ò–∫–æ–Ω–∫–∏/—Ä–µ–∂–∏–º—ã ====== */
  const SPECIAL_FAVORITES_KEY = '__favorites__';
  const SPECIAL_RELIZ_KEY = '__reliz__';
  let viewMode = 'album';

  const ICON_ALBUMS_ORDER = [
    { key: SPECIAL_FAVORITES_KEY,  title: '‚≠ê‚≠ê‚≠ê–ò–ó–ë–†–ê–ù–ù–û–ï‚≠ê‚≠ê‚≠ê', icon: 'img/icon_album/icon-album-00.png' },
    { key: 'golos-dushi',          title: '–ì–æ–ª–æ—Å –î—É—à–∏',            icon: 'img/icon_album/icon-album-02.png' },
    { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º',   icon: 'img/icon_album/icon-album-01.png' },
    { key: 'krevetochka',          title: '–ö–†–ï–í–ï„ÉÑTOCHKA',         icon: 'img/icon_album/icon-album+00.png' },
    { key: SPECIAL_RELIZ_KEY,      title: '–ù–û–í–û–°–¢–ò',               icon: 'img/icon_album/icon-album-news.png' }
  ];
  const ICON_KEY_ALIASES = {
    'golos-dushi': ['golos', 'golos-dushi'],
    'mezhdu-zlom-i-dobrom': ['mzid', 'mezhdu-zlom-i-dobrom'],
    'krevetochka': ['krevetochka']
  };
  const ICON_TITLE_MAP = {
    'golos-dushi': '–ì–æ–ª–æ—Å –î—É—à–∏',
    'mezhdu-zlom-i-dobrom': '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º',
    'krevetochka': '–ö–†–ï–í–ï„ÉÑTOCHKA'
  };
  function albumByKey(key) { return albumsIndex.find(a => a.key === key) || null; }
  function resolveRealAlbumKey(iconKey) {
    if (albumByKey(iconKey)) return iconKey;
    const aliases = ICON_KEY_ALIASES[iconKey] || [];
    for (const k of aliases) if (albumByKey(k)) return k;
    const expectedTitle = ICON_TITLE_MAP[iconKey];
    if (expectedTitle) {
      const found = albumsIndex.find(a => String(a.title).toLowerCase().includes(expectedTitle.toLowerCase()));
      if (found) return found.key;
    }
    return null;
  }

  function isMobileUA() { try { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); } catch { return false; } }
  function isIOSStandalone() {
    try {
      const iOS = /iP(hone|od|ad)/i.test(navigator.userAgent);
      const standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      return iOS && !!standalone;
    } catch { return false; }
  }
  function buildAlbumIcons(){
    const box = document.getElementById('album-icons'); 
    if (!box) return;

    const isMob = isMobileUA();
    const html = ICON_ALBUMS_ORDER.map(it=>{
      let dataKey = it.key;
      if (it.key !== SPECIAL_FAVORITES_KEY && it.key !== SPECIAL_RELIZ_KEY) {
        const real = resolveRealAlbumKey(it.key);
        dataKey = real || '__unknown__';
      }
      const title = it.title || '';
      const baseIcon = it.icon || 'img/logo.png';
      const path1x = isMob
        ? baseIcon.replace(/icon_album\/(.+)\.png$/i, 'icon_album/mobile/$1@1x.jpg')
        : baseIcon.replace(/\.png$/i, '@1x.png');
      const path2x = isMob
        ? path1x.replace(/@1x\.jpg$/i, '@2x.jpg')
        : path1x.replace(/@1x\.png$/i, '@2x.png');

      return `<div class="album-icon" data-akey="${dataKey}" data-icon="${it.key}" title="${title}">
        <img loading="lazy" src="${path1x}" srcset="${path2x} 2x" alt="${title}" width="60" height="60">
      </div>`;
    }).join('');

    box.innerHTML = html;
    box.querySelectorAll('.album-icon').forEach(el=>{
      el.onclick = ()=> onAlbumIconClick(el.getAttribute('data-akey'));
    });

    setActiveAlbumIcon(currentAlbumKey || document.getElementById('album-select')?.value || (albumsIndex[0]?.key || ''));
  }
  function setActiveAlbumIcon(key){
    const box = document.getElementById('album-icons'); 
    if (!box) return;
    box.querySelectorAll('.album-icon').forEach(el=>{
      const k = el.getAttribute('data-akey');
      el.classList.toggle('active', k && key && k === key);
    });
  }
  function setAlbumHeaderTitle(key) {
    const el = document.getElementById('active-album-title');
    if (!el) return;
    let title = '‚Äî';
    let cls = '';

    if (key === SPECIAL_FAVORITES_KEY) { title = '‚òÖ ‚òÖ ‚òÖ –ò–ó–ë–†–ê–ù–ù–û–ï ‚òÖ ‚òÖ ‚òÖ'; cls = 'fav'; }
    else if (key === SPECIAL_RELIZ_KEY) { title = '–ù–û–í–û–°–¢–ò'; cls = 'news'; }
    else { const meta = albumByKey(key); title = meta?.title || (config?.albumName || '–ê–ª—å–±–æ–º'); }

    el.textContent = title;
    el.title = title;
    el.className = 'active-album-title' + (cls ? (' ' + cls) : '');
  }
  function onAlbumIconClick(key){
    if (key === SPECIAL_FAVORITES_KEY) { openFavoritesView(); setActiveAlbumIcon(key); setAlbumHeaderTitle(SPECIAL_FAVORITES_KEY); return; }
    if (key === SPECIAL_RELIZ_KEY) { openRelizView(); setActiveAlbumIcon(key); setAlbumHeaderTitle(SPECIAL_RELIZ_KEY); return; }

    if (!key || key === '__unknown__') {
      const real = resolveRealAlbumKey(key);
      if (real) key = real;
    }
    const meta = albumByKey(key);
    if (!meta) { NotificationSystem.error('–ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

    // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π –∞–ª—å–±–æ–º –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≥–∞–ª–µ—Ä–µ–∏
    if (viewMode === 'album' && key === currentAlbumKey) {
      __currentGalleryVisible = !__currentGalleryVisible;
      setCoverWrapVisible(__currentGalleryVisible);
      setActiveAlbumIcon(key);
      setAlbumHeaderTitle(key);
      return;
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∞–ª—å–±–æ–º
    applyRelizUiMode(false);
    viewMode = 'album';
    clearRelizView();
    document.getElementById('track-list').style.display = '';
    document.getElementById('cover-wrap').style.display = '';

    const sel = document.getElementById('album-select'); if (sel) sel.value = key;
    setActiveAlbumIcon(key);

    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞—Ö–æ–¥–∏–º —Å –æ—Ç–∫—Ä—ã—Ç–æ–π –≥–∞–ª–µ—Ä–µ–µ–π
    __currentGalleryVisible = true;
    setCoverWrapVisible(true);

    loadAlbumByKey(key).then(()=> setAlbumHeaderTitle(key));
  }

  /* ====== –ü—Ä–æ–º–æ–∫–æ–¥ ====== */
  function checkPromo() {
    const inp = document.getElementById('promo-inp');
    const err = document.getElementById('promo-error');
    const val = (inp?.value || '').trim();
    if (!val) { if (err) err.innerText = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥'; return; }
    if (val.toUpperCase() === PROMO_CODE.toUpperCase()) {
      localStorage.setItem('promoPassed', '1'); showMain();
    } else {
      if (err) err.innerText = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë!';
    }
  }
  document.getElementById('promo-inp').addEventListener('keydown', e => { if (e.key === 'Enter') checkPromo(); });

  /* ====== –°–ª—É–∂–µ–±–Ω—ã–µ ====== */
  function applyLogos() {
    try {
      const logoBottom = document.getElementById('logo-bottom');
      if (logoBottom) logoBottom.src = pickLogoUrl();
      const promo = document.getElementById('promo-cover');
      if (promo) promo.src = pickLogoUrl();
    } catch {}
  }
  function pickLogoUrl() {
    const dpr = window.devicePixelRatio || 1;
    const mobile = isMobileUA() || (Math.min(screen.width, screen.height) <= 820);
    if (mobile) return dpr >= 2 ? 'img/mobile/logo@2x.jpg' : 'img/mobile/logo@1x.jpg';
    if (dpr >= 3) return 'img/desktop/logo@3x.png';
    if (dpr >= 2) return 'img/desktop/logo@2x.png';
    return 'img/desktop/logo@1x.png';
  }
  function hasKeyboard() {
    try {
      const isDesktop = !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const hasPointer = matchMedia('(pointer: fine)').matches;
      const canHover = matchMedia('(hover: hover)').matches;
      const noTouch = (navigator.maxTouchPoints || 0) === 0;
      return (isDesktop && hasPointer) || (canHover && noTouch);
    } catch { return true; }
  }
  function showMain() {
    document.getElementById('promocode-block').classList.add('hidden');
    document.getElementById('main-block').classList.remove('hidden');
    initializeMainUi();
  }

  /* ====== –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–ª—å–±–æ–º–æ–≤ ====== */
  async function loadAlbumsIndex() {
    const sel = document.getElementById('album-select');
    try {
      const r = await fetch('./albums.json', { cache:'no-cache' });
      const j = await r.json();
      albumsIndex = Array.isArray(j.albums) ? j.albums : [];
      if (!albumsIndex.length) throw new Error('empty index');
    } catch(e) {
      albumsIndex = ALBUMS_FALLBACK.slice();
    }
    sel.innerHTML = albumsIndex.map(a => `<option value="${a.key}">${a.title}</option>`).join('');

    const first = albumsIndex[0];
    if (first) document.getElementById('promo-cover').src = 'img/logo.png';

    buildAlbumIcons();
    setActiveAlbumIcon(document.getElementById('album-select')?.value || albumsIndex[0]?.key || '');
  }

  /* ====== –ó–∞–≥—Ä—É–∑–∫–∞/–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞ ====== */
  const albumConfigCache = {}; // { key: { base, config } }
  let __albumLoadCtrl = null;
  let __currentGalleryVisible = true;

  async function loadAlbumByKey(key) {
    const meta = albumByKey(key);
    if (!meta) { NotificationSystem.error('–ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

    // –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–ª—å–±–æ–º–∞
    if (typeof gc === 'function') gc(); // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω garbage collector
    
    resetGallery();
    
    // –û—á–∏—â–∞–µ–º –∫—ç—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    if (prefetchedUrls.size > 0) prefetchedUrls.clear();

    currentAlbumKey = key;
    const base = normalizeBase(meta.base);
    albumBase = base;
    localStorage.setItem('currentAlbum', currentAlbumKey);

    try { __albumLoadCtrl?.abort(); } catch {}
    __albumLoadCtrl = new AbortController();
    const signal = __albumLoadCtrl.signal;

    ensureQuickCoverForAlbum({ key, base });

    if (albumConfigCache[key]?.config) {
      const cached = albumConfigCache[key];
      await applyAlbumConfig(cached.base, cached.config, { skipCovers: true, signal });

      buildCoverGalleryList(key, base, signal).then(gal => {
        if (signal.aborted) return;
        if (Array.isArray(gal) && gal.length) {
          coverGalleryArr = gal;
        } else {
          coverGalleryArr = [{ type:'img', src: 'img/logo.png', formats: { full: 'img/logo.png' }, ar: 1 }];
        }
        coverGalleryIdx = 0;
        setCoverImage(0);
        showGalleryNav();
        if (!galleryRotationStarted) setTimeout(() => { if (!signal.aborted) startCoverAutoPlay(); }, 5000);
      }).catch(()=>{});
      warmupOtherAlbums(key);
      return;
    }

    try {
      const resp = await fetch(absJoin(base, 'config.json'), { cache: 'no-cache', signal });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      if (!Array.isArray(data.tracks)) {
        try { NotificationSystem && NotificationSystem.error('config.json: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Å—Å–∏–≤ tracks[]'); } catch {}
        data.tracks = [];
      }
      data.tracks.forEach((t, i) => {
        const titleSafe = t && t.title ? t.title : `–¢—Ä–µ–∫ #${i+1}`;
        if (!t.audio) {
          try { NotificationSystem && NotificationSystem.warning(`config.json: —É ¬´${titleSafe}¬ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ audio`); } catch {}
        }
        if (t.audio) t.audio = absJoin(base, t.audio);
        if (t.lyrics) t.lyrics = absJoin(base, t.lyrics);
        if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
      });
      albumConfigCache[key] = { base, config: data };
      await applyAlbumConfig(base, data, { skipCovers: true, signal });

      try {
        const gal = await buildCoverGalleryList(currentAlbumKey, base, signal);
        if (signal.aborted) return;
        coverGalleryArr = (Array.isArray(gal) && gal.length) ? gal
                          : [{ type:'img', src: 'img/logo.png', formats: { full: 'img/logo.png' }, ar: 1 }];
        coverGalleryIdx = 0;
        setCoverImage(0);
        showGalleryNav();
        if (!galleryRotationStarted) setTimeout(() => { if (!signal.aborted) startCoverAutoPlay(); }, 5000);
      } catch {
        if (signal.aborted) return;
        coverGalleryArr = [{ type:'img', src: 'img/logo.png', formats: { full: 'img/logo.png' }, ar: 1 }];
        coverGalleryIdx = 0;
        setCoverImage(0); showGalleryNav();
        if (!galleryRotationStarted) setTimeout(() => { if (!signal.aborted) startCoverAutoPlay(); }, 5000);
      }

      warmupOtherAlbums(key);
    } catch(e) {
      if (signal.aborted) return;
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å config.json –∞–ª—å–±–æ–º–∞:', e);
      NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º');
      // –ï—Å–ª–∏ –∞–ª—å–±–æ–º ¬´–Ω–µ –≤—ã—à–µ–ª¬ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
      try {
        const meta = albumByKey(key);
        renderComingSoonPlaceholder(meta?.title || '–ê–ª—å–±–æ–º');
      } catch {}
    } finally {
      setActiveAlbumIcon(currentAlbumKey);
      setCoverWrapVisible(__currentGalleryVisible);
      setAlbumHeaderTitle(currentAlbumKey);
    }
  }

  async function applyAlbumConfig(base, data, { skipCovers = false, signal } = {}) {
    try {
      if (data.background) {
        const attach = isMobileUA() ? '' : ' fixed';
        document.body.style.background = `url(${absJoin(base, data.background)}) center/cover${attach} #111`;
      } else {
        document.body.style.background = `#181818`;
      }
    } catch {}

    config = data;
    if (!Array.isArray(config.tracks)) config.tracks = [];

    if (!skipCovers) {
      try {
        const gal = await buildCoverGalleryList(currentAlbumKey, base, signal);
        coverGalleryArr = (Array.isArray(gal) && gal.length) ? gal : [{ type:'img', src: 'img/logo.png', formats:{full:'img/logo.png'}, ar:1 }];
      } catch {
        coverGalleryArr = [{ type:'img', src: 'img/logo.png', formats:{full:'img/logo.png'}, ar:1 }];
      }
      if (!signal?.aborted) {
        coverGalleryIdx = 0; setCoverImage(coverGalleryIdx);
        showGalleryNav();
        if (!galleryRotationStarted) setTimeout(() => { if (!signal?.aborted) startCoverAutoPlay(); }, 5000);
      }
    }

    try { document.getElementById('support-link').href = (config.donateLink || '#'); } catch {}
    try { document.getElementById('album-title-modal').textContent = (config.albumName || '–ê–ª—å–±–æ–º'); } catch {}
    buildSocials();

    (function preservePlayer() {
      try {
        const lp = document.getElementById('lyricsplayerblock');
        const holder = document.getElementById('now-playing');
        if (lp && holder && !holder.contains(lp)) {
          holder.innerHTML = '';
          holder.appendChild(lp);
        }
      } catch {}
    })();


    buildTrackList();
    updateAvailableTracks();
    applyMiniModeUI();
    updateNextUpLabel();
    updateMiniNowHeader();
    parseDeepLink();
    try { updatePlayerCorePlaylistFromConfig(); } catch {}
  }

  /* –ü—Ä–æ–≥—Ä–µ–≤ —Å–æ—Å–µ–¥–Ω–∏—Ö –∞–ª—å–±–æ–º–æ–≤ */
  async function warmupOtherAlbums(currentKey) {
    try {
      const list = (albumsIndex || []).map(a => a.key);
      const pos = list.indexOf(currentKey);
      const neigh = [list[pos - 1], list[pos + 1]].filter(Boolean);

      for (const key of neigh) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∞–ª—å–±–æ–º—ã, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ª—É—á–∞—Ç—å 404 –≤ –∫–æ–Ω—Å–æ–ª–∏
        if (!PUBLISHED_ALBUM_KEYS.has(key)) continue;

        if (albumConfigCache[key]?.config) continue;
        const meta = albumByKey(key);
        if (!meta) continue;
        const base = normalizeBase(meta.base);

        // –ö–æ–Ω—Ñ–∏–≥ –∞–ª—å–±–æ–º–∞ (best-effort, –±–µ–∑ —à—É–º–Ω—ã—Ö –æ—à–∏–±–æ–∫)
        try {
          const r = await fetch(absJoin(base, 'config.json'), { cache: 'force-cache' });
          if (r && r.ok) {
            const data = await r.json();
            (data.tracks || []).forEach(t => {
              t.audio = absJoin(base, t.audio);
              t.lyrics = absJoin(base, t.lyrics);
              if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
            });
            albumConfigCache[key] = { base, config: data };
          }
        } catch {}

        // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ id –≤—Ö–æ–¥–∏—Ç –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫
        try {
          const cid = centralIdForAlbumKey(key);
          if (cid) fetch(`${CENTRAL_GALLERY_BASE}${cid}/index.json`).catch(()=>{});
        } catch {}
      }
    } catch {}
  }

  /* –°–æ—Ü—Å–µ—Ç–∏ */
  function buildSocials() {
    const linksEl = document.getElementById('social-links');
    if (!config || !config.socials || !linksEl) { linksEl.innerHTML = ''; return; }
    linksEl.innerHTML = (config.socials || []).map(x => `<a href="${x.url}" target="_blank" rel="noopener">${x.title}</a>`).join(" ");
  }

  /* –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏ */
  function setCoverWrapVisible(visible){
    const cw = document.getElementById('cover-wrap');
    if (cw) cw.style.display = visible ? '' : 'none';
  }
  function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  }

  function initAudioContextForBackground() {
    try {
      // –°–æ–∑–¥–∞–µ–º AudioContext —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è iOS
      window.__audioContext = new (window.AudioContext || window.webkitAudioContext)({
        latencyHint: 'playback',
        sampleRate: 44100
      });
    
      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –±—É–¥–µ—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
      window.__audioContext.onstatechange = () => {
        if (window.__audioContext.state === 'suspended') {
          window.__audioContext.resume().catch(console.warn);
        }
      };
    
      // –°–æ–∑–¥–∞–µ–º "—Ç–∏—Ö–∏–π" –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –∞—É–¥–∏–æ –≤ —Ñ–æ–Ω–µ
      const oscillator = window.__audioContext.createOscillator();
      const gainNode = window.__audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(window.__audioContext.destination);
      gainNode.gain.value = 0.00001; // –ø–æ—á—Ç–∏ –±–µ—Å—à—É–º–Ω—ã–π
      oscillator.start(0);
    
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      window.__backgroundOscillator = oscillator;
      window.__backgroundGainNode = gainNode;
    
      console.log('iOS AudioContext initialized for background playback');
    } catch (e) {
      console.warn('Failed to initialize iOS AudioContext', e);
    }
  }

  function resumeAudioContextIfNeeded() {
    try {
      if (window.__audioContext && window.__audioContext.state === 'suspended') {
        window.__audioContext.resume().catch(console.warn);
      }
    } catch (e) {
      console.warn('Failed to resume audio context', e);
    }
  }
  // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –µ—â—ë –Ω–µ –≤—ã—à–µ–¥—à–µ–≥–æ –∞–ª—å–±–æ–º–∞ (–Ω–µ—Ç config.json)
  function renderComingSoonPlaceholder(title){
    try {
      const slot = document.getElementById('cover-slot');
      const list = document.getElementById('track-list');
      if (slot) {
        slot.replaceChildren();
        const box = document.createElement('div');
        box.style.cssText = 'display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#0f1219;color:#cfe3ff;font-weight:800;text-align:center;padding:16px;';
        box.innerHTML = `<div><div style="font-size:18px;margin-bottom:6px;">–°–∫–æ—Ä–æ —Ä–µ–ª–∏–∑</div><div style="opacity:.85;">${(title||'–ê–ª—å–±–æ–º')}</div></div>`;
        slot.appendChild(box);
      }
      if (list) {
        list.innerHTML = '<div style="text-align:center; opacity:.8; margin:10px 0;">–°–∫–æ—Ä–æ —Ä–µ–ª–∏–∑ ‚Äî —Ç—Ä–µ–∫–ª–∏—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
      }
    } catch {}
  }

  /* ¬´–ù–æ–≤–æ—Å—Ç–∏¬ª */
  async function openRelizView(){
    viewMode = 'reliz';
    setActiveAlbumIcon(SPECIAL_RELIZ_KEY);
    setAlbumHeaderTitle(SPECIAL_RELIZ_KEY);

    const list = document.getElementById('track-list');
    const cw = document.getElementById('cover-wrap');
    if (list) list.style.display = 'none';
    if (cw) cw.style.display = '';
    applyRelizUiMode(true);

    resetGallery();
    __currentGalleryVisible = true;
    setCoverWrapVisible(true);

    clearRelizView();
    let cont = document.getElementById('reliz-container');
    if (!cont) {
      cont = document.createElement('div');
      cont.id = 'reliz-container';
      const header = document.querySelector('header');
      header && header.insertAdjacentElement('afterend', cont);
    }
    cont.innerHTML = '';

    try {
      ensureQuickCoverForAlbum({ key: SPECIAL_RELIZ_KEY, base: location.origin + location.pathname });

      const ctrl = new AbortController();
      __albumLoadCtrl = ctrl;
      const signal = ctrl.signal;

      const gal = await buildCoverGalleryList(SPECIAL_RELIZ_KEY, location.origin + location.pathname, signal);

      if (signal.aborted) return;
      coverGalleryArr = (Array.isArray(gal) && gal.length) ? gal : [{ type:'img', src: 'img/logo.png', ar: 1 }];
      coverGalleryIdx = 0;
      setCoverImage(0);
      showGalleryNav();
      if (!galleryRotationStarted) setTimeout(() => { if (!signal.aborted) startCoverAutoPlay(); }, 5000);
    } catch (e) {
      console.error('–ù–æ–≤–æ—Å—Ç–∏: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –≥–∞–ª–µ—Ä–µ—é', e);
      coverGalleryArr = [{ type:'img', src: 'img/logo.png', ar: 1 }];
      coverGalleryIdx = 0;
      setCoverImage(0);
      showGalleryNav();
      if (!galleryRotationStarted) setTimeout(() => startCoverAutoPlay(), 5000);
    }

    try {
      const newsWrap = document.createElement('div');
      newsWrap.style.margin = '12px auto';
      newsWrap.style.maxWidth = '400px';
      newsWrap.innerHTML = `
        <iframe
          src="./news.html"
          title="–ù–æ–≤–æ—Å—Ç–∏ ‚Äî –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"
          style="width:100%; min-height: 800px; border:1px solid rgba(255,255,255,.1); border-radius:10px; background:#0b0e15;"
          loading="lazy"
          referrerpolicy="strict-origin-when-cross-origin"
          allow="encrypted-media; picture-in-picture; fullscreen">
        </iframe>`;
      cont.appendChild(newsWrap);
    } catch {}

    applyMiniModeUI();
  }
  function clearRelizView(){ const cont = document.getElementById('reliz-container'); if (cont) cont.remove(); }
  /* background handlers removed ‚Äî iOS/Android –∫–µ–π—Å—ã –≤–µ–¥–µ–º —á–µ—Ä–µ–∑ PlayerCore –∏ Visibility API */
  // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ initializeMainUi
  /* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI ====== */
  async function initializeMainUi() {
    (async () => {
      await loadAlbumsIndex();

      const sel = document.getElementById('album-select');
      const params = new URLSearchParams(location.search);
      const urlAlbum = params.get('album');
      const savedAlbum = localStorage.getItem('currentAlbum');
      const first = albumsIndex[0]?.key || null;

      const toLoad = urlAlbum && albumByKey(urlAlbum) ? urlAlbum
                    : (savedAlbum && albumByKey(savedAlbum) ? savedAlbum : first);

      if (toLoad) sel.value = toLoad;

      const startKey = (params.get('view') === 'favorites') ? SPECIAL_FAVORITES_KEY
                          : (params.get('view') === 'reliz') ? SPECIAL_RELIZ_KEY
                          : (toLoad || first);

      setAlbumHeaderTitle(startKey === SPECIAL_FAVORITES_KEY || startKey === SPECIAL_RELIZ_KEY ? startKey : (sel.value || startKey));
      setActiveAlbumIcon(startKey === SPECIAL_FAVORITES_KEY || startKey === SPECIAL_RELIZ_KEY ? startKey : sel.value);

      sel.onchange = () => {
        applyRelizUiMode(false);
        viewMode = 'album';
        clearRelizView();
        document.getElementById('track-list').style.display = '';
        document.getElementById('cover-wrap').style.display = '';
        setActiveAlbumIcon(sel.value);
        __currentGalleryVisible = true;
        setCoverWrapVisible(true);
        loadAlbumByKey(sel.value);
      };

      if (localStorage.getItem('promoPassed') === '1') {
        document.getElementById('promocode-block').classList.add('hidden');
        document.getElementById('main-block').classList.remove('hidden');

        try {
          shuffleMode = localStorage.getItem('shuffleMode') === '1';
          repeatMode = localStorage.getItem('repeatMode') === '1';
          favoritesOnlyMode = localStorage.getItem('favoritesOnlyMode') === '1';
          offlineMode = localStorage.getItem('offlineMode') === '1';
          animationEnabled = localStorage.getItem('animationEnabled') === '1';
          bitEnabled = localStorage.getItem('bitEnabled') === '1';
          const savedIntensity = localStorage.getItem('bitIntensity'); if (savedIntensity) bitIntensity = parseInt(savedIntensity);
          ultraEcoEnabled = localStorage.getItem('ultraEco') === '1';
          // –ü—Ä–∏–º–µ–Ω–∏–º —ç–∫–æ-–ø—Ä–æ—Ñ–∏–ª—å (—Ç–∏—Ö–æ): –∏–∑–º–µ–Ω–∏—Ç —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥–∏/–∞–Ω–∏–º–∞—Ü–∏–∏/–≥–∞–ª–µ—Ä–µ—é
          applyEcoState(ultraEcoEnabled, { silent: true });
        } catch {}

        await loadAlbumByKey(sel.value);
        try { warmupOtherAlbums(sel.value); } catch {}

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        const resumeRaw = sessionStorage.getItem('resumeAfterReloadV1');
        let resume = null;
        if (resumeRaw) {
          try { resume = JSON.parse(resumeRaw); } catch {}
          sessionStorage.removeItem('resumeAfterReloadV1');
        }

        const stBase = resume || PlayerState.restore();
        if (stBase && stBase.album && albumByKey(stBase.album)) {
          if (sel.value !== stBase.album) {
            sel.value = stBase.album;
            await loadAlbumByKey(stBase.album);
          }
        }
        if (stBase && Number.isInteger(stBase.trackIndex) && stBase.trackIndex >= 0 && stBase.trackIndex < (config.tracks || []).length) {
          showTrack(stBase.trackIndex, false);
          setTimeout(()=> {
            try { window.PlayerAdapter && window.PlayerAdapter.applyState && window.PlayerAdapter.applyState(stBase); } catch {}
            applyLyricsViewMode();
            PlayerState.save();
          }, 300);
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è
      try {
        applyEnergySaver(detectEnergySaver());
        const nc = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        if (nc && 'onchange' in nc) {
          nc.addEventListener('change', () => applyEnergySaver(detectEnergySaver()));
        }
        const mrm = matchMedia('(prefers-reduced-motion: reduce)');
        if (mrm && 'addEventListener' in mrm) {
          mrm.addEventListener('change', () => applyEnergySaver(detectEnergySaver()));
        }
      } catch {}

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –≥–∞–ª–µ—Ä–µ–∏
      const leftBtn  = document.getElementById('cover-gallery-arrow-left');
      const rightBtn = document.getElementById('cover-gallery-arrow-right');
      const galleryNavGuard = () => {
        if (energySaver) { NotificationSystem.info('–ì–∞–ª–µ—Ä–µ—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è'); return true; }
        if (document.hidden) { NotificationSystem.info('–ì–∞–ª–µ—Ä–µ—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ'); return true; }
        return false;
      };
      leftBtn.onclick = () => {
        if (galleryNavGuard()) return;
        if (!coverGalleryArr.length) return;
        setCoverImage(coverGalleryIdx - 1);
        startCoverAutoPlay();
      };
      rightBtn.onclick = () => {
        if (galleryNavGuard()) return;
        if (!coverGalleryArr.length) return;
        setCoverImage(coverGalleryIdx + 1);
        startCoverAutoPlay();
      };

      let startX = null;
      const el = document.getElementById('cover-wrap');
      el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, { passive: true });
      el.addEventListener('touchend', e => {
        if (startX === null) return;
        const dx = e.changedTouches[0].clientX - startX;
        if (Math.abs(dx) > 30) {
          if (!coverGalleryArr.length) { startX = null; return; }
          if (dx > 0) setCoverImage(coverGalleryIdx - 1); else setCoverImage(coverGalleryIdx + 1);
          startCoverAutoPlay();
        }
        startX = null;
      }, { passive: true });

      if (hasKeyboard()) {
        const hot = document.getElementById('hotkeys-btn');
        if (hot) hot.style.display = 'block';
      }

      // –û—Ç–∫—Ä—ã—Ç–∏–µ ¬´–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å¬ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ (—Å–º. scripts/ui/bindings.js)
      document.getElementById('modal-feedback').onclick = (e) => { if (e.target === e.currentTarget) closeFeedbackModal(); };

      // PWA install
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('install-pwa-btn');
        if (btn) btn.style.display = '';
      });
      document.getElementById('install-pwa-btn').onclick = async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.finally(() => {
            document.getElementById('install-pwa-btn').style.display = 'none';
            deferredPrompt = null;
          });
        } else {
          NotificationSystem.info('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA');
        }
      };

      detectIOSAndShowInstallGuide();

      // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–æ–Ω–æ–≤—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (freeze/resume –∏ –ø—Ä.)
      /* setupBackgroundEventHandlers: —É–¥–∞–ª–µ–Ω–æ ‚Äî –ø—É—Ç—å —á–µ—Ä–µ–∑ PlayerCore */
      // Service Worker + –º—è–≥–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
      if ('serviceWorker' in navigator) {
        function persistResumeBeforeReload() {
          try {
            const pc = window.playerCore;
            const wasPlaying = pc ? !!pc.isPlaying?.() : false;
            const st = {
              album: playingAlbumKey || currentAlbumKey || null,
              trackIndex: (typeof playingTrack === 'number' && playingTrack >= 0) ? playingTrack : currentTrack,
              position: pc ? Math.floor(pc.getSeek?.() || 0) : 0,
              volume: pc ? (pc.getVolume?.() ?? 1) : 1,
              wasPlaying
            };
            sessionStorage.setItem('resumeAfterReloadV1', JSON.stringify(st));
          } catch {}
        }

        function setupUpdateFlow(reg) {
          function onNewSWWaiting(sw) {
            // –ü–æ–ø—Ä–æ—Å–∏–º –≤–µ—Ä—Å–∏—é SW
            try { sw.postMessage({ type: 'GET_SW_VERSION' }); } catch {}
          }
          if (reg.waiting) onNewSWWaiting(reg.waiting);
          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                onNewSWWaiting(reg.waiting || sw);
              }
            });
          });
        }

        navigator.serviceWorker.register('./service-worker.js').then(async reg => {
          await navigator.serviceWorker.ready;
          // –ü—Ä–æ—Å–∏–º –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —á—Ç–æ–±—ã –∫—ç—à –Ω–µ –æ—á–∏—â–∞–ª–∏ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
          try { if (navigator.storage?.persist) navigator.storage.persist().catch(()=>{}); } catch {}
          syncOfflineState();
          try { reg.active && reg.active.postMessage({ type: 'REQUEST_OFFLINE_STATE' }); } catch(e){}
          try { reg.update(); } catch(e) {}
          setInterval(async () => {
            try { const r = await navigator.serviceWorker.getRegistration(); if (r) r.update(); } catch(e) {}
          }, 60 * 60 * 1000);
          setupUpdateFlow(reg);
        });

        navigator.serviceWorker.addEventListener('message', async (event) => {
          const msg = event.data || {};
          if (msg.type === 'OFFLINE_STATE') {
            offlineMode = !!msg.value;
            setOfflineUIState(offlineMode ? 'offline' : 'online');
            return;
          }
          if (msg.type === 'SW_VERSION') {
            const swVer = String(msg.version || '');
            if (swVer && swVer !== VERSION) {
              // –ü—Ä–µ–¥–ª–æ–∂–∏–º –æ–±–Ω–æ–≤–∏—Ç—å
              const agree = confirm(`–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–µ—Ä–∞ (${swVer}). –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å? –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è —Å —Ç–æ–≥–æ –∂–µ –º–µ—Å—Ç–∞.`);
              if (agree) {
                persistResumeBeforeReload();
                const reg = await navigator.serviceWorker.getRegistration().catch(()=>null);
                if (reg && (reg.waiting || reg.installing)) {
                  const target = reg.waiting || reg.installing;
                  try { target.postMessage({ type: 'SKIP_WAITING' }); } catch {}
                }
                // –ñ–¥—ë–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                const onCtrl = () => {
                  navigator.serviceWorker.removeEventListener('controllerchange', onCtrl);
                  setTimeout(() => location.reload(), 150);
                };
                navigator.serviceWorker.addEventListener('controllerchange', onCtrl);
              }
            }
          }
        });
      }

      document.addEventListener('visibilitychange', async () => {
        const pc = window.playerCore;
        const isHidden = document.hidden;

        if (isHidden) {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          __wasPlayingBeforeHidden = !!(pc && pc.isPlaying && pc.isPlaying());
          __savedResumePosition = pc && pc.getSeek ? (pc.getSeek() || 0) : 0;

          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI-–∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
          if (coverAutoplay) { clearInterval(coverAutoplay); coverAutoplay = null; }
          if (animationEnabled) {
            window.__savedAnimationState = animationEnabled;
            applyAnimationState(false);
          }
          if (bitEnabled) {
            window.__savedBitState = bitEnabled;
            stopLogoPulsation();
          }
          // iOS: –ø–æ–¥–¥–µ—Ä–∂–∏–º –∞—É–¥–∏–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç (–∫–∞–∫ –∏ –ø—Ä–µ–∂–¥–µ)
          if (isIOS() && __wasPlayingBeforeHidden) {
            resumeAudioContextIfNeeded();
          }
          console.log('App going to background, position saved:', __savedResumePosition);
        } else {
          // –í–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω
          checkSleepTimer();

          if (isIOS()) resumeAudioContextIfNeeded();

          if (__wasPlayingBeforeHidden && !sleepTimerTarget) {
            if (typeof __savedResumePosition === 'number') {
              try { pc && pc.seek && pc.seek(__savedResumePosition); } catch {}
            }
            if (pc && pc.play && !pc.isPlaying()) {
              try { pc.play(); } catch {}
            }
          }

          // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º UI
          syncUiFromPlayback();

          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI-–∞–Ω–∏–º–∞—Ü–∏–∏
          if (window.__savedAnimationState) {
            applyAnimationState(window.__savedAnimationState);
            window.__savedAnimationState = null;
          }
          if (window.__savedBitState) {
            initAudioContext();
            startLogoPulsation();
            window.__savedBitState = null;
          }

          // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –≥–∞–ª–µ—Ä–µ—é
          if (!coverAutoplay && Array.isArray(coverGalleryArr) && coverGalleryArr.length > 1) {
            startCoverAutoPlay();
          }

          console.log('App returning to foreground, resuming playback');
        }
      });

      window.addEventListener('focus', checkSleepTimer);

      window.addEventListener('offline', () => {
        startOfflineToasts();
        const pc = window.playerCore;
        try { __savedResumePosition = pc && pc.getSeek ? (pc.getSeek() || 0) : 0; } catch {}
      });
      window.addEventListener('online', () => {
        stopOfflineToasts();
        NotificationSystem.success('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        const pc = window.playerCore;
        if (pc && typeof __savedResumePosition === 'number') {
          try { pc.seek(__savedResumePosition); } catch {}
          __savedResumePosition = null;
        }
      });
    })();
  }

  /* ====== –§–æ–Ω: Web Locks + Wake Lock (Android) ====== */
  let __wakeLock = null;
  let __playbackLockReleaser = null;

  async function setPlaybackLocks(active) {
    try {
      if (active) {
        // Web Locks: —É–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–µ—Å—É—Ä—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        if (navigator.locks && typeof navigator.locks.request === 'function' && !__playbackLockReleaser) {
          navigator.locks.request('audio-playback', { mode: 'shared' }, async lock => {
            await new Promise(resolve => { __playbackLockReleaser = resolve; });
          }).catch(()=>{});
        }
        // Wake Lock (—ç–∫—Ä–∞–Ω): –ø–æ–ª–µ–∑–Ω–æ –Ω–∞ Android –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
        if ('wakeLock' in navigator && !document.hidden && !__wakeLock) {
          try {
            __wakeLock = await navigator.wakeLock.request('screen');
            __wakeLock.addEventListener('release', () => { __wakeLock = null; }, { once: true });
          } catch (e) {
            // –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–æ–π/–û–° ‚Äî –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
          }
        }
      } else {
        if (__playbackLockReleaser) { try { __playbackLockReleaser(); } catch {} __playbackLockReleaser = null; }
        if (__wakeLock) { try { await __wakeLock.release(); } catch {} __wakeLock = null; }
      }
    } catch {}
  }

  // –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Wake Lock –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ ‚Äî —á–µ—Ä–µ–∑ PlayerCore
  document.addEventListener('visibilitychange', () => {
    try {
      const pc = window.playerCore;
      const playing = pc && pc.isPlaying && pc.isPlaying();
      (window.Energy && window.Energy.setPlaybackLocks
        ? window.Energy.setPlaybackLocks(!document.hidden && playing)
        : setPlaybackLocks(!document.hidden && playing));
    } catch {}
  });

  /* ====== –ü–ª–µ–µ—Ä/–∏–∑–±—Ä–∞–Ω–Ω–æ–µ ====== */
  let currentTrack = -1;
  let currentLyrics = [];
  let offlineMode = false;
  let offlineDownloading = false;
  let deferredPrompt = null;

  let shuffleMode = false;
  let repeatMode = false;
  let autoNextDisabled = false; // ¬´–û–¥–∏–Ω —Ç—Ä–µ–∫¬ª: –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ (–Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –ø—Ä–∏ Repeat)
  let favoritesOnlyMode = false;
  let availableTracks = [];
  let favoritesFilterActive = false;

  let animationEnabled = false;
  let bitEnabled = false;
  let bitIntensity = 100;
  let audioContext = null;
  let analyser = null;
  let audioSource = null;
  let animationFrame = null;

  let filesToDownload = [];

  /* ====== –£–ª—å—Ç—Ä–∞‚Äë—ç–∫–æ–Ω–æ–º –∏ —Å–µ—Ç—å ====== */
  let ultraEcoEnabled = false;
  let __uiUpdateMinIntervalMs = 1000;   // 1—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  let __progressThrottleMs   = 1000;
  let __savedAnimationBeforeEco = null;
  let __savedBitBeforeEco = null;
  let __ecoAutoFromEnergy = false;

  let __offlineToastInterval = null;
  let __savedResumePosition = null;
  let __wasPlayingBeforeHidden = false;
  let __wasPlayingBeforeOffline = false;

  function startOfflineToasts() {
    try { if (__offlineToastInterval) return;
      NotificationSystem.offline('–ü—Ä–æ–ø–∞–ª–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
      __offlineToastInterval = setInterval(() => {
        NotificationSystem.offline('–ü—Ä–æ–ø–∞–ª–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
      }, 30000);
    } catch {}
  }
  function stopOfflineToasts() {
    try { if (__offlineToastInterval) { clearInterval(__offlineToastInterval); __offlineToastInterval = null; } } catch {}
  }

  // –≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ
  let energySaver = false;
  let __savedAnimationBeforeEnergy = null;
  let __savedBitBeforeEnergy = null;

  function detectEnergySaver() {
    try {
      const nc = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const saveData = !!(nc && nc.saveData);
      const reduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
      return saveData || reduced;
    } catch { return false; }
  }

  function applyEnergySaver(on) {
    energySaver = !!on;
    if (energySaver) {
      if (__savedAnimationBeforeEnergy === null) __savedAnimationBeforeEnergy = animationEnabled;
      if (__savedBitBeforeEnergy === null) __savedBitBeforeEnergy = bitEnabled;
      if (animationEnabled) applyAnimationState(false);
      if (bitEnabled) stopLogoPulsation();
      if (coverAutoplay) { clearInterval(coverAutoplay); coverAutoplay = null; }
      // –ê–≤—Ç–æ-–≤–∫–ª—é—á–∞–µ–º ¬´–£–ª—å—Ç—Ä–∞‚Äë—ç–∫–æ–Ω–æ–º¬ª (–º–æ–∂–Ω–æ –ø–æ—Ç–æ–º –æ—Ç–∫–ª—é—á–∏—Ç—å –≤—Ä—É—á–Ω—É—é)
      if (!ultraEcoEnabled) { __ecoAutoFromEnergy = true; applyEcoState(true, { silent: true }); }
    } else {
      if (__savedAnimationBeforeEnergy !== null) {
        applyAnimationState(__savedAnimationBeforeEnergy);
        __savedAnimationBeforeEnergy = null;
      }
      if (__savedBitBeforeEnergy) {
        initAudioContext();
        startLogoPulsation();
      }
      __savedBitBeforeEnergy = null;
      if (!coverAutoplay && Array.isArray(coverGalleryArr) && coverGalleryArr.length > 1 && !document.hidden) {
        startCoverAutoPlay();
      }
      // –ï—Å–ª–∏ –≠–∫–æ –≤–∫–ª—é—á–∞–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–æ–º ‚Äî –≤–µ—Ä–Ω—ë–º –∫–∞–∫ –±—ã–ª–æ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª –≤–∫–ª—é—á–µ–Ω–∏–µ)
      if (__ecoAutoFromEnergy) {
        __ecoAutoFromEnergy = false;
        if (localStorage.getItem('ultraEco') !== '1') {
          applyEcoState(false, { silent: true });
        }
      }
    }
  }
  let __currentAudio = null;
  let __wasMini = false;
  let __savedLyricsModeForMini = null;
  let __savedAnimationForMini = null;

  const FAVORITES_REFS_KEY = 'favoritesAlbumRefs:v1';
  let favoritesRefsModel = null;
  // –ö—ç—à –æ–±–ª–æ–∂–µ–∫ –∞–ª—å–±–æ–º–æ–≤ (–ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏)
  const albumCoverCache = Object.create(null);

  /* –°—Ç–∞—Ä—ã–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Ö–µ–ª–ø–µ—Ä—ã */
function getPlayerConfig() {
  // –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî PlayerCore snapshot (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ¬ª)
  try {
    const pc = window.playerCore;
    if (pc && typeof pc.getPlaylistSnapshot === 'function') {
      const snap = pc.getPlaylistSnapshot();
      if (Array.isArray(snap) && snap.length) {
        return {
          tracks: snap.map(t => ({
            title: t.title,
            audio: t.src || '',
            lyrics: t.lyrics || '',
            fulltext: t.fulltext || ''
          })),
          artist: snap[0].artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
          albumName: snap[0].album || '–ê–ª—å–±–æ–º'
        };
      }
    }
  } catch {}
  // –§–æ–ª–±—ç–∫ ‚Äî —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π –∞–ª—å–±–æ–º
  return config ? { tracks: config.tracks, artist: config.artist, albumName: config.albumName } : null;
}

// –§–æ—Ä–º–∏—Ä—É–µ–º –ø–ª–µ–π–ª–∏—Å—Ç PlayerCore –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∞–ª—å–±–æ–º–∞ (–±–µ–∑ ‚Äú—Ñ–∞–≤–æ—Ä–∏—Ç–æ–≤‚Äù-—Ä–µ–∂–∏–º–∞)
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ config/—Ç—Ä–µ–∫-–ª–∏—Å—Ç–∞.
function updatePlayerCorePlaylistFromConfig() {
  try {
    if (!window.playerCore || !config || !Array.isArray(config.tracks)) return;
    const artist = config.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞';
    const album = config.albumName || '–ê–ª—å–±–æ–º';
    const cover = 'img/logo.png';
    const tracks = config.tracks.map(t => ({
      src: t.audio,
      title: t.title,
      artist,
      album,
      cover,
      lyrics: t.lyrics,
      fulltext: t.fulltext
    }));
    if (tracks.length) {
      const startIdx = (typeof currentTrack === 'number' && currentTrack >= 0 && currentTrack < tracks.length) ? currentTrack : 0;
      window.playerCore.setPlaylist(tracks, startIdx);
      // –ü—Ä–∏–º–µ–Ω–∏–º —Ç–µ–∫—É—â–∏–µ —Ä–µ–∂–∏–º—ã
      window.playerCore.setRepeat(!!repeatMode);
      window.playerCore.setShuffle(!!shuffleMode);
      const favList = getLiked();
      window.playerCore.setFavoritesOnly(!!favoritesOnlyMode, favList);
      // –ü—Ä–∏–º–µ–Ω–∏–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –≥—Ä–æ–º–∫–æ—Å—Ç—å
      const savedVolumeRaw = localStorage.getItem('playerVolume');
      const savedVolume = parseFloat(savedVolumeRaw);
      const volume = Number.isFinite(savedVolume) ? savedVolume : 1;
      window.playerCore.setVolume(volume);
    }
  } catch {}
}

  function isBrowsingSameAsPlaying() { return !!(playingAlbumKey && playingAlbumKey === currentAlbumKey); }

  // NotificationSystem –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ ./scripts/ui/notify.js (ESM). –î–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ window.NotificationSystem.

  /* –ò–∑–±—Ä–∞–Ω–Ω–æ–µ v2 */
  const LIKED_STORAGE_KEY_V2 = 'likedTracks:v2';
  function getLikedMap() {
    try { const raw = localStorage.getItem(LIKED_STORAGE_KEY_V2); const map = raw ? JSON.parse(raw) : {}; return (map && typeof map === 'object') ? map : {}; }
    catch { return {}; }
  }
  function getLikedForAlbum(albumKey) {
    try { const raw = localStorage.getItem(LIKED_STORAGE_KEY_V2); const map = raw ? JSON.parse(raw) : {}; const arr = map && typeof map === 'object' ? map[albumKey] : []; return Array.isArray(arr) ? arr : []; }
    catch { return []; }
  }
  function getLiked() { return getLikedForAlbum(currentAlbumKey); }
  function saveLiked(arr) {
    if (!currentAlbumKey) return;
    const map = getLikedMap();
    map[currentAlbumKey] = Array.from(new Set(arr.filter(n => Number.isInteger(n))));
    localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map));
  }
  function isLiked(idx, albumKey = currentAlbumKey) { return getLikedForAlbum(albumKey).includes(idx); }
  function isLikedInPlayback(idx) {
    if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
      const ref = favoritesRefsModel?.[idx];
      return ref ? getLikedForAlbum(ref.__a).includes(ref.__t) : false;
    }
    return getLikedForAlbum(playingAlbumKey).includes(idx);
  }

  /* –°—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (refs) */
  function readFavoritesRefs(){ try { const raw = localStorage.getItem(FAVORITES_REFS_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr)?arr:[]; } catch { return []; } }
  function writeFavoritesRefs(arr){ try { localStorage.setItem(FAVORITES_REFS_KEY, JSON.stringify(arr)); } catch {} }
  function ensureFavoritesRefsWithLikes(){
    const refs = readFavoritesRefs();
    const keySet = new Set(refs.map(x=>`${x.a}:${x.t}`));
    for (const alb of albumsIndex) {
      const liked = getLikedForAlbum(alb.key);
      liked.forEach(ti=>{
        const k = `${alb.key}:${ti}`;
        if (!keySet.has(k)) { refs.push({ a: alb.key, t: ti }); keySet.add(k); }
      });
    }
    writeFavoritesRefs(refs);
    return refs;
  }
  function getSortedFavoritesRefs() {
    const refs = ensureFavoritesRefsWithLikes().slice();
    const order = ICON_ALBUMS_ORDER.map(x=>x.key).filter(k=>k!==SPECIAL_FAVORITES_KEY && k!==SPECIAL_RELIZ_KEY);
    const orderMap = new Map(order.map((k,i)=>[k,i]));
    refs.sort((r1,r2)=>{
      const o1 = orderMap.has(r1.a) ? orderMap.get(r1.a) : 999;
      const o2 = orderMap.has(r2.a) ? orderMap.get(r2.a) : 999;
      if (o1 !== o2) return o1 - o2;
      return (r1.t - r2.t);
    });
    return refs;
  }
  async function getAlbumConfigByKey(albumKey){
    if (albumConfigCache[albumKey]?.config) return albumConfigCache[albumKey].config;
    const meta = albumsIndex.find(a => a.key === albumKey);
    if (!meta) return null;
    const base = normalizeBase(meta.base);
    try{
      const r = await fetch(absJoin(base,'config.json'), { cache:'no-cache' });
      const data = await r.json();
      if (!Array.isArray(data.tracks)) data.tracks = [];
      data.tracks.forEach((t, i) => {
        if (t.audio) t.audio = absJoin(base, t.audio);
        else { try { NotificationSystem && NotificationSystem.warning(`config.json[${base}]: —É —Ç—Ä–µ–∫–∞ #${i+1} –Ω–µ—Ç –ø–æ–ª—è audio`); } catch {} }
        if (t.lyrics) t.lyrics = absJoin(base, t.lyrics);
        if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
      });
      albumConfigCache[albumKey] = { base, config: data };
      return data;
    } catch { return null; }
  }
  async function buildFavoritesRefsModel() {
    const sortedRefs = getSortedFavoritesRefs();
    const out = [];

    async function getAlbumCoverUrl(albumKey) {
      if (albumCoverCache[albumKey]) return albumCoverCache[albumKey];
      try {
        const cid = centralIdForAlbumKey(albumKey);
        if (!cid) { albumCoverCache[albumKey] = 'img/logo.png'; return albumCoverCache[albumKey]; }
        const baseDir = `${CENTRAL_GALLERY_BASE}${cid}/`;
        const r = await fetch(baseDir + 'index.json', { cache: 'force-cache' });
        const j = r.ok ? await r.json() : null;
        const first = j && (Array.isArray(j.items) ? j.items[0] : (Array.isArray(j) ? j[0] : null));
        if (first) {
          const norm = normalizeGalleryItem(first, baseDir);
          const url = (norm && (norm.formats?.webp || norm.formats?.full || norm.src)) || 'img/logo.png';
          albumCoverCache[albumKey] = url;
          return url;
        }
      } catch {}
      albumCoverCache[albumKey] = 'img/logo.png';
      return albumCoverCache[albumKey];
    }

    for (const ref of sortedRefs) {
      const cfg = await getAlbumConfigByKey(ref.a);
      const tr = cfg?.tracks?.[ref.t];
      if (!tr) continue;
      const active = getLikedForAlbum(ref.a).includes(ref.t);
      const cover = await getAlbumCoverUrl(ref.a);
      out.push({
        title: tr.title,
        audio: tr.audio,
        lyrics: tr.lyrics,
        fulltext: tr.fulltext || null,
        __a: ref.a,
        __t: ref.t,
        __artist: cfg?.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
        __album: cfg?.albumName || '–ê–ª—å–±–æ–º',
        __active: active,
        __cover: cover
      });
    }
    favoritesRefsModel = out;
    return out;
  }

  function updateFavoritesRefsModelActiveFlag(albumKey, trackIndex, isActive) {
    if (!Array.isArray(favoritesRefsModel)) return;
    const item = favoritesRefsModel.find(x => x.__a === albumKey && x.__t === trackIndex);
    if (item) item.__active = !!isActive;
  }

  // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø –î–õ–Ø ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª
  async function ensureFavoritesPlayback(index) {
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –º–æ–¥–µ–ª—å –µ—Å–ª–∏ –ø—É—Å—Ç–æ
    if (!Array.isArray(favoritesRefsModel) || favoritesRefsModel.length === 0) {
      await buildFavoritesRefsModel();
    }

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç UI
    playingAlbumKey = SPECIAL_FAVORITES_KEY;

    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–ª–µ–π–ª–∏—Å—Ç –¥–ª—è PlayerCore (–∏—Å—Ç–æ—á–Ω–∏–∫ –∑–≤—É–∫–∞)
    const playlist = (favoritesRefsModel || []).map(it => ({
      src: it.audio,
      title: it.title,
      artist: it.__artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      album: it.__album || '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
      cover: it.__cover || 'img/logo.png',
      lyrics: it.lyrics
    }));

    // –ò–Ω–¥–µ–∫—Å
    let idx = Number(index);
    if (!Number.isInteger(idx) || idx < 0 || idx >= (playlist.length || 0)) {
      idx = 0;
    }

    // –û—Ç—Ä–∏—Å—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (UI –±–ª–æ–∫)
    if (!document.getElementById('lyricsplayerblock')) {
      const holder = document.getElementById('now-playing');
      if (holder) holder.innerHTML = '<div class="lyrics-player-block" id="lyricsplayerblock"></div>';
    }

    // –ü–µ—Ä–µ–¥–∞—ë–º –ø–ª–µ–π–ª–∏—Å—Ç –≤ —è–¥—Ä–æ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
    try {
      window.playerCore.setPlaylist(playlist, idx, { artist: '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞', album: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', cover: 'img/logo.png' });
      window.playerCore.play(idx);
    } catch {}

    // –û–±–Ω–æ–≤–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–ª—è UI
    updateAvailableTracks();
  }

  /* –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ */
  function buildTrackList() {
    // –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/tracks.js
    if (window.UITracks && typeof window.UITracks.buildTrackList === 'function') {
      return window.UITracks.buildTrackList();
    }
  }

  function pickAndPlayTrack(n){ showTrack(n, true); }
  function toggleLike(idx, e) {
    if (e) e.stopPropagation();
    let liked = getLiked();
    const was = liked.includes(idx);
    liked = was ? liked.filter(x=>x!==idx) : [...liked, idx];
    saveLiked(liked);
    const star = e ? e.target : document.querySelector(`#trk${idx} .like-star`);
    if (star){ star.src = was? 'img/star2.png':'img/star.png'; star.title = was?'–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è':'–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è'; star.classList.add('animating'); setTimeout(()=>star.classList.remove('animating'),300); }

    if (favoritesFilterActive) {
      updateFavoriteClasses();
      const count = document.querySelectorAll('.track.is-favorite').length;
      if (count===0) {
        toggleFavoritesFilter();
        NotificationSystem.warning('–í—Å–µ —Ç—Ä–µ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, —Ñ–∏–ª—å—Ç—Ä –æ—Ç–∫–ª—é—á—ë–Ω');
      } else {
        NotificationSystem.info(`‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤: ${count}`);
      }
    }

    if (favoritesOnlyMode && isBrowsingSameAsPlaying()) {
          updateAvailableTracks();
          if (!getLikedForPlayback().includes(playingTrack)) {
            const nextFavorite = getNextFavoriteTrack();
            if (nextFavorite !== -1) setTimeout(() => showTrack(nextFavorite, true), 300);
            else { toggleFavoritesOnly(); NotificationSystem.warning('–í—Å–µ —Ç—Ä–µ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ'); }
          }
          if (shuffleMode) { try { window.playerCore && window.playerCore.setShuffle(!!shuffleMode); } catch {} }
        }
  }

  /* –ü–ª–µ–µ—Ä */
  /* Audio-tag path removed. PlayerCore (Howler) –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∑–≤—É–∫–∞. */

  function dedupePlayerBlock() {
    try {
      const nodes = Array.from(document.querySelectorAll('#lyricsplayerblock'));
      if (nodes.length <= 1) return;
      let keep = nodes[0];
      nodes.forEach(n => { if (n !== keep) n.remove(); });
    } catch {}
  }
function showTrack(n, doPlay) {
  try {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫—É—Ä—Å–æ—Ä—ã UI
    currentTrack = n;
    playingTrack = n;
    playingAlbumKey = currentAlbumKey || playingAlbumKey || null;

    // –û–±–µ—Å–ø–µ—á–∏–º –ø–ª–µ–π–ª–∏—Å—Ç –¥–ª—è PlayerCore (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –¥–µ–ª–∞–ª–∏)
    if (typeof updatePlayerCorePlaylistFromConfig === 'function') {
      updatePlayerCorePlaylistFromConfig();
    }

    // –û—Ç—Ä–∏—Å—É–µ–º –±–ª–æ–∫ –ø–ª–µ–µ—Ä–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    if (!document.getElementById('lyricsplayerblock')) {
      const holder = document.getElementById('now-playing');
      if (holder) holder.innerHTML = '<div class="lyrics-player-block" id="lyricsplayerblock"></div>';
    }
    if (typeof renderLyricsBlock === 'function') renderLyricsBlock();

    // –ó–∞–ø—É—Å–∫/–ø–∞—É–∑–∞ —á–µ—Ä–µ–∑ PlayerCore
    if (doPlay === false) window.playerCore.pause();
    else window.playerCore.play(n);
  } catch {
    // –§–æ–ª–±—ç–∫: –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ—Ç PlayerCore ‚Äî –º–æ–ª—á–∞
  }
}
  function renderLyricsBlock() {
    // –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/tracks.js
    if (window.UITracks && typeof window.UITracks.renderLyricsBlock === 'function') {
      return window.UITracks.renderLyricsBlock();
    }
  }

  /* –õ–∏—Ä–∏–∫–∞ */
  let lyricsViewMode = 'normal';
  // –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥/—Å—Ç–µ–π—Ç –¥–ª—è –ª–∏—Ä–∏–∫–∏
  let __lyricsLastIdx = -1;
  let __lyricsLastTs = 0;
  let __lyricsMinIntervalBase = 250; // –º—Å
  function restoreLyricsViewMode() { try { const saved = localStorage.getItem('lyricsViewMode'); if (saved && ['normal','hidden','expanded'].includes(saved)) lyricsViewMode = saved; } catch {} }
  function saveLyricsViewMode() { try { localStorage.setItem('lyricsViewMode', lyricsViewMode); } catch {} }
  restoreLyricsViewMode();
  function renderLyrics(time) {
    if (!currentLyrics || !currentLyrics.length) { const el = document.getElementById('lyrics'); if (el) el.innerHTML = ''; return; }
    const windowSize = (lyricsViewMode === 'expanded') ? 9 : 5;
    const centerLine = Math.floor(windowSize / 2);
    let active = 0;
    for (let i = 0; i < currentLyrics.length; i++) if (time >= currentLyrics[i].time) active = i;
    const start = Math.max(0, active - centerLine);
    const padTop = Math.max(0, centerLine - active);
    const rows = [];
    for (let p = 0; p < padTop; ++p) rows.push('<div class="lyrics-window-line"></div>');
    for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
      const cls = (i === active) ? 'lyrics-window-line active' : 'lyrics-window-line';
      rows.push(`<div class="${cls}">${currentLyrics[i] ? currentLyrics[i].line : ''}</div>`);
    }
    while (rows.length < windowSize) rows.push('<div class="lyrics-window-line"></div>');
    const lyricsEl = document.getElementById('lyrics');
    if (lyricsEl) lyricsEl.innerHTML = rows.join('');
  }
  function renderLyricsEnhanced(t){
    if (lyricsViewMode === 'hidden' || !Array.isArray(currentLyrics) || currentLyrics.length === 0) return;

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥: –≤ ultraEco/—Ñ–æ–Ω–µ —Ä–µ–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º
    const ecoIntervalMs = (window.ultraEcoEnabled || document.hidden)
      ? Math.max(500, window.__uiUpdateMinIntervalMs || 1000)
      : __lyricsMinIntervalBase;

    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É
    let idx = 0;
    for (let i = 0; i < currentLyrics.length; i++) {
      if (t >= currentLyrics[i].time) idx = i; else break;
    }
    const now = performance.now();
    if (idx === __lyricsLastIdx && (now - __lyricsLastTs) < ecoIntervalMs) return;

    __lyricsLastIdx = idx;
    __lyricsLastTs = now;
    renderLyrics(t);
  }

  function copyLyrics(){
    const pc = getPlayerConfig();
    const idx = (typeof playingTrack === 'number' && playingTrack >= 0) ? playingTrack : currentTrack;
    if (!pc || !pc.tracks || idx < 0 || !pc.tracks[idx] || !pc.tracks[idx].fulltext) { 
      NotificationSystem.warning('–§–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω!'); return;
    }
    fetch(pc.tracks[idx].fulltext).then(r=>r.text()).then(txt=>{
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(txt).then(()=>NotificationSystem.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'),()=>NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
      } else {
        const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); NotificationSystem.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'); } catch { NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
        document.body.removeChild(ta);
      }
    }).catch(()=> NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç!'));
  }
  function toggleLyricsView(){
    const modes=['normal','hidden','expanded'];
    lyricsViewMode = modes[(modes.indexOf(lyricsViewMode)+1)%modes.length];
    applyLyricsViewMode();
    saveLyricsViewMode();
    const msg = {normal:'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏', hidden:'üö´ –õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞', expanded:'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏'}[lyricsViewMode];
    NotificationSystem.info(msg);
  }
  function applyLyricsViewMode(){
    const w=document.getElementById('lyrics-window'), btn=document.querySelector('.lyrics-toggle-btn');
    if (!w||!btn) return;
    w.classList.remove('lyrics-normal','lyrics-hidden','lyrics-expanded'); btn.classList.remove('lyrics-normal','lyrics-hidden','lyrics-expanded');
    w.classList.add(`lyrics-${lyricsViewMode}`); btn.classList.add(`lyrics-${lyricsViewMode}`);
    // –ï—Å–ª–∏ –ª–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ ‚Äî —Ñ–æ–Ω –≤—Å–µ–≥–¥–∞ –≤—ã–∫–ª—é—á–∞–µ–º
    if (lyricsViewMode === 'hidden') applyAnimationState(false);
  }

  /* –ö–æ–Ω—Ç—Ä–æ–ª—ã –ø–ª–µ–µ—Ä–∞ */
  let lastTimeUpdate = 0, isSeekingProgress=false, isMuted=false, sleepTimerInterval=null, sleepTimerTarget=null;
  let __lastProgressFillTs = 0; // —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (1 –ì—Ü)
  function initializePlayerControls() {
    const progressBar = document.getElementById('player-progress-bar');
    if (progressBar) {
      progressBar.addEventListener('click', seekToPosition);
      const startDrag = (e)=>{
        isSeekingProgress = true;
        const moveHandler = (e2) => {
          const rect = progressBar.getBoundingClientRect();
          const clientX = e2.touches ? e2.touches[0].clientX : e2.clientX;
          const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
          document.getElementById('player-progress-fill').style.width = `${percent*100}%`;
        };
        const endHandler = (e3) => {
          const rect = progressBar.getBoundingClientRect();
          const clientX = e3.changedTouches ? e3.changedTouches[0].clientX : e3.clientX;
          const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
          const dur = (window.playerCore && window.playerCore.getDuration) ? (window.playerCore.getDuration() || 0) : 0;
          if (dur > 0 && window.playerCore && window.playerCore.seek) {
            window.playerCore.seek(dur * percent);
          }
          isSeekingProgress = false;
          document.removeEventListener('mousemove', moveHandler);
          document.removeEventListener('mouseup', endHandler);
          document.removeEventListener('touchmove', moveHandler);
          document.removeEventListener('touchend', endHandler);
        };
        document.addEventListener('mousemove', moveHandler);
        document.addEventListener('mouseup', endHandler);
        document.addEventListener('touchmove', moveHandler, {passive:false});
        document.addEventListener('touchend', endHandler);
        e.preventDefault();
      };
      progressBar.addEventListener('mousedown', startDrag);
      progressBar.addEventListener('touchstart', startDrag, {passive:false});
    }
    const volumeSlider = document.getElementById('volume-slider');
    if (volumeSlider) {
      volumeSlider.addEventListener('input', onVolumeSliderChange);
      const savedVolumeRaw = localStorage.getItem('playerVolume');
      const savedVolume = parseFloat(savedVolumeRaw);
      const volume = Number.isFinite(savedVolume) ? savedVolume : 1;
      volumeSlider.value = Math.round(volume * 100);
      updateVolumeUI(volume);
      // –ì—Ä–æ–º–∫–æ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ PlayerCore.setVolume
    }
  }
  /* onAudioMetadataLoaded removed ‚Äî –ø–æ–∑–∏—Ü–∏—è/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ PlayerCore —Ç–∏–∫–µ—Ä */
  /* onAudioTimeUpdate removed ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å/–≤—Ä–µ–º—è/–ª–∏—Ä–∏–∫–∞ –≤–µ–¥—É—Ç—Å—è —á–µ—Ä–µ–∑ PlayerCore –∏ core‚Äëticker */
  /* onAudioEnded removed ‚Äî –∞–≤—Ç–æ–Ω–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–Ω—É—Ç—Ä–∏ PlayerCore */

  function seekToPosition(e) {
    if (!window.playerCore) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const clientX = e.clientX ?? (e.touches && e.touches[0] && e.touches[0].clientX);
    if (typeof clientX !== 'number') return;
    const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
    const dur = window.playerCore.getDuration() || 0;
    if (dur > 0) window.playerCore.seek(dur * percent);
  }
  function onVolumeSliderChange(e) {
    const value = (e && e.target ? e.target.value : 100) / 100;
    if (window.playerCore && typeof window.playerCore.setVolume === 'function') {
      window.playerCore.setVolume(value);
    }
    updateVolumeUI(value);
    try { localStorage.setItem('playerVolume', value); } catch {}
  }
  function toggleMute() {
    if (!window.playerCore) return;
    if (isMuted) {
      const saved = parseFloat(localStorage.getItem('playerVolume'));
      const vol = Number.isFinite(saved) && saved > 0 ? saved : 1;
      window.playerCore.setVolume(vol);
      isMuted = false;
      updateVolumeUI(vol);
    } else {
      try {
        const curVol = (window.playerCore.getVolume && window.playerCore.getVolume()) || 1;
        localStorage.setItem('playerVolume', curVol);
      } catch {}
      window.playerCore.setVolume(0);
      isMuted = true;
      updateVolumeUI(0);
    }
  }
  function togglePlayPause() {
    if (!window.playerCore) return;
    if (window.playerCore.isPlaying()) window.playerCore.pause();
    else window.playerCore.play(typeof playingTrack === 'number' ? playingTrack : 0);
  }
  function updatePlayPauseIcon() {
    const icon = document.getElementById('play-pause-icon');
    if (!icon) return;
    const playing = !!(window.playerCore && typeof window.playerCore.isPlaying === 'function' && window.playerCore.isPlaying());
    icon.innerHTML = playing ? '<path d="M6 6h4v12H6zM14 6h4v12h-4z"/>' : '<path d="M8 5v14l11-7z"/>';
  }
  function stopPlayback(){
    if (!window.playerCore) return;
    window.playerCore.stop();
    updatePlayPauseIcon();
  }

  function toggleRepeat(){
    repeatMode = !repeatMode;
    const btn=document.getElementById('repeat-btn');
    if (repeatMode) btn.classList.add('repeat-active'); else btn.classList.remove('repeat-active');
    localStorage.setItem('repeatMode', repeatMode?'1':'0');
    try { window.playerCore && window.playerCore.setRepeat(repeatMode); } catch {}
  }
  function toggleShuffle(){
    shuffleMode = !shuffleMode;
    const btn = document.getElementById('shuffle-btn');
    if (shuffleMode) {
      btn && btn.classList.add('active');
      NotificationSystem.info('üîÄ –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫');
    } else {
      btn && btn.classList.remove('active');
      NotificationSystem.info('–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ');
    }
    localStorage.setItem('shuffleMode', shuffleMode ? '1' : '0');
    try { window.playerCore && window.playerCore.setShuffle(shuffleMode); } catch {}
    updateNextUpLabel();
  }

  function toggleFavoritesOnly(){
    return __toggleFavoritesOnly_impl();
  }

function __toggleFavoritesOnly_impl(){
  const btn = document.getElementById('favorites-btn');
  const icon = document.getElementById('favorites-btn-icon');
  favoritesOnlyMode = !favoritesOnlyMode;
  if (favoritesOnlyMode) { btn && btn.classList.add('favorites-active'); if (icon) icon.src = 'img/star.png'; NotificationSystem.success('‚≠ê –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ'); }
  else { btn && btn.classList.remove('favorites-active'); if (icon) icon.src = 'img/star2.png'; NotificationSystem.info('–ò–≥—Ä–∞—é—Ç –≤—Å–µ —Ç—Ä–µ–∫–∏'); }
  localStorage.setItem('favoritesOnlyMode', favoritesOnlyMode ? '1' : '0');

  const list = document.getElementById('track-list');
  const filterBtn = document.getElementById('filter-favorites-btn');

  if (viewMode === 'favorites') {
    favoritesFilterActive = favoritesOnlyMode;
    if (favoritesFilterActive) {
      filterBtn && filterBtn.classList.add('filtered');
      if (filterBtn) filterBtn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò';
      list && list.classList.add('filtered');
      updateFavoriteClassesFavorites();
    } else {
      filterBtn && filterBtn.classList.remove('filtered');
      if (filterBtn) filterBtn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏';
      list && list.classList.remove('filtered');
    }
  } else if (viewMode === 'album') {
    favoritesFilterActive = favoritesOnlyMode;
    if (favoritesFilterActive) {
      filterBtn && filterBtn.classList.add('filtered');
      if (filterBtn) filterBtn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò';
      list && list.classList.add('filtered');
      updateFavoriteClasses();
    } else {
      filterBtn && filterBtn.classList.remove('filtered');
      if (filterBtn) filterBtn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏';
      list && list.classList.remove('filtered');
    }
  }

  if (playingAlbumKey) {
    if (isBrowsingOtherAlbum() || playingAlbumKey === SPECIAL_FAVORITES_KEY) {
      if (shuffleMode) { try { window.playerCore && window.playerCore.setShuffle(!!shuffleMode); } catch {} }
      updateNextUpLabel();
    } else {
      updateAvailableTracks();
      if (shuffleMode) { try { window.playerCore && window.playerCore.setShuffle(!!shuffleMode); } catch {} }
      updateNextUpLabel();
    }
  }

  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å PlayerCore (—Ñ–∏–ª—å—Ç—Ä –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º —Ç–µ–∫—É—â–µ–≥–æ –∞–ª—å–±–æ–º–∞)
  try {
    const favList = Array.isArray(config?.tracks) ? getLiked() : [];
    window.playerCore && window.playerCore.setFavoritesOnly(favoritesOnlyMode, favList);
  } catch {}
}

  function updateAvailableTracks(){
    const pc = getPlayerConfig();
    if (!pc || !Array.isArray(pc.tracks)) { availableTracks = []; return; }
    if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
      const activeIdx = [];
      favoritesRefsModel.forEach((x, i) => { if (x.__active) activeIdx.push(i); });
      availableTracks = activeIdx; return;
    }
    availableTracks = favoritesOnlyMode
      ? getLikedForPlayback()
      : Array.from({ length: pc.tracks.length }, (_, i) => i);
  }
  function getLikedForPlayback() { return getLikedForAlbum(playingAlbumKey); }
  function getNextFavoriteTrack(){
    const liked = getLikedForPlayback();
    if (!liked.length) return -1;
    const pos = liked.indexOf(playingTrack);
    return pos !== -1 && pos < liked.length - 1 ? liked[pos + 1] : liked[0];
  }
  function shouldUsePlaybackContext() { return playingAlbumKey === SPECIAL_FAVORITES_KEY || isBrowsingOtherAlbum(); }

  function previousTrack(){
    if (!window.playerCore) return;
    if (repeatMode) {
      window.playerCore.seek(0);
      window.playerCore.play();
      return;
    }
    window.playerCore.prev();
  }

  function nextTrack(){
    if (!window.playerCore) return;
    if (repeatMode) {
      window.playerCore.seek(0);
      window.playerCore.play();
      return;
    }
    window.playerCore.next();
  }

  function getAvailableTracksForAlbum(albumKey, tracksLen) {
    if (!tracksLen || tracksLen <= 0) return [];
    if (albumKey === SPECIAL_FAVORITES_KEY) {
      if (!Array.isArray(favoritesRefsModel)) return [];
      const activeIdx = [];
      favoritesRefsModel.forEach((x, i) => { if (x.__active) activeIdx.push(i); });
      return activeIdx;
    }
    if (favoritesOnlyMode) {
      const liked = getLikedForAlbum(albumKey).filter(n => Number.isInteger(n) && n >= 0 && n < tracksLen);
      return liked.length ? liked : Array.from({length: tracksLen}, (_,i)=>i);
    }
    return Array.from({length: tracksLen}, (_,i)=>i);
  }
  // legacy: —É–¥–∞–ª–µ–Ω–æ. shuffle —É–ø—Ä–∞–≤–ª—è–µ—Ç PlayerCore
  function createShuffledPlaylist(){
    try { window.playerCore && window.playerCore.setShuffle(!!shuffleMode); } catch {}
  }

  /* createPlayingShuffledPlaylist removed ‚Äî shuffle —É–ø—Ä–∞–≤–ª—è–µ—Ç PlayerCore */
  function playFromPlaybackAlbum(idx, doPlay) {
    // –û–±–Ω–æ–≤–∏–º –∫—É—Ä—Å–æ—Ä—ã UI
    currentTrack = idx;
    playingTrack = idx;

    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –±–ª–æ–∫–∞ –ø–ª–µ–µ—Ä–∞
    if (!document.getElementById('lyricsplayerblock')) {
      const holder = document.getElementById('now-playing');
      if (holder) {
        holder.innerHTML = '<div class="lyrics-player-block" id="lyricsplayerblock"></div>';
        renderLyricsBlock();
      }
    }

    // –ü–µ—Ä–µ—Å—Ç–∞–≤–∏–º –ø–ª–µ–µ—Ä –ø–æ–¥ –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–º¬ª
    if (playingAlbumKey === SPECIAL_FAVORITES_KEY && viewMode === 'favorites') {
      updateFavoritesCurrentRow(idx);
      const list = document.getElementById('track-list');
      const lp = document.getElementById('lyricsplayerblock');
      const rows = list ? list.querySelectorAll('.track') : [];
      const row = rows[idx];
      if (list && lp && row) {
        if (row.nextSibling) row.parentNode.insertBefore(lp, row.nextSibling);
        else row.parentNode.appendChild(lp);
      }
    }
    dedupePlayerBlock();

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PlayerCore
    try {
      if (doPlay === false) {
        window.playerCore.pause();
      } else {
        window.playerCore.play(idx);
      }
    } catch {}

    applyMiniModeUI();
    updateNextUpLabel();
    updateMiniNowHeader();
  }

  /* Media Session ‚Äî –µ–¥–∏–Ω—ã–π –ø—É—Ç—å */
  function setupMediaSessionForPlayback() {
    // MediaSession –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è PlayerCore (Howler).
    // –•–µ–ª–ø–µ—Ä –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ —Ç–µ–ø–µ—Ä—å –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç.
    return;
  }
  // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –≤ Media Session
  // Media Session –ø–æ–∑–∏—Ü–∏—é –æ–±–Ω–æ–≤–ª—è–µ—Ç PlayerCore –≤–Ω—É—Ç—Ä–∏ onplay/onTick.
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è.
  function initSilentAudioPlayback() {
    if (!isIOS()) return;
  
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
    
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      gainNode.gain.value = 0.00001; // –ø–æ—á—Ç–∏ –±–µ—Å—à—É–º–Ω—ã–π
    
      oscillator.start(0);
    
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
      window.__silentOscillator = oscillator;
      window.__silentAudioContext = audioContext;
    
      // –û—á–∏—â–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        try {
          oscillator.stop();
          audioContext.close().catch(console.warn);
          delete window.__silentOscillator;
          delete window.__silentAudioContext;
        } catch (e) {
          console.warn('Failed to clean silent audio', e);
        }
      }, 2000);
    
      console.log('Silent audio playback initialized for iOS background mode');
    } catch (e) {
      console.warn('Failed to initialize silent audio playback', e);
    }
  }
  /* computeNextIndexPlayback removed ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º playerCore.getNextIndex() */
  // –õ–Å–ì–ö–ò–ô –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ –≤ —Ñ–æ–Ω–µ (iOS): –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–æ–∫, –Ω–æ —Å ¬´–æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ–º¬ª
  /* backgroundNextTrack removed ‚Äî –∞–≤—Ç–æ–Ω–µ–∫—Å—Ç –∏ —Ñ–æ–Ω –≤–µ–¥—ë—Ç PlayerCore */
  function updateNextUpLabel() {
    const box = document.getElementById('next-up');
    const lp = document.getElementById('lyricsplayerblock');
    if (!box || !lp) return;
    if (!isBrowsingOtherAlbum()) { box.style.display = 'none'; return; }

    const pc = window.playerCore;
    if (!pc || typeof pc.getNextIndex !== 'function') { box.style.display = 'none'; return; }
    const nextIdx = pc.getNextIndex();
    if (!Number.isInteger(nextIdx) || nextIdx < 0) { box.style.display = 'none'; return; }

    let title = '‚Äî';
    try {
      const snap = typeof pc.getPlaylistSnapshot === 'function' ? pc.getPlaylistSnapshot() : null;
      if (snap && snap[nextIdx] && snap[nextIdx].title) title = snap[nextIdx].title;
    } catch {}
    const titleEl = box.querySelector('.title');
    if (titleEl) {
      titleEl.textContent = `${String(nextIdx + 1).padStart(2, '0')}. ${title}`;
      titleEl.title = `${String(nextIdx + 1).padStart(2, '0')}. ${title}`;
    }
    box.style.display = '';
  }

  // –ú—è–≥–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è UI –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–≥—Ä–∞—é—â–µ–º—É —Ç—Ä–µ–∫—É (—á–µ—Ä–µ–∑ PlayerCore)
  function syncUiFromPlayback() {
    const pc = window.playerCore;
    if (!pc) return;

    const idxNow = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
    if (playingAlbumKey === currentAlbumKey) {
      if (typeof idxNow === 'number' && idxNow >= 0 && currentTrack !== idxNow) {
        currentTrack = idxNow;
        playingTrack = idxNow;
        try {
          document.querySelectorAll('#track-list .track').forEach(el => el.classList.remove('current'));
          const row = document.getElementById(`trk${currentTrack}`);
          if (row) row.classList.add('current');
          const lp = document.getElementById('lyricsplayerblock');
          if (row && lp && row.parentNode) {
            if (row.nextSibling) row.parentNode.insertBefore(lp, row.nextSibling);
            else row.parentNode.appendChild(lp);
          }
        } catch {}
        // –û–±–Ω–æ–≤–∏–º –ª–∏—Ä–∏–∫—É –ø–æ–¥ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—É—Ç—å)
        const snap = typeof pc.getPlaylistSnapshot === 'function' ? pc.getPlaylistSnapshot() : null;
        if (snap && snap[currentTrack] && snap[currentTrack].lyrics) {
          loadLyrics(snap[currentTrack].lyrics);
        }
      }
    }

    applyMiniModeUI();
    updateMiniNowHeader();
    updateNextUpLabel();

    // –†–∞–∑–æ–≤–æ –æ–±–Ω–æ–≤–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å/—Ç–∞–π–º–µ—Ä—ã –∏–∑ PlayerCore
    updateUiFromCoreOnce();
  }

  function applyMiniModeUI() {
    // –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/mini.js
    if (window.UIMini && typeof window.UIMini.applyMiniModeUI === 'function') {
      return window.UIMini.applyMiniModeUI();
    }
  }

  function applyRelizUiMode(on) {
    const now = document.getElementById('now-playing');
    const dl = document.getElementById('download-album-main');
    const off = document.getElementById('offline-btn');
    const hot = document.getElementById('hotkeys-btn');
    const filterBtn = document.getElementById('filter-favorites-btn');

    if (now) now.style.display = on ? 'none' : '';
    if (dl) dl.style.display = on ? 'none' : '';
    if (off) off.style.display = on ? 'none' : '';
    if (filterBtn) filterBtn.style.display = on ? 'none' : '';
    if (hot) hot.style.display = on ? 'block' : (hasKeyboard() ? 'block' : 'none');
  }
  function updateMiniNowHeader() {
    // –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/mini.js
    if (window.UIMini && typeof window.UIMini.updateMiniNowHeader === 'function') {
      return window.UIMini.updateMiniNowHeader();
    }
  }

  function toggleLikePlayingFromMini(e) {
    // –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/mini.js
    if (e && e.stopPropagation) e.stopPropagation();
    if (window.UIMini && typeof window.UIMini.toggleLikePlayingFromMini === 'function') {
      return window.UIMini.toggleLikePlayingFromMini();
    }
  }

  async function openPlayingAlbumFromMini(e) {
    // –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/mini.js
    if (window.UIMini && typeof window.UIMini.openPlayingAlbumFromMini === 'function') {
      return window.UIMini.openPlayingAlbumFromMini(e);
    }
  }

  function attachPlaybackStateListeners() {
    if (!('mediaSession' in navigator)) return;
    try {
      const pc = window.playerCore;
      const playing = pc && pc.isPlaying && pc.isPlaying();
      navigator.mediaSession.playbackState = playing ? 'playing' : 'paused';
    } catch {}
  }

  function toggleLikePlaying() {
    if (!playingTracks || playingTrack < 0) return;
    let albumForLike = playingAlbumKey;
    let indexForLike = playingTrack;

    if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
      const ref = favoritesRefsModel?.[playingTrack];
      if (!ref) return;
      albumForLike = ref.__a;
      indexForLike = ref.__t;
    }
    const map = getLikedMap();
    const arr = Array.isArray(map[albumForLike]) ? map[albumForLike] : [];
    const was = arr.includes(indexForLike);
    const next = was ? arr.filter(x => x !== indexForLike) : [...arr, indexForLike];
    map[albumForLike] = Array.from(new Set(next));
    try { localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map)); } catch {}

    updateMiniNowHeader();

    if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
      updateFavoritesRefsModelActiveFlag(albumForLike, indexForLike, !was);
      const favRow = document.getElementById(`fav_${albumForLike}_${indexForLike}`);
      if (favRow) {
        favRow.classList.toggle('inactive', was);
        const s = favRow.querySelector('.like-star');
        if (s) { s.src = was ? 'img/star2.png' : 'img/star.png'; s.title = was ? '–í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–°–Ω—è—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ'; }
      }
      /* shuffle handled by PlayerCore */
      updateNextUpLabel();
      if (was) { nextTrack(); return; }
    } else {
      const favRow = document.getElementById(`fav_${albumForLike}_${indexForLike}`);
      if (favRow) {
        favRow.classList.toggle('inactive', was);
        const s = favRow.querySelector('.like-star');
        if (s) { s.src = was ? 'img/star2.png' : 'img/star.png'; s.title = was ? '–í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–°–Ω—è—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ'; }
      }
      if (favoritesOnlyMode && shuffleMode) { try { window.playerCore && window.playerCore.setShuffle(!!shuffleMode); } catch {} }
      updateNextUpLabel();
    }
  }

  /* –§–∏–ª—å—Ç—Ä/—Å–ø–∏—Å–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ */
  function updateFavoriteClasses() {
    const liked = getLiked();
    document.querySelectorAll('.track').forEach(tr => tr.classList.remove('is-favorite'));
    liked.forEach(idx => { const el = document.getElementById(`trk${idx}`); if (el) el.classList.add('is-favorite'); });
  }
  function updateFavoriteClassesFavorites() {
    if (!Array.isArray(favoritesRefsModel)) return;
    document.querySelectorAll('#track-list .track').forEach(tr => tr.classList.remove('is-favorite'));
    favoritesRefsModel.forEach((item, i) => {
      if (item.__active) {
        const el = document.getElementById(`fav_${item.__a}_${item.__t}`);
        if (el) el.classList.add('is-favorite');
      }
    });
  }
  function toggleFavoritesFilter() {
    const btn = document.getElementById('filter-favorites-btn');
    const list = document.getElementById('track-list');

    if (viewMode === 'favorites') {
      favoritesFilterActive = !favoritesFilterActive;
      if (favoritesFilterActive) {
        const anyActive = (favoritesRefsModel || []).some(x => x.__active);
        if (!anyActive) { favoritesFilterActive = false; NotificationSystem.warning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ —Å–æ ‚≠ê!'); return; }
        btn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò';
        btn.classList.add('filtered'); list.classList.add('filtered'); updateFavoriteClassesFavorites();
      } else {
        btn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏';
        btn.classList.remove('filtered'); list.classList.remove('filtered');
      }
      return;
    }

    const liked = getLiked();
    favoritesFilterActive = !favoritesFilterActive;
    if (favoritesFilterActive) {
      if (!liked.length){ NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤!'); favoritesFilterActive=false; return; }
      btn.textContent='–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò'; btn.classList.add('filtered'); list.classList.add('filtered'); updateFavoriteClasses();
    } else {
      btn.textContent='–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏'; btn.classList.remove('filtered'); list.classList.remove('filtered');
    }
  }
  function updateFavoritesCurrentRow(idx) {
    try {
      const rows = document.querySelectorAll('#track-list .track');
      rows.forEach(r => r.classList.remove('current'));
      const row = rows[idx];
      if (row) row.classList.add('current');
    } catch {}
  }
async function openFavoritesView(){
  applyRelizUiMode(false);
  viewMode = 'favorites';
  clearRelizView();
  setActiveAlbumIcon(SPECIAL_FAVORITES_KEY);
  setAlbumHeaderTitle(SPECIAL_FAVORITES_KEY);

  try {
    const lp = document.getElementById('lyricsplayerblock');
    const holder = document.getElementById('now-playing');
    if (lp && holder && !holder.contains(lp)) { holder.innerHTML = ''; holder.appendChild(lp); }
  } catch {}

  applyMiniModeUI();

  const cw = document.getElementById('cover-wrap'); if (cw) cw.style.display = 'none';

  await buildFavoritesRefsModel();

  const list = document.getElementById('track-list');
  list.style.display = '';
  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  let html = '<div style="text-align:center; opacity:.8; margin:6px 0 8px 0;">–ò–ó–ë–†–ê–ù–ù–´–ï –ü–ï–°–ù–ò</div>';

  (favoritesRefsModel || []).forEach((item, idx) => {
    const n = String(idx + 1).padStart(2,'0');
    const activeCls = item.__active ? '' : ' inactive';
    const star = item.__active ? 'img/star.png' : 'img/star2.png';
    const starTitle = item.__active ? '–°–Ω—è—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
    html += `
      <div class="track${activeCls}" id="fav_${item.__a}_${item.__t}" data-akey="${item.__a}" data-t="${item.__t}" data-idx="${idx}">
        <span class="tnum">${n}.</span>
        <span class="track-title" title="${item.title} ‚Äî ${item.__album}">
          ${item.title} <span style="opacity:.6;font-size:.9em;">‚Äî ${item.__album}</span>
        </span>
        <img src="${star}" class="like-star" alt="–∑–≤–µ–∑–¥–∞" title="${starTitle}">
      </div>`;
  });

  list.innerHTML = html;

  if (!list.__favDelegationInstalled) {
    list.__favDelegationInstalled = true;
    list.addEventListener('click', (e) => {
      const t = e.target instanceof Element ? e.target : null;
      if (!t) return;
      const row = t.closest('#track-list .track');
      if (!row) return;
      const a = row.getAttribute('data-akey');
      const ti = parseInt(row.getAttribute('data-t') || '-1', 10);
      const idx = parseInt(row.getAttribute('data-idx') || '-1', 10);

      // –ö–ª–∏–∫ –ø–æ –∑–≤–µ–∑–¥–µ
      if (t.closest('.like-star')) {
        e.stopPropagation();
        const wasActive = getLikedForAlbum(a).includes(ti);
        toggleLikeForAlbum(a, ti, !wasActive);
        updateFavRow({ a, t: ti }, !wasActive);
        updateFavoritesRefsModelActiveFlag(a, ti, !wasActive);

        if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
          if (wasActive) {
            if (favoritesRefsModel && favoritesRefsModel[playingTrack] &&
                favoritesRefsModel[playingTrack].__a === a &&
                favoritesRefsModel[playingTrack].__t === ti) {
              try { window.playerCore && window.playerCore.setShuffle(!!shuffleMode); } catch {}
              nextTrack();
            } else {
              try { window.playerCore && window.playerCore.setShuffle(!!shuffleMode); } catch {}
              updateNextUpLabel();
            }
            NotificationSystem.info('–¢—Ä–µ–∫ —Å–Ω—è—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
          } else {
            try { window.playerCore && window.playerCore.setShuffle(!!shuffleMode); } catch {}
            updateNextUpLabel();
            NotificationSystem.success('–¢—Ä–µ–∫ –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
          }
        } else {
          if (wasActive) NotificationSystem.info('–¢—Ä–µ–∫ —Å–Ω—è—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
          else NotificationSystem.success('–¢—Ä–µ–∫ –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
        }
        return;
      }

      // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ
      const modelItem = favoritesRefsModel?.[idx];
      if (!modelItem) return;
      if (modelItem.__active) {
        ensureFavoritesPlayback(idx);
      } else {
        showFavInactivePrompt({ a, t: ti, title: modelItem.title, album: modelItem.__album });
      }
    });
  }

  if (playingAlbumKey === SPECIAL_FAVORITES_KEY && typeof playingTrack === 'number' && playingTrack >= 0) {
    updateFavoritesCurrentRow(playingTrack);
    const rows = Array.from(document.querySelectorAll('#track-list .track'));
    const rowUnder = rows[playingTrack];
    const lp = document.getElementById('lyricsplayerblock');
    if (rowUnder && lp && rowUnder.parentNode) {
      if (rowUnder.nextSibling) rowUnder.parentNode.insertBefore(lp, rowUnder.nextSibling);
      else rowUnder.parentNode.appendChild(lp);
    }
  }

  applyMiniModeUI();
  list.classList.remove('filtered');
}
  function updateFavRow(ref, active){
    const row = document.getElementById(`fav_${ref.a}_${ref.t}`); if (!row) return;
    row.classList.toggle('inactive', !active);
    const star = row.querySelector('.like-star');
    if (star) { star.src = active ? 'img/star.png' : 'img/star2.png'; star.title = active ? '–°–Ω—è—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'; }
  }
  function toggleLikeForAlbum(albumKey, idx, makeLiked){
    const map = getLikedMap();
    const arr = Array.isArray(map[albumKey]) ? map[albumKey] : [];
    const has = arr.includes(idx);
    let next = arr.slice();
    if (makeLiked && !has) next.push(idx);
    if (!makeLiked && has) next = next.filter(x=>x!==idx);
    map[albumKey] = Array.from(new Set(next));
    try { localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map)); } catch {}
  }
  function showFavInactivePrompt(ref){
    const modal = document.createElement('div');
    modal.className = 'modal-bg active';
    modal.innerHTML = `
      <div class="modal-feedback" style="max-width: 380px;">
        <button class="bigclose" onclick="this.closest('.modal-bg').remove()" title="–ó–∞–∫—Ä—ã—Ç—å">
          <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
        </button>
        <div style="font-weight:700; margin-bottom:10px;">–¢—Ä–µ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</div>
        <div style="opacity:.8; margin-bottom:14px;">
          –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞ —Å–ª—É—à–∞—Ç—å —Ç—Ä–µ–∫ –≤ ¬´–ò–ó–ë–†–ê–ù–ù–û–ú¬ª ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.
          –õ–∏–±–æ —É–¥–∞–ª–∏—Ç–µ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.
        </div>
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
          <button class="offline-btn online" style="min-width:140px;" id="fav-add-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ ‚≠ê</button>
          <button class="offline-btn" style="min-width:140px;" id="fav-del-btn">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
    modal.querySelector('#fav-add-btn').onclick = ()=>{ toggleLikeForAlbum(ref.a, ref.t, true); updateFavRow(ref, true); updateFavoritesRefsModelActiveFlag(ref.a, ref.t, true); modal.remove(); NotificationSystem.success('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'); };
    modal.querySelector('#fav-del-btn').onclick = ()=>{ modal.remove(); showFavDeleteConfirm(ref); };
  }
  function showFavDeleteConfirm(ref){
    const modal = document.createElement('div');
    modal.className = 'modal-bg active';
    modal.innerHTML = `
      <div class="modal-feedback" style="max-width: 390px;">
        <button class="bigclose" onclick="this.closest('.modal-bg').remove()" title="–ó–∞–∫—Ä—ã—Ç—å">
          <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
        </button>
        <div style="font-weight:700; margin-bottom:10px;">–£–¥–∞–ª–∏—Ç—å –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª?</div>
        <div style="opacity:.8; margin-bottom:12px;">
          –ï—Å–ª–∏ –≤—ã —É–¥–∞–ª–∏—Ç–µ —Ç—Ä–µ–∫, –æ–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª, –Ω–æ –≤—ã –≤—Å–µ–≥–¥–∞ —Å–º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –µ–≥–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
          <button class="offline-btn" style="min-width:120px;" id="fav-del-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="offline-btn online" style="min-width:120px;" id="fav-del-apply">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>`;
    document.body.appendChild(modal);

    modal.querySelector('#fav-del-cancel').onclick = ()=> modal.remove();
    modal.querySelector('#fav-del-apply').onclick = ()=>{
      const refs = readFavoritesRefs().filter(x=> !(x.a===ref.a && x.t===ref.t));
      writeFavoritesRefs(refs);
      document.getElementById(`fav_${ref.a}_${ref.t}`)?.remove();
      if (Array.isArray(favoritesRefsModel)) {
        favoritesRefsModel = favoritesRefsModel.filter(x => !(x.__a === ref.a && x.__t === ref.t));
        const rows = document.querySelectorAll('#track-list .track');
        rows.forEach((row, i) => { const tnum = row.querySelector('.tnum'); if (tnum) tnum.textContent = `${String(i + 1).padStart(2,'0')}.`; });
      }
      modal.remove();
      NotificationSystem.success('–£–¥–∞–ª–µ–Ω–æ –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª');
    };
  }

  /* Prefetch —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞ */
  function prefetchNextTrackAssetsForPlayback() {
    try {
      const pc = window.playerCore;
      if (!pc || typeof pc.getNextIndex !== 'function') return;
      const nextIdx = pc.getNextIndex();
      const snap = typeof pc.getPlaylistSnapshot === 'function' ? pc.getPlaylistSnapshot() : null;
      if (Number.isInteger(nextIdx) && nextIdx >= 0 && snap && snap[nextIdx]) {
        const t = snap[nextIdx];
        if (t?.cover) prefetchAudioLink(t.cover, 'image');
        if (t?.lyrics) prefetchAudioLink(t.lyrics, 'fetch');
        // –∞—É–¥–∏–æ URL –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Howler options; –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–≤—Ä–∏—Å—Ç–∏–∫–∏:
        // –µ—Å–ª–∏ src –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å–Ω–∞–ø—à–æ—Ç–µ ‚Äî –ø—Ä–æ–≥—Ä–µ–µ–º
        if (t?.src) prefetchAudioLink(t.src, 'audio');
      }
      // –ü—Ä–∏ Repeat ‚Äî –¥–µ—Ä–∂–∏–º —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ —Ç—ë–ø–ª—ã–º
      const curIdx = typeof pc.getIndex === 'function' ? pc.getIndex() : -1;
      if (repeatMode && curIdx >= 0 && snap && snap[curIdx] && snap[curIdx].src) {
        prefetchAudioLink(snap[curIdx].src, 'audio');
      }
    } catch {}
  }

  function prefetchAudioLink(url, asType = 'audio') {
    if (!url) return;
    try {
      // –ü—Ä–æ–≥—Ä–µ–≤–∞–µ–º —á–µ—Ä–µ–∑ SW, —á—Ç–æ–±—ã –ø–æ–ª–æ–∂–∏—Ç—å –æ—Ç–≤–µ—Ç –≤ MEDIA_CACHE
      fetch(url, { cache: 'reload', mode: 'cors' }).catch(()=>{});
    } catch (e) {}
  }

  /* –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏—Ä–∏–∫–∏ */
  function loadLyrics(file){ fetch(file).then(r=>r.json()).then(js=>{ currentLyrics=js; renderLyrics(0); }).catch(()=>{ currentLyrics=[]; }); }

  /* –í—Ä–µ–º—è/—Ö–æ—Ç–∫–µ–∏/–º–æ–¥–∞–ª–∫–∏ */
  function formatTime(sec){ if (isNaN(sec)||sec<0) return '--:--'; const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

  // –†–∞–∑–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤—Ä–µ–º–µ–Ω–∏/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ—Ç PlayerCore
  function updateUiFromCoreOnce() {
    try {
      const pc = window.playerCore;
      if (!pc) return;
      const dur = pc.getDuration ? (pc.getDuration() || 0) : 0;
      const pos = pc.getSeek ? (pc.getSeek() || 0) : 0;
      const elapsedEl = document.getElementById('time-elapsed');
      const remainingEl = document.getElementById('time-remaining');
      const fill = document.getElementById('player-progress-fill');
      if (elapsedEl) elapsedEl.textContent = formatTime(pos);
      if (remainingEl) remainingEl.textContent = formatTime(Math.max(0, dur - pos));
      if (fill && dur > 0) fill.style.width = `${(pos / dur) * 100}%`;
    } catch {}
  }

  window.addEventListener('keydown', function(e){
    if (e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
    const hasModal = document.querySelector('.modal-bg.active');
    if (e.key==='Escape' && hasModal){ e.preventDefault(); document.querySelectorAll('.modal-bg.active').forEach(m=>m.classList.remove('active')); return; }
    if (hasModal) return;
    // source: Howler (PlayerCore)
    switch(e.key.toUpperCase()){
      case ' ': case 'K': e.preventDefault(); togglePlayPause(); break;
      case 'X': e.preventDefault(); stopPlayback(); break;
      case 'N': e.preventDefault(); nextTrack(); break;
      case 'P': e.preventDefault(); previousTrack(); break;
      case 'J': e.preventDefault(); { const pc = window.playerCore; if (pc && pc.seek) pc.seek(Math.max(0, (pc.getSeek?.() || 0) - 10)); } break;
      case 'L': e.preventDefault(); { const pc = window.playerCore; if (pc && pc.seek) { const dur = pc.getDuration?.() || 0; pc.seek(Math.min(dur, (pc.getSeek?.() || 0) + 10)); } } break;
      case '+': case '=': e.preventDefault(); const vs1=document.getElementById('volume-slider'); if (vs1){ vs1.value=Math.min(100, parseInt(vs1.value||'100') + 10); vs1.dispatchEvent(new Event('input')); } break;
      case '-': e.preventDefault(); const vs2=document.getElementById('volume-slider'); if (vs2){ vs2.value=Math.max(0, parseInt(vs2.value||'100') - 10); vs2.dispatchEvent(new Event('input')); } break;
      case 'M': case '0': e.preventDefault(); toggleMute(); break;
      case 'R': e.preventDefault(); toggleRepeat(); break;
      case 'U': e.preventDefault(); toggleShuffle(); break;
      case 'F': e.preventDefault(); toggleFavoritesOnly(); break;
      case 'T': e.preventDefault(); toggleSleepMenu(); break;
      case 'A': e.preventDefault(); toggleAnimation(); break;
      case 'B': e.preventDefault(); toggleBit(); break;
      case 'O':
        e.preventDefault();
        autoNextDisabled = !autoNextDisabled;
        if (repeatMode && autoNextDisabled) {
          NotificationSystem.info('–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –æ–ø—Ü–∏—è ¬´–û–¥–∏–Ω —Ç—Ä–µ–∫¬ª –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞');
        } else {
          NotificationSystem.info(autoNextDisabled ? '‚èπ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç–∫–ª—é—á—ë–Ω' : '‚ñ∂ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –≤–∫–ª—é—á—ë–Ω');
        }
        break;
      case '1': if (bitEnabled){ bitIntensity=100; localStorage.setItem('bitIntensity','100'); NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: 100%'); } break;
      case '2': if (bitEnabled){ bitIntensity=50; localStorage.setItem('bitIntensity','50'); NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: 50%'); } break;
      case '3': if (bitEnabled){ bitIntensity=15; localStorage.setItem('bitIntensity','15'); NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: 15%'); } break;
      case 'Y': e.preventDefault(); if (currentTrack>=0) toggleLyricsView(); break;
      case 'W': e.preventDefault(); document.getElementById('track-list')?.scrollIntoView({behavior:'smooth'}); break;
      case 'D':
        e.preventDefault();
        if (isBrowsingSameAsPlaying()) { if (playingTrack >= 0) toggleLike(playingTrack); }
        else { toggleLikePlaying(); }
        break;
      case '?': e.preventDefault(); showHotkeysModal(); break;
    }
    if (e.key>='1' && e.key<='9' && !e.shiftKey && !e.ctrlKey && !e.altKey){
      const i=parseInt(e.key)-1; if (config && i<config.tracks.length){ e.preventDefault(); showTrack(i,true); }
    }
  });
  function showHotkeysModal(){ document.getElementById('hotkeys-modal').classList.add('active'); }
  function closeHotkeysModal(){ document.getElementById('hotkeys-modal').classList.remove('active'); }

  /* –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å */
  function openFeedbackModal(){ document.getElementById('modal-feedback').classList.add('active'); }
  function closeFeedbackModal(){ document.getElementById('modal-feedback').classList.remove('active'); }

  /* Deep Link */
  function parseDeepLink(){
    const params = new URLSearchParams(location.search);
    const view = params.get('view');
    if (view === 'favorites') { openFavoritesView(); return; }
    const albumParam = params.get('album');
    if (albumParam && albumByKey(albumParam) && albumParam !== currentAlbumKey) {
      const sel = document.getElementById('album-select');
      sel.value = albumParam;
      loadAlbumByKey(albumParam);
      return;
    }
    const t = params.get('track');
    if (t && config){
      const idx=parseInt(t,10);
      if (!isNaN(idx) && idx>=0 && idx<config.tracks.length){
        showTrack(idx,true);
        const timeParam = parseInt(params.get('time')||'0', 10);
        if (!isNaN(timeParam) && timeParam > 0) {
          setTimeout(()=> {
            try { window.playerCore && window.playerCore.seek && window.playerCore.seek(timeParam); } catch {}
          }, 600);
        }
        setTimeout(()=>document.getElementById(`trk${idx}`)?.scrollIntoView({behavior:'smooth',block:'center'}), 300);
      }
    }
  }

  /* –°–∫–∞—á–∏–≤–∞–Ω–∏—è: —Ç—Ä–µ–∫/–∞–ª—å–±–æ–º */
  function getTrackFileName(track, idx, artist){ return `${String(idx+1).padStart(2,'0')} - ${track.title} - ${artist}.mp3`.replace(/[\\/:"*?<>|]+/g,'_'); }
  function openDownloadModal(e){
    if (e) e.preventDefault();
    const pc = getPlayerConfig(); const tr = pc?.tracks?.[playingTrack];
    if (!tr) return;
    const fn = getTrackFileName(tr, playingTrack, pc.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞');
    document.getElementById('download-modal-filename').innerHTML=`<b>${fn}</b>`;
    document.getElementById('download-modal').classList.add('active');
  }
  async function downloadCurrentTrack(){
    const pc = getPlayerConfig(); const tr = pc?.tracks?.[playingTrack];
    if (!tr) return;
    const fn = getTrackFileName(tr, playingTrack, pc.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞');
    const a=document.createElement('a'); a.href=tr.audio; a.download=fn;
    document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); },250);
    closeDownloadModal(); NotificationSystem.success('–§–∞–π–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
  }
  async function shareCurrentTrack(){
    const pc = getPlayerConfig(); const tr = pc?.tracks?.[playingTrack];
    if (!tr) return;
    const t = (window.playerCore && window.playerCore.getSeek) ? Math.floor(window.playerCore.getSeek() || 0) : 0;
    const timeParam = t > 10 ? `&time=${t}` : '';
    const shareUrl = location.origin + location.pathname + `?album=${playingAlbumKey}&track=${playingTrack}${timeParam}`;
    const txt = `üéµ ${tr.title} - ${pc.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞'}\nüéß –°–ª—É—à–∞–π:`;
    if (navigator.share){
      try { await navigator.share({title: tr.title, text: txt, url: shareUrl}); NotificationSystem.success('–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!'); closeDownloadModal(); } catch {}
    } else {
      await navigator.clipboard.writeText(`${txt}\n${shareUrl}`);
      NotificationSystem.success('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    }
  }

  function copyLinkCurrentTrack(){
    const pc = getPlayerConfig(); const tr = pc?.tracks?.[playingTrack];
    if (!tr) return;
    const directUrl = tr.audio;
    if (navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(directUrl).then(()=>NotificationSystem.success('–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'),()=>NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
    } else {
      const ta=document.createElement('textarea'); ta.value=directUrl; document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); NotificationSystem.success('–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); }catch{ NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
      document.body.removeChild(ta);
    }
    closeDownloadModal();
  }
  function closeDownloadModal(){ const m = document.getElementById('download-modal'); if (m) m.classList.remove('active'); }

  function openAlbumDownloadModal(){ document.getElementById('albumDownloadModal').classList.add('active'); checkFavoritesAvailable(); }
  function closeAlbumDownloadModal(){ document.getElementById('albumDownloadModal').classList.remove('active'); }
  document.getElementById('albumDownloadModal').onclick = function(e){ if (e.target===this) closeAlbumDownloadModal(); };
  function checkFavoritesAvailable(){ const favCheckbox=document.getElementById('onlyFavorites'); const liked=getLiked(); favCheckbox.disabled = liked.length===0; favCheckbox.parentElement.style.opacity = liked.length===0 ? '.5' : '1'; }

  function loadJSZip(){ if (window.JSZip) return Promise.resolve(); return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

  // –°–æ–±–∏—Ä–∞–µ–º —Ñ–∞–π–ª—ã –≥–∞–ª–µ—Ä–µ–∏ —Ç–µ–∫—É—â–µ–≥–æ –∞–ª—å–±–æ–º–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
  async function gatherGalleryFilesForAlbum(albumKey) {
    const id = centralIdForAlbumKey(albumKey);
    if (!id) return [];
    try {
      const baseDir = `${CENTRAL_GALLERY_BASE}${id}/`;
      const r = await fetch(baseDir + 'index.json', { cache: 'no-cache' });
      if (!r.ok) return [];
      const j = await r.json();
      const arr = Array.isArray(j.items) ? j.items : (Array.isArray(j) ? j : []);
      const files = [];
      for (const raw of arr) {
        const norm = normalizeGalleryItem(raw, baseDir);
        if (!norm || norm.type !== 'img') continue;
        const src = norm.formats?.full || norm.src;
        if (src) {
          const name = src.split('/').pop();
          files.push({ url: src, name: `gallery/${name}`, type: 'image' });
        }
      }
      return files;
    } catch { return []; }
  }

  async function prepareFilesList(){
    filesToDownload=[]; const added = new Set();
    const liked = getLiked();
    let idxs = [];
    const onlyFav = document.getElementById('onlyFavorites').checked;
    const fullAlbum = document.getElementById('fullAlbum').checked;
    if (onlyFav && liked.length>0) idxs = liked;
    else if (fullAlbum) idxs = config.tracks.map((_,i)=>i);

    for (const i of idxs){
      const t=config.tracks[i]; const num=String(i+1).padStart(2,'0'); const name=`${num} - ${t.title} - ${config.artist}.mp3`;
      if (!added.has(name)){ added.add(name); filesToDownload.push({url: t.audio, name, type:'audio'}); }
      if (document.getElementById('includeLyrics').checked && t.fulltext){
        const n2 = `${num} - ${t.title} - ${config.artist}.txt`;
        if (!added.has(n2)){ added.add(n2); try{ const r=await fetch(t.fulltext); const text=await r.text(); filesToDownload.push({content:text, name:n2, type:'text'}); }catch{} }
      }
    }
    if (document.getElementById('includeCovers').checked){
      const galleryFiles = await gatherGalleryFilesForAlbum(currentAlbumKey);
      for (const f of galleryFiles) {
        if (!added.has(f.name)){ added.add(f.name); filesToDownload.push(f); }
      }
      // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî –µ—Å–ª–∏ –≥–∞–ª–µ—Ä–µ—è –ø—É—Å—Ç–∞, –ø–æ–ª–æ–∂–∏–º –ª–æ–≥–æ—Ç–∏–ø
      if (galleryFiles.length === 0) {
        const nm = 'logo.png';
        if (!added.has(nm)){ added.add(nm); filesToDownload.push({ url: 'img/logo.png', name: nm, type: 'image' }); }
      }
    }
    if (!added.has('logo.png')) filesToDownload.push({url:'img/logo.png', name:'logo.png', type:'image'});
    if (!added.has('social.txt')) filesToDownload.push({content: generateSocialText(), name:'social.txt', type:'text'});
  }
  function generateSocialText(){
    const s = (config && config.socials) ? config.socials : [];
    const lines = s.map(one=>`${one.title}: ${one.url}`).join('\n');
    return `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         –í–ò–¢–†–ò–ù–ê –†–ê–ó–ë–ò–¢–ê ‚Äî ${config?.albumName||'–ê–ª—å–±–æ–º'}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–∞—à–µ–º—É —Ç–≤–æ—Ä—á–µ—Å—Ç–≤—É!
–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –Ω–∞—Å –∏ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å:

${lines}

–° –ª—é–±–æ–≤—å—é, "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
  }
  async function prepareDownload(){
    await loadJSZip();
    await prepareFilesList();
    if (!filesToDownload.length) return NotificationSystem.error('–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞');

    const sizeMB = await calculateArchiveSize();
    document.getElementById('archiveSize').textContent = sizeMB+' –ú–ë';
    document.getElementById('fileCount').textContent = filesToDownload.length;
    closeAlbumDownloadModal();
    document.getElementById('sizeConfirmModal').classList.add('active');
  }
  function closeSizeConfirmModal(){ document.getElementById('sizeConfirmModal').classList.remove('active'); }
  document.getElementById('sizeConfirmModal').onclick = function(e){ if (e.target===this) closeSizeConfirmModal(); };
  async function calculateArchiveSize(){
    let total=0; const promises=[];
    for (const f of filesToDownload){
      if (f.url){
        const head = fetch(f.url, {method:'HEAD'}).then(r=>{ const s=r.headers.get('content-length'); return s?parseInt(s):null; }).catch(()=>null);
        const heur = new Promise(r=>setTimeout(()=>r(f.type==='audio'? 5*1024*1024 : f.type==='image'? 500*1024 : 10*1024),500));
        promises.push(Promise.race([head,heur]).then(sz=>{ if (sz) total+=sz; }));
      } else if (f.content){
        total += new Blob([f.content]).size;
      }
    }
    await Promise.allSettled(promises);
    total = Math.ceil(total*1.1);
    return (total/1024/1024).toFixed(1);
  }
  function startDownload(){ document.getElementById('sizeConfirmModal').classList.remove('active'); createAndDownloadZip(); }
  function showProgressModal(){ document.getElementById('downloadProgressModal').classList.add('active'); document.getElementById('progressFill').style.width='0%'; document.getElementById('progressText').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/${filesToDownload.length}`; document.getElementById('errorsList').style.display='none'; }
  function updateProgress(done,total){ document.getElementById('progressFill').style.width = `${Math.round(done/total*100)}%`; document.getElementById('progressText').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: ${done}/${total}`; }
  function showErrors(errors){ if (errors.length){ document.getElementById('errorsList').style.display='block'; document.getElementById('errorsListContent').innerHTML = errors.map(e=>`<li>${e}</li>`).join(''); } }
  async function createAndDownloadZip(){
    await loadJSZip();
    const zip = new JSZip(); const errors=[]; let done=0;
    showProgressModal();
    const BATCH=5;
    for (let i=0;i<filesToDownload.length;i+=BATCH){
      const batch=filesToDownload.slice(i,i+BATCH);
      await Promise.allSettled(batch.map(async f=>{
        try {
          if (f.url){ const r=await fetch(f.url); if (!r.ok) throw new Error(`HTTP ${r.status}`); const b=await r.blob(); zip.file(f.name,b); }
          else zip.file(f.name, f.content);
          done++; updateProgress(done, filesToDownload.length);
        } catch(e){ errors.push(f.name); done++; updateProgress(done, filesToDownload.length); }
      }));
    }
    if (errors.length){ showErrors(errors); await new Promise(r=>setTimeout(r,1500)); }
    document.getElementById('progressText').textContent='–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
    const content = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}}, meta=>{
      document.getElementById('progressText').textContent = `–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${meta.percent.toFixed(0)}%`;
      document.getElementById('progressFill').style.width = `${meta.percent.toFixed(0)}%`;
    });
    const a=document.createElement('a'); a.href=URL.createObjectURL(content);
    const date=new Date().toISOString().split('T')[0];
    const albumName = (config?.albumName || 'album').replace(/[\\/:"*?<>|]+/g,'_');
    a.download = `vitrina-razbita-${albumName}-${date}.zip`; a.click();
    setTimeout(()=>{ document.getElementById('downloadProgressModal').classList.remove('active'); URL.revokeObjectURL(a.href); NotificationSystem.success('–ê—Ä—Ö–∏–≤ —Å–∫–∞—á–∞–Ω!'); }, 800);
  }

  /* Sleep */
  function toggleSleepMenu(){ const menu=document.getElementById('sleep-menu'); menu.classList.toggle('active'); if (menu.classList.contains('active')) setTimeout(()=>document.addEventListener('click', closeSleepMenu),100); }
  function closeSleepMenu(e){ if (e && e.target.closest('#sleep-timer-btn')) return; document.getElementById('sleep-menu').classList.remove('active'); document.removeEventListener('click', closeSleepMenu); }
  function setSleepTimer(minutes) {
    closeSleepMenu();
    if (minutes === 'off') {
      clearSleepTimer();
      return;
    }
    const ms = minutes * 60 * 1000;
    try { window.playerCore && window.playerCore.setSleepTimer(ms); } catch {}
    sleepTimerTarget = Date.now() + ms; // –ª–æ–∫–∞–ª—å–Ω–∞—è —Ç–µ–Ω—å –¥–ª—è –±–µ–π–¥–∂–∞/–æ–≤–µ—Ä–ª–µ—è
    updateSleepTimerUI();
    if (sleepTimerInterval) clearInterval(sleepTimerInterval);
    sleepTimerInterval = setInterval(checkSleepTimer, 1000);
  }
  </script>

  <script>
  /* ====== –¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/sleep.js ====== */
  /* ====== –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏, ¬´–±–∏—Ç¬ª (–ø—É–ª—å—Å –ª–æ–≥–æ) ====== */
  function toggleAnimation() {
    if (energySaver) { NotificationSystem.info('–û—Ç–∫–ª—é—á–µ–Ω–æ –≤ —Ä–µ–∂–∏–º–µ —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è'); return; }
    applyAnimationState(!animationEnabled);
    localStorage.setItem('animationEnabled', animationEnabled ? '1' : '0');
    NotificationSystem.info(animationEnabled ? '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏: –í–ö–õ' : '‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏: –í–´–ö–õ');
  }
  function applyAnimationState(on) {
    animationEnabled = !!on;
    const win = document.getElementById('lyrics-window');
    const bg = win ? win.querySelector('.lyrics-animated-bg') : null;
    if (win) win.classList.toggle('animation-active', animationEnabled);
    if (bg) bg.classList.toggle('active', animationEnabled);
    const btn = document.getElementById('animation-btn');
    if (btn) btn.classList.toggle('animation-active', animationEnabled);
  }

  function toggleBit() {
    if (energySaver) { NotificationSystem.info('–ü—É–ª—å—Å–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è'); return; }
    bitEnabled = !bitEnabled;
    localStorage.setItem('bitEnabled', bitEnabled ? '1' : '0');
    const btn = document.getElementById('bit-btn');
    if (btn) btn.classList.toggle('bit-active', bitEnabled);
    if (bitEnabled) {
      initAudioContext();
      startLogoPulsation();
      NotificationSystem.info(`üíø –ü—É–ª—å—Å–∞—Ü–∏—è: –í–ö–õ (${bitIntensity}%)`);
    } else {
      stopLogoPulsation();
      NotificationSystem.info('üíø –ü—É–ª—å—Å–∞—Ü–∏—è: –í–´–ö–õ');
    }
  }
  function initAudioContext() {
    try {
      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      if (analyser && audioContext) return;

      const pc = window.playerCore;
      const howl = pc && pc.howl ? pc.howl : null;

      // 1) WebAudio-—Ä–µ–∂–∏–º Howler: –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ masterGain
      if (window.Howler && window.Howler.ctx) {
        audioContext = window.Howler.ctx;
        if (!analyser) {
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
        }
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º masterGain ‚Üí analyser (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ—Å–Ω–æ–≤–Ω—ã–º –≤—ã–≤–æ–¥–æ–º)
        if (window.Howler.masterGain && typeof window.Howler.masterGain.connect === 'function') {
          try { window.Howler.masterGain.connect(analyser); } catch {}
        }
        return;
      }

      // 2) Fallback (html5=true –≤–Ω—É—Ç—Ä–∏ Howler): MediaElementSource –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É–∑–ª–∞
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContext.state === 'suspended') { audioContext.resume().catch(()=>{}); }

      if (!analyser) {
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
      }

      // –î–æ—Å—Ç–∞—ë–º HTMLAudioElement –∏–∑ Howler (html5 –ø—É—Ç—å)
      const node = howl && howl._sounds && howl._sounds[0] && howl._sounds[0]._node;
      if (node && !audioSource) {
        audioSource = audioContext.createMediaElementSource(node);
        audioSource.connect(analyser);
        // –ù–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫ destination ‚Äî –∑–≤—É–∫ –∏ —Ç–∞–∫ –∏–¥—ë—Ç –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞
      }
    } catch {}
  }

  function startLogoPulsation() {
    const logo = document.getElementById('logo-bottom');
    if (!logo) return;
    if (animationFrame) cancelAnimationFrame(animationFrame);
    const dataArray = new Uint8Array(analyser ? analyser.frequencyBinCount : 32);
    let t0 = performance.now();
    let lastUpdate = 0;

    function loop(ts) {
      if (!bitEnabled || !logo) return;

      // –≠–ö–û: –æ–≥—Ä–∞–Ω–∏—á–∏–º —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      const ecoInterval = window.ultraEcoEnabled ? (window.__uiUpdateMinIntervalMs || 1000) : 0;
      if (ecoInterval && (ts - lastUpdate) < ecoInterval) {
        animationFrame = requestAnimationFrame(loop);
        return;
      }
      lastUpdate = ts;

      const dt = (ts - t0) / 1000;
      t0 = ts;

      let level = 0.35;
      if (analyser) {
        analyser.getByteFrequencyData(dataArray);
        const bassCount = Math.max(4, Math.floor(dataArray.length * 0.2));
        let sum = 0;
        for (let i = 0; i < bassCount; i++) sum += dataArray[i];
        level = (sum / (bassCount * 255));
      } else {
        level = 0.5 + 0.5 * Math.sin(ts / 200);
      }

      const intensity = Math.max(0, Math.min(1, bitIntensity / 100));
      const scale = 1 + (level * 0.12 * intensity);
      logo.style.transform = `scale(${scale.toFixed(3)})`;
      animationFrame = requestAnimationFrame(loop);
    }
    animationFrame = requestAnimationFrame(loop);
  }

  function stopLogoPulsation() {
    if (animationFrame) { cancelAnimationFrame(animationFrame); animationFrame = null; }
    const logo = document.getElementById('logo-bottom');
    if (logo) logo.style.transform = 'scale(1)';
    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∞—É–¥–∏–æ-—Ä–µ—Å—É—Ä—Å—ã
    try { if (audioSource) { audioSource.disconnect(); audioSource = null; } } catch {}
    try { if (analyser) { analyser.disconnect(); analyser = null; } } catch {}
    try {
      const howlerCtx = (window.Howler && window.Howler.ctx) ? window.Howler.ctx : null;
      if (audioContext && audioContext !== howlerCtx && audioContext.state !== 'closed' && typeof audioContext.close === 'function') {
        audioContext.close().catch(()=>{});
      }
    } catch {}
    // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º Howler.ctx ‚Äî –Ω–µ –æ–±–Ω—É–ª—è–µ–º –µ–≥–æ
    if (window.Howler && window.Howler.ctx && audioContext === window.Howler.ctx) {
      analyser = null;
      audioSource = null;
    } else {
      audioContext = null;
    }
  }

  /* ====== –£–ª—å—Ç—Ä–∞‚Äë—ç–∫–æ–Ω–æ–º: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ/–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ====== */
  function applyEcoState(on, { silent = false } = {}) {
    ultraEcoEnabled = !!on;
    // –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥–∏
    const ecoSec = Math.max(2, Math.min(60, parseInt(localStorage.getItem('ecoUiIntervalSec') || '5', 10)));
    __uiUpdateMinIntervalMs = ultraEcoEnabled ? (ecoSec * 1000) : 1000;
    __progressThrottleMs    = ultraEcoEnabled ? (ecoSec * 1000) : 1000;

    // –ê–Ω–∏–º–∞—Ü–∏–∏/–±–∏—Ç/–≥–∞–ª–µ—Ä–µ—è
    if (ultraEcoEnabled) {
      if (__savedAnimationBeforeEco === null) __savedAnimationBeforeEco = animationEnabled;
      if (__savedBitBeforeEco === null) __savedBitBeforeEco = bitEnabled;
      if (animationEnabled) applyAnimationState(false);
      if (bitEnabled) stopLogoPulsation();
      if (coverAutoplay) { clearInterval(coverAutoplay); coverAutoplay = null; }
    } else {
      if (__savedAnimationBeforeEco !== null) { applyAnimationState(__savedAnimationBeforeEco); __savedAnimationBeforeEco = null; }
      if (__savedBitBeforeEco) { try { initAudioContext(); startLogoPulsation(); } catch {} }
      __savedBitBeforeEco = null;
      if (!coverAutoplay && Array.isArray(coverGalleryArr) && coverGalleryArr.length > 1 && !document.hidden && !energySaver) {
        startCoverAutoPlay();
      }
    }

    // UI –∫–Ω–æ–ø–∫–∞
    try { const eb = document.getElementById('eco-btn'); if (eb) eb.classList.toggle('eco-active', ultraEcoEnabled); } catch {}

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Ä—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ)
    try { localStorage.setItem('ultraEco', ultraEcoEnabled ? '1' : '0'); } catch {}

    if (!silent) {
      NotificationSystem.info(ultraEcoEnabled ? '‚ö° –£–ª—å—Ç—Ä–∞‚Äë—ç–∫–æ–Ω–æ–º: –í–ö–õ' : '‚ö° –£–ª—å—Ç—Ä–∞‚Äë—ç–∫–æ–Ω–æ–º: –í–´–ö–õ');
    }

    // –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ ¬´—Ñ–æ–Ω–∞¬ª –∏–ª–∏ –≤—ã–∫–ª—é—á–∞–µ–º —ç–∫–æ ‚Äî –ø—Ä–∏–≤–µ—Å—Ç–∏ UI –∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
    if (!document.hidden) {
      updateUiFromCoreOnce();
    }
  }

  function toggleEco() {
    // –ï—Å–ª–∏ –¥–æ —ç—Ç–æ–≥–æ –∞–≤—Ç–æ-–≤–∫–ª—é—á–∏–ª–∏ –∏–∑ —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è ‚Äî –¥–∞–ª—å—à–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
    __ecoAutoFromEnergy = false;
    applyEcoState(!ultraEcoEnabled);
  }

  function handleLogoClick() {
    // –õ—ë–≥–∫–∏–π ¬´—Ç—ã—á–æ–∫¬ª
    const logo = document.getElementById('logo-bottom');
    if (!logo) return;
    logo.style.transition = 'transform .08s ease-out';
    logo.style.transform = 'scale(1.13)';
    setTimeout(() => { logo.style.transform = 'scale(1)'; logo.style.transition = 'transform .1s ease-out'; }, 120);
  }

  /* ====== –ú–æ–¥–∞–ª –ª–∏—Ä–∏–∫–∏ ====== */
  let lyricsModalFont = 16;
  function openLyricsModal() {
    // –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/modals.js
    if (window.UIModals && typeof window.UIModals.openLyricsModal === 'function') {
      return window.UIModals.openLyricsModal();
    }
  }

  function closeLyricsModal() {
    if (window.UIModals && typeof window.UIModals.closeLyricsModal === 'function') {
      return window.UIModals.closeLyricsModal();
    }
  }
  function buildFallbackLyricsText() {
    if (window.UIModals && typeof window.UIModals.buildFallbackLyricsText === 'function') {
      return window.UIModals.buildFallbackLyricsText();
    }
    return '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.';
  }
  function copyLyricsFromModal() {
    if (window.UIModals && typeof window.UIModals.copyLyricsFromModal === 'function') {
      return window.UIModals.copyLyricsFromModal();
    }
  }

  async function shareLyricsFromModal() {
    if (window.UIModals && typeof window.UIModals.shareLyricsFromModal === 'function') {
      return window.UIModals.shareLyricsFromModal();
    }
  }

  function zoomLyrics(delta) {
    if (window.UIModals && typeof window.UIModals.zoomLyrics === 'function') {
      return window.UIModals.zoomLyrics(delta);
    }
  }

  function toggleLyricsFullscreen() {
    if (window.UIModals && typeof window.UIModals.toggleLyricsFullscreen === 'function') {
      return window.UIModals.toggleLyricsFullscreen();
    }
  }

  function exitLyricsFullscreenIfAny() {
    if (window.UIModals && typeof window.UIModals.exitLyricsFullscreenIfAny === 'function') {
      return window.UIModals.exitLyricsFullscreenIfAny();
    }
  }

  /* ====== Player State ====== */
  // –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π, —á—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞—Ç—å –≤ localStorage –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
  let __psSaveTs = 0;
  function savePlayerStateThrottled(force = false) {
    const now = Date.now();
    if (!force && (now - __psSaveTs) < 5000) return;
    __psSaveTs = now;
    try { (window.PlayerState && window.PlayerState.save && window.PlayerState.save()); } catch {}
  }
  // –¢–æ–Ω–∫–∞—è –ø—Ä–æ—Å–ª–æ–π–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏–∑ scripts/player-adapter.js
  const PlayerState = window.PlayerState || { save: ()=>{}, restore: ()=>null };

  /* ====== PWA / iOS —É—Å—Ç–∞–Ω–æ–≤–∫–∞ ====== */
  function detectIOSAndShowInstallGuide() {
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if (!isIOS || isStandalone) return;

    // –ü–æ—è–≤–∏—Ç—Å—è —Å–ø—É—Å—Ç—è 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      if (localStorage.getItem('iosInstallDismissed') === '1') return;
      let el = document.querySelector('.ios-install-prompt');
      if (!el) {
        el = document.createElement('div');
        el.className = 'ios-install-prompt';
        el.innerHTML = `
          <button class="ios-prompt-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="dismissIOSPrompt()">√ó</button>
          <div class="ios-prompt-content">
            <img class="ios-prompt-icon" src="icons/apple-touch-icon.png" alt="">
            <div style="font-weight:800; font-size:18px; margin-bottom:8px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
            <div style="opacity:.85;">–ù–∞–∂–º–∏—Ç–µ ‚Ä¢ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Ä¢ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª¬ª</div>
            <button class="ios-prompt-button" onclick="dismissIOSPrompt()">–ü–æ–Ω—è—Ç–Ω–æ</button>
          </div>`;
        document.body.appendChild(el);
      }
      requestAnimationFrame(() => el.classList.add('show'));
    }, 2000);
  }
  function dismissIOSPrompt() {
    const el = document.querySelector('.ios-install-prompt');
    if (el) el.classList.remove('show');
    localStorage.setItem('iosInstallDismissed', '1');
    setTimeout(() => el && el.remove(), 350);
  }

  /* ====== OFFLINE: –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ scripts/ui/offline.js ====== */
  /* ====== –ú–µ–ª–æ—á–∏ ====== */
  function openInAppCurrentTrack() {
    const pc = getPlayerConfig();
    const tr = pc?.tracks?.[playingTrack];
    if (!tr) return;
    window.open(tr.audio, '_blank', 'noopener');
    closeDownloadModal();
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∫–Ω–æ–ø–æ–∫ –ø–ª–µ–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ
  function restorePlayerButtonsState() {
    const btnSh = document.getElementById('shuffle-btn');
    const btnRpt = document.getElementById('repeat-btn');
    const btnFav = document.getElementById('favorites-btn');
    const favIcon = document.getElementById('favorites-btn-icon');
    const btnAnim = document.getElementById('animation-btn');
    const btnBit = document.getElementById('bit-btn');
    const btnEco = document.getElementById('eco-btn');
    if (btnSh) btnSh.classList.toggle('active', shuffleMode);
    if (btnRpt) btnRpt.classList.toggle('repeat-active', repeatMode);
    if (btnFav) btnFav.classList.toggle('favorites-active', favoritesOnlyMode);
    if (favIcon) favIcon.src = favoritesOnlyMode ? 'img/star.png' : 'img/star2.png';
    if (btnAnim) btnAnim.classList.toggle('animation-active', animationEnabled);
    if (btnBit) btnBit.classList.toggle('bit-active', bitEnabled);
    if (btnEco) btnEco.classList.toggle('eco-active', ultraEcoEnabled);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  window.addEventListener('load', () => {
    try { window.__initPlayerCoreBindings && window.__initPlayerCoreBindings(); } catch {}
    // –ü–æ–º–µ—á–∞–µ–º iOS –¥–ª—è UI-–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π (—Å–∫—Ä—ã—Ç—å —Å–ª–∞–π–¥–µ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏)
    try { if (/iphone|ipad|ipod/i.test(navigator.userAgent)) document.body.classList.add('ios'); } catch {}

    applyLogos();
    const passed = localStorage.getItem('promoPassed') === '1';
    if (passed) {
      document.getElementById('promocode-block').classList.add('hidden');
      document.getElementById('main-block').classList.remove('hidden');
      initializeMainUi();
    }
    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ Memory Saver + –∫–Ω–æ–ø–∫–∞-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    const showMemorySaverHelpModal = () => {
      let modal = document.getElementById('memory-saver-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'memory-saver-modal';
        modal.className = 'modal-bg active';
        modal.innerHTML = `
          <div class="modal-feedback" style="max-width:480px;">
            <button class="bigclose" onclick="this.closest('.modal-bg').remove()" title="–ó–∞–∫—Ä—ã—Ç—å">
              <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
            </button>
            <div style="font-size:1.1em; font-weight:800; margin-bottom:8px;">Chrome: –∫–∞–∫ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º—É–∑—ã–∫—É</div>
            <div style="color:#cfe3ff; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:12px; line-height:1.4;">
              –ï—Å–ª–∏ –≤ Chrome –≤–∫–ª—é—á—ë–Ω ¬´–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏¬ª, –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –≤—ã–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –º—É–∑—ã–∫–∞ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.<br><br>
              –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–π—Ç –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:<br>
              1) –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Chrome ‚Üí –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.<br>
              2) –í —Ä–∞–∑–¥–µ–ª–µ ¬´–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏¬ª –Ω–∞–π–¥–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–∞–π—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–º–∏¬ª.<br>
              3) –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –∏ —É–∫–∞–∂–∏—Ç–µ: <b>${location.origin}</b><br><br>
              –ë—ã—Å—Ç—Ä–∞—è —Å—Å—ã–ª–∫–∞: chrome://settings/performance
            </div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
              <button class="offline-btn online" onclick="navigator.clipboard && navigator.clipboard.writeText('chrome://settings/performance').then(()=>{},()=>{}); this.textContent='–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
              <button class="offline-btn" onclick="this.closest('.modal-bg').remove()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
      } else {
        modal.classList.add('active');
      }
    };
    try {
      const isChrome = /Chrome\/\d+/.test(navigator.userAgent) && !/Edg\//.test(navigator.userAgent) && !/OPR\//.test(navigator.userAgent);
      const ctr = document.querySelector('.bottom-controls-center');
      if (isChrome && ctr && !document.getElementById('memory-saver-help-btn')) {
        const btn = document.createElement('button');
        btn.id = 'memory-saver-help-btn';
        btn.className = 'offline-btn';
        btn.style.width = '98%';
        btn.style.background = '#273050';
        btn.textContent = '–ö–∞–∫ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º—É–∑—ã–∫—É –≤ Chrome';
        btn.onclick = showMemorySaverHelpModal;
        ctr.appendChild(btn);
      }
      if (document.wasDiscarded) {
        showMemorySaverHelpModal();
      }
    } catch {}
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    setInterval(checkSleepTimer, 1000);
  });
  </script>
</body>
</html>


