<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  
  <!-- iOS & PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  
  <!-- Favicons -->
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">
  
  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">
  
  <!-- Styles -->
  <link rel="stylesheet" href="styles/main.css">
  
  <!-- –ö–†–ò–¢–ò–ß–ù–û: Howler.js –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ü–ï–†–í–´–ú -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>
  
  <!-- Core -->
  <script src="./scripts/core/bootstrap.js"></script>
  <script src="./scripts/core/utils.js"></script>
  <script src="./scripts/core/config.js" type="module"></script>
  
  <!-- Player Core (–Ω–æ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞) -->
  <script src="./src/PlayerCore.js" type="module"></script>
  
  <!-- UI Modules -->
  <script src="./scripts/ui/notify.js" defer></script>
  <script src="./scripts/ui/favorites-const.js" defer></script>
  <script src="./scripts/ui/favorites-data.js" defer></script>
  <script src="./scripts/ui/favorites.js" defer></script>
  <script src="./scripts/ui/favorites-view.js" defer></script>
  <script src="./scripts/ui/sleep.js" defer></script>
  <script src="./scripts/ui/lyrics-modal.js" defer></script>
  <script src="./scripts/ui/sysinfo.js" defer></script>
  
  <!-- App Modules -->
  <script src="./scripts/app/background-audio.js" defer></script>
  <script src="./scripts/app/background-events.js" defer></script>

  <!-- Network (needed for PQ rules + future network policy) -->
  <script src="./scripts/app/network-manager.js" defer></script>

  <script src="./scripts/app/playback-policy.js" defer></script>
  <script src="./scripts/app/player-ui.js" defer></script>
  <script src="./scripts/app/gallery.js" type="module"></script>
  <script src="./scripts/app/albums.js" type="module"></script>
  <script src="./scripts/app/navigation.js" type="module"></script>
  
  <!-- Main App -->
  <script src="./scripts/app.js" type="module"></script>
  
  <!-- Performance Monitoring -->
  <script src="./performance/rum.js" defer></script>
</head>
<body>
  <!-- Promocode Screen -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons" aria-label="–ê–ª—å–±–æ–º—ã"></div>
      
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" 
                title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" 
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div id="cover-slot" aria-label="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞"></div>
        
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" 
                title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" 
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <!-- –ú–∏–Ω–∏-–ø–ª–µ–µ—Ä (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –¥—Ä—É–≥–æ–≥–æ –∞–ª—å–±–æ–º–∞) -->
    <div id="now-playing" style="width:100%; max-width:395px; margin:8px auto 0 auto;"></div>
    
    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">

      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>
      
      <button id="install-pwa-btn" style="display: none;">
        –£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
      </button>
      
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;">
        –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò
      </button>
      
      <button id="sysinfo-btn" style="display:none;">
        –û –°–ò–°–¢–ï–ú–ï
      </button>
      
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      
      <a class="support-link" id="support-link" href="#" target="_blank">
        –ü–û–î–î–ï–†–ñ–ê–¢–¨
      </a>
      
      <button class="offline-btn online" id="offline-btn">ONLINE</button>
    </div>
  </div>

  <!-- Modals Container -->
  <div id="modals-container"></div>

  <!-- Inline Scripts -->
  <script>
    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    
    const VERSION = String(window.APP_CONFIG?.APP_VERSION || '8.0.4');
    const BUILD_DATE = String(window.APP_CONFIG?.BUILD_DATE || '2025-12-07');
    
    // –§–ª–∞–≥–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    window.autoNextDisabled = false;
    window.sleepTimerTarget = null;
    window.sleepTimerInterval = null;
    
    // ========== –ü–†–û–í–ï–†–ö–ê –ü–†–û–ú–û–ö–û–î–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
    
    window.addEventListener('load', () => {
      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iOS
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.body.classList.add('ios');
      }
      
      // ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –∏–∑ window.APP_CONFIG.PROMOCODE
      // –ü–æ–≤–µ–¥–µ–Ω–∏–µ:
      // - –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫/–ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏: –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –ø—Ä–æ–º–æ–∫–æ–¥–∞
      // - –µ—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –≤—Ö–æ–¥ —Å—Ä–∞–∑—É
      const PROMO = String(window.APP_CONFIG?.PROMOCODE || '').trim();

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –µ—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
      const savedPromo = localStorage.getItem('promocode');
      if (PROMO && savedPromo === PROMO) {
        unlockAppDirectly();
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
      const promoInput = document.getElementById('promo-inp');
      const promoBtn = document.getElementById('promo-btn');
      const promoError = document.getElementById('promo-error');

      const checkPromo = () => {
        const value = promoInput.value.trim();
        if (PROMO && value === PROMO) {
          localStorage.setItem('promocode', value);
          unlockAppDirectly();
        } else {
          promoError.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';
          promoInput.classList.add('error');
          setTimeout(() => {
            promoError.textContent = '';
            promoInput.classList.remove('error');
          }, 2000);
        }
      };
      
      promoBtn?.addEventListener('click', checkPromo);
      promoInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') checkPromo();
      });
      
      // iOS: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–æ —É—Å—Ç–∞–Ω–æ–≤–∫—É
      detectIOSAndShowInstallGuide();
      
      // Chrome: –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–æ Memory Saver —É–¥–∞–ª–µ–Ω–∞ –ø–æ –¥–∏–∑–∞–π–Ω—É
    });
    
    function unlockAppDirectly() {
      const promocodeBlock = document.getElementById('promocode-block');
      const mainBlock = document.getElementById('main-block');
      
      if (promocodeBlock) promocodeBlock.classList.add('hidden');
      if (mainBlock) mainBlock.classList.remove('hidden');
      
      // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ window.app
      const waitForApp = setInterval(() => {
        if (window.app && typeof window.app.initialize === 'function') {
          clearInterval(waitForApp);
          window.app.initialize();
        }
      }, 100);
    }
    
    // ========== iOS INSTALL GUIDE ==========
    
    function detectIOSAndShowInstallGuide() {
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
      
      if (!isIOS || isStandalone) return;
      
      setTimeout(() => {
        if (localStorage.getItem('iosInstallDismissed') === '1') return;
        
        const el = document.createElement('div');
        el.className = 'ios-install-prompt';
        el.innerHTML = `
          <button class="ios-prompt-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="dismissIOSPrompt()">√ó</button>
          <div class="ios-prompt-content">
            <img class="ios-prompt-icon" src="icons/apple-touch-icon.png" alt="–ò–∫–æ–Ω–∫–∞">
            <div style="font-weight:800; font-size:18px; margin-bottom:8px;">
              –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            </div>
            <div style="opacity:.85; margin-bottom:14px;">
              –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</strong> ‚ÜóÔ∏è<br>
              –∏ –≤—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª¬ª</strong>
            </div>
            <button class="ios-prompt-button" onclick="dismissIOSPrompt()">–ü–æ–Ω—è—Ç–Ω–æ</button>
          </div>
        `;
        document.body.appendChild(el);
        
        requestAnimationFrame(() => el.classList.add('show'));
      }, 3000);
    }
    
    function dismissIOSPrompt() {
      const el = document.querySelector('.ios-install-prompt');
      if (el) {
        el.classList.remove('show');
        localStorage.setItem('iosInstallDismissed', '1');
        setTimeout(() => el.remove(), 350);
      }
    }
    
    // ========== –£–¢–ò–õ–ò–¢–´ ==========
    // ‚úÖ –£—Ç–∏–ª–∏—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ scripts/core/utils.js (window.Utils.*)
    // Back-compat: –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤ legacy-–∫–æ–¥–µ –µ—â—ë –≤—ã–∑—ã–≤–∞—é—Ç—Å—è window.formatTime/escapeHtml.
    window.formatTime = window.Utils?.formatTime;
    window.escapeHtml = window.Utils?.escapeHtml;

    // ========== –≠–ö–°–ü–û–†–¢ –ì–õ–û–ë–ê–õ–¨–ù–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• ==========
    
    window.VERSION = VERSION;
    window.BUILD_DATE = BUILD_DATE;
    
    console.log(`üéµ –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ v${VERSION} (${BUILD_DATE})`);
  </script>
<script type="module" src="./scripts/app/offline-ui-bootstrap.js"></script>
<script type="module">
  import { attachOfflineUI } from './scripts/app/offline-ui-bootstrap.js';
  import { attachOfflineIndicators } from './scripts/ui/offline-indicators.js';
  import { attachCacheProgressOverlay } from './scripts/ui/cache-progress-overlay.js';
  import { attachPlaybackCache } from './scripts/app/playback-cache-bootstrap.js';

  // ‚úÖ –ï–¥–∏–Ω–∞—è offline-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ (ESM)
  attachOfflineUI();

  // UI/–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
  attachOfflineIndicators();
  attachCacheProgressOverlay();
  attachPlaybackCache();
</script>
</body>
</html>
