<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  
  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  
  <!-- Favicons -->
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">
  
  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">
  
  <!-- Styles -->
  <link rel="stylesheet" href="styles/main.css">
  
  <!-- Howler.js -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>

  <!-- Preconnect –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
  <!-- Core -->
  <script src="./scripts/core/bootstrap.js"></script>
  <!-- ‚ö†Ô∏è bootstrap.js –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ã—á–Ω—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º, –ù–ï type="module" -->
  <script src="./scripts/core/config.js" type="module"></script>
  
  <!-- Player Core -->
  <script src="./scripts/player/player-adapter.js" type="module"></script>
  
  <!-- UI Modules -->
  <script src="./scripts/ui/notify.js" defer></script>
  <script src="./scripts/ui/favorites-const.js" defer></script>
  <script src="./scripts/ui/favorites-storage.js" defer></script>
  <script src="./scripts/ui/favorites-data.js" defer></script>
  <script src="./scripts/ui/favorites.js" defer></script>
  <script src="./scripts/ui/mini.js" defer></script>
  <script src="./scripts/ui/modals.js" defer></script>
  <script src="./scripts/ui/sysinfo.js" defer></script>
  <script src="./scripts/ui/sleep.js" defer></script>
  
  <!-- App Modules -->
  <script src="./scripts/app/background-audio.js" defer></script>
  <script src="./scripts/app/background-events.js" defer></script>
  <script src="./scripts/app/player-ui.js" defer></script>
  <script src="./scripts/app/albums.js" type="module"></script>
  <script src="./scripts/app/navigation.js" type="module"></script>
  <script src="./scripts/app/downloads.js" type="module"></script>
  
  <!-- Main App -->
  <script src="./scripts/app.js" type="module"></script>
  
  <!-- Performance Monitoring -->
  <script src="./performance/rum.js" defer></script>
</head>
<body>
  <!-- Promocode Screen -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons" aria-label="–ê–ª—å–±–æ–º—ã"></div>
      
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" 
                title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" 
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div id="cover-slot" aria-label="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞"></div>
        
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" 
                title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" 
                      stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <div id="now-playing"></div>
    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">
      <button class="filter-favorites-btn" id="filter-favorites-btn">
        –°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏
      </button>
      
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>
      
      <button id="install-pwa-btn" style="display: none;">
        –£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
      </button>
      
      <button id="download-album-main">
        –°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú
      </button>
      
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;">
        –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò
      </button>
      
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      
      <a class="support-link" id="support-link" href="#" target="_blank">
        –ü–û–î–î–ï–†–ñ–ê–¢–¨
      </a>
      
      <button class="offline-btn online" id="offline-btn">ONLINE</button>
    </div>
  </div>

  <!-- Modals Container -->
  <div id="modals-container"></div>

  <!-- Inline Scripts -->
  <script>
    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    
    const VERSION = '8.0.3';
    const BUILD_DATE = '2025-12-07';
    
    // –§–ª–∞–≥–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    window.autoNextDisabled = false;
    window.sleepTimerTarget = null;
    window.sleepTimerInterval = null;
    
    // ========== –ü–†–û–í–ï–†–ö–ê –ü–†–û–ú–û–ö–û–î–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
    
    window.addEventListener('load', () => {
      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iOS
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.body.classList.add('ios');
      }
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –µ—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
      const savedPromo = localStorage.getItem('promocode');
      if (savedPromo === 'VITRINA2025') {
        unlockAppDirectly();
      }
      
      // iOS: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–æ —É—Å—Ç–∞–Ω–æ–≤–∫—É
      detectIOSAndShowInstallGuide();
      
      // Chrome: –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–æ Memory Saver
      showChromeMemorySaverHint();
    });
    
    function unlockAppDirectly() {
      const promocodeBlock = document.getElementById('promocode-block');
      const mainBlock = document.getElementById('main-block');
      
      if (promocodeBlock) promocodeBlock.classList.add('hidden');
      if (mainBlock) mainBlock.classList.remove('hidden');
      
      // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ window.app
      const waitForApp = setInterval(() => {
        if (window.app && typeof window.app.initialize === 'function') {
          clearInterval(waitForApp);
          window.app.initialize();
        }
      }, 100);
    }
    
    // ========== iOS INSTALL GUIDE ==========
    
    function detectIOSAndShowInstallGuide() {
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
      
      if (!isIOS || isStandalone) return;
      
      setTimeout(() => {
        if (localStorage.getItem('iosInstallDismissed') === '1') return;
        
        const el = document.createElement('div');
        el.className = 'ios-install-prompt';
        el.innerHTML = `
          <button class="ios-prompt-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="dismissIOSPrompt()">√ó</button>
          <div class="ios-prompt-content">
            <img class="ios-prompt-icon" src="icons/apple-touch-icon.png" alt="–ò–∫–æ–Ω–∫–∞">
            <div style="font-weight:800; font-size:18px; margin-bottom:8px;">
              –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            </div>
            <div style="opacity:.85; margin-bottom:14px;">
              –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</strong> ‚ÜóÔ∏è<br>
              –∏ –≤—ã–±–µ—Ä–∏—Ç–µ <strong>¬´–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª¬ª</strong>
            </div>
            <button class="ios-prompt-button" onclick="dismissIOSPrompt()">–ü–æ–Ω—è—Ç–Ω–æ</button>
          </div>
        `;
        document.body.appendChild(el);
        
        requestAnimationFrame(() => el.classList.add('show'));
      }, 3000);
    }
    
    function dismissIOSPrompt() {
      const el = document.querySelector('.ios-install-prompt');
      if (el) {
        el.classList.remove('show');
        localStorage.setItem('iosInstallDismissed', '1');
        setTimeout(() => el.remove(), 350);
      }
    }
    
    // ========== CHROME MEMORY SAVER HINT ==========
    
    function showChromeMemorySaverHint() {
      try {
        const isChrome = /Chrome\/\d+/.test(navigator.userAgent) && 
                        !/Edg\//.test(navigator.userAgent) && 
                        !/OPR\//.test(navigator.userAgent);
        
        if (!isChrome) return;
        
        const alreadyShown = localStorage.getItem('chromeMemoryHintShown') === '1';
        if (alreadyShown) return;
        
        const container = document.querySelector('.bottom-controls-center');
        if (!container) return;
        
        const btn = document.createElement('button');
        btn.id = 'memory-saver-help-btn';
        btn.className = 'offline-btn';
        btn.style.cssText = 'width: 98%; background: #273050; margin-top: 8px;';
        btn.textContent = '–ö–∞–∫ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º—É–∑—ã–∫—É –≤ Chrome';
        
        btn.onclick = () => {
          showMemorySaverModal();
          localStorage.setItem('chromeMemoryHintShown', '1');
        };
        
        container.appendChild(btn);
      } catch (e) {
        console.warn('Failed to show Chrome hint:', e);
      }
    }
    
    function showMemorySaverModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-bg active';
      modal.innerHTML = `
        <div class="modal-feedback" style="max-width:480px;">
          <button class="bigclose" onclick="this.closest('.modal-bg').remove()" 
                  title="–ó–∞–∫—Ä—ã—Ç—å" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
            <svg viewBox="0 0 48 48">
              <line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" 
                    stroke-width="6" stroke-linecap="round"/>
              <line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" 
                    stroke-width="6" stroke-linecap="round"/>
            </svg>
          </button>
          
          <div style="font-size:1.1em; font-weight:800; margin-bottom:12px; color: #4daaff;">
            Chrome: –∫–∞–∫ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º—É–∑—ã–∫—É
          </div>
          
          <div style="color:#cfe3ff; background:rgba(255,255,255,.06); 
                      border:1px solid rgba(255,255,255,.1); border-radius:8px; 
                      padding:14px; line-height:1.5;">
            –ï—Å–ª–∏ –≤ Chrome –≤–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º <strong>¬´–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏¬ª</strong>, 
            –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –≤—ã–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.
            <br><br>
            <strong>–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–π—Ç –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:</strong><br>
            1Ô∏è‚É£ –û—Ç–∫—Ä–æ–π—Ç–µ <code style="background:rgba(0,0,0,.3); padding:2px 6px; 
               border-radius:4px;">chrome://settings/performance</code><br>
            2Ô∏è‚É£ –í —Ä–∞–∑–¥–µ–ª–µ ¬´–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏¬ª –Ω–∞–π–¥–∏—Ç–µ:<br>
            <em>¬´–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–∞–π—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–º–∏¬ª</em><br>
            3Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ <strong>¬´–î–æ–±–∞–≤–∏—Ç—å¬ª</strong> –∏ —É–∫–∞–∂–∏—Ç–µ:<br>
            <code style="background:rgba(77,170,255,.15); padding:3px 8px; 
                  border-radius:4px; color:#4daaff;">${location.origin}</code>
          </div>
          
          <div style="display:flex; gap:10px; justify-content:center; margin-top:16px; flex-wrap:wrap;">
            <button class="offline-btn online" id="copy-chrome-settings-btn">
              üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
            </button>
            <button class="offline-btn" onclick="this.closest('.modal-bg').remove()">
              –ü–æ–Ω—è—Ç–Ω–æ
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
      const copyBtn = modal.querySelector('#copy-chrome-settings-btn');
      copyBtn?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText('chrome://settings/performance');
          copyBtn.textContent = '‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞';
          copyBtn.style.background = '#27b34c';
          
          setTimeout(() => {
            copyBtn.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É';
            copyBtn.style.background = '';
          }, 2000);
        } catch (e) {
          console.error('Copy failed:', e);
        }
      });
    }
    
    // ========== –£–¢–ò–õ–ò–¢–´ ==========
    
    function formatTime(sec) {
      if (isNaN(sec) || sec < 0) return '--:--';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
    
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }
    
    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ì–û–†–Ø–ß–ò–• –ö–õ–ê–í–ò–® ==========
    
    function togglePlayPause() {
      if (!window.playerCore) return;
      window.playerCore.isPlaying() ? window.playerCore.pause() : window.playerCore.play();
    }
    
    function stopPlayback() {
      window.playerCore?.stop();
    }
    
    function nextTrack() {
      window.playerCore?.next();
    }
    
    function previousTrack() {
      window.playerCore?.prev();
    }
    
    function seekAudio(seconds) {
      if (!window.playerCore) return;
      const current = window.playerCore.getSeek() || 0;
      const duration = window.playerCore.getDuration() || 0;
      const newPos = Math.max(0, Math.min(duration, current + seconds));
      window.playerCore.seek(newPos);
    }
    
    function adjustVolume(delta) {
      if (!window.playerCore) return;
      const current = window.playerCore.getVolume();
      const newVolume = Math.max(0, Math.min(1, current + (delta / 100)));
      window.playerCore.setVolume(newVolume);
      
      // –û–±–Ω–æ–≤–∏—Ç—å UI –≥—Ä–æ–º–∫–æ—Å—Ç–∏
      if (window.PlayerUI) {
        window.PlayerUI.updateVolumeUI?.(newVolume);
      }
      
      localStorage.setItem('playerVolume', String(newVolume));
    }
    
    function toggleMute() {
      document.getElementById('mute-btn')?.click();
    }
    
    function toggleRepeat() {
      document.getElementById('repeat-btn')?.click();
    }
    
    function toggleShuffle() {
      document.getElementById('shuffle-btn')?.click();
    }
    
    function toggleFavoritesOnly() {
      document.getElementById('favorites-btn')?.click();
    }
    
    function toggleSleepMenu() {
      document.getElementById('sleep-timer-btn')?.click();
    }
    
    function toggleAnimation() {
      window.PlayerUI?.toggleAnimation();
    }
    
    function toggleBit() {
      window.PlayerUI?.toggleBit();
    }
    
    function setBitIntensity(value) {
      if (window.PlayerUI) {
        window.PlayerUI.bitIntensity = value;
        window.NotificationSystem?.info(`üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${value}%`);
      }
    }
    
    function toggleLyricsView() {
      window.PlayerUI?.toggleLyricsView();
    }
    
    function toggleLikePlaying() {
      const track = window.playerCore?.getCurrentTrack();
      if (!track) return;
      
      const albumKey = window.AlbumsManager?.getCurrentAlbum();
      const index = window.playerCore?.getIndex();
      
      if (albumKey !== null && typeof index === 'number') {
        const star = document.querySelector(`.track[data-index="${index}"] .like-star`);
        star?.click();
      }
    }
    
    function toggleEco() {
      document.getElementById('eco-btn')?.click();
    }
    
    function showHotkeysModal() {
      window.NavigationManager?.showHotkeysModal();
    }
    
    // ========== –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò ==========
    
    window.addEventListener('keydown', (e) => {
      // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
      const hasModal = document.querySelector('.modal-bg.active, .modal-overlay.show');
      if (e.key === 'Escape' && hasModal) {
        e.preventDefault();
        document.querySelectorAll('.modal-bg.active').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
        return;
      }
      
      if (hasModal) return;
      
      const key = e.key.toUpperCase();
      
      switch(key) {
        case ' ':
        case 'K':
          e.preventDefault();
          togglePlayPause();
          break;
        case 'X':
          e.preventDefault();
          stopPlayback();
          break;
        case 'N':
          e.preventDefault();
          nextTrack();
          break;
        case 'P':
          e.preventDefault();
          previousTrack();
          break;
        case 'J':
          e.preventDefault();
          seekAudio(-10);
          break;
        case 'L':
          e.preventDefault();
          seekAudio(10);
          break;
        case '+':
        case '=':
          e.preventDefault();
          adjustVolume(10);
          break;
        case '-':
          e.preventDefault();
          adjustVolume(-10);
          break;
        case 'M':
          e.preventDefault();
          toggleMute();
          break;
        case 'R':
          e.preventDefault();
          toggleRepeat();
          break;
        case 'U':
          e.preventDefault();
          toggleShuffle();
          break;
        case 'F':
          e.preventDefault();
          toggleFavoritesOnly();
          break;
        case 'T':
          e.preventDefault();
          toggleSleepMenu();
          break;
        case 'A':
          e.preventDefault();
          toggleAnimation();
          break;
        case 'B':
          e.preventDefault();
          toggleBit();
          break;
        case '1':
          if (window.PlayerUI?.bitEnabled) {
            e.preventDefault();
            setBitIntensity(100);
          }
          break;
        case '2':
          if (window.PlayerUI?.bitEnabled) {
            e.preventDefault();
            setBitIntensity(50);
          }
          break;
        case '3':
          if (window.PlayerUI?.bitEnabled) {
            e.preventDefault();
            setBitIntensity(15);
          }
          break;
        case 'Y':
          e.preventDefault();
          toggleLyricsView();
          break;
        case 'W':
          e.preventDefault();
          document.getElementById('track-list')?.scrollIntoView({
            behavior: 'smooth'
          });
          break;
        case 'D':
          e.preventDefault();
          toggleLikePlaying();
          break;
        case '?':
          e.preventDefault();
          showHotkeysModal();
          break;
        case 'O':
          e.preventDefault();
          window.autoNextDisabled = !window.autoNextDisabled;
          window.NotificationSystem?.info(
            window.autoNextDisabled ? '‚èπ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç–∫–ª—é—á—ë–Ω' : '‚ñ∂ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –≤–∫–ª—é—á—ë–Ω'
          );
          break;
      }
      
      // –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Ç—Ä–µ–∫–∞ –ø–æ —Ü–∏—Ñ—Ä–µ (1-9)
      if (e.key >= '1' && e.key <= '9' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
        const idx = parseInt(e.key) - 1;
        const tracks = document.querySelectorAll('.track');
        if (tracks[idx]) {
          e.preventDefault();
          tracks[idx].click();
        }
      }
    });
    
    // ========== SLEEP TIMER ==========
    
    function setSleepTimer(minutes) {
      if (minutes === 'off') {
        clearSleepTimer();
        return;
      }
      
      window.sleepTimerTarget = Date.now() + minutes * 60 * 1000;
      updateSleepTimerUI();
      
      if (window.sleepTimerInterval) {
        clearInterval(window.sleepTimerInterval);
      }
      
      window.sleepTimerInterval = setInterval(() => {
        if (!window.sleepTimerTarget) {
          clearInterval(window.sleepTimerInterval);
          window.sleepTimerInterval = null;
          return;
        }
        
        const now = Date.now();
        const msLeft = window.sleepTimerTarget - now;
        
        if (msLeft <= 0) {
          // –ö–†–ò–¢–ò–ß–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º PlayerCore
          if (window.playerCore && window.playerCore.isPlaying()) {
            window.playerCore.pause();
            window.NotificationSystem?.info('‚è∞ –¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
          }
          clearSleepTimer();
        } else if (msLeft <= 10000 && !document.querySelector('#sleep-overlay')) {
          showSleepOverlay();
        }
        
        updateSleepTimerUI();
      }, 1000);
      
      window.NotificationSystem?.success(`‚è∞ –¢–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${minutes} –º–∏–Ω`);
    }
    
    function clearSleepTimer() {
      window.sleepTimerTarget = null;
      
      if (window.sleepTimerInterval) {
        clearInterval(window.sleepTimerInterval);
        window.sleepTimerInterval = null;
      }
      
      updateSleepTimerUI();
      
      const overlay = document.getElementById('sleep-overlay');
      if (overlay) overlay.remove();
      
      // –¢–∞–∫–∂–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤ PlayerCore
      if (window.playerCore && typeof window.playerCore.clearSleepTimer === 'function') {
        window.playerCore.clearSleepTimer();
      }
    }
    
    function updateSleepTimerUI() {
      const badge = document.getElementById('sleep-timer-badge');
      if (!badge) return;
      
      if (!window.sleepTimerTarget) {
        badge.style.display = 'none';
        badge.textContent = '';
        return;
      }
      
      const minsLeft = Math.max(0, Math.ceil((window.sleepTimerTarget - Date.now()) / 60000));
      badge.textContent = String(minsLeft);
      badge.style.display = minsLeft > 0 ? '' : 'none';
    }
    
    function showSleepOverlay() {
      let overlay = document.getElementById('sleep-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sleep-overlay';
        overlay.className = 'sleep-overlay';
        overlay.innerHTML = `
          <div class="sleep-content">
            <div class="sleep-icon">üò¥</div>
            <div class="sleep-title">–°–∫–æ—Ä–æ –ø–∞—É–∑–∞</div>
            <div class="sleep-message">
              –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ —Ç–∞–π–º–µ—Ä—É —Å–Ω–∞.
            </div>
            <div class="sleep-buttons">
              <button class="sleep-btn sleep-btn-secondary" onclick="cancelSleepOverlay()">
                –û—Ç–º–µ–Ω–∞
              </button>
              <button class="sleep-btn sleep-btn-primary" onclick="confirmSleepOverlay()">
                –û—Å—Ç–∞–≤–∏—Ç—å
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
      }
      overlay.classList.add('active');
    }
    
    function cancelSleepOverlay() {
      clearSleepTimer();
      const overlay = document.getElementById('sleep-overlay');
      if (overlay) overlay.remove();
    }
    
    function confirmSleepOverlay() {
      const overlay = document.getElementById('sleep-overlay');
      if (overlay) overlay.remove();
    }
    
    // ========== –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ò–ï –ó–ê–î–ê–ß–ò ==========
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Ç–∞–π–º–µ—Ä–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(() => {
      updateSleepTimerUI();
    }, 1000);
    
    // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–®–ò–ë–û–ö ==========
    
    window.addEventListener('error', (e) => {
      console.error('üí• Global error:', e.error || e.message);
    });
    
    window.addEventListener('unhandledrejection', (e) => {
      console.error('üí• Unhandled promise rejection:', e.reason);
    });
    
    // ========== –≠–ö–°–ü–û–†–¢ –ì–õ–û–ë–ê–õ–¨–ù–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• ==========
    
    window.VERSION = VERSION;
    window.BUILD_DATE = BUILD_DATE;
    
    console.log(`üéµ –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ v${VERSION} (${BUILD_DATE})`);
  </script>
</body>
</html>
