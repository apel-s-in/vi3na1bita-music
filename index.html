<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />
  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <!-- FAVICONS -->
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="alternate icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="alternate icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">
  <!-- Styles -->
  <link rel="stylesheet" href="styles/main.css">
  <!-- Howler.js -->
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>
  <!-- Core -->
  <script src="./scripts/core/bootstrap.js"></script>
  <script src="./scripts/core/config.js" type="module"></script>
  <!-- Player -->
  <script src="./scripts/player/player-adapter.js" type="module"></script>
  <!-- UI -->
  <script src="./scripts/ui/notify.js" defer></script>
  <script src="./scripts/ui/favorites-const.js" defer></script>
  <script src="./scripts/ui/favorites-storage.js" defer></script>
  <script src="./scripts/ui/favorites-data.js" defer></script>
  <script src="./scripts/ui/favorites.js" defer></script>
  <script src="./scripts/ui/mini.js" defer></script>
  <script src="./scripts/ui/modals.js" defer></script>
  <script src="./scripts/ui/sysinfo.js" defer></script>
  <script src="./scripts/ui/sleep.js" defer></script>
  <!-- App -->
  <script src="./scripts/app/background-audio.js" defer></script>
  <script src="./scripts/app/background-events.js" defer></script>
  <script src="./scripts/app/albums.js" type="module"></script>
  <script src="./scripts/app/navigation.js" type="module"></script>
  <script src="./scripts/app/downloads.js" type="module"></script>
  <!-- Main -->
  <script src="./scripts/app.js" type="module"></script>
  <!-- RUM -->
  <script src="./performance/rum.js" defer></script>
</head>
<body>
  <!-- Promocode -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>
  <!-- Main -->
  <div id="main-block" class="hidden">
    <header>
      <div id="active-album-title" class="active-album-title">‚Äî</div>
      <div id="album-icons" class="album-icons"></div>
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div id="cover-slot"></div>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34">
            <circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/>
            <polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div id="social-links" class="socials-under-cover"></div>
    </header>
    <div id="now-playing"></div>
    <div class="track-list" id="track-list"></div>
    <div class="bottom-controls-center">
      <button class="filter-favorites-btn" id="filter-favorites-btn">
        –°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏
      </button>
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø"/>
      <button id="install-pwa-btn" style="display: none;">
        –£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
      </button>
      <button id="download-album-main">–°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú</button>
      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;">
        –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò
      </button>
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>
      <button class="offline-btn online" id="offline-btn">ONLINE</button>
    </div>
  </div>
  <!-- Modals container -->
  <div id="modals-container"></div>
  <script>
    // –í–µ—Ä—Å–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const VERSION = '8.0.3';
    const BUILD_DATE = '2025-11-08';
    const PROMO_CODE = 'VITRINA2025';
    
    // –°–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤: fallback
    const ALBUMS_FALLBACK = [
      { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º (2025)', base: 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/' },
      { key: 'golos-dushi',          title: '–ì–æ–ª–æ—Å –î—É—à–∏',                base: 'https://apel-s-in.github.io/vi3na1bita-golos-dushi/' },
      { key: 'krevetochka',          title: '–ö–†–ï–í–ï—ÜTOCHKA',             base: 'https://apel-s-in.github.io/krevetochka/' }
    ];
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let albumsIndex = [];
    let currentAlbumKey = null;
    let albumBase = '';
    let config = null;
    let currentTrack = -1;
    let currentLyrics = [];
    let offlineMode = false;
    let shuffleMode = false;
    let repeatMode = false;
    let favoritesOnlyMode = false;
    let animationEnabled = false;
    let bitEnabled = false;
    let bitIntensity = 100;
    let ultraEcoEnabled = false;
    let energySaver = false;
    let sleepTimerTarget = null;
    let sleepTimerInterval = null;
    let coverGalleryArr = [];
    let coverGalleryIdx = 0;
    let coverAutoplay = null;
    let galleryRotationStarted = false;
    let favoritesRefsModel = null;
    let __currentGalleryVisible = true;
    let __lastProgressFillTs = 0;
    let __uiUpdateMinIntervalMs = 1000;
    let __progressThrottleMs = 1000;
    let __wasPlayingBeforeHidden = false;
    let __savedResumePosition = null;
    let __offlineToastInterval = null;
    
    // –ö–ª—é—á–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤
    const SPECIAL_FAVORITES_KEY = '__favorites__';
    const SPECIAL_RELIZ_KEY = '__reliz__';
    let viewMode = 'album';
    
    // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –∞–ª—å–±–æ–º–æ–≤
    const ICON_ALBUMS_ORDER = [
      { key: SPECIAL_FAVORITES_KEY,  title: '‚≠ê‚≠ê‚≠ê–ò–ó–ë–†–ê–ù–ù–û–ï‚≠ê‚≠ê‚≠ê', icon: 'img/icon_album/icon-album-00.png' },
      { key: 'mezhdu-zlom-i-dobrom', title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º',   icon: 'img/icon_album/icon-album-01.png' },
      { key: 'golos-dushi',          title: '–ì–æ–ª–æ—Å –î—É—à–∏',            icon: 'img/icon_album/icon-album-02.png' },
      { key: 'krevetochka',          title: '–ö–†–ï–í–ï—ÜTOCHKA',         icon: 'img/icon_album/icon-album+00.png' },
      { key: SPECIAL_RELIZ_KEY,      title: '–ù–û–í–û–°–¢–ò',               icon: 'img/icon_album/icon-album-news.png' }
    ];
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è iOS
    function detectIOSAndShowInstallGuide() {
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent) && !window.MSStream;
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      
      if (!isIOS || isStandalone) return;
      
      setTimeout(() => {
        if (localStorage.getItem('iosInstallDismissed') === '1') return;
        
        let el = document.createElement('div');
        el.className = 'ios-install-prompt';
        el.innerHTML = `
          <button class="ios-prompt-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" onclick="dismissIOSPrompt()">√ó</button>
          <div class="ios-prompt-content">
            <img class="ios-prompt-icon" src="icons/apple-touch-icon.png" alt="–ò–∫–æ–Ω–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è">
            <div style="font-weight:800; font-size:18px; margin-bottom:8px;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
            <div style="opacity:.85;">–ù–∞–∂–º–∏—Ç–µ ‚Ä¢ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Ä¢ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª¬ª</div>
            <button class="ios-prompt-button" onclick="dismissIOSPrompt()">–ü–æ–Ω—è—Ç–Ω–æ</button>
          </div>`;
        document.body.appendChild(el);
        
        requestAnimationFrame(() => el.classList.add('show'));
      }, 2000);
    }
    
    function dismissIOSPrompt() {
      const el = document.querySelector('.ios-install-prompt');
      if (el) {
        el.classList.remove('show');
        localStorage.setItem('iosInstallDismissed', '1');
        setTimeout(() => el && el.remove(), 350);
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.body.classList.add('ios');
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
      const passed = localStorage.getItem('promoPassed') === '1';
      if (passed) {
        document.getElementById('promocode-block').classList.add('hidden');
        document.getElementById('main-block').classList.remove('hidden');
        window.APP?.initialize?.();
      }
      
      // –ü–æ–∫–∞–∑ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–æ Memory Saver –≤ Chrome
      try {
        const isChrome = /Chrome\/\d+/.test(navigator.userAgent) && !/Edg\//.test(navigator.userAgent) && !/OPR\//.test(navigator.userAgent);
        const ctr = document.querySelector('.bottom-controls-center');
        if (isChrome && ctr && !document.getElementById('memory-saver-help-btn')) {
          const btn = document.createElement('button');
          btn.id = 'memory-saver-help-btn';
          btn.className = 'offline-btn';
          btn.style.width = '98%';
          btn.style.background = '#273050';
          btn.style.marginTop = '8px';
          btn.textContent = '–ö–∞–∫ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º—É–∑—ã–∫—É –≤ Chrome';
          btn.onclick = () => {
            let modal = document.createElement('div');
            modal.className = 'modal-bg active';
            modal.innerHTML = `
              <div class="modal-feedback" style="max-width:480px;">
                <button class="bigclose" onclick="this.closest('.modal-bg').remove()" title="–ó–∞–∫—Ä—ã—Ç—å">
                  <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
                </button>
                <div style="font-size:1.1em; font-weight:800; margin-bottom:8px;">Chrome: –∫–∞–∫ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –º—É–∑—ã–∫—É</div>
                <div style="color:#cfe3ff; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:12px; line-height:1.4;">
                  –ï—Å–ª–∏ –≤ Chrome –≤–∫–ª—é—á—ë–Ω ¬´–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏¬ª, –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –≤—ã–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –º—É–∑—ã–∫–∞ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.<br><br>
                  –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–∞–π—Ç –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:<br>
                  1) –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Chrome ‚Üí –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.<br>
                  2) –í —Ä–∞–∑–¥–µ–ª–µ ¬´–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏¬ª –Ω–∞–π–¥–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–∞–π—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–º–∏¬ª.<br>
                  3) –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª –∏ —É–∫–∞–∂–∏—Ç–µ: <b>${location.origin}</b><br><br>
                  –ë—ã—Å—Ç—Ä–∞—è —Å—Å—ã–ª–∫–∞: chrome://settings/performance
                </div>
                <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
                  <button class="offline-btn online" onclick="navigator.clipboard && navigator.clipboard.writeText('chrome://settings/performance').then(()=>{},()=>{}); this.textContent='–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                  <button class="offline-btn" onclick="this.closest('.modal-bg').remove()">–ü–æ–Ω—è—Ç–Ω–æ</button>
                </div>
              </div>`;
            document.body.appendChild(modal);
          };
          ctr.appendChild(btn);
        }
      } catch {}
      
      // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
      setInterval(() => {
        if (sleepTimerTarget) {
          const now = Date.now();
          const msLeft = sleepTimerTarget - now;
          
          if (msLeft <= 0) {
            const audio = document.getElementById('audio');
            if (audio && !audio.paused) {
              audio.pause();
              window.NotificationSystem?.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            }
            sleepTimerTarget = null;
            if (sleepTimerInterval) {
              clearInterval(sleepTimerInterval);
              sleepTimerInterval = null;
            }
            updateSleepTimerUI();
          } else if (msLeft <= 10000 && !ultraEcoEnabled && !document.querySelector('#sleep-overlay')) {
            showSleepOverlay();
          }
          
          updateSleepTimerUI();
        }
      }, 1000);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è
      applyEnergySaver(detectEnergySaver());
      
      // –ü–æ–∫–∞–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è iOS
      detectIOSAndShowInstallGuide();
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    function updateSleepTimerUI() {
      const btn = document.getElementById('sleep-timer-btn');
      const badge = document.getElementById('sleep-timer-badge');
      
      if (!sleepTimerTarget) {
        if (btn) btn.classList.remove('active');
        if (badge) {
          badge.style.display = 'none';
          badge.textContent = '';
        }
        return;
      }
      
      if (btn) btn.classList.add('active');
      const minsLeft = Math.max(0, Math.ceil((sleepTimerTarget - Date.now()) / 60000));
      
      if (badge) {
        badge.style.display = '';
        badge.textContent = String(minsLeft);
      }
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –æ–≤–µ—Ä–ª–µ–π —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    function showSleepOverlay() {
      let ov = document.getElementById('sleep-overlay');
      if (!ov) {
        ov = document.createElement('div');
        ov.id = 'sleep-overlay';
        ov.className = 'sleep-overlay';
        ov.innerHTML = `
          <div class="sleep-content">
            <div class="sleep-icon">üò¥</div>
            <div class="sleep-title">–°–∫–æ—Ä–æ –ø–∞—É–∑–∞</div>
            <div class="sleep-message">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ —Ç–∞–π–º–µ—Ä—É —Å–Ω–∞.</div>
            <div class="sleep-buttons">
              <button class="sleep-btn sleep-btn-secondary" onclick="cancelSleepOverlay()">–û—Ç–º–µ–Ω–∞</button>
              <button class="sleep-btn sleep-btn-primary" onclick="confirmSleepOverlay()">–û—Å—Ç–∞–≤–∏—Ç—å</button>
            </div>
          </div>`;
        document.body.appendChild(ov);
      }
      ov.classList.add('active');
    }
    
    // –û—Ç–º–µ–Ω–∞ —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    function cancelSleepOverlay() {
      clearSleepTimer();
      const ov = document.getElementById('sleep-overlay');
      if (ov) ov.remove();
    }
    
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    function confirmSleepOverlay() {
      const ov = document.getElementById('sleep-overlay');
      if (ov) ov.remove();
    }
    
    // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    function clearSleepTimer() {
      sleepTimerTarget = null;
      if (sleepTimerInterval) {
        clearInterval(sleepTimerInterval);
        sleepTimerInterval = null;
      }
      updateSleepTimerUI();
      const ov = document.getElementById('sleep-overlay');
      if (ov) ov.remove();
      window.NotificationSystem?.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω');
    }
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ —Å–Ω–∞
    function setSleepTimer(minutes) {
      if (minutes === 'off') {
        clearSleepTimer();
        return;
      }
      
      sleepTimerTarget = Date.now() + minutes * 60 * 1000;
      updateSleepTimerUI();
      
      if (sleepTimerInterval) {
        clearInterval(sleepTimerInterval);
      }
      sleepTimerInterval = setInterval(() => {
        if (!sleepTimerTarget) {
          clearInterval(sleepTimerInterval);
          sleepTimerInterval = null;
          return;
        }
        
        const now = Date.now();
        const msLeft = sleepTimerTarget - now;
        
        if (msLeft <= 0) {
          const audio = document.getElementById('audio');
          if (audio && !audio.paused) {
            audio.pause();
            window.NotificationSystem?.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
          }
          clearSleepTimer();
        } else if (msLeft <= 10000 && !ultraEcoEnabled && !document.querySelector('#sleep-overlay')) {
          showSleepOverlay();
        }
        
        updateSleepTimerUI();
      }, 1000);
    }
    
    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è
    function detectEnergySaver() {
      try {
        const nc = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        const saveData = !!(nc && nc.saveData);
        const reduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
        return saveData || reduced;
      } catch {
        return false;
      }
    }
    
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è
    function applyEnergySaver(on) {
      energySaver = !!on;
      
      if (energySaver) {
        if (animationEnabled) {
          window.__savedAnimationBeforeEnergy = animationEnabled;
          toggleAnimation();
        }
        
        if (bitEnabled) {
          window.__savedBitBeforeEnergy = bitEnabled;
          toggleBit();
        }
        
        if (coverAutoplay) {
          clearInterval(coverAutoplay);
          coverAutoplay = null;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ–º —É–ª—å—Ç—Ä–∞-—ç–∫–æ–Ω–æ–º–∏—é
        if (!ultraEcoEnabled) {
          window.__ecoAutoFromEnergy = true;
          toggleEco();
        }
      } else {
        if (window.__savedAnimationBeforeEnergy) {
          toggleAnimation();
          window.__savedAnimationBeforeEnergy = null;
        }
        
        if (window.__savedBitBeforeEnergy) {
          toggleBit();
          window.__savedBitBeforeEnergy = null;
        }
        
        if (!coverAutoplay && Array.isArray(coverGalleryArr) && coverGalleryArr.length > 1 && !document.hidden) {
          startCoverAutoPlay();
        }
        
        // –ï—Å–ª–∏ –≠–ö–û –±—ã–ª–æ –≤–∫–ª—é—á–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –±—ã–ª–æ
        if (window.__ecoAutoFromEnergy) {
          window.__ecoAutoFromEnergy = false;
          if (localStorage.getItem('ultraEco') !== '1') {
            toggleEco();
          }
        }
      }
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(sec) {
      if (isNaN(sec) || sec < 0) return '--:--';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    function hasKeyboard() {
      try {
        const isDesktop = !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const hasPointer = matchMedia('(pointer: fine)').matches;
        const canHover = matchMedia('(hover: hover)').matches;
        const noTouch = (navigator.maxTouchPoints || 0) === 0;
        return (isDesktop && hasPointer) || (canHover && noTouch);
      } catch {
        return true;
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
    window.addEventListener('keydown', function(e) {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      const hasModal = document.querySelector('.modal-bg.active');
      if (e.key === 'Escape' && hasModal) {
        e.preventDefault();
        document.querySelectorAll('.modal-bg.active').forEach(m => m.classList.remove('active'));
        return;
      }
      
      if (hasModal) return;
      
      switch(e.key.toUpperCase()) {
        case ' ': case 'K': e.preventDefault(); togglePlayPause(); break;
        case 'X': e.preventDefault(); stopPlayback(); break;
        case 'N': e.preventDefault(); nextTrack(); break;
        case 'P': e.preventDefault(); previousTrack(); break;
        case 'J': e.preventDefault(); seekAudio(-10); break;
        case 'L': e.preventDefault(); seekAudio(10); break;
        case '+': case '=': e.preventDefault(); adjustVolume(10); break;
        case '-': e.preventDefault(); adjustVolume(-10); break;
        case 'M': e.preventDefault(); toggleMute(); break;
        case 'R': e.preventDefault(); toggleRepeat(); break;
        case 'U': e.preventDefault(); toggleShuffle(); break;
        case 'F': e.preventDefault(); toggleFavoritesOnly(); break;
        case 'T': e.preventDefault(); toggleSleepMenu(); break;
        case 'A': e.preventDefault(); toggleAnimation(); break;
        case 'B': e.preventDefault(); toggleBit(); break;
        case '1': if (bitEnabled) { setBitIntensity(100); } break;
        case '2': if (bitEnabled) { setBitIntensity(50); } break;
        case '3': if (bitEnabled) { setBitIntensity(15); } break;
        case 'Y': e.preventDefault(); toggleLyricsView(); break;
        case 'W': e.preventDefault(); document.getElementById('track-list')?.scrollIntoView({behavior: 'smooth'}); break;
        case 'D': e.preventDefault(); toggleLikePlaying(); break;
        case '?': e.preventDefault(); showHotkeysModal(); break;
        case 'O': e.preventDefault(); autoNextDisabled = !autoNextDisabled; 
                  window.NotificationSystem?.info(autoNextDisabled ? '‚èπ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç–∫–ª—é—á—ë–Ω' : '‚ñ∂ –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –≤–∫–ª—é—á—ë–Ω');
                  break;
      }
      
      // –ù–æ–º–µ—Ä–∞ —Ç—Ä–µ–∫–æ–≤ 1-9
      if (e.key >= '1' && e.key <= '9' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
        const idx = parseInt(e.key) - 1;
        if (config && idx < config.tracks.length) {
          e.preventDefault();
          showTrack(idx, true);
        }
      }
    });
  </script>
</body>
</html>
